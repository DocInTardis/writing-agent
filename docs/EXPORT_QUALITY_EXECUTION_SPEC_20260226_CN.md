# 导出质量修复执行规范（2026-02-26）

## 1. 目标

- 定位导出文档质量偏低的根因，并区分“模型问题”与“系统算法/架构问题”。
- 若确认为系统问题，必须修改原算法，直到导出文本在常规语境下保持语义完整、结构自然。
- 通过模块化拆分降低 `app_v2.py` 的导出职责耦合，减少“系统强加限制”对内容质量的负面影响。

## 2. 根因判定标准

按以下优先级判定，任何一项命中即视为“系统算法问题”，不得归因模型：

1. 导出前清洗/修复步骤对原文进行破坏性改写（删除符号、错误拼接、强制补段）。
2. 严格格式策略默认开启，导致普通文档被按学术模板强制改造。
3. 在无真实引用数据时仍注入“占位参考文献”或强制参考文献章节。
4. 导出路径默认执行自动修复，覆盖用户原文表达。

## 3. 强制执行项（全部必须完成）

1. 将导出清洗能力从 `writing_agent/web/app_v2.py` 下沉到独立模块。
2. 将导出清洗改为“保语义优先”：
   - 禁止删除 Markdown 单星号强调；
   - 禁止移除列表标记；
   - 禁止短行强行拼接正文。
3. 严格策略改为显式开启：
   - `strict_doc_format` 默认关闭；
   - `strict_citation_verify` 默认关闭；
   - 支持通过环境变量覆盖默认值。
4. 取消无引用场景下的占位参考文献注入。
5. 参考文献相关约束仅在“有真实引用需求”时生效。
6. `download_docx` 自动修复仅在严格模式下触发。
7. 新增回归测试，覆盖以下行为：
   - 默认模式不强制 TOC/参考文献；
   - 清洗不破坏强调和列表；
   - 无引用不注入占位参考文献；
   - 严格模式显式开启仍可执行结构修复。
8. 执行并通过回归命令：
   - `python -m pytest -q tests/export/test_docx_export.py tests/test_generation_guards.py tests/test_doc_format_heading_glue.py`

## 4. 质量验收标准

- 普通导出路径：优先保留用户原文语义，不做学术模板强制改造。
- 学术严格路径：显式启用后才执行格式约束与自动修复。
- 自动化测试：目标用例全部通过。
- 架构层面：导出清洗逻辑已模块化，不再全部堆叠在 `app_v2.py`。

## 5. 参考依据（知网/标准）

- CNKI 期刊系统投稿须知页面（摘要、关键词、参考文献等结构要求）；
- 国家标准平台中“参考文献著录规则”标准条目信息（GB/T 7714）。

说明：参考依据用于指导“严格学术模式”的规则边界，不得反向污染默认通用导出路径。
