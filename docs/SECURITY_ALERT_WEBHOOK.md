# Dependency Security Webhook Alerts

This doc describes webhook alerts emitted by `.github/workflows/dependency-security.yml`.

## Trigger Conditions

Webhook notify is triggered when either check fails:

- dependency audit (`scripts/dependency_audit.py`)
- SBOM generation (`scripts/generate_sbom.py`)

## Simulation Mode

The workflow supports a manual end-to-end alert simulation:

1. Open GitHub Actions `dependency-security`.
2. Click `Run workflow`.
3. Enable input `simulate_failure=true`.
4. Workflow will force audit failure (`--max-npm-dev-moderate -1`) and execute full alert/issue path.

Simulation alerts are tagged in payload and issue title.

## Payload Schema

Webhook payload is generated by `scripts/security_alert_notify.py`:

```json
{
  "schema_version": 1,
  "source": "dependency-security-workflow",
  "kind": "dependency_security",
  "status": "failed",
  "severity": "warn|high|critical",
  "timestamp": 0,
  "repo": "owner/repo",
  "run_id": "123456",
  "run_number": "78",
  "run_url": "https://github.com/owner/repo/actions/runs/...",
  "artifact_url": "https://github.com/owner/repo/actions/runs/.../artifacts/...",
  "summary": "...",
  "details": "...",
  "failed_check_ids": ["npm_prod_critical"],
  "triage_hints": ["..."],
  "simulate_failure": false
}
```

## Optional Signature Verification

If secret `SECURITY_ALERT_WEBHOOK_SIGNING_KEY` is configured, webhook requests include:

- `X-WA-Timestamp`: unix seconds
- `X-WA-Signature`: `sha256=<hex>`

Signature input:

```text
<timestamp>.<raw_json_body>
```

Use HMAC-SHA256 with the same signing key to verify.

## Recommended Receiver Checks

- Reject timestamp drift beyond acceptable window (for example 5 minutes).
- Verify HMAC signature before parsing body.
- Deduplicate events by `(repo, run_id, status, summary)`.
- Keep `run_url` and `artifact_url` in alert ticket for fast triage.
