# Incident Notification Channels

This document describes outbound notification for incident reports generated by preflight.

## Script

- `scripts/incident_notify.py`

## Supported channels

- Generic webhook (`WA_INCIDENT_WEBHOOK_URL`)
- Slack incoming webhook (`WA_INCIDENT_SLACK_WEBHOOK_URL`)
- Feishu bot webhook (`WA_INCIDENT_FEISHU_WEBHOOK_URL`)
- Email via SMTP (`WA_INCIDENT_EMAIL_TO`, `WA_INCIDENT_EMAIL_FROM`, `WA_INCIDENT_SMTP_HOST`, ...)
- Routing policy (`security/incident_routing.json`)
- On-call roster (`security/oncall_roster.json`)

Routing rules can filter by:

- `min_severity`
- `owners`
- `days_of_week` (0-6, Monday=0)
- `hours_utc` (`start`/`end`, supports cross-day windows)

## Common usage

Notify only when incident is escalated:

```bash
python scripts/incident_notify.py --only-when-escalated
```

Strict mode (fails if no channel configured or any configured channel fails):

```bash
python scripts/incident_notify.py --only-when-escalated --strict
```

Use an explicit on-call roster file:

```bash
python scripts/incident_notify.py --oncall-roster security/oncall_roster.json --only-when-escalated
```

Disable roster preference and keep static channel config first:

```bash
python scripts/incident_notify.py --prefer-oncall-roster 0 --only-when-escalated
```

Replay dead-letter payload:

```bash
python scripts/incident_notify.py --replay-dead-letter .data/out/dead_letter/incident_notify_dead_letter_*.json
```

## Optional signing

- Generic webhook supports HMAC signature headers:
  - `X-WA-Timestamp`
  - `X-WA-Signature`
- Configure key:
  - `WA_INCIDENT_SIGNING_KEY`

## Output artifact

- `.data/out/incident_notify_*.json`
- `.data/out/dead_letter/incident_notify_dead_letter_*.json` (when delivery fails)

This report includes per-channel delivery status and retry traces.

## Local drill

Run an end-to-end local drill for webhook/slack/feishu channels:

```bash
python scripts/incident_notify_drill.py
```

Include SMTP email channel in drill:

```bash
python scripts/incident_notify_drill.py --with-email
```

## On-call roster behavior

- Default roster path:
  - `security/oncall_roster.json`
- Override path:
  - `WA_INCIDENT_ONCALL_ROSTER_FILE`
- Toggle roster preference:
  - `WA_INCIDENT_USE_ONCALL_ROSTER` (`1` by default)
- Guard requirement:
  - `WA_INCIDENT_REQUIRE_ONCALL_ROSTER=1` to enforce roster presence and at least one reachable on-call target in `incident_config_guard`.

Drill artifacts:

- `.data/out/incident_notify_drill_*.json`
- `.data/out/incident_notify_drill_notify_*.json`
- `.data/out/incident_report_drill_*.json`
