(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))r(a);new MutationObserver(a=>{for(const s of a)if(s.type==="childList")for(const m of s.addedNodes)m.tagName==="LINK"&&m.rel==="modulepreload"&&r(m)}).observe(document,{childList:!0,subtree:!0});function i(a){const s={};return a.integrity&&(s.integrity=a.integrity),a.referrerPolicy&&(s.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?s.credentials="include":a.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(a){if(a.ep)return;a.ep=!0;const s=i(a);fetch(a.href,s)}})();const Ur=2,Qa=4,Za=8,Pu=1<<24,Bs=16,ns=32,da=64,ql=128,Hi=512,Tr=1024,Jr=2048,Wi=4096,Bi=8192,Cs=16384,Ks=32768,ja=65536,gu=1<<17,Hu=1<<18,Ma=1<<19,zu=1<<20,Es=1<<25,sa=65536,Fl=1<<21,ic=1<<22,Ws=1<<23,Is=Symbol("$state"),Wu=Symbol("legacy props"),lv=Symbol(""),ta=new class extends Error{name="StaleReactionError";message="The reaction that called `getAbortSignal()` was re-run or destroyed"},cv=!!globalThis.document?.contentType&&globalThis.document.contentType.includes("xml"),to=3,Ba=8,Ol=!1;var eo=Array.isArray,uv=Array.prototype.indexOf,Ea=Array.prototype.includes,Ho=Array.from,sc=Object.defineProperty,$a=Object.getOwnPropertyDescriptor,Uu=Object.getOwnPropertyDescriptors,fv=Object.prototype,dv=Array.prototype,ac=Object.getPrototypeOf,_u=Object.isExtensible;const Ns=()=>{};function vv(e){return e()}function Ro(e){for(var n=0;n<e.length;n++)e[n]()}function Ju(){var e,n,i=new Promise((r,a)=>{e=r,n=a});return{promise:i,resolve:e,reject:n}}function Ku(e){return e===this.v}function Gu(e,n){return e!=e?n==n:e!==n||e!==null&&typeof e=="object"||typeof e=="function"}function Vu(e){return!Gu(e,this.v)}function oc(e){throw new Error("https://svelte.dev/e/lifecycle_outside_component")}function pv(){throw new Error("https://svelte.dev/e/async_derived_orphan")}function mv(e,n,i){throw new Error("https://svelte.dev/e/each_key_duplicate")}function hv(e){throw new Error("https://svelte.dev/e/effect_in_teardown")}function gv(){throw new Error("https://svelte.dev/e/effect_in_unowned_derived")}function _v(e){throw new Error("https://svelte.dev/e/effect_orphan")}function bv(){throw new Error("https://svelte.dev/e/effect_update_depth_exceeded")}function yv(){throw new Error("https://svelte.dev/e/hydration_failed")}function wv(e){throw new Error("https://svelte.dev/e/props_invalid_value")}function xv(){throw new Error("https://svelte.dev/e/state_descriptors_fixed")}function kv(){throw new Error("https://svelte.dev/e/state_prototype_fixed")}function Sv(){throw new Error("https://svelte.dev/e/state_unsafe_mutation")}function $v(){throw new Error("https://svelte.dev/e/svelte_boundary_reset_onerror")}let Da=!1,Tv=!1;function jv(){Da=!0}const Ev=1,Av=2,Xu=4,Cv=8,Iv=16,Nv=2,Mv=8,Bv=1,Dv=2,lc="[",zo="[!",cc="]",aa={},zr=Symbol(),Yu="http://www.w3.org/1999/xhtml";let Ln=null;function Aa(e){Ln=e}function Zr(e,n=!1,i){Ln={p:Ln,i:!1,c:null,e:null,s:e,x:null,l:Da&&!n?{s:null,u:null,$:[]}:null}}function ti(e){var n=Ln,i=n.e;if(i!==null){n.e=null;for(var r of i)$f(r)}return e!==void 0&&(n.x=e),n.i=!0,Ln=n.p,e??{}}function no(){return!Da||Ln!==null&&Ln.l===null}let ea=[];function Qu(){var e=ea;ea=[],Ro(e)}function ds(e){if(ea.length===0&&!Ka){var n=ea;queueMicrotask(()=>{n===ea&&Qu()})}ea.push(e)}function Lv(){for(;ea.length>0;)Qu()}function ro(e){console.warn("https://svelte.dev/e/hydration_mismatch")}function Rv(){console.warn("https://svelte.dev/e/select_multiple_invalid_value")}function qv(){console.warn("https://svelte.dev/e/svelte_boundary_reset_noop")}let ge=!1;function As(e){ge=e}let Fe;function Qr(e){if(e===null)throw ro(),aa;return Fe=e}function oa(){return Qr(rs(Fe))}function d(e){if(ge){if(rs(Fe)!==null)throw ro(),aa;Fe=e}}function us(e=1){if(ge){for(var n=e,i=Fe;n--;)i=rs(i);Fe=i}}function qo(e=!0){for(var n=0,i=Fe;;){if(i.nodeType===Ba){var r=i.data;if(r===cc){if(n===0)return i;n-=1}else(r===lc||r===zo||r[0]==="["&&!isNaN(Number(r.slice(1))))&&(n+=1)}var a=rs(i);e&&i.remove(),i=a}}function Zu(e){if(!e||e.nodeType!==Ba)throw ro(),aa;return e.data}function ka(e){if(typeof e!="object"||e===null||Is in e)return e;const n=ac(e);if(n!==fv&&n!==dv)return e;var i=new Map,r=eo(e),a=qs(0),s=ra,m=h=>{if(ra===s)return h();var y=qe,S=ra;Ui(null),Su(s);var b=h();return Ui(y),Su(S),b};return r&&i.set("length",qs(e.length)),new Proxy(e,{defineProperty(h,y,S){(!("value"in S)||S.configurable===!1||S.enumerable===!1||S.writable===!1)&&xv();var b=i.get(y);return b===void 0?m(()=>{var T=qs(S.value);return i.set(y,T),T}):f(b,S.value,!0),!0},deleteProperty(h,y){var S=i.get(y);if(S===void 0){if(y in h){const b=m(()=>qs(zr));i.set(y,b),Ga(a)}}else f(S,zr),Ga(a);return!0},get(h,y,S){if(y===Is)return e;var b=i.get(y),T=y in h;if(b===void 0&&(!T||$a(h,y)?.writable)&&(b=m(()=>{var q=ka(T?h[y]:zr),O=qs(q);return O}),i.set(y,b)),b!==void 0){var N=t(b);return N===zr?void 0:N}return Reflect.get(h,y,S)},getOwnPropertyDescriptor(h,y){var S=Reflect.getOwnPropertyDescriptor(h,y);if(S&&"value"in S){var b=i.get(y);b&&(S.value=t(b))}else if(S===void 0){var T=i.get(y),N=T?.v;if(T!==void 0&&N!==zr)return{enumerable:!0,configurable:!0,value:N,writable:!0}}return S},has(h,y){if(y===Is)return!0;var S=i.get(y),b=S!==void 0&&S.v!==zr||Reflect.has(h,y);if(S!==void 0||Me!==null&&(!b||$a(h,y)?.writable)){S===void 0&&(S=m(()=>{var N=b?ka(h[y]):zr,q=qs(N);return q}),i.set(y,S));var T=t(S);if(T===zr)return!1}return b},set(h,y,S,b){var T=i.get(y),N=y in h;if(r&&y==="length")for(var q=S;q<T.v;q+=1){var O=i.get(q+"");O!==void 0?f(O,zr):q in h&&(O=m(()=>qs(zr)),i.set(q+"",O))}if(T===void 0)(!N||$a(h,y)?.writable)&&(T=m(()=>qs(void 0)),f(T,ka(S)),i.set(y,T));else{N=T.v!==zr;var E=m(()=>ka(S));f(T,E)}var P=Reflect.getOwnPropertyDescriptor(h,y);if(P?.set&&P.set.call(b,S),!N){if(r&&typeof y=="string"){var vt=i.get("length"),U=Number(y);Number.isInteger(U)&&U>=vt.v&&f(vt,U+1)}Ga(a)}return!0},ownKeys(h){t(a);var y=Reflect.ownKeys(h).filter(T=>{var N=i.get(T);return N===void 0||N.v!==zr});for(var[S,b]of i)b.v!==zr&&!(S in h)&&y.push(S);return y},setPrototypeOf(){kv()}})}function bu(e){try{if(e!==null&&typeof e=="object"&&Is in e)return e[Is]}catch{}return e}function Fv(e,n){return Object.is(bu(e),bu(n))}var yu,tf,ef,nf;function Pl(){if(yu===void 0){yu=window,tf=/Firefox/.test(navigator.userAgent);var e=Element.prototype,n=Node.prototype,i=Text.prototype;ef=$a(n,"firstChild").get,nf=$a(n,"nextSibling").get,_u(e)&&(e.__click=void 0,e.__className=void 0,e.__attributes=null,e.__style=void 0,e.__e=void 0),_u(i)&&(i.__t=void 0)}}function Ti(e=""){return document.createTextNode(e)}function Pi(e){return ef.call(e)}function rs(e){return nf.call(e)}function p(e,n){if(!ge)return Pi(e);var i=Pi(Fe);if(i===null)i=Fe.appendChild(Ti());else if(n&&i.nodeType!==to){var r=Ti();return i?.before(r),Qr(r),r}return n&&Wo(i),Qr(i),i}function hr(e,n=!1){if(!ge){var i=Pi(e);return i instanceof Comment&&i.data===""?rs(i):i}if(n){if(Fe?.nodeType!==to){var r=Ti();return Fe?.before(r),Qr(r),r}Wo(Fe)}return Fe}function u(e,n=1,i=!1){let r=ge?Fe:e;for(var a;n--;)a=r,r=rs(r);if(!ge)return r;if(i){if(r?.nodeType!==to){var s=Ti();return r===null?a?.after(s):r.before(s),Qr(s),s}Wo(r)}return Qr(r),r}function uc(e){e.textContent=""}function rf(){return!1}function Ov(e,n,i){return document.createElementNS(Yu,e,void 0)}function Wo(e){if(e.nodeValue.length<65536)return;let n=e.nextSibling;for(;n!==null&&n.nodeType===to;)n.remove(),e.nodeValue+=n.nodeValue,n=e.nextSibling}function sf(e){var n=Me;if(n===null)return qe.f|=Ws,e;if((n.f&Ks)===0&&(n.f&Qa)===0)throw e;Ca(e,n)}function Ca(e,n){for(;n!==null;){if((n.f&ql)!==0){if((n.f&Ks)===0)throw e;try{n.b.error(e);return}catch(i){e=i}}n=n.parent}throw e}const Pv=-7169;function ir(e,n){e.f=e.f&Pv|n}function fc(e){(e.f&Hi)!==0||e.deps===null?ir(e,Tr):ir(e,Wi)}function af(e){if(e!==null)for(const n of e)(n.f&Ur)===0||(n.f&sa)===0||(n.f^=sa,af(n.deps))}function of(e,n,i){(e.f&Jr)!==0?n.add(e):(e.f&Wi)!==0&&i.add(e),af(e.deps),ir(e,Tr)}const jo=new Set;let Je=null,Fo=null,Qi=null,Si=[],Uo=null,Hl=!1,Ka=!1;class Us{committed=!1;current=new Map;previous=new Map;#t=new Set;#e=new Set;#n=0;#s=0;#a=null;#o=new Set;#r=new Set;#i=new Map;is_fork=!1;#l=!1;#u(){return this.is_fork||this.#s>0}skip_effect(n){this.#i.has(n)||this.#i.set(n,{d:[],m:[]})}unskip_effect(n){var i=this.#i.get(n);if(i){this.#i.delete(n);for(var r of i.d)ir(r,Jr),Zi(r);for(r of i.m)ir(r,Wi),Zi(r)}}process(n){Si=[],this.apply();var i=[],r=[];for(const a of n)this.#c(a,i,r);if(this.#u()){this.#f(r),this.#f(i);for(const[a,s]of this.#i)ff(a,s)}else{for(const a of this.#t)a();this.#t.clear(),this.#n===0&&this.#v(),Fo=this,Je=null,wu(r),wu(i),Fo=null,this.#a?.resolve()}Qi=null}#c(n,i,r){n.f^=Tr;for(var a=n.first;a!==null;){var s=a.f,m=(s&(ns|da))!==0,h=m&&(s&Tr)!==0,y=h||(s&Bi)!==0||this.#i.has(a);if(!y&&a.fn!==null){m?a.f^=Tr:(s&Qa)!==0?i.push(a):La(a)&&((s&Bs)!==0&&this.#r.add(a),ca(a));var S=a.first;if(S!==null){a=S;continue}}for(;a!==null;){var b=a.next;if(b!==null){a=b;break}a=a.parent}}}#f(n){for(var i=0;i<n.length;i+=1)of(n[i],this.#o,this.#r)}capture(n,i){i!==zr&&!this.previous.has(n)&&this.previous.set(n,i),(n.f&Ws)===0&&(this.current.set(n,n.v),Qi?.set(n,n.v))}activate(){Je=this,this.apply()}deactivate(){Je===this&&(Je=null,Qi=null)}flush(){if(this.activate(),Si.length>0){if(lf(),Je!==null&&Je!==this)return}else this.#n===0&&this.process([]);this.deactivate()}discard(){for(const n of this.#e)n(this);this.#e.clear()}#v(){if(jo.size>1){this.previous.clear();var n=Qi,i=!0;for(const a of jo){if(a===this){i=!1;continue}const s=[];for(const[h,y]of this.current){if(a.current.has(h))if(i&&y!==a.current.get(h))a.current.set(h,y);else continue;s.push(h)}if(s.length===0)continue;const m=[...a.current.keys()].filter(h=>!this.current.has(h));if(m.length>0){var r=Si;Si=[];const h=new Set,y=new Map;for(const S of s)cf(S,m,h,y);if(Si.length>0){Je=a,a.apply();for(const S of Si)a.#c(S,[],[]);a.deactivate()}Si=r}}Je=null,Qi=n}this.committed=!0,jo.delete(this)}increment(n){this.#n+=1,n&&(this.#s+=1)}decrement(n){this.#n-=1,n&&(this.#s-=1),!this.#l&&(this.#l=!0,ds(()=>{this.#l=!1,this.#u()?Si.length>0&&this.flush():this.revive()}))}revive(){for(const n of this.#o)this.#r.delete(n),ir(n,Jr),Zi(n);for(const n of this.#r)ir(n,Wi),Zi(n);this.flush()}oncommit(n){this.#t.add(n)}ondiscard(n){this.#e.add(n)}settled(){return(this.#a??=Ju()).promise}static ensure(){if(Je===null){const n=Je=new Us;jo.add(Je),Ka||ds(()=>{Je===n&&n.flush()})}return Je}apply(){}}function cr(e){var n=Ka;Ka=!0;try{for(var i;;){if(Lv(),Si.length===0&&(Je?.flush(),Si.length===0))return Uo=null,i;lf()}}finally{Ka=n}}function lf(){Hl=!0;var e=null;try{for(var n=0;Si.length>0;){var i=Us.ensure();if(n++>1e3){var r,a;Hv()}i.process(Si),Js.clear()}}finally{Si=[],Hl=!1,Uo=null}}function Hv(){try{bv()}catch(e){Ca(e,Uo)}}let Ss=null;function wu(e){var n=e.length;if(n!==0){for(var i=0;i<n;){var r=e[i++];if((r.f&(Cs|Bi))===0&&La(r)&&(Ss=new Set,ca(r),r.deps===null&&r.first===null&&r.nodes===null&&r.teardown===null&&r.ac===null&&Af(r),Ss?.size>0)){Js.clear();for(const a of Ss){if((a.f&(Cs|Bi))!==0)continue;const s=[a];let m=a.parent;for(;m!==null;)Ss.has(m)&&(Ss.delete(m),s.push(m)),m=m.parent;for(let h=s.length-1;h>=0;h--){const y=s[h];(y.f&(Cs|Bi))===0&&ca(y)}}Ss.clear()}}Ss=null}}function cf(e,n,i,r){if(!i.has(e)&&(i.add(e),e.reactions!==null))for(const a of e.reactions){const s=a.f;(s&Ur)!==0?cf(a,n,i,r):(s&(ic|Bs))!==0&&(s&Jr)===0&&uf(a,n,r)&&(ir(a,Jr),Zi(a))}}function uf(e,n,i){const r=i.get(e);if(r!==void 0)return r;if(e.deps!==null)for(const a of e.deps){if(Ea.call(n,a))return!0;if((a.f&Ur)!==0&&uf(a,n,i))return i.set(a,!0),!0}return i.set(e,!1),!1}function Zi(e){var n=Uo=e,i=n.b;if(i?.is_pending&&(e.f&(Qa|Za|Pu))!==0&&(e.f&Ks)===0){i.defer_effect(e);return}for(;n.parent!==null;){n=n.parent;var r=n.f;if(Hl&&n===Me&&(r&Bs)!==0&&(r&Hu)===0&&(r&Ks)!==0)return;if((r&(da|ns))!==0){if((r&Tr)===0)return;n.f^=Tr}}Si.push(n)}function ff(e,n){if(!((e.f&ns)!==0&&(e.f&Tr)!==0)){(e.f&Jr)!==0?n.d.push(e):(e.f&Wi)!==0&&n.m.push(e),ir(e,Tr);for(var i=e.first;i!==null;)ff(i,n),i=i.next}}function zv(e){let n=0,i=la(0),r;return()=>{pc()&&(t(i),Ra(()=>(n===0&&(r=_(()=>e(()=>Ga(i)))),n+=1,()=>{ds(()=>{n-=1,n===0&&(r?.(),r=void 0,Ga(i))})})))}}var Wv=ja|Ma;function Uv(e,n,i){new Jv(e,n,i)}class Jv{parent;is_pending=!1;#t;#e=ge?Fe:null;#n;#s;#a;#o=null;#r=null;#i=null;#l=null;#u=0;#c=0;#f=!1;#v=new Set;#p=new Set;#d=null;#b=zv(()=>(this.#d=la(this.#u),()=>{this.#d=null}));constructor(n,i,r){this.#t=n,this.#n=i,this.#s=a=>{var s=Me;s.b=this,s.f|=ql,r(a)},this.parent=Me.b,this.#a=mc(()=>{if(ge){const a=this.#e;oa(),a.data===zo?this.#w():this.#y()}else this.#g()},Wv),ge&&(this.#t=Fe)}#y(){try{this.#o=Yi(()=>this.#s(this.#t))}catch(n){this.error(n)}}#w(){const n=this.#n.pending;n&&(this.is_pending=!0,this.#r=Yi(()=>n(this.#t)),ds(()=>{var i=this.#l=document.createDocumentFragment(),r=Ti();i.append(r),this.#o=this.#h(()=>(Us.ensure(),Yi(()=>this.#s(r)))),this.#c===0&&(this.#t.before(i),this.#l=null,ia(this.#r,()=>{this.#r=null}),this.#m())}))}#g(){try{if(this.is_pending=this.has_pending_snippet(),this.#c=0,this.#u=0,this.#o=Yi(()=>{this.#s(this.#t)}),this.#c>0){var n=this.#l=document.createDocumentFragment();Nf(this.#o,n);const i=this.#n.pending;this.#r=Yi(()=>i(this.#t))}else this.#m()}catch(i){this.error(i)}}#m(){this.is_pending=!1;for(const n of this.#v)ir(n,Jr),Zi(n);for(const n of this.#p)ir(n,Wi),Zi(n);this.#v.clear(),this.#p.clear()}defer_effect(n){of(n,this.#v,this.#p)}is_rendered(){return!this.is_pending&&(!this.parent||this.parent.is_rendered())}has_pending_snippet(){return!!this.#n.pending}#h(n){var i=Me,r=qe,a=Ln;hs(this.#a),Ui(this.#a),Aa(this.#a.ctx);try{return n()}catch(s){return sf(s),null}finally{hs(i),Ui(r),Aa(a)}}#_(n){if(!this.has_pending_snippet()){this.parent&&this.parent.#_(n);return}this.#c+=n,this.#c===0&&(this.#m(),this.#r&&ia(this.#r,()=>{this.#r=null}),this.#l&&(this.#t.before(this.#l),this.#l=null))}update_pending_count(n){this.#_(n),this.#u+=n,!(!this.#d||this.#f)&&(this.#f=!0,ds(()=>{this.#f=!1,this.#d&&Na(this.#d,this.#u)}))}get_effect_pending(){return this.#b(),t(this.#d)}error(n){var i=this.#n.onerror;let r=this.#n.failed;if(!i&&!r)throw n;this.#o&&(ji(this.#o),this.#o=null),this.#r&&(ji(this.#r),this.#r=null),this.#i&&(ji(this.#i),this.#i=null),ge&&(Qr(this.#e),us(),Qr(qo()));var a=!1,s=!1;const m=()=>{if(a){qv();return}a=!0,s&&$v(),this.#i!==null&&ia(this.#i,()=>{this.#i=null}),this.#h(()=>{Us.ensure(),this.#g()})};ds(()=>{try{s=!0,i?.(n,m),s=!1}catch(h){Ca(h,this.#a&&this.#a.parent)}r&&(this.#i=this.#h(()=>{Us.ensure();try{return Yi(()=>{var h=Me;h.b=this,h.f|=ql,r(this.#t,()=>n,()=>m)})}catch(h){return Ca(h,this.#a.parent),null}}))})}}function Kv(e,n,i,r){const a=no()?Jo:Ia;var s=e.filter(N=>!N.settled);if(i.length===0&&s.length===0){r(n.map(a));return}var m=Je,h=Me,y=Gv(),S=s.length===1?s[0].promise:s.length>1?Promise.all(s.map(N=>N.promise)):null;function b(N){y();try{r(N)}catch(q){(h.f&Cs)===0&&Ca(q,h)}m?.deactivate(),zl()}if(i.length===0){S.then(()=>b(n.map(a)));return}function T(){y(),Promise.all(i.map(N=>Xv(N))).then(N=>b([...n.map(a),...N])).catch(N=>Ca(N,h))}S?S.then(T):T()}function Gv(){var e=Me,n=qe,i=Ln,r=Je;return function(s=!0){hs(e),Ui(n),Aa(i),s&&r?.activate()}}function zl(){hs(null),Ui(null),Aa(null)}function Vv(){var e=Me.b,n=Je,i=e.is_rendered();return e.update_pending_count(1),n.increment(i),()=>{e.update_pending_count(-1),n.decrement(i)}}function Jo(e){var n=Ur|Jr,i=qe!==null&&(qe.f&Ur)!==0?qe:null;return Me!==null&&(Me.f|=Ma),{ctx:Ln,deps:null,effects:null,equals:Ku,f:n,fn:e,reactions:null,rv:0,v:zr,wv:0,parent:i??Me,ac:null}}function Xv(e,n,i){Me===null&&pv();var a=void 0,s=la(zr),m=!qe,h=new Map;return op(()=>{var y=Ju();a=y.promise;try{Promise.resolve(e()).then(y.resolve,y.reject).then(()=>{S===Je&&S.committed&&S.deactivate(),zl()})}catch(N){y.reject(N),zl()}var S=Je;if(m){var b=Vv();h.get(S)?.reject(ta),h.delete(S),h.set(S,y)}const T=(N,q=void 0)=>{if(S.activate(),q)q!==ta&&(s.f|=Ws,Na(s,q));else{(s.f&Ws)!==0&&(s.f^=Ws),Na(s,N);for(const[O,E]of h){if(h.delete(O),O===S)break;E.reject(ta)}}b&&b()};y.promise.then(T,N=>T(null,N||"unknown"))}),Go(()=>{for(const y of h.values())y.reject(ta)}),new Promise(y=>{function S(b){function T(){b===a?y(s):S(a)}b.then(T,T)}S(a)})}function Sa(e){const n=Jo(e);return gf(n),n}function Ia(e){const n=Jo(e);return n.equals=Vu,n}function Yv(e){var n=e.effects;if(n!==null){e.effects=null;for(var i=0;i<n.length;i+=1)ji(n[i])}}function Qv(e){for(var n=e.parent;n!==null;){if((n.f&Ur)===0)return(n.f&Cs)===0?n:null;n=n.parent}return null}function dc(e){var n,i=Me;hs(Qv(e));try{e.f&=~sa,Yv(e),n=wf(e)}finally{hs(i)}return n}function df(e){var n=dc(e);if(!e.equals(n)&&(e.wv=bf(),(!Je?.is_fork||e.deps===null)&&(e.v=n,e.deps===null))){ir(e,Tr);return}Gs||(Qi!==null?(pc()||Je?.is_fork)&&Qi.set(e,n):fc(e))}function Zv(e){if(e.effects!==null)for(const n of e.effects)(n.teardown||n.ac)&&(n.teardown?.(),n.ac?.abort(ta),n.teardown=Ns,n.ac=null,Xa(n,0),hc(n))}function vf(e){if(e.effects!==null)for(const n of e.effects)n.teardown&&ca(n)}let Wl=new Set;const Js=new Map;let pf=!1;function la(e,n){var i={f:0,v:e,reactions:null,equals:Ku,rv:0,wv:0};return i}function qs(e,n){const i=la(e);return gf(i),i}function W(e,n=!1,i=!0){const r=la(e);return n||(r.equals=Vu),Da&&i&&Ln!==null&&Ln.l!==null&&(Ln.l.s??=[]).push(r),r}function Wr(e,n){return f(e,_(()=>t(e))),n}function f(e,n,i=!1){qe!==null&&(!ts||(qe.f&gu)!==0)&&no()&&(qe.f&(Ur|Bs|ic|gu))!==0&&(zi===null||!Ea.call(zi,e))&&Sv();let r=i?ka(n):n;return Na(e,r)}function Na(e,n){if(!e.equals(n)){var i=e.v;Gs?Js.set(e,n):Js.set(e,i),e.v=n;var r=Us.ensure();if(r.capture(e,i),(e.f&Ur)!==0){const a=e;(e.f&Jr)!==0&&dc(a),fc(a)}e.wv=bf(),mf(e,Jr),no()&&Me!==null&&(Me.f&Tr)!==0&&(Me.f&(ns|da))===0&&(Oi===null?ep([e]):Oi.push(e)),!r.is_fork&&Wl.size>0&&!pf&&tp()}return n}function tp(){pf=!1;for(const e of Wl)(e.f&Tr)!==0&&ir(e,Wi),La(e)&&ca(e);Wl.clear()}function Ga(e){f(e,e.v+1)}function mf(e,n){var i=e.reactions;if(i!==null)for(var r=no(),a=i.length,s=0;s<a;s++){var m=i[s],h=m.f;if(!(!r&&m===Me)){var y=(h&Jr)===0;if(y&&ir(m,n),(h&Ur)!==0){var S=m;Qi?.delete(S),(h&sa)===0&&(h&Hi&&(m.f|=sa),mf(S,Wi))}else y&&((h&Bs)!==0&&Ss!==null&&Ss.add(m),Zi(m))}}}function fs(e){ge&&Pi(e)!==null&&uc(e)}let xu=!1;function hf(){xu||(xu=!0,document.addEventListener("reset",e=>{Promise.resolve().then(()=>{if(!e.defaultPrevented)for(const n of e.target.elements)n.__on_r?.()})},{capture:!0}))}function Ko(e){var n=qe,i=Me;Ui(null),hs(null);try{return e()}finally{Ui(n),hs(i)}}function vc(e,n,i,r=i){e.addEventListener(n,()=>Ko(i));const a=e.__on_r;a?e.__on_r=()=>{a(),r(!0)}:e.__on_r=()=>r(!0),hf()}let Bo=!1,Gs=!1;function ku(e){Gs=e}let qe=null,ts=!1;function Ui(e){qe=e}let Me=null;function hs(e){Me=e}let zi=null;function gf(e){qe!==null&&(zi===null?zi=[e]:zi.push(e))}let $i=null,Mi=0,Oi=null;function ep(e){Oi=e}let _f=1,na=0,ra=na;function Su(e){ra=e}function bf(){return++_f}function La(e){var n=e.f;if((n&Jr)!==0)return!0;if(n&Ur&&(e.f&=~sa),(n&Wi)!==0){for(var i=e.deps,r=i.length,a=0;a<r;a++){var s=i[a];if(La(s)&&df(s),s.wv>e.wv)return!0}(n&Hi)!==0&&Qi===null&&ir(e,Tr)}return!1}function yf(e,n,i=!0){var r=e.reactions;if(r!==null&&!(zi!==null&&Ea.call(zi,e)))for(var a=0;a<r.length;a++){var s=r[a];(s.f&Ur)!==0?yf(s,n,!1):n===s&&(i?ir(s,Jr):(s.f&Tr)!==0&&ir(s,Wi),Zi(s))}}function wf(e){var n=$i,i=Mi,r=Oi,a=qe,s=zi,m=Ln,h=ts,y=ra,S=e.f;$i=null,Mi=0,Oi=null,qe=(S&(ns|da))===0?e:null,zi=null,Aa(e.ctx),ts=!1,ra=++na,e.ac!==null&&(Ko(()=>{e.ac.abort(ta)}),e.ac=null);try{e.f|=Fl;var b=e.fn,T=b();e.f|=Ks;var N=e.deps,q=Je?.is_fork;if($i!==null){var O;if(q||Xa(e,Mi),N!==null&&Mi>0)for(N.length=Mi+$i.length,O=0;O<$i.length;O++)N[Mi+O]=$i[O];else e.deps=N=$i;if(pc()&&(e.f&Hi)!==0)for(O=Mi;O<N.length;O++)(N[O].reactions??=[]).push(e)}else!q&&N!==null&&Mi<N.length&&(Xa(e,Mi),N.length=Mi);if(no()&&Oi!==null&&!ts&&N!==null&&(e.f&(Ur|Wi|Jr))===0)for(O=0;O<Oi.length;O++)yf(Oi[O],e);if(a!==null&&a!==e){if(na++,a.deps!==null)for(let E=0;E<i;E+=1)a.deps[E].rv=na;if(n!==null)for(const E of n)E.rv=na;Oi!==null&&(r===null?r=Oi:r.push(...Oi))}return(e.f&Ws)!==0&&(e.f^=Ws),T}catch(E){return sf(E)}finally{e.f^=Fl,$i=n,Mi=i,Oi=r,qe=a,zi=s,Aa(m),ts=h,ra=y}}function np(e,n){let i=n.reactions;if(i!==null){var r=uv.call(i,e);if(r!==-1){var a=i.length-1;a===0?i=n.reactions=null:(i[r]=i[a],i.pop())}}if(i===null&&(n.f&Ur)!==0&&($i===null||!Ea.call($i,n))){var s=n;(s.f&Hi)!==0&&(s.f^=Hi,s.f&=~sa),fc(s),Zv(s),Xa(s,0)}}function Xa(e,n){var i=e.deps;if(i!==null)for(var r=n;r<i.length;r++)np(e,i[r])}function ca(e){var n=e.f;if((n&Cs)===0){ir(e,Tr);var i=Me,r=Bo;Me=e,Bo=!0;try{(n&(Bs|Pu))!==0?lp(e):hc(e),jf(e);var a=wf(e);e.teardown=typeof a=="function"?a:null,e.wv=_f;var s;Ol&&Tv&&(e.f&Jr)!==0&&e.deps}finally{Bo=r,Me=i}}}async function rp(){await Promise.resolve(),cr()}function t(e){var n=e.f,i=(n&Ur)!==0;if(qe!==null&&!ts){var r=Me!==null&&(Me.f&Cs)!==0;if(!r&&(zi===null||!Ea.call(zi,e))){var a=qe.deps;if((qe.f&Fl)!==0)e.rv<na&&(e.rv=na,$i===null&&a!==null&&a[Mi]===e?Mi++:$i===null?$i=[e]:$i.push(e));else{(qe.deps??=[]).push(e);var s=e.reactions;s===null?e.reactions=[qe]:Ea.call(s,qe)||s.push(qe)}}}if(Gs&&Js.has(e))return Js.get(e);if(i){var m=e;if(Gs){var h=m.v;return((m.f&Tr)===0&&m.reactions!==null||kf(m))&&(h=dc(m)),Js.set(m,h),h}var y=(m.f&Hi)===0&&!ts&&qe!==null&&(Bo||(qe.f&Hi)!==0),S=(m.f&Ks)===0;La(m)&&(y&&(m.f|=Hi),df(m)),y&&!S&&(vf(m),xf(m))}if(Qi?.has(e))return Qi.get(e);if((e.f&Ws)!==0)throw e.v;return e.v}function xf(e){if(e.f|=Hi,e.deps!==null)for(const n of e.deps)(n.reactions??=[]).push(e),(n.f&Ur)!==0&&(n.f&Hi)===0&&(vf(n),xf(n))}function kf(e){if(e.v===zr)return!0;if(e.deps===null)return!1;for(const n of e.deps)if(Js.has(n)||(n.f&Ur)!==0&&kf(n))return!0;return!1}function _(e){var n=ts;try{return ts=!0,e()}finally{ts=n}}function ie(e){if(!(typeof e!="object"||!e||e instanceof EventTarget)){if(Is in e)Ul(e);else if(!Array.isArray(e))for(let n in e){const i=e[n];typeof i=="object"&&i&&Is in i&&Ul(i)}}}function Ul(e,n=new Set){if(typeof e=="object"&&e!==null&&!(e instanceof EventTarget)&&!n.has(e)){n.add(e),e instanceof Date&&e.getTime();for(let r in e)try{Ul(e[r],n)}catch{}const i=ac(e);if(i!==Object.prototype&&i!==Array.prototype&&i!==Map.prototype&&i!==Set.prototype&&i!==Date.prototype){const r=Uu(i);for(let a in r){const s=r[a].get;if(s)try{s.call(e)}catch{}}}}}function Sf(e){Me===null&&(qe===null&&_v(),gv()),Gs&&hv()}function ip(e,n){var i=n.last;i===null?n.last=n.first=e:(i.next=e,e.prev=i,n.last=e)}function gs(e,n,i){var r=Me;r!==null&&(r.f&Bi)!==0&&(e|=Bi);var a={ctx:Ln,deps:null,nodes:null,f:e|Jr|Hi,first:null,fn:n,last:null,next:null,parent:r,b:r&&r.b,prev:null,teardown:null,wv:0,ac:null};if(i)try{ca(a)}catch(h){throw ji(a),h}else n!==null&&Zi(a);var s=a;if(i&&s.deps===null&&s.teardown===null&&s.nodes===null&&s.first===s.last&&(s.f&Ma)===0&&(s=s.first,(e&Bs)!==0&&(e&ja)!==0&&s!==null&&(s.f|=ja)),s!==null&&(s.parent=r,r!==null&&ip(s,r),qe!==null&&(qe.f&Ur)!==0&&(e&da)===0)){var m=qe;(m.effects??=[]).push(s)}return a}function pc(){return qe!==null&&!ts}function Go(e){const n=gs(Za,null,!1);return ir(n,Tr),n.teardown=e,n}function Jl(e){Sf();var n=Me.f,i=!qe&&(n&ns)!==0&&(n&Ks)===0;if(i){var r=Ln;(r.e??=[]).push(e)}else return $f(e)}function $f(e){return gs(Qa|zu,e,!1)}function sp(e){return Sf(),gs(Za|zu,e,!0)}function ap(e){Us.ensure();const n=gs(da|Ma,e,!0);return(i={})=>new Promise(r=>{i.outro?ia(n,()=>{ji(n),r(void 0)}):(ji(n),r(void 0))})}function Tf(e){return gs(Qa,e,!1)}function Hs(e,n){var i=Ln,r={effect:null,ran:!1,deps:e};i.l.$.push(r),r.effect=Ra(()=>{e(),!r.ran&&(r.ran=!0,_(n))})}function io(){var e=Ln;Ra(()=>{for(var n of e.l.$){n.deps();var i=n.effect;(i.f&Tr)!==0&&i.deps!==null&&ir(i,Wi),La(i)&&ca(i),n.ran=!1}})}function op(e){return gs(ic|Ma,e,!0)}function Ra(e,n=0){return gs(Za|n,e,!0)}function rt(e,n=[],i=[],r=[]){Kv(r,n,i,a=>{gs(Za,()=>e(...a.map(t)),!0)})}function mc(e,n=0){var i=gs(Bs|n,e,!0);return i}function Yi(e){return gs(ns|Ma,e,!0)}function jf(e){var n=e.teardown;if(n!==null){const i=Gs,r=qe;ku(!0),Ui(null);try{n.call(null)}finally{ku(i),Ui(r)}}}function hc(e,n=!1){var i=e.first;for(e.first=e.last=null;i!==null;){const a=i.ac;a!==null&&Ko(()=>{a.abort(ta)});var r=i.next;(i.f&da)!==0?i.parent=null:ji(i,n),i=r}}function lp(e){for(var n=e.first;n!==null;){var i=n.next;(n.f&ns)===0&&ji(n),n=i}}function ji(e,n=!0){var i=!1;(n||(e.f&Hu)!==0)&&e.nodes!==null&&e.nodes.end!==null&&(Ef(e.nodes.start,e.nodes.end),i=!0),hc(e,n&&!i),Xa(e,0),ir(e,Cs);var r=e.nodes&&e.nodes.t;if(r!==null)for(const s of r)s.stop();jf(e);var a=e.parent;a!==null&&a.first!==null&&Af(e),e.next=e.prev=e.teardown=e.ctx=e.deps=e.fn=e.nodes=e.ac=null}function Ef(e,n){for(;e!==null;){var i=e===n?null:rs(e);e.remove(),e=i}}function Af(e){var n=e.parent,i=e.prev,r=e.next;i!==null&&(i.next=r),r!==null&&(r.prev=i),n!==null&&(n.first===e&&(n.first=r),n.last===e&&(n.last=i))}function ia(e,n,i=!0){var r=[];Cf(e,r,!0);var a=()=>{i&&ji(e),n&&n()},s=r.length;if(s>0){var m=()=>--s||a();for(var h of r)h.out(m)}else a()}function Cf(e,n,i){if((e.f&Bi)===0){e.f^=Bi;var r=e.nodes&&e.nodes.t;if(r!==null)for(const h of r)(h.is_global||i)&&n.push(h);for(var a=e.first;a!==null;){var s=a.next,m=(a.f&ja)!==0||(a.f&ns)!==0&&(e.f&Bs)!==0;Cf(a,n,m?i:!1),a=s}}}function gc(e){If(e,!0)}function If(e,n){if((e.f&Bi)!==0){e.f^=Bi,(e.f&Tr)===0&&(ir(e,Jr),Zi(e));for(var i=e.first;i!==null;){var r=i.next,a=(i.f&ja)!==0||(i.f&ns)!==0;If(i,a?n:!1),i=r}var s=e.nodes&&e.nodes.t;if(s!==null)for(const m of s)(m.is_global||n)&&m.in()}}function Nf(e,n){if(e.nodes)for(var i=e.nodes.start,r=e.nodes.end;i!==null;){var a=i===r?null:rs(i);n.append(i),i=a}}const Eo=Symbol("events"),cp=new Set,$u=new Set;function up(e,n,i,r={}){function a(s){if(r.capture||Kl.call(n,s),!s.cancelBubble)return Ko(()=>i?.call(this,s))}return e.startsWith("pointer")||e.startsWith("touch")||e==="wheel"?ds(()=>{n.addEventListener(e,a,r)}):n.addEventListener(e,a,r),a}function C(e,n,i,r,a){var s={capture:r,passive:a},m=up(e,n,i,s);(n===document.body||n===window||n===document||n instanceof HTMLMediaElement)&&Go(()=>{n.removeEventListener(e,m,s)})}let Tu=null;function Kl(e){var n=this,i=n.ownerDocument,r=e.type,a=e.composedPath?.()||[],s=a[0]||e.target;Tu=e;var m=0,h=Tu===e&&e[Eo];if(h){var y=a.indexOf(h);if(y!==-1&&(n===document||n===window)){e[Eo]=n;return}var S=a.indexOf(n);if(S===-1)return;y<=S&&(m=y)}if(s=a[m]||e.target,s!==n){sc(e,"currentTarget",{configurable:!0,get(){return s||i}});var b=qe,T=Me;Ui(null),hs(null);try{for(var N,q=[];s!==null;){var O=s.assignedSlot||s.parentNode||s.host||null;try{var E=s[Eo]?.[r];E!=null&&(!s.disabled||e.target===s)&&E.call(s,e)}catch(P){N?q.push(P):N=P}if(e.cancelBubble||O===n||O===null)break;s=O}if(N){for(let P of q)queueMicrotask(()=>{throw P});throw N}}finally{e[Eo]=n,delete e.currentTarget,Ui(b),hs(T)}}}const fp=globalThis?.window?.trustedTypes&&globalThis.window.trustedTypes.createPolicy("svelte-trusted-html",{createHTML:e=>e});function dp(e){return fp?.createHTML(e)??e}function Mf(e,n=!1){var i=Ov("template");return e=e.replaceAll("<!>","<!---->"),i.innerHTML=n?dp(e):e,i.content}function vs(e,n){var i=Me;i.nodes===null&&(i.nodes={start:e,end:n,a:null,t:null})}function F(e,n){var i=(n&Bv)!==0,r=(n&Dv)!==0,a,s=!e.startsWith("<!>");return()=>{if(ge)return vs(Fe,null),Fe;a===void 0&&(a=Mf(s?e:"<!>"+e,!0),i||(a=Pi(a)));var m=r||tf?document.importNode(a,!0):a.cloneNode(!0);if(i){var h=Pi(m),y=m.lastChild;vs(h,y)}else vs(m,m);return m}}function Xi(e=""){if(!ge){var n=Ti(e+"");return vs(n,n),n}var i=Fe;return i.nodeType!==to?(i.before(i=Ti()),Qr(i)):Wo(i),vs(i,i),i}function Vs(){if(ge)return vs(Fe,null),Fe;var e=document.createDocumentFragment(),n=document.createComment(""),i=Ti();return e.append(n,i),vs(n,i),e}function M(e,n){if(ge){var i=Me;((i.f&Ks)===0||i.nodes.end===null)&&(i.nodes.end=Fe),oa();return}e!==null&&e.before(n)}const vp=["touchstart","touchmove"];function pp(e){return vp.includes(e)}function D(e,n){var i=n==null?"":typeof n=="object"?n+"":n;i!==(e.__t??=e.nodeValue)&&(e.__t=i,e.nodeValue=i+"")}function Bf(e,n){return Df(e,n)}function mp(e,n){Pl(),n.intro=n.intro??!1;const i=n.target,r=ge,a=Fe;try{for(var s=Pi(i);s&&(s.nodeType!==Ba||s.data!==lc);)s=rs(s);if(!s)throw aa;As(!0),Qr(s);const m=Df(e,{...n,anchor:s});return As(!1),m}catch(m){if(m instanceof Error&&m.message.split(`
`).some(h=>h.startsWith("https://svelte.dev/e/")))throw m;return m!==aa&&console.warn("Failed to hydrate: ",m),n.recover===!1&&yv(),Pl(),uc(i),As(!1),Bf(e,n)}finally{As(r),Qr(a)}}const Ao=new Map;function Df(e,{target:n,anchor:i,props:r={},events:a,context:s,intro:m=!0}){Pl();var h=void 0,y=ap(()=>{var S=i??n.appendChild(Ti());Uv(S,{pending:()=>{}},N=>{Zr({});var q=Ln;if(s&&(q.c=s),a&&(r.$$events=a),ge&&vs(N,null),h=e(N,r)||{},ge&&(Me.nodes.end=Fe,Fe===null||Fe.nodeType!==Ba||Fe.data!==cc))throw ro(),aa;ti()});var b=new Set,T=N=>{for(var q=0;q<N.length;q++){var O=N[q];if(!b.has(O)){b.add(O);var E=pp(O);for(const U of[n,document]){var P=Ao.get(U);P===void 0&&(P=new Map,Ao.set(U,P));var vt=P.get(O);vt===void 0?(U.addEventListener(O,Kl,{passive:E}),P.set(O,1)):P.set(O,vt+1)}}}};return T(Ho(cp)),$u.add(T),()=>{for(var N of b)for(const E of[n,document]){var q=Ao.get(E),O=q.get(N);--O==0?(E.removeEventListener(N,Kl),q.delete(N),q.size===0&&Ao.delete(E)):q.set(N,O)}$u.delete(T),S!==i&&S.parentNode?.removeChild(S)}});return Gl.set(h,y),h}let Gl=new WeakMap;function hp(e,n){const i=Gl.get(e);return i?(Gl.delete(e),i(n)):Promise.resolve()}function gp(e){return function(...n){var i=n[0];i.target===this&&e?.apply(this,n)}}function ua(e){return function(...n){var i=n[0];return i.stopPropagation(),e?.apply(this,n)}}function fi(e){return new _p(e)}class _p{#t;#e;constructor(n){var i=new Map,r=(s,m)=>{var h=W(m,!1,!1);return i.set(s,h),h};const a=new Proxy({...n.props||{},$$events:{}},{get(s,m){return t(i.get(m)??r(m,Reflect.get(s,m)))},has(s,m){return m===Wu?!0:(t(i.get(m)??r(m,Reflect.get(s,m))),Reflect.has(s,m))},set(s,m,h){return f(i.get(m)??r(m,h),h),Reflect.set(s,m,h)}});this.#e=(n.hydrate?mp:Bf)(n.component,{target:n.target,anchor:n.anchor,props:a,context:n.context,intro:n.intro??!1,recover:n.recover}),(!n?.props?.$$host||n.sync===!1)&&cr(),this.#t=a.$$events;for(const s of Object.keys(this.#e))s==="$set"||s==="$destroy"||s==="$on"||sc(this,s,{get(){return this.#e[s]},set(m){this.#e[s]=m},enumerable:!0});this.#e.$set=s=>{Object.assign(a,s)},this.#e.$destroy=()=>{hp(this.#e)}}$set(n){this.#e.$set(n)}$on(n,i){this.#t[n]=this.#t[n]||[];const r=(...a)=>i.call(this,...a);return this.#t[n].push(r),()=>{this.#t[n]=this.#t[n].filter(a=>a!==r)}}$destroy(){this.#e.$destroy()}}const bp="5";typeof window<"u"&&((window.__svelte??={}).v??=new Set).add(bp);jv();class yp{anchor;#t=new Map;#e=new Map;#n=new Map;#s=new Set;#a=!0;constructor(n,i=!0){this.anchor=n,this.#a=i}#o=()=>{var n=Je;if(this.#t.has(n)){var i=this.#t.get(n),r=this.#e.get(i);if(r)gc(r),this.#s.delete(i);else{var a=this.#n.get(i);a&&(this.#e.set(i,a.effect),this.#n.delete(i),a.fragment.lastChild.remove(),this.anchor.before(a.fragment),r=a.effect)}for(const[s,m]of this.#t){if(this.#t.delete(s),s===n)break;const h=this.#n.get(m);h&&(ji(h.effect),this.#n.delete(m))}for(const[s,m]of this.#e){if(s===i||this.#s.has(s))continue;const h=()=>{if(Array.from(this.#t.values()).includes(s)){var S=document.createDocumentFragment();Nf(m,S),S.append(Ti()),this.#n.set(s,{effect:m,fragment:S})}else ji(m);this.#s.delete(s),this.#e.delete(s)};this.#a||!r?(this.#s.add(s),ia(m,h,!1)):h()}}};#r=n=>{this.#t.delete(n);const i=Array.from(this.#t.values());for(const[r,a]of this.#n)i.includes(r)||(ji(a.effect),this.#n.delete(r))};ensure(n,i){var r=Je,a=rf();if(i&&!this.#e.has(n)&&!this.#n.has(n))if(a){var s=document.createDocumentFragment(),m=Ti();s.append(m),this.#n.set(n,{effect:Yi(()=>i(m)),fragment:s})}else this.#e.set(n,Yi(()=>i(this.anchor)));if(this.#t.set(r,n),a){for(const[h,y]of this.#e)h===n?r.unskip_effect(y):r.skip_effect(y);for(const[h,y]of this.#n)h===n?r.unskip_effect(y.effect):r.skip_effect(y.effect);r.oncommit(this.#o),r.ondiscard(this.#r)}else ge&&(this.anchor=Fe),this.#o()}}function qa(e){Ln===null&&oc(),Da&&Ln.l!==null?kp(Ln).m.push(e):Jl(()=>{const n=_(e);if(typeof n=="function")return n})}function wp(e){Ln===null&&oc(),qa(()=>()=>_(e))}function xp(e,n,{bubbles:i=!1,cancelable:r=!1}={}){return new CustomEvent(e,{detail:n,bubbles:i,cancelable:r})}function _c(){const e=Ln;return e===null&&oc(),(n,i,r)=>{const a=e.s.$$events?.[n];if(a){const s=eo(a)?a.slice():[a],m=xp(n,i,r);for(const h of s)h.call(e.x,m);return!m.defaultPrevented}return!0}}function kp(e){var n=e.l;return n.u??={a:[],b:[],m:[]}}function tt(e,n,i=!1){ge&&oa();var r=new yp(e),a=i?ja:0;function s(m,h){if(ge){const b=Zu(e);var y;if(b===lc?y=0:b===zo?y=!1:y=parseInt(b.substring(1)),m!==y){var S=qo();Qr(S),r.anchor=S,As(!1),r.ensure(m,h),As(!0);return}}r.ensure(m,h)}mc(()=>{var m=!1;n((h,y=0)=>{m=!0,s(y,h)}),m||s(!1,null)},a)}function Jn(e,n){return n}function Sp(e,n,i){for(var r=[],a=n.length,s,m=n.length,h=0;h<a;h++){let T=n[h];ia(T,()=>{if(s){if(s.pending.delete(T),s.done.add(T),s.pending.size===0){var N=e.outrogroups;Vl(Ho(s.done)),N.delete(s),N.size===0&&(e.outrogroups=null)}}else m-=1},!1)}if(m===0){var y=r.length===0&&i!==null;if(y){var S=i,b=S.parentNode;uc(b),b.append(S),e.items.clear()}Vl(n,!y)}else s={pending:new Set(n),done:new Set},(e.outrogroups??=new Set).add(s)}function Vl(e,n=!0){for(var i=0;i<e.length;i++)ji(e[i],n)}var ju;function cn(e,n,i,r,a,s=null){var m=e,h=new Map,y=(n&Xu)!==0;if(y){var S=e;m=ge?Qr(Pi(S)):S.appendChild(Ti())}ge&&oa();var b=null,T=Ia(()=>{var vt=i();return eo(vt)?vt:vt==null?[]:Ho(vt)}),N,q=!0;function O(){P.fallback=b,$p(P,N,m,n,r),b!==null&&(N.length===0?(b.f&Es)===0?gc(b):(b.f^=Es,Ja(b,null,m)):ia(b,()=>{b=null}))}var E=mc(()=>{N=t(T);var vt=N.length;let U=!1;if(ge){var lt=Zu(m)===zo;lt!==(vt===0)&&(m=qo(),Qr(m),As(!1),U=!0)}for(var Tt=new Set,kt=Je,Mt=rf(),Wt=0;Wt<vt;Wt+=1){ge&&Fe.nodeType===Ba&&Fe.data===cc&&(m=Fe,U=!0,As(!1));var et=N[Wt],Et=r(et,Wt),$t=q?null:h.get(Et);$t?($t.v&&Na($t.v,et),$t.i&&Na($t.i,Wt),Mt&&kt.unskip_effect($t.e)):($t=Tp(h,q?m:ju??=Ti(),et,Et,Wt,a,n,i),q||($t.e.f|=Es),h.set(Et,$t)),Tt.add(Et)}if(vt===0&&s&&!b&&(q?b=Yi(()=>s(m)):(b=Yi(()=>s(ju??=Ti())),b.f|=Es)),vt>Tt.size&&mv(),ge&&vt>0&&Qr(qo()),!q)if(Mt){for(const[Jt,de]of h)Tt.has(Jt)||kt.skip_effect(de.e);kt.oncommit(O),kt.ondiscard(()=>{})}else O();U&&As(!0),t(T)}),P={effect:E,items:h,outrogroups:null,fallback:b};q=!1,ge&&(m=Fe)}function Wa(e){for(;e!==null&&(e.f&ns)===0;)e=e.next;return e}function $p(e,n,i,r,a){var s=(r&Cv)!==0,m=n.length,h=e.items,y=Wa(e.effect.first),S,b=null,T,N=[],q=[],O,E,P,vt;if(s)for(vt=0;vt<m;vt+=1)O=n[vt],E=a(O,vt),P=h.get(E).e,(P.f&Es)===0&&(P.nodes?.a?.measure(),(T??=new Set).add(P));for(vt=0;vt<m;vt+=1){if(O=n[vt],E=a(O,vt),P=h.get(E).e,e.outrogroups!==null)for(const $t of e.outrogroups)$t.pending.delete(P),$t.done.delete(P);if((P.f&Es)!==0)if(P.f^=Es,P===y)Ja(P,null,i);else{var U=b?b.next:y;P===e.effect.last&&(e.effect.last=P.prev),P.prev&&(P.prev.next=P.next),P.next&&(P.next.prev=P.prev),Fs(e,b,P),Fs(e,P,U),Ja(P,U,i),b=P,N=[],q=[],y=Wa(b.next);continue}if((P.f&Bi)!==0&&(gc(P),s&&(P.nodes?.a?.unfix(),(T??=new Set).delete(P))),P!==y){if(S!==void 0&&S.has(P)){if(N.length<q.length){var lt=q[0],Tt;b=lt.prev;var kt=N[0],Mt=N[N.length-1];for(Tt=0;Tt<N.length;Tt+=1)Ja(N[Tt],lt,i);for(Tt=0;Tt<q.length;Tt+=1)S.delete(q[Tt]);Fs(e,kt.prev,Mt.next),Fs(e,b,kt),Fs(e,Mt,lt),y=lt,b=Mt,vt-=1,N=[],q=[]}else S.delete(P),Ja(P,y,i),Fs(e,P.prev,P.next),Fs(e,P,b===null?e.effect.first:b.next),Fs(e,b,P),b=P;continue}for(N=[],q=[];y!==null&&y!==P;)(S??=new Set).add(y),q.push(y),y=Wa(y.next);if(y===null)continue}(P.f&Es)===0&&N.push(P),b=P,y=Wa(P.next)}if(e.outrogroups!==null){for(const $t of e.outrogroups)$t.pending.size===0&&(Vl(Ho($t.done)),e.outrogroups?.delete($t));e.outrogroups.size===0&&(e.outrogroups=null)}if(y!==null||S!==void 0){var Wt=[];if(S!==void 0)for(P of S)(P.f&Bi)===0&&Wt.push(P);for(;y!==null;)(y.f&Bi)===0&&y!==e.fallback&&Wt.push(y),y=Wa(y.next);var et=Wt.length;if(et>0){var Et=(r&Xu)!==0&&m===0?i:null;if(s){for(vt=0;vt<et;vt+=1)Wt[vt].nodes?.a?.measure();for(vt=0;vt<et;vt+=1)Wt[vt].nodes?.a?.fix()}Sp(e,Wt,Et)}}s&&ds(()=>{if(T!==void 0)for(P of T)P.nodes?.a?.apply()})}function Tp(e,n,i,r,a,s,m,h){var y=(m&Ev)!==0?(m&Iv)===0?W(i,!1,!1):la(i):null,S=(m&Av)!==0?la(a):null;return{v:y,i:S,e:Yi(()=>(s(n,y??i,S??a,h),()=>{e.delete(r)}))}}function Ja(e,n,i){if(e.nodes)for(var r=e.nodes.start,a=e.nodes.end,s=n&&(n.f&Es)===0?n.nodes.start:i;r!==null;){var m=rs(r);if(s.before(r),r===a)return;r=m}}function Fs(e,n,i){n===null?e.effect.first=i:n.next=i,i===null?e.effect.last=n:i.prev=n}function jp(e,n,i=!1,r=!1,a=!1){var s=e,m="";rt(()=>{var h=Me;if(m===(m=n()??"")){ge&&oa();return}if(h.nodes!==null&&(Ef(h.nodes.start,h.nodes.end),h.nodes=null),m!==""){if(ge){Fe.data;for(var y=oa(),S=y;y!==null&&(y.nodeType!==Ba||y.data!=="");)S=y,y=rs(y);if(y===null)throw ro(),aa;vs(Fe,S),s=Qr(y);return}var b=m+"";i?b=`<svg>${b}</svg>`:r&&(b=`<math>${b}</math>`);var T=Mf(b);if((i||r)&&(T=Pi(T)),vs(Pi(T),T.lastChild),i||r)for(;Pi(T);)s.before(Pi(T));else s.before(T)}})}function Lf(e,n,i,r,a){ge&&oa();var s=n.$$slots?.[i],m=!1;s===!0&&(s=n.children,m=!0),s===void 0||s(e,m?()=>r:r)}const Eu=[...` 	
\r\f \v\uFEFF`];function Ep(e,n,i){var r=e==null?"":""+e;if(n&&(r=r?r+" "+n:n),i){for(var a of Object.keys(i))if(i[a])r=r?r+" "+a:a;else if(r.length)for(var s=a.length,m=0;(m=r.indexOf(a,m))>=0;){var h=m+s;(m===0||Eu.includes(r[m-1]))&&(h===r.length||Eu.includes(r[h]))?r=(m===0?"":r.substring(0,m))+r.substring(h+1):m=h}}return r===""?null:r}function Ap(e,n){return e==null?null:String(e)}function Ne(e,n,i,r,a,s){var m=e.__className;if(ge||m!==i||m===void 0){var h=Ep(i,r,s);(!ge||h!==e.getAttribute("class"))&&(h==null?e.removeAttribute("class"):e.className=h),e.__className=i}else if(s&&a!==s)for(var y in s){var S=!!s[y];(a==null||S!==!!a[y])&&e.classList.toggle(y,S)}return s}function Ts(e,n,i,r){var a=e.__style;if(ge||a!==n){var s=Ap(n);(!ge||s!==e.getAttribute("style"))&&(s==null?e.removeAttribute("style"):e.style.cssText=s),e.__style=n}return r}function Rf(e,n,i=!1){if(e.multiple){if(n==null)return;if(!eo(n))return Rv();for(var r of e.options)r.selected=n.includes(Va(r));return}for(r of e.options){var a=Va(r);if(Fv(a,n)){r.selected=!0;return}}(!i||n!==void 0)&&(e.selectedIndex=-1)}function Cp(e){var n=new MutationObserver(()=>{Rf(e,e.__value)});n.observe(e,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["value"]}),Go(()=>{n.disconnect()})}function $s(e,n,i=n){var r=new WeakSet,a=!0;vc(e,"change",s=>{var m=s?"[selected]":":checked",h;if(e.multiple)h=[].map.call(e.querySelectorAll(m),Va);else{var y=e.querySelector(m)??e.querySelector("option:not([disabled])");h=y&&Va(y)}i(h),Je!==null&&r.add(Je)}),Tf(()=>{var s=n();if(e===document.activeElement){var m=Fo??Je;if(r.has(m))return}if(Rf(e,s,a),a&&s===void 0){var h=e.querySelector(":checked");h!==null&&(s=Va(h),i(s))}e.__value=s,a=!1}),Cp(e)}function Va(e){return"__value"in e?e.__value:e.value}const Ip=Symbol("is custom element"),Np=Symbol("is html"),Mp=cv?"link":"LINK";function tr(e){if(ge){var n=!1,i=()=>{if(!n){if(n=!0,e.hasAttribute("value")){var r=e.value;js(e,"value",null),e.value=r}if(e.hasAttribute("checked")){var a=e.checked;js(e,"checked",null),e.checked=a}}};e.__on_r=i,ds(i),hf()}}function js(e,n,i,r){var a=Bp(e);ge&&(a[n]=e.getAttribute(n),n==="src"||n==="srcset"||n==="href"&&e.nodeName===Mp)||a[n]!==(a[n]=i)&&(n==="loading"&&(e[lv]=i),i==null?e.removeAttribute(n):typeof i!="string"&&Dp(e).includes(n)?e[n]=i:e.setAttribute(n,i))}function Bp(e){return e.__attributes??={[Ip]:e.nodeName.includes("-"),[Np]:e.namespaceURI===Yu}}var Au=new Map;function Dp(e){var n=e.getAttribute("is")||e.nodeName,i=Au.get(n);if(i)return i;Au.set(n,i=[]);for(var r,a=e,s=Element.prototype;s!==a;){r=Uu(a);for(var m in r)r[m].set&&i.push(m);a=ac(a)}return i}function sn(e,n,i=n){var r=new WeakSet;vc(e,"input",async a=>{var s=a?e.defaultValue:e.value;if(s=Nl(e)?Ml(s):s,i(s),Je!==null&&r.add(Je),await rp(),s!==(s=n())){var m=e.selectionStart,h=e.selectionEnd,y=e.value.length;if(e.value=s??"",h!==null){var S=e.value.length;m===h&&h===y&&S>y?(e.selectionStart=S,e.selectionEnd=S):(e.selectionStart=m,e.selectionEnd=Math.min(h,S))}}}),(ge&&e.defaultValue!==e.value||_(n)==null&&e.value)&&(i(Nl(e)?Ml(e.value):e.value),Je!==null&&r.add(Je)),Ra(()=>{var a=n();if(e===document.activeElement){var s=Fo??Je;if(r.has(s))return}Nl(e)&&a===Ml(e.value)||e.type==="date"&&!a&&!e.value||a!==e.value&&(e.value=a??"")})}function Xl(e,n,i=n){vc(e,"change",r=>{var a=r?e.defaultChecked:e.checked;i(a)}),(ge&&e.defaultChecked!==e.checked||_(n)==null)&&i(e.checked),Ra(()=>{var r=n();e.checked=!!r})}function Nl(e){var n=e.type;return n==="number"||n==="range"}function Ml(e){return e===""?null:+e}function Cu(e,n){return e===n||e?.[Is]===n}function bc(e={},n,i,r){return Tf(()=>{var a,s;return Ra(()=>{a=s,s=[],_(()=>{e!==i(...s)&&(n(e,...s),a&&Cu(i(...a),e)&&n(null,...a))})}),()=>{ds(()=>{s&&Cu(i(...s),e)&&n(null,...s)})}}),e}function Ds(e=!1){const n=Ln,i=n.l.u;if(!i)return;let r=()=>ie(n.s);if(e){let a=0,s={};const m=Jo(()=>{let h=!1;const y=n.s;for(const S in y)y[S]!==s[S]&&(s[S]=y[S],h=!0);return h&&a++,a});r=()=>t(m)}i.b.length&&sp(()=>{Iu(n,r),Ro(i.b)}),Jl(()=>{const a=_(()=>i.m.map(vv));return()=>{for(const s of a)typeof s=="function"&&s()}}),i.a.length&&Jl(()=>{Iu(n,r),Ro(i.a)})}function Iu(e,n){if(e.l.s)for(const i of e.l.s)t(i);n()}function ps(e,n){var i=e.$$events?.[n.type],r=eo(i)?i.slice():i==null?[]:[i];for(var a of r)a.call(this,n)}function di(e,n,i){e.$$events||={},e.$$events[n]||=[],e.$$events[n].push(i)}function vi(e){for(var n in e)n in this&&(this[n]=e[n])}function yc(e,n,i){if(e==null)return n(void 0),i&&i(void 0),Ns;const r=_(()=>e.subscribe(n,i));return r.unsubscribe?()=>r.unsubscribe():r}const ya=[];function Lp(e,n){return{subscribe:gr(e,n).subscribe}}function gr(e,n=Ns){let i=null;const r=new Set;function a(h){if(Gu(e,h)&&(e=h,i)){const y=!ya.length;for(const S of r)S[1](),ya.push(S,e);if(y){for(let S=0;S<ya.length;S+=2)ya[S][0](ya[S+1]);ya.length=0}}}function s(h){a(h(e))}function m(h,y=Ns){const S=[h,y];return r.add(S),r.size===1&&(i=n(a,s)||Ns),h(e),()=>{r.delete(S),r.size===0&&i&&(i(),i=null)}}return{set:a,update:s,subscribe:m}}function Rp(e,n,i){const r=!Array.isArray(e),a=r?[e]:e;if(!a.every(Boolean))throw new Error("derived() expects stores as input, got a falsy value");const s=n.length<2;return Lp(i,(m,h)=>{let y=!1;const S=[];let b=0,T=Ns;const N=()=>{if(b)return;T();const O=n(r?S[0]:S,m,h);s?m(O):T=typeof O=="function"?O:Ns},q=a.map((O,E)=>yc(O,P=>{S[E]=P,b&=~(1<<E),y&&N()},()=>{b|=1<<E}));return y=!0,N(),function(){Ro(q),T(),y=!1}})}function es(e){let n;return yc(e,i=>n=i)(),n}let Co=!1,Yl=Symbol();function Zn(e,n,i){const r=i[n]??={store:null,source:W(void 0),unsubscribe:Ns};if(r.store!==e&&!(Yl in i))if(r.unsubscribe(),r.store=e??null,e==null)r.source.v=void 0,r.unsubscribe=Ns;else{var a=!0;r.unsubscribe=yc(e,s=>{a?r.source.v=s:f(r.source,s)}),a=!1}return e&&Yl in i?es(e):t(r.source)}function qp(e,n){return e.set(n),n}function Fa(){const e={};function n(){Go(()=>{for(var i in e)e[i].unsubscribe();sc(e,Yl,{enumerable:!1,value:!0})})}return[e,n]}function Fp(e){var n=Co;try{return Co=!1,[e(),Co]}finally{Co=n}}function jr(e,n,i,r){var a=!Da||(i&Nv)!==0,s=(i&Mv)!==0,m=r,h=!0,y=()=>(h&&(h=!1,m=r),m),S;{var b=Is in e||Wu in e;S=$a(e,n)?.set??(b&&n in e?U=>e[n]=U:void 0)}var T,N=!1;[T,N]=Fp(()=>e[n]),T===void 0&&r!==void 0&&(T=y(),S&&(a&&wv(),S(T)));var q;if(a?q=()=>{var U=e[n];return U===void 0?y():(h=!0,U)}:q=()=>{var U=e[n];return U!==void 0&&(m=void 0),U===void 0?m:U},S){var O=e.$$legacy;return(function(U,lt){return arguments.length>0?((!a||!lt||O||N)&&S(lt?q():U),U):q()})}var E=!1,P=Ia(()=>(E=!1,q()));t(P);var vt=Me;return(function(U,lt){if(arguments.length>0){const Tt=lt?t(P):a&&s?ka(U):U;return f(P,Tt),E=!0,m!==void 0&&(m=Tt),U}return Gs&&E||(vt.f&Cs)!==0?P.v:t(P)})}const Ms=gr(""),zs=gr(""),mr=gr(""),$r=gr(null),Qn=gr(!1),xa=gr("就绪"),ui=gr("就绪"),wc=gr([]),Op=gr("等待解析…"),Pp=gr([]),Hp=gr([]),xc=gr([]),Ps=gr(!1),Do=gr(null),Vo=gr([]),fa=gr(-1),kc=Rp(mr,e=>String(e||"").replace(/\s/g,"").length),Ql=gr([]),Nu=gr(!1),Ua=gr(!1);let Bl=null,Dl=null;typeof window<"u"&&(window.__waGetStore=e=>{const i={docId:Ms,instruction:zs,sourceText:mr,docIr:$r,docIrDirty:Qn,flowStatus:xa,docStatus:ui,generating:Ps,wordCount:kc}[e];return i?es(i):void 0});async function zp(){const e=es(Ms);if(!e)return;const n=await fetch(`/api/doc/${e}/chat`);if(!n.ok)return;const i=await n.json(),r=Array.isArray(i.items)?i.items:[];wc.set(r)}async function Wp(){const e=es(Ms);if(!e)return;const n=await fetch(`/api/doc/${e}/thoughts`);if(!n.ok)return;const i=await n.json(),r=Array.isArray(i.items)?i.items:[];xc.set(r)}async function Up(e){const n=es(Ms);n&&await fetch(`/api/doc/${n}/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({items:e.slice(-200)})})}async function Jp(e){const n=es(Ms);n&&await fetch(`/api/doc/${n}/thoughts`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({items:e.slice(-200)})})}function Hr(e,n){const i={role:e,text:String(n||"").trim()};i.text&&wc.update(r=>{const a=[...r,i];return Bl&&clearTimeout(Bl),Bl=setTimeout(()=>{Up(a).catch(()=>{})},300),a})}function Xr(e,n,i){const r={label:e,detail:n,time:i||new Date().toLocaleTimeString()};xc.update(a=>{const s=[...a,r].slice(-200);return Dl&&clearTimeout(Dl),Dl=setTimeout(()=>{Jp(s).catch(()=>{})},300),s})}function gt(e,n="info"){const i=Date.now(),r={id:i,message:e,type:n};Ql.update(a=>[...a,r]),setTimeout(()=>{Ql.update(a=>a.filter(s=>s.id!==i))},2600)}function Mu(e){const n=String(e||"");Vo.update(i=>{const r=i.slice(0,es(fa)+1);if(r[r.length-1]===n)return i;r.push(n);const a=r.slice(-50);return fa.set(a.length-1),a})}function Kp(){const e=es(fa);if(e<=0)return;fa.set(e-1);const n=es(Vo);mr.set(n[e-1]||""),Qn.set(!0)}function Gp(){const e=es(fa),n=es(Vo);e>=n.length-1||(fa.set(e+1),mr.set(n[e+1]||""),Qn.set(!0))}var Vp=F('<div class="assistant-header svelte-191yngm"><div class="assistant-title svelte-191yngm"><span class="assistant-dot svelte-191yngm"></span> 智能助手</div> <button class="assistant-toggle svelte-191yngm"> </button></div>'),Xp=F('<div class="panel-title svelte-191yngm">对话写作</div>'),Yp=F('<div class="thought-item svelte-191yngm"><div class="thought-meta svelte-191yngm"><span class="label"> </span> <span class="time"> </span></div> <div class="detail svelte-191yngm"> </div></div>'),Qp=F('<div class="thoughts svelte-191yngm"><div class="thoughts-title svelte-191yngm">思考链</div> <div class="thought-list svelte-191yngm"></div></div>'),Zp=F('<div><div class="chat-bubble svelte-191yngm"> </div></div>'),tm=F('<div><!> <!> <div class="chat-history svelte-191yngm"></div> <div class="composer-tools svelte-191yngm"><button class="attach-btn svelte-191yngm">上传内容</button> <span class="composer-tip svelte-191yngm">支持图片与文档</span></div> <div class="composer svelte-191yngm"><textarea rows="3" placeholder="输入需求或修改指令" class="svelte-191yngm"></textarea> <button class="send-btn svelte-191yngm">发送</button></div> <input class="hidden-input svelte-191yngm" type="file" accept="image/*,.doc,.docx,.pdf,.txt,.md,.html,.htm,.ppt,.pptx,.xls,.xlsx,.csv,.json"/></div>');function qf(e,n){if(new.target)return fi({component:qf,...e});Zr(n,!1);const i=()=>Zn(zs,"$instruction",s),r=()=>Zn(xc,"$thoughtLog",s),a=()=>Zn(wc,"$chat",s),[s,m]=Fa(),h=_c();let y=jr(n,"variant",12,"panel"),S=W(!0),b=W(null);function T(){const Bt=i().trim();Bt&&(h("send",Bt),zs.set(""),O())}function N(Bt){Bt.key==="Enter"&&!Bt.shiftKey&&(Bt.preventDefault(),T())}function q(){f(S,!t(S)),O()}function O(){queueMicrotask(()=>{const Bt=document.querySelector(".chat-history");Bt&&(Bt.scrollTop=Bt.scrollHeight);const pt=document.querySelector(".thought-list");pt&&(pt.scrollTop=pt.scrollHeight)})}function E(){t(b)?.click()}function P(Bt){const pt=Bt.currentTarget,jt=pt?.files?.[0];jt&&(h("upload",{file:jt}),pt&&(pt.value=""))}var vt={get variant(){return y()},set variant(Bt){y(Bt),cr()},$set:vi,$on:(Bt,pt)=>di(n,Bt,pt)};Ds();var U=tm(),lt=p(U);{var Tt=Bt=>{var pt=Vp(),jt=u(p(pt),2),Dt=p(jt,!0);d(jt),d(pt),rt(()=>D(Dt,t(S)?"隐藏思考":"思考链")),C("click",jt,q),M(Bt,pt)},kt=Bt=>{var pt=Xp();M(Bt,pt)};tt(lt,Bt=>{y()==="assistant"?Bt(Tt):Bt(kt,!1)})}var Mt=u(lt,2);{var Wt=Bt=>{var pt=Qp(),jt=u(p(pt),2);cn(jt,5,r,Jn,(Dt,Xt)=>{var mn=Yp(),fn=p(mn),De=p(fn),bt=p(De,!0);d(De);var At=u(De,2),ne=p(At,!0);d(At),d(fn);var Oe=u(fn,2),_e=p(Oe,!0);d(Oe),d(mn),rt(()=>{D(bt,(t(Xt),_(()=>t(Xt).label))),D(ne,(t(Xt),_(()=>t(Xt).time))),D(_e,(t(Xt),_(()=>t(Xt).detail)))}),M(Dt,mn)}),d(jt),d(pt),M(Bt,pt)};tt(Mt,Bt=>{t(S)&&Bt(Wt)})}var et=u(Mt,2);cn(et,5,a,Jn,(Bt,pt)=>{var jt=Zp(),Dt=p(jt),Xt=p(Dt,!0);d(Dt),d(jt),rt(()=>{Ne(jt,1,`chat-msg ${t(pt),_(()=>t(pt).role)??""}`,"svelte-191yngm"),D(Xt,(t(pt),_(()=>t(pt).text)))}),M(Bt,jt)}),d(et);var Et=u(et,2),$t=p(Et);us(2),d(Et);var Jt=u(Et,2),de=p(Jt);fs(de);var Be=u(de,2);d(Jt);var ke=u(Jt,2);bc(ke,Bt=>f(b,Bt),()=>t(b)),d(U),rt(()=>Ne(U,1,`chat-shell ${y()}`,"svelte-191yngm")),C("click",$t,E),sn(de,i,Bt=>qp(zs,Bt)),C("keydown",de,N),C("click",Be,T),C("change",ke,P),M(e,U);var un=ti(vt);return m(),un}function lr(e){return String(e||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function ms(e){let n=lr(e);return n=n.replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>"),n=n.replace(/\*(.+?)\*/g,"<em>$1</em>"),n=n.replace(/~~(.+?)~~/g,"<del>$1</del>"),n=n.replace(/==(.+?)==/g,"<mark>$1</mark>"),n=n.replace(/\+\+(.+?)\+\+/g,"<u>$1</u>"),n=n.replace(/\[(.+?)\]\((.+?)\)/g,'<a href="$2" target="_blank" rel="noopener">$1</a>'),n}function Oo(e){return String(e||"").trim().toLowerCase()}function Ff(e){const n=[];let i=[],r=!1;const a=()=>{i.length&&(i.length>=4?n.push(i.join("")):n.push(...i),i=[])};for(const s of e){const m=s.trim();if(!m){a(),r||(n.push(""),r=!0);continue}r=!1;const h=m.length<=1,y=/[\u4e00-\u9fa5A-Za-z0-9\.\-\u3000-\u303F]/.test(m);if(h&&y){i.push(m);continue}a(),n.push(s)}return a(),n}function Po(e,n,i=""){const r=ms(n),a=Math.min(6,Math.max(1,Number(e||1)));return`<h${a}${i}>${r}</h${a}>`}function em(e){return`<p>${ms(e).replace(/\n/g,"<br/>")}</p>`}function nm(e){const n=String(e.id||"").trim();return n?` data-block-id="${lr(n)}"`:""}function Sc(e){const n=e.style;if(!n||typeof n!="object")return"";const i=n,r=[],a=String(i.align||i.textAlign||"").trim();["left","center","right","justify"].includes(a)&&r.push(`text-align:${a}`);const s=String(i.lineHeight||"").trim();/^\d+(\.\d+)?$/.test(s)&&r.push(`line-height:${s}`);const m=String(i.indent||i.textIndent||"").trim();/^\d+(\.\d+)?(px|pt|em|rem)?$/.test(m)&&r.push(`text-indent:${m}`);const h=String(i.marginTop||"").trim();/^\d+(\.\d+)?(px|pt|em|rem)?$/.test(h)&&r.push(`margin-top:${h}`);const y=String(i.marginBottom||"").trim();/^\d+(\.\d+)?(px|pt|em|rem)?$/.test(y)&&r.push(`margin-bottom:${y}`);const S=String(i.fontFamily||"").trim();S&&S.length<80&&r.push(`font-family:${lr(S)}`);const b=String(i.fontSize||"").trim();/^\d+(\.\d+)?(px|pt|em|rem)?$/.test(b)&&r.push(`font-size:${b}`);const T=String(i.fontWeight||"").trim();/^(normal|bold|bolder|lighter|[1-9]00)$/.test(T)&&r.push(`font-weight:${T}`);const N=String(i.fontStyle||"").trim();/^(normal|italic|oblique)$/.test(N)&&r.push(`font-style:${N}`);const q=String(i.color||"").trim();(/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(q)||q.startsWith("rgb(")||q.startsWith("rgba("))&&r.push(`color:${lr(q)}`);const O=String(i.background||i.backgroundColor||"").trim();return(/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(O)||O.startsWith("rgb(")||O.startsWith("rgba("))&&r.push(`background-color:${lr(O)}`),r.length?` style="${r.join(";")}"`:""}function rm(e){const n={caption:"",columns:[],rows:[]},i=e.table,r=typeof i=="object"&&i?i:e.data,a=typeof r=="object"&&r?r:e;n.caption=String(a.caption||"").trim();const s=a.columns;Array.isArray(s)&&(n.columns=s.map(h=>String(h)));const m=a.rows;return Array.isArray(m)&&(n.rows=m),n}function im(e){const n=e.figure,i=typeof n=="object"&&n?n:null,a=String((i||e).caption||"").trim(),s=i?{...i}:{};return a&&(s.caption=a),{caption:a,spec:s}}function sm(e){const n=[],i=String(e.color||"").trim();(/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(i)||i.startsWith("rgb("))&&n.push(`color:${lr(i)}`);const r=String(e.background||"").trim();(/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(r)||r.startsWith("rgb("))&&n.push(`background-color:${lr(r)}`);const a=String(e.font||"").trim();a&&a.length<80&&n.push(`font-family:${lr(a)}`);const s=String(e.size||"").trim();return/^\d+(\.\d+)?(px|pt|em|rem)?$/.test(s)&&n.push(`font-size:${s}`),n.length?` style="${n.join(";")}"`:""}function Bu(e){const n=[];return e.forEach(i=>{const r=String(i.text||"");if(!r)return;let a=lr(r).replace(/\n/g,"<br/>");i.bold&&(a=`<strong>${a}</strong>`),i.italic&&(a=`<em>${a}</em>`),i.underline&&(a=`<u>${a}</u>`),i.strike&&(a=`<del>${a}</del>`);const s=String(i.link||"").trim();s&&(a=`<a href="${lr(s)}" target="_blank" rel="noopener">${a}</a>`);const m=sm(i);m&&(a=`<span${m}>${a}</span>`),n.push(a)}),n.join("")}function am(e){const n=/^H([1-6])::(.+)$/.exec(e);if(n){const i=Math.min(6,Math.max(1,Number(n[1]||2))),r=String(n[2]||"").trim();if(r)return`${"#".repeat(i)} ${r}`}return`## ${e}`}function om(e){const n=/^H([1-6])::(.+)$/.exec(e);if(n){const i=Math.min(6,Math.max(1,Number(n[1]||2))),r=String(n[2]||"").trim();if(r)return Po(i,r)}return Po(2,e)}function Of(e){const n=String(e.type||"paragraph").toLowerCase();if(n==="paragraph"||n==="text"||n==="p"){const r=Array.isArray(e.runs)?e.runs:null,s=(r&&r.length?r.map(m=>String(m.text||"")).join(""):String(e.text||"")).trim();return s?[s]:[]}if(n==="list"||n==="bullets"||n==="bullet"){const r=!!e.ordered,a=Array.isArray(e.items)?e.items:[];if(a.length){const h=a.map(y=>String(y||"").trim()).filter(Boolean);return r?h.map((y,S)=>`${S+1}. ${y}`):h.map(y=>`- ${y}`)}const s=String(e.text||"").trim();if(!s)return[];const m=s.split(/\n+/).map(h=>h.trim()).filter(Boolean);return r?m.map((h,y)=>`${y+1}. ${h.replace(/^\d+[\.\)]\s+/,"")}`):m.map(h=>h.startsWith("-")?h:`- ${h}`)}if(n==="table"||n==="figure"){const r={};return typeof e.caption=="string"&&(r.caption=e.caption),Array.isArray(e.columns)&&(r.columns=e.columns),Array.isArray(e.rows)&&(r.rows=e.rows),e.data&&typeof e.data=="object"&&(r.data=e.data),[`[[${n==="table"?"TABLE":"FIGURE"}:${JSON.stringify(r)}]]`]}if(n==="reference"||n==="ref"){const r=String(e.text||"").trim();return r?[r]:(Array.isArray(e.items)?e.items:[]).map(s=>String(s||"").trim()).filter(Boolean)}const i=String(e.text||"").trim();return i?[i]:[]}function Pf(e){const n=nm(e),i=Sc(e),r=String(e.type||"paragraph").toLowerCase();if(r==="heading"){const s=Math.min(6,Math.max(1,Number(e.level||1))),m=String(e.text||""),h=Array.isArray(e.runs)?e.runs:null,y=m.trim(),S=`${n}${i}`;if(h&&h.length){const b=Bu(h);return`<h${s}${S}>${b||"<br/>"}</h${s}>`}return y?Po(s,m,S):S?`<h${s}${S}><br/></h${s}>`:""}if(r==="paragraph"||r==="text"||r==="p"){const s=String(e.text||""),m=Array.isArray(e.runs)?e.runs:null,h=s.trim(),y=`${n}${i}`;if(m&&m.length){const S=Bu(m);return`<p${y}>${S||"<br/>"}</p>`}return h?`<p${y}>${ms(s).replace(/\n/g,"<br/>")}</p>`:y?`<p${y}><br/></p>`:""}if(r==="list"||r==="bullets"||r==="bullet"){let s=!!e.ordered;const m=Array.isArray(e.items)?e.items:[],h=m.length>0;let y=m.length?m.map(T=>String(T??"")):String(e.text||"").split(/\n+/).map(T=>T.trim()).filter(Boolean);if(!y.length&&!h)return"";if(!s){const T=/^\d+[\.\)]\s+/;y.filter(q=>T.test(q)).length===y.length&&(s=!0,y=y.map(q=>q.replace(T,"")))}const S=y.map(T=>{const N=String(T??"");return N.trim()?`<li>${ms(N)}</li>`:"<li><br/></li>"}).join(""),b=`${n}${i}`;return s?`<ol${b}>${S}</ol>`:`<ul${b}>${S}</ul>`}if(r==="table"){const s=rm(e),m=s.caption||"Table",h=s.columns.length?s.columns:["Col 1","Col 2"],y=s.rows.length?s.rows:[["",""]],S=h.map(N=>`<th>${lr(N)}</th>`).join(""),b=y.map(N=>{const q=Array.isArray(N)?N:[N];return`<tr>${h.map((E,P)=>`<td>${lr(String(q[P]??""))}</td>`).join("")}</tr>`}).join("");return`<figure class="wa-table"${`${n}${i}`}><figcaption>${lr(m)}</figcaption><table><thead><tr>${S}</tr></thead><tbody>${b}</tbody></table></figure>`}if(r==="figure"){const s=im(e),m=s.caption||"图示",h=`${n}${i}`,y=s.spec&&typeof s.spec=="object"?encodeURIComponent(JSON.stringify(s.spec)):"",S=y?` data-figure-spec="${lr(y)}"`:"";return`<figure class="wa-figure"${h}${S}><div class="wa-figure-box">图</div><figcaption>${lr(m)}</figcaption></figure>`}if(r==="quote"){const s=String(e.text||"").trim();return s?`<blockquote>${ms(s)}</blockquote>`:""}const a=String(e.text||"").trim();return a?em(a):""}function $c(e){for(const n of e)if(String(n.type||"").toLowerCase()==="heading"&&Number(n.level||0)===1){const r=String(n.text||"").trim();if(r)return r}for(const n of e)if(String(n.type||"")==="paragraph"){const i=String(n.text||"").trim();if(i)return i.slice(0,24)}return""}function Zl(e){const n=[];let i="";for(const r of e){const a=String(r.section_id||r.section_title||"").trim();if(a&&a!==i){const s=am(a);s&&n.push(s),i=a}n.push(...Of(r))}return n.length?n.join(`

`).trim():null}function tc(e,n){const i=['<div class="wa-doc">'],r=String(n||"").trim()||$c(e);i.push(`<div class="wa-header" contenteditable="false">${lr(r)}</div>`),i.push('<div class="wa-body">'),r&&i.push(`<div class="wa-title">${ms(r)}</div>`);let a="",s=!1;for(const m of e){const h=String(m.section_id||m.section_title||"").trim();if(h&&h!==a){const b=om(h);b&&i.push(b),a=h}const y=String(m.type||"").toLowerCase();if(!s&&r&&y==="heading"&&Number(m.level||0)===1){const b=String(m.text||"").trim();if(Oo(b)===Oo(r)){s=!0;continue}}const S=Pf(m);S&&i.push(S)}return i.push("</div>"),i.push('<div class="wa-footer" contenteditable="false">Page 1</div>'),i.push("</div>"),i.length>2?i.join(""):null}function Hf(e){for(const n of e){const i=String(n.title||"").trim(),r=Number(n.level||0);if(i&&r<=1)return i;const a=Array.isArray(n.children)?n.children:[],s=Hf(a);if(s)return s}return""}function zf(e){const n=String(e.title||"").trim();if(n)return n;const i=Array.isArray(e.sections)?e.sections:[],r=Hf(i);if(r)return r;if(i.length===1){const s=i[0],m=Number(s.level||0),h=String(s.title||"").trim();if(h&&m<=1)return h}const a=Array.isArray(e.blocks)?e.blocks:[];return $c(a)}function Wf(e,n){const i=String(e.title||"").trim();if(i){const s=Math.min(6,Math.max(1,Number(e.level||2)));n.push(`${"#".repeat(s)} ${i}`)}const r=Array.isArray(e.blocks)?e.blocks:[];for(const s of r)n.push(...Of(s));const a=Array.isArray(e.children)?e.children:[];for(const s of a)Wf(s,n)}function Uf(e,n){const i=String(e.title||"").trim(),r=Math.min(6,Math.max(1,Number(e.level||2))),a=String(e.id||"").trim(),s=a?` data-section-id="${lr(a)}" data-section-level="${r}"`:"",m=Sc({style:e.style}),h=`${s}${m}`,y=[];i&&(r===1&&n&&Oo(i)===n||y.push(Po(r,i,h)));const S=Array.isArray(e.blocks)?e.blocks:[];for(const T of S){const N=Pf(T);N&&y.push(N)}const b=Array.isArray(e.children)?e.children:[];for(const T of b)y.push(Uf(T,n));return y.join("")}function lm(e){const n=String(e.title||"").trim(),i=Array.isArray(e.sections)?e.sections:[],r=[];n&&r.push(`# ${n}`);for(const a of i){const s=String(a.title||a.name||a.section||"").trim();if(!s)continue;r.push(`## ${s}`);let m=a.content??a.text??a.body;Array.isArray(m)&&(m=m.map(y=>String(y||"").trim()).filter(Boolean).join(`

`));const h=String(m||"").trim();h&&r.push(h)}return r.length?r.join(`

`).trim():null}function Ya(e){const n=zf(e),i=Array.isArray(e.sections)?e.sections:[],r=[];n&&r.push(`# ${n}`);for(const a of i)Wf(a,r);return r.length?r.join(`

`).trim():null}function Du(e){const n=zf(e),i=Array.isArray(e.sections)?e.sections:[];if(!n&&i.length===0)return null;const r=['<div class="wa-doc">'];r.push(`<div class="wa-header" contenteditable="false">${lr(n)}</div>`),r.push('<div class="wa-body">');const a=Oo(n),s=Sc({style:e.title_style});n&&r.push(`<div class="wa-title"${s}>${ms(n)}</div>`);for(const m of i)r.push(Uf(m,a));return r.push("</div>"),r.push('<div class="wa-footer" contenteditable="false">Page 1</div>'),r.push("</div>"),r.join("")}function cm(e){const n=String(e.type||"paragraph").toLowerCase(),r=String(e.id||"").trim()||Lo();if(n==="paragraph"){const s=String(e.text||"").trim();return s?{id:r,type:"paragraph",text:s}:null}if(n==="list"){const s=Array.isArray(e.items)?e.items.map(m=>String(m||"").trim()).filter(Boolean):[];return s.length?{id:r,type:"list",items:s,ordered:!!e.ordered}:null}if(n==="table")return{id:r,type:"table",table:e.table||{}};if(n==="figure")return{id:r,type:"figure",figure:e.figure||{}};const a=String(e.text||"").trim();return a?{id:r,type:"paragraph",text:a}:null}function Lo(){return typeof crypto<"u"&&"randomUUID"in crypto?crypto.randomUUID().replace(/-/g,""):`b${Math.random().toString(16).slice(2)}${Date.now().toString(16)}`}function um(e,n){const i=String(n).trim()||"自动生成文档",r=[],a=[];let s=[];const m=()=>{if(!s.length)return;const h={id:Lo(),title:i,level:1,blocks:s,children:[]};r.push(h),a.push({level:1,node:h}),s=[]};for(const h of e){if(String(h.type||"").toLowerCase()==="heading"){const b=Math.min(6,Math.max(1,Number(h.level||1))),T=String(h.text||"").trim()||"章节",N={id:Lo(),title:T,level:b,blocks:[],children:[]};for(s.length&&a.length===0&&m();a.length&&a[a.length-1].level>=b;)a.pop();a.length?a[a.length-1].node.children.push(N):r.push(N),a.push({level:b,node:N});continue}const S=cm(h);S&&(a.length?a[a.length-1].node.blocks.push(S):s.push(S))}return s.length&&!r.length&&r.push({id:Lo(),title:i,level:1,blocks:s,children:[]}),{title:i,sections:r}}const Jf=["摘要","引言","绪论","背景","研究背景","目标","范围","术语","定义","需求","需求分析","总体设计","系统设计","架构设计","详细设计","模块设计","实现","关键技术","应用","方法","数据","分析","讨论","评估","结果","结论","总结","展望","风险","问题","计划","本周工作","下周计划","问题与风险","需协助事项","参考文献","附录","致谢"],cs=/[。！？!?；;，、]/,Kf=["本文","本研究","本项目","作为","通过","基于","采用","利用","借助","随着","本周","本次","本节","我们","由于","因此","此外","同时","首先","其次","最后"],fm=["作为","尽管","通过","基于","采用","利用","借助","随着","为了","针对","此外","同时","首先","其次","最后"],dm=["模型","系统"];function Zs(e){return String(e||"").replace(/^[：:、\-—\s]+/g,"").trim()}function wa(e){return String(e||"").replace(/[：:、\-—\s]+$/g,"").trim()}function vm(e,n){let i=String(e||"").trim(),r=String(n||"").trim();if(!i||!r||i.length<8)return{left:i,right:r};const a=Math.min(8,Math.floor(i.length/2));for(let s=a;s>=3;s-=1){const m=i.slice(-s);if(!m||!i.startsWith(m))continue;const h=i.slice(0,i.length-s).trim();if(!(!h||h.length<4))return r.startsWith(m)?{left:h,right:r}:{left:h,right:`${m}${r}`}}return{left:i,right:r}}function pm(e){const n=String(e||"").trim();return n?!!(n.length>=24||cs.test(n)||Kf.some(r=>{const a=n.indexOf(r);return a>=1&&a<=18})||n.length>=14&&/(是|为|通过|随着|由于|因此|并且|能够|可以|实现|提升|优化)/.test(n)):!1}function Lu(e){const n=String(e||"").trim();if(!n||n.length<=12&&!cs.test(n))return null;const i=/^(.{1,12})[:：](.+)$/.exec(n);if(i){const m=String(i[1]||"").trim(),h=String(i[2]||"").trim();if(m&&h&&(cs.test(h)||h.length>=12))return{heading:wa(m),rest:Zs(h)}}const r=/^(.{2,10})\s*\1(.+)$/.exec(n);if(r){const m=String(r[1]||"").trim(),h=String(r[2]||"").trim();if(m&&h&&(cs.test(h)||h.length>=6))return{heading:wa(m),rest:Zs(h)}}const a=Jf.slice().sort((m,h)=>h.length-m.length);for(const m of a)if(n.startsWith(m)&&n.length>m.length+1){const h=Zs(n.slice(m.length).trim());if(h&&(cs.test(h)||h.length>=12))return{heading:m,rest:h}}for(const m of a){const h=n.indexOf(m);if(h<=0)continue;const y=h+m.length;if(y>10)continue;const S=n.slice(0,y).trim(),b=Zs(n.slice(y).trim());if(S&&b&&(cs.test(b)||b.length>=12))return{heading:wa(S),rest:b}}const s=n.search(/\b\d+(?:\.\d+)+\b/);if(s>0&&s<=12){const m=n.slice(0,s).trim(),h=Zs(n.slice(s).trim());if(m&&h&&(cs.test(h)||h.length>=12))return{heading:wa(m),rest:h}}for(const m of fm){const h=n.indexOf(m);if(h<2||h>24)continue;let y=n.slice(0,h).trim(),S=Zs(n.slice(h).trim());if(!(!y||!S)&&!(y.length>20||S.length<6)){if(["作为","通过","基于","采用","利用","借助"].includes(m)){const b=vm(y,S);y=b.left,S=b.right;for(const T of dm)if(y.endsWith(T)&&y.length-T.length>=4){S=`${T}${S}`,y=y.slice(0,y.length-T.length).trim();break}}if(y&&y.length<=16&&!cs.test(y))return{heading:wa(y),rest:S}}}for(const m of Kf){const h=n.indexOf(m);if(h>0&&h<=10){const y=n.slice(0,h).trim(),S=Zs(n.slice(h).trim());if(y&&S&&S.length>=6&&!cs.test(y))return{heading:wa(y),rest:S}}}return null}function mm(e){const n=String(e||"").replace(/\r/g,"").trim();if(!n)return[];const i=n.split(/\n+/).map(s=>s.trim()).filter(Boolean),r=[],a=s=>{const m=String(s||"").trim();if(!m)return;if(m.length<=92){r.push(m);return}let h=m.split(new RegExp("(?<=[。！？!?；;])(?=[^”’」』）》】\\]\\s])","g")).map(S=>S.trim()).filter(Boolean);if(h.length<=1&&m.length>118){const S=[];for(let b=0;b<m.length;b+=1){const T=m[b];(T==="，"||T===","||T==="、")&&S.push(b)}if(S.length){const b=Math.floor(m.length/2);let T=S[0],N=Number.POSITIVE_INFINITY;for(const E of S){if(E<24||E>m.length-18)continue;const P=Math.abs(E-b);P<N&&(N=P,T=E)}const q=m.slice(0,T+1).trim(),O=m.slice(T+1).trim();h=[q,O].filter(Boolean)}}if(h.length<=1){r.push(m);return}const y=[];for(const S of h)S&&(y.length&&S.length<24?y[y.length-1]=`${y[y.length-1]}${S}`:y.push(S));r.push(...y.filter(Boolean))};for(const s of i.length?i:[n])a(s);return r.length?r:[n]}function Gf(e){let n=String(e||"").trim();return n?(n.startsWith("```")&&(n=n.replace(/^```json/i,"").replace(/^```/,""),n.endsWith("```")&&(n=n.slice(0,-3)),n=n.trim()),n.startsWith("{")||n.startsWith("[")?n:null):null}function so(e){try{return JSON.parse(e)}catch{return null}}function Vf(e){const n=[],i=String(e||"").split(`
`);for(const r of i){const a=r.trim();if(!a)continue;const s=so(a);s&&typeof s=="object"&&!Array.isArray(s)&&n.push(s)}return n}function hm(e){if(!e||typeof e!="object")return null;const n=e;return n.doc_ir&&typeof n.doc_ir=="object"?Ya(n.doc_ir):Array.isArray(e)?Zl(e):Array.isArray(n.blocks)?Zl(n.blocks):Array.isArray(n.sections)?n.sections.some(a=>a&&(a.blocks||a.children))?Ya(n):lm(n):null}function ec(e){if(!e||typeof e!="object")return null;const n=e;return n.doc_ir&&typeof n.doc_ir=="object"?Du(n.doc_ir):Array.isArray(e)?tc(e):Array.isArray(n.blocks)?tc(n.blocks,String(n.title||"").trim()):Array.isArray(n.sections)?Du(n):null}function gm(e){const n=String(e||"").trim();if(!n||/^#{1,3}\s+/m.test(n))return null;const i=Gf(n);if(i){const a=so(i);if(a!==null){const s=hm(a);if(s)return s}}const r=Vf(n);return r.length>0?Zl(r):null}function _m(e){const n=String(e||"").trim();if(!n)return null;const i=Gf(n);if(i){const a=so(i);if(a!==null){const s=ec(a);if(s)return s}}const r=Vf(n);if(r.length>0){const a=tc(r);if(a)return a}return null}function bm(e){if(!e)return null;if(typeof e=="string"){const n=so(e);return n?ec(n):null}return typeof e!="object"?null:ec(e)}function ym(e,n,i){const r=String(e||""),a=_m(r);if(a)return a;if(!i){const s=bm(n);if(s)return s}return""}function nc(e){let n=String(e||"").replace(/\r\n/g,`
`).replace(/\r/g,`
`);if(!n.endsWith(`
`)){const q=n.lastIndexOf(`
`),O=q>=0?n.slice(q+1):n;O.trim().length<=4&&(/^#{1,6}\s*\S*$/.test(O)||/^[-*•·]\s*\S*$/.test(O))&&(n=q>=0?n.slice(0,q+1):"")}if(!n.trim())return null;const i=Ff(n.split(`
`)),r=[];let a="",s=[],m=[],h=null;const y=q=>{const O=mm(String(q||""));for(const E of O){const P=String(E||"").trim();P&&r.push({type:"paragraph",text:P})}},S=()=>{if(!s.length)return;const q=s.join(" ").replace(/\s+/g," ").trim();q&&y(q),s=[]},b=()=>{m.length&&(r.push({type:"list",items:m.slice(),ordered:!!h}),m=[],h=null)};let T=!0;for(const q of i){const E=String(q||"").trim();if(!E){S(),b(),T=!0;continue}if(/^#{1,6}$/.test(E))continue;const P=/^(#{1,3})\s*(.+)$/.exec(E);if(P){S(),b();const kt=Math.min(3,Math.max(1,P[1].length));let Mt=String(P[2]||"").trim(),Wt="";const et=Lu(Mt);et&&(Mt=et.heading,Wt=et.rest),kt===1&&!a&&Mt&&(a=Mt),r.push({type:"heading",level:kt,text:Mt||"章节"}),Wt&&y(Wt),T=!1;continue}const vt=/^(\d+(?:\.\d+){0,3})[\.、\)]?\s+(.+)$/.exec(E);if(vt){const kt=String(vt[1]||"");let Mt=String(vt[2]||"").trim();const Wt=(kt.match(/\./g)||[]).length,et=Math.min(6,2+Wt),Et=Lu(Mt),$t=Mt.length<=16&&!cs.test(Mt),Jt=Jf.some(ke=>Mt.startsWith(ke)),de=pm(Mt),Be=Et||$t||Jt||(T||!s.length&&!m.length)&&!de;if(Mt&&Be){S(),b();let ke="";Et&&(Mt=Et.heading,ke=Et.rest),et===1&&!a&&Mt&&(a=Mt),r.push({type:"heading",level:et,text:Mt||"章节"}),ke&&y(ke),T=!1;continue}}const U=E.match(/^\[\[(FIGURE|TABLE)\s*:\s*(\{[\s\S]*\})\s*\]\]$/i);if(U){S(),b();const kt=String(U[1]||"").toLowerCase(),Mt=so(U[2])||{raw:U[2]};kt==="table"?r.push({type:"table",table:Mt}):r.push({type:"figure",figure:Mt});continue}const lt=E.match(/^[-*•·]\s+(.*)$/),Tt=E.match(/^\d+[\.\)]\s+(.*)$/);if(lt||Tt){S();const kt=!!Tt;h===null&&(h=kt),h!==kt&&(b(),h=kt);const Mt=String(Tt?.[1]||lt?.[1]||"").trim();Mt&&m.push(Mt),T=!1;continue}b(),s.push(E),T=!1}S(),b();const N=a||$c(r)||"自动生成文档";return um(r,N)}function wm(e){const n=String(e||"").replace(/\r\n/g,`
`).replace(/\r/g,`
`);if(!n.trim())return"";const i=gm(n)||n,r=Ff(i.split(`
`));let a="",s=!1,m="";const h=[],y=()=>{m&&(h.push(m==="ol"?"</ol>":"</ul>"),m="")};for(const S of r){const b=S.trim();if(b.startsWith("```")){s?(h.push("</code></pre>"),s=!1):(y(),h.push('<pre class="code"><code>'),s=!0);continue}if(s){h.push(`${lr(S)}
`);continue}if(/^#{1,6}$/.test(b))continue;if(b===":::left"){y(),a="left";continue}if(b===":::center"){y(),a="center";continue}if(b===":::right"){y(),a="right";continue}if(b===":::"){y(),a="";continue}const T=b.match(/^\[\[(FIGURE|TABLE)\s*:\s*(\{[\s\S]*\})\s*\]\]$/i);if(T){y();const P=String(T[1]||"").toLowerCase();let vt=P==="figure"?"图示":"表格";try{const U=JSON.parse(T[2]);U&&typeof U.caption=="string"&&U.caption.trim()&&(vt=U.caption.trim())}catch{}P==="figure"?h.push(`<figure class="wa-figure" data-wa-figure="1"><div class="wa-figure-box">图</div><figcaption>${lr(vt)}</figcaption></figure>`):h.push(`<div class="wa-table" data-wa-table="1"><div class="wa-table-box">表</div><div class="wa-table-caption">${lr(vt)}</div></div>`);continue}const N=b.match(/^(#{1,3})\s*(.+?)\s*$/);if(N){y();const P=Math.min(3,N[1].length);h.push(`<h${P}>${ms(N[2])}</h${P}>`);continue}if(!b){if(m)continue;y(),h.push("<p><br/></p>");continue}const q=b.match(/^-\s+(.+)/),O=b.match(/^\d+\.\s+(.+)/);if(q||O){const P=q?"ul":"ol";m?m!==P&&(y(),m=P,h.push(P==="ol"?"<ol>":"<ul>")):(m=P,h.push(P==="ol"?"<ol>":"<ul>"));const vt=(q||O)[1];h.push(`<li>${ms(vt)}</li>`);continue}y();const E=a?` style="text-align:${a};"`:"";h.push(`<p${E}>${ms(S)}</p>`)}return y(),h.join("")}function xm(e,n,i){const r=ym(e,n,i);return r||wm(String(e||""))}var km=F('<button class="dropdown-item svelte-lk86dq"> </button>'),Sm=F('<div class="dropdown-panel svelte-lk86dq"></div>'),$m=F("<option> </option>"),Tm=F('<button class="color-item svelte-lk86dq"></button>'),jm=F('<div class="dropdown-panel color-grid svelte-lk86dq"></div>'),Em=F('<button class="color-item svelte-lk86dq"></button>'),Am=F('<div class="dropdown-panel color-grid svelte-lk86dq"></div>'),Cm=F('<button class="dropdown-item svelte-lk86dq"> </button>'),Im=F('<div class="dropdown-panel svelte-lk86dq"></div>'),Nm=F('<div class="dropdown-panel svelte-lk86dq"><button class="dropdown-item svelte-lk86dq">插入表格</button> <button class="dropdown-item svelte-lk86dq">合并单元格</button> <button class="dropdown-item svelte-lk86dq">插入行</button> <button class="dropdown-item svelte-lk86dq">插入列</button> <button class="dropdown-item svelte-lk86dq">删除行</button> <button class="dropdown-item svelte-lk86dq">删除列</button></div>'),Mm=F('<div class="panel-header svelte-lk86dq"><div class="panel-title">正文编辑</div> <div class="editor-stats svelte-lk86dq"><span> </span> <span>·</span> <span> </span></div></div> <div class="extended-toolbar svelte-lk86dq"><div class="toolbar-group svelte-lk86dq"><button class="tool-btn svelte-lk86dq" title="字体"><span style="font-family: serif;">A</span></button> <!></div> <div class="toolbar-group svelte-lk86dq"><select class="tool-select svelte-lk86dq"><option>字号</option><!></select></div> <div class="toolbar-group svelte-lk86dq"><button class="tool-btn svelte-lk86dq" title="文字颜色"><span style="color: #FF0000;">A</span></button> <!></div> <div class="toolbar-group svelte-lk86dq"><button class="tool-btn svelte-lk86dq" title="背景颜色"><span style="background: #FFFF00;">█</span></button> <!></div> <span class="separator svelte-lk86dq"></span> <button class="tool-btn svelte-lk86dq" title="左对齐">≡</button> <button class="tool-btn svelte-lk86dq" title="居中">≡</button> <button class="tool-btn svelte-lk86dq" title="右对齐">≡</button> <button class="tool-btn svelte-lk86dq" title="两端对齐">≡</button> <span class="separator svelte-lk86dq"></span> <button class="tool-btn svelte-lk86dq" title="上标">x²</button> <button class="tool-btn svelte-lk86dq" title="下标">x₂</button> <button class="tool-btn svelte-lk86dq" title="水平线">—</button> <span class="separator svelte-lk86dq"></span> <div class="toolbar-group svelte-lk86dq"><button class="tool-btn svelte-lk86dq" title="行距">≣</button> <!></div> <button class="tool-btn svelte-lk86dq" title="首行缩进">¶</button> <button class="tool-btn svelte-lk86dq" title="段间距">⇕</button> <span class="separator svelte-lk86dq"></span> <button class="tool-btn svelte-lk86dq" title="行内公式">𝑓(𝑥)</button> <button class="tool-btn svelte-lk86dq" title="公式块">∫</button> <span class="separator svelte-lk86dq"></span> <button class="tool-btn svelte-lk86dq" title="插入脚注">※</button> <button class="tool-btn svelte-lk86dq" title="生成目录">☰</button> <span class="separator svelte-lk86dq"></span> <div class="toolbar-group svelte-lk86dq"><button class="tool-btn svelte-lk86dq" title="表格">⊞</button> <!></div></div>',1),Bm=F('<div class="slash-empty svelte-lk86dq">无匹配命令，按 Backspace 删除关键字。</div>'),Dm=F('<button role="option"><span class="slash-label svelte-lk86dq"> </span> <span class="slash-desc svelte-lk86dq"> </span></button>'),Lm=F('<div class="slash-list svelte-lk86dq"></div>'),Rm=F('<div class="slash-menu svelte-lk86dq" role="listbox" tabindex="-1" aria-label="插入命令菜单"><div class="slash-menu-head svelte-lk86dq"><span>/ 命令</span> <span class="query svelte-lk86dq"> </span></div> <!> <div class="slash-menu-foot svelte-lk86dq">↑↓ 选择 · Enter 执行 · Esc 关闭</div></div>'),qm=F('<div class="block-marquee svelte-lk86dq" aria-hidden="true"></div>'),Fm=F('<div class="find-replace-panel svelte-lk86dq"><div class="find-replace-row svelte-lk86dq"><input type="text" placeholder="查找..." class="svelte-lk86dq"/> <button class="btn-small svelte-lk86dq">下一个</button> <button class="btn-small svelte-lk86dq">✕</button></div> <div class="find-replace-row svelte-lk86dq"><input type="text" placeholder="替换为..." class="svelte-lk86dq"/> <button class="btn-small svelte-lk86dq">替换</button> <button class="btn-small svelte-lk86dq">全部替换</button></div></div>'),Om=F('<div><!> <div class="editable svelte-lk86dq" role="region" aria-label="文档编辑区"></div> <!> <!> <!></div>');function Xf(e,n){if(new.target)return fi({component:Xf,...e});Zr(n,!1);const i=()=>Zn(Ps,"$generating",y),r=()=>Zn(mr,"$sourceText",y),a=()=>Zn($r,"$docIr",y),s=()=>Zn(fa,"$historyIndex",y),m=()=>Zn(Vo,"$history",y),h=()=>Zn(kc,"$wordCount",y),[y,S]=Fa();let b=W(null),T="",N=W("text"),q=null,O=null,E=null,P=jr(n,"showToolbar",12,!0),vt=jr(n,"paper",12,!0),U=jr(n,"lockEditing",12,!1);const lt=_c();let Tt=W(null),kt=W(""),Mt=!1,Wt=null,et="",Et=null,$t=[],Jt=[],de="",Be=null,ke=W(!1),un=W({left:0,top:0,width:0,height:0}),Bt=!1,pt="",jt=[];const Dt=[{id:"heading1",label:"标题 1",desc:"插入一级标题",command:"heading1",keywords:["h1","标题","一级"]},{id:"heading2",label:"标题 2",desc:"插入二级标题",command:"heading2",keywords:["h2","标题","二级"]},{id:"paragraph",label:"正文段落",desc:"切换为正文段落",command:"paragraph",keywords:["正文","段落","p"]},{id:"list-bullet",label:"无序列表",desc:"插入项目符号列表",command:"list-bullet",keywords:["列表","bullet","无序"]},{id:"list-number",label:"有序列表",desc:"插入编号列表",command:"list-number",keywords:["列表","编号","有序"]},{id:"quote",label:"引用块",desc:"插入引用格式",command:"quote",keywords:["引用","quote"]},{id:"code",label:"代码块",desc:"插入代码块",command:"code",keywords:["代码","code"]},{id:"table",label:"表格",desc:"插入表格",command:"table",keywords:["表格","table"]},{id:"image",label:"图片",desc:"插入图片",command:"image",keywords:["图片","image","图"]},{id:"toc",label:"目录",desc:"生成目录",command:"toc",keywords:["目录","toc"]},{id:"footnote",label:"脚注",desc:"插入脚注",command:"footnote",keywords:["脚注","footnote"]},{id:"math-inline",label:"行内公式",desc:"插入行内 LaTeX 公式",command:"math-inline",keywords:["公式","math","latex"]},{id:"math-block",label:"公式块",desc:"插入块级 LaTeX 公式",command:"math-block",keywords:["公式块","math","latex"]}];let Xt=W(!1),mn=W(0),fn=W(0),De=W(0),bt=W("");function At(){return i()?"正在生成内容，暂不可直接编辑…":U()?"正在渲染内容，暂不可编辑，请稍候…":"在这里直接编辑或等待生成内容…"}function ne(){if(!t(b))return;const o=i()||U();Wr(b,t(b).dataset.readonly=o?"1":"0"),Wr(b,t(b).dataset.emptyHint=At())}function Oe(o){if(!t(b))return;const v=!String(o||"").trim();Wr(b,t(b).dataset.empty=v?"1":"0"),ne()}function _e(o){if(!o||typeof o!="object")return!1;const v=o;if(String(v.title||"").trim())return!0;const k=H=>{for(const L of H){if(!L||typeof L!="object")continue;const J=L;if(String(J.title||"").trim()||(Array.isArray(J.blocks)?J.blocks:[]).length>0)return!0;const z=Array.isArray(J.children)?J.children:[];if(z.length&&k(z))return!0}return!1},A=Array.isArray(v.sections)?v.sections:[];return A.length>0&&k(A)?!0:(Array.isArray(v.blocks)?v.blocks:[]).length>0}function Br(){return{title:"",sections:[{id:Pn(),title:"",level:1,blocks:[{id:Pn(),type:"paragraph",text:""}],children:[]}]}}function Er(){if(!t(b))return;const o=String(r()||""),v=a(),g=_e(v);if(!g&&!o.trim()){const I=Br();$r.set(I),Qn.set(!1);return}const k=!g,A=g?`doc:${Dr(v)}`:`text:${o}`;if(t(Tt)&&t(b).contains(t(Tt))&&A!==T){Wt=A;return}A!==T&&(q&&clearTimeout(q),q=setTimeout(()=>{if(Wr(b,t(b).innerHTML=xm(o,v,k)),f(N,k?"text":"doc"),T=A,Wt=null,Oe(o),ne(),Zt(),Ei(),et){const I=t(b).querySelector(`[data-block-id="${CSS.escape(et)}"]`);et="",I&&I.focus()}wi(),xi(),Or()},100))}function Dr(o){try{return JSON.stringify(o)||""}catch{return""}}function pi(o){const v=!i()&&!U();o.setAttribute("contenteditable",v?"true":"false"),o.setAttribute("spellcheck","false"),v?o.dataset.waEdit="1":delete o.dataset.waEdit}function Zt(){if(!t(b))return;const o=t(b).querySelector(".wa-title");o&&(o.dataset.docTitle="1",pi(o)),t(b).querySelectorAll("[data-section-id]").forEach(v=>{pi(v)}),t(b).querySelectorAll("[data-block-id]").forEach(v=>{const g=v,k=g.tagName.toLowerCase();if(k==="figure"||k==="table"){g.setAttribute("contenteditable","false"),delete g.dataset.waEdit;return}pi(g)})}function ue(o){if(!o||!(o instanceof HTMLElement)||!t(b))return null;const v=o.closest('[data-wa-edit="1"]');return!v||!t(b).contains(v)?null:v}function dn(o){const v=ue(o);if(v)return v;const g=document.activeElement,k=ue(g);if(k)return k;const I=window.getSelection()?.anchorNode||null;return I instanceof HTMLElement?ue(I):I&&I.parentElement?ue(I.parentElement):null}function fe(){const v=window.getSelection()?.anchorNode||null;return v instanceof HTMLElement?ue(v):v&&v.parentElement?ue(v.parentElement):null}function ei(){if(!t(b))return null;const o=window.getSelection();if(!o||o.rangeCount===0)return null;const v=o.getRangeAt(0).cloneRange();v.collapse(!0);const g=v.getBoundingClientRect();if(g){const k=Math.max(0,g.left+Math.max(1,g.width/2)),A=Math.max(0,g.top+Math.max(1,g.height/2)),I=document.elementFromPoint(k,A),H=ue(I);if(H)return H;const L=Ut(A);if(L)return L}return t(b).querySelector('[data-wa-edit="1"]')}function vn(o){let v=String(o||"").replace(/\r/g,"");return v=v.replace(/[ \t]+/g," "),v=v.replace(/[ \t]*\n[ \t]*/g,`
`),v=v.replace(/\n{3,}/g,`

`),v.trim()}function Ji(o){if(o.nodeType===Node.TEXT_NODE)return o.textContent||"";if(!(o instanceof HTMLElement))return"";const v=o.tagName.toLowerCase();if(v==="br")return`
`;if(v==="strong"||v==="b")return`**${K(o)}**`;if(v==="em"||v==="i")return`*${K(o)}*`;if(v==="u")return`++${K(o)}++`;if(v==="del"||v==="s")return`~~${K(o)}~~`;if(v==="mark")return`==${K(o)}==`;if(v==="code")return"`"+(o.textContent||"")+"`";if(v==="a"){const g=o.getAttribute("href")||"",k=K(o);return g?`[${k}](${g})`:k}return K(o)}function K(o){const v=[];return o.childNodes.forEach(g=>v.push(Ji(g))),vn(v.join(""))}function ft(o){if(o.nodeType===Node.TEXT_NODE)return o.textContent||"";if(!(o instanceof HTMLElement))return"";if(o.tagName.toLowerCase()==="br")return`
`;const g=[];return o.childNodes.forEach(k=>g.push(ft(k))),g.join("")}function Ht(o){const v=[];return o.childNodes.forEach(g=>v.push(ft(g))),v.join("")}function pn(o){const v=document.createElement("div");return v.appendChild(o),K(v)}function Ar(o){const v=window.getSelection();if(!v||v.rangeCount===0)return null;const g=v.getRangeAt(0);if(!o.contains(g.startContainer))return null;const k=g.cloneRange();k.selectNodeContents(o),k.setEnd(g.startContainer,g.startOffset);const A=g.cloneRange();A.selectNodeContents(o),A.setStart(g.startContainer,g.startOffset);const I=pn(k.cloneContents()),H=pn(A.cloneContents());return{before:I,after:H}}function Rn(o){if(o.nodeType===Node.TEXT_NODE)return(o.textContent||"").length;if(!(o instanceof HTMLElement))return 0;if(o.tagName.toLowerCase()==="br")return 1;let g=0;return o.childNodes.forEach(k=>{g+=Rn(k)}),g}function qn(o){const v=window.getSelection();if(!v||v.rangeCount===0)return null;const g=v.getRangeAt(0),k=g.startContainer;if(!o.contains(k))return null;let A=0,I=!1;const H=L=>{if(!I){if(L===k){if(L.nodeType===Node.TEXT_NODE)A+=g.startOffset;else if(L instanceof HTMLElement){const J=Array.from(L.childNodes);for(let R=0;R<g.startOffset;R++)A+=Rn(J[R])}I=!0;return}if(L.nodeType===Node.TEXT_NODE||L instanceof HTMLElement&&L.tagName.toLowerCase()==="br"){A+=Rn(L);return}L.childNodes.forEach(J=>H(J))}};return H(o),A}function Tn(o){const v=o.style,g=window.getComputedStyle(o),k={},A=v.textAlign||o.getAttribute("align")||g.textAlign||"";A&&(k.align=A);const I=v.lineHeight||g.lineHeight;if(I){let xt=I;const It=/^(\d+(?:\.\d+)?)px$/.exec(I),Ae=/^(\d+(?:\.\d+)?)px$/.exec(v.fontSize||g.fontSize||"");if(It&&Ae){const ot=Number(It[1])/Number(Ae[1]);Number.isFinite(ot)&&ot>0&&(xt=ot.toFixed(2).replace(/\.00$/,""))}k.lineHeight=xt}const H=v.textIndent||g.textIndent;H&&(k.indent=H);const L=v.marginTop||g.marginTop;L&&(k.marginTop=L);const J=v.marginBottom||g.marginBottom;J&&(k.marginBottom=J);const R=v.fontFamily||g.fontFamily;R&&(k.fontFamily=R);const z=v.fontSize||g.fontSize;if(z){let xt=z;const It=/^(\d+(?:\.\d+)?)px$/.exec(z);if(It){const Ae=Math.round(Number(It[1])*72/96);Number.isFinite(Ae)&&Ae>0&&(xt=`${Ae}pt`)}k.fontSize=xt}const it=v.fontWeight||g.fontWeight;it&&(k.fontWeight=it);const Q=v.fontStyle||g.fontStyle;Q&&(k.fontStyle=Q);const mt=v.color||g.color;mt&&(k.color=mt);const at=v.backgroundColor||g.backgroundColor;return at&&at!=="transparent"&&at!=="rgba(0, 0, 0, 0)"&&(k.background=at),Object.keys(k).length?k:null}function Le(o){const v=[],g=(R,z)=>{R&&v.push({text:R,bold:z.bold,italic:z.italic,underline:z.underline,strike:z.strike,color:z.color,background:z.background,font:z.font,size:z.size,link:z.link})},k=R=>{const z=String(R||"").trim();return z?z.split(",")[0].replace(/["']/g,"").trim():""},A=(R,z)=>{if(R.nodeType===Node.TEXT_NODE){g(R.textContent||"",z);return}if(!(R instanceof HTMLElement))return;const it=R.tagName.toLowerCase();if(it==="br"){g(`
`,z);return}const Q={...z};if((it==="strong"||it==="b")&&(Q.bold=!0),(it==="em"||it==="i")&&(Q.italic=!0),it==="u"&&(Q.underline=!0),(it==="s"||it==="del"||it==="strike")&&(Q.strike=!0),it==="a"){const at=R.getAttribute("href")||"";at&&(Q.link=at)}if(it==="font"){const at=R.getAttribute("color");at&&(Q.color=at);const xt=R.getAttribute("face");xt&&(Q.font=k(xt));const It=R.getAttribute("size");It&&(Q.size=String(It))}const mt=R.style;if(mt){mt.color&&(Q.color=mt.color),mt.backgroundColor&&(Q.background=mt.backgroundColor),mt.fontFamily&&(Q.font=k(mt.fontFamily)),mt.fontSize&&(Q.size=mt.fontSize);const at=mt.textDecoration;at&&at.includes("underline")&&(Q.underline=!0),at&&at.includes("line-through")&&(Q.strike=!0)}R.childNodes.forEach(at=>A(at,Q))};A(o,{});const I=[],H=R=>[R.bold?"b":"",R.italic?"i":"",R.underline?"u":"",R.strike?"s":"",R.color||"",R.background||"",R.font||"",R.size||"",R.link||""].join("|");v.forEach(R=>{const z=I[I.length-1];z&&H(z)===H(R)?z.text+=R.text:I.push({...R})});const L=vn(I.map(R=>R.text).join("")),J=I.some(R=>Object.keys(R).some(z=>z!=="text"&&R[z]));return{text:L,runs:J?I:null}}function an(o){if(o.dataset.docTitle==="1")return{kind:"title",text:K(o)};const v=String(o.dataset.sectionId||"").trim();if(v)return{kind:"section",id:v,text:K(o),style:Tn(o)};const g=String(o.dataset.blockId||"").trim();if(!g)return null;const k=o.tagName.toLowerCase();if(k==="ul"||k==="ol"){const R={type:"list",items:Array.from(o.querySelectorAll(":scope > li")).map(it=>vn(K(it))),ordered:k==="ol"},z=Tn(o);return z&&(R.style=z),{kind:"block",id:g,payload:R}}if(/^h[1-6]$/.test(k)){const J=Number(k.slice(1)),R=Le(o),z=R.text.replace(/\n+/g," ").trim(),it={type:"heading",level:J,text:z};R.runs&&(it.runs=R.runs);const Q=Tn(o);return Q&&(it.style=Q),{kind:"block",id:g,payload:it}}const A=Le(o),H={type:"paragraph",text:A.text};A.runs&&(H.runs=A.runs);const L=Tn(o);return L&&(H.style=L),{kind:"block",id:g,payload:H}}function jn(o,v=180){O&&clearTimeout(O),O=setTimeout(()=>{const g=Ya(o)||"";mr.set(g),Oe(g),Mu(g)},v)}function tn(o,v){$r.set(o),Qn.set(!1),T=`doc:${Dr(o)}`,jn(o,v?.immediate?0:180)}function ur(o,v){const g=String(v||"").trim()||"自动生成文档",k=String(o.title||"").trim();let A=!1;g!==k&&(A=!0);const I=J=>{let R=!1;const z=J.map(it=>{let Q=!1,mt=it;String(it.title||"").trim()===k&&(mt={...it,title:g},Q=!0);const at=Array.isArray(it.children)?it.children:[];if(at.length){const xt=I(at);xt!==at&&(mt={...mt,children:xt},Q=!0)}return Q&&(R=!0),mt});return R&&(A=!0),R?z:J},H=Array.isArray(o.sections)?o.sections:[],L=I(H);return A?{...o,title:g,sections:L}:null}function Lr(o,v,g,k){const A=String(g||"").trim()||"章节";let I=!1;const H=R=>{let z=!1;const it=R.map(Q=>{let mt=!1,at=Q;String(Q.id||"")===v&&(at={...Q,title:A},k&&Object.keys(k).length&&(at={...at,style:k}),mt=!0);const xt=Array.isArray(Q.children)?Q.children:[];if(xt.length){const It=H(xt);It!==xt&&(at={...at,children:It},mt=!0)}return mt&&(z=!0),at});return z&&(I=!0),z?it:R},L=Array.isArray(o.sections)?o.sections:[],J=H(L);return I?{...o,sections:J}:null}function en(o,v,g){let k=!1;const A=L=>{let J=!1;const R=L.map(z=>{let it=!1,Q=z;const mt=Array.isArray(z.blocks)?z.blocks:[];if(mt.length){const xt=mt.findIndex(It=>String(It.id||"")===v);if(xt>=0){const It=mt[xt]||{},Ae={...It,...g,id:It.id||v},ot=mt.slice();ot[xt]=Ae,Q={...Q,blocks:ot},it=!0}}const at=Array.isArray(z.children)?z.children:[];if(at.length){const xt=A(at);xt!==at&&(Q={...Q,children:xt},it=!0)}return it&&(J=!0),Q});return J&&(k=!0),J?R:L},I=Array.isArray(o.sections)?o.sections:[],H=A(I);return k?{...o,sections:H}:null}function Cr(o,v,g){let k=!1;const A=L=>{let J=!1;const R=L.map(z=>{let it=!1,Q=z;const mt=Array.isArray(z.blocks)?z.blocks:[];if(mt.length){const xt=mt.findIndex(It=>String(It.id||"")===v);if(xt>=0){const It=mt.slice();It.splice(xt+1,0,g),Q={...Q,blocks:It},it=!0}}const at=Array.isArray(z.children)?z.children:[];if(at.length){const xt=A(at);xt!==at&&(Q={...Q,children:xt},it=!0)}return it&&(J=!0),Q});return J&&(k=!0),J?R:L},I=Array.isArray(o.sections)?o.sections:[],H=A(I);return k?{...o,sections:H}:null}function Kt(o,v,g){let k=!1;const A=L=>{let J=!1;const R=L.map(z=>{let it=!1,Q=z;const mt=Array.isArray(z.blocks)?z.blocks:[];if(mt.length){const xt=mt.findIndex(It=>String(It.id||"")===v);if(xt>=0){const It=mt.slice();It.splice(xt,0,g),Q={...Q,blocks:It},it=!0}}const at=Array.isArray(z.children)?z.children:[];if(at.length){const xt=A(at);xt!==at&&(Q={...Q,children:xt},it=!0)}return it&&(J=!0),Q});return J&&(k=!0),J?R:L},I=Array.isArray(o.sections)?o.sections:[],H=A(I);return k?{...o,sections:H}:null}function yn(o,v,g){let k=!1;const A=R=>{const z=String(R.type||"paragraph").toLowerCase();if(z==="list"){const it=Array.isArray(R.items)?R.items:[],Q=it.map(mt=>String(mt??"").replace(v,g));return Q.join("")!==it.join("")?(k=!0,{...R,items:Q}):R}if(z==="table"){const it=typeof R.table=="object"&&R.table?R.table:null;if(it&&typeof it.caption=="string"){const Q=String(it.caption||"").replace(v,g);if(Q!==it.caption)return k=!0,{...R,table:{...it,caption:Q}}}return R}if(z==="figure"){const it=typeof R.figure=="object"&&R.figure?R.figure:null;if(it&&typeof it.caption=="string"){const Q=String(it.caption||"").replace(v,g);if(Q!==it.caption)return k=!0,{...R,figure:{...it,caption:Q}}}return R}if(typeof R.text=="string"){const it=String(R.text||"").replace(v,g);if(it!==R.text)return k=!0,{...R,text:it}}return R},I=R=>{let z=!1;const it=R.map(Q=>{let mt=!1,at=Q;if(typeof Q.title=="string"){const Ae=String(Q.title||"").replace(v,g);Ae!==Q.title&&(at={...at,title:Ae},mt=!0,k=!0)}const xt=Array.isArray(Q.blocks)?Q.blocks:[];if(xt.length){const Ae=xt.map(ot=>A(ot));Ae.some((ot,ct)=>ot!==xt[ct])&&(at={...at,blocks:Ae},mt=!0)}const It=Array.isArray(Q.children)?Q.children:[];if(It.length){const Ae=I(It);Ae!==It&&(at={...at,children:Ae},mt=!0)}return mt&&(z=!0),mt?at:Q});return z?it:R},H={...o};if(typeof H.title=="string"){const R=String(H.title||"").replace(v,g);R!==H.title&&(H.title=R,k=!0)}const L=Array.isArray(H.sections)?H.sections:[],J=I(L);return J!==L&&(H.sections=J),k?H:null}function sr(o,v=160){Et&&clearTimeout(Et),Et=setTimeout(()=>{Fn(o)},v)}function Fn(o,v){const g=a();if(!g||typeof g!="object")return;const k=an(o);if(!k)return;let A=null;k.kind==="title"?A=ur(g,String(k.text||"")):k.kind==="section"?A=Lr(g,String(k.id||""),String(k.text||""),k.style||null):k.kind==="block"&&(A=en(g,String(k.id||""),k.payload||{})),A&&tn(A,v)}function wn(){Et&&(clearTimeout(Et),Et=null);const o=t(Tt)||dn(document.activeElement);if(o){Fn(o,{immediate:!0});return}O&&(clearTimeout(O),O=null);const v=a();if(!v||typeof v!="object")return;const g=Ya(v)||"";mr.set(g),Oe(g)}const Rr="sec:",se="doc:title";function ve(o){return String(o||"").startsWith(Rr)}function nn(o){return ve(o)?String(o||"").slice(Rr.length).trim():""}function Ge(){if(!t(b))return[];const o=t(b).querySelectorAll('[data-block-id], [data-section-id], [data-doc-title="1"]');return Array.from(o)}function te(o){if(!o)return"";const v=String(o.dataset.blockId||"").trim();if(v)return v;const g=String(o.dataset.sectionId||"").trim();return g?`${Rr}${g}`:String(o.dataset.docTitle||"").trim()?se:""}function Se(o){if(!t(b)||!o)return null;if(o===se)return t(b).querySelector('[data-doc-title="1"]');if(ve(o)){const v=nn(o);return v?t(b).querySelector(`[data-section-id="${CSS.escape(v)}"]`):null}return t(b).querySelector(`[data-block-id="${CSS.escape(o)}"]`)}function me(o){if(!t(b)||!o)return{sectionId:"",sectionTitle:""};if(o===se){const I=t(b).querySelector('[data-doc-title="1"]');return{sectionId:se,sectionTitle:I?vn(Ht(I)):"文档标题"}}const v=nn(o);if(v){const I=t(b).querySelector(`[data-section-id="${CSS.escape(v)}"]`),H=I?vn(Ht(I).replace(/^#+\s*/,"")):"";return{sectionId:v,sectionTitle:H}}let g="",k="";const A=Array.from(t(b).querySelectorAll("[data-section-id], [data-block-id]"));for(const I of A){const H=String(I.dataset.sectionId||"").trim();H&&(g=H,k=vn(Ht(I).replace(/^#+\s*/,"")));const L=String(I.dataset.blockId||"").trim();if(L&&L===o)return{sectionId:g,sectionTitle:k}}return{sectionId:"",sectionTitle:""}}function En(o){const v=new Set,g=[];for(const k of o){const A=String(k||"").trim();!A||v.has(A)||(v.add(A),g.push(A))}return g}function he(o){const v=new Set(En(o)),g=[];for(const k of Ge()){const A=te(k);A&&v.has(A)&&g.push(A)}return g}function be(){const o=Jt.map(I=>{const H=te(I),L=Ht(I),J=me(H),R=H===se?"title":ve(H)?"section":"block";return{id:H,text:L,kind:R,style:Tn(I)||{},sectionId:J.sectionId,sectionTitle:J.sectionTitle}});if(!o.length){lt("blockselect",{blockId:"",blockIds:[],blocks:[],text:"",rect:null,style:{}});return}const v=Jt[0],g=te(v),k=Ht(v),A=v.getBoundingClientRect();lt("blockselect",{blockId:g,blockIds:$t.slice(),blocks:o,text:k,rect:{top:A.top,left:A.left,width:A.width,height:A.height},style:Tn(v)||{}})}function pe(o,v){for(const g of Jt)g.classList.remove("wa-block-selected");$t=he(o),Jt=$t.map(g=>Se(g)).filter(g=>!!g);for(const g of Jt)g.classList.add("wa-block-selected");v&&$t.includes(v)?de=v:$t.length===1?de=$t[0]:$t.length||(de=""),be(),queueMicrotask(()=>Rt())}function je(){pe([])}function Ee(o){return(o||[]).filter(v=>{const g=String(v||"").trim();return g&&g!==se&&!ve(g)})}function Re(){if(!t(b))return!1;const o=window.getSelection();if(!o||o.rangeCount===0)return!1;const v=o.anchorNode,g=o.focusNode;return!!(v&&g&&t(b).contains(v)&&t(b).contains(g))}function Pe(){const o=window.getSelection();return!o||o.rangeCount===0||o.isCollapsed?!1:Re()}function er(o,v){const g=new Set(Ee(v));if(!g.size)return[];const k=[],A=H=>{for(const L of H){const J=Array.isArray(L.blocks)?L.blocks:[];for(const z of J){const it=String(z.id||"");it&&g.has(it)&&k.push(z)}const R=Array.isArray(L.children)?L.children:[];R.length&&A(R)}},I=Array.isArray(o.sections)?o.sections:[];return A(I),k}function wt(o){const v=String(o.type||"paragraph").toLowerCase();if(v==="list")return(Array.isArray(o.items)?o.items:[]).map(k=>String(k??"").trim()).filter(Boolean).join(`
`);if(v==="table"){const g=o.table&&typeof o.table=="object"?o.table:{};return String(g.caption||"表格")}if(v==="figure"){const g=o.figure&&typeof o.figure=="object"?o.figure:{};return String(g.caption||"图片")}return String(o.text||"").trim()}async function re(o){const v=String(o||"");if(!v)return!1;try{if(navigator.clipboard&&navigator.clipboard.writeText)return await navigator.clipboard.writeText(v),!0}catch{}try{const g=document.createElement("textarea");g.value=v,g.style.position="fixed",g.style.opacity="0",document.body.appendChild(g),g.focus(),g.select();const k=document.execCommand("copy");return g.remove(),k}catch{return!1}}async function $e(){try{if(navigator.clipboard&&navigator.clipboard.readText)return await navigator.clipboard.readText()}catch{}return""}function Qt(o,v){const g=JSON.parse(JSON.stringify(o||{})),k=String(g.type||"paragraph").toLowerCase();return g.id=Pn(),["paragraph","text","p","list","table","figure","heading"].includes(k)||(g.type="paragraph",g.text=wt(o)),(k==="text"||k==="p")&&typeof g.text!="string"&&(g.text=wt(o)),k==="paragraph"&&typeof g.text!="string"&&(g.text=wt(o)),g.id||(g.id=`${Pn()}_${v+1}`),g}function Lt(o,v,g){if(!g.length)return null;let k=!1;const A=L=>{let J=!1;const R=L.map(z=>{let it=!1,Q=z;const mt=Array.isArray(z.blocks)?z.blocks:[];if(mt.length){const xt=mt.findIndex(It=>String(It.id||"")===v);if(xt>=0){const It=mt.slice();It.splice(xt+1,0,...g),Q={...Q,blocks:It},it=!0}}const at=Array.isArray(z.children)?z.children:[];if(at.length){const xt=A(at);xt!==at&&(Q={...Q,children:xt},it=!0)}return it&&(J=!0),Q});return J&&(k=!0),J?R:L},I=Array.isArray(o.sections)?o.sections:[],H=A(I);return k?{...o,sections:H}:null}function ee(o,v){if(!v.length)return null;const g=Array.isArray(o.sections)?o.sections:[];if(!g.length)return null;const k=g[0],A=Array.isArray(k.blocks)?k.blocks:[],I={...k,blocks:[...A,...v]},H=g.slice();return H[0]=I,{...o,sections:H}}function hn(o,v){const g=new Set(Ee(v));if(!g.size)return null;let k=!1;const A=L=>{let J=!1;const R=L.map(z=>{let it=!1,Q=z;const mt=Array.isArray(z.blocks)?z.blocks:[];if(mt.length){const xt=mt.filter(It=>!g.has(String(It.id||"")));xt.length!==mt.length&&(Q={...Q,blocks:xt},it=!0)}const at=Array.isArray(z.children)?z.children:[];if(at.length){const xt=A(at);xt!==at&&(Q={...Q,children:xt},it=!0)}return it&&(J=!0),Q});return J&&(k=!0),J?R:L},I=Array.isArray(o.sections)?o.sections:[],H=A(I);return k?{...o,sections:H}:null}function An(){const o=i()||U(),v=ii();let g=!1,k=!1,A=!1;const I=s()>0,H=s()>=0&&s()<m().length-1;let L=!o&&(v||I),J=!o&&(v||H);try{g=!!document.queryCommandState("bold"),k=!!document.queryCommandState("italic"),A=!!document.queryCommandState("underline")}catch{}try{const mt=!!document.queryCommandEnabled("undo"),at=!!document.queryCommandEnabled("redo");L=!o&&(mt||I),J=!o&&(at||H)}catch{}const R=Pe()||$t.length>0,z=R,it=!o&&R,Q=!o&&(v||$t.length>0);return{focused:v,readonly:o,bold:g,italic:k,underline:A,hasSelection:R,canUndo:L,canRedo:J,canCopy:z,canCut:it,canPaste:Q}}function Rt(o=!1){const v=An(),g=JSON.stringify(v);!o&&g===pt||(pt=g,lt("toolbarstate",v))}async function gn(){if(Pe())return document.execCommand("copy"),!0;if(!a()||typeof a()!="object")return!1;const o=Ee($t);if(!o.length)return!1;const v=er(a(),o);if(!v.length)return!1;jt=v.map((k,A)=>Qt(k,A));const g=v.map(k=>wt(k)).filter(Boolean).join(`

`);return await re(g),!0}async function Cn(){if(Pe())return document.execCommand("cut"),!0;if(!a()||typeof a()!="object")return!1;const o=Ee($t);if(!o.length||!await gn())return!1;const g=hn(a(),o);return g?(tn(g),pe([]),!0):!1}async function ni(){if(Pe()){const I=await $e();return I?(document.execCommand("insertText",!1,I),!0):!1}if(!a()||typeof a()!="object")return!1;const o=Ee($t),v=o.length?o[o.length-1]:"";let g=jt.map((I,H)=>Qt(I,H));if(!g.length){const I=(await $e()).trim();if(!I)return!1;g=I.split(/\n{2,}/).map(H=>H.trim()).filter(Boolean).map((H,L)=>({id:`${Pn()}_${L+1}`,type:"paragraph",text:H}))}const k=a(),A=v?Lt(k,v,g):ee(k,g);return A?(tn(A),pe(g.map(I=>String(I.id||"")).filter(Boolean)),!0):!1}function Ei(){!t(b)||!$t.length||pe($t,de)}function Ai(o){const g=Ge().map(J=>te(J)).filter(Boolean),k=de&&g.includes(de)?de:g[0]||"",A=g.indexOf(k),I=g.indexOf(o);if(A<0||I<0){pe([o],o);return}const[H,L]=A<=I?[A,I]:[I,A];pe(g.slice(H,L+1),k)}function qr(o){const v=$t.includes(o),g=v?$t.filter(k=>k!==o):[...$t,o];pe(g,v?de:o)}function is(o,v){const g=Math.min(o.x,v.x),k=Math.min(o.y,v.y),A=Math.abs(o.x-v.x),I=Math.abs(o.y-v.y);return{left:g,top:k,width:A,height:I}}function mi(o,v){const g=o.left+o.width,k=o.top+o.height,A=v.left+v.width,I=v.top+v.height;return!(g<v.left||A<o.left||k<v.top||I<o.top)}function In(o){const v=[];for(const g of Ge()){const k=te(g);k&&mi(o,g.getBoundingClientRect())&&v.push(k)}return v}function Kr(o){if(!Be)return;const v={x:o.clientX,y:o.clientY},g=is(Be,v);if(!t(ke)){if(g.width<10&&g.height<10)return;f(ke,!0),Bt=!0,window.getSelection()?.removeAllRanges()}o.preventDefault(),f(un,g);const k=In(g);k.length?pe(k,k[0]):pe([])}function _r(){Be=null,f(ke,!1),f(un,{left:0,top:0,width:0,height:0}),window.removeEventListener("mousemove",Kr),window.removeEventListener("mouseup",br)}function br(){_r()}function On(o){if(!t(b)||o.button!==0)return;const v=o.target;if(!v||!t(b).contains(v)||v.closest('a,button,input,textarea,select,[data-wa-no-marquee="1"]'))return;const g=t(b).getBoundingClientRect(),k=o.clientX<=g.left+22;!o.altKey&&!k||(Be={x:o.clientX,y:o.clientY},f(ke,!1),f(un,{left:o.clientX,top:o.clientY,width:0,height:0}),window.addEventListener("mousemove",Kr),window.addEventListener("mouseup",br))}function Ve(o){if(!o.isContentEditable)return;o.focus();const v=document.createRange();v.selectNodeContents(o);const g=!vn(Ht(o));v.collapse(g);const k=window.getSelection();k?.removeAllRanges(),k?.addRange(v)}function Ut(o){if(!t(b))return null;const v=Array.from(t(b).querySelectorAll('[data-wa-edit="1"]'));if(!v.length)return null;v.sort((H,L)=>H.getBoundingClientRect().top-L.getBoundingClientRect().top);const g=v[0],k=v[v.length-1];if(o<=g.getBoundingClientRect().top+4)return g;if(o>=k.getBoundingClientRect().bottom-4)return k;let A=g,I=Number.POSITIVE_INFINITY;for(const H of v){const L=H.getBoundingClientRect(),J=L.top+L.height/2,R=Math.abs(o-J);R<I&&(A=H,I=R)}return A}function nr(o,v){const g=v.getBoundingClientRect();return o.clientX<=g.left+18}function fr(o){if(t(Xt)&&Nn(),Bt){Bt=!1;return}const v=o.target;if(!v||!t(b))return;const g=v.closest('[data-block-id], [data-section-id], [data-doc-title="1"]');if(!g||!t(b).contains(g)){if(je(),!i()&&!U()){const L=Ut(o.clientY)||t(b).querySelector('[data-wa-edit="1"]');L&&Ve(L)}return}const k=te(g);if(!k){je();return}const A=nr(o,g),I=o.ctrlKey||o.metaKey;if(!(o.shiftKey||I||o.altKey||A)){je();return}if(o.shiftKey){Ai(k);return}if(I){qr(k);return}pe([k],k)}function Kn(){const o=String(t(bt)||"").trim().toLowerCase();return o?Dt.filter(v=>`${v.label} ${v.desc} ${v.keywords.join(" ")}`.toLowerCase().includes(o)):Dt}function Nn(){f(Xt,!1),f(bt,""),f(De,0)}function Ct(){const o=window.getSelection();if(!o||o.rangeCount===0)return null;const v=o.getRangeAt(0).cloneRange();v.collapse(!0);let g=v.getBoundingClientRect();if(!g||g.width===0&&g.height===0){const k=document.createElement("span");k.textContent="​",k.style.opacity="0",v.insertNode(k),g=k.getBoundingClientRect(),k.remove(),o.removeAllRanges(),o.addRange(v)}return g||null}function ri(o){if(i()||U())return;const v=dn(o);if(!v)return;const g=Ct()||v.getBoundingClientRect(),k=320,A=320;f(mn,Math.min(Math.max(12,g.left),Math.max(12,window.innerWidth-k-12))),f(fn,Math.min(Math.max(72,g.bottom+8),Math.max(72,window.innerHeight-A-12))),f(bt,""),f(De,0),f(Xt,!0)}function rn(o){const v=Kn();if(!v.length){f(De,0);return}const g=(t(De)+o+v.length)%v.length;f(De,g)}function hi(o){const v=Kn();if(!v.length){Nn();return}const g=v[Math.max(0,Math.min(o,v.length-1))];Nn(),Gt(g.command);const k=dn(document.activeElement);k&&sr(k,0),queueMicrotask(()=>Rt())}function gi(o){if(t(b)&&Wr(b,t(b).dataset.caretActive="1"),i()||U()){o.target?.blur?.(),t(b)&&delete t(b).dataset.caretActive,Rt();return}const v=ue(o.target);v&&(f(Tt,v),f(kt,String(v.dataset.blockId||v.dataset.sectionId||v.dataset.docTitle||"")),queueMicrotask(()=>Rt()))}function ss(o){t(Xt)&&Nn();const v=ue(o.target);v&&(!i()&&!U()&&Fn(v,{immediate:!0}),t(Tt)===v&&(f(Tt,null),f(kt,"")),Wt&&Wt!==T&&Er()),queueMicrotask(()=>{if(!t(b))return;const g=document.activeElement;g&&t(b).contains(g)?Wr(b,t(b).dataset.caretActive="1"):delete t(b).dataset.caretActive}),queueMicrotask(()=>Rt())}function He(o){if(i()||U()||Mt)return;const v=dn(o.target);v&&(f(Tt,v),f(kt,String(v.dataset.blockId||v.dataset.sectionId||v.dataset.docTitle||"")),sr(v),queueMicrotask(()=>Rt()))}function ae(){Mt=!0,Rt()}function Gn(o){Mt=!1,He(o),queueMicrotask(()=>Rt())}function Di(o){const v=document.createElement("div");v.innerHTML=o;const g=[],k=L=>{if(L.nodeType===Node.TEXT_NODE)return(L.textContent||"").replace(/\s+/g," ");if(!(L instanceof HTMLElement))return"";const J=L.tagName.toLowerCase();if(J==="br")return`
`;if(J==="strong"||J==="b")return`**${A(L)}**`;if(J==="em"||J==="i")return`*${A(L)}*`;if(J==="u")return`++${A(L)}++`;if(J==="del"||J==="s")return`~~${A(L)}~~`;if(J==="mark")return`==${A(L)}==`;if(J==="code")return"`"+A(L)+"`";if(J==="a"){const R=L.getAttribute("href")||"",z=A(L);return R?`[${z}](${R})`:z}return A(L)},A=L=>{const J=[];return L.childNodes.forEach(R=>J.push(k(R))),J.join("").replace(/\s+/g," ").trim()},I=L=>{const J=L.replace(/\s+$/g,"").trim();J&&g.push(J)},H=L=>{if(!(L instanceof HTMLElement))return;const J=L.tagName.toLowerCase();if(L.dataset.waFigure==="1"){const R=L.querySelector("figcaption")?.textContent?.trim()||"图示";g.push(`[[FIGURE:{"caption":"${Ci(R)}"}]]`);return}if(L.dataset.waTable==="1"){const R=L.querySelector(".wa-table-caption")?.textContent?.trim()||"表格";g.push(`[[TABLE:{"caption":"${Ci(R)}"}]]`);return}if(J==="h1"||J==="h2"||J==="h3"){const R=J==="h1"?1:J==="h2"?2:3,z=A(L);z&&g.push(`${"#".repeat(R)} ${z}`);return}if(J==="pre"){const R=L.textContent||"";g.push("```\n"+R.replace(/\n+$/,"")+"\n```");return}if(J==="blockquote"){const R=A(L);R&&g.push("> "+R);return}if(J==="ul"||J==="ol"){Array.from(L.querySelectorAll(":scope > li")).forEach((z,it)=>{const Q=A(z);Q&&g.push(J==="ol"?`${it+1}. ${Q}`:`- ${Q}`)});return}if(J==="p"||J==="div"){const R=A(L);I(R);return}if(J==="figure"){const R=L.querySelector("figcaption")?.textContent?.trim()||"图示";g.push(`[[FIGURE:{"caption":"${Ci(R)}"}]]`);return}if(J==="table"){g.push('[[TABLE:{"caption":"表格"}]]');return}L.childNodes.forEach(R=>H(R))};return v.childNodes.forEach(L=>H(L)),g.join(`

`).trim()}function Gr(o){const v=document.createElement("div");v.innerHTML=o;const g=[];let k="";const A=ot=>{if(ot.nodeType===Node.TEXT_NODE)return(ot.textContent||"").replace(/\s+/g," ");if(!(ot instanceof HTMLElement))return"";const ct=ot.tagName.toLowerCase();if(ct==="br")return`
`;if(ct==="strong"||ct==="b")return`**${I(ot)}**`;if(ct==="em"||ct==="i")return`*${I(ot)}*`;if(ct==="u")return`++${I(ot)}++`;if(ct==="del"||ct==="s")return`~~${I(ot)}~~`;if(ct==="mark")return`==${I(ot)}==`;if(ct==="code")return"`"+I(ot)+"`";if(ct==="a"){const Nt=ot.getAttribute("href")||"",Yt=I(ot);return Nt?`[${Yt}](${Nt})`:Yt}return I(ot)},I=ot=>{const ct=[];return ot.childNodes.forEach(Nt=>ct.push(A(Nt))),ct.join("").replace(/\s+/g," ").trim()},H=(ot,ct)=>{const Nt=ot.replace(/\s+$/g,"").trim();Nt&&g.push({type:"paragraph",text:Nt,id:ct||void 0})},L=["摘要","引言","绪论","前言","背景","相关技术概述","关键技术","研究方法","实验","结果","讨论","结论","总结","展望","参考文献","附录","致谢","Abstract"],J=/^(\d+(?:\.\d+){0,2})\s*[\.、:：-]?\s*([^\s].{0,24})$/,R=/^([一二三四五六七八九十]+)\s*[、.．:：-]?\s*([^\s].{0,24})$/,z=ot=>{const ct=String(ot||"").trim();return ct?!!(ct.length>=24||/[。！？!?；;，,]/.test(ct)||["本文","本研究","随着","通过","由于","因此","此外","同时","首先","其次","最后"].some(zt=>{const Pt=ct.indexOf(zt);return Pt>=1&&Pt<=18})||ct.length>=14&&/(是|为|通过|随着|由于|因此|并且|能够|可以|实现|提升|优化)/.test(ct)):!1},it=ot=>{const ct=String(ot||"").trim();if(!ct)return{title:"",rest:""};const Nt=/^(.{2,18})\s*\1(.+)$/.exec(ct);if(Nt)return{title:String(Nt[1]||"").trim(),rest:String(Nt[2]||"").trim()};for(const zt of L){const Pt=ct.indexOf(zt);if(Pt>1&&Pt<=20){const Qe=ct.slice(0,Pt).trim(),Fi=ct.slice(Pt).trim();if(Qe.length>=2&&Fi.length>=2)return{title:Qe,rest:Fi}}}const Yt=ct.search(/\b\d+(?:\.\d+){0,2}\b/);return Yt>1&&Yt<=20?{title:ct.slice(0,Yt).trim(),rest:ct.slice(Yt).trim()}:{title:ct,rest:""}},Q=ot=>{const ct=String(ot||"").trim();if(!ct)return null;if(ct.length<=12&&L.includes(ct))return{level:2,heading:ct,rest:""};const Nt=J.exec(ct);if(Nt){const zt=String(Nt[1]||"").trim(),Pt=String(Nt[2]||"").trim();if(z(Pt))return null;const Qe=zt.split(".").length-1;return{level:Math.min(4,2+Math.max(0,Qe)),heading:`${zt} ${Pt}`.trim(),rest:""}}const Yt=R.exec(ct);if(Yt){const zt=String(Yt[1]||"").trim(),Pt=String(Yt[2]||"").trim();return z(Pt)?null:{level:2,heading:`${zt} ${Pt}`.trim(),rest:""}}if(ct.length>20){for(const zt of L)if(ct.startsWith(zt)&&ct.length>zt.length+8)return{level:2,heading:zt,rest:ct.slice(zt.length).trim()}}return null},mt=(ot,ct)=>{const Nt=String(ot||"").trim();if(!Nt)return;const Yt=Q(Nt);if(Yt){g.push({type:"heading",level:Yt.level,text:Yt.heading}),Yt.rest&&H(Yt.rest,ct);return}H(Nt,ct)},at=ot=>{const ct=ot.tagName.toLowerCase()==="table"?ot:ot.querySelector("table");if(!ct)return null;const Nt=ot.querySelector("figcaption")||ot.querySelector(".wa-table-caption")||ct.querySelector("caption"),Yt=Nt?(Nt.textContent||"").trim():"",zt=[],Pt=[],Qe=Array.from(ct.querySelectorAll("thead th"));return Qe.length&&Qe.forEach(ws=>zt.push((ws.textContent||"").trim())),Array.from(ct.querySelectorAll("tr")).forEach((ws,va)=>{const Rs=Array.from(ws.querySelectorAll("td, th"));if(!Rs.length)return;const xs=Rs.map(pa=>(pa.textContent||"").trim());if(!zt.length&&va===0&&ws.querySelectorAll("th").length===Rs.length){zt.push(...xs);return}Pt.push(xs)}),{caption:Yt,columns:zt,rows:Pt}},xt=ot=>{const ct=ot.tagName.toLowerCase()==="figure"?ot:ot.querySelector("figure"),Nt=ct?.querySelector("figcaption")||ot.querySelector("figcaption"),Yt=Nt?(Nt.textContent||"").trim():"",zt=ct?.dataset.figureSpec||"";let Pt={};if(zt)try{const Qe=JSON.parse(decodeURIComponent(zt));Qe&&typeof Qe=="object"&&(Pt=Qe)}catch{Pt={}}return Yt&&(Pt={...Pt,caption:Yt}),Object.keys(Pt).length?Pt:{caption:Yt}},It=ot=>{if(!(ot instanceof HTMLElement))return;const ct=ot.tagName.toLowerCase();if(ct==="div"&&ot.classList.contains("wa-doc")){ot.childNodes.forEach(Nt=>It(Nt));return}if(!(ot.classList.contains("wa-header")||ot.classList.contains("wa-footer"))){if(ot.classList.contains("wa-body")){ot.childNodes.forEach(Nt=>It(Nt));return}if(ot.classList.contains("wa-title")){const Nt=I(ot),Yt=it(Nt);Yt.title&&!k&&(k=Yt.title),Yt.rest&&mt(Yt.rest);return}if(ot.dataset.waTable==="1"||ot.classList.contains("wa-table")||ct==="table"){const Nt=at(ot);Nt&&g.push({type:"table",table:Nt,id:ot.dataset.blockId||void 0});return}if(ot.dataset.waFigure==="1"||ot.classList.contains("wa-figure")||ct==="figure"){const Nt=xt(ot);Nt&&g.push({type:"figure",figure:Nt,id:ot.dataset.blockId||void 0});return}if(ct==="h1"||ct==="h2"||ct==="h3"||ct==="h4"||ct==="h5"||ct==="h6"){const Nt=Number(ct.slice(1)),Yt=I(ot);if(Yt){if(Nt===1&&!k){k=Yt;return}g.push({type:"heading",level:Nt,text:Yt})}return}if(ct==="ul"||ct==="ol"){const Nt=Array.from(ot.querySelectorAll(":scope > li")).map(Yt=>I(Yt)).filter(Boolean);Nt.length&&g.push({type:"list",items:Nt,ordered:ct==="ol",id:ot.dataset.blockId||void 0});return}if(ct==="blockquote"){const Nt=I(ot);Nt&&g.push({type:"paragraph",text:Nt});return}if(ct==="pre"){const Nt=ot.textContent||"";H(Nt.replace(/\n+$/,""),ot.dataset.blockId||void 0);return}if(ct==="p"||ct==="div"){const Nt=I(ot);mt(Nt,ot.dataset.blockId||void 0);return}ot.childNodes.forEach(Nt=>It(Nt))}};v.childNodes.forEach(ot=>It(ot));const Ae=k||_s(g)||"自动生成文档";return _i(g,Ae)}function _s(o){for(const v of o){if(String(v.type||"")==="heading"&&Number(v.level||0)===1&&v.text)return String(v.text||"").trim();if(String(v.type||"")==="paragraph"&&v.text){const g=String(v.text||"").trim();if(g)return g.slice(0,24)}}return""}function _i(o,v){const g=String(v||"").trim()||"自动生成文档",k=[],A=[];let I=[];const H=()=>{if(!I.length)return;const L={id:Pn(),title:g,level:1,blocks:I,children:[]};k.push(L),A.push({level:1,node:L}),I=[]};for(const L of o){if(String(L.type||"").toLowerCase()==="heading"){const z=Math.min(6,Math.max(1,Number(L.level||1))),it=String(L.text||"").trim()||"章节",Q={id:Pn(),title:it,level:z,blocks:[],children:[]};for(I.length&&A.length===0&&H();A.length&&A[A.length-1].level>=z;)A.pop();A.length?A[A.length-1].node.children.push(Q):k.push(Q),A.push({level:z,node:Q});continue}const R=Ir(L);R&&(A.length?A[A.length-1].node.blocks.push(R):I.push(R))}return I.length&&!k.length&&k.push({id:Pn(),title:g,level:1,blocks:I,children:[]}),{title:g,sections:k}}function Ir(o){const v=String(o.type||"paragraph").toLowerCase(),k=String(o.id||"").trim()||Pn();if(v==="paragraph"){const I=String(o.text||"").trim();return I?{id:k,type:"paragraph",text:I}:null}if(v==="list"){const I=Array.isArray(o.items)?o.items.map(L=>String(L||"").trim()).filter(Boolean):[];if(!I.length)return null;const H=!!o.ordered;return{id:k,type:"list",items:I,ordered:H}}if(v==="table")return{id:k,type:"table",table:o.table||{}};if(v==="figure")return{id:k,type:"figure",figure:o.figure||{}};const A=String(o.text||"").trim();return A?{id:k,type:"paragraph",text:A}:null}function Pn(){return typeof crypto<"u"&&"randomUUID"in crypto?crypto.randomUUID().replace(/-/g,""):`b${Math.random().toString(16).slice(2)}${Date.now().toString(16)}`}function Ci(o){return o.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}function Ki(){if(!t(b))return null;const o=document.activeElement;if(o&&t(b).contains(o)&&o.isContentEditable)return o;const v=Jt[0]||null;if(v&&v.isContentEditable)return v.focus(),v;const g=t(b).querySelector('[data-wa-edit="1"]');return g?(g.focus(),g):null}function ii(){if(!t(b))return!1;const o=document.activeElement;return!!(o&&t(b).contains(o)&&o.isContentEditable)}function Ii(o){const v=Ki();if(!v)return!1;try{return document.execCommand(o)?(sr(v,0),!0):!1}catch{return!1}}function Gt(o){const v=i()||U(),g=String(o||"").toLowerCase();if(g==="copy"){gn(),Rt();return}if(g==="cut"){v||Cn(),Rt();return}if(g==="paste"){v||ni(),Rt();return}if(g==="undo"){if(v){Rt();return}Ii("undo")||Kp(),queueMicrotask(()=>Rt());return}if(g==="redo"){if(v){Rt();return}Ii("redo")||Gp(),queueMicrotask(()=>Rt());return}if(Ki()){if(o==="bold")return document.execCommand("bold");if(o==="italic")return document.execCommand("italic");if(o==="underline")return document.execCommand("underline");if(o==="strikethrough")return document.execCommand("strikeThrough");if(o==="superscript")return document.execCommand("superscript");if(o==="subscript")return document.execCommand("subscript");if(o==="heading1")return document.execCommand("formatBlock",!1,"H1");if(o==="heading2")return document.execCommand("formatBlock",!1,"H2");if(o==="heading3")return document.execCommand("formatBlock",!1,"H3");if(o==="paragraph")return document.execCommand("formatBlock",!1,"P");if(o==="list-bullet")return document.execCommand("insertUnorderedList");if(o==="list-number")return document.execCommand("insertOrderedList");if(o==="indent")return document.execCommand("indent");if(o==="outdent")return document.execCommand("outdent");if(o==="quote")return document.execCommand("formatBlock",!1,"BLOCKQUOTE");if(o==="align-left")return document.execCommand("justifyLeft");if(o==="align-center")return document.execCommand("justifyCenter");if(o==="align-right")return document.execCommand("justifyRight");if(o==="align-justify")return document.execCommand("justifyFull");if(o.startsWith("line-height:")){const k=o.slice(12),A=window.getSelection();if(A&&A.rangeCount){let H=A.getRangeAt(0).commonAncestorContainer;if(H.nodeType===Node.TEXT_NODE&&(H=H.parentElement),H instanceof HTMLElement){let L=H.closest("p, div, h1, h2, h3, blockquote");L instanceof HTMLElement&&(L.style.lineHeight=k)}}return}if(o.startsWith("margin:")){const k=o.slice(7),A=window.getSelection();if(A&&A.rangeCount){let H=A.getRangeAt(0).commonAncestorContainer;if(H.nodeType===Node.TEXT_NODE&&(H=H.parentElement),H instanceof HTMLElement){let L=H.closest("p, div, h1, h2, h3");L instanceof HTMLElement&&(L.style.margin=k)}}return}if(o==="indent-first"){const k=window.getSelection();if(k&&k.rangeCount){let I=k.getRangeAt(0).commonAncestorContainer;if(I.nodeType===Node.TEXT_NODE&&(I=I.parentElement),I instanceof HTMLElement){let H=I.closest("p, div");H instanceof HTMLElement&&(H.style.textIndent="2em")}}return}if(o.startsWith("color:")){const k=o.slice(6);return document.execCommand("foreColor",!1,k)}if(o.startsWith("bgcolor:")){const k=o.slice(8);return document.execCommand("hiliteColor",!1,k)}if(o.startsWith("font:")){const k=o.slice(5);return document.execCommand("fontName",!1,k)}if(o.startsWith("size:")){const k=o.slice(5),A=window.getSelection();if(A&&A.rangeCount){const I=A.getRangeAt(0),H=document.createElement("span");H.style.fontSize=k+"px",I.surroundContents(H)}return}if(o==="code"){const k=window.getSelection(),A=k&&k.rangeCount?k.getRangeAt(0).toString():"";return document.execCommand("insertHTML",!1,`<pre><code>${si(A||"")}</code></pre>`)}if(o==="image"){const k=document.createElement("input");k.type="file",k.accept="image/*",k.onchange=async A=>{const I=A.target.files?.[0];if(!I)return;const H=new FileReader;H.onload=L=>{const J=L.target?.result;document.execCommand("insertHTML",!1,`<img src="${J}" alt="图片" style="max-width:100%;height:auto;" />`)},H.readAsDataURL(I)},k.click();return}if(o==="table"){const k=prompt("行数：","3"),A=prompt("列数：","3");if(!k||!A)return;let I='<table style="border-collapse:collapse;width:100%;margin:10px 0;">';for(let H=0;H<parseInt(k);H++){I+="<tr>";for(let L=0;L<parseInt(A);L++)I+='<td style="border:1px solid #ccc;padding:8px;min-width:80px;">　</td>';I+="</tr>"}return I+="</table>",document.execCommand("insertHTML",!1,I)}if(o==="link"){const k=prompt("请输入链接地址：","https://");k&&document.execCommand("createLink",!1,k);return}if(o==="hr")return document.execCommand("insertHTML",!1,'<hr style="border:none;border-top:1px solid #ddd;margin:16px 0;" />');if(o==="math-inline"){const k=prompt("输入行内公式（LaTeX）：","x^2 + y^2 = r^2");k&&document.execCommand("insertHTML",!1,`<span class="math-inline" data-latex="${si(k)}">$${k}$</span>`);return}if(o==="math-block"){const k=prompt("输入公式块（LaTeX）：","\\int_{-\\infty}^{\\infty} e^{-x^2} dx = \\sqrt{\\pi}");k&&document.execCommand("insertHTML",!1,`<div class="math-block" data-latex="${si(k)}">$$${k}$$</div>`);return}if(o==="footnote"){const k=prompt("脚注内容：");if(!k)return;const A="fn-"+Date.now(),I=`<sup><a href="#${A}" id="ref-${A}" style="color:#a5722a;text-decoration:none;">[${Xn()}]</a></sup>`;document.execCommand("insertHTML",!1,I),Ni(A,k,Xn());return}if(o==="toc"){const k=ar();document.execCommand("insertHTML",!1,k);return}if(o==="clear-format")return document.execCommand("removeFormat")}}function yr(o){const v=o.ctrlKey||o.metaKey,g=String(o.key||"").toLowerCase(),k=!ii()&&$t.length>0,A=dn(o.target)||fe()||ei();if(t(Xt)){if(g==="escape"){o.preventDefault(),Nn();return}if(g==="arrowdown"){o.preventDefault(),rn(1);return}if(g==="arrowup"){o.preventDefault(),rn(-1);return}if(g==="enter"||g==="tab"){o.preventDefault(),hi(t(De));return}if(g==="backspace"){o.preventDefault(),f(bt,String(t(bt)||"").slice(0,-1)),f(De,0);return}if(!v&&!o.altKey&&!o.metaKey&&o.key.length===1){o.preventDefault(),f(bt,t(bt)+o.key),f(De,0);return}}if(!v&&!o.altKey&&o.key==="/"&&A){o.preventDefault(),ri(o.target);return}if(v&&g==="b"){o.preventDefault(),Gt("bold");return}if(v&&g==="i"){o.preventDefault(),Gt("italic");return}if(v&&g==="u"){o.preventDefault(),Gt("underline");return}if(v&&o.shiftKey&&g==="x"){o.preventDefault(),Gt("strikethrough");return}if(v&&g==="z"&&o.shiftKey){o.preventDefault(),Gt("redo");return}if(v&&g==="z"){o.preventDefault(),Gt("undo");return}if(v&&g==="y"){o.preventDefault(),Gt("redo");return}if(v&&g==="k"){o.preventDefault(),Gt("link");return}if(v&&g==="f"){o.preventDefault(),f(Hn,!0),Rt();return}if(v&&g==="c"&&k&&!Pe()){o.preventDefault(),Gt("copy");return}if(v&&g==="x"&&k&&!Pe()){o.preventDefault(),Gt("cut");return}if(v&&g==="v"&&k&&!Pe()){o.preventDefault(),Gt("paste");return}if(o.key==="Enter"&&!o.shiftKey&&!v){const I=A;if(I&&I.dataset.blockId){const H=I.tagName.toLowerCase();if(H!=="ul"&&H!=="ol"){o.preventDefault(),document.execCommand("insertLineBreak"),sr(I,0),queueMicrotask(()=>Rt());return}}}if(o.key==="Enter"&&!o.shiftKey&&v){if(A&&t(b)){o.preventDefault(),document.execCommand("insertParagraph"),Zt();const H=t(b).innerHTML||"",L=Gr(H);if(L)tn(L,{immediate:!0}),f(N,"doc"),T=`doc:${Dr(L)}`,Qn.set(!1);else{const J=Di(H);mr.set(J),Qn.set(!0),Mu(J),Oe(J)}queueMicrotask(()=>Rt());return}const I=A;if(I&&I.dataset.blockId){const H=I.tagName.toLowerCase();if(H==="ul"||H==="ol"){o.preventDefault();const L=a();if(!L||typeof L!="object")return;const J=String(I.dataset.blockId),z=window.getSelection()?.anchorNode,it=z instanceof HTMLElement?z:z?.parentElement,Q=it?it.closest("li"):null;if(!Q||!I.contains(Q))return;const mt=Array.from(I.querySelectorAll(":scope > li")),at=mt.indexOf(Q);if(at<0)return;let xt="",It="";const Ae=Ar(Q);if(Ae)xt=Ae.before,It=Ae.after;else{const zt=Ht(Q),Pt=qn(Q),Qe=Pt==null?zt.length:Math.max(0,Math.min(zt.length,Pt));xt=zt.slice(0,Qe),It=zt.slice(Qe)}const ot=vn(xt),ct=vn(It);if(!ot&&!ct){const zt=mt.map((Pt,Qe)=>Qe===at?null:vn(K(Pt))).filter(Pt=>Pt!==null);if(zt.length){const Pt=en(L,J,{type:"list",items:zt,ordered:H==="ol"});if(Pt){const Qe={id:Pn(),type:"paragraph",text:""},Fi=Cr(Pt,J,Qe);if(Fi){et=String(Qe.id||""),tn(Fi);return}tn(Pt)}}else{const Pt=en(L,J,{type:"paragraph",text:"",items:[],ordered:!1});Pt&&(et=J,tn(Pt))}return}const Nt=mt.map((zt,Pt)=>Pt===at?ot:vn(K(zt)));Nt.splice(at+1,0,ct);const Yt=en(L,J,{type:"list",items:Nt,ordered:H==="ol"});Yt&&(et=J,tn(Yt));return}if(H==="p"||/^h[1-6]$/.test(H)){o.preventDefault();const L=a();if(!L||typeof L!="object")return;const J=String(I.dataset.blockId),R=Ht(I),z=qn(I),it=z==null?R.length:Math.max(0,Math.min(R.length,z)),Q=R.slice(0,it),mt=R.slice(it),at=vn(Q),xt=vn(mt),It=Tn(I),Ae=/^h[1-6]$/.test(H);if(it===0){const zt={id:Pn(),type:"paragraph",text:""};It&&H==="p"&&(zt.style=It);const Pt=Kt(L,J,zt);Pt&&(et=String(zt.id||""),tn(Pt));return}if(it>=R.length){const zt={id:Pn(),type:"paragraph",text:""};It&&H==="p"&&(zt.style=It);const Pt=Cr(L,J,zt);Pt&&(et=String(zt.id||""),tn(Pt));return}let ot=null;if(Ae){const Pt={type:"heading",level:Number(H.slice(1)),text:at.replace(/\n+/g," ").trim()};It&&(Pt.style=It),ot=en(L,J,Pt)}else{const zt={type:"paragraph",text:at};It&&(zt.style=It),ot=en(L,J,zt)}const ct={id:Pn(),type:"paragraph",text:xt};!Ae&&It&&(ct.style=It);const Yt=Cr(ot||L,J,ct);Yt&&(et=String(ct.id||""),tn(Yt))}}}queueMicrotask(()=>Rt())}let Hn=W(!1),wr=W(""),Fr=W(""),bi=W(!1),as=W(!1),Ls=W(!1),bs=W(!1),yi=W(!1);const Xs=new Map,Z=["宋体","黑体","微软雅黑","楷体","Arial","Times New Roman","Courier New","Georgia","Verdana"],dt=[12,14,16,18,20,22,24,28,32,36,42,48,56,64,72],Vt=["#000000","#333333","#666666","#999999","#CCCCCC","#FFFFFF","#FF0000","#FF6600","#FFCC00","#00FF00","#00CCFF","#0000FF","#9900FF","#FF00FF"],qt=[1,1.15,1.5,2,2.5,3];function ye(){t(wr)&&window.find(t(wr),!1,!1,!0,!1,!0,!1)}function Xe(){if(!t(wr))return;const o=window.getSelection();o&&o.toString().toLowerCase()===t(wr).toLowerCase()&&document.execCommand("insertHTML",!1,t(Fr)),ye()}function oe(){const o=new RegExp(Vn(t(wr)),"gi");if(!t(wr))return;if(a()&&typeof a()=="object"){const g=yn(a(),o,t(Fr));g&&tn(g),f(Hn,!1);return}if(!t(b))return;let v=t(b).innerHTML;v=v.replace(o,t(Fr)),Wr(b,t(b).innerHTML=v),Zt(),f(Hn,!1)}function Vn(o){return o.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function zn(){const o=window.getSelection();if(!o||!o.rangeCount)return;const v=o.anchorNode?.parentElement?.closest("td, th");if(!v)return alert("请先选中表格单元格");const g=v.nextElementSibling;if(!g||g.tagName!=="TD"&&g.tagName!=="TH")return alert("无法合并：需要选中相邻单元格");const k=parseInt(v.getAttribute("colspan")||"1");v.setAttribute("colspan",String(k+1)),g.remove()}function Wn(){const o=window.getSelection();if(!o||!o.rangeCount)return;const v=o.anchorNode?.parentElement?.closest("td, th");if(!v)return alert("请先选中表格单元格");const g=v.parentElement,k=g.cloneNode(!0);k.querySelectorAll("td, th").forEach(A=>A.textContent="　"),g.parentElement?.insertBefore(k,g.nextSibling)}function rr(){const o=window.getSelection();if(!o||!o.rangeCount)return;const v=o.anchorNode?.parentElement?.closest("td, th");if(!v)return alert("请先选中表格单元格");const g=Array.from(v.parentElement?.children||[]).indexOf(v),k=v.closest("table");k&&k.querySelectorAll("tr").forEach(A=>{const I=document.createElement(v.tagName.toLowerCase());I.textContent="　",I.style.cssText=v.style.cssText,A.insertBefore(I,A.children[g+1])})}function xe(){const o=window.getSelection();if(!o||!o.rangeCount)return;const v=o.anchorNode?.parentElement?.closest("td, th");if(!v)return alert("请先选中表格单元格");const g=v.parentElement;if(!g)return;const k=g.parentElement;if(k&&k.children.length<=1)return alert("无法删除：表格至少需要一行");g.remove()}function xr(){const o=window.getSelection();if(!o||!o.rangeCount)return;const v=o.anchorNode?.parentElement?.closest("td, th");if(!v)return alert("请先选中表格单元格");const g=Array.from(v.parentElement?.children||[]).indexOf(v),k=v.closest("table");if(!k)return;const A=k.querySelector("tr");if(A&&A.children.length<=1)return alert("无法删除：表格至少需要一列");k.querySelectorAll("tr").forEach(I=>{I.children[g]?.remove()})}function Xn(){return t(b)?t(b).querySelectorAll('[id^="ref-fn-"]').length+1:1}function Ni(o,v,g){if(!t(b))return;let k=t(b).querySelector(".footnotes-section");k||(k=document.createElement("div"),k.className="footnotes-section",k.innerHTML='<hr style="margin-top:40px;border:none;border-top:1px solid #ddd;" /><h3>脚注</h3>',t(b).appendChild(k));const A=document.createElement("div");A.className="footnote-item",A.id=o,A.innerHTML=`<sup>[${g}]</sup> ${v}`,k.appendChild(A)}function ar(){if(!t(b))return"";const o=t(b).querySelectorAll("h1, h2, h3");if(o.length===0)return"<p>未找到标题</p>";let v='<div class="toc-section" style="border:1px solid #ddd;padding:16px;border-radius:8px;background:rgba(255,255,255,0.5);margin:20px 0;"><h3>目录</h3><ul style="list-style:none;padding-left:0;">';return o.forEach((g,k)=>{const A=parseInt(g.tagName[1]),I=g.textContent||"",H="heading-"+k;g.id=H;const L=(A-1)*20;v+=`<li style="margin-left:${L}px;margin-top:8px;"><a href="#${H}" style="color:#a5722a;text-decoration:none;">${I}</a></li>`}),v+="</ul></div>",v}function si(o){return String(o||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function wi(){if(!(!t(b)||!window.renderMathInElement))try{window.renderMathInElement(t(b),{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],throwOnError:!1})}catch(o){console.error("Math rendering error:",o)}}function xi(){!t(b)||!window.Prism||t(b).querySelectorAll("pre code").forEach(o=>{window.Prism.highlightElement(o)})}async function Or(){if(!t(b))return;const o=Array.from(t(b).querySelectorAll(".wa-figure[data-figure-spec]"));for(const v of o){if(v.dataset.figureRendered==="1")continue;const g=v.dataset.figureSpec||"";if(!g)continue;v.dataset.figureRendered="1";let k=null;try{k=JSON.parse(decodeURIComponent(g))}catch{k=null}if(!k)continue;const A=JSON.stringify(k);let I=Xs.get(A);const H=v.querySelector(".wa-figure-box");if(H&&(H.innerHTML='<div class="wa-figure-loading">渲染中...</div>'),!I)try{const L=await fetch("/api/figure/render",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({spec:k})});if(!L.ok)throw new Error(await L.text());const J=await L.json();I=String(J.svg||""),I&&Xs.set(A,I)}catch{I=""}H&&(H.innerHTML=I||'<div class="wa-figure-loading">渲染失败</div>')}}const Li=Do.subscribe(o=>{if(o){if(o==="commit"){wn(),Do.set(null),queueMicrotask(()=>Rt());return}Gt(o),Do.set(null),queueMicrotask(()=>Rt())}});qa(()=>{if(Er(),!_e(a())){const z=String(r()||"").trim(),it=z?nc(z):null;it?($r.set(it),Qn.set(!1)):($r.set(Br()),Qn.set(!1))}E=mr.subscribe(()=>Er()),$r.subscribe(()=>Er());const o=document.createElement("link");o.rel="stylesheet",o.href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css",document.head.appendChild(o);const v=document.createElement("script");v.src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js",v.onload=()=>{const z=document.createElement("script");z.src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js",z.onload=()=>{wi()},document.head.appendChild(z)},document.head.appendChild(v);const g=document.createElement("link");g.rel="stylesheet",g.href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css",document.head.appendChild(g);const k=document.createElement("script");k.src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js",k.onload=()=>{const z=["https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-clike.min.js","https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-c.min.js","https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-cpp.min.js","https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-java.min.js","https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-javascript.min.js","https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-python.min.js","https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-sql.min.js"],it=Q=>new Promise(mt=>{const at=document.createElement("script");at.src=Q,at.async=!1,at.onload=()=>mt(),at.onerror=()=>mt(),document.head.appendChild(at)});(async()=>{for(const Q of z)await it(Q);setTimeout(()=>xi(),500)})()},document.head.appendChild(k);const A=new IntersectionObserver(z=>{z.forEach(it=>{if(it.isIntersecting&&it.target instanceof HTMLImageElement){const Q=it.target;Q.dataset.src&&(Q.src=Q.dataset.src,Q.removeAttribute("data-src"))}})}),I=new MutationObserver(()=>{t(b)?.querySelectorAll("img[data-src]").forEach(z=>A.observe(z))});t(b)&&I.observe(t(b),{childList:!0,subtree:!0});const H=()=>Rt(),L=()=>Rt(),J=()=>Rt(),R=z=>{if(z.defaultPrevented||!(z.ctrlKey||z.metaKey))return;const Q=z.target;if(!!Q?.closest("input, textarea, select")||!!(Q&&Q.isContentEditable&&!t(b)?.contains(Q)))return;const at=String(z.key||"").toLowerCase();if(!ii()&&!$t.length)return;const xt=!ii()&&$t.length>0;if(at==="c"){xt&&!Pe()&&(z.preventDefault(),Gt("copy"));return}if(at==="x"){xt&&!Pe()&&(z.preventDefault(),Gt("cut"));return}if(at==="v"){xt&&!Pe()&&(z.preventDefault(),Gt("paste"));return}if(at==="z"&&z.shiftKey){z.preventDefault(),Gt("redo");return}if(at==="z"){z.preventDefault(),Gt("undo");return}at==="y"&&(z.preventDefault(),Gt("redo"))};return document.addEventListener("selectionchange",H),t(b)?.addEventListener("mouseup",L),t(b)?.addEventListener("keyup",J),window.addEventListener("keydown",R),Rt(!0),()=>{_r(),Li(),E&&E(),A.disconnect(),I.disconnect(),document.removeEventListener("selectionchange",H),t(b)?.removeEventListener("mouseup",L),t(b)?.removeEventListener("keyup",J),window.removeEventListener("keydown",R),q&&clearTimeout(q),O&&clearTimeout(O),Et&&clearTimeout(Et)}}),Hs(()=>(i(),ie(U()),t(b),t(Tt)),()=>{const o=i()||U();t(b)&&(ne(),Zt(),o&&t(Tt)&&(t(Tt).blur(),f(Tt,null),f(kt,"")),Rt())}),io();var ai={get showToolbar(){return P()},set showToolbar(o){P(o),cr()},get paper(){return vt()},set paper(o){vt(o),cr()},get lockEditing(){return U()},set lockEditing(o){U(o),cr()},$set:vi,$on:(o,v)=>di(n,o,v)};Ds();var Ri=Om(),oi=p(Ri);{var Ye=o=>{var v=Mm(),g=hr(v),k=u(p(g),2),A=p(k),I=p(A);d(A);var H=u(A,4),L=p(H);d(H),d(k),d(g);var J=u(g,2),R=p(J),z=p(R),it=u(z,2);{var Q=_n=>{var xn=Sm();cn(xn,5,()=>Z,Jn,(Nr,on)=>{var ln=km(),Gi=p(ln,!0);d(ln),rt(()=>{Ts(ln,`font-family: ${t(on)??""}`),D(Gi,t(on))}),C("click",ln,()=>{Gt("font:"+t(on)),f(bi,!1)}),M(Nr,ln)}),d(xn),M(_n,xn)};tt(it,_n=>{t(bi)&&_n(Q)})}d(R);var mt=u(R,2),at=p(mt),xt=p(at);xt.value=xt.__value="";var It=u(xt);cn(It,1,()=>dt,Jn,(_n,xn)=>{var Nr=$m(),on=p(Nr);d(Nr);var ln={};rt(()=>{D(on,`${t(xn)??""}pt`),ln!==(ln=t(xn))&&(Nr.value=(Nr.__value=t(xn))??"")}),M(_n,Nr)}),d(at),d(mt);var Ae=u(mt,2),ot=p(Ae),ct=u(ot,2);{var Nt=_n=>{var xn=jm();cn(xn,5,()=>Vt,Jn,(Nr,on)=>{var ln=Tm();rt(()=>{Ts(ln,`background: ${t(on)??""};`),js(ln,"aria-label",`文字颜色 ${t(on)}`)}),C("click",ln,()=>{Gt("color:"+t(on)),f(as,!1)}),M(Nr,ln)}),d(xn),M(_n,xn)};tt(ct,_n=>{t(as)&&_n(Nt)})}d(Ae);var Yt=u(Ae,2),zt=p(Yt),Pt=u(zt,2);{var Qe=_n=>{var xn=Am();cn(xn,5,()=>Vt,Jn,(Nr,on)=>{var ln=Em();rt(()=>{Ts(ln,`background: ${t(on)??""};`),js(ln,"aria-label",`背景颜色 ${t(on)}`)}),C("click",ln,()=>{Gt("bgcolor:"+t(on)),f(Ls,!1)}),M(Nr,ln)}),d(xn),M(_n,xn)};tt(Pt,_n=>{t(Ls)&&_n(Qe)})}d(Yt);var Fi=u(Yt,4),ws=u(Fi,2),va=u(ws,2),Rs=u(va,2),xs=u(Rs,4),pa=u(xs,2),ao=u(pa,2),Oa=u(ao,4),oo=p(Oa),ks=u(oo,2);{var Qo=_n=>{var xn=Im();cn(xn,5,()=>qt,Jn,(Nr,on)=>{var ln=Cm(),Gi=p(ln);d(ln),rt(()=>D(Gi,`${t(on)??""}倍行距`)),C("click",ln,()=>{Gt("line-height:"+t(on)),f(bs,!1)}),M(Nr,ln)}),d(xn),M(_n,xn)};tt(ks,_n=>{t(bs)&&_n(Qo)})}d(Oa);var lo=u(Oa,2),co=u(lo,2),uo=u(co,4),fo=u(uo,2),vo=u(fo,4),ma=u(vo,2),Pa=u(ma,4),Ha=p(Pa),po=u(Ha,2);{var mo=_n=>{var xn=Nm(),Nr=p(xn),on=u(Nr,2),ln=u(on,2),Gi=u(ln,2),ho=u(Gi,2),Ys=u(ho,2);d(xn),C("click",Nr,()=>{Gt("table"),f(yi,!1)}),C("click",on,()=>{zn(),f(yi,!1)}),C("click",ln,()=>{Wn(),f(yi,!1)}),C("click",Gi,()=>{rr(),f(yi,!1)}),C("click",ho,()=>{xe(),f(yi,!1)}),C("click",Ys,()=>{xr(),f(yi,!1)}),M(_n,xn)};tt(po,_n=>{t(yi)&&_n(mo)})}d(Pa),d(J),rt(_n=>{D(I,`${h()??""} 字`),D(L,`${_n??""} 分钟阅读`)},[()=>(h(),_(()=>Math.ceil(h()/400)))]),C("click",z,()=>f(bi,!t(bi))),C("change",at,_n=>Gt("size:"+_n.currentTarget.value)),C("click",ot,()=>f(as,!t(as))),C("click",zt,()=>f(Ls,!t(Ls))),C("click",Fi,()=>Gt("align-left")),C("click",ws,()=>Gt("align-center")),C("click",va,()=>Gt("align-right")),C("click",Rs,()=>Gt("align-justify")),C("click",xs,()=>Gt("superscript")),C("click",pa,()=>Gt("subscript")),C("click",ao,()=>Gt("hr")),C("click",oo,()=>f(bs,!t(bs))),C("click",lo,()=>Gt("indent-first")),C("click",co,()=>Gt("margin:10px 0")),C("click",uo,()=>Gt("math-inline")),C("click",fo,()=>Gt("math-block")),C("click",vo,()=>Gt("footnote")),C("click",ma,()=>Gt("toc")),C("click",Ha,()=>f(yi,!t(yi))),M(o,v)};tt(oi,o=>{P()&&o(Ye)})}var Ke=u(oi,2);bc(Ke,o=>f(b,o),()=>t(b));var ki=u(Ke,2);{var li=o=>{var v=Rm(),g=p(v),k=u(p(g),2),A=p(k,!0);d(k),d(g);var I=u(g,2);{var H=R=>{var z=Bm();M(R,z)},L=Sa(()=>_(()=>Kn().length===0)),J=R=>{var z=Lm();cn(z,5,()=>_(Kn),Jn,(it,Q,mt)=>{var at=Dm(),xt=p(at),It=p(xt,!0);d(xt);var Ae=u(xt,2),ot=p(Ae,!0);d(Ae),d(at),rt(()=>{Ne(at,1,`slash-item ${mt===t(De)?"active":""}`,"svelte-lk86dq"),js(at,"aria-selected",mt===t(De)),D(It,(t(Q),_(()=>t(Q).label))),D(ot,(t(Q),_(()=>t(Q).desc)))}),C("mouseenter",at,()=>f(De,mt)),C("click",at,()=>hi(mt)),M(it,at)}),d(z),M(R,z)};tt(I,R=>{t(L)?R(H):R(J,!1)})}us(2),d(v),rt(()=>{Ts(v,`left:${t(mn)}px;top:${t(fn)}px;`),D(A,t(bt)||"全部")}),C("mousedown",v,ua(function(R){ps.call(this,n,R)})),M(o,v)};tt(ki,o=>{t(Xt)&&o(li)})}var os=u(ki,2);{var qi=o=>{var v=qm();rt(()=>Ts(v,(t(un),_(()=>`left:${t(un).left}px;top:${t(un).top}px;width:${t(un).width}px;height:${t(un).height}px;`)))),M(o,v)};tt(os,o=>{t(ke)&&o(qi)})}var ys=u(os,2);{var Xo=o=>{var v=Fm(),g=p(v),k=p(g);tr(k);var A=u(k,2),I=u(A,2);d(g);var H=u(g,2),L=p(H);tr(L);var J=u(L,2),R=u(J,2);d(H),d(v),sn(k,()=>t(wr),z=>f(wr,z)),C("click",A,ye),C("click",I,()=>f(Hn,!1)),sn(L,()=>t(Fr),z=>f(Fr,z)),C("click",J,Xe),C("click",R,oe),M(o,v)};tt(ys,o=>{t(Hn)&&o(Xo)})}d(Ri),rt(()=>{Ne(Ri,1,`panel editor ${vt()?"paper":""}`,"svelte-lk86dq"),js(Ke,"data-render-mode",t(N)),js(Ke,"contenteditable",i()||U()?"false":"true")}),C("mousedown",Ke,On),C("input",Ke,He),C("focusin",Ke,gi),C("focusout",Ke,ss),C("compositionstart",Ke,ae),C("compositionend",Ke,Gn),C("click",Ke,fr),C("keydown",Ke,yr),M(e,Ri);var Yo=ti(ai);return S(),Yo}function Yf(e,n){if(new.target)return fi({component:Yf,...e});Zr(n,!1);let i=jr(n,"showToolbar",12,!0),r=jr(n,"paper",12,!0),a=jr(n,"lockEditing",12,!1);var s={get showToolbar(){return i()},set showToolbar(m){i(m),cr()},get paper(){return r()},set paper(m){r(m),cr()},get lockEditing(){return a()},set lockEditing(m){a(m),cr()},$set:vi,$on:(m,h)=>di(n,m,h)};return Xf(e,{get showToolbar(){return i()},get paper(){return r()},get lockEditing(){return a()},$$events:{blockedit(m){ps.call(this,n,m)},blockselect(m){ps.call(this,n,m)},toolbarstate(m){ps.call(this,n,m)}}}),ti(s)}var Pm=F("<button> </button>"),Hm=F('<button class="template-chip svelte-1ka5p0t"> </button>'),zm=F('<div class="kind-grid svelte-1ka5p0t"></div> <div class="template-list svelte-1ka5p0t"></div> <textarea class="prompt-box svelte-1ka5p0t" rows="5" placeholder="输入你要绘制的内容，例如：用户登录到下单的关键流程。"></textarea> <div class="canvas-actions svelte-1ka5p0t"><button class="btn primary svelte-1ka5p0t"> </button> <button class="btn ghost svelte-1ka5p0t">插入文档</button></div> <textarea class="prompt-box mini svelte-1ka5p0t" rows="3" placeholder="二次优化，例如：改成更简洁的 5 个节点，强调异常分支。"></textarea> <button class="btn ghost svelte-1ka5p0t">AI 二次优化</button>',1),Wm=F('<textarea class="spec-editor svelte-1ka5p0t" rows="18" placeholder="可直接编辑 JSON 规范，例如：type=flow，caption=示例，data 包含 nodes/edges。"></textarea> <div class="canvas-actions svelte-1ka5p0t"><button class="btn primary svelte-1ka5p0t">应用规范</button> <button class="btn ghost svelte-1ka5p0t">复制规范</button></div>',1),Um=F('<div class="empty svelte-1ka5p0t">暂无历史记录</div>'),Jm=F('<button class="history-item svelte-1ka5p0t"><div class="svelte-1ka5p0t"> </div> <div class="svelte-1ka5p0t"> </div> <div class="svelte-1ka5p0t"> </div></button>'),Km=F('<div class="history-list svelte-1ka5p0t"><!></div>'),Gm=F('<div class="error svelte-1ka5p0t"> </div>'),Vm=F('<div class="svg-host svelte-1ka5p0t"><div class="svg-scale svelte-1ka5p0t"><!></div></div>'),Xm=F('<div class="placeholder svelte-1ka5p0t"><h4 class="svelte-1ka5p0t">画布预览区</h4> <p class="svelte-1ka5p0t">左侧输入描述后点击“生成图形”，或切换到 JSON 手动编辑规范。</p></div>'),Ym=F('<div class="canvas-backdrop svelte-1ka5p0t" role="button" tabindex="0" aria-label="关闭画布"><section class="canvas-shell svelte-1ka5p0t" aria-label="AI 画布系统"><header class="canvas-topbar svelte-1ka5p0t"><div class="title-wrap svelte-1ka5p0t"><h3 class="svelte-1ka5p0t">AI 画布系统</h3> <p class="svelte-1ka5p0t">同页完成生成、修改、预览、插入，支持流程图/ER 图/时序图/统计图。</p></div> <div class="top-actions svelte-1ka5p0t"><button class="btn ghost svelte-1ka5p0t">工作台</button> <button class="btn ghost svelte-1ka5p0t">JSON</button> <button class="btn ghost svelte-1ka5p0t">历史</button> <button class="btn ghost svelte-1ka5p0t">清空</button> <button class="close-btn svelte-1ka5p0t" aria-label="关闭">×</button></div></header> <div class="canvas-main svelte-1ka5p0t"><aside class="canvas-sidebar svelte-1ka5p0t"><div class="panel-title svelte-1ka5p0t"> </div> <!> <!> <!> <!></aside> <section class="canvas-stage svelte-1ka5p0t"><div class="stage-toolbar svelte-1ka5p0t"><div class="zoom-group svelte-1ka5p0t"><button class="btn ghost svelte-1ka5p0t">-</button> <span> </span> <button class="btn ghost svelte-1ka5p0t">+</button> <button class="btn ghost svelte-1ka5p0t">重置缩放</button></div> <div class="export-group svelte-1ka5p0t"><button class="btn ghost svelte-1ka5p0t">复制 SVG</button> <button class="btn ghost svelte-1ka5p0t">下载 SVG</button> <button class="btn primary svelte-1ka5p0t">插入正文</button></div></div> <div class="preview-wrap svelte-1ka5p0t"><!></div></section></div></section></div>');function Qf(e,n){if(new.target)return fi({component:Qf,...e});Zr(n,!1);let i=jr(n,"open",12,!1),r=jr(n,"docId",12,"");const a=_c(),s=[{value:"flow",label:"流程图"},{value:"er",label:"ER 图"},{value:"sequence",label:"时序图"},{value:"timeline",label:"时间线"},{value:"bar",label:"柱状图"},{value:"line",label:"折线图"},{value:"pie",label:"饼图"}],m={flow:["需求分析 -> 方案设计 -> 开发实现 -> 测试验收 -> 上线运营","用户登录 -> 权限校验 -> 数据查询 -> 结果返回","问题发现 -> 原因定位 -> 修复验证 -> 发布回归"],er:["电商系统：用户、订单、商品、支付","教学系统：学生、课程、教师、选课记录","医院系统：患者、医生、挂号、检查报告"],sequence:["用户 -> 网关 -> 认证服务 -> 业务服务 -> 数据库","浏览器 -> 服务端 -> 缓存 -> 数据库","客户端 -> API -> 队列 -> Worker -> 存储"],timeline:["立项 -> 调研 -> 设计 -> 开发 -> 测试 -> 发布","需求冻结 -> 联调 -> 验收 -> 复盘","周一需求 -> 周三开发 -> 周五发布"],bar:["近 3 个月活跃用户对比","三种方案成本对比","各模块缺陷数统计"],line:["Q1-Q4 访问量变化趋势","模型版本准确率变化","系统响应时间趋势"],pie:["项目成本占比：人力、硬件、云资源、其他","问题类型占比：功能、性能、兼容性、体验","用户来源占比：自然、投放、活动、推荐"]};let h=W("studio"),y=W("flow"),S=W(""),b=W(""),T=W(!1),N=W(""),q=W(""),O=W(null),E=W(""),P=W(1),vt=W([]);function U(bt){return bt==="json"?"规范编辑":bt==="history"?"历史画布":"智能画布"}function lt(){a("close")}function Tt(bt){f(S,bt)}function kt(bt){const At=String(bt||"").trim().toLowerCase();return At==="er"?"er":At==="sequence"?"sequence":At==="timeline"?"timeline":At==="bar"?"bar":At==="line"?"line":At==="pie"?"pie":"flow"}function Mt(bt){if(!bt||typeof bt!="object"||Array.isArray(bt))throw new Error("图形规范不是对象");return bt}function Wt(bt){return JSON.stringify(bt,(At,ne)=>typeof ne=="string"?ne.replace(/\u0000/g,""):ne,2)}function et(bt,At,ne,Oe){f(vt,[{id:Date.now(),kind:At,prompt:bt,spec:ne,svg:Oe,ts:Date.now()},...t(vt)].slice(0,40))}async function Et(bt,At,ne){const Oe=await fetch("/api/figure/render",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({spec:bt})});if(!Oe.ok)throw new Error(await Oe.text());const _e=await Oe.json(),Br=String(_e.svg||"");f(q,Br),f(O,bt),f(E,Wt(bt)),et(At,ne,bt,Br)}async function $t(bt){const At=String(bt||t(S)||"").trim();if(!r()){f(N,"文档未加载");return}if(At){f(T,!0),f(N,"");try{const ne=await fetch(`/api/doc/${r()}/diagram/generate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt:At,kind:t(y)})});if(!ne.ok)throw new Error(await ne.text());const Oe=await ne.json(),_e=Mt(Oe.spec||{});await Et(_e,At,t(y)),f(h,"studio")}catch(ne){f(N,ne instanceof Error?ne.message:"图形生成失败")}finally{f(T,!1)}}}async function Jt(){const bt=t(b).trim();if(!bt)return;if(!t(O)){await $t(bt);return}const At=JSON.stringify(t(O)).slice(0,1800);await $t(`在当前图基础上优化：${bt}
当前规范：${At}`)}async function de(){const bt=String(t(E)||"").trim();if(bt){f(T,!0),f(N,"");try{const At=Mt(JSON.parse(bt)),ne=kt(At.type);f(y,ne),await Et(At,"手动编辑规范",ne),f(h,"studio")}catch(At){f(N,At instanceof Error?At.message:"规范解析失败")}finally{f(T,!1)}}}function Be(bt){f(y,bt.kind),f(S,bt.prompt),f(O,bt.spec),f(q,bt.svg),f(E,Wt(bt.spec)),f(h,"studio")}function ke(){t(O)&&a("insert",{spec:t(O)})}async function un(){if(t(q))try{await navigator.clipboard.writeText(t(q))}catch{f(N,"复制 SVG 失败，请检查浏览器权限")}}async function Bt(){if(t(E).trim())try{await navigator.clipboard.writeText(t(E))}catch{f(N,"复制规范失败，请检查浏览器权限")}}function pt(){if(!t(q))return;const bt=new Blob([t(q)],{type:"image/svg+xml;charset=utf-8"}),At=URL.createObjectURL(bt),ne=document.createElement("a");ne.href=At,ne.download=`canvas-${Date.now()}.svg`,document.body.appendChild(ne),ne.click(),ne.remove(),URL.revokeObjectURL(At)}function jt(){f(q,""),f(O,null),f(E,""),f(b,""),f(N,""),f(P,1)}function Dt(bt){bt.key==="Escape"&&lt()}var Xt={get open(){return i()},set open(bt){i(bt),cr()},get docId(){return r()},set docId(bt){r(bt),cr()},$set:vi,$on:(bt,At)=>di(n,bt,At)};Ds();var mn=Vs(),fn=hr(mn);{var De=bt=>{var At=Ym(),ne=p(At),Oe=p(ne),_e=u(p(Oe),2),Br=p(_e),Er=u(Br,2),Dr=u(Er,2),pi=u(Dr,2),Zt=u(pi,2);d(_e),d(Oe);var ue=u(Oe,2),dn=p(ue),fe=p(dn),ei=p(fe,!0);d(fe);var vn=u(fe,2);{var Ji=se=>{var ve=zm(),nn=hr(ve);cn(nn,5,()=>s,Jn,(je,Ee)=>{var Re=Pm(),Pe=p(Re,!0);d(Re),rt(()=>{Ne(Re,1,(t(y),t(Ee),_(()=>`kind-chip ${t(y)===t(Ee).value?"active":""}`)),"svelte-1ka5p0t"),D(Pe,(t(Ee),_(()=>t(Ee).label)))}),C("click",Re,()=>f(y,t(Ee).value)),M(je,Re)}),d(nn);var Ge=u(nn,2);cn(Ge,5,()=>(t(y),_(()=>m[t(y)])),Jn,(je,Ee)=>{var Re=Hm(),Pe=p(Re,!0);d(Re),rt(()=>D(Pe,t(Ee))),C("click",Re,()=>Tt(t(Ee))),M(je,Re)}),d(Ge);var te=u(Ge,2);fs(te);var Se=u(te,2),me=p(Se),En=p(me,!0);d(me);var he=u(me,2);d(Se);var be=u(Se,2);fs(be);var pe=u(be,2);rt((je,Ee)=>{me.disabled=je,D(En,t(T)?"生成中...":"生成图形"),he.disabled=!t(O),pe.disabled=Ee},[()=>(t(T),t(S),_(()=>t(T)||!t(S).trim())),()=>(t(T),t(b),_(()=>t(T)||!t(b).trim()))]),sn(te,()=>t(S),je=>f(S,je)),C("click",me,()=>$t()),C("click",he,ke),sn(be,()=>t(b),je=>f(b,je)),C("click",pe,Jt),M(se,ve)};tt(vn,se=>{t(h)==="studio"&&se(Ji)})}var K=u(vn,2);{var ft=se=>{var ve=Wm(),nn=hr(ve);fs(nn);var Ge=u(nn,2),te=p(Ge),Se=u(te,2);d(Ge),rt((me,En)=>{te.disabled=me,Se.disabled=En},[()=>(t(T),t(E),_(()=>t(T)||!t(E).trim())),()=>(t(E),_(()=>!t(E).trim()))]),sn(nn,()=>t(E),me=>f(E,me)),C("click",te,de),C("click",Se,Bt),M(se,ve)};tt(K,se=>{t(h)==="json"&&se(ft)})}var Ht=u(K,2);{var pn=se=>{var ve=Km(),nn=p(ve);{var Ge=Se=>{var me=Um();M(Se,me)},te=Se=>{var me=Vs(),En=hr(me);cn(En,1,()=>t(vt),Jn,(he,be)=>{var pe=Jm(),je=p(pe),Ee=p(je,!0);d(je);var Re=u(je,2),Pe=p(Re,!0);d(Re);var er=u(Re,2),wt=p(er,!0);d(er),d(pe),rt((re,$e)=>{D(Ee,re),D(Pe,(t(be),_(()=>t(be).prompt||"无描述"))),D(wt,$e)},[()=>(t(be),_(()=>s.find(re=>re.value===t(be).kind)?.label||t(be).kind)),()=>(t(be),_(()=>new Date(t(be).ts).toLocaleString()))]),C("click",pe,()=>Be(t(be))),M(he,pe)}),M(Se,me)};tt(nn,Se=>{t(vt),_(()=>t(vt).length===0)?Se(Ge):Se(te,!1)})}d(ve),M(se,ve)};tt(Ht,se=>{t(h)==="history"&&se(pn)})}var Ar=u(Ht,2);{var Rn=se=>{var ve=Gm(),nn=p(ve,!0);d(ve),rt(()=>D(nn,t(N))),M(se,ve)};tt(Ar,se=>{t(N)&&se(Rn)})}d(dn);var qn=u(dn,2),Tn=p(qn),Le=p(Tn),an=p(Le),jn=u(an,2),tn=p(jn);d(jn);var ur=u(jn,2),Lr=u(ur,2);d(Le);var en=u(Le,2),Cr=p(en),Kt=u(Cr,2),yn=u(Kt,2);d(en),d(Tn);var sr=u(Tn,2),Fn=p(sr);{var wn=se=>{var ve=Vm(),nn=p(ve),Ge=p(nn);jp(Ge,()=>t(q)),d(nn),d(ve),rt(()=>Ts(nn,`transform: scale(${t(P)});`)),M(se,ve)},Rr=se=>{var ve=Xm();M(se,ve)};tt(Fn,se=>{t(q)?se(wn):se(Rr,!1)})}d(sr),d(qn),d(ue),d(ne),d(At),rt((se,ve)=>{D(ei,se),D(tn,`${ve??""}%`),Cr.disabled=!t(q),Kt.disabled=!t(q),yn.disabled=!t(O)},[()=>(t(h),_(()=>U(t(h)))),()=>(t(P),_(()=>Math.round(t(P)*100)))]),C("click",Br,()=>f(h,"studio")),C("click",Er,()=>f(h,"json")),C("click",Dr,()=>f(h,"history")),C("click",pi,jt),C("click",Zt,lt),C("click",an,()=>f(P,Math.max(.4,Number((t(P)-.1).toFixed(1))))),C("click",ur,()=>f(P,Math.min(2.2,Number((t(P)+.1).toFixed(1))))),C("click",Lr,()=>f(P,1)),C("click",Cr,un),C("click",Kt,pt),C("click",yn,ke),C("click",At,gp(lt)),C("keydown",At,Dt),M(bt,At)};tt(fn,bt=>{i()&&bt(De)})}return M(e,mn),ti(Xt)}var Qm=F("<div> </div>"),Zm=F('<div class="toast-root svelte-1cpok13"></div>');function Zf(e,n){if(new.target)return fi({component:Zf,...e});Zr(n,!1);const i=()=>Zn(Ql,"$toasts",r),[r,a]=Fa();var s={$set:vi,$on:(y,S)=>di(n,y,S)},m=Zm();cn(m,5,i,y=>y.id,(y,S)=>{var b=Qm(),T=p(b,!0);d(b),rt(()=>{Ne(b,1,`toast ${t(S),_(()=>t(S).type)??""}`,"svelte-1cpok13"),D(T,(t(S),_(()=>t(S).message)))}),M(y,b)}),d(m),M(e,m);var h=ti(s);return a(),h}var th=F('<button type="button" class="modal-backdrop svelte-ta60gp" aria-label="关闭"></button> <div class="modal svelte-ta60gp" role="dialog" aria-modal="true"><div class="modal-header svelte-ta60gp"><div class="modal-title svelte-ta60gp"> </div> <button class="btn ghost">关闭</button></div> <div class="modal-body"><!></div></div>',1);function td(e,n){if(new.target)return fi({component:td,...e});Zr(n,!1);let i=jr(n,"open",12,!1),r=jr(n,"title",12,""),a=jr(n,"onClose",12);var s={get open(){return i()},set open(S){i(S),cr()},get title(){return r()},set title(S){r(S),cr()},get onClose(){return a()},set onClose(S){a(S),cr()},$set:vi,$on:(S,b)=>di(n,S,b)},m=Vs(),h=hr(m);{var y=S=>{var b=th(),T=hr(b),N=u(T,2),q=p(N),O=p(q),E=p(O,!0);d(O);var P=u(O,2);d(q);var vt=u(q,2),U=p(vt);Lf(U,n,"default",{}),d(vt),d(N),rt(()=>D(E,r())),C("click",T,function(...lt){a()?.apply(this,lt)}),C("click",P,function(...lt){a()?.apply(this,lt)}),M(S,b)};tt(h,S=>{i()&&S(y)})}return M(e,m),ti(s)}var eh=F('<div class="settings-row svelte-anx9w7"><label><input type="checkbox"/> 扩展大纲</label></div> <div class="settings-row svelte-anx9w7"><label><input type="checkbox"/> 需要引用</label></div> <div class="settings-row svelte-anx9w7"><label for="targetChars">目标字数</label> <input id="targetChars" type="number" min="100" max="10000" placeholder="例如 1000" class="svelte-anx9w7"/></div> <div class="settings-row svelte-anx9w7"><label for="styleTone">风格/语气</label> <input id="styleTone" type="text" placeholder="例如：正式、简洁、适度营销" class="svelte-anx9w7"/></div> <div class="settings-row svelte-anx9w7"><label for="outputFormat">输出格式</label> <select id="outputFormat" class="svelte-anx9w7"><option>Markdown</option><option>纯文本</option></select></div> <div class="settings-section svelte-anx9w7"><div class="section-title svelte-anx9w7">高级设置（可改所有默认值）</div> <label for="formattingJson">格式 formatting</label> <textarea id="formattingJson" rows="6" class="svelte-anx9w7"></textarea> <label for="prefsJson">生成偏好 generation_prefs</label> <textarea id="prefsJson" rows="6" class="svelte-anx9w7"></textarea></div> <div class="settings-actions svelte-anx9w7"><button class="btn primary">保存</button> <button class="btn ghost">取消</button></div>',1),nh=F('<button class="btn ghost">设置</button> <!>',1);function ed(e,n){if(new.target)return fi({component:ed,...e});Zr(n,!1);const i=()=>Zn(Ms,"$docId",r),[r,a]=Fa();let s=W(!1),m=W(!1),h=W(""),y=W(""),S=W(!1),b=W("markdown"),T=W(""),N=W("");async function q(){const kt=i();if(!kt)return;const Mt=await fetch(`/api/doc/${kt}`);if(!Mt.ok)return;const Wt=await Mt.json(),et=Wt.generation_prefs||{},Et=Wt.formatting||{};f(m,!!et.expand_outline),f(h,et.target_chars?Number(et.target_chars):""),f(y,String(Et.style||"")),f(S,!!et.citations_required),f(b,String(et.output_format||"markdown")),f(T,JSON.stringify(Et,null,2)),f(N,JSON.stringify(et,null,2))}async function O(){const kt=i();if(!kt)return;let Mt={},Wt={};try{Mt=t(T).trim()?JSON.parse(t(T)):{},Wt=t(N).trim()?JSON.parse(t(N)):{}}catch{gt("高级设置 JSON 解析失败，请检查格式。","bad");return}const et={generation_prefs:{...Wt,expand_outline:t(m),citations_required:t(S),output_format:t(b)},formatting:{...Mt,style:t(y)}};t(h)&&(et.generation_prefs.target_chars=Number(t(h))),await fetch(`/api/doc/${kt}/settings`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(et)}),gt("设置已保存","ok"),f(s,!1)}function E(){f(s,!0),q().catch(()=>{})}var P={$set:vi,$on:(kt,Mt)=>di(n,kt,Mt)};Ds();var vt=nh(),U=hr(vt),lt=u(U,2);td(lt,{get open(){return t(s)},title:"生成设置",onClose:()=>f(s,!1),children:(kt,Mt)=>{var Wt=eh(),et=hr(Wt),Et=p(et),$t=p(Et);tr($t),us(),d(Et),d(et);var Jt=u(et,2),de=p(Jt),Be=p(de);tr(Be),us(),d(de),d(Jt);var ke=u(Jt,2),un=u(p(ke),2);tr(un),d(ke);var Bt=u(ke,2),pt=u(p(Bt),2);tr(pt),d(Bt);var jt=u(Bt,2),Dt=u(p(jt),2),Xt=p(Dt);Xt.value=Xt.__value="markdown";var mn=u(Xt);mn.value=mn.__value="plain",d(Dt),d(jt);var fn=u(jt,2),De=u(p(fn),4);fs(De);var bt=u(De,4);fs(bt),d(fn);var At=u(fn,2),ne=p(At),Oe=u(ne,2);d(At),Xl($t,()=>t(m),_e=>f(m,_e)),Xl(Be,()=>t(S),_e=>f(S,_e)),sn(un,()=>t(h),_e=>f(h,_e)),sn(pt,()=>t(y),_e=>f(y,_e)),$s(Dt,()=>t(b),_e=>f(b,_e)),sn(De,()=>t(T),_e=>f(T,_e)),sn(bt,()=>t(N),_e=>f(N,_e)),C("click",ne,O),C("click",Oe,()=>f(s,!1)),M(kt,Wt)},$$slots:{default:!0}}),C("click",U,E),M(e,vt);var Tt=ti(P);return a(),Tt}var rh=F('<div class="loading svelte-1bmythy">加载中...</div>'),ih=F('<div class="empty svelte-1bmythy">暂无文档</div>'),sh=F('<div class="doc-item svelte-1bmythy"><button class="doc-info svelte-1bmythy" type="button"><div class="doc-title svelte-1bmythy"> </div> <div class="doc-meta svelte-1bmythy"><span> </span> <span> </span></div> <div class="doc-preview svelte-1bmythy"> </div></button> <button class="delete-btn svelte-1bmythy">删除</button></div>'),ah=F('<div class="doc-list svelte-1bmythy"></div>'),oh=F('<div class="modal-backdrop svelte-1bmythy" role="button" tabindex="0" aria-label="关闭文档列表"><div class="modal-panel svelte-1bmythy" role="dialog" aria-modal="true" tabindex="-1"><div class="modal-header svelte-1bmythy"><h2 class="svelte-1bmythy">文档列表</h2> <button class="close-btn svelte-1bmythy">✕</button></div> <div class="modal-body svelte-1bmythy"><!></div></div></div>');function nd(e,n){if(new.target)return fi({component:nd,...e});Zr(n,!1);let i=jr(n,"visible",12,!1),r=jr(n,"onSelect",12,()=>{}),a=W([]),s=W(!1);async function m(){f(s,!0);try{const O=await fetch("/api/docs/list");if(!O.ok)throw new Error("加载失败");const E=await O.json();f(a,E.docs||[])}catch{gt("加载文档列表失败","error")}finally{f(s,!1)}}function h(O){try{return new Date(O).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})}catch{return O}}function y(O,E){return(O||"").length>E?O.slice(0,E)+"...":O}async function S(O){if(confirm("确定删除此文档？"))try{await fetch(`/api/doc/${O}/delete`,{method:"POST"}),gt("已删除","ok"),await m()}catch{gt("删除失败","error")}}qa(()=>{i()&&m()}),Hs(()=>ie(i()),()=>{i()&&m()}),io();var b={get visible(){return i()},set visible(O){i(O),cr()},get onSelect(){return r()},set onSelect(O){r(O),cr()},$set:vi,$on:(O,E)=>di(n,O,E)};Ds();var T=Vs(),N=hr(T);{var q=O=>{var E=oh(),P=p(E),vt=p(P),U=u(p(vt),2);d(vt);var lt=u(vt,2),Tt=p(lt);{var kt=et=>{var Et=rh();M(et,Et)},Mt=et=>{var Et=ih();M(et,Et)},Wt=et=>{var Et=ah();cn(Et,5,()=>t(a),Jn,($t,Jt)=>{var de=sh(),Be=p(de),ke=p(Be),un=p(ke,!0);d(ke);var Bt=u(ke,2),pt=p(Bt),jt=p(pt,!0);d(pt);var Dt=u(pt,2),Xt=p(Dt);d(Dt),d(Bt);var mn=u(Bt,2),fn=p(mn,!0);d(mn),d(Be);var De=u(Be,2);d(de),rt((bt,At)=>{D(un,(t(Jt),_(()=>t(Jt).title||"自动生成文档"))),D(jt,bt),D(Xt,`${t(Jt),_(()=>t(Jt).char_count||0)??""} 字`),D(fn,At)},[()=>(t(Jt),_(()=>h(t(Jt).updated_at))),()=>(t(Jt),_(()=>y(t(Jt).text,80)))]),C("click",Be,()=>r()(t(Jt).doc_id)),C("click",De,()=>S(t(Jt).doc_id)),M($t,de)}),d(Et),M(et,Et)};tt(Tt,et=>{t(s)?et(kt):(t(a),_(()=>t(a).length===0)?et(Mt,1):et(Wt,!1))})}d(lt),d(P),d(E),C("click",U,()=>i(!1)),C("click",P,ua(function(et){ps.call(this,n,et)})),C("keydown",P,ua(function(et){ps.call(this,n,et)})),C("click",E,()=>i(!1)),C("keydown",E,et=>{(et.key==="Enter"||et.key===" "||et.key==="Escape")&&(et.preventDefault(),i(!1))}),M(O,E)};tt(N,O=>{i()&&O(q)})}return M(e,T),ti(b)}var lh=F('<div class="skeleton-wrapper svelte-1bn1hqj"><div class="skeleton-header svelte-1bn1hqj"><div class="skeleton-line skeleton-title svelte-1bn1hqj"></div> <div class="skeleton-line skeleton-subtitle svelte-1bn1hqj"></div></div> <div class="skeleton-content svelte-1bn1hqj"><div class="skeleton-line svelte-1bn1hqj"></div> <div class="skeleton-line svelte-1bn1hqj"></div> <div class="skeleton-line short svelte-1bn1hqj"></div> <div class="skeleton-line svelte-1bn1hqj"></div> <div class="skeleton-line svelte-1bn1hqj"></div> <div class="skeleton-line short svelte-1bn1hqj"></div></div></div>');function rd(e,n){if(new.target)return fi({component:rd,...e});Zr(n,!1);var i={$set:vi,$on:(a,s)=>di(n,a,s)},r=lh();return M(e,r),ti(i)}var ch=F('<div class="progress-bar indeterminate svelte-1qjgclg"></div>'),uh=F('<div class="progress-bar svelte-1qjgclg"></div>'),fh=F('<div class="progress-container svelte-1qjgclg"><!></div>');function id(e,n){if(new.target)return fi({component:id,...e});Zr(n,!1);let i=jr(n,"progress",12,0),r=jr(n,"indeterminate",12,!1);var a={get progress(){return i()},set progress(S){i(S),cr()},get indeterminate(){return r()},set indeterminate(S){r(S),cr()},$set:vi,$on:(S,b)=>di(n,S,b)},s=fh(),m=p(s);{var h=S=>{var b=ch();M(S,b)},y=S=>{var b=uh();rt(T=>Ts(b,`width: ${T??""}%`),[()=>(ie(i()),_(()=>Math.min(100,Math.max(0,i()))))]),M(S,b)};tt(m,S=>{r()?S(h):S(y,!1)})}return d(s),M(e,s),ti(a)}var dh=F('<div class="error-boundary svelte-1k3aqik"><div class="error-icon svelte-1k3aqik">⚠️</div> <h2 class="svelte-1k3aqik">抱歉，出现了一些问题</h2> <p class="error-message svelte-1k3aqik"> </p> <div class="error-suggestion svelte-1k3aqik">建议： <ul class="svelte-1k3aqik"><li class="svelte-1k3aqik">刷新页面重试</li> <li class="svelte-1k3aqik">检查网络连接</li> <li class="svelte-1k3aqik">清除浏览器缓存</li> <li class="svelte-1k3aqik">如问题持续，请联系技术支持</li></ul></div> <button class="btn-retry svelte-1k3aqik">重新加载</button></div>');function sd(e,n){if(new.target)return fi({component:sd,...e});Zr(n,!1);let i=jr(n,"fallback",12,"出现错误，请刷新页面重试"),r=W(!1),a=W("");qa(()=>{const b=T=>{f(r,!0),f(a,T.error?.message||T.message||i()),console.error("捕获到错误:",T.error)};return window.addEventListener("error",b),()=>{window.removeEventListener("error",b)}});var s={get fallback(){return i()},set fallback(b){i(b),cr()},$set:vi,$on:(b,T)=>di(n,b,T)};Ds();var m=Vs(),h=hr(m);{var y=b=>{var T=dh(),N=u(p(T),4),q=p(N,!0);d(N);var O=u(N,4);d(T),rt(()=>D(q,t(a))),C("click",O,()=>window.location.reload()),M(b,T)},S=b=>{var T=Vs(),N=hr(T);Lf(N,n,"default",{}),M(b,T)};tt(h,b=>{t(r)?b(y):b(S,!1)})}return M(e,m),ti(s)}var vh=F('<div class="verify-debug-controls svelte-13e776w"><label for="verify-debug-level" class="svelte-13e776w">debug level</label> <select id="verify-debug-level" class="svelte-13e776w"><option>safe (masked)</option><option>strict (metrics only)</option><option>full (raw, rate limited)</option></select></div>'),ph=F('<div class="verify-summary svelte-13e776w"> </div>'),mh=F('<span class="verify-debug-observe svelte-13e776w"> </span>'),hh=F('<span class="verify-debug-flag svelte-13e776w">full -> safe (rate limited)</span>'),gh=F('<span class="verify-debug-trend svelte-13e776w"> </span>'),_h=F('<div class="verify-debug-history-item svelte-13e776w"><span class="history-time svelte-13e776w"> </span> <span> </span> <span> </span> <span class="history-meta svelte-13e776w"> </span> <span class="history-meta svelte-13e776w"> </span> <span class="history-meta svelte-13e776w"> </span> <span class="history-meta svelte-13e776w"> </span></div>'),bh=F('<div class="verify-debug-history svelte-13e776w"><div class="verify-debug-history-title svelte-13e776w"> </div> <div class="verify-debug-history-list svelte-13e776w"></div></div>'),yh=F('<div class="verify-debug-summary svelte-13e776w"><span> </span> <span class="verify-debug-metrics svelte-13e776w"> </span> <!> <span class="verify-debug-health svelte-13e776w"><span> </span> <span> </span></span> <!> <!> <button class="btn-debug-clear svelte-13e776w">清空历史</button> <button class="btn-debug-copy svelte-13e776w">复制诊断 JSON</button></div> <!>',1),wh=F('<p class="empty svelte-13e776w">加载中...</p>'),xh=F('<p class="empty svelte-13e776w">暂无引用</p>'),kh=F('<span class="source svelte-13e776w"> </span>'),Sh=F('<span class="hint svelte-13e776w"> </span>'),$h=F('<span class="hint svelte-13e776w"> </span>'),Th=F('<span class="hint svelte-13e776w"> </span>'),jh=F('<span class="hint svelte-13e776w"> </span>'),Eh=F('<div class="debug-line svelte-13e776w"> </div>'),Ah=F('<div class="debug-line svelte-13e776w"> </div>'),Ch=F('<div class="debug-line svelte-13e776w"> </div>'),Ih=F('<details class="verify-debug-item svelte-13e776w"><summary class="svelte-13e776w">debug details</summary> <div class="debug-line svelte-13e776w"> </div> <!> <!> <div class="debug-line svelte-13e776w"> </div> <!> <div class="debug-line svelte-13e776w"> </div></details>'),Nh=F('<div class="verify-info svelte-13e776w"><span> </span> <!> <!> <!> <!> <!></div>'),Mh=F('<div class="citation-item svelte-13e776w"><div class="citation-info svelte-13e776w"><strong class="svelte-13e776w"> </strong> <span class="svelte-13e776w"> </span> <!> <!></div> <div class="citation-actions svelte-13e776w"><button class="btn-copy svelte-13e776w">复制</button> <button class="btn-delete svelte-13e776w">删除</button></div></div>'),Bh=F('<div class="citation-list svelte-13e776w"></div>'),Dh=F('<div class="modal-backdrop svelte-13e776w" role="button" tabindex="0" aria-label="关闭引用管理"><div class="modal svelte-13e776w" role="dialog" aria-modal="true" tabindex="-1"><div class="modal-header svelte-13e776w"><h2 class="svelte-13e776w">引用管理</h2> <button class="close-btn svelte-13e776w">×</button></div> <div class="modal-body svelte-13e776w"><div class="add-section svelte-13e776w"><h3 class="svelte-13e776w">添加引用</h3> <div class="form-grid svelte-13e776w"><input type="text" placeholder="引用 ID（如 smith2023）" class="svelte-13e776w"/> <input type="text" placeholder="作者*" class="svelte-13e776w"/> <input type="text" placeholder="标题*" class="svelte-13e776w"/> <input type="text" placeholder="年份" class="svelte-13e776w"/> <input type="text" placeholder="来源（期刊/会议/URL）" class="full-width svelte-13e776w"/></div> <button class="btn-add svelte-13e776w">添加引用</button></div> <div class="verify-section svelte-13e776w"><h3 class="svelte-13e776w">核验真实性</h3> <div class="verify-row svelte-13e776w"><button class="btn-verify svelte-13e776w"><!></button> <!> <!> <!></div></div> <div class="export-section svelte-13e776w"><h3 class="svelte-13e776w">导出参考文献</h3> <div class="export-btns svelte-13e776w"><button class="btn-export svelte-13e776w">APA</button> <button class="btn-export svelte-13e776w">MLA</button> <button class="btn-export svelte-13e776w">GB/T 7714</button></div></div> <div class="list-section svelte-13e776w"><h3 class="svelte-13e776w"> </h3> <!></div></div></div></div>');function ad(e,n){if(new.target)return fi({component:ad,...e});Zr(n,!1);const i=()=>Zn(Ms,"$docId",r),[r,a]=Fa();let s=jr(n,"visible",12,!1);const m=!1,h=8,y=.55,S=.08;let b=W([]),T=W(!1),N=W(!1),q=W({}),O=W(null),E=W(null),P=W([]),vt=0,U=W("safe"),lt=W(""),Tt=null,kt=W({id:"",author:"",title:"",year:"",source:""});function Mt(K){return Array.isArray(K)?K.filter(ft=>ft&&typeof ft=="object").map(ft=>{const Ht=ft;return{id:String(Ht.id||"").trim(),author:String(Ht.author||"").trim(),title:String(Ht.title||"").trim(),year:String(Ht.year||"").trim(),source:String(Ht.source||"").trim()}}).filter(ft=>ft.id&&ft.title):[]}function Wt(K){const ft=String(K||"").trim().toLowerCase();return ft==="full"?"full":ft==="strict"?"strict":"safe"}function et(K){const ft=Number(K);return Number.isFinite(ft)?Math.max(0,Math.round(ft)):0}function Et(K){const ft=Number(K);return Number.isFinite(ft)?Math.max(0,ft):0}function $t(K){return et(K.hit)+et(K.miss)}function Jt(K){const ft=$t(K);return ft<=0?0:et(K.hit)/ft}function de(K){const ft=et(K.set);return ft<=0?0:et(K.evicted)/ft}function Be(K){return`${(Math.max(0,Math.min(1,Number(K)||0))*100).toFixed(1)}%`}function ke(){return new Date().toLocaleTimeString("zh-CN",{hour12:!1})}function un(K){const ft={id:`${Date.now()}-${vt++}`,at_label:ke(),level:K.level,workers:et(K.request.workers),elapsed_ms:Number(K.elapsed_ms||0),cache_size:et(K.cache.size),cache_max:et(K.cache.max_entries),hit_rate:Jt(K.cache),evict_rate:de(K.cache),sampled_output:et(K.sampling.output_items),sampled_input:et(K.sampling.input_items)};f(P,[...t(P),ft].slice(-h))}function Bt(K){return K.length?K.reduce((ft,Ht)=>ft+(Number.isFinite(Ht)?Ht:0),0)/K.length:0}function pt(K=5){const ft=Math.max(1,et(K));return t(P).slice(-ft)}function jt(K=5){return Bt(pt(K).map(ft=>Number(ft.hit_rate||0)))}function Dt(K=5){return Bt(pt(K).map(ft=>Number(ft.evict_rate||0)))}function Xt(K=5){return Bt(pt(K).map(ft=>Number(ft.elapsed_ms||0)))}function mn(){t(P).length&&(f(P,[]),gt("已清空调试历史","ok"))}async function fn(){const K=i();if(K){f(T,!0);try{const ft=await fetch(`/api/doc/${K}/citations`);if(!ft.ok)throw new Error(await ft.text());const Ht=await ft.json();f(b,Mt(Ht?.items)),f(q,{}),f(O,null),f(E,null),f(P,[])}catch(ft){console.error("Failed to load citations",ft),gt("加载引用失败","bad")}finally{f(T,!1)}}}async function De(){const K=i();if(!K)return;const ft=await fetch(`/api/doc/${K}/citations`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({items:t(b)})});if(!ft.ok)throw new Error(await ft.text())}function bt(){Tt&&clearTimeout(Tt),Tt=setTimeout(()=>{De().catch(K=>{console.error("Failed to save citations",K),gt("保存引用失败","bad")})},300)}function At(){if(!t(kt).id||!t(kt).author||!t(kt).title){gt("请填写必填项：ID、作者、标题","bad");return}if(t(b).some(K=>K.id===t(kt).id)){gt("引用 ID 已存在","bad");return}f(b,[...t(b),{...t(kt)}]),bt(),f(kt,{id:"",author:"",title:"",year:"",source:""}),gt("已添加引用","ok")}function ne(K){f(b,t(b).filter(Ht=>Ht.id!==K));const ft={...t(q)};if(delete ft[K],f(q,ft),t(E)&&t(E).items[K]){const Ht={...t(E).items};delete Ht[K],f(E,{...t(E),items:Ht})}bt(),gt("已删除引用","ok")}async function Oe(K){try{await navigator.clipboard.writeText(`[@${K}]`),gt("已复制引用标记","ok")}catch{gt("复制失败，请手动复制","bad")}}function _e(K,ft){return ft==="apa"?`${K.author} (${K.year}). ${K.title}. ${K.source}.`:ft==="mla"?`${K.author}. "${K.title}." ${K.source}, ${K.year}.`:`${K.author}. ${K.title}[J]. ${K.source}, ${K.year}.`}function Br(K){const ft=t(b).map(Rn=>_e(Rn,K)),Ht=new Blob([ft.join(`

`)],{type:"text/plain"}),pn=URL.createObjectURL(Ht),Ar=document.createElement("a");Ar.href=pn,Ar.download=`references_${K}.txt`,Ar.click(),URL.revokeObjectURL(pn),gt(`已导出 ${K.toUpperCase()} 参考文献`,"ok")}function Er(){if(!t(E))return null;const K=t(b).map(Ht=>({id:Ht.id,verify:t(q)[Ht.id]||null,debug:t(E)?.items?.[Ht.id]||null})),ft=t(P).slice().reverse();return{generated_at:new Date().toISOString(),doc_id:i(),debug_level_selected:t(U),summary:t(O)||null,debug:t(E),debug_history_limit:h,debug_history:ft,debug_history_stats:{sample_size:pt(5).length,avg_hit_rate:jt(5),avg_evict_rate:Dt(5),avg_elapsed_ms:Xt(5)},rows:K}}async function Dr(){if(!m||!t(E))return;const K=Er();if(K)try{await navigator.clipboard.writeText(JSON.stringify(K,null,2)),gt("已复制核验诊断 JSON","ok")}catch{gt("复制诊断 JSON 失败","bad")}}function pi(K){return K==="verified"?"ok":K==="possible"?"warn":K==="error"?"err":"miss"}function Zt(K){return K==="verified"?"已核验":K==="possible"?"疑似匹配":K==="error"?"核验失败":"未命中"}async function ue(){const K=i();if(K){if(!t(b).length){gt("暂无可核验的引用","info");return}f(N,!0);try{const ft={items:t(b),persist:!0,debug:m};m&&(ft.debug_level=t(U));const Ht=await fetch(`/api/doc/${K}/citations/verify`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(ft)});if(!Ht.ok)throw new Error(await Ht.text());const pn=await Ht.json(),Ar=Array.isArray(pn?.items)?pn.items:[],Rn={};for(const Le of Ar){if(!Le||typeof Le!="object")continue;const an=Le,jn=String(an.id||"").trim();jn&&(Rn[jn]={id:jn,status:String(an.status||"not_found")||"not_found",provider:String(an.provider||"").trim(),score:Number(an.score||0),matched_title:String(an.matched_title||"").trim(),matched_year:String(an.matched_year||"").trim(),matched_source:String(an.matched_source||"").trim(),reason:String(an.reason||"").trim()})}f(q,Rn);const qn=pn?.summary||{};if(f(O,{total:Number(qn.total||0),verified:Number(qn.verified||0),possible:Number(qn.possible||0),not_found:Number(qn.not_found||0),error:Number(qn.error||0)}),m&&pn&&typeof pn=="object"&&pn.debug&&typeof pn.debug=="object"){const Le=pn.debug,an=Le.request,jn=an&&typeof an=="object"?an:{},tn=Wt(Le.requested_level),ur=Wt(Le.level),Lr=Le.cache,en=Lr&&typeof Lr=="object"?Lr:{},Cr={size:et(en.size),ttl_s:Number(en.ttl_s||0),max_entries:et(en.max_entries),hit:et(en.hit),miss:et(en.miss),set:et(en.set),expired:et(en.expired),evicted:et(en.evicted)},Kt=Le.sampling,yn=Kt&&typeof Kt=="object"?Kt:{},sr=Le.sanitized,Fn=Le.observe,wn=Fn&&typeof Fn=="object"?Fn:null;let Rr=null;if(wn){const Ge=wn.request,te=Ge&&typeof Ge=="object"?Ge:{},Se=wn.window,me=Se&&typeof Se=="object"?Se:{},En=me.elapsed_ms,he=En&&typeof En=="object"?En:{},be=me.items,pe=be&&typeof be=="object"?be:{},je=me.workers,Ee=je&&typeof je=="object"?je:{},Re=me.errors,Pe=Re&&typeof Re=="object"?Re:{},er=me.cache_delta,wt=er&&typeof er=="object"?er:{},re=te.cache_delta,$e=re&&typeof re=="object"?re:{};Rr={request:{elapsed_ms:Et(te.elapsed_ms),item_count:et(te.item_count),worker_count:et(te.worker_count),error_count:et(te.error_count),cache_delta:{hit:et($e.hit),miss:et($e.miss),set:et($e.set),expired:et($e.expired),evicted:et($e.evicted),hit_rate:Et($e.hit_rate)}},window:{window_s:Et(me.window_s),max_runs:et(me.max_runs),runs:et(me.runs),elapsed_ms:{avg:Et(he.avg),p50:Et(he.p50),p95:Et(he.p95),max:Et(he.max)},items:{total:et(pe.total),avg:Et(pe.avg),p50:Et(pe.p50),p95:Et(pe.p95),max:Et(pe.max)},workers:{avg:Et(Ee.avg),max:Et(Ee.max)},errors:{total:et(Pe.total),rate_per_run:Et(Pe.rate_per_run)},cache_delta:{hit:et(wt.hit),miss:et(wt.miss),set:et(wt.set),expired:et(wt.expired),evicted:et(wt.evicted),hit_rate:Et(wt.hit_rate)}}}}const se={},ve=Array.isArray(Le.items)?Le.items:[];for(const Ge of ve){if(!Ge||typeof Ge!="object")continue;const te=Ge,Se=String(te.id||"").trim();if(!Se)continue;const me=te.providers,En=me&&typeof me=="object"?me:{},he={};for(const[be,pe]of Object.entries(En))he[String(be)]=Number(pe||0);se[Se]={id:Se,cache_hit:!!te.cache_hit,query:String(te.query||"").trim(),providers:he,errors:Array.isArray(te.errors)?te.errors.map(be=>String(be||"").trim()).filter(Boolean):[],picked_provider:String(te.picked_provider||"").trim(),picked_title_score:Number(te.picked_title_score||0),picked_year_score:Number(te.picked_year_score||0),picked_total_score:Number(te.picked_total_score||0),elapsed_ms:Number(te.elapsed_ms||0)}}const nn={request:{persist:!!jn.persist,debug:!!jn.debug,input_count:et(jn.input_count),workers:et(jn.workers)},requested_level:tn,level:ur,sanitized:typeof sr=="boolean"?sr:ur!=="full",rate_limited_full:!!Le.rate_limited_full,cache:Cr,observe:Rr,sampling:{input_items:Number(yn.input_items||ve.length),output_items:Number(yn.output_items||ve.length),limit:Number(yn.limit||0),truncated:!!yn.truncated},elapsed_ms:Number(Le.elapsed_ms||0),items:se};f(E,nn),un(nn),tn==="full"&&ur!=="full"&&gt("debug full 已被限流降级为 safe","info")}else f(E,null);const Tn=Mt(pn?.updated_items);Tn.length&&f(b,Tn),gt("引用核验完成","ok")}catch(ft){console.error("Failed to verify citations",ft),gt("引用核验失败","bad")}finally{f(N,!1)}}}qa(()=>{s()&&fn()}),Hs(()=>(ie(s()),i(),t(lt)),()=>{if(s()){const K=i();K&&K!==t(lt)&&(f(lt,K),fn())}}),io();var dn={get visible(){return s()},set visible(K){s(K),cr()},$set:vi,$on:(K,ft)=>di(n,K,ft)};Ds();var fe=Vs(),ei=hr(fe);{var vn=K=>{var ft=Dh(),Ht=p(ft),pn=p(Ht),Ar=u(p(pn),2);d(pn);var Rn=u(pn,2),qn=p(Rn),Tn=u(p(qn),2),Le=p(Tn);tr(Le);var an=u(Le,2);tr(an);var jn=u(an,2);tr(jn);var tn=u(jn,2);tr(tn);var ur=u(tn,2);tr(ur),d(Tn);var Lr=u(Tn,2);d(qn);var en=u(qn,2),Cr=u(p(en),2),Kt=p(Cr),yn=p(Kt);{var sr=wt=>{var re=Xi("核验中...");M(wt,re)},Fn=wt=>{var re=Xi("核验引用");M(wt,re)};tt(yn,wt=>{t(N)?wt(sr):wt(Fn,!1)})}d(Kt);var wn=u(Kt,2);{var Rr=wt=>{var re=vh(),$e=u(p(re),2),Qt=p($e);Qt.value=Qt.__value="safe";var Lt=u(Qt);Lt.value=Lt.__value="strict";var ee=u(Lt);ee.value=ee.__value="full",d($e),d(re),rt(()=>$e.disabled=t(N)),$s($e,()=>t(U),hn=>f(U,hn)),M(wt,re)};tt(wn,wt=>{m&&wt(Rr)})}var se=u(wn,2);{var ve=wt=>{var re=ph(),$e=p(re);d(re),rt(()=>D($e,`总计 ${t(O),_(()=>t(O).total)??""} · 已核验 ${t(O),_(()=>t(O).verified)??""} · 疑似 ${t(O),_(()=>t(O).possible)??""} · 未命中 ${t(O),_(()=>t(O).not_found)??""} · 异常 ${t(O),_(()=>t(O).error)??""}`)),M(wt,re)};tt(se,wt=>{t(O)&&wt(ve)})}var nn=u(se,2);{var Ge=wt=>{var re=yh(),$e=hr(re),Qt=p($e),Lt=p(Qt);d(Qt);var ee=u(Qt,2),hn=p(ee);d(ee);var An=u(ee,2);{var Rt=Ve=>{var Ut=mh(),nr=p(Ut);d(Ut),rt((fr,Kn,Nn,Ct,ri)=>D(nr,`window ${t(E),_(()=>t(E).observe.window.runs)??""}/${t(E),_(()=>t(E).observe.window.max_runs||"-")??""} · p50/p95 ${fr??""}/${Kn??""}ms · avg items ${Nn??""} · avg workers ${Ct??""} · hitΔ ${ri??""}`),[()=>(t(E),_(()=>t(E).observe.window.elapsed_ms.p50.toFixed(1))),()=>(t(E),_(()=>t(E).observe.window.elapsed_ms.p95.toFixed(1))),()=>(t(E),_(()=>t(E).observe.window.items.avg.toFixed(1))),()=>(t(E),_(()=>t(E).observe.window.workers.avg.toFixed(1))),()=>(t(E),_(()=>Be(t(E).observe.window.cache_delta.hit_rate)))]),M(Ve,Ut)};tt(An,Ve=>{t(E),_(()=>t(E).observe)&&Ve(Rt)})}var gn=u(An,2),Cn=p(gn),ni=p(Cn);d(Cn);var Ei=u(Cn,2),Ai=p(Ei);d(Ei),d(gn);var qr=u(gn,2);{var is=Ve=>{var Ut=hh();M(Ve,Ut)};tt(qr,Ve=>{t(E),_(()=>t(E).rate_limited_full)&&Ve(is)})}var mi=u(qr,2);{var In=Ve=>{var Ut=gh(),nr=p(Ut);d(Ut),rt((fr,Kn,Nn)=>D(nr,`avg(5) hit ${fr??""} · evict ${Kn??""} · elapsed ${Nn??""}ms`),[()=>_(()=>Be(jt(5))),()=>_(()=>Be(Dt(5))),()=>_(()=>Xt(5).toFixed(1))]),M(Ve,Ut)};tt(mi,Ve=>{t(P),_(()=>t(P).length>0)&&Ve(In)})}var Kr=u(mi,2),_r=u(Kr,2);d($e);var br=u($e,2);{var On=Ve=>{var Ut=bh(),nr=p(Ut),fr=p(nr);d(nr);var Kn=u(nr,2);cn(Kn,5,()=>(t(P),_(()=>t(P).slice().reverse())),Nn=>Nn.id,(Nn,Ct)=>{var ri=_h(),rn=p(ri),hi=p(rn,!0);d(rn);var gi=u(rn,2),ss=p(gi);d(gi);var He=u(gi,2),ae=p(He);d(He);var Gn=u(He,2),Di=p(Gn);d(Gn);var Gr=u(Gn,2),_s=p(Gr);d(Gr);var _i=u(Gr,2),Ir=p(_i);d(_i);var Pn=u(_i,2),Ci=p(Pn);d(Pn),d(ri),rt((Ki,ii,Ii)=>{D(hi,(t(Ct),_(()=>t(Ct).at_label))),Ne(gi,1,(t(Ct),_(()=>"history-chip "+(t(Ct).hit_rate<y?"warn":"ok"))),"svelte-13e776w"),D(ss,`hit ${Ki??""}`),Ne(He,1,(t(Ct),_(()=>"history-chip "+(t(Ct).evict_rate>S?"warn":"ok"))),"svelte-13e776w"),D(ae,`evict ${ii??""}`),D(Di,`w${t(Ct),_(()=>t(Ct).workers)??""}`),D(_s,`cache ${t(Ct),_(()=>t(Ct).cache_size)??""}/${t(Ct),_(()=>t(Ct).cache_max||"-")??""}`),D(Ir,`sample ${t(Ct),_(()=>t(Ct).sampled_output)??""}/${t(Ct),_(()=>t(Ct).sampled_input)??""}`),D(Ci,`${Ii??""}ms`)},[()=>(t(Ct),_(()=>Be(t(Ct).hit_rate))),()=>(t(Ct),_(()=>Be(t(Ct).evict_rate))),()=>(t(Ct),_(()=>t(Ct).elapsed_ms.toFixed(1)))]),M(Nn,ri)}),d(Kn),d(Ut),rt(()=>D(fr,`recent verify runs (${t(P),_(()=>t(P).length)??""}/8)`)),M(Ve,Ut)};tt(br,Ve=>{t(P),_(()=>t(P).length>0)&&Ve(On)})}rt((Ve,Ut,nr,fr,Kn,Nn,Ct,ri,rn)=>{D(Lt,`Debug · req ${t(E),_(()=>t(E).requested_level)??""} · active ${t(E),_(()=>t(E).level)??""} · workers ${t(E),_(()=>t(E).request.workers)??""} · sampled ${t(E),_(()=>t(E).sampling.output_items)??""}/${t(E),_(()=>t(E).sampling.input_items)??""} · elapsed ${Ve??""}ms`),D(hn,`cache ${t(E),_(()=>t(E).cache.size)??""}/${t(E),_(()=>t(E).cache.max_entries||"-")??""} · ttl ${Ut??""}s · hit ${t(E),_(()=>t(E).cache.hit)??""}/${nr??""} (${fr??""}) · evict ${t(E),_(()=>t(E).cache.evicted)??""}/${t(E),_(()=>t(E).cache.set)??""} (${Kn??""}) · expired ${t(E),_(()=>t(E).cache.expired)??""}`),Ne(Cn,1,Nn,"svelte-13e776w"),D(ni,`hit ${Ct??""}`),Ne(Ei,1,ri,"svelte-13e776w"),D(Ai,`evict ${rn??""}`),Kr.disabled=(t(P),_(()=>t(P).length===0))},[()=>(t(E),_(()=>t(E).elapsed_ms.toFixed(1))),()=>(t(E),_(()=>t(E).cache.ttl_s.toFixed(0))),()=>(t(E),_(()=>$t(t(E).cache))),()=>(t(E),_(()=>Be(Jt(t(E).cache)))),()=>(t(E),_(()=>Be(de(t(E).cache)))),()=>(t(E),_(()=>"verify-debug-chip "+(Jt(t(E).cache)<y?"warn":"ok"))),()=>(t(E),_(()=>Be(Jt(t(E).cache)))),()=>(t(E),_(()=>"verify-debug-chip "+(de(t(E).cache)>S?"warn":"ok"))),()=>(t(E),_(()=>Be(de(t(E).cache))))]),C("click",Kr,mn),C("click",_r,Dr),M(wt,re)};tt(nn,wt=>{m&&t(E)&&wt(Ge)})}d(Cr),d(en);var te=u(en,2),Se=u(p(te),2),me=p(Se),En=u(me,2),he=u(En,2);d(Se),d(te);var be=u(te,2),pe=p(be),je=p(pe);d(pe);var Ee=u(pe,2);{var Re=wt=>{var re=wh();M(wt,re)},Pe=wt=>{var re=xh();M(wt,re)},er=wt=>{var re=Bh();cn(re,5,()=>t(b),Jn,($e,Qt)=>{const Lt=Ia(()=>(t(q),t(Qt),_(()=>t(q)[t(Qt).id]))),ee=Ia(()=>(t(E),t(Qt),_(()=>t(E)?.items?.[t(Qt).id])));var hn=Mh(),An=p(hn),Rt=p(An),gn=p(Rt);d(Rt);var Cn=u(Rt,2),ni=p(Cn);d(Cn);var Ei=u(Cn,2);{var Ai=_r=>{var br=kh(),On=p(br,!0);d(br),rt(()=>D(On,(t(Qt),_(()=>t(Qt).source)))),M(_r,br)};tt(Ei,_r=>{t(Qt),_(()=>t(Qt).source)&&_r(Ai)})}var qr=u(Ei,2);{var is=_r=>{var br=Nh(),On=p(br),Ve=p(On,!0);d(On);var Ut=u(On,2);{var nr=He=>{var ae=Sh(),Gn=p(ae);d(ae),rt(()=>D(Gn,`来源：${ie(t(Lt)),_(()=>t(Lt).provider)??""}`)),M(He,ae)};tt(Ut,He=>{ie(t(Lt)),_(()=>t(Lt).provider)&&He(nr)})}var fr=u(Ut,2);{var Kn=He=>{var ae=$h(),Gn=p(ae);d(ae),rt(Di=>D(Gn,`相似度：${Di??""}`),[()=>(ie(t(Lt)),_(()=>Number(t(Lt).score||0).toFixed(2)))]),M(He,ae)},Nn=Sa(()=>(ie(t(Lt)),_(()=>Number(t(Lt).score||0)>0)));tt(fr,He=>{t(Nn)&&He(Kn)})}var Ct=u(fr,2);{var ri=He=>{var ae=Th(),Gn=p(ae);d(ae),rt(()=>D(Gn,`匹配标题：${ie(t(Lt)),_(()=>t(Lt).matched_title)??""}`)),M(He,ae)};tt(Ct,He=>{ie(t(Lt)),_(()=>t(Lt).matched_title)&&He(ri)})}var rn=u(Ct,2);{var hi=He=>{var ae=jh(),Gn=p(ae);d(ae),rt(()=>D(Gn,`匹配年份：${ie(t(Lt)),_(()=>t(Lt).matched_year)??""}`)),M(He,ae)};tt(rn,He=>{ie(t(Lt)),_(()=>t(Lt).matched_year)&&He(hi)})}var gi=u(rn,2);{var ss=He=>{var ae=Ih(),Gn=u(p(ae),2),Di=p(Gn);d(Gn);var Gr=u(Gn,2);{var _s=yr=>{var Hn=Eh(),wr=p(Hn);d(Hn),rt(()=>D(wr,`query: ${ie(t(ee)),_(()=>t(ee).query)??""}`)),M(yr,Hn)};tt(Gr,yr=>{ie(t(ee)),_(()=>t(ee).query)&&yr(_s)})}var _i=u(Gr,2);{var Ir=yr=>{var Hn=Ah(),wr=p(Hn);d(Hn),rt((Fr,bi,as)=>D(wr,`picked: ${ie(t(ee)),_(()=>t(ee).picked_provider)??""} (total ${Fr??""}, title ${bi??""}, year ${as??""})`),[()=>(ie(t(ee)),_(()=>t(ee).picked_total_score.toFixed(3))),()=>(ie(t(ee)),_(()=>t(ee).picked_title_score.toFixed(3))),()=>(ie(t(ee)),_(()=>t(ee).picked_year_score.toFixed(3)))]),M(yr,Hn)};tt(_i,yr=>{ie(t(ee)),_(()=>t(ee).picked_provider)&&yr(Ir)})}var Pn=u(_i,2),Ci=p(Pn);d(Pn);var Ki=u(Pn,2);{var ii=yr=>{var Hn=Ch(),wr=p(Hn);d(Hn),rt(Fr=>D(wr,`errors: ${Fr??""}`),[()=>(ie(t(ee)),_(()=>t(ee).errors.join(" | ")))]),M(yr,Hn)};tt(Ki,yr=>{ie(t(ee)),_(()=>t(ee).errors.length>0)&&yr(ii)})}var Ii=u(Ki,2),Gt=p(Ii);d(Ii),d(ae),rt((yr,Hn)=>{D(Di,`cache_hit: ${ie(t(ee)),_(()=>t(ee).cache_hit?"true":"false")??""}`),D(Ci,`providers: ${yr??""}`),D(Gt,`elapsed: ${Hn??""}ms`)},[()=>(ie(t(ee)),_(()=>JSON.stringify(t(ee).providers))),()=>(ie(t(ee)),_(()=>t(ee).elapsed_ms.toFixed(2)))]),M(He,ae)};tt(gi,He=>{m&&t(ee)&&He(ss)})}d(br),rt((He,ae)=>{Ne(On,1,He,"svelte-13e776w"),D(Ve,ae)},[()=>(ie(t(Lt)),_(()=>"status "+pi(t(Lt).status))),()=>(ie(t(Lt)),_(()=>Zt(t(Lt).status)))]),M(_r,br)};tt(qr,_r=>{t(Lt)&&_r(is)})}d(An);var mi=u(An,2),In=p(mi),Kr=u(In,2);d(mi),d(hn),rt(()=>{D(gn,`[@${t(Qt),_(()=>t(Qt).id)??""}]`),D(ni,`${t(Qt),_(()=>t(Qt).author)??""} (${t(Qt),_(()=>t(Qt).year)??""}). ${t(Qt),_(()=>t(Qt).title)??""}`)}),C("click",In,()=>Oe(t(Qt).id)),C("click",Kr,()=>ne(t(Qt).id)),M($e,hn)}),d(re),M(wt,re)};tt(Ee,wt=>{t(T)?wt(Re):(t(b),_(()=>t(b).length===0)?wt(Pe,1):wt(er,!1))})}d(be),d(Rn),d(Ht),d(ft),rt(()=>{Kt.disabled=(t(N),t(T),t(b),_(()=>t(N)||t(T)||t(b).length===0)),D(je,`已有引用 (${t(b),_(()=>t(b).length)??""})`)}),C("click",Ar,()=>s(!1)),sn(Le,()=>t(kt).id,wt=>Wr(kt,t(kt).id=wt)),sn(an,()=>t(kt).author,wt=>Wr(kt,t(kt).author=wt)),sn(jn,()=>t(kt).title,wt=>Wr(kt,t(kt).title=wt)),sn(tn,()=>t(kt).year,wt=>Wr(kt,t(kt).year=wt)),sn(ur,()=>t(kt).source,wt=>Wr(kt,t(kt).source=wt)),C("click",Lr,At),C("click",Kt,ue),C("click",me,()=>Br("apa")),C("click",En,()=>Br("mla")),C("click",he,()=>Br("gb")),C("click",Ht,ua(function(wt){ps.call(this,n,wt)})),C("keydown",Ht,ua(function(wt){ps.call(this,n,wt)})),C("click",ft,()=>s(!1)),C("keydown",ft,wt=>{(wt.key==="Enter"||wt.key===" "||wt.key==="Escape")&&(wt.preventDefault(),s(!1))}),M(K,ft)};tt(ei,K=>{s()&&K(vn)})}M(e,fe);var Ji=ti(dn);return a(),Ji}const Ll=5e3;function Te(e){const n=Number(e);return Number.isFinite(n)?Math.max(0,Math.round(n)):0}function Dn(e){const n=Number(e);return Number.isFinite(n)?Math.max(0,n):0}function Ta(e){return Math.max(0,Math.min(1,Dn(e)))}function Yr(e){return`${(Math.max(0,Math.min(1,e))*100).toFixed(1)}%`}function Ru(e){const n=Te(e.hit)+Te(e.miss);return n<=0?0:Te(e.hit)/n}function Os(e){const n=Number(e||0);if(!Number.isFinite(n)||n<=0)return"--:--:--";const i=n>1e10?n:n*1e3;return new Date(i).toLocaleTimeString("zh-CN",{hour12:!1})}function Io(e){const n=Number(e||0);return Number.isFinite(n)?Math.abs(n)<1?n.toFixed(3):Math.abs(n)<100?n.toFixed(2):n.toFixed(1):"0"}function No(e){return{enabled:!!e.enabled,min_runs:Math.max(1,Math.min(500,Te(e.min_runs)||8)),p95_ms:Math.max(100,Math.min(6e4,Te(e.p95_ms)||4500)),error_rate_per_run:Math.max(0,Math.min(1,Dn(e.error_rate_per_run)||0)),cache_delta_hit_rate:Math.max(0,Math.min(1,Dn(e.cache_delta_hit_rate)||0))}}function qu(e){const n=e&&typeof e=="object"?e:{};return{hit:Te(n.hit),miss:Te(n.miss),set:Te(n.set),expired:Te(n.expired),evicted:Te(n.evicted),hit_rate:Ta(n.hit_rate)}}function Lh(e){return Array.isArray(e)?e.map(n=>String(n||"").trim()).filter(n=>n.length>0).slice(0,12):[]}function Rh(e){return String(e||"").trim().toLowerCase()==="critical"?"critical":"warn"}function rc(e){const n=String(e||"").trim().toLowerCase();return n==="critical"?"critical":n==="warn"?"warn":"ok"}function od(e){const n=e&&typeof e=="object"?e:{};return{id:String(n.id||"").trim(),ts:Dn(n.ts),severity:rc(n.severity),degraded:!!n.degraded,runs:Te(n.runs),p95_ms:Dn(n.p95_ms),error_rate_per_run:Ta(n.error_rate_per_run),cache_delta_hit_rate:Ta(n.cache_delta_hit_rate),triggered_alerts:Te(n.triggered_alerts),notification_status:String(n.notification_status||"").trim()}}function qh(e,n){const i=e&&typeof e=="object"?e:{},r=i.trend_context&&typeof i.trend_context=="object"?i.trend_context:{},a=Array.isArray(r.points)?r.points:[];return{event_id:n,total:Te(r.total),before:Te(r.before),after:Te(r.after),points:a.map(s=>od(s)).filter(s=>s.id.length>0)}}function Fh(e){const n=e&&typeof e=="object"?e:{},i=n.cache&&typeof n.cache=="object"?n.cache:{},r=n.observe&&typeof n.observe=="object"?n.observe:{},a=r.elapsed_ms&&typeof r.elapsed_ms=="object"?r.elapsed_ms:{},s=r.items&&typeof r.items=="object"?r.items:{},m=r.workers&&typeof r.workers=="object"?r.workers:{},h=r.errors&&typeof r.errors=="object"?r.errors:{},y=Array.isArray(r.recent)?r.recent:[],S=!!n.degraded,b=Lh(n.errors),T=n.alerts&&typeof n.alerts=="object"?n.alerts:{},N=Array.isArray(T.rules)?T.rules:[],q=Array.isArray(T.triggered_rules)?T.triggered_rules:[],O=T.thresholds&&typeof T.thresholds=="object"?T.thresholds:{},E=T.notification&&typeof T.notification=="object"?T.notification:{},P=n.trend&&typeof n.trend=="object"?n.trend:{},vt=Array.isArray(P.points)?P.points:[];return{cache:{size:Te(i.size),ttl_s:Dn(i.ttl_s),max_entries:Te(i.max_entries),hit:Te(i.hit),miss:Te(i.miss),set:Te(i.set),expired:Te(i.expired),evicted:Te(i.evicted)},observe:{window_s:Dn(r.window_s),max_runs:Te(r.max_runs),runs:Te(r.runs),elapsed_ms:{avg:Dn(a.avg),p50:Dn(a.p50),p95:Dn(a.p95),max:Dn(a.max)},items:{total:Te(s.total),avg:Dn(s.avg),p50:Dn(s.p50),p95:Dn(s.p95),max:Dn(s.max)},workers:{avg:Dn(m.avg),max:Dn(m.max)},errors:{total:Te(h.total),rate_per_run:Ta(h.rate_per_run)},cache_delta:qu(r.cache_delta),recent:y.filter(U=>U&&typeof U=="object").map(U=>{const lt=U;return{ts:Dn(lt.ts),elapsed_ms:Dn(lt.elapsed_ms),item_count:Te(lt.item_count),worker_count:Te(lt.worker_count),error_count:Te(lt.error_count),cache_delta:qu(lt.cache_delta)}})},degraded:S,errors:b,alerts:{enabled:!!T.enabled,severity:rc(T.severity),triggered:Te(T.triggered),runs:Te(T.runs),min_runs:Te(T.min_runs),warmup:!!T.warmup,thresholds:{p95_ms:Math.max(100,Math.min(6e4,Dn(O.p95_ms)||4500)),error_rate_per_run:Math.max(0,Math.min(1,Ta(O.error_rate_per_run))),cache_delta_hit_rate:Math.max(0,Math.min(1,Ta(O.cache_delta_hit_rate)))},rules:N.filter(U=>U&&typeof U=="object").map(U=>{const lt=U;return{id:String(lt.id||"").trim(),level:Rh(lt.level),triggered:!!lt.triggered,value:Dn(lt.value),threshold:Dn(lt.threshold),op:String(lt.op||"").trim(),message:String(lt.message||"").trim()}}).filter(U=>U.id.length>0),triggered_rules:q.map(U=>String(U||"").trim()).filter(U=>U.length>0),notification:{enabled:!!E.enabled,webhook_configured:!!E.webhook_configured,sent:!!E.sent,channels:Array.isArray(E.channels)?E.channels.map(U=>String(U||"").trim()).filter(U=>U.length>0):[],signature:String(E.signature||"").trim(),dedupe_hit:!!E.dedupe_hit,event_type:String(E.event_type||"").trim()||"none",status:String(E.status||"").trim()||"unknown",cooldown_s:Dn(E.cooldown_s),last_sent_at:Dn(E.last_sent_at),suppressed:Te(E.suppressed),last_error:String(E.last_error||"").trim(),event_id:String(E.event_id||"").trim(),events_total:Te(E.events_total),events_recent:Array.isArray(E.events_recent)?E.events_recent.filter(U=>U&&typeof U=="object").map(U=>{const lt=U;return{id:String(lt.id||"").trim(),ts:Dn(lt.ts),severity:rc(lt.severity),event_type:String(lt.event_type||"").trim()||"none",status:String(lt.status||"").trim()||"unknown",sent:!!lt.sent,dedupe_hit:!!lt.dedupe_hit,triggered_rules:Array.isArray(lt.triggered_rules)?lt.triggered_rules.map(Tt=>String(Tt||"").trim()).filter(Tt=>Tt.length>0):[],channels:Array.isArray(lt.channels)?lt.channels.map(Tt=>String(Tt||"").trim()).filter(Tt=>Tt.length>0):[]}}).filter(U=>U.id.length>0):[]}},trend:{enabled:!!P.enabled,total:Te(P.total),limit:Te(P.limit),points:vt.filter(U=>U&&typeof U=="object").map(U=>od(U)).filter(U=>U.id.length>0)}}}var Oh=F('<div class="perf-empty">鍔犺浇涓?..</div>'),Ph=F('<div class="perf-error"> </div>'),Hh=F("<span>鎸囨爣鎺ュ彛宸查檷绾ц繑鍥烇紝褰撳墠鏁版嵁鏉ヨ嚜鍏滃簳蹇収銆�</span>"),zh=F("<span>鎸囨爣鎺ュ彛姝ｅ父銆�</span>"),Wh=F('<span class="error-item"> </span>'),Uh=F('<div class="perf-degraded-errors"><div class="title">Degraded Causes</div> <div class="error-list"></div></div>'),Jh=F("<span> </span>"),Kh=F("<span>alerts disabled</span>"),Gh=F('<span class="alerts-warmup">warmup: alerts suppressed until enough runs</span>'),Vh=F("<span> </span>"),Xh=F("<span>dedupe-hit</span>"),Yh=F("<span> </span>"),Qh=F('<span class="notify-signature"> </span>'),Zh=F('<span class="notify-error"> </span>'),tg=F("<span>dedupe</span>"),eg=F("<span> </span>"),ng=F("<span> </span>"),rg=F('<button class="event-link"><!></button>'),ig=F('<div><span class="event-time"> </span> <span class="event-type"> </span> <span class="event-status"> </span> <span> </span> <!> <!> <!> <!></div>'),sg=F('<div class="perf-alert-events"><div class="title"> </div> <div class="alert-event-list"></div></div>'),ag=F('<div class="perf-error"> </div>'),og=F("<span>degraded</span>"),lg=F('<div><span class="time"> </span> <span> </span> <span> </span> <span> </span> <span> </span> <span> </span> <!></div>'),cg=F('<div class="trend-list"></div>'),ug=F('<div class="perf-event-context"><div class="title"> </div> <div class="line"> </div> <!></div>'),fg=F("<span> </span>"),dg=F('<div><span class="rule-id"> </span> <span> </span> <span> </span></div>'),vg=F('<div class="perf-alert-rules"><div class="title">Triggered Rules</div> <div class="alert-rule-list"></div></div>'),pg=F('<div class="perf-empty">鏆傛棤鏁版嵁</div>'),mg=F('<div class="recent-item"><span class="time"> </span> <span> </span> <span> </span> <span> </span> <span> </span> <span> </span></div>'),hg=F('<div class="recent-list"></div>'),gg=F('<div class="line">trend storage disabled</div>'),_g=F('<div class="perf-empty">鏆傛棤瓒嬪娍鏁版嵁</div>'),bg=F("<span>degraded</span>"),yg=F('<div><span class="time"> </span> <span> </span> <span> </span> <span> </span> <span> </span> <span> </span> <!></div>'),wg=F('<div class="trend-list"></div>'),xg=F('<div class="perf-updated"> </div> <div><span class="health-tag"> </span> <!></div> <!> <div><span class="alerts-tag">Alerts</span> <!> <!></div> <div><span class="notify-tag">Notify</span> <span> <!></span> <!> <!> <!> <!> <!></div> <!> <!> <!> <div class="perf-alert-config"><div class="title">Alert Config</div> <div class="alert-admin-key"><label for="alert-admin-key">admin key (optional)</label> <input id="alert-admin-key" type="password" placeholder="X-Admin-Key"/></div> <div class="alert-config-grid"><label class="alert-field checkbox"><input type="checkbox"/> <span>enabled</span></label> <label class="alert-field"><span>min runs</span> <input type="number" min="1" max="500"/></label> <label class="alert-field"><span>p95 ms >=</span> <input type="number" min="100" max="60000"/></label> <label class="alert-field"><span>error rate >=</span> <input type="number" min="0" max="1" step="0.01"/></label> <label class="alert-field"><span>hit rate &lt;=</span> <input type="number" min="0" max="1" step="0.01"/></label></div> <div class="alert-config-actions"><button class="btn-alert-save"><!></button> <button class="btn-alert-reset">鎭㈠榛樿</button> <!></div></div> <!> <div class="perf-cards"><div class="perf-card"><div class="label">绐楀彛</div> <div class="value"> </div> <div class="meta"> </div></div> <div class="perf-card"><div class="label">寤惰繜</div> <div class="value"> </div> <div class="meta"> </div></div> <div class="perf-card"><div class="label">璐熻浇</div> <div class="value"> </div> <div class="meta"> </div></div> <div class="perf-card"><div class="label">閿欒/鍛戒腑</div> <div class="value"> </div> <div class="meta"> </div></div></div> <div class="perf-cache"><div class="title">缂撳瓨蹇収</div> <div class="line"> </div> <div class="line"> </div></div> <div class="perf-recent"><div class="title"> </div> <!></div> <div class="perf-trend"><div class="title"> </div> <!></div>',1),kg=F('<div class="perf-empty">鏆傛棤瑙傛祴鏁版嵁</div>'),Sg=F('<div class="perf-backdrop" role="button" tabindex="0" aria-label="鍏抽棴鎬ц兘瑙傛祴"><div class="perf-modal" role="dialog" aria-modal="true" tabindex="-1"><div class="perf-header"><div><h2>鏍搁獙鎬ц兘瑙傛祴</h2> <div class="perf-sub">绐楀彛缁熻 + 鏈€杩戣姹傛槑缁�</div></div> <div class="perf-actions"><button class="btn-refresh"><!></button> <button class="btn-close" aria-label="鍏抽棴">脳</button></div></div> <div class="perf-body"><!></div></div></div>');function ld(e,n){if(new.target)return fi({component:ld,...e});Zr(n,!1);let i=jr(n,"visible",12,!1),r=W(null),a=W(!1),s=W(!1),m=W(""),h=W(""),y=null,S=W(!1),b=W(!1),T=W(!1),N=W(""),q=W(""),O=W(""),E=W(!1),P=W(""),vt=W(""),U=W(null),lt=W({enabled:!0,min_runs:8,p95_ms:4500,error_rate_per_run:.3,cache_delta_hit_rate:.35});typeof window<"u"&&f(O,String(window.localStorage.getItem("wa_alert_admin_key")||""));function Tt(pt=!1){const jt={};pt&&(jt["Content-Type"]="application/json");const Dt=String(t(O)||"").trim();return Dt&&(jt["X-Admin-Key"]=Dt),jt}function kt(){if(typeof window>"u")return;const pt=String(t(O)||"");pt.trim()?window.localStorage.setItem("wa_alert_admin_key",pt):window.localStorage.removeItem("wa_alert_admin_key")}function Mt(pt){t(T)||t(b)||f(lt,No({enabled:pt.alerts.enabled,min_runs:pt.alerts.min_runs,p95_ms:pt.alerts.thresholds.p95_ms,error_rate_per_run:pt.alerts.thresholds.error_rate_per_run,cache_delta_hit_rate:pt.alerts.thresholds.cache_delta_hit_rate}))}async function Wt(){if(t(r)){f(b,!0),f(N,""),f(q,"");try{const pt=No(t(lt));f(lt,pt);const jt=await fetch("/api/metrics/citation_verify/alerts/config",{method:"POST",headers:Tt(!0),body:JSON.stringify({config:pt})});if(!jt.ok)throw new Error(`HTTP ${jt.status}`);const Dt=await jt.json();if(Number(Dt?.ok||0)!==1)throw new Error("Failed to save alert config");const Xt=Dt?.config&&typeof Dt.config=="object"?Dt.config:{};f(lt,No({enabled:Xt.enabled,min_runs:Xt.min_runs,p95_ms:Xt.p95_ms,error_rate_per_run:Xt.error_rate_per_run,cache_delta_hit_rate:Xt.cache_delta_hit_rate})),f(T,!1),f(N,"Alert config saved"),f(q,"ok"),await $t(!0)}catch(pt){f(N,pt instanceof Error?pt.message:"Failed to save alert config"),f(q,"bad")}finally{f(b,!1)}}}async function et(){f(b,!0),f(N,""),f(q,"");try{const pt=await fetch("/api/metrics/citation_verify/alerts/config",{method:"POST",headers:Tt(!0),body:JSON.stringify({reset:!0})});if(!pt.ok)throw new Error(`HTTP ${pt.status}`);const jt=await pt.json();if(Number(jt?.ok||0)!==1)throw new Error("Failed to reset alert config");const Dt=jt?.config&&typeof jt.config=="object"?jt.config:{};f(lt,No({enabled:Dt.enabled,min_runs:Dt.min_runs,p95_ms:Dt.p95_ms,error_rate_per_run:Dt.error_rate_per_run,cache_delta_hit_rate:Dt.cache_delta_hit_rate})),f(T,!1),f(N,"Alert config reset to defaults"),f(q,"ok"),await $t(!0)}catch(pt){f(N,pt instanceof Error?pt.message:"Failed to reset alert config"),f(q,"bad")}finally{f(b,!1)}}async function Et(pt){const jt=String(pt||"").trim();if(jt){f(E,!0),f(vt,jt),f(P,"");try{const Dt=await fetch(`/api/metrics/citation_verify/alerts/event/${encodeURIComponent(jt)}?context=12`,{headers:Tt(!1)});if(!Dt.ok)throw new Error(`HTTP ${Dt.status}`);const Xt=await Dt.json();if(Number(Xt?.ok||0)!==1)throw new Error("Failed to load event context");f(U,qh(Xt,jt))}catch(Dt){f(P,Dt instanceof Error?Dt.message:"Failed to load event context"),f(U,null)}finally{f(E,!1)}}}async function $t(pt=!1){pt?f(s,!0):t(r)||f(a,!0),f(m,"");try{const jt=await fetch("/api/metrics/citation_verify");if(!jt.ok)throw new Error(`HTTP ${jt.status}`);const Dt=await jt.json();f(r,Fh(Dt)),t(r)&&Mt(t(r)),f(h,new Date().toLocaleTimeString("zh-CN",{hour12:!1}))}catch(jt){f(m,jt instanceof Error?jt.message:"Failed to load performance metrics")}finally{f(a,!1),f(s,!1)}}function Jt(){y&&(clearInterval(y),y=null)}function de(){y||(y=setInterval(()=>{i()&&$t(!1)},Ll))}wp(()=>{Jt()}),Hs(()=>(ie(i()),t(S)),()=>{i()&&!t(S)?(f(S,!0),$t(!1),de()):!i()&&t(S)&&(f(S,!1),Jt())}),io();var Be={get visible(){return i()},set visible(pt){i(pt),cr()},$set:vi,$on:(pt,jt)=>di(n,pt,jt)};Ds();var ke=Vs(),un=hr(ke);{var Bt=pt=>{var jt=Sg(),Dt=p(jt),Xt=p(Dt),mn=u(p(Xt),2),fn=p(mn),De=p(fn);{var bt=Zt=>{var ue=Xi("鍒锋柊涓?..");M(Zt,ue)},At=Zt=>{var ue=Xi("鍒锋柊");M(Zt,ue)};tt(De,Zt=>{t(s)?Zt(bt):Zt(At,!1)})}d(fn);var ne=u(fn,2);d(mn),d(Xt);var Oe=u(Xt,2),_e=p(Oe);{var Br=Zt=>{var ue=Oh();M(Zt,ue)},Er=Zt=>{var ue=Ph(),dn=p(ue,!0);d(ue),rt(()=>D(dn,t(m))),M(Zt,ue)},Dr=Zt=>{var ue=xg(),dn=hr(ue),fe=p(dn);d(dn);var ei=u(dn,2),vn=p(ei),Ji=p(vn,!0);d(vn);var K=u(vn,2);{var ft=Z=>{var dt=Hh();M(Z,dt)},Ht=Z=>{var dt=zh();M(Z,dt)};tt(K,Z=>{t(r),_(()=>t(r).degraded)?Z(ft):Z(Ht,!1)})}d(ei);var pn=u(ei,2);{var Ar=Z=>{var dt=Uh(),Vt=u(p(dt),2);cn(Vt,5,()=>(t(r),_(()=>t(r).errors)),Jn,(qt,ye)=>{var Xe=Wh(),oe=p(Xe,!0);d(Xe),rt(()=>D(oe,t(ye))),M(qt,Xe)}),d(Vt),d(dt),M(Z,dt)};tt(pn,Z=>{t(r),_(()=>t(r).degraded&&t(r).errors.length>0)&&Z(Ar)})}var Rn=u(pn,2),qn=u(p(Rn),2);{var Tn=Z=>{var dt=Jh(),Vt=p(dt);d(dt),rt(qt=>D(Vt,`severity ${qt??""} | triggered ${t(r),_(()=>t(r).alerts.triggered)??""} | runs ${t(r),_(()=>t(r).alerts.runs)??""}/${t(r),_(()=>t(r).alerts.min_runs)??""}`),[()=>(t(r),_(()=>t(r).alerts.severity.toUpperCase()))]),M(Z,dt)},Le=Z=>{var dt=Kh();M(Z,dt)};tt(qn,Z=>{t(r),_(()=>t(r).alerts.enabled)?Z(Tn):Z(Le,!1)})}var an=u(qn,2);{var jn=Z=>{var dt=Gh();M(Z,dt)};tt(an,Z=>{t(r),_(()=>t(r).alerts.warmup&&t(r).alerts.enabled)&&Z(jn)})}d(Rn);var tn=u(Rn,2),ur=u(p(tn),2),Lr=p(ur),en=u(Lr);{var Cr=Z=>{var dt=Xi();rt(Vt=>D(dt,Vt),[()=>(t(r),_(()=>t(r).alerts.notification.channels.join(",")))]),M(Z,dt)},Kt=Z=>{var dt=Xi("none");M(Z,dt)};tt(en,Z=>{t(r),_(()=>t(r).alerts.notification.channels.length>0)?Z(Cr):Z(Kt,!1)})}d(ur);var yn=u(ur,2);{var sr=Z=>{var dt=Vh(),Vt=p(dt);d(dt),rt(()=>D(Vt,`suppressed ${t(r),_(()=>t(r).alerts.notification.suppressed)??""}`)),M(Z,dt)};tt(yn,Z=>{t(r),_(()=>t(r).alerts.notification.suppressed>0)&&Z(sr)})}var Fn=u(yn,2);{var wn=Z=>{var dt=Xh();M(Z,dt)};tt(Fn,Z=>{t(r),_(()=>t(r).alerts.notification.dedupe_hit)&&Z(wn)})}var Rr=u(Fn,2);{var se=Z=>{var dt=Yh(),Vt=p(dt);d(dt),rt(qt=>D(Vt,`event ${qt??""}`),[()=>(t(r),_(()=>t(r).alerts.notification.event_id.slice(0,8)))]),M(Z,dt)};tt(Rr,Z=>{t(r),_(()=>t(r).alerts.notification.event_id)&&Z(se)})}var ve=u(Rr,2);{var nn=Z=>{var dt=Qh(),Vt=p(dt,!0);d(dt),rt(()=>D(Vt,(t(r),_(()=>t(r).alerts.notification.signature)))),M(Z,dt)};tt(ve,Z=>{t(r),_(()=>t(r).alerts.notification.signature)&&Z(nn)})}var Ge=u(ve,2);{var te=Z=>{var dt=Zh(),Vt=p(dt,!0);d(dt),rt(()=>D(Vt,(t(r),_(()=>t(r).alerts.notification.last_error)))),M(Z,dt)};tt(Ge,Z=>{t(r),_(()=>t(r).alerts.notification.last_error)&&Z(te)})}d(tn);var Se=u(tn,2);{var me=Z=>{var dt=sg(),Vt=p(dt),qt=p(Vt);d(Vt);var ye=u(Vt,2);cn(ye,5,()=>(t(r),_(()=>t(r).alerts.notification.events_recent.slice().reverse())),Jn,(Xe,oe)=>{var Vn=ig(),zn=p(Vn),Wn=p(zn,!0);d(zn);var rr=u(zn,2),xe=p(rr,!0);d(rr);var xr=u(rr,2),Xn=p(xr,!0);d(xr);var Ni=u(xr,2),ar=p(Ni);d(Ni);var si=u(Ni,2);{var wi=Ye=>{var Ke=tg();M(Ye,Ke)};tt(si,Ye=>{t(oe),_(()=>t(oe).dedupe_hit)&&Ye(wi)})}var xi=u(si,2);{var Or=Ye=>{var Ke=eg(),ki=p(Ke);d(Ke),rt(li=>D(ki,`rules ${li??""}`),[()=>(t(oe),_(()=>t(oe).triggered_rules.join(",")))]),M(Ye,Ke)};tt(xi,Ye=>{t(oe),_(()=>t(oe).triggered_rules.length>0)&&Ye(Or)})}var Li=u(xi,2);{var ai=Ye=>{var Ke=ng(),ki=p(Ke);d(Ke),rt(li=>D(ki,`via ${li??""}`),[()=>(t(oe),_(()=>t(oe).channels.join(",")))]),M(Ye,Ke)};tt(Li,Ye=>{t(oe),_(()=>t(oe).channels.length>0)&&Ye(ai)})}var Ri=u(Li,2);{var oi=Ye=>{var Ke=rg(),ki=p(Ke);{var li=qi=>{var ys=Xi("loading...");M(qi,ys)},os=qi=>{var ys=Xi("locate");M(qi,ys)};tt(ki,qi=>{t(E),t(vt),t(oe),_(()=>t(E)&&t(vt)===t(oe).id)?qi(li):qi(os,!1)})}d(Ke),rt(()=>Ke.disabled=t(E)),C("click",Ke,()=>Et(t(oe).id)),M(Ye,Ke)};tt(Ri,Ye=>{t(oe),_(()=>t(oe).id)&&Ye(oi)})}d(Vn),rt(Ye=>{Ne(Vn,1,(t(oe),_(()=>"alert-event-item "+t(oe).severity))),D(Wn,Ye),D(xe,(t(oe),_(()=>t(oe).event_type))),D(Xn,(t(oe),_(()=>t(oe).status))),D(ar,`sent ${t(oe),_(()=>t(oe).sent?"yes":"no")??""}`)},[()=>(ie(Os),t(oe),_(()=>Os(t(oe).ts)))]),M(Xe,Vn)}),d(ye),d(dt),rt(()=>D(qt,`Alert Events (${t(r),_(()=>t(r).alerts.notification.events_recent.length)??""}/${t(r),_(()=>t(r).alerts.notification.events_total)??""})`)),M(Z,dt)};tt(Se,Z=>{t(r),_(()=>t(r).alerts.notification.events_recent.length>0)&&Z(me)})}var En=u(Se,2);{var he=Z=>{var dt=ag(),Vt=p(dt,!0);d(dt),rt(()=>D(Vt,t(P))),M(Z,dt)};tt(En,Z=>{t(P)&&Z(he)})}var be=u(En,2);{var pe=Z=>{var dt=ug(),Vt=p(dt),qt=p(Vt);d(Vt);var ye=u(Vt,2),Xe=p(ye);d(ye);var oe=u(ye,2);{var Vn=zn=>{var Wn=cg();cn(Wn,7,()=>(t(U),_(()=>t(U).points)),(rr,xe)=>`ctx-${rr.id}-${xe}`,(rr,xe)=>{var xr=lg(),Xn=p(xr),Ni=p(Xn,!0);d(Xn);var ar=u(Xn,2),si=p(ar);d(ar);var wi=u(ar,2),xi=p(wi);d(wi);var Or=u(wi,2),Li=p(Or);d(Or);var ai=u(Or,2),Ri=p(ai);d(ai);var oi=u(ai,2),Ye=p(oi);d(oi);var Ke=u(oi,2);{var ki=li=>{var os=og();M(li,os)};tt(Ke,li=>{t(xe),_(()=>t(xe).degraded)&&li(ki)})}d(xr),rt((li,os,qi,ys)=>{Ne(xr,1,(t(xe),_(()=>"trend-item "+t(xe).severity))),D(Ni,li),D(si,`p95 ${os??""}ms`),D(xi,`err ${qi??""}`),D(Li,`hit ${ys??""}`),D(Ri,`alerts ${t(xe),_(()=>t(xe).triggered_alerts)??""}`),D(Ye,`notify ${t(xe),_(()=>t(xe).notification_status||"none")??""}`)},[()=>(ie(Os),t(xe),_(()=>Os(t(xe).ts))),()=>(t(xe),_(()=>t(xe).p95_ms.toFixed(1))),()=>(ie(Yr),t(xe),_(()=>Yr(t(xe).error_rate_per_run))),()=>(ie(Yr),t(xe),_(()=>Yr(t(xe).cache_delta_hit_rate)))]),M(rr,xr)}),d(Wn),M(zn,Wn)};tt(oe,zn=>{t(U),_(()=>t(U).points.length>0)&&zn(Vn)})}d(dt),rt(zn=>{D(qt,`Event Context (${zn??""})`),D(Xe,`points ${t(U),_(()=>t(U).points.length)??""}/${t(U),_(()=>t(U).total)??""} | before ${t(U),_(()=>t(U).before)??""}
                | after ${t(U),_(()=>t(U).after)??""}`)},[()=>(t(U),_(()=>t(U).event_id.slice(0,8)))]),M(Z,dt)};tt(be,Z=>{t(U)&&Z(pe)})}var je=u(be,2),Ee=u(p(je),2),Re=u(p(Ee),2);tr(Re),d(Ee);var Pe=u(Ee,2),er=p(Pe),wt=p(er);tr(wt),us(2),d(er);var re=u(er,2),$e=u(p(re),2);tr($e),d(re);var Qt=u(re,2),Lt=u(p(Qt),2);tr(Lt),d(Qt);var ee=u(Qt,2),hn=u(p(ee),2);tr(hn),d(ee);var An=u(ee,2),Rt=u(p(An),2);tr(Rt),d(An),d(Pe);var gn=u(Pe,2),Cn=p(gn),ni=p(Cn);{var Ei=Z=>{var dt=Xi("淇濆瓨涓?..");M(Z,dt)},Ai=Z=>{var dt=Xi("淇濆瓨鍛婅閰嶇疆");M(Z,dt)};tt(ni,Z=>{t(b)?Z(Ei):Z(Ai,!1)})}d(Cn);var qr=u(Cn,2),is=u(qr,2);{var mi=Z=>{var dt=fg(),Vt=p(dt,!0);d(dt),rt(()=>{Ne(dt,1,"alert-config-msg "+(t(q)||"ok")),D(Vt,t(N))}),M(Z,dt)};tt(is,Z=>{t(N)&&Z(mi)})}d(gn),d(je);var In=u(je,2);{var Kr=Z=>{var dt=vg(),Vt=u(p(dt),2);cn(Vt,5,()=>(t(r),_(()=>t(r).alerts.rules.filter(qt=>qt.triggered))),Jn,(qt,ye)=>{var Xe=dg(),oe=p(Xe),Vn=p(oe,!0);d(oe);var zn=u(oe,2),Wn=p(zn,!0);d(zn);var rr=u(zn,2),xe=p(rr);d(rr),d(Xe),rt((xr,Xn)=>{Ne(Xe,1,(t(ye),_(()=>"alert-rule-item "+t(ye).level))),D(Vn,(t(ye),_(()=>t(ye).id))),D(Wn,(t(ye),_(()=>t(ye).message))),D(xe,`value ${xr??""} ${t(ye),_(()=>t(ye).op)??""} ${Xn??""}`)},[()=>(ie(Io),t(ye),_(()=>Io(t(ye).value))),()=>(ie(Io),t(ye),_(()=>Io(t(ye).threshold)))]),M(qt,Xe)}),d(Vt),d(dt),M(Z,dt)};tt(In,Z=>{t(r),_(()=>t(r).alerts.enabled&&t(r).alerts.triggered>0)&&Z(Kr)})}var _r=u(In,2),br=p(_r),On=u(p(br),2),Ve=p(On);d(On);var Ut=u(On,2),nr=p(Ut);d(Ut),d(br);var fr=u(br,2),Kn=u(p(fr),2),Nn=p(Kn);d(Kn);var Ct=u(Kn,2),ri=p(Ct);d(Ct),d(fr);var rn=u(fr,2),hi=u(p(rn),2),gi=p(hi);d(hi);var ss=u(hi,2),He=p(ss);d(ss),d(rn);var ae=u(rn,2),Gn=u(p(ae),2),Di=p(Gn);d(Gn);var Gr=u(Gn,2),_s=p(Gr);d(Gr),d(ae),d(_r);var _i=u(_r,2),Ir=u(p(_i),2),Pn=p(Ir);d(Ir);var Ci=u(Ir,2),Ki=p(Ci);d(Ci),d(_i);var ii=u(_i,2),Ii=p(ii),Gt=p(Ii);d(Ii);var yr=u(Ii,2);{var Hn=Z=>{var dt=pg();M(Z,dt)},wr=Z=>{var dt=hg();cn(dt,7,()=>(t(r),_(()=>t(r).observe.recent.slice().reverse())),(Vt,qt)=>`${Vt.ts}-${qt}`,(Vt,qt)=>{var ye=mg(),Xe=p(ye),oe=p(Xe,!0);d(Xe);var Vn=u(Xe,2),zn=p(Vn);d(Vn);var Wn=u(Vn,2),rr=p(Wn);d(Wn);var xe=u(Wn,2),xr=p(xe);d(xe);var Xn=u(xe,2),Ni=p(Xn);d(Xn);var ar=u(Xn,2),si=p(ar);d(ar),d(ye),rt((wi,xi,Or)=>{D(oe,wi),D(zn,`${xi??""}ms`),D(rr,`items ${t(qt),_(()=>t(qt).item_count)??""}`),D(xr,`w${t(qt),_(()=>t(qt).worker_count)??""}`),D(Ni,`err ${t(qt),_(()=>t(qt).error_count)??""}`),D(si,`hit_delta ${Or??""}`)},[()=>(ie(Os),t(qt),_(()=>Os(t(qt).ts))),()=>(t(qt),_(()=>t(qt).elapsed_ms.toFixed(1))),()=>(ie(Yr),t(qt),_(()=>Yr(t(qt).cache_delta.hit_rate)))]),M(Vt,ye)}),d(dt),M(Z,dt)};tt(yr,Z=>{t(r),_(()=>t(r).observe.recent.length===0)?Z(Hn):Z(wr,!1)})}d(ii);var Fr=u(ii,2),bi=p(Fr),as=p(bi);d(bi);var Ls=u(bi,2);{var bs=Z=>{var dt=gg();M(Z,dt)},yi=Z=>{var dt=_g();M(Z,dt)},Xs=Z=>{var dt=wg();cn(dt,7,()=>(t(r),_(()=>t(r).trend.points.slice().reverse())),(Vt,qt)=>`${Vt.id}-${qt}`,(Vt,qt)=>{var ye=yg(),Xe=p(ye),oe=p(Xe,!0);d(Xe);var Vn=u(Xe,2),zn=p(Vn);d(Vn);var Wn=u(Vn,2),rr=p(Wn);d(Wn);var xe=u(Wn,2),xr=p(xe);d(xe);var Xn=u(xe,2),Ni=p(Xn);d(Xn);var ar=u(Xn,2),si=p(ar);d(ar);var wi=u(ar,2);{var xi=Or=>{var Li=bg();M(Or,Li)};tt(wi,Or=>{t(qt),_(()=>t(qt).degraded)&&Or(xi)})}d(ye),rt((Or,Li,ai,Ri)=>{Ne(ye,1,(t(qt),_(()=>"trend-item "+t(qt).severity))),D(oe,Or),D(zn,`p95 ${Li??""}ms`),D(rr,`err ${ai??""}`),D(xr,`hit ${Ri??""}`),D(Ni,`alerts ${t(qt),_(()=>t(qt).triggered_alerts)??""}`),D(si,`notify ${t(qt),_(()=>t(qt).notification_status||"none")??""}`)},[()=>(ie(Os),t(qt),_(()=>Os(t(qt).ts))),()=>(t(qt),_(()=>t(qt).p95_ms.toFixed(1))),()=>(ie(Yr),t(qt),_(()=>Yr(t(qt).error_rate_per_run))),()=>(ie(Yr),t(qt),_(()=>Yr(t(qt).cache_delta_hit_rate)))]),M(Vt,ye)}),d(dt),M(Z,dt)};tt(Ls,Z=>{t(r),_(()=>!t(r).trend.enabled)?Z(bs):(t(r),_(()=>t(r).trend.points.length===0)?Z(yi,1):Z(Xs,!1))})}d(Fr),rt((Z,dt,Vt,qt,ye,Xe,oe,Vn,zn,Wn,rr,xe)=>{D(fe,`鏈€杩戝埛鏂? ${(t(h)||"--:--:--")??""} | 鑷姩杞 ${Z??""}s`),Ne(ei,1,(t(r),_(()=>"perf-health "+(t(r).degraded?"warn":"ok")))),D(Ji,(t(r),_(()=>t(r).degraded?"DEGRADED":"HEALTHY"))),Ne(Rn,1,(t(r),_(()=>"perf-alert-summary "+(t(r).alerts.enabled?t(r).alerts.severity:"ok")))),Ne(tn,1,(t(r),_(()=>"perf-notify-summary "+(t(r).alerts.notification.sent?"sent":"idle")))),D(Lr,`status ${t(r),_(()=>t(r).alerts.notification.status)??""} | event ${t(r),_(()=>t(r).alerts.notification.event_type)??""} | channels `),Cn.disabled=t(b)||!t(T),qr.disabled=t(b),D(Ve,`${t(r),_(()=>t(r).observe.runs)??""}/${t(r),_(()=>t(r).observe.max_runs)??""}`),D(nr,`window ${dt??""}s`),D(Nn,`${Vt??""} / ${qt??""} ms`),D(ri,`max ${ye??""} ms`),D(gi,`${Xe??""} items/run`),D(He,`workers avg ${oe??""} | max ${Vn??""}`),D(Di,`${zn??""} / ${Wn??""}`),D(_s,`errors ${t(r),_(()=>t(r).observe.errors.total)??""} | hit_delta`),D(Pn,`size ${t(r),_(()=>t(r).cache.size)??""}/${t(r),_(()=>t(r).cache.max_entries)??""} | ttl ${rr??""}s | hit ${t(r),_(()=>t(r).cache.hit)??""}/
              ${t(r),_(()=>t(r).cache.hit+t(r).cache.miss)??""} (${xe??""})`),D(Ki,`set ${t(r),_(()=>t(r).cache.set)??""} | evicted ${t(r),_(()=>t(r).cache.evicted)??""} | expired ${t(r),_(()=>t(r).cache.expired)??""}`),D(Gt,`Recent Runs (${t(r),_(()=>t(r).observe.recent.length)??""})`),D(as,`Trend (${t(r),_(()=>t(r).trend.points.length)??""}/${t(r),_(()=>t(r).trend.total)??""})`)},[()=>(ie(Ll),_(()=>Math.floor(Ll/1e3))),()=>(t(r),_(()=>t(r).observe.window_s.toFixed(0))),()=>(t(r),_(()=>t(r).observe.elapsed_ms.p50.toFixed(1))),()=>(t(r),_(()=>t(r).observe.elapsed_ms.p95.toFixed(1))),()=>(t(r),_(()=>t(r).observe.elapsed_ms.max.toFixed(1))),()=>(t(r),_(()=>t(r).observe.items.avg.toFixed(1))),()=>(t(r),_(()=>t(r).observe.workers.avg.toFixed(1))),()=>(t(r),_(()=>t(r).observe.workers.max.toFixed(0))),()=>(ie(Yr),t(r),_(()=>Yr(t(r).observe.errors.rate_per_run))),()=>(ie(Yr),t(r),_(()=>Yr(t(r).observe.cache_delta.hit_rate))),()=>(t(r),_(()=>t(r).cache.ttl_s.toFixed(0))),()=>(ie(Yr),ie(Ru),t(r),_(()=>Yr(Ru(t(r).cache))))]),sn(Re,()=>t(O),Z=>f(O,Z)),C("change",Re,kt),Xl(wt,()=>t(lt).enabled,Z=>Wr(lt,t(lt).enabled=Z)),C("change",wt,()=>{f(T,!0),f(N,""),f(q,"")}),sn($e,()=>t(lt).min_runs,Z=>Wr(lt,t(lt).min_runs=Z)),C("input",$e,()=>{f(T,!0),f(N,""),f(q,"")}),sn(Lt,()=>t(lt).p95_ms,Z=>Wr(lt,t(lt).p95_ms=Z)),C("input",Lt,()=>{f(T,!0),f(N,""),f(q,"")}),sn(hn,()=>t(lt).error_rate_per_run,Z=>Wr(lt,t(lt).error_rate_per_run=Z)),C("input",hn,()=>{f(T,!0),f(N,""),f(q,"")}),sn(Rt,()=>t(lt).cache_delta_hit_rate,Z=>Wr(lt,t(lt).cache_delta_hit_rate=Z)),C("input",Rt,()=>{f(T,!0),f(N,""),f(q,"")}),C("click",Cn,Wt),C("click",qr,et),M(Zt,ue)},pi=Zt=>{var ue=kg();M(Zt,ue)};tt(_e,Zt=>{t(a)&&!t(r)?Zt(Br):t(m)?Zt(Er,1):t(r)?Zt(Dr,2):Zt(pi,!1)})}d(Oe),d(Dt),d(jt),rt(()=>fn.disabled=t(a)||t(s)),C("click",fn,()=>$t(!0)),C("click",ne,()=>i(!1)),C("click",Dt,ua(function(Zt){ps.call(this,n,Zt)})),C("keydown",Dt,ua(function(Zt){ps.call(this,n,Zt)})),C("click",jt,()=>i(!1)),C("keydown",jt,Zt=>{(Zt.key==="Enter"||Zt.key===" "||Zt.key==="Escape")&&(Zt.preventDefault(),i(!1))}),M(pt,jt)};tt(un,pt=>{i()&&pt(Bt)})}return M(e,ke),ti(Be)}const $g="modulepreload",Tg=function(e){return"/"+e},Fu={},jg=function(n,i,r){let a=Promise.resolve();if(i&&i.length>0){let S=function(b){return Promise.all(b.map(T=>Promise.resolve(T).then(N=>({status:"fulfilled",value:N}),N=>({status:"rejected",reason:N}))))};var m=S;document.getElementsByTagName("link");const h=document.querySelector("meta[property=csp-nonce]"),y=h?.nonce||h?.getAttribute("nonce");a=S(i.map(b=>{if(b=Tg(b),b in Fu)return;Fu[b]=!0;const T=b.endsWith(".css"),N=T?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${b}"]${N}`))return;const q=document.createElement("link");if(q.rel=T?"stylesheet":$g,T||(q.as="script"),q.crossOrigin="",q.href=b,y&&q.setAttribute("nonce",y),document.head.appendChild(q),T)return new Promise((O,E)=>{q.addEventListener("load",O),q.addEventListener("error",()=>E(new Error(`Unable to preload CSS for ${b}`)))})}))}function s(h){const y=new Event("vite:preloadError",{cancelable:!0});if(y.payload=h,window.dispatchEvent(y),!y.defaultPrevented)throw h}return a.then(h=>{for(const y of h||[])y.status==="rejected"&&s(y.reason);return n().catch(s)})};let Mo=null,Rl=null;async function Eg(){try{return Rl?!0:(Mo=await jg(()=>import("./chunk-wa_bridge.js"),[]),Mo?.default&&await Mo.default(),Rl=Mo?.WasmEditor??null,Rl?(console.log("已加载 Rust WASM 引擎"),!0):(console.warn("未找到 Rust WASM 入口：WasmEditor"),!1))}catch(e){return console.warn("Rust WASM 加载失败，回退到 contenteditable：",e),!1}}var Ag=F('<div class="status-chip light svelte-13mrafj"> </div>'),Cg=F('<div class="status-chip light svelte-13mrafj"> </div>'),Ig=F('<button class="btn ghost svelte-13mrafj">续跑</button>'),Ng=F('<div class="generation-banner svelte-13mrafj"> </div>'),Mg=F('<div class="generation-banner svelte-13mrafj"> <!> 。可点击“续跑”继续生成。</div>'),Bg=F('<div class="failure-row svelte-13mrafj"><span> </span> <button class="btn ghost svelte-13mrafj">重试</button></div>'),Dg=F('<section class="section-failures svelte-13mrafj"><div class="panel-title svelte-13mrafj">失败章节</div> <!></section>'),Lg=F('<span class="feedback-tip svelte-13mrafj"> </span>'),Rg=F('<div class="plagiarism-evidence svelte-13mrafj"> </div>'),qg=F('<div class="plagiarism-item svelte-13mrafj"><div class="plagiarism-item-head svelte-13mrafj"><span> </span> <span> </span></div> <div class="plagiarism-item-metrics svelte-13mrafj"><span> </span> <span> </span> <span> </span> <span> </span></div> <!> <div class="panel-sub svelte-13mrafj"> </div></div>'),Fg=F('<section class="feedback-panel ai-rate-panel svelte-13mrafj"><div class="feedback-panel-head svelte-13mrafj"><div><div class="panel-title svelte-13mrafj">AI 率检测</div> <div class="panel-sub svelte-13mrafj">基于 burstiness、重复率、词汇熵、连接词密度等信号估计。</div></div></div> <div class="feedback-form svelte-13mrafj"><div class="plagiarism-grid svelte-13mrafj"><label class="feedback-label" for="ai-rate-threshold">判定阈值</label> <input id="ai-rate-threshold" type="number" min="0.05" max="0.95" step="0.01" data-testid="ai-rate-threshold" class="svelte-13mrafj"/> <span class="panel-sub svelte-13mrafj">建议 0.65，结果仅作为风险提示</span></div> <div class="feedback-actions svelte-13mrafj"><button class="btn primary svelte-13mrafj" data-testid="ai-rate-run"> </button> <!></div> <!></div></section>'),Og=F('<span class="feedback-tip svelte-13mrafj"> </span>'),Pg=F('<div class="plagiarism-report-actions svelte-13mrafj"><span class="panel-sub svelte-13mrafj"> </span> <button class="btn ghost svelte-13mrafj">下载 JSON</button> <button class="btn ghost svelte-13mrafj">下载 MD</button> <button class="btn ghost svelte-13mrafj">下载 CSV</button></div>'),Hg=F('<em class="svelte-13mrafj"> </em>'),zg=F('<div class="plagiarism-evidence svelte-13mrafj"> </div>'),Wg=F('<div class="plagiarism-item svelte-13mrafj"><div class="plagiarism-item-head svelte-13mrafj"><span> <!></span> <span> </span></div> <div class="plagiarism-item-metrics svelte-13mrafj"><span> </span> <span> </span> <span> </span> <span> </span></div> <!></div>'),Ug=F('<div class="plagiarism-results svelte-13mrafj"></div>'),Jg=F('<section class="feedback-panel plagiarism-panel svelte-13mrafj"><div class="feedback-panel-head svelte-13mrafj"><div><div class="panel-title svelte-13mrafj">内容查重检测</div> <div class="panel-sub svelte-13mrafj">算法：n-gram + Winnowing + SimHash 混合评分，建议阈值 0.35。</div></div></div> <div class="feedback-form svelte-13mrafj"><div class="plagiarism-grid svelte-13mrafj"><label class="feedback-label" for="plag-threshold">判定阈值</label> <input id="plag-threshold" type="number" min="0.05" max="0.95" step="0.01" data-testid="plagiarism-threshold" class="svelte-13mrafj"/> <label class="feedback-label" for="plag-docids">参考文档ID</label> <input id="plag-docids" type="text" placeholder="多个ID用逗号或空格分隔" data-testid="plagiarism-docids" class="svelte-13mrafj"/></div> <div class="feedback-row svelte-13mrafj"><span class="feedback-label">参考文本</span> <textarea rows="4" maxlength="30000" placeholder="可粘贴外部资料、历史稿件或样本文本用于查重" data-testid="plagiarism-text" class="svelte-13mrafj"></textarea></div> <div class="feedback-actions svelte-13mrafj"><button class="btn primary svelte-13mrafj" data-testid="plagiarism-run"> </button> <button class="btn ghost svelte-13mrafj" data-testid="plagiarism-library-run"> </button> <!></div> <!> <!></div></section>'),Kg=F('<button type="button"> </button>'),Gg=F('<span class="feedback-tip svelte-13mrafj"> </span>'),Vg=F('<div class="feedback-item-note svelte-13mrafj"> </div>'),Xg=F('<div class="feedback-item svelte-13mrafj"><div class="feedback-item-head svelte-13mrafj"><span> </span> <span> </span></div> <!></div>'),Yg=F('<div class="feedback-history svelte-13mrafj"><div class="panel-sub svelte-13mrafj">最近反馈</div> <!></div>'),Qg=F('<section class="feedback-panel svelte-13mrafj"><div class="feedback-panel-head svelte-13mrafj"><div><div class="panel-title svelte-13mrafj">用户满意度</div> <div class="panel-sub svelte-13mrafj">1 分最低，5 分最高；低分样本会进入学习池。</div></div></div> <div class="feedback-form svelte-13mrafj"><div class="feedback-row svelte-13mrafj"><span class="feedback-label">评分</span> <div class="rating-group svelte-13mrafj"></div> <span class="feedback-label">阶段</span> <select data-testid="feedback-stage" class="svelte-13mrafj"><option>通用反馈</option><option>阶段1 生成</option><option>阶段2 修改</option><option>最终版本</option></select></div> <div class="feedback-row svelte-13mrafj"><span class="feedback-label">备注</span> <textarea data-testid="feedback-note" rows="2" maxlength="600" placeholder="可选：不满意点、缺失点、改进建议" class="svelte-13mrafj"></textarea></div> <div class="feedback-actions svelte-13mrafj"><button class="btn primary svelte-13mrafj" data-testid="feedback-submit"> </button> <!></div> <!></div></section>'),Zg=F('<div class="panel-empty svelte-13mrafj">加载中...</div>'),t_=F('<div class="panel-empty svelte-13mrafj"> </div>'),e_=F('<div class="panel-empty svelte-13mrafj">暂无版本</div>'),n_=F('<div class="version-summary svelte-13mrafj"> </div>'),r_=F('<div class="version-summary svelte-13mrafj"> </div>'),i_=F('<div><div><div class="minor-title svelte-13mrafj"> </div> <!> <div class="minor-meta svelte-13mrafj"> </div></div> <div class="minor-actions svelte-13mrafj"><button class="btn ghost svelte-13mrafj">切换</button> <button class="btn ghost svelte-13mrafj">对比</button></div></div>'),s_=F('<div class="version-minors svelte-13mrafj"></div>'),a_=F('<div class="version-group"><div><div class="version-title svelte-13mrafj"><span> </span> <span> </span></div> <div class="version-meta svelte-13mrafj"><span> </span> <span> </span></div> <!> <div class="version-actions svelte-13mrafj"><button class="btn ghost svelte-13mrafj">切换</button> <button class="btn ghost svelte-13mrafj">对比</button></div></div> <!></div>'),o_=F('<div class="version-groups svelte-13mrafj"></div>'),l_=F('<div class="inline-selection-bar svelte-13mrafj" role="toolbar" aria-label="选中块快捷操作"><div class="inline-selection-meta svelte-13mrafj"> <span class="svelte-13mrafj">Ctrl/Cmd+Enter 下弹窗 · Ctrl/Cmd+Shift+Enter 上弹窗</span></div> <div class="inline-selection-actions svelte-13mrafj"><button class="mini-btn svelte-13mrafj">改写</button> <button class="mini-btn svelte-13mrafj">样式</button> <button class="mini-btn svelte-13mrafj">插表</button> <button class="mini-btn svelte-13mrafj">插图</button> <button class="mini-btn svelte-13mrafj">对话</button> <button class="mini-btn svelte-13mrafj">上方</button> <button class="mini-btn svelte-13mrafj">下方</button></div></div>'),c_=F('<span class="selected-chip svelte-13mrafj"> </span>'),u_=F('<div class="block-error svelte-13mrafj"> </div>'),f_=F('<div class="inline-style-row compact svelte-13mrafj"><span>字体</span> <select class="svelte-13mrafj"><option>默认</option><option>宋体</option><option>黑体</option><option>微软雅黑</option><option>楷体</option><option>仿宋</option></select> <span>字号</span> <select class="svelte-13mrafj"><option>默认</option><option>12pt</option><option>14pt</option><option>16pt</option><option>18pt</option><option>20pt</option></select> <span>行距</span> <select class="svelte-13mrafj"><option>默认</option><option>1.2</option><option>1.5</option><option>1.75</option><option>2.0</option></select> <span>对齐</span> <select class="svelte-13mrafj"><option>默认</option><option>左对齐</option><option>居中</option><option>右对齐</option><option>两端对齐</option></select> <span>字重</span> <select class="svelte-13mrafj"><option>默认</option><option>常规</option><option>中等</option><option>半粗</option><option>加粗</option></select> <span>字形</span> <select class="svelte-13mrafj"><option>默认</option><option>正常</option><option>斜体</option></select> <span>文字色</span> <input type="text" placeholder="#1f2937" class="svelte-13mrafj"/> <span>背景色</span> <input type="text" placeholder="#ffffff" class="svelte-13mrafj"/></div> <div class="panel-empty svelte-13mrafj">样式栏会回显当前选中块的样式，修改仅作用于当前选区。</div>',1),d_=F('<div class="assistant-inline-tip svelte-13mrafj"><div>用于处理当前选中块的复杂语义修改。</div> <textarea class="inline-instruction svelte-13mrafj" placeholder="例如：将选中内容改成课程设计报告语气，并补全术语解释。"></textarea> <div class="assistant-inline-actions svelte-13mrafj"><button class="btn ghost svelte-13mrafj">同步到改写指令</button> <button class="btn ghost svelte-13mrafj">发到右下角全局助手</button></div></div>'),v_=F('<div class="panel-empty svelte-13mrafj">当前选区包含标题，请直接编辑标题或切到“样式设置”。</div>'),p_=F('<div class="inline-preset-row svelte-13mrafj"><button class="preset-chip svelte-13mrafj">更正式</button> <button class="preset-chip svelte-13mrafj">更简洁</button> <button class="preset-chip svelte-13mrafj">更详细</button> <button class="preset-chip svelte-13mrafj">保留术语</button></div> <div class="inline-ai-row svelte-13mrafj"><textarea class="inline-instruction svelte-13mrafj" placeholder="例如：仅重写选中段落，语气更正式，减少20%字数。"></textarea></div> <div class="inline-action-row svelte-13mrafj"><button class="btn ghost svelte-13mrafj">切到改动对话</button> <button class="btn primary svelte-13mrafj"> </button></div> <!>',1),m_=F('<div class="block-error svelte-13mrafj"> </div>'),h_=F('<button><span class="svelte-13mrafj"> </span> <span class="svelte-13mrafj"> </span></button>'),g_=F('<div class="candidate-card svelte-13mrafj"><div class="candidate-head svelte-13mrafj"><span> </span> <span class="candidate-meta svelte-13mrafj"> </span></div> <div class="candidate-actions svelte-13mrafj"><button class="btn primary svelte-13mrafj">采纳到正文</button> <button class="btn ghost svelte-13mrafj">重新生成</button> <button class="btn ghost danger svelte-13mrafj">忽略建议</button></div> <div class="candidate-label svelte-13mrafj">建议文本</div> <div class="candidate-text svelte-13mrafj"> </div></div>'),__=F('<div class="candidate-compare compact svelte-13mrafj"><div class="candidate-before svelte-13mrafj"><div class="candidate-label svelte-13mrafj">原文</div> <div class="candidate-text svelte-13mrafj"> </div></div> <div class="candidate-panel svelte-13mrafj"><div class="candidate-switches svelte-13mrafj"></div> <!></div></div>'),b_=F('<section aria-label="选中内容修改窗口"><div class="inline-popover-head svelte-13mrafj"><div><div class="panel-title svelte-13mrafj">选中内容轻量修改</div> <div class="panel-sub svelte-13mrafj">当前上下文独立于其他段落块，同一块会继承修改上下文。</div></div> <div class="inline-popover-head-actions svelte-13mrafj"><button class="btn ghost btn-sm svelte-13mrafj">插表</button> <button class="btn ghost btn-sm svelte-13mrafj">插图</button> <button class="btn ghost btn-sm svelte-13mrafj">上方</button> <button class="btn ghost btn-sm svelte-13mrafj">下方</button> <button class="btn ghost btn-sm svelte-13mrafj">关闭</button></div></div> <div class="inline-tabs svelte-13mrafj"><button>改写建议</button> <button>样式设置</button> <button>改动对话</button></div> <div class="selected-targets svelte-13mrafj"></div> <!> <!> <!> <!> <!> <!></section>'),y_=F('<span class="assistant-queue-badge svelte-13mrafj"> </span>'),w_=F("<!> <!> <!> <!>",1),x_=F('<main><header class="topbar svelte-13mrafj"><div class="brand svelte-13mrafj"><div class="logo svelte-13mrafj">IR</div> <div class="brand-text"><div class="brand-title svelte-13mrafj">写作引擎</div> <div class="brand-sub svelte-13mrafj">Doc IR · 语义写作</div></div></div> <nav class="menu svelte-13mrafj"><button class="menu-item svelte-13mrafj">概览</button> <button class="menu-item svelte-13mrafj">模板</button> <button class="menu-item svelte-13mrafj">协作</button> <button class="menu-item svelte-13mrafj">历史</button> <button class="menu-item svelte-13mrafj">帮助</button></nav> <div class="top-actions svelte-13mrafj"><div class="status-chip svelte-13mrafj"><span class="dot svelte-13mrafj"></span> <span> </span></div> <div class="status-chip light svelte-13mrafj"> </div> <!> <!> <button class="btn ghost svelte-13mrafj">保存</button> <button class="btn ghost svelte-13mrafj">导出 Word</button> <button class="btn ghost svelte-13mrafj">导出 PDF</button> <button class="btn ghost svelte-13mrafj" data-testid="ai-rate-toggle"> </button> <button class="btn ghost svelte-13mrafj" data-testid="plagiarism-toggle"> </button> <button class="btn ghost svelte-13mrafj" data-testid="feedback-toggle"> </button> <!></div></header> <div class="workspace svelte-13mrafj"><aside class="nav-rail svelte-13mrafj"><button class="nav-btn active svelte-13mrafj" title="文档"><span>文档</span></button> <button class="nav-btn svelte-13mrafj" title="画布"><span>画布</span></button> <button class="nav-btn svelte-13mrafj" title="引用"><span>引用</span></button> <button class="nav-btn svelte-13mrafj" title="性能"><span>性能</span></button> <button class="nav-btn svelte-13mrafj" title="文档库"><span>文档库</span></button></aside> <section class="doc-area svelte-13mrafj"><div class="doc-toolbar svelte-13mrafj"><div class="toolbar-line svelte-13mrafj"><div class="toolbar-cluster svelte-13mrafj"><span class="cluster-label svelte-13mrafj">文本</span> <button class="tool-btn svelte-13mrafj" title="撤销 Ctrl/Cmd+Z">↶</button> <button class="tool-btn svelte-13mrafj" title="重做 Ctrl/Cmd+Y">↷</button> <button class="tool-btn svelte-13mrafj" title="复制 Ctrl/Cmd+C">复制</button> <button class="tool-btn svelte-13mrafj" title="剪切 Ctrl/Cmd+X">剪切</button> <button class="tool-btn svelte-13mrafj" title="粘贴 Ctrl/Cmd+V">粘贴</button> <button class="tool-btn svelte-13mrafj" title="清除格式">Tx</button> <span class="tool-sep svelte-13mrafj"></span> <button title="加粗 Ctrl/Cmd+B">B</button> <button title="斜体 Ctrl/Cmd+I">I</button> <button title="下划线 Ctrl/Cmd+U">U</button></div> <div class="toolbar-cluster svelte-13mrafj"><span class="cluster-label svelte-13mrafj">结构</span> <button class="tool-btn svelte-13mrafj">H1</button> <button class="tool-btn svelte-13mrafj">H2</button> <button class="tool-btn svelte-13mrafj">引用</button> <button class="tool-btn svelte-13mrafj">代码</button> <button class="tool-btn svelte-13mrafj">列表</button> <button class="tool-btn svelte-13mrafj">1.</button></div> <div class="toolbar-cluster svelte-13mrafj"><span class="cluster-label svelte-13mrafj">插入</span> <button class="tool-btn svelte-13mrafj">画布</button> <button class="tool-btn svelte-13mrafj">引用</button></div> <div class="toolbar-cluster compact svelte-13mrafj"><span class="cluster-label svelte-13mrafj">智能写作</span> <button class="btn ghost svelte-13mrafj">生成</button> <button class="btn ghost svelte-13mrafj">停止</button> <!></div></div></div> <!> <!> <!> <!> <!> <!> <div class="doc-stage svelte-13mrafj"><!></div></section> <aside class="side-panel svelte-13mrafj"><div class="panel-card version-panel svelte-13mrafj"><div class="panel-header svelte-13mrafj"><div><div class="panel-title svelte-13mrafj">版本树</div> <div class="panel-sub svelte-13mrafj">自动小版本 · 手动大版本</div></div> <button class="icon-btn svelte-13mrafj" title="刷新">刷新</button></div> <div class="major-commit svelte-13mrafj"><input class="version-input svelte-13mrafj" placeholder="输入版本说明"/> <button class="btn primary svelte-13mrafj">保存版本</button></div> <!> <div class="version-diff svelte-13mrafj"><div class="panel-sub svelte-13mrafj">对比结果</div> <pre class="svelte-13mrafj"> </pre></div></div></aside></div> <!> <!> <div><button class="assistant-toggle svelte-13mrafj"> <!></button> <!></div> <input class="hidden-input svelte-13mrafj" type="file" accept="image/*"/> <!></main> <!> <!>',1);function cd(e,n){if(new.target)return fi({component:cd,...e});Zr(n,!1);const i=()=>Zn(Ps,"$generating",q),r=()=>Zn(mr,"$sourceText",q),a=()=>Zn($r,"$docIr",q),s=()=>Zn(Ms,"$docId",q),m=()=>Zn(ui,"$docStatus",q),h=()=>Zn(xa,"$flowStatus",q),y=()=>Zn(kc,"$wordCount",q),S=()=>Zn(zs,"$instruction",q),b=()=>Zn(Qn,"$docIrDirty",q),T=()=>Zn(Nu,"$darkMode",q),N=()=>Zn(Ua,"$isLoading",q),[q,O]=Fa();let E=null,P="",vt=null,U=null,lt=!1,Tt=W(!1),kt=[],Mt=null,Wt=0,et=0,Et=!1,$t=W(!1),Jt=null,de=null,Be=0,ke="",un="",Bt=!1,pt=!1,jt=!1,Dt=0,Xt=0,mn=0,fn=9e4,De=null,bt=!1,At=W({current:0,total:0,percent:0,etaS:0,section:""}),ne=0,Oe=[],_e=W([]),Br=!1,Er=W(null),Dr=null,pi=!1,Zt="",ue=W(""),dn=null,fe=W(null),ei=W(!1),vn=W(!1),Ji=W(!1),K=W(!1),ft=W([]),Ht=W(0),pn=W("general"),Ar=W(""),Rn=W(!1),qn=W(0),Tn=W(!1),Le=W(!1),an=W(!1),jn=W(.35),tn=W(""),ur=W(""),Lr=W(!1),en=W(!1),Cr=W(.65),Kt=W(null),yn=W([]),sr=W(0),Fn=W(0),wn=W(null),Rr=W(!1),se=[],ve=W([]),nn=W(""),Ge=W(""),te=W(""),Se=W(!0),me=W(!1),En="",he=W([]),be=W([]),pe=W(""),je=W(""),Ee=W(""),Re=W(""),Pe=W(""),er=W(""),wt=W(""),re=W(""),$e=W(""),Qt=W(""),Lt=W("rewrite"),ee=W(!1),hn=W(""),An=W(""),Rt=W([]),gn=W(0),Cn=W(null),ni=W("");const Ei=new Map;let Ai="",qr=W(!1),is=W(0),mi=W(0),In=W(!1),Kr=W("down"),_r=W(0),br=W(0),On=W([]),Ve=W([]),Ut=W(!1),nr=W(""),fr=W(null),Kn=[],Nn=Date.now(),Ct=W({focused:!1,readonly:!1,bold:!1,italic:!1,underline:!1,hasSelection:!1,canUndo:!1,canRedo:!1,canCopy:!1,canCut:!1,canPaste:!1}),ri=0,rn=W([]),hi=!1,gi=null;typeof window<"u"&&document.body.setAttribute("data-engine","rust");function ss(){return gi||(gi=Eg().then(l=>l).catch(()=>!1)),gi}function He(){const l=window;if(l.__DOC_ID__)return String(l.__DOC_ID__);const c=document.body?.getAttribute("data-doc-id");return c||document.querySelector('meta[name="doc-id"]')?.getAttribute("content")||""}function ae(){if(!Be)return new Date().toLocaleTimeString();const l=Date.now()-Be,c=Math.max(0,Math.floor(l/1e3)),w=String(Math.floor(c/60)).padStart(2,"0"),x=String(c%60).padStart(2,"0");return`+${w}:${x}`}function Gn(l){const c=(l||"").toUpperCase();return c==="PLAN"?"规划":c==="WRITE"?"写作":c==="DONE"?"完成":c==="STOPPED"?"已停止":l}function Di(l){return Xe(String(l||"")).trim().replace(/^#+\s*/,"").replace(/^h[23]::/i,"").replace(/\s+/g,"").replace(/[：:，,。.!?？；;、（）()【】\[\]《》"'“”‘’]/g,"").toLowerCase()}function Gr(){return i()||t(Tt)||t($t)}function _s(l){const c=String(l||"").trim();return c?c.replace(/[`~*#>\-\[\]\(\)_=|]/g,"").replace(/\s+/g,"").replace(/[，。！？；：,.!?;:]/g,"").length>=8:!1}function _i(l){const c=String(l||"").trim();return c?/(?:全文|整篇|整文|全部|从头).{0,4}(?:重写|改写)|覆盖重写|推倒重写|重新写一份|(?:rewrite|redo|start over|from scratch|replace).{0,14}(?:entire|whole|full|document|draft)|(?:entire|whole|full).{0,14}(?:rewrite|redo|replace)|overwrite(?:\s+the)?(?:\s+whole|\s+entire|\s+full)?(?:\s+document|\s+draft)?/i.test(c)?"overwrite":/(?:续写|接着写|继续写|接续写|在原文基础上继续|延续写|(?:continue|keep writing|carry on|extend|add more|build on).{0,14}(?:current|existing|draft|document|text|content)?|(?:based on|on top of)\s+(?:the\s+)?(?:existing|current))/i.test(c)?"continue":null:null}function Ir(l){if(!Array.isArray(l))return[];const c=[],w=new Set;for(const x of l){const $=String(x||"").trim();!$||w.has($)||(w.add($),c.push($))}return c}function Pn(l){if(!l||typeof l!="object")return null;const c=String(l.status||"").trim().toLowerCase();if(c!=="running"&&c!=="interrupted")return null;const w=String(l.compose_mode||"auto").trim().toLowerCase(),x=w==="continue"||w==="overwrite"||w==="auto"?w:"auto";return{status:c,updated_at:Number(l.updated_at||0),user_instruction:String(l.user_instruction||"").trim(),request_instruction:String(l.request_instruction||"").trim(),compose_mode:x,partial_chars:Number(l.partial_chars||0),partial_preview:String(l.partial_preview||"").trim(),plan_sections:Ir(l.plan_sections),completed_sections:Ir(l.completed_sections),pending_sections:Ir(l.pending_sections),cursor_anchor:String(l.cursor_anchor||"").trim(),error:String(l.error||"").trim()}}function Ci(){const l=[],c=new Set;for(const w of t(be)){const x=Di(w.sectionTitle||w.sectionId||"");!x||c.has(x)||(c.add(x),l.push(x))}return l}function Ki(l,c){const w=Di(l);if(w){if(c==="start"){t(On).includes(w)||f(On,[...t(On),w]);return}c==="end"&&(f(On,t(On).filter(x=>x!==w)),t(Ve).includes(w)||f(Ve,[...t(Ve),w]))}}function ii(){f(On,[]),f(Ve,[])}function Ii(){if(!Gr())return!0;if(!i())return!1;const l=Ci();return l.length?l.every(c=>t(Ve).includes(c)&&!t(On).includes(c)):!1}function Gt(l){if(Ii())return!0;const c=t(nr)||`生成中，暂不支持${l}`;return f(hn,c),gt(c,"info"),!1}function yr(l){const c={id:++ri,text:l,createdAt:Date.now()};f(rn,[...t(rn),c].slice(-20)),Hr("system",`当前正在生成，已加入待执行队列（${t(rn).length}）`),gt(`已排队（${t(rn).length}）`,"info"),queueMicrotask(()=>{Hn()})}async function Hn(){if(hi||!t(rn).length)return;hi=!0;let l=0,c=!1;try{for(;t(rn).length;){if(Gr()){l||(l=Date.now());const $=Date.now()-l;!i()&&(t(Tt)||t($t))&&!kt.length&&Jt===null&&Date.now()-Nn>2500?(bi(),c||(gt("检测到渲染状态卡住，已自动恢复并继续执行排队指令。","info"),c=!0)):$>15e4&&(Ps.set(!1),bi(),c||(gt("排队指令等待超时，已强制恢复并继续。","info"),c=!0)),await new Promise(B=>setTimeout(B,100));continue}l=0;const[w,...x]=t(rn);f(rn,x),Hr("system",`开始执行排队指令（剩余 ${t(rn).length}）`),await go(w.text,{fromQueue:!0})}}finally{hi=!1}}function wr(l){const c=String(l||"");c.trim()&&(c.length<8&&!/[\w\u4e00-\u9fa5]/.test(c)||(Nn=Date.now(),P+=c,vt&&clearTimeout(vt),vt=setTimeout(()=>{const w=P.slice(-120);Xr("写作",w,ae()),P="",vt=null},500)))}function Fr(l,c){if(!c&&!lt&&!t(Tt))return;const w=String(l??r()??"");U&&clearTimeout(U),U=setTimeout(()=>{if(!c&&!lt&&!t(Tt))return;const x=nc(w);if(x){const $=Qe(x);$r.set($),Qn.set(!1)}},120)}function bi(){kt=[],et=0,Et=!1,f($t,!1),Jt=null,de=null,Wt+=1,f(Tt,!1),Mt&&(clearTimeout(Mt),Mt=null)}function as(){let l=26,c=14;return et>1600?(l=120,c=6):et>700?(l=72,c=8):et>260&&(l=46,c=11),Et&&(l=Math.max(l,140),c=Math.min(c,5)),{chunk:l,delayMs:c}}function Ls(l,c,w){mr.update(x=>{const $=String(x||""),j=w?$+c:Fi($,l,c);return Fr(j),j}),Nr(),wr(c)}function bs(l){if(l!==Wt)return;if(!kt.length){f($t,!1),Et=!1,Jt!==null&&(Z(Jt,de),Jt=null,de=null),f(Tt,!1);return}const c=kt[0],w=as(),x=c.text.slice(0,w.chunk);c.text=c.text.slice(x.length),et=Math.max(0,et-x.length),c.text||kt.shift(),x&&Ls(c.section,x,c.raw),Mt=setTimeout(()=>bs(l),w.delayMs)}function yi(){if(t($t)||!kt.length)return;f($t,!0),f(Tt,!0);const l=++Wt;bs(l)}function Xs(l,c,w){const x=String(c||"");x&&(kt.push({section:String(l||""),raw:!!w?.raw,text:x}),et+=x.length,yi())}function Z(l,c){const w=String(l||"");if(Nn=Date.now(),mr.set(w),c&&typeof c=="object"){const x=Qe(c);$r.set(x),Qn.set(!1)}else{const x=nc(w);if(x){const $=Qe(x);$r.set($),Qn.set(!1)}else $r.set(null),Qn.set(!0)}}function dt(l,c){if(Jt=String(l||""),de=c||null,!kt.length&&!t($t)){Z(Jt,de),Jt=null,de=null;return}Et=!0,yi()}let Vt=0;async function qt(l,c){const w=++Vt,x=Math.max(10,c?.chunk??36),$=Math.max(10,c?.delayMs??18);f(Tt,!0),Qn.set(!0),mr.set("");try{let j=0;for(;j<l.length;){if(w!==Vt)return;const B=l.slice(j,j+x);Nn=Date.now(),mr.update(Y=>{const G=String(Y||"")+B;return Fr(G),G}),wr(B),j+=x,await new Promise(Y=>setTimeout(Y,$))}if(w!==Vt)return;if(c?.finalDocIr&&typeof c.finalDocIr=="object"){const B=Qe(c.finalDocIr);$r.set(B),Qn.set(!1)}else Fr(l,!0)}finally{w===Vt&&f(Tt,!1)}}function ye(l,c,w){let x=String(l||"").replace(/\r/g,"");/^#\s+/m.test(x)||(x=`# ${c||"自动生成文档"}

`+x.trimStart());for(const $ of w||[]){const j=Xe(String($||"").trim());if(!j)continue;new RegExp(`^##\\s+${j.replace(/[.*+?^${}()|[\]\\\\]/g,"\\\\$&")}\\s*$`,"m").test(x)||(x=(x.trimEnd()+`

## ${j}

`).replace(/\n{4,}/g,`

`))}return x}function Xe(l){const c=String(l||"").trim(),w=/^H[23]::(.*)$/.exec(c);return(w?w[1]:c).trim()}function oe(l){return l.replace(/[.*+?^${}()|[\]\\/]/g,"\\$&")}const Vn="sec:",zn="doc:title";function Wn(l){return String(l||"").startsWith(Vn)}function rr(l){return String(l||"")===zn}function xe(l){return Wn(l)?String(l||"").slice(Vn.length).trim():""}function xr(l){const c=String(l||"").trim();return!c||Wn(c)||rr(c)?"":c}function Xn(l){return(l||[]).map(c=>xr(c)).filter(Boolean)}function Ni(l){return(l||[]).map(c=>xe(c)).filter(Boolean)}function ar(l){const c=String(l||"").trim().toLowerCase();if(!c)return"";if(/^#([0-9a-f]{3})$/.test(c)){const j=c.slice(1);return`#${j[0]}${j[0]}${j[1]}${j[1]}${j[2]}${j[2]}`}if(/^#([0-9a-f]{6})$/.test(c))return c;const w=/^rgba?\(([^)]+)\)$/.exec(c);if(!w)return"";const x=w[1].split(",").map(j=>Number(j.trim())).filter(j=>Number.isFinite(j));return x.length<3?"":`#${x.slice(0,3).map(j=>Math.max(0,Math.min(255,Math.round(j))).toString(16).padStart(2,"0")).join("")}`}function si(l){return(l||[]).map(c=>({...c}))}function wi(l){return(l||[]).map(c=>String(c||"").trim()).filter(Boolean).sort().join("|")}function xi(){Ai&&Ei.set(Ai,{tab:t(Lt),cmd:t(Qt),styleFontSize:t(je),styleLineHeight:t(Ee),styleFontFamily:t(Re),styleColor:t(Pe),styleBackground:t(er),styleAlign:t(wt),styleFontWeight:t(re),styleFontStyle:t($e),candidates:si(t(Rt)),activeIndex:t(gn),originalText:t(An),error:t(hn),dialogInput:t(ni)})}function Or(l){f(Lt,l.tab||"rewrite"),f(Qt,String(l.cmd||"")),f(je,String(l.styleFontSize||"")),f(Ee,String(l.styleLineHeight||"")),f(Re,String(l.styleFontFamily||"")),f(Pe,ar(l.styleColor||"")),f(er,ar(l.styleBackground||"")),f(wt,String(l.styleAlign||"")),f(re,String(l.styleFontWeight||"")),f($e,String(l.styleFontStyle||"")),f(Rt,si(l.candidates||[])),f(gn,Number.isFinite(l.activeIndex)?Math.max(0,l.activeIndex):0),f(An,String(l.originalText||t(pe)||"")),f(hn,String(l.error||"")),f(ni,String(l.dialogInput||""))}function Li(l){f(Lt,"rewrite"),f(je,String(l.fontSize||"")),f(Ee,String(l.lineHeight||"")),f(Re,String(l.fontFamily||"")),f(Pe,ar(String(l.color||""))),f(er,ar(String(l.background||l.backgroundColor||""))),f(wt,String(l.align||l.textAlign||"")),f(re,String(l.fontWeight||"")),f($e,String(l.fontStyle||"")),f(Qt,""),f(ee,!1),f(hn,""),f(An,t(pe)),f(Rt,[]),f(gn,0),f(ni,"")}function ai(l,c,w){return Math.min(w,Math.max(c,l))}function Ri(l){const c=(l||[]).map(G=>String(G||"").trim()).filter(Boolean);if(!c.length)return null;const w=document.querySelector(".editable");if(!w)return null;let x=Number.POSITIVE_INFINITY,$=Number.POSITIVE_INFINITY,j=0,B=0,Y=0;for(const G of c){let V=null;if(Wn(G)){const nt=xe(G);if(nt){const X=`[data-section-id="${CSS.escape(nt)}"]`;V=w.querySelector(X)}}else if(rr(G))V=w.querySelector('.wa-title[data-doc-title="1"]');else{const nt=xr(G);if(nt){const X=`[data-block-id="${CSS.escape(nt)}"]`;V=w.querySelector(X)}}if(!V)continue;const ht=V.getBoundingClientRect();x=Math.min(x,ht.left),$=Math.min($,ht.top),j=Math.max(j,ht.right),B=Math.max(B,ht.bottom),Y+=1}return Y?{left:x,top:$,right:j,bottom:B,width:Math.max(0,j-x),height:Math.max(0,B-$)}:null}function oi(){if(!t(he).length){f(qr,!1),f(In,!1);return}const l=Ri(t(he));if(!l){f(qr,!1),f(In,!1);return}const c=Math.min(560,window.innerWidth-24);f(is,ai(l.left,12,Math.max(12,window.innerWidth-c-12))),f(mi,ai(l.bottom+10,72,Math.max(72,window.innerHeight-56))),f(qr,!0);const w=Math.min(720,window.innerWidth-24);f(_r,ai(l.left,12,Math.max(12,window.innerWidth-w-12))),f(br,t(Kr)==="up"?ai(t(mi)-10,92,Math.max(92,window.innerHeight-80)):ai(t(mi)+50,92,Math.max(92,window.innerHeight-80)))}function Ye(l,c="down"){if(t(he).length){if(t(In)&&t(Lt)===l&&t(Kr)===c){f(In,!1);return}f(Lt,l),f(Kr,c),f(In,!0),oi()}}function Ke(){f(In,!1)}function ki(l){if(t(In)&&t(Lt)===l){f(In,!1);return}f(Lt,l),t(In)||(f(In,!0),oi())}function li(l){const c=l.detail||{};if(c.docIr&&typeof c.docIr=="object"){const w=Qe(c.docIr);$r.set(w),Qn.set(!1),dn=w}if(c.text){const w=String(c.text||"");mr.set(w),f(ue,w)}c.meta&&c.meta.action&&gt("Block updated","ok")}function os(l){const c=l.detail&&typeof l.detail=="object"?l.detail:{};f(Ct,{focused:!!c.focused,readonly:!!c.readonly,bold:!!c.bold,italic:!!c.italic,underline:!!c.underline,hasSelection:!!c.hasSelection,canUndo:!!c.canUndo,canRedo:!!c.canRedo,canCopy:!!c.canCopy,canCut:!!c.canCut,canPaste:!!c.canPaste})}function qi(l){const c=l.detail||{},w=Array.isArray(c.blockIds)?c.blockIds.map(V=>String(V||"").trim()).filter(Boolean):[],x=String(c.blockId||""),$=w.length?w:x?[x]:[],j=wi($),B=Ai;if(!$.length&&t(he).length){const V=document.activeElement;if(V&&(V.closest(".inline-edit-popover")||V.closest(".inline-selection-bar")||V.closest(".block-dialog")))return}B&&B!==j&&xi();const Y=Array.isArray(c.blocks)?c.blocks.map(V=>({id:String(V?.id||"").trim(),text:String(V?.text||""),style:V?.style&&typeof V.style=="object"?V.style:{},kind:["block","section","title"].includes(String(V?.kind||""))?String(V?.kind||""):"block",sectionId:String(V?.sectionId||"").trim(),sectionTitle:String(V?.sectionTitle||"").trim()})).filter(V=>V.id):[];f(he,$),f(be,Y.length?Y:$.map(V=>({id:V,text:String(c.text||""),style:{},kind:"block",sectionId:"",sectionTitle:""}))),En=$[0]||"",f(pe,t(be).length>1?t(be).map((V,ht)=>`[块${ht+1}] ${V.text}`.trim()).join(`

`):String(c.text||""));const G=c.style&&typeof c.style=="object"?c.style:{};if(f(Re,String(G.fontFamily||"")),f(je,String(G.fontSize||"")),f(Ee,String(G.lineHeight||"")),f(Pe,ar(String(G.color||""))),f(er,ar(String(G.background||G.backgroundColor||""))),f(wt,String(G.align||G.textAlign||"")),f(re,String(G.fontWeight||"")),f($e,String(G.fontStyle||"")),!$.length){Ai="",f(qr,!1),f(In,!1),f(An,""),f(Rt,[]),f(gn,0),f(hn,"");return}if(j!==B){const V=Ei.get(j);V?Or(V):Li(G),Ai=j}f(An,t(An)||t(pe)),requestAnimationFrame(()=>oi())}function ys(l,c,w){const x=new Set((c||[]).map(V=>String(V||"").trim()).filter(Boolean));if(!x.size)return null;const $=Array.isArray(l.sections)?l.sections:[];let j=!1;const B=V=>{const ht={...V};for(const[nt,X]of Object.entries(w)){const ut=String(X||"").trim();ut?ht[nt]=ut:delete ht[nt]}return ht},Y=V=>{let ht=!1;const X=(Array.isArray(V?.blocks)?V.blocks:[]).map(St=>{if(!x.has(String(St?.id||"")))return St;ht=!0,j=!0;const ze=St?.style&&typeof St.style=="object"?St.style:{};return{...St,style:B(ze)}}),ut=Array.isArray(V?.children)?V.children:[],st=ut.map(St=>Y(St)),_t=st.some((St,ze)=>St!==ut[ze]);if(!ht&&!_t)return V;const yt={...V};return ht&&(yt.blocks=X),_t&&(yt.children=st),yt},G=$.map(V=>Y(V));return j?{...l,sections:G}:null}function Xo(l,c,w){const x=new Set((c||[]).map(V=>String(V||"").trim()).filter(Boolean));if(!x.size)return null;const $=Array.isArray(l.sections)?l.sections:[];let j=!1;const B=V=>{const ht={...V};for(const[nt,X]of Object.entries(w)){const ut=String(X||"").trim();ut?ht[nt]=ut:delete ht[nt]}return ht},Y=V=>{let ht=!1,nt=V;const X=String(V?.id||"").trim();if(X&&x.has(X)){const yt=V?.style&&typeof V.style=="object"?V.style:{};nt={...nt,style:B(yt)},ht=!0}const ut=Array.isArray(V?.children)?V.children:[],st=ut.map(yt=>Y(yt));return st.some((yt,St)=>yt!==ut[St])&&(nt={...nt,children:st},ht=!0),ht&&(j=!0),ht?nt:V},G=$.map(V=>Y(V));return j?{...l,sections:G}:null}function Yo(l,c){const w=l.title_style,x=w&&typeof w=="object"?{...w}:{};let $=!1;for(const[j,B]of Object.entries(c)){const Y=String(B||"").trim();Y?String(x[j]||"")!==Y&&(x[j]=Y,$=!0):j in x&&(delete x[j],$=!0)}return $?{...l,title_style:x}:null}function o(l){if(!Gt("修改当前选中块"))return;const c=t(he).length?t(he):En?[En]:[];if(!c.length||!a())return;const w=Xn(c),x=Ni(c),$=c.includes(zn);let j=a(),B=!1;if(w.length){const Y=ys(j,w,l);Y&&(j=Y,B=!0)}if(x.length){const Y=Xo(j,x,l);Y&&(j=Y,B=!0)}if($){const Y=Yo(j,l);Y&&(j=Y,B=!0)}B&&(mt(j),requestAnimationFrame(()=>oi()),on().catch(()=>{}))}function v(){return t(he).length?t(he).slice():En?[En]:[]}function g(){return Xn(v())}function k(){const l=v();return l.length?g().length!==l.length:!1}function A(){return t(be).length>1?t(be).map((l,c)=>`[块${c+1}] ${l.text}`.trim()).join(`

`):t(be).length===1?String(t(be)[0].text||""):t(pe).trim()}function I(l){f(Lt,"assistant"),f(Se,!0);const c=v(),w=A(),x=String(l||"").trim();if(w&&c.length>0){const j=c.some(B=>Wn(B)||rr(B))?"请只修改我选中的标题或段落，不要改其他部分。":c.length>1?`请只修改我选中的 ${c.length} 个段落块，不要改其他段落。`:"请只修改我选中的这段内容，不要改其他段落。";zs.set(`${j}
${w}

修改要求：${x}`)}queueMicrotask(()=>{const $=document.querySelector(".assistant-dock .composer textarea");$&&$.focus()})}async function H(){if(!Gt("生成块改写候选"))return;const l=v(),c=g();if(!s()||!l.length)return;if(!c.length){f(hn,"当前选中为标题，建议在“样式设置”中修改，或直接在标题处输入。");return}if(c.length!==l.length){f(hn,"标题与正文混选时暂不支持候选生成，请只选段落块。");return}const w=t(Qt).trim();if(w){f(ee,!0),f(hn,""),f(Rt,[]);try{if(!a()||typeof a()!="object")throw new Error("文档尚未就绪");const x=a();if(f(An,A()),c.length===1){const $={block_id:c[0],instruction:w};a()&&($.doc_ir=a());const j=await fetch(`/api/doc/${s()}/block-edit/preview`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify($)});if(!j.ok)throw new Error(await j.text());const B=await j.json();f(An,String(B.before||t(pe)||""));const Y=Array.isArray(B.candidates)?B.candidates:[];f(Rt,Y.filter(G=>G&&typeof G=="object"&&G.doc_ir&&!G.error).map((G,V)=>({label:String(G.label||`方案${V+1}`),selectedAfter:R(String(G.selected_after||""),t(An)),selectedBefore:String(G.selected_before||t(An)||""),docIr:G.doc_ir,diff:G.diff})))}else{const $=[{label:"方案A",instruction:w},{label:"方案B",instruction:`${w}。请采用另一种表达方式，保持原意但在句式和组织上有明显差异。`}],j=[];for(const B of $){let Y=JSON.parse(JSON.stringify(x));const G=[],V=[];for(const ht of c){const nt={block_id:ht,instruction:B.instruction,doc_ir:Y,variants:[{label:B.label,instruction:B.instruction}]},X=await fetch(`/api/doc/${s()}/block-edit/preview`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(nt)});if(!X.ok)throw new Error(await X.text());const ut=await X.json(),st=Array.isArray(ut.candidates)?ut.candidates[0]:null;if(!st||!st.doc_ir)throw new Error(`未生成可用候选：${B.label}`);const _t=String(ut.before||""),yt=R(String(st.selected_after||""),_t);_t&&G.push(_t),yt&&V.push(yt),Y=st.doc_ir}j.push({label:B.label,selectedAfter:V.join(`

`),selectedBefore:G.join(`

`)||t(An),docIr:Y,diff:""})}f(Rt,j)}if(!t(Rt).length)throw new Error("没有生成可用候选版本");f(gn,0)}catch(x){f(hn,x instanceof Error?x.message:"候选生成失败")}finally{f(ee,!1)}}}function L(l){const c=t(Qt).trim();f(Qt,c?`${c}；${l}`:l),f(Lt,"rewrite")}function J(l){if(t(he).length){if((l.ctrlKey||l.metaKey)&&l.key==="Enter"){l.preventDefault();const c=l.shiftKey?"up":"down";Ye(t(Lt),c);return}l.key==="Escape"&&t(In)&&f(In,!1)}}function R(l,c){const w=String(l||"").trim();if(!w)return"";const x=String(c||"").trim();let $=w.replace(/^\s*```[a-zA-Z0-9_-]*\s*/g,"").replace(/\s*```\s*$/g,"").trim();const j=/(?:改写后(?:的)?(?:文本|版本)?|优化后(?:的)?(?:文本|版本)?|重写后(?:的)?(?:文本|版本)?|润色后(?:的)?(?:文本|版本)?|rewritten\s*text|revised\s*version|final\s*version)\s*[:：]\s*/gi;let B=null;for(;;){const G=j.exec($);if(!G)break;B=G}if(B&&B.index>=0&&($=$.slice(B.index+B[0].length).trim()),x&&$.startsWith(x)){const G=$.slice(x.length).replace(/^[\s:：\-—]+/,"");G.length>=4&&($=G)}const Y=$.split(/\n{2,}/).map(G=>G.trim()).filter(Boolean);if(x&&Y.length>=2){const G=Y.filter(V=>V!==x);G.length&&G.length<Y.length&&($=G.join(`

`))}return $.trim()}function z(l){const c=String(l?.selectedAfter||""),w=String(l?.selectedBefore||t(An)||""),x=c.length-w.length;return x===0?"长度不变":x>0?`增加 ${x} 字`:`减少 ${Math.abs(x)} 字`}function it(){f(Rt,[]),f(gn,0),f(hn,""),gt("已忽略本轮建议","info")}async function Q(l){if(!Gt("采纳候选改写"))return;const c=t(Rt)[l];if(!c||!s()||!c.docIr)return;const w=c.docIr;mt(w);try{await fetch(`/api/doc/${s()}/save`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({doc_ir:w})}),await fetch(`/api/doc/${s()}/version/commit`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:`块修改:${c.label}`,author:"user",kind:"minor"})}),gt(`已应用${c.label}`,"ok"),f(Rt,[]),f(gn,0),f(Qt,""),requestAnimationFrame(()=>oi()),await Ys()}catch(x){f(hn,x instanceof Error?x.message:"应用候选失败")}}function mt(l){const c=Qe(l);$r.set(c),Qn.set(!1),dn=c;const w=Ya(c)||"";mr.set(w),f(ue,w)}function at(l,c,w){if(!c)return null;const x=Array.isArray(l.sections)?l.sections:[];if(!x.length)return null;let $=!1;const j=Y=>{let G=!1;const V=Y.map(ht=>{let nt=!1,X=ht;const ut=Array.isArray(ht.blocks)?ht.blocks.slice():[],st=ut.findIndex(yt=>String(yt?.id||"")===c);st>=0&&(ut.splice(st+1,0,w),X={...X,blocks:ut},nt=!0);const _t=Array.isArray(ht.children)?ht.children:[];if(_t.length){const yt=j(_t);yt!==_t&&(X={...X,children:yt},nt=!0)}return nt&&(G=!0),nt?X:ht});return G&&($=!0),G?V:Y},B=j(x);return $?{...l,sections:B}:null}function xt(l,c){const w=Array.isArray(l.sections)?l.sections:[];if(!w.length)return null;const x=w[0],$=Array.isArray(x.blocks)?x.blocks.slice():[];$.push(c);const j={...x,blocks:$},B=w.slice();return B[0]=j,{...l,sections:B}}function It(l,c){if(!l||typeof l!="object")return;const w=a();if(!w||typeof w!="object")return;const x={id:Math.random().toString(36).slice(2),type:"figure",figure:l},$=Xn(c?.targetIds||[]),j=$.length?$[$.length-1]:"",B=j&&at(w,j,x)||xt(w,x);B&&mt(B)}function Ae(l){const c=a();if(!c||typeof c!="object")return;const w={id:Math.random().toString(36).slice(2),type:"table",table:{caption:"新建表格",columns:["列1","列2","列3"],rows:[["","",""],["","",""]]}},x=Xn(l?.targetIds||[]),$=x.length?x[x.length-1]:"",j=$&&at(c,$,w)||xt(c,w);j&&(mt(j),gt("已插入表格块，可直接编辑内容。","ok"))}const ot=new Map;async function ct(l){if(!l)return null;if(ot.has(l))return ot.get(l);try{const c=await fetch(`/api/text/${encodeURIComponent(l)}`);if(!c.ok)throw new Error(await c.text());const w=await c.json();return ot.set(l,w),w}catch{return null}}function Nt(l){if(!l)return"";const c=String(l.kind||""),w=String(l.format||"");if(w==="text")return String(l.text||"");if(w==="json"){const x=l.data||{};if(c==="list")return(Array.isArray(x.items)?x.items:[]).map(j=>`- ${String(j).trim()}`).join(`
`);if(c==="table")return`[[TABLE:${JSON.stringify(x)}]]`;if(c==="figure")return`[[FIGURE:${JSON.stringify(x)}]]`;if(x.text)return String(x.text)}return""}async function Yt(l,c){const w=await ct(c),x=Nt(w);x&&Xs(String(l||""),x,{raw:!l})}function zt(l){let c=String(l||"").replace(/\r/g,"");return c=c.replace(/(\n(?:-|\d+\.)[^\n]*)(?:\n{2,})(?=(?:-|\d+\.)\s)/g,`$1
`),c=c.replace(/\n{3,}/g,`

`),c}function Pt(l){const c=String(l||"").replace(/\r/g,"").trim();if(!c)return[];const w=c.split(/\n+/).map(j=>j.trim()).filter(Boolean),x=[],$=j=>{const B=String(j||"").trim();if(!B)return;if(B.length<=92){x.push(B);return}let Y=B.split(new RegExp("(?<=[。！？!?；;])(?=[^”’」』）》】\\]\\s])","g")).map(V=>V.trim()).filter(Boolean);if(Y.length<=1&&B.length>118){const V=[];for(let ht=0;ht<B.length;ht+=1){const nt=B[ht];(nt==="，"||nt===","||nt==="、")&&V.push(ht)}if(V.length){const ht=Math.floor(B.length/2);let nt=V[0],X=Number.POSITIVE_INFINITY;for(const _t of V){if(_t<24||_t>B.length-18)continue;const yt=Math.abs(_t-ht);yt<X&&(X=yt,nt=_t)}const ut=B.slice(0,nt+1).trim(),st=B.slice(nt+1).trim();Y=[ut,st].filter(Boolean)}}if(Y.length<=1){x.push(B);return}const G=[];for(const V of Y)V&&(G.length&&V.length<24?G[G.length-1]=`${G[G.length-1]}${V}`:G.push(V));x.push(...G.filter(Boolean))};for(const j of w.length?w:[c])$(j);return x.length?x:[c]}function Qe(l){const c=Array.isArray(l.sections)?l.sections:[];if(!c.length)return l;let w=!1;const x=(B,Y)=>{const G=String(B||"").trim(),V=String(Y||"").trim();if(!G||!V)return null;const ht=G.replace(/^\d+(?:\.\d+){0,3}\s*/,"").trim();if(!ht||ht.length>4)return null;const nt=/^([\u4e00-\u9fa5]{1,4})(自|是|在|由|通过|随着|并|可|将|会)([\s\S]*)$/.exec(V);if(!nt)return null;const X=String(nt[1]||"").trim();if(!X||X.length>3||ht.endsWith(X))return null;const ut=`${G}${X}`.trim(),st=`${String(nt[2]||"")}${String(nt[3]||"")}`.trim();return st?{title:ut,rest:st}:null},$=B=>{let Y=!1,G=B;const V=Array.isArray(B?.blocks)?B.blocks:[];if(V.length){const ut=V[0],st=String(ut?.type||"").toLowerCase();if(st==="paragraph"||st==="text"||st==="p"){const _t=x(String(B?.title||""),String(ut?.text||""));if(_t){const yt={...ut,text:_t.rest},St=V.slice();St[0]=yt,G={...G,title:_t.title,blocks:St},Y=!0,w=!0}}}const ht=Array.isArray(G?.blocks)?G.blocks:V,nt=[];for(const ut of ht){const st=String(ut?.type||"").toLowerCase(),_t=String(ut?.text||""),yt=Array.isArray(ut?.runs)?ut.runs:null;if((st==="paragraph"||st==="text"||st==="p")&&!yt&&_t.length>92){const St=Pt(_t);if(St.length>1){const ze=String(ut?.id||""),Ft=ze?ze.replace(/__\d+$/,""):Math.random().toString(36).slice(2),le=ut?.style&&typeof ut.style=="object"?{...ut.style}:{},Ce=St.length;St.forEach((ce,Ze)=>{const Ie={...le};Ce>1&&(Ze===0?Ie.marginBottom||(Ie.marginBottom="0"):(Ie.marginTop||(Ie.marginTop="0"),!Ie.indent&&!Ie.textIndent&&(Ie.indent="0"),Ze<Ce-1&&!Ie.marginBottom&&(Ie.marginBottom="0"))),nt.push({...ut,id:`${Ft}__${Ze+1}`,text:ce,style:Ie})}),w=!0,Y=!0;continue}}nt.push(ut)}Y&&(G={...G,blocks:nt});const X=Array.isArray(B?.children)?B.children:[];if(X.length){const ut=X.map(_t=>$(_t));ut.some((_t,yt)=>_t!==X[yt])&&(G={...G,children:ut},w=!0)}return G},j=c.map(B=>$(B));return w?{...l,sections:j}:l}function Fi(l,c,w){const x=Xe(c),$=String(w||"").replace(/\r/g,"");if(!$||!$.trim()&&!$.includes(`
`))return String(l||"");if(!x){const _t=String(l||"").replace(/\r/g,""),yt=_t+(_t.endsWith(`
`)||!_t?"":`
`)+$;return zt(yt)}let j=String(l||"").replace(/\r/g,"");const B=new RegExp(`^##\\s+${oe(x)}\\s*$`,"m");B.test(j)||(j=ye(j,"",[x]));const Y=B.exec(j);if(!Y){const _t=j+(j.endsWith(`
`)?"":`
`)+$;return zt(_t)}const G=Y.index+Y[0].length,ht=j.slice(G).search(/^##\s+/m),nt=ht>=0?G+ht:j.length,X=j.slice(0,nt),ut=j.slice(nt),st=X+$+ut;return zt(st)}function ws(l){const c=String(l||"").replace(/\r/g,"").split(`
`);let w="message";const x=[];for(const B of c)B.startsWith("event:")&&(w=B.slice(6).trim()),B.startsWith("data:")&&x.push(B.slice(5).trim());const $=x.join(`
`);let j={};try{j=$?JSON.parse($):{}}catch{j={raw:$}}return{event:w,data:j}}async function va(l,c,w,x){const $=await fetch(l,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c),signal:x});if(!$.ok){const V=await $.text()||$.statusText||"请求失败";throw new Error(`HTTP ${$.status}: ${V}`)}if(!$.body)throw new Error("当前环境不支持流式输出");const j=$.body.getReader(),B=new TextDecoder("utf-8");let Y="";for(;;){const{value:G,done:V}=await j.read();if(V)break;Y+=B.decode(G,{stream:!0});let ht=Y.indexOf(`

`);for(;ht>=0;){const nt=Y.slice(0,ht);if(Y=Y.slice(ht+2),nt.trim()){const{event:X,data:ut}=ws(nt);w(X,ut)}ht=Y.indexOf(`

`)}}}async function Rs(){const l=s();if(l){Ua.set(!0);try{const c=await fetch(`/api/doc/${l}`);if(!c.ok)throw new Error(await c.text());const w=await c.json();if(mr.set(String(w.text||"")),f(ue,String(w.text||"")),Zt=t(ue),f(fe,Pn(w.resume_state)),f(ft,xs(w.feedback_log)),await co(),await uo(),w.doc_ir&&typeof w.doc_ir=="object"){const x=Qe(w.doc_ir);$r.set(x),Qn.set(!1),dn=x}else $r.set(null),dn=null;Ys().catch(()=>{})}catch(c){gt(`加载失败: ${c instanceof Error?c.message:"未知错误"}`,"error")}finally{Ua.set(!1)}}}function xs(l){const c=Array.isArray(l)?l:[],w=[];for(const x of c){if(!x||typeof x!="object")continue;const $=Number(x.rating||0);if(!Number.isFinite($)||$<1||$>5)continue;const j=String(x.id||"").trim()||`${Date.now()}-${Math.random()}`,B=String(x.note||"").trim(),Y=String(x.stage||"general").trim()||"general",G=Number(x.created_at||0),V=Number.isFinite(G)&&G>0?G:Date.now()/1e3,nt=(Array.isArray(x.tags)?x.tags:[]).map(X=>String(X||"").trim()).filter(Boolean);w.push({id:j,rating:$,note:B,stage:Y,tags:nt,created_at:V})}return w.sort((x,$)=>$.created_at-x.created_at),w.slice(0,80)}async function pa(){const l=s();if(l)try{const c=await fetch(`/api/doc/${l}/feedback`);if(!c.ok)return;const w=await c.json();f(ft,xs(w.items))}catch{}}function ao(l){const c=Number(l||0);return!Number.isFinite(c)||c<=0?"--":new Date(c*1e3).toLocaleString()}async function Oa(){const l=s();if(!l||t(Rn))return;if(!Number.isFinite(t(Ht))||t(Ht)<1||t(Ht)>5){gt("请选择 1-5 分满意度","info");return}f(Rn,!0),f(qn,0);const c={item:{rating:t(Ht),stage:t(pn),note:String(t(Ar)||"").trim(),created_at:Date.now()/1e3},context:{doc_status:String(m()||""),flow_status:String(h()||""),char_count:String(r()||"").replace(/\s/g,"").length,word_count:Number(y()||0),instruction_preview:String(S()||"").trim().slice(0,400)}};try{const w=await fetch(`/api/doc/${l}/feedback`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)});if(!w.ok)throw new Error(await w.text());const x=await w.json();f(ft,xs(x.items));const $=Number(x.low_recorded||0);f(qn,Number.isFinite($)?$:0),t(qn)>0?gt("已记录低满意度样本，后续可用于学习改进。","info"):gt("满意度已提交","ok"),f(Ar,"")}catch(w){const x=w instanceof Error?w.message:"提交失败";gt(`满意度提交失败: ${x}`,"bad")}finally{f(Rn,!1)}}function oo(l){const c=String(l||"");if(!c.trim())return[];const w=c.split(/[,\n;\s]+/).map($=>String($||"").trim()).filter(Boolean),x=[];for(const $ of w)x.includes($)||x.push($);return x.slice(0,50)}function ks(l){const c=Number(l||0);return Number.isFinite(c)?Math.max(0,Math.min(1,c)):0}function Qo(l){const c=ks(l);return c>=.7?"高风险":c>=.45?"中风险":c>=.2?"低风险":"很低"}async function lo(){const l=s();if(!l||t(Le))return;const c=oo(t(tn)),w=String(t(ur)||"").trim();if(!c.length&&!w){gt("请至少提供一个对比文档ID或粘贴参考文本","info");return}f(Le,!0),f(yn,[]),f(sr,0),f(Fn,0);try{const x={threshold:Math.max(.05,Math.min(.95,Number(t(jn)||.35))),reference_doc_ids:c};w&&(x.reference_texts=[{id:"manual_text",title:"手动粘贴文本",text:w}]);const $=await fetch(`/api/doc/${l}/plagiarism/check`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(x)});if(!$.ok)throw new Error(await $.text());const j=await $.json(),B=Array.isArray(j?.results)?j.results:[];f(yn,B.map(Y=>({reference_id:String(Y?.reference_id||""),reference_title:String(Y?.reference_title||""),score:ks(Y?.score),threshold:ks(Y?.threshold||x.threshold),suspected:!!Y?.suspected,metrics:Y?.metrics&&typeof Y.metrics=="object"?Y.metrics:{},evidence:Array.isArray(Y?.evidence)?Y.evidence:[]}))),f(sr,Number(j?.flagged_count||0)||0),f(Fn,ks(j?.max_score||0)),t(yn).length===0?gt("查重完成：没有可分析的参考文本","info"):t(sr)>0?gt(`查重完成：发现 ${t(sr)} 个疑似高重复来源`,"bad"):gt("查重完成：未发现超阈值重复来源","ok")}catch(x){const $=x instanceof Error?x.message:"查重失败";gt(`查重失败: ${$}`,"bad")}finally{f(Le,!1)}}async function co(){const l=s();if(l)try{const c=await fetch(`/api/doc/${l}/plagiarism/library_scan/latest`);if(!c.ok)return;const w=await c.json();f(wn,w?.has_report&&w.latest||null)}catch{}}async function uo(){const l=s();if(l)try{const c=await fetch(`/api/doc/${l}/ai_rate/latest`);if(!c.ok)return;const w=await c.json();f(Kt,w?.has_latest&&w.latest||null)}catch{}}async function fo(){const l=s();if(l&&!t(en)){f(en,!0);try{const c={threshold:Math.max(.05,Math.min(.95,Number(t(Cr)||.65)))},w=await fetch(`/api/doc/${l}/ai_rate/check`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)});if(!w.ok)throw new Error(await w.text());const x=await w.json();f(Kt,x);const $=Number(x?.ai_rate_percent||0),j=String(x?.risk_level||"");x?.suspected_ai?gt(`AI率检测完成：${$}%（${j}）`,"bad"):gt(`AI率检测完成：${$}%（${j}）`,"ok")}catch(c){const w=c instanceof Error?c.message:"AI率检测失败";gt(`AI率检测失败: ${w}`,"bad")}finally{f(en,!1)}}}async function vo(){const l=s();if(l&&!t(an)){f(an,!0);try{const c={include_all_docs:!0,threshold:Math.max(.05,Math.min(.95,Number(t(jn)||.35))),top_k:30,max_docs:120},w=String(t(ur)||"").trim();w&&(c.reference_texts=[{id:"manual_text",title:"手动粘贴文本",text:w}]);const x=await fetch(`/api/doc/${l}/plagiarism/library_scan`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)});if(!x.ok)throw new Error(await x.text());const $=await x.json();f(wn,{report_id:String($?.report_id||""),created_at:Number($?.created_at||0),threshold:Number($?.threshold||c.threshold),source_chars:Number($?.source_chars||0),flagged_count:Number($?.flagged_count||0),total_references:Number($?.total_references||0),max_score:Number($?.max_score||0),suspected:!!$?.suspected,paths:$?.paths&&typeof $.paths=="object"?$.paths:{}});const j=Array.isArray($?.results)?$.results:[];f(yn,j.map(B=>({reference_id:String(B?.reference_id||""),reference_title:String(B?.reference_title||""),score:ks(B?.score),threshold:ks(B?.threshold||c.threshold),suspected:!!B?.suspected,metrics:B?.metrics&&typeof B.metrics=="object"?B.metrics:{},evidence:Array.isArray(B?.evidence)?B.evidence:[]}))),f(sr,Number($?.flagged_count||0)||0),f(Fn,ks($?.max_score||0)),gt(`全库查重完成：来源 ${t(wn).total_references}，超阈值 ${t(wn).flagged_count}`,t(wn).flagged_count>0?"bad":"ok")}catch(c){const w=c instanceof Error?c.message:"全库查重失败";gt(`全库查重失败: ${w}`,"bad")}finally{f(an,!1)}}}function ma(l){const c=s();if(!c)return;const w=String(t(wn)?.report_id||"").trim();if(!w){gt("暂无可下载的查重报告","info");return}window.location.href=`/api/doc/${c}/plagiarism/library_scan/download?report_id=${encodeURIComponent(w)}&format=${l}`}function Pa(l){const c=[],w=Array.isArray(l?.sections)?l.sections:[],x=$=>{c.push($),(Array.isArray($?.children)?$.children:[]).forEach(B=>x(B))};return w.forEach($=>x($)),c}function Ha(l){const c=Math.max(1,Math.min(6,Number(l?.level||1))),w=String(l?.title||"").trim(),x=l?.style&&typeof l.style=="object"?JSON.stringify(l.style):"";return`${c}:${w}:${x}`}function po(l){const c=String(l?.type||"paragraph").toLowerCase(),w=l?.style&&typeof l.style=="object"?l.style:null,x=Array.isArray(l?.runs)?l.runs:null;if(c==="list"){const B=Array.isArray(l?.items)?l.items:[],Y=!!l?.ordered,G={type:"list",items:B,ordered:Y};return w&&(G.style=w),x&&(G.runs=x),G}if(c==="table"){const B={type:"table",table:l?.table||{}};return w&&(B.style=w),x&&(B.runs=x),B}if(c==="figure"){const B={type:"figure",figure:l?.figure||{}};return w&&(B.style=w),x&&(B.runs=x),B}const j={type:"paragraph",text:String(l?.text||"")};return w&&(j.style=w),x&&(j.runs=x),j}function mo(l){const c=String(l?.type||"paragraph").toLowerCase(),w=l?.style?`:style=${JSON.stringify(l?.style||{})}`:"",x=l?.runs?`:runs=${JSON.stringify(l?.runs||[])}`:"";return c==="list"?`list:${JSON.stringify(l?.items||[])}:${!!l?.ordered}${w}`:c==="table"?`table:${JSON.stringify(l?.table||{})}${w}`:c==="figure"?`figure:${JSON.stringify(l?.figure||{})}${w}`:`paragraph:${String(l?.text||"")}${w}${x}`}function _n(l,c){if(!l||!c)return null;const w=Pa(l),x=Pa(c);if(w.length!==x.length)return null;for(let j=0;j<w.length;j++)if(Ha(w[j])!==Ha(x[j])||!w[j]?.id)return null;const $=[];for(let j=0;j<w.length;j++){const B=w[j],Y=x[j],G=Array.isArray(B?.blocks)?B.blocks:[],V=Array.isArray(Y?.blocks)?Y.blocks:[],ht=G.map(St=>String(St?.id||"")).filter(Boolean),nt=V.map(St=>String(St?.id||"")).filter(Boolean),X=new Set(ht),ut=new Set(nt),st=new Map(G.map(St=>[String(St?.id||""),St]));for(const St of ht)ut.has(St)||$.push({op:"delete",target_id:St});const _t=nt.filter(St=>X.has(St)),yt=ht.filter(St=>ut.has(St));_t.forEach((St,ze)=>{const Ft=yt.indexOf(St);Ft!==-1&&Ft!==ze&&($.push({op:"move",target_id:St,parent_id:String(B.id),index:ze}),yt.splice(Ft,1),yt.splice(ze,0,St))}),V.forEach((St,ze)=>{const Ft=String(St?.id||"");if(Ft&&X.has(Ft)){const Ce=st.get(Ft);Ce&&mo(Ce)!==mo(St)&&$.push({op:"update",target_id:Ft,payload:po(St)});return}const le=po(St);$.push({op:"insert",parent_id:String(B.id),index:ze,payload:le})})}return $}async function xn(){const l=s();if(!l||!i()||pi)return;const c=String(r()||"");if(!(!c.trim()||c===Zt)){pi=!0;try{(await fetch(`/api/doc/${l}/save`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:c})})).ok&&(Zt=c)}catch{}finally{pi=!1}}}function Nr(){i()&&(Dr&&clearTimeout(Dr),Dr=setTimeout(()=>{xn()},1600))}async function on(){const l=s();if(l)try{if(a()&&!b()&&dn){const w=_n(dn,a());if(w&&w.length>0){const x=await fetch(`/api/doc/${l}/doc_ir/ops`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({ops:w})});if(x.ok){const $=await x.json();if($.doc_ir&&typeof $.doc_ir=="object"){const j=Qe($.doc_ir);$r.set(j),Qn.set(!1),dn=j}if($.text){const j=String($.text||"");mr.set(j),f(ue,j),Zt=j}else f(ue,r()),Zt=r();gt("已保存","ok");return}}else if(w&&w.length===0){f(ue,r()),Zt=r(),dn=a();return}}const c={text:r()};!b()&&a()&&(c.doc_ir=a()),await fetch(`/api/doc/${l}/save`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)}),f(ue,r()),Zt=r(),!b()&&a()?dn=a():dn=null,gt("已保存","ok")}catch(c){gt(`保存失败: ${c instanceof Error?c.message:"未知错误"}`,"error")}}function ln(l){if(!l)return"";try{return new Date(l*1e3).toLocaleString()}catch{return String(l)}}function Gi(l){if(!l||typeof l!="object")return"";const c=Number(l.insert||0),w=Number(l.delete||0),x=Number(l.replace||0),$=[];return c&&$.push(`新增${c}`),x&&$.push(`修改${x}`),w&&$.push(`删除${w}`),$.join(" / ")}function ho(l){const c=[];let w=null;return l.forEach(x=>{const $=Array.isArray(x?.tags)?x.tags:[];(x?.kind||($.includes("major")?"major":$.includes("minor")?"minor":""))==="major"||!w?(w={major:x,minors:[]},c.push(w)):w.minors.push(x)}),c}async function Ys(){if(s()){f(Rr,!0),f(te,"");try{const l=await fetch(`/api/doc/${s()}/version/log?branch=main&limit=50`);if(!l.ok)throw new Error(await l.text());const c=await l.json();se=Array.isArray(c.versions)?c.versions:[],f(ve,ho(se))}catch(l){f(te,l instanceof Error?l.message:"加载失败")}finally{f(Rr,!1)}}}async function fd(){if(!s())return;const l=t(Ge).trim()||"定稿版本";try{const c=await fetch(`/api/doc/${s()}/version/commit`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:l,author:"user",kind:"major"})});if(!c.ok)throw new Error(await c.text());f(Ge,""),await Ys(),gt("已提交版本","ok")}catch(c){gt(`提交失败: ${c instanceof Error?c.message:"未知错误"}`,"error")}}async function Tc(l){if(!(!s()||!l))try{const c=await fetch(`/api/doc/${s()}/version/checkout`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({version_id:l})});if(!c.ok)throw new Error(await c.text());const w=await c.json(),x=String(w.doc_text||"");Z(x),f(ue,x),await Ys(),gt("已切换版本","ok")}catch(c){gt(`切换失败: ${c instanceof Error?c.message:"未知错误"}`,"error")}}async function dd(l,c){if(!(!s()||!l||!c)){f(nn,"");try{const w=await fetch(`/api/doc/${s()}/version/diff?from_version=${l}&to_version=${c}`);if(!w.ok)throw new Error(await w.text());const x=await w.json(),$=Array.isArray(x.diff)?x.diff:[];f(nn,$.join(`
`))}catch(w){f(nn,w instanceof Error?w.message:"对比失败")}}}async function jc(l){if(!l)return;const c=se.find(w=>w.is_current);!c||c.version_id===l||await dd(c.version_id,l)}async function Ec(l){if(!s())return!1;try{const c=await fetch(`/api/doc/${s()}/export/check?format=${l}&auto_fix=1`);if(!c.ok){const B=await c.text();return gt(`导出校验失败: ${B||c.statusText}`,"bad"),!1}const w=await c.json(),x=!!w?.can_export,$=Array.isArray(w?.issues)?w.issues:[];if((Array.isArray(w?.warnings)?w.warnings:[]).length>0&&gt("导出前已自动修复文档结构。","info"),!x){const B=$[0],Y=String(B?.message||"导出前校验未通过");return $.some(V=>String(V?.code||"").startsWith("citation_"))?(f(vn,!0),gt(`${Y} 已自动打开“引用”面板，请先点击“核验引用”。`,"bad")):gt(Y,"bad"),!1}return!0}catch(c){return gt(`导出校验失败: ${c instanceof Error?c.message:"未知错误"}`,"bad"),!1}}async function vd(){!s()||!await Ec("pdf")||(gt("正在生成PDF...","info"),window.location.href=`/download/${s()}.pdf`)}function pd(l){f(ei,!1),window.location.href=`/workbench/${l}`}async function md(){!s()||!await Ec("docx")||(gt("正在生成Word文档...","info"),window.location.href=`/download/${s()}.docx`)}async function hd(){if(!t(fe)||i())return;const l=String(t(fe).user_instruction||t(fe).request_instruction||"").trim();if(!l){gt("没有可续跑的历史指令","info");return}await go(l,{fromResume:!0,forcedComposeMode:"continue",resumeSections:t(fe).pending_sections||[],cursorAnchor:t(fe).cursor_anchor||""})}function gd(l){const c=String(l?.name||"").toLowerCase();return String(l?.type||"").startsWith("image/")||/\.(png|jpe?g|gif|bmp|webp|svg)$/i.test(c)}async function Ac(l,c){if(!s()||!l)return;const w=new FormData;w.append("file",l,l.name);const x=c?.source||"assistant",$=gd(l);if(x==="inline-image"&&!$){gt("选中段落插图仅支持图片文件。","info");return}try{gt($?"正在上传图片...":"正在上传文件...","info");const j=await fetch(`/api/doc/${s()}/upload`,{method:"POST",body:w});if(!j.ok)throw new Error(await j.text());const B=await j.json(),Y=String(B.kind||"");if(x==="inline-image"&&$){const G=l.name.replace(/\.[^.]+$/,"");It({caption:G,source:"upload",filename:l.name},{targetIds:c?.targetIds||[]}),on().catch(()=>{}),gt("图片上传成功，已插入选中内容后。","ok"),Hr("system",`已插入图片：${l.name}`);return}if(Y==="template")gt("模板文件上传成功，已解析结构。","ok"),Hr("system",`模板已上传并解析：${l.name}`);else{const G=$?"图片已上传到资料库。若要插入正文，请选中段落后点击“插图”。":"文件上传成功，已纳入资料库。";gt(G,"ok"),Hr("system",`${G}（${l.name}）`)}}catch(j){const B=j instanceof Error?j.message:"上传失败";gt(B,"bad")}}function Cc(){t(he).length&&Gt("插图")&&(Kn=t(he).slice(),t(fr)?.click())}function Ic(){t(he).length&&Gt("插表")&&(Ae({targetIds:t(he).slice()}),on().catch(()=>{}))}async function _d(l){const c=l.currentTarget,w=c?.files?.[0],x=Kn.slice();Kn=[],w&&await Ac(w,{source:"inline-image",targetIds:x}),c&&(c.value="")}async function bd(l){const c=l?.detail?.file;c&&await Ac(c,{source:"assistant"})}async function go(l,c){const w=String(l||"").trim();if(!w)return;if(Gr()){c?.fromQueue||(Hr("user",w),zs.set(""),yr(w));return}if(!s()){const nt="缺少文档ID，请刷新或从 /workbench/{id} 进入";ui.set(`已中止: ${nt}`),Xr("中止",nt,new Date().toLocaleTimeString()),gt(nt,"info");return}c?.fromQueue?Hr("system","正在执行排队指令…"):c?.fromResume?Hr("system","正在续跑上次中断任务…"):(Hr("user",w),zs.set("")),Pr("commit");const x=String(r()||""),$=_s(x),j=_i(w);let B=c?.forcedComposeMode||j||"auto";!c?.forcedComposeMode&&!j&&$&&(c?.fromQueue?B="continue":B=window.confirm(`检测到编辑区已有内容。
确定：在当前内容基础上续写
取消：覆盖重写当前文档`)?"continue":"overwrite");let Y=w;!j&&B==="continue"?Y=`请在保留现有内容结构和已写段落的前提下继续写作，不要删除或改写已有内容。

用户需求：${w}`:!j&&B==="overwrite"&&(Y=`请忽略当前已有正文，按用户需求从头完整重写，并用新内容覆盖旧内容。

用户需求：${w}`);const G=Ir(c?.resumeSections||[]),V=String(c?.cursorAnchor||"").trim();f(fe,{status:"running",updated_at:Date.now()/1e3,user_instruction:w,request_instruction:Y,compose_mode:B,partial_chars:String(r()||"").trim().length,partial_preview:String(r()||"").trim().slice(-240),plan_sections:G,completed_sections:[],pending_sections:G,cursor_anchor:V,error:""}),Vt+=1,bi(),ii(),Ps.set(!0),Qn.set(!0),lt=!0,xa.set("分析"),ui.set("生成中…"),Be=Date.now(),ke="",un="",Bt=!1,pt=!1,jt=!1,Dt=Date.now(),Nn=Date.now(),bt=!1,f(At,{current:0,total:0,percent:0,etaS:0,section:""}),ne=Date.now(),Oe=[],mn=0,f(_e,[]),Xr("启动","开始生成",new Date().toLocaleTimeString()),E=new AbortController,Ua.set(!1),De&&clearInterval(De),De=setInterval(()=>{if(!i())return;const nt=Date.now()-Dt,X=Oe.length>0?Math.round(Oe.reduce((_t,yt)=>_t+yt,0)/Oe.length):0;let ut=Math.max(fn,X*6||0,mn*3||0,9e4);ut=Math.min(6e5,ut),(/model preparing/i.test(un)||/解析中/.test(un)||ke==="analysis")&&(ut=Math.max(ut,18e4)),nt>ut&&!bt&&(bt=!0,E?.abort(`客户端超时：${Math.round(nt/1e3)}秒无事件，切换非流式生成`))},1e3);const ht={instruction:Y,text:x,compose_mode:B};G.length>0&&(ht.resume_sections=G),V&&(ht.cursor_anchor=V);try{if(await va(`/api/doc/${s()}/generate/stream`,ht,(nt,X)=>{const ut=Date.now();if(ke=String(nt||""),Dt>0&&(Xt=ut-Dt,Xt>0&&Xt<12e4&&(Oe=[...Oe,Xt].slice(-8)),Xt>mn&&Xt<6e5&&(mn=Xt)),Dt=ut,nt==="state"){const st=Gn(String(X.name||""));xa.set(st||h()),Xr("流程",st,ae());return}if(nt==="delta"){const st=String(X.delta||"").trim();st&&(ui.set(st),un=st,Xr("进度",st,ae()));return}if(nt==="plan"){const st=String(X.title||"自动生成文档"),yt=(Array.isArray(X.sections)?X.sections:[]).map(ze=>Xe(String(ze||""))).filter(Boolean);t(fe)&&f(fe,{...t(fe),plan_sections:yt,completed_sections:[],pending_sections:yt}),Xr("大纲",`标题：${st}；章节：${yt.join(" / ")}`,ae());const St=ye(r(),st,yt);mr.set(St),Fr(St);return}if(nt==="section"){const st=String(X.phase||""),_t=String(X.section_key||X.section||"");if((st==="start"||st==="end")&&Ki(_t,st),st==="end"){const yt=Xe(String(_t||"")).trim();if(t(fe)&&yt){const St=Ir([...t(fe).completed_sections,yt]),Ft=(t(fe).plan_sections||[]).filter(le=>!St.includes(le));f(fe,{...t(fe),completed_sections:St,pending_sections:Ft})}}if(st==="delta"){jt=!0;const yt=String(X.block_id||""),St=String(X.block_type||"");if(yt){Yt(_t,yt);return}const ze=String(X.delta||"");ze&&Xs(_t,ze,{raw:!_t&&!St})}return}if(nt==="progress"){const st=Number(X.current||0),_t=Number(X.total||0),yt=Number(X.percent||0),St=Xe(String(X.section||"")),ze=Number(X.elapsed_s||0);if(ne===0&&(ne=Date.now()),st>0){const le=(ze>0?ze:Math.max(1,Math.round((Date.now()-ne)/1e3)))/st,Ce=Math.max(0,Math.round(le*Math.max(0,_t-st)));f(At,{current:st,total:_t,percent:yt,etaS:Ce,section:St})}else f(At,{current:st,total:_t,percent:yt,etaS:0,section:St});return}if(nt==="section_error"){const st=String(X.section||""),_t=String(X.reason||"unknown");st&&(f(_e,[...t(_e),{section:st,reason:_t}]),gt(`章节失败: ${st}`,"bad"));return}if(nt==="analysis"){const st=String(X.summary||""),_t=Array.isArray(X.steps)?X.steps:[],yt=Array.isArray(X.missing)?X.missing:[];if(Op.set(st||"等待解析…"),Pp.set(_t),Hp.set(yt),Xr("解析",st||"解析完成",ae()),X.raw){const St=JSON.stringify(X.raw,null,2).slice(0,600);Xr("解析JSON",St,ae())}return}if(nt==="final"){const st=String(X.text||"");if(jt){const _t=X.doc_ir&&typeof X.doc_ir=="object"?X.doc_ir:null;dt(st,_t)}else{const _t=X.doc_ir&&typeof X.doc_ir=="object"?X.doc_ir:null;qt(st,{finalDocIr:_t})}ui.set("完成"),xa.set("完成"),Bt=!0,f(fe,null),Hr("system","已完成生成。"),Xr("完成","生成完成",ae()),gt("生成完成","ok"),on().catch(()=>{});return}if(nt==="error"){const st=String(X.message||X.reason||X.detail||"服务端未返回具体原因"),yt=String(X.code||X.type||"").toLowerCase().includes("abort")||/aborted|stopped|取消|中止/i.test(st);pt=!0,ui.set(yt?`已中止: ${st}`:`生成失败: ${st}`),Hr("system",st),Xr(yt?"中止":"错误",st,ae()),gt(st,yt?"info":"bad")}},E.signal),!Bt&&!pt){const nt=un?`流式结束但未完成，最后进度: ${un}`:ke?`流式结束但未完成，最后事件: ${ke}`:"流式结束但未完成，服务端未返回原因";ui.set(`已中止: ${nt}`),Hr("system",nt),Xr("中止",nt,ae()),gt(nt,"info")}}catch(nt){if(String(nt?.name||"")==="AbortError"){const X=E?.signal?.reason||nt?.message||"用户中止";if(String(X).includes("切换非流式生成")){Xr("中止",String(X),ae()),gt(String(X),"info");try{const ut=await fetch(`/api/doc/${s()}/generate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(ht)});if(!ut.ok){const yt=await ut.text();throw new Error(`HTTP ${ut.status}: ${yt||ut.statusText}`)}const st=await ut.json(),_t=String(st.text||"");if(jt){const yt=st.doc_ir&&typeof st.doc_ir=="object"?st.doc_ir:null;dt(_t,yt)}else{const yt=st.doc_ir&&typeof st.doc_ir=="object"?st.doc_ir:null;qt(_t,{finalDocIr:yt})}ui.set("完成"),xa.set("完成"),f(fe,null),Hr("system","已完成生成（非流式兜底）。"),Xr("完成","非流式生成完成",ae()),gt("生成完成（非流式）","ok"),on().catch(()=>{})}catch(ut){const st=ut?.message||"非流式生成失败";ui.set(`生成失败: ${st}`),Hr("system",st),Xr("错误",String(st),ae()),gt(String(st),"bad")}}else ui.set(`已中止: ${X}`),Hr("system",`已中止生成：${X}`),Xr("中止",String(X),ae()),gt(String(X),"info")}else{const X=nt?.message||"生成失败，请检查模型是否运行。";ui.set(`生成失败: ${X}`),Hr("system",X),Xr("错误",String(X),ae()),gt(String(X),"bad")}}finally{if(!Bt){const nt=String(r()||"").trim(),X=t(fe);f(fe,{status:"interrupted",updated_at:Date.now()/1e3,user_instruction:String(X?.user_instruction||w),request_instruction:String(X?.request_instruction||Y),compose_mode:X?.compose_mode||B,partial_chars:nt.length,partial_preview:nt.slice(-240),plan_sections:Ir(X?.plan_sections||[]),completed_sections:Ir(X?.completed_sections||[]),pending_sections:Ir(X?.pending_sections||[]),cursor_anchor:String(X?.cursor_anchor||V),error:String(m()||"")}),xn()}if(Ps.set(!1),Ua.set(!1),lt=!1,ii(),Dr&&(clearTimeout(Dr),Dr=null),U&&(clearTimeout(U),U=null),De&&(clearInterval(De),De=null),mn>0&&typeof localStorage<"u"){const nt=Math.min(6e5,Math.max(fn,mn*3,9e4));fn=nt;try{localStorage.setItem("wa_idle_base_ms",String(nt))}catch{}}E=null,t(rn).length&&queueMicrotask(()=>{Hn()})}}async function yd(l){const c=s(),w=String(l||"").trim();if(!(!c||!w||i())){Pr("commit"),await on().catch(()=>{}),Ps.set(!0),ui.set(`重试章节：${w}`);try{const x=await fetch(`/api/doc/${c}/generate/section`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({section:w,instruction:String(S()||"").trim()})});if(!x.ok)throw new Error(await x.text());const $=await x.json(),j=String($.text||"");if(j&&(mr.set(j),ui.set("完成"),Hr("system",`章节重试完成：${w}`)),$.doc_ir&&typeof $.doc_ir=="object"){const B=Qe($.doc_ir);$r.set(B),Qn.set(!1)}else j&&Qn.set(!0);f(_e,t(_e).filter(B=>B.section!==w)),gt(`章节重试完成: ${w}`,"ok"),on().catch(()=>{})}catch(x){const $=x instanceof Error?x.message:"章节重试失败";ui.set(`重试失败: ${$}`),gt(`章节重试失败: ${$}`,"bad")}finally{Ps.set(!1)}}}function wd(){E&&E.abort("用户点击停止")}function Pr(l){Do.set(l)}qa(()=>{const l=localStorage.getItem("darkMode")==="true";Nu.set(l),l&&document.body.classList.add("dark");const c=localStorage.getItem("wa_idle_base_ms");if(c){const j=Number(c);Number.isFinite(j)&&j>0&&(fn=j)}ss();const w=j=>{if(!Br)return;const B=document.querySelector(".grid");if(!B)return;const Y=B.getBoundingClientRect(),G=Math.min(Math.max(j.clientX-Y.left,220),Y.width-260);Math.round(G/Y.width*100)},x=()=>{Br=!1,document.body.style.cursor=""},$=()=>{oi()};if(window.addEventListener("mousemove",w),window.addEventListener("mouseup",x),window.addEventListener("resize",$),window.addEventListener("scroll",$,!0),window.addEventListener("keydown",J),!s()){const j=He();j&&(Ms.set(j),Rs().then(()=>Promise.all([zp(),Wp(),pa()])).catch(()=>{}))}return()=>{xi(),window.removeEventListener("mousemove",w),window.removeEventListener("mouseup",x),window.removeEventListener("resize",$),window.removeEventListener("scroll",$,!0),window.removeEventListener("keydown",J),t(Er)&&clearTimeout(t(Er))}}),Hs(()=>(t(gn),t(Rt)),()=>{t(gn)>=t(Rt).length&&f(gn,0)}),Hs(()=>(t(Rt),t(gn)),()=>{f(Cn,t(Rt)[t(gn)]||null)}),Hs(()=>(r(),t(ue),i(),t(Er)),()=>{r()&&r()!==t(ue)&&!i()&&(t(Er)&&clearTimeout(t(Er)),f(Er,setTimeout(()=>{on().catch(()=>{})},3e3)))}),Hs(()=>(t(Ut),i(),t(Ve),t(On)),()=>{if(!Gr())f(Ut,!1),f(nr,"");else if(!i())f(Ut,!0),f(nr,"当前内容仍在渲染，请等待打字机输出结束后再修改。");else{const l=Ci();if(!l.length)f(Ut,!0),f(nr,"当前仍在生成。请先选择已完成章节下的段落块。");else{const c=l.filter(w=>!t(Ve).includes(w)||t(On).includes(w));f(Ut,c.length>0),f(nr,t(Ut)?"选中块所在章节仍在生成，请等待该章节完成后再修改。":"")}}}),io();var xd={$set:vi,$on:(l,c)=>di(n,l,c)};Ds();var Nc=x_(),_o=hr(Nc);let Mc;var Zo=p(_o),Bc=u(p(Zo),4),tl=p(Bc),Dc=u(p(tl),2),kd=p(Dc,!0);d(Dc),d(tl);var el=u(tl,2),Sd=p(el);d(el);var Lc=u(el,2);{var $d=l=>{var c=Ag(),w=p(c);d(c),rt(()=>D(w,`最近满意度 ${t(ft),_(()=>t(ft)[0].rating)??""}/5`)),M(l,c)};tt(Lc,l=>{t(ft),_(()=>t(ft).length>0)&&l($d)})}var Rc=u(Lc,2);{var Td=l=>{var c=Cg(),w=p(c);d(c),rt(x=>D(w,`查重最高 ${x??""}%`),[()=>(t(Fn),_(()=>Math.round(t(Fn)*100)))]),M(l,c)};tt(Rc,l=>{t(yn),_(()=>t(yn).length>0)&&l(Td)})}var qc=u(Rc,2),Fc=u(qc,2),Oc=u(Fc,2),bo=u(Oc,2),jd=p(bo,!0);d(bo);var yo=u(bo,2),Ed=p(yo,!0);d(yo);var wo=u(yo,2),Ad=p(wo,!0);d(wo);var Cd=u(wo,2);ed(Cd,{}),d(Bc),d(Zo);var nl=u(Zo,2),rl=p(nl),Pc=u(p(rl),2),Hc=u(Pc,2),zc=u(Hc,2),Id=u(zc,2);d(rl);var il=u(rl,2),sl=p(il),Wc=p(sl),al=p(Wc),ol=u(p(al),2),ll=u(ol,2),cl=u(ll,2),ul=u(cl,2),fl=u(ul,2),dl=u(fl,2),xo=u(dl,4),ko=u(xo,2),vl=u(ko,2);d(al);var pl=u(al,2),Uc=u(p(pl),2),Jc=u(Uc,2),Kc=u(Jc,2),Gc=u(Kc,2),Vc=u(Gc,2),Nd=u(Vc,2);d(pl);var ml=u(pl,2),Xc=u(p(ml),2),Md=u(Xc,2);d(ml);var Yc=u(ml,2),hl=u(p(Yc),2),gl=u(hl,2),Bd=u(gl,2);{var Dd=l=>{var c=Ig();C("click",c,hd),M(l,c)};tt(Bd,l=>{t(fe)&&!i()&&l(Dd)})}d(Yc),d(Wc),d(sl);var Qc=u(sl,2);{var Ld=l=>{var c=Ng(),w=p(c);d(c),rt(x=>D(w,`生成中 ${t(At),_(()=>t(At).current)??""}/${t(At),_(()=>t(At).total)??""} · ${t(At),_(()=>t(At).percent)??""}% · 预计剩余 ${x??""} 分 ${t(At),_(()=>t(At).etaS%60)??""} 秒`),[()=>(t(At),_(()=>Math.ceil(t(At).etaS/60)))]),M(l,c)};tt(Qc,l=>{i(),t(At),_(()=>i()&&t(At).total>0)&&l(Ld)})}var Zc=u(Qc,2);{var Rd=l=>{var c=Mg(),w=p(c),x=u(w);{var $=j=>{var B=Xi();rt(Y=>D(B,`，待续写章节：${Y??""}`),[()=>(t(fe),_(()=>t(fe).pending_sections.join(" / ")))]),M(j,B)};tt(x,j=>{t(fe),_(()=>t(fe).pending_sections&&t(fe).pending_sections.length>0)&&j($)})}us(),d(c),rt(()=>D(w,`检测到未完成任务（已缓存约 ${t(fe),_(()=>t(fe).partial_chars)??""} 字） `)),M(l,c)};tt(Zc,l=>{t(fe),i(),_(()=>t(fe)&&!i()&&t(fe).status==="interrupted")&&l(Rd)})}var tu=u(Zc,2);{var qd=l=>{var c=Dg(),w=u(p(c),2);cn(w,1,()=>t(_e),Jn,(x,$)=>{var j=Bg(),B=p(j),Y=p(B,!0);d(B);var G=u(B,2);d(j),rt(()=>D(Y,(t($),_(()=>t($).section)))),C("click",G,()=>yd(t($).section)),M(x,j)}),d(c),M(l,c)};tt(tu,l=>{t(_e),_(()=>t(_e).length>0)&&l(qd)})}var eu=u(tu,2);{var Fd=l=>{var c=Fg(),w=u(p(c),2),x=p(w),$=u(p(x),2);tr($),us(2),d(x);var j=u(x,2),B=p(j),Y=p(B,!0);d(B);var G=u(B,2);{var V=X=>{var ut=Lg(),st=p(ut);d(ut),rt((_t,yt,St)=>D(st,`估计 AI 率 ${_t??""}%，
                  风险 ${yt??""}，
                  置信度 ${St??""}%`),[()=>(t(Kt),_(()=>Math.round(Number(t(Kt).ai_rate||0)*100))),()=>(t(Kt),_(()=>String(t(Kt).risk_level||"unknown"))),()=>(t(Kt),_(()=>Math.round(Number(t(Kt).confidence||0)*100)))]),M(X,ut)};tt(G,X=>{t(Kt)&&X(V)})}d(j);var ht=u(j,2);{var nt=X=>{var ut=qg(),st=p(ut),_t=p(st),yt=p(_t);d(_t);var St=u(_t,2);let ze;var Ft=p(St);d(St),d(st);var le=u(st,2),Ce=p(le),ce=p(Ce);d(Ce);var Ze=u(Ce,2),Ie=p(Ze);d(Ze);var Mn=u(Ze,2),we=p(Mn);d(Mn);var Ot=u(Mn,2),We=p(Ot);d(Ot),d(le);var Ue=u(le,2);{var Un=dr=>{var Bn=Rg(),kn=p(Bn);d(Bn),rt(Sn=>D(kn,`依据：${Sn??""}`),[()=>(t(Kt),_(()=>String(t(Kt).evidence[0]||"")))]),M(dr,Bn)},kr=Sa(()=>(t(Kt),_(()=>Array.isArray(t(Kt).evidence)&&t(Kt).evidence.length>0)));tt(Ue,dr=>{t(kr)&&dr(Un)})}var bn=u(Ue,2),or=p(bn,!0);d(bn),d(ut),rt((dr,Bn,kn,Sn,Yn,Sr,vr,Mr)=>{D(yt,`阈值 ${dr??""}%`),ze=Ne(St,1,"svelte-13mrafj",null,ze,Bn),D(Ft,`判定 ${kn??""}`),D(ce,`重复率 ${Sn??""}%`),D(Ie,`词汇多样性 ${Yn??""}%`),D(we,`熵 ${Sr??""}%`),D(We,`句长波动 ${vr??""}%`),D(or,Mr)},[()=>(t(Kt),_(()=>Math.round(Number(t(Kt).threshold||.65)*100))),()=>({danger:!!t(Kt).suspected_ai}),()=>(t(Kt),_(()=>t(Kt).suspected_ai?"疑似AI生成":"未超阈值")),()=>(t(Kt),_(()=>Math.round(Number(t(Kt).signals?.repeated_3gram_ratio||0)*100))),()=>(t(Kt),_(()=>Math.round(Number(t(Kt).signals?.lexical_diversity||0)*100))),()=>(t(Kt),_(()=>Math.round(Number(t(Kt).signals?.token_entropy_norm||0)*100))),()=>(t(Kt),_(()=>Math.round(Number(t(Kt).signals?.sentence_burstiness_cv||0)*100))),()=>(t(Kt),_(()=>String(t(Kt).note||"")))]),M(X,ut)};tt(ht,X=>{t(Kt)&&X(nt)})}d(w),d(c),rt(()=>{B.disabled=t(en),D(Y,t(en)?"检测中...":"开始 AI 率检测")}),sn($,()=>t(Cr),X=>f(Cr,X)),C("click",B,fo),M(l,c)};tt(eu,l=>{t(Lr)&&l(Fd)})}var nu=u(eu,2);{var Od=l=>{var c=Jg(),w=u(p(c),2),x=p(w),$=u(p(x),2);tr($);var j=u($,4);tr(j),d(x);var B=u(x,2),Y=u(p(B),2);fs(Y),d(B);var G=u(B,2),V=p(G),ht=p(V,!0);d(V);var nt=u(V,2),X=p(nt,!0);d(nt);var ut=u(nt,2);{var st=Ft=>{var le=Og(),Ce=p(le);d(le),rt((ce,Ze)=>D(Ce,`最高重复分数 ${ce??""}%，
                  风险等级 ${Ze??""}，
                  超阈值来源 ${t(sr)??""} 个`),[()=>(t(Fn),_(()=>Math.round(t(Fn)*100))),()=>(t(Fn),_(()=>Qo(t(Fn))))]),M(Ft,le)};tt(ut,Ft=>{t(yn),_(()=>t(yn).length>0)&&Ft(st)})}d(G);var _t=u(G,2);{var yt=Ft=>{var le=Pg(),Ce=p(le),ce=p(Ce);d(Ce);var Ze=u(Ce,2),Ie=u(Ze,2),Mn=u(Ie,2);d(le),rt(()=>D(ce,`报告ID ${t(wn),_(()=>t(wn).report_id)??""} · 来源 ${t(wn),_(()=>t(wn).total_references)??""} · 超阈值 ${t(wn),_(()=>t(wn).flagged_count)??""}`)),C("click",Ze,()=>ma("json")),C("click",Ie,()=>ma("md")),C("click",Mn,()=>ma("csv")),M(Ft,le)};tt(_t,Ft=>{t(wn)&&Ft(yt)})}var St=u(_t,2);{var ze=Ft=>{var le=Ug();cn(le,5,()=>t(yn),Jn,(Ce,ce)=>{var Ze=Wg(),Ie=p(Ze),Mn=p(Ie),we=p(Mn),Ot=u(we);{var We=$n=>{var Vr=Hg(),Vi=p(Vr);d(Vr),rt(()=>D(Vi,`(${t(ce),_(()=>t(ce).reference_id)??""})`)),M($n,Vr)};tt(Ot,$n=>{t(ce),_(()=>t(ce).reference_id)&&$n(We)})}d(Mn);var Ue=u(Mn,2);let Un;var kr=p(Ue);d(Ue),d(Ie);var bn=u(Ie,2),or=p(bn),dr=p(or);d(or);var Bn=u(or,2),kn=p(Bn);d(Bn);var Sn=u(Bn,2),Yn=p(Sn);d(Sn);var Sr=u(Sn,2),vr=p(Sr);d(Sr),d(bn);var Mr=u(bn,2);{var pr=$n=>{var Vr=zg(),Vi=p(Vr);d(Vr),rt(ls=>D(Vi,`证据片段：${ls??""}`),[()=>(t(ce),_(()=>String(t(ce).evidence[0]?.snippet||"").slice(0,120)))]),M($n,Vr)};tt(Mr,$n=>{t(ce),_(()=>t(ce).evidence&&t(ce).evidence.length>0)&&$n(pr)})}d(Ze),rt(($n,Vr,Vi,ls,Qs,ha)=>{D(we,`${t(ce),_(()=>t(ce).reference_title||t(ce).reference_id)??""} `),Un=Ne(Ue,1,"svelte-13mrafj",null,Un,{danger:t(ce).suspected}),D(kr,`分数 ${$n??""}% / 阈值 ${Vr??""}%`),D(dr,`Containment ${Vi??""}%`),D(kn,`Jaccard ${ls??""}%`),D(Yn,`Winnowing ${Qs??""}%`),D(vr,`Longest ${ha??""} chars`)},[()=>(t(ce),_(()=>Math.round(t(ce).score*100))),()=>(t(ce),_(()=>Math.round(t(ce).threshold*100))),()=>(t(ce),_(()=>Math.round(Number(t(ce).metrics?.containment||0)*100))),()=>(t(ce),_(()=>Math.round(Number(t(ce).metrics?.jaccard_resemblance||0)*100))),()=>(t(ce),_(()=>Math.round(Number(t(ce).metrics?.winnowing_overlap||0)*100))),()=>(t(ce),_(()=>Number(t(ce).metrics?.longest_match_chars||0)))]),M(Ce,Ze)}),d(le),M(Ft,le)};tt(St,Ft=>{t(yn),_(()=>t(yn).length>0)&&Ft(ze)})}d(w),d(c),rt(()=>{V.disabled=t(Le),D(ht,t(Le)?"检测中...":"开始查重"),nt.disabled=t(an),D(X,t(an)?"全库扫描中...":"全库查重")}),sn($,()=>t(jn),Ft=>f(jn,Ft)),sn(j,()=>t(tn),Ft=>f(tn,Ft)),sn(Y,()=>t(ur),Ft=>f(ur,Ft)),C("click",V,lo),C("click",nt,vo),M(l,c)};tt(nu,l=>{t(Tn)&&l(Od)})}var ru=u(nu,2);{var Pd=l=>{var c=Qg(),w=u(p(c),2),x=p(w),$=u(p(x),2);cn($,4,()=>[1,2,3,4,5],Jn,(Ft,le)=>{var Ce=Kg(),ce=p(Ce,!0);d(Ce),rt(()=>{Ne(Ce,1,`rating-btn ${t(Ht)===le?"active":""}`,"svelte-13mrafj"),js(Ce,"data-testid",`rating-${le}`),D(ce,le)}),C("click",Ce,()=>f(Ht,le)),M(Ft,Ce)}),d($);var j=u($,4),B=p(j);B.value=B.__value="general";var Y=u(B);Y.value=Y.__value="stage1";var G=u(Y);G.value=G.__value="stage2";var V=u(G);V.value=V.__value="final",d(j),d(x);var ht=u(x,2),nt=u(p(ht),2);fs(nt),d(ht);var X=u(ht,2),ut=p(X),st=p(ut,!0);d(ut);var _t=u(ut,2);{var yt=Ft=>{var le=Gg(),Ce=p(le);d(le),rt(()=>D(Ce,`已记录低满意度样本 ${t(qn)??""} 条`)),M(Ft,le)};tt(_t,Ft=>{t(qn)>0&&Ft(yt)})}d(X);var St=u(X,2);{var ze=Ft=>{var le=Yg(),Ce=u(p(le),2);cn(Ce,1,()=>(t(ft),_(()=>t(ft).slice(0,5))),Jn,(ce,Ze)=>{var Ie=Xg(),Mn=p(Ie),we=p(Mn),Ot=p(we);d(we);var We=u(we,2),Ue=p(We,!0);d(We),d(Mn);var Un=u(Mn,2);{var kr=bn=>{var or=Vg(),dr=p(or,!0);d(or),rt(()=>D(dr,(t(Ze),_(()=>t(Ze).note)))),M(bn,or)};tt(Un,bn=>{t(Ze),_(()=>t(Ze).note)&&bn(kr)})}d(Ie),rt(bn=>{D(Ot,`${t(Ze),_(()=>t(Ze).rating)??""}/5 · ${t(Ze),_(()=>t(Ze).stage)??""}`),D(Ue,bn)},[()=>(t(Ze),_(()=>ao(t(Ze).created_at)))]),M(ce,Ie)}),d(le),M(Ft,le)};tt(St,Ft=>{t(ft),_(()=>t(ft).length>0)&&Ft(ze)})}d(w),d(c),rt(()=>{ut.disabled=t(Rn),D(st,t(Rn)?"提交中...":"提交评分")}),$s(j,()=>t(pn),Ft=>f(pn,Ft)),sn(nt,()=>t(Ar),Ft=>f(Ar,Ft)),C("click",ut,Oa),M(l,c)};tt(ru,l=>{t(K)&&l(Pd)})}var iu=u(ru,2),Hd=p(iu);{var zd=l=>{rd(l,{})},Wd=l=>{{let c=Ia(()=>t(Tt)||t($t));Yf(l,{showToolbar:!1,paper:!0,get lockEditing(){return t(c)},$$events:{blockedit:li,blockselect:qi,toolbarstate:os}})}};tt(Hd,l=>{N()?l(zd):l(Wd,!1)})}d(iu),d(il);var su=u(il,2),au=p(su),_l=p(au),Ud=u(p(_l),2);d(_l);var bl=u(_l,2),yl=p(bl);tr(yl);var Jd=u(yl,2);d(bl);var ou=u(bl,2);{var Kd=l=>{var c=Zg();M(l,c)},Gd=l=>{var c=t_(),w=p(c,!0);d(c),rt(()=>D(w,t(te))),M(l,c)},Vd=l=>{var c=e_();M(l,c)},Xd=l=>{var c=o_();cn(c,5,()=>t(ve),Jn,(w,x)=>{var $=a_(),j=p($),B=p(j),Y=p(B),G=p(Y,!0);d(Y);var V=u(Y,2),ht=p(V,!0);d(V),d(B);var nt=u(B,2),X=p(nt),ut=p(X,!0);d(X);var st=u(X,2),_t=p(st,!0);d(st),d(nt);var yt=u(nt,2);{var St=Ie=>{var Mn=n_(),we=p(Mn,!0);d(Mn),rt(Ot=>D(we,Ot),[()=>(t(x),_(()=>Gi(t(x).major?.summary)))]),M(Ie,Mn)},ze=Sa(()=>(t(x),_(()=>Gi(t(x).major?.summary))));tt(yt,Ie=>{t(ze)&&Ie(St)})}var Ft=u(yt,2),le=p(Ft),Ce=u(le,2);d(Ft),d(j);var ce=u(j,2);{var Ze=Ie=>{var Mn=s_();cn(Mn,5,()=>(t(x),_(()=>t(x).minors)),Jn,(we,Ot)=>{var We=i_(),Ue=p(We),Un=p(Ue),kr=p(Un,!0);d(Un);var bn=u(Un,2);{var or=vr=>{var Mr=r_(),pr=p(Mr,!0);d(Mr),rt($n=>D(pr,$n),[()=>(t(Ot),_(()=>Gi(t(Ot).summary)))]),M(vr,Mr)},dr=Sa(()=>(t(Ot),_(()=>Gi(t(Ot).summary))));tt(bn,vr=>{t(dr)&&vr(or)})}var Bn=u(bn,2),kn=p(Bn,!0);d(Bn),d(Ue);var Sn=u(Ue,2),Yn=p(Sn),Sr=u(Yn,2);d(Sn),d(We),rt(vr=>{Ne(We,1,(t(Ot),_(()=>`version-minor ${t(Ot).is_current?"current":""}`)),"svelte-13mrafj"),D(kr,(t(Ot),_(()=>t(Ot).message||"未命名"))),D(kn,vr),Yn.disabled=(t(Ot),_(()=>t(Ot).is_current)),Sr.disabled=(t(Ot),_(()=>t(Ot).is_current))},[()=>(t(Ot),_(()=>ln(t(Ot).timestamp)))]),C("click",Yn,()=>Tc(t(Ot).version_id)),C("click",Sr,()=>jc(t(Ot).version_id)),M(we,We)}),d(Mn),M(Ie,Mn)};tt(ce,Ie=>{t(x),_(()=>t(x).minors&&t(x).minors.length)&&Ie(Ze)})}d($),rt((Ie,Mn)=>{Ne(j,1,(t(x),_(()=>`version-major ${t(x).major?.is_current?"current":""}`)),"svelte-13mrafj"),D(G,(t(x),_(()=>t(x).major?.message||"未命名"))),Ne(V,1,(t(x),_(()=>`badge ${t(x).major?.kind==="major"?"major":"minor"}`)),"svelte-13mrafj"),D(ht,(t(x),_(()=>t(x).major?.kind==="major"?"大版本":"小版本"))),D(ut,Ie),D(_t,Mn),le.disabled=(t(x),_(()=>t(x).major?.is_current)),Ce.disabled=(t(x),_(()=>t(x).major?.is_current))},[()=>(t(x),_(()=>ln(t(x).major?.timestamp||0))),()=>(t(x),_(()=>String(t(x).major?.version_id||"").slice(0,7)))]),C("click",le,()=>Tc(t(x).major?.version_id)),C("click",Ce,()=>jc(t(x).major?.version_id)),M(w,$)}),d(c),M(l,c)};tt(ou,l=>{t(Rr)?l(Kd):t(te)?l(Gd,1):(t(ve),_(()=>t(ve).length===0)?l(Vd,2):l(Xd,!1))})}var lu=u(ou,2),cu=u(p(lu),2),Yd=p(cu,!0);d(cu),d(lu),d(au),d(su),d(nl);var uu=u(nl,2);{var Qd=l=>{var c=l_(),w=p(c),x=p(w);us(),d(w);var $=u(w,2),j=p($),B=u(j,2),Y=u(B,2),G=u(Y,2),V=u(G,2),ht=u(V,2),nt=u(ht,2);d($),d(c),rt(()=>{Ts(c,`left:${t(is)}px;top:${t(mi)}px;`),D(x,`已选中 ${t(he),_(()=>t(he).length)??""} 项 `),j.disabled=t(Ut),B.disabled=t(Ut),Y.disabled=t(Ut),G.disabled=t(Ut)}),C("click",j,()=>Ye("rewrite","down")),C("click",B,()=>Ye("style","down")),C("click",Y,Ic),C("click",G,Cc),C("click",V,()=>Ye("assistant","down")),C("click",ht,()=>Ye(t(Lt),"up")),C("click",nt,()=>Ye(t(Lt),"down")),M(l,c)};tt(uu,l=>{t(he),t(qr),_(()=>t(he).length>0&&t(qr))&&l(Qd)})}var fu=u(uu,2);{var Zd=l=>{var c=b_(),w=p(c),x=u(p(w),2),$=p(x),j=u($,2),B=u(j,2),Y=u(B,2),G=u(Y,2);d(x),d(w);var V=u(w,2),ht=p(V),nt=u(ht,2),X=u(nt,2);d(V);var ut=u(V,2);cn(ut,5,()=>t(be),Jn,(we,Ot,We)=>{var Ue=c_(),Un=p(Ue,!0);d(Ue),rt(()=>{js(Ue,"title",(t(Ot),_(()=>t(Ot).text))),D(Un,(t(Ot),_(()=>t(Ot).kind==="section"||t(Ot).kind==="title"?`标题${We+1}`:`块${We+1}`)))}),M(we,Ue)}),d(ut);var st=u(ut,2);{var _t=we=>{var Ot=u_(),We=p(Ot,!0);d(Ot),rt(()=>D(We,t(nr))),M(we,Ot)};tt(st,we=>{t(Ut)&&we(_t)})}var yt=u(st,2);{var St=we=>{var Ot=f_(),We=hr(Ot),Ue=u(p(We),2),Un=p(Ue);Un.value=Un.__value="";var kr=u(Un);kr.value=kr.__value="宋体";var bn=u(kr);bn.value=bn.__value="黑体";var or=u(bn);or.value=or.__value="微软雅黑";var dr=u(or);dr.value=dr.__value="楷体";var Bn=u(dr);Bn.value=Bn.__value="仿宋",d(Ue);var kn=u(Ue,4),Sn=p(kn);Sn.value=Sn.__value="";var Yn=u(Sn);Yn.value=Yn.__value="12pt";var Sr=u(Yn);Sr.value=Sr.__value="14pt";var vr=u(Sr);vr.value=vr.__value="16pt";var Mr=u(vr);Mr.value=Mr.__value="18pt";var pr=u(Mr);pr.value=pr.__value="20pt",d(kn);var $n=u(kn,4),Vr=p($n);Vr.value=Vr.__value="";var Vi=u(Vr);Vi.value=Vi.__value="1.2";var ls=u(Vi);ls.value=ls.__value="1.5";var Qs=u(ls);Qs.value=Qs.__value="1.75";var ha=u(Qs);ha.value=ha.__value="2",d($n);var ga=u($n,4),xl=p(ga);xl.value=xl.__value="";var kl=u(xl);kl.value=kl.__value="left";var Sl=u(kl);Sl.value=Sl.__value="center";var $l=u(Sl);$l.value=$l.__value="right";var pu=u($l);pu.value=pu.__value="justify",d(ga);var _a=u(ga,4),Tl=p(_a);Tl.value=Tl.__value="";var jl=u(Tl);jl.value=jl.__value="400";var El=u(jl);El.value=El.__value="500";var Al=u(El);Al.value=Al.__value="600";var mu=u(Al);mu.value=mu.__value="700",d(_a);var ba=u(_a,4),Cl=p(ba);Cl.value=Cl.__value="";var Il=u(Cl);Il.value=Il.__value="normal";var hu=u(Il);hu.value=hu.__value="italic",d(ba);var za=u(ba,4);tr(za);var To=u(za,4);tr(To),d(We),us(2),rt(()=>{Ue.disabled=t(Ut),kn.disabled=t(Ut),$n.disabled=t(Ut),ga.disabled=t(Ut),_a.disabled=t(Ut),ba.disabled=t(Ut),za.disabled=t(Ut),To.disabled=t(Ut)}),$s(Ue,()=>t(Re),ci=>f(Re,ci)),C("change",Ue,()=>o({fontFamily:t(Re)})),$s(kn,()=>t(je),ci=>f(je,ci)),C("change",kn,()=>o({fontSize:t(je)})),$s($n,()=>t(Ee),ci=>f(Ee,ci)),C("change",$n,()=>o({lineHeight:t(Ee)})),$s(ga,()=>t(wt),ci=>f(wt,ci)),C("change",ga,()=>o({align:t(wt)})),$s(_a,()=>t(re),ci=>f(re,ci)),C("change",_a,()=>o({fontWeight:t(re)})),$s(ba,()=>t($e),ci=>f($e,ci)),C("change",ba,()=>o({fontStyle:t($e)})),sn(za,()=>t(Pe),ci=>f(Pe,ci)),C("change",za,()=>o({color:t(Pe)})),sn(To,()=>t(er),ci=>f(er,ci)),C("change",To,()=>o({background:t(er)})),M(we,Ot)};tt(yt,we=>{t(Lt)==="style"&&we(St)})}var ze=u(yt,2);{var Ft=we=>{var Ot=d_(),We=u(p(Ot),2);fs(We);var Ue=u(We,2),Un=p(Ue),kr=u(Un,2);d(Ue),d(Ot),sn(We,()=>t(ni),bn=>f(ni,bn)),C("click",Un,()=>{f(Qt,t(ni).trim()),f(Lt,"rewrite")}),C("click",kr,()=>I(t(ni))),M(we,Ot)};tt(ze,we=>{t(Lt)==="assistant"&&we(Ft)})}var le=u(ze,2);{var Ce=we=>{var Ot=p_(),We=hr(Ot),Ue=p(We),Un=u(Ue,2),kr=u(Un,2),bn=u(kr,2);d(We);var or=u(We,2),dr=p(or);fs(dr),d(or);var Bn=u(or,2),kn=p(Bn),Sn=u(kn,2),Yn=p(Sn,!0);d(Sn),d(Bn);var Sr=u(Bn,2);{var vr=pr=>{var $n=v_();M(pr,$n)},Mr=Sa(()=>_(k));tt(Sr,pr=>{t(Mr)&&pr(vr)})}rt(pr=>{Sn.disabled=pr,D(Yn,t(ee)?"正在生成建议...":"生成建议（不改原文）")},[()=>(t(Ut),t(ee),t(Qt),_(()=>t(Ut)||t(ee)||!t(Qt).trim()||k()))]),C("click",Ue,()=>L("语气更正式，保留原意")),C("click",Un,()=>L("压缩到更简洁，控制在80字左右")),C("click",kr,()=>L("增加解释细节，但不要扩展事实")),C("click",bn,()=>L("保持术语不变，仅调整表达")),sn(dr,()=>t(Qt),pr=>f(Qt,pr)),C("click",kn,()=>Ye("assistant",t(Kr))),C("click",Sn,H),M(we,Ot)};tt(le,we=>{t(Lt)==="rewrite"&&we(Ce)})}var ce=u(le,2);{var Ze=we=>{var Ot=m_(),We=p(Ot,!0);d(Ot),rt(()=>D(We,t(hn))),M(we,Ot)};tt(ce,we=>{t(hn)&&we(Ze)})}var Ie=u(ce,2);{var Mn=we=>{var Ot=__(),We=p(Ot),Ue=u(p(We),2),Un=p(Ue,!0);d(Ue),d(We);var kr=u(We,2),bn=p(kr);cn(bn,5,()=>t(Rt),Jn,(Bn,kn,Sn)=>{var Yn=h_(),Sr=p(Yn),vr=p(Sr,!0);d(Sr);var Mr=u(Sr,2),pr=p(Mr,!0);d(Mr),d(Yn),rt($n=>{Ne(Yn,1,`candidate-switch ${t(gn)===Sn?"active":""}`,"svelte-13mrafj"),D(vr,(t(kn),_(()=>t(kn).label))),D(pr,$n)},[()=>(t(kn),_(()=>z(t(kn))))]),C("click",Yn,()=>f(gn,Sn)),M(Bn,Yn)}),d(bn);var or=u(bn,2);{var dr=Bn=>{var kn=g_(),Sn=p(kn),Yn=p(Sn),Sr=p(Yn,!0);d(Yn);var vr=u(Yn,2),Mr=p(vr,!0);d(vr),d(Sn);var pr=u(Sn,2),$n=p(pr),Vr=u($n,2),Vi=u(Vr,2);d(pr);var ls=u(pr,4),Qs=p(ls,!0);d(ls),d(kn),rt(ha=>{D(Sr,(t(Cn),_(()=>t(Cn).label))),D(Mr,ha),$n.disabled=t(Ut),D(Qs,(t(Cn),_(()=>t(Cn).selectedAfter)))},[()=>(t(Cn),_(()=>z(t(Cn))))]),C("click",$n,()=>Q(t(gn))),C("click",Vr,H),C("click",Vi,it),M(Bn,kn)};tt(or,Bn=>{t(Cn)&&Bn(dr)})}d(kr),d(Ot),rt(()=>D(Un,t(An)||t(pe))),M(we,Ot)};tt(Ie,we=>{t(Rt),_(()=>t(Rt).length>0)&&we(Mn)})}d(c),rt(()=>{Ne(c,1,`inline-edit-popover ${t(Kr)}`,"svelte-13mrafj"),Ts(c,`left:${t(_r)}px;top:${t(br)}px;`),$.disabled=t(Ut),j.disabled=t(Ut),Ne(ht,1,`inline-tab ${t(Lt)==="rewrite"?"active":""}`,"svelte-13mrafj"),Ne(nt,1,`inline-tab ${t(Lt)==="style"?"active":""}`,"svelte-13mrafj"),Ne(X,1,`inline-tab ${t(Lt)==="assistant"?"active":""}`,"svelte-13mrafj")}),C("click",$,Ic),C("click",j,Cc),C("click",B,()=>Ye(t(Lt),"up")),C("click",Y,()=>Ye(t(Lt),"down")),C("click",G,Ke),C("click",ht,()=>ki("rewrite")),C("click",nt,()=>ki("style")),C("click",X,()=>ki("assistant")),M(l,c)};tt(fu,l=>{t(In),t(he),_(()=>t(In)&&t(he).length>0)&&l(Zd)})}var So=u(fu,2),$o=p(So),du=p($o),tv=u(du);{var ev=l=>{var c=y_(),w=p(c,!0);d(c),rt(()=>D(w,(t(rn),_(()=>t(rn).length)))),M(l,c)};tt(tv,l=>{t(rn),_(()=>t(rn).length>0)&&l(ev)})}d($o);var nv=u($o,2);{var rv=l=>{qf(l,{variant:"assistant",$$events:{send:c=>go(c.detail),upload:bd}})};tt(nv,l=>{t(Se)&&l(rv)})}d(So);var wl=u(So,2);bc(wl,l=>f(fr,l),()=>t(fr));var iv=u(wl,2);{var sv=l=>{id(l,{indeterminate:!0})};tt(iv,l=>{i()&&l(sv)})}d(_o);var vu=u(_o,2);Qf(vu,{get open(){return t(me)},get docId(){return s()},$$events:{close:()=>f(me,!1),insert:l=>It(l.detail.spec)}});var av=u(vu,2);sd(av,{children:(l,c)=>{var w=w_(),x=hr(w);Zf(x,{});var $=u(x,2);nd($,{onSelect:pd,get visible(){return t(ei)},set visible(Y){f(ei,Y)},$$legacy:!0});var j=u($,2);ad(j,{get visible(){return t(vn)},set visible(Y){f(vn,Y)},$$legacy:!0});var B=u(j,2);ld(B,{get visible(){return t(Ji)},set visible(Y){f(Ji,Y)},$$legacy:!0}),M(l,w)},$$slots:{default:!0}}),rt(()=>{Mc=Ne(_o,1,"app svelte-13mrafj",null,Mc,{dark:T()}),D(kd,m()||"未加载"),D(Sd,`字数 ${y()??""}`),D(jd,t(Lr)?"收起AI率":"AI率检测"),D(Ed,t(Tn)?"收起查重":"查重检测"),D(Ad,t(K)?"收起评分":"满意度评分"),ol.disabled=(t(Ct),_(()=>!t(Ct).canUndo)),ll.disabled=(t(Ct),_(()=>!t(Ct).canRedo)),cl.disabled=(t(Ct),_(()=>!t(Ct).canCopy)),ul.disabled=(t(Ct),_(()=>!t(Ct).canCut)),fl.disabled=(t(Ct),_(()=>!t(Ct).canPaste)),dl.disabled=(t(Ct),_(()=>t(Ct).readonly||!t(Ct).focused)),Ne(xo,1,(t(Ct),_(()=>`tool-btn ${t(Ct).bold?"active":""}`)),"svelte-13mrafj"),xo.disabled=(t(Ct),_(()=>t(Ct).readonly||!t(Ct).focused)),Ne(ko,1,(t(Ct),_(()=>`tool-btn ${t(Ct).italic?"active":""}`)),"svelte-13mrafj"),ko.disabled=(t(Ct),_(()=>t(Ct).readonly||!t(Ct).focused)),Ne(vl,1,(t(Ct),_(()=>`tool-btn ${t(Ct).underline?"active":""}`)),"svelte-13mrafj"),vl.disabled=(t(Ct),_(()=>t(Ct).readonly||!t(Ct).focused)),hl.disabled=i(),gl.disabled=!i(),D(Yd,t(nn)||"请选择版本进行对比"),Ne(So,1,`assistant-dock ${t(Se)?"open":""}`,"svelte-13mrafj"),D(du,`${t(Se)?"收起助手":"打开助手"} `)}),C("click",qc,on),C("click",Fc,md),C("click",Oc,vd),C("click",bo,()=>f(Lr,!t(Lr))),C("click",yo,()=>f(Tn,!t(Tn))),C("click",wo,()=>f(K,!t(K))),C("click",Pc,()=>f(me,!0)),C("click",Hc,()=>f(vn,!0)),C("click",zc,()=>f(Ji,!0)),C("click",Id,()=>f(ei,!0)),C("click",ol,()=>Pr("undo")),C("click",ll,()=>Pr("redo")),C("click",cl,()=>Pr("copy")),C("click",ul,()=>Pr("cut")),C("click",fl,()=>Pr("paste")),C("click",dl,()=>Pr("clear-format")),C("click",xo,()=>Pr("bold")),C("click",ko,()=>Pr("italic")),C("click",vl,()=>Pr("underline")),C("click",Uc,()=>Pr("heading1")),C("click",Jc,()=>Pr("heading2")),C("click",Kc,()=>Pr("quote")),C("click",Gc,()=>Pr("code")),C("click",Vc,()=>Pr("list-bullet")),C("click",Nd,()=>Pr("list-number")),C("click",Xc,()=>f(me,!0)),C("click",Md,()=>f(vn,!0)),C("click",hl,()=>go(S())),C("click",gl,wd),C("click",Ud,Ys),sn(yl,()=>t(Ge),l=>f(Ge,l)),C("click",Jd,fd),C("click",$o,()=>f(Se,!t(Se))),C("change",wl,_d),M(e,Nc);var ov=ti(xd);return O(),ov}function ud(e,n){if(new.target)return fi({component:ud,...e});Zr(n,!1);var i={$set:vi,$on:(r,a)=>di(n,r,a)};return cd(e,{}),ti(i)}const Ou=document.getElementById("app");Ou&&new ud({target:Ou});
