(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))r(a);new MutationObserver(a=>{for(const s of a)if(s.type==="childList")for(const m of s.addedNodes)m.tagName==="LINK"&&m.rel==="modulepreload"&&r(m)}).observe(document,{childList:!0,subtree:!0});function i(a){const s={};return a.integrity&&(s.integrity=a.integrity),a.referrerPolicy&&(s.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?s.credentials="include":a.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(a){if(a.ep)return;a.ep=!0;const s=i(a);fetch(a.href,s)}})();const Zr=2,Za=4,to=8,Ju=1<<24,Bs=16,os=32,da=64,Ol=128,Gi=512,Rr=1024,ti=2048,Vi=4096,Li=8192,Cs=16384,Gs=32768,Ea=65536,xu=1<<17,Gu=1<<18,Ba=1<<19,Ku=1<<20,Es=1<<25,sa=65536,Pl=1<<21,ac=1<<22,Ws=1<<23,Is=Symbol("$state"),Vu=Symbol("legacy props"),gv=Symbol(""),ta=new class extends Error{name="StaleReactionError";message="The reaction that called `getAbortSignal()` was re-run or destroyed"},_v=!!globalThis.document?.contentType&&globalThis.document.contentType.includes("xml"),eo=3,Da=8,Hl=!1;var no=Array.isArray,bv=Array.prototype.indexOf,Aa=Array.prototype.includes,Ho=Array.from,oc=Object.defineProperty,Ta=Object.getOwnPropertyDescriptor,Xu=Object.getOwnPropertyDescriptors,yv=Object.prototype,wv=Array.prototype,lc=Object.getPrototypeOf,Su=Object.isExtensible;const Ns=()=>{};function xv(e){return e()}function Ro(e){for(var n=0;n<e.length;n++)e[n]()}function Yu(){var e,n,i=new Promise((r,a)=>{e=r,n=a});return{promise:i,resolve:e,reject:n}}function Qu(e){return e===this.v}function Zu(e,n){return e!=e?n==n:e!==n||e!==null&&typeof e=="object"||typeof e=="function"}function tf(e){return!Zu(e,this.v)}function cc(e){throw new Error("https://svelte.dev/e/lifecycle_outside_component")}function Sv(){throw new Error("https://svelte.dev/e/async_derived_orphan")}function kv(e,n,i){throw new Error("https://svelte.dev/e/each_key_duplicate")}function $v(e){throw new Error("https://svelte.dev/e/effect_in_teardown")}function Tv(){throw new Error("https://svelte.dev/e/effect_in_unowned_derived")}function jv(e){throw new Error("https://svelte.dev/e/effect_orphan")}function Ev(){throw new Error("https://svelte.dev/e/effect_update_depth_exceeded")}function Av(){throw new Error("https://svelte.dev/e/hydration_failed")}function Cv(e){throw new Error("https://svelte.dev/e/props_invalid_value")}function Iv(){throw new Error("https://svelte.dev/e/state_descriptors_fixed")}function Nv(){throw new Error("https://svelte.dev/e/state_prototype_fixed")}function Mv(){throw new Error("https://svelte.dev/e/state_unsafe_mutation")}function Bv(){throw new Error("https://svelte.dev/e/svelte_boundary_reset_onerror")}let La=!1,Dv=!1;function Lv(){La=!0}const Rv=1,qv=2,ef=4,Fv=8,Ov=16,Pv=2,Hv=8,zv=1,Wv=2,uc="[",zo="[!",fc="]",aa={},Yr=Symbol(),nf="http://www.w3.org/1999/xhtml";let Ln=null;function Ca(e){Ln=e}function oi(e,n=!1,i){Ln={p:Ln,i:!1,c:null,e:null,s:e,x:null,l:La&&!n?{s:null,u:null,$:[]}:null}}function li(e){var n=Ln,i=n.e;if(i!==null){n.e=null;for(var r of i)Cf(r)}return e!==void 0&&(n.x=e),n.i=!0,Ln=n.p,e??{}}function ro(){return!La||Ln!==null&&Ln.l===null}let ea=[];function rf(){var e=ea;ea=[],Ro(e)}function gs(e){if(ea.length===0&&!Ka){var n=ea;queueMicrotask(()=>{n===ea&&rf()})}ea.push(e)}function Uv(){for(;ea.length>0;)rf()}function io(e){console.warn("https://svelte.dev/e/hydration_mismatch")}function Jv(){console.warn("https://svelte.dev/e/select_multiple_invalid_value")}function Gv(){console.warn("https://svelte.dev/e/svelte_boundary_reset_noop")}let he=!1;function As(e){he=e}let ze;function ai(e){if(e===null)throw io(),aa;return ze=e}function oa(){return ai(ls(ze))}function d(e){if(he){if(ls(ze)!==null)throw io(),aa;ze=e}}function ms(e=1){if(he){for(var n=e,i=ze;n--;)i=ls(i);ze=i}}function qo(e=!0){for(var n=0,i=ze;;){if(i.nodeType===Da){var r=i.data;if(r===fc){if(n===0)return i;n-=1}else(r===uc||r===zo||r[0]==="["&&!isNaN(Number(r.slice(1))))&&(n+=1)}var a=ls(i);e&&i.remove(),i=a}}function sf(e){if(!e||e.nodeType!==Da)throw io(),aa;return e.data}function ka(e){if(typeof e!="object"||e===null||Is in e)return e;const n=lc(e);if(n!==yv&&n!==wv)return e;var i=new Map,r=no(e),a=qs(0),s=ra,m=g=>{if(ra===s)return g();var w=He,k=ra;Xi(null),Au(s);var b=g();return Xi(w),Au(k),b};return r&&i.set("length",qs(e.length)),new Proxy(e,{defineProperty(g,w,k){(!("value"in k)||k.configurable===!1||k.enumerable===!1||k.writable===!1)&&Iv();var b=i.get(w);return b===void 0?m(()=>{var j=qs(k.value);return i.set(w,j),j}):f(b,k.value,!0),!0},deleteProperty(g,w){var k=i.get(w);if(k===void 0){if(w in g){const b=m(()=>qs(Yr));i.set(w,b),Va(a)}}else f(k,Yr),Va(a);return!0},get(g,w,k){if(w===Is)return e;var b=i.get(w),j=w in g;if(b===void 0&&(!j||Ta(g,w)?.writable)&&(b=m(()=>{var F=ka(j?g[w]:Yr),O=qs(F);return O}),i.set(w,b)),b!==void 0){var B=t(b);return B===Yr?void 0:B}return Reflect.get(g,w,k)},getOwnPropertyDescriptor(g,w){var k=Reflect.getOwnPropertyDescriptor(g,w);if(k&&"value"in k){var b=i.get(w);b&&(k.value=t(b))}else if(k===void 0){var j=i.get(w),B=j?.v;if(j!==void 0&&B!==Yr)return{enumerable:!0,configurable:!0,value:B,writable:!0}}return k},has(g,w){if(w===Is)return!0;var k=i.get(w),b=k!==void 0&&k.v!==Yr||Reflect.has(g,w);if(k!==void 0||Be!==null&&(!b||Ta(g,w)?.writable)){k===void 0&&(k=m(()=>{var B=b?ka(g[w]):Yr,F=qs(B);return F}),i.set(w,k));var j=t(k);if(j===Yr)return!1}return b},set(g,w,k,b){var j=i.get(w),B=w in g;if(r&&w==="length")for(var F=k;F<j.v;F+=1){var O=i.get(F+"");O!==void 0?f(O,Yr):F in g&&(O=m(()=>qs(Yr)),i.set(F+"",O))}if(j===void 0)(!B||Ta(g,w)?.writable)&&(j=m(()=>qs(void 0)),f(j,ka(k)),i.set(w,j));else{B=j.v!==Yr;var E=m(()=>ka(k));f(j,E)}var P=Reflect.getOwnPropertyDescriptor(g,w);if(P?.set&&P.set.call(b,k),!B){if(r&&typeof w=="string"){var dt=i.get("length"),U=Number(w);Number.isInteger(U)&&U>=dt.v&&f(dt,U+1)}Va(a)}return!0},ownKeys(g){t(a);var w=Reflect.ownKeys(g).filter(j=>{var B=i.get(j);return B===void 0||B.v!==Yr});for(var[k,b]of i)b.v!==Yr&&!(k in g)&&w.push(k);return w},setPrototypeOf(){Nv()}})}function ku(e){try{if(e!==null&&typeof e=="object"&&Is in e)return e[Is]}catch{}return e}function Kv(e,n){return Object.is(ku(e),ku(n))}var $u,af,of,lf;function zl(){if($u===void 0){$u=window,af=/Firefox/.test(navigator.userAgent);var e=Element.prototype,n=Node.prototype,i=Text.prototype;of=Ta(n,"firstChild").get,lf=Ta(n,"nextSibling").get,Su(e)&&(e.__click=void 0,e.__className=void 0,e.__attributes=null,e.__style=void 0,e.__e=void 0),Su(i)&&(i.__t=void 0)}}function ki(e=""){return document.createTextNode(e)}function Ji(e){return of.call(e)}function ls(e){return lf.call(e)}function v(e,n){if(!he)return Ji(e);var i=Ji(ze);if(i===null)i=ze.appendChild(ki());else if(n&&i.nodeType!==eo){var r=ki();return i?.before(r),ai(r),r}return n&&Wo(i),ai(i),i}function wr(e,n=!1){if(!he){var i=Ji(e);return i instanceof Comment&&i.data===""?ls(i):i}if(n){if(ze?.nodeType!==eo){var r=ki();return ze?.before(r),ai(r),r}Wo(ze)}return ze}function u(e,n=1,i=!1){let r=he?ze:e;for(var a;n--;)a=r,r=ls(r);if(!he)return r;if(i){if(r?.nodeType!==eo){var s=ki();return r===null?a?.after(s):r.before(s),ai(s),s}Wo(r)}return ai(r),r}function dc(e){e.textContent=""}function cf(){return!1}function Vv(e,n,i){return document.createElementNS(nf,e,void 0)}function Wo(e){if(e.nodeValue.length<65536)return;let n=e.nextSibling;for(;n!==null&&n.nodeType===eo;)n.remove(),e.nodeValue+=n.nodeValue,n=e.nextSibling}function uf(e){var n=Be;if(n===null)return He.f|=Ws,e;if((n.f&Gs)===0&&(n.f&Za)===0)throw e;Ia(e,n)}function Ia(e,n){for(;n!==null;){if((n.f&Ol)!==0){if((n.f&Gs)===0)throw e;try{n.b.error(e);return}catch(i){e=i}}n=n.parent}throw e}const Xv=-7169;function ar(e,n){e.f=e.f&Xv|n}function vc(e){(e.f&Gi)!==0||e.deps===null?ar(e,Rr):ar(e,Vi)}function ff(e){if(e!==null)for(const n of e)(n.f&Zr)===0||(n.f&sa)===0||(n.f^=sa,ff(n.deps))}function df(e,n,i){(e.f&ti)!==0?n.add(e):(e.f&Vi)!==0&&i.add(e),ff(e.deps),ar(e,Rr)}const jo=new Set;let Xe=null,Fo=null,rs=null,xi=[],Uo=null,Wl=!1,Ka=!1;class Us{committed=!1;current=new Map;previous=new Map;#t=new Set;#e=new Set;#n=0;#s=0;#a=null;#o=new Set;#r=new Set;#i=new Map;is_fork=!1;#l=!1;#u(){return this.is_fork||this.#s>0}skip_effect(n){this.#i.has(n)||this.#i.set(n,{d:[],m:[]})}unskip_effect(n){var i=this.#i.get(n);if(i){this.#i.delete(n);for(var r of i.d)ar(r,ti),is(r);for(r of i.m)ar(r,Vi),is(r)}}process(n){xi=[],this.apply();var i=[],r=[];for(const a of n)this.#c(a,i,r);if(this.#u()){this.#f(r),this.#f(i);for(const[a,s]of this.#i)hf(a,s)}else{for(const a of this.#t)a();this.#t.clear(),this.#n===0&&this.#v(),Fo=this,Xe=null,Tu(r),Tu(i),Fo=null,this.#a?.resolve()}rs=null}#c(n,i,r){n.f^=Rr;for(var a=n.first;a!==null;){var s=a.f,m=(s&(os|da))!==0,g=m&&(s&Rr)!==0,w=g||(s&Li)!==0||this.#i.has(a);if(!w&&a.fn!==null){m?a.f^=Rr:(s&Za)!==0?i.push(a):Ra(a)&&((s&Bs)!==0&&this.#r.add(a),ca(a));var k=a.first;if(k!==null){a=k;continue}}for(;a!==null;){var b=a.next;if(b!==null){a=b;break}a=a.parent}}}#f(n){for(var i=0;i<n.length;i+=1)df(n[i],this.#o,this.#r)}capture(n,i){i!==Yr&&!this.previous.has(n)&&this.previous.set(n,i),(n.f&Ws)===0&&(this.current.set(n,n.v),rs?.set(n,n.v))}activate(){Xe=this,this.apply()}deactivate(){Xe===this&&(Xe=null,rs=null)}flush(){if(this.activate(),xi.length>0){if(vf(),Xe!==null&&Xe!==this)return}else this.#n===0&&this.process([]);this.deactivate()}discard(){for(const n of this.#e)n(this);this.#e.clear()}#v(){if(jo.size>1){this.previous.clear();var n=rs,i=!0;for(const a of jo){if(a===this){i=!1;continue}const s=[];for(const[g,w]of this.current){if(a.current.has(g))if(i&&w!==a.current.get(g))a.current.set(g,w);else continue;s.push(g)}if(s.length===0)continue;const m=[...a.current.keys()].filter(g=>!this.current.has(g));if(m.length>0){var r=xi;xi=[];const g=new Set,w=new Map;for(const k of s)pf(k,m,g,w);if(xi.length>0){Xe=a,a.apply();for(const k of xi)a.#c(k,[],[]);a.deactivate()}xi=r}}Xe=null,rs=n}this.committed=!0,jo.delete(this)}increment(n){this.#n+=1,n&&(this.#s+=1)}decrement(n){this.#n-=1,n&&(this.#s-=1),!this.#l&&(this.#l=!0,gs(()=>{this.#l=!1,this.#u()?xi.length>0&&this.flush():this.revive()}))}revive(){for(const n of this.#o)this.#r.delete(n),ar(n,ti),is(n);for(const n of this.#r)ar(n,Vi),is(n);this.flush()}oncommit(n){this.#t.add(n)}ondiscard(n){this.#e.add(n)}settled(){return(this.#a??=Yu()).promise}static ensure(){if(Xe===null){const n=Xe=new Us;jo.add(Xe),Ka||gs(()=>{Xe===n&&n.flush()})}return Xe}apply(){}}function dr(e){var n=Ka;Ka=!0;try{for(var i;;){if(Uv(),xi.length===0&&(Xe?.flush(),xi.length===0))return Uo=null,i;vf()}}finally{Ka=n}}function vf(){Wl=!0;var e=null;try{for(var n=0;xi.length>0;){var i=Us.ensure();if(n++>1e3){var r,a;Yv()}i.process(xi),Js.clear()}}finally{xi=[],Wl=!1,Uo=null}}function Yv(){try{Ev()}catch(e){Ia(e,Uo)}}let ks=null;function Tu(e){var n=e.length;if(n!==0){for(var i=0;i<n;){var r=e[i++];if((r.f&(Cs|Li))===0&&Ra(r)&&(ks=new Set,ca(r),r.deps===null&&r.first===null&&r.nodes===null&&r.teardown===null&&r.ac===null&&Bf(r),ks?.size>0)){Js.clear();for(const a of ks){if((a.f&(Cs|Li))!==0)continue;const s=[a];let m=a.parent;for(;m!==null;)ks.has(m)&&(ks.delete(m),s.push(m)),m=m.parent;for(let g=s.length-1;g>=0;g--){const w=s[g];(w.f&(Cs|Li))===0&&ca(w)}}ks.clear()}}ks=null}}function pf(e,n,i,r){if(!i.has(e)&&(i.add(e),e.reactions!==null))for(const a of e.reactions){const s=a.f;(s&Zr)!==0?pf(a,n,i,r):(s&(ac|Bs))!==0&&(s&ti)===0&&mf(a,n,r)&&(ar(a,ti),is(a))}}function mf(e,n,i){const r=i.get(e);if(r!==void 0)return r;if(e.deps!==null)for(const a of e.deps){if(Aa.call(n,a))return!0;if((a.f&Zr)!==0&&mf(a,n,i))return i.set(a,!0),!0}return i.set(e,!1),!1}function is(e){var n=Uo=e,i=n.b;if(i?.is_pending&&(e.f&(Za|to|Ju))!==0&&(e.f&Gs)===0){i.defer_effect(e);return}for(;n.parent!==null;){n=n.parent;var r=n.f;if(Wl&&n===Be&&(r&Bs)!==0&&(r&Gu)===0&&(r&Gs)!==0)return;if((r&(da|os))!==0){if((r&Rr)===0)return;n.f^=Rr}}xi.push(n)}function hf(e,n){if(!((e.f&os)!==0&&(e.f&Rr)!==0)){(e.f&ti)!==0?n.d.push(e):(e.f&Vi)!==0&&n.m.push(e),ar(e,Rr);for(var i=e.first;i!==null;)hf(i,n),i=i.next}}function Qv(e){let n=0,i=la(0),r;return()=>{hc()&&(t(i),qa(()=>(n===0&&(r=_(()=>e(()=>Va(i)))),n+=1,()=>{gs(()=>{n-=1,n===0&&(r?.(),r=void 0,Va(i))})})))}}var Zv=Ea|Ba;function tp(e,n,i){new ep(e,n,i)}class ep{parent;is_pending=!1;#t;#e=he?ze:null;#n;#s;#a;#o=null;#r=null;#i=null;#l=null;#u=0;#c=0;#f=!1;#v=new Set;#p=new Set;#d=null;#b=Qv(()=>(this.#d=la(this.#u),()=>{this.#d=null}));constructor(n,i,r){this.#t=n,this.#n=i,this.#s=a=>{var s=Be;s.b=this,s.f|=Ol,r(a)},this.parent=Be.b,this.#a=gc(()=>{if(he){const a=this.#e;oa(),a.data===zo?this.#w():this.#y()}else this.#g()},Zv),he&&(this.#t=ze)}#y(){try{this.#o=ns(()=>this.#s(this.#t))}catch(n){this.error(n)}}#w(){const n=this.#n.pending;n&&(this.is_pending=!0,this.#r=ns(()=>n(this.#t)),gs(()=>{var i=this.#l=document.createDocumentFragment(),r=ki();i.append(r),this.#o=this.#h(()=>(Us.ensure(),ns(()=>this.#s(r)))),this.#c===0&&(this.#t.before(i),this.#l=null,ia(this.#r,()=>{this.#r=null}),this.#m())}))}#g(){try{if(this.is_pending=this.has_pending_snippet(),this.#c=0,this.#u=0,this.#o=ns(()=>{this.#s(this.#t)}),this.#c>0){var n=this.#l=document.createDocumentFragment();Rf(this.#o,n);const i=this.#n.pending;this.#r=ns(()=>i(this.#t))}else this.#m()}catch(i){this.error(i)}}#m(){this.is_pending=!1;for(const n of this.#v)ar(n,ti),is(n);for(const n of this.#p)ar(n,Vi),is(n);this.#v.clear(),this.#p.clear()}defer_effect(n){df(n,this.#v,this.#p)}is_rendered(){return!this.is_pending&&(!this.parent||this.parent.is_rendered())}has_pending_snippet(){return!!this.#n.pending}#h(n){var i=Be,r=He,a=Ln;ws(this.#a),Xi(this.#a),Ca(this.#a.ctx);try{return n()}catch(s){return uf(s),null}finally{ws(i),Xi(r),Ca(a)}}#_(n){if(!this.has_pending_snippet()){this.parent&&this.parent.#_(n);return}this.#c+=n,this.#c===0&&(this.#m(),this.#r&&ia(this.#r,()=>{this.#r=null}),this.#l&&(this.#t.before(this.#l),this.#l=null))}update_pending_count(n){this.#_(n),this.#u+=n,!(!this.#d||this.#f)&&(this.#f=!0,gs(()=>{this.#f=!1,this.#d&&Ma(this.#d,this.#u)}))}get_effect_pending(){return this.#b(),t(this.#d)}error(n){var i=this.#n.onerror;let r=this.#n.failed;if(!i&&!r)throw n;this.#o&&($i(this.#o),this.#o=null),this.#r&&($i(this.#r),this.#r=null),this.#i&&($i(this.#i),this.#i=null),he&&(ai(this.#e),ms(),ai(qo()));var a=!1,s=!1;const m=()=>{if(a){Gv();return}a=!0,s&&Bv(),this.#i!==null&&ia(this.#i,()=>{this.#i=null}),this.#h(()=>{Us.ensure(),this.#g()})};gs(()=>{try{s=!0,i?.(n,m),s=!1}catch(g){Ia(g,this.#a&&this.#a.parent)}r&&(this.#i=this.#h(()=>{Us.ensure();try{return ns(()=>{var g=Be;g.b=this,g.f|=Ol,r(this.#t,()=>n,()=>m)})}catch(g){return Ia(g,this.#a.parent),null}}))})}}function np(e,n,i,r){const a=ro()?Jo:Na;var s=e.filter(B=>!B.settled);if(i.length===0&&s.length===0){r(n.map(a));return}var m=Xe,g=Be,w=rp(),k=s.length===1?s[0].promise:s.length>1?Promise.all(s.map(B=>B.promise)):null;function b(B){w();try{r(B)}catch(F){(g.f&Cs)===0&&Ia(F,g)}m?.deactivate(),Ul()}if(i.length===0){k.then(()=>b(n.map(a)));return}function j(){w(),Promise.all(i.map(B=>sp(B))).then(B=>b([...n.map(a),...B])).catch(B=>Ia(B,g))}k?k.then(j):j()}function rp(){var e=Be,n=He,i=Ln,r=Xe;return function(s=!0){ws(e),Xi(n),Ca(i),s&&r?.activate()}}function Ul(){ws(null),Xi(null),Ca(null)}function ip(){var e=Be.b,n=Xe,i=e.is_rendered();return e.update_pending_count(1),n.increment(i),()=>{e.update_pending_count(-1),n.decrement(i)}}function Jo(e){var n=Zr|ti,i=He!==null&&(He.f&Zr)!==0?He:null;return Be!==null&&(Be.f|=Ba),{ctx:Ln,deps:null,effects:null,equals:Qu,f:n,fn:e,reactions:null,rv:0,v:Yr,wv:0,parent:i??Be,ac:null}}function sp(e,n,i){Be===null&&Sv();var a=void 0,s=la(Yr),m=!He,g=new Map;return hp(()=>{var w=Yu();a=w.promise;try{Promise.resolve(e()).then(w.resolve,w.reject).then(()=>{k===Xe&&k.committed&&k.deactivate(),Ul()})}catch(B){w.reject(B),Ul()}var k=Xe;if(m){var b=ip();g.get(k)?.reject(ta),g.delete(k),g.set(k,w)}const j=(B,F=void 0)=>{if(k.activate(),F)F!==ta&&(s.f|=Ws,Ma(s,F));else{(s.f&Ws)!==0&&(s.f^=Ws),Ma(s,B);for(const[O,E]of g){if(g.delete(O),O===k)break;E.reject(ta)}}b&&b()};w.promise.then(j,B=>j(null,B||"unknown"))}),Ko(()=>{for(const w of g.values())w.reject(ta)}),new Promise(w=>{function k(b){function j(){b===a?w(s):k(a)}b.then(j,j)}k(a)})}function $a(e){const n=Jo(e);return xf(n),n}function Na(e){const n=Jo(e);return n.equals=tf,n}function ap(e){var n=e.effects;if(n!==null){e.effects=null;for(var i=0;i<n.length;i+=1)$i(n[i])}}function op(e){for(var n=e.parent;n!==null;){if((n.f&Zr)===0)return(n.f&Cs)===0?n:null;n=n.parent}return null}function pc(e){var n,i=Be;ws(op(e));try{e.f&=~sa,ap(e),n=Tf(e)}finally{ws(i)}return n}function gf(e){var n=pc(e);if(!e.equals(n)&&(e.wv=kf(),(!Xe?.is_fork||e.deps===null)&&(e.v=n,e.deps===null))){ar(e,Rr);return}Ks||(rs!==null?(hc()||Xe?.is_fork)&&rs.set(e,n):vc(e))}function lp(e){if(e.effects!==null)for(const n of e.effects)(n.teardown||n.ac)&&(n.teardown?.(),n.ac?.abort(ta),n.teardown=Ns,n.ac=null,Ya(n,0),_c(n))}function _f(e){if(e.effects!==null)for(const n of e.effects)n.teardown&&ca(n)}let Jl=new Set;const Js=new Map;let bf=!1;function la(e,n){var i={f:0,v:e,reactions:null,equals:Qu,rv:0,wv:0};return i}function qs(e,n){const i=la(e);return xf(i),i}function W(e,n=!1,i=!0){const r=la(e);return n||(r.equals=tf),La&&i&&Ln!==null&&Ln.l!==null&&(Ln.l.s??=[]).push(r),r}function Qr(e,n){return f(e,_(()=>t(e))),n}function f(e,n,i=!1){He!==null&&(!ss||(He.f&xu)!==0)&&ro()&&(He.f&(Zr|Bs|ac|xu))!==0&&(Ki===null||!Aa.call(Ki,e))&&Mv();let r=i?ka(n):n;return Ma(e,r)}function Ma(e,n){if(!e.equals(n)){var i=e.v;Ks?Js.set(e,n):Js.set(e,i),e.v=n;var r=Us.ensure();if(r.capture(e,i),(e.f&Zr)!==0){const a=e;(e.f&ti)!==0&&pc(a),vc(a)}e.wv=kf(),yf(e,ti),ro()&&Be!==null&&(Be.f&Rr)!==0&&(Be.f&(os|da))===0&&(Ui===null?up([e]):Ui.push(e)),!r.is_fork&&Jl.size>0&&!bf&&cp()}return n}function cp(){bf=!1;for(const e of Jl)(e.f&Rr)!==0&&ar(e,Vi),Ra(e)&&ca(e);Jl.clear()}function Va(e){f(e,e.v+1)}function yf(e,n){var i=e.reactions;if(i!==null)for(var r=ro(),a=i.length,s=0;s<a;s++){var m=i[s],g=m.f;if(!(!r&&m===Be)){var w=(g&ti)===0;if(w&&ar(m,n),(g&Zr)!==0){var k=m;rs?.delete(k),(g&sa)===0&&(g&Gi&&(m.f|=sa),yf(k,Vi))}else w&&((g&Bs)!==0&&ks!==null&&ks.add(m),is(m))}}}function hs(e){he&&Ji(e)!==null&&dc(e)}let ju=!1;function wf(){ju||(ju=!0,document.addEventListener("reset",e=>{Promise.resolve().then(()=>{if(!e.defaultPrevented)for(const n of e.target.elements)n.__on_r?.()})},{capture:!0}))}function Go(e){var n=He,i=Be;Xi(null),ws(null);try{return e()}finally{Xi(n),ws(i)}}function mc(e,n,i,r=i){e.addEventListener(n,()=>Go(i));const a=e.__on_r;a?e.__on_r=()=>{a(),r(!0)}:e.__on_r=()=>r(!0),wf()}let Bo=!1,Ks=!1;function Eu(e){Ks=e}let He=null,ss=!1;function Xi(e){He=e}let Be=null;function ws(e){Be=e}let Ki=null;function xf(e){He!==null&&(Ki===null?Ki=[e]:Ki.push(e))}let Si=null,Di=0,Ui=null;function up(e){Ui=e}let Sf=1,na=0,ra=na;function Au(e){ra=e}function kf(){return++Sf}function Ra(e){var n=e.f;if((n&ti)!==0)return!0;if(n&Zr&&(e.f&=~sa),(n&Vi)!==0){for(var i=e.deps,r=i.length,a=0;a<r;a++){var s=i[a];if(Ra(s)&&gf(s),s.wv>e.wv)return!0}(n&Gi)!==0&&rs===null&&ar(e,Rr)}return!1}function $f(e,n,i=!0){var r=e.reactions;if(r!==null&&!(Ki!==null&&Aa.call(Ki,e)))for(var a=0;a<r.length;a++){var s=r[a];(s.f&Zr)!==0?$f(s,n,!1):n===s&&(i?ar(s,ti):(s.f&Rr)!==0&&ar(s,Vi),is(s))}}function Tf(e){var n=Si,i=Di,r=Ui,a=He,s=Ki,m=Ln,g=ss,w=ra,k=e.f;Si=null,Di=0,Ui=null,He=(k&(os|da))===0?e:null,Ki=null,Ca(e.ctx),ss=!1,ra=++na,e.ac!==null&&(Go(()=>{e.ac.abort(ta)}),e.ac=null);try{e.f|=Pl;var b=e.fn,j=b();e.f|=Gs;var B=e.deps,F=Xe?.is_fork;if(Si!==null){var O;if(F||Ya(e,Di),B!==null&&Di>0)for(B.length=Di+Si.length,O=0;O<Si.length;O++)B[Di+O]=Si[O];else e.deps=B=Si;if(hc()&&(e.f&Gi)!==0)for(O=Di;O<B.length;O++)(B[O].reactions??=[]).push(e)}else!F&&B!==null&&Di<B.length&&(Ya(e,Di),B.length=Di);if(ro()&&Ui!==null&&!ss&&B!==null&&(e.f&(Zr|Vi|ti))===0)for(O=0;O<Ui.length;O++)$f(Ui[O],e);if(a!==null&&a!==e){if(na++,a.deps!==null)for(let E=0;E<i;E+=1)a.deps[E].rv=na;if(n!==null)for(const E of n)E.rv=na;Ui!==null&&(r===null?r=Ui:r.push(...Ui))}return(e.f&Ws)!==0&&(e.f^=Ws),j}catch(E){return uf(E)}finally{e.f^=Pl,Si=n,Di=i,Ui=r,He=a,Ki=s,Ca(m),ss=g,ra=w}}function fp(e,n){let i=n.reactions;if(i!==null){var r=bv.call(i,e);if(r!==-1){var a=i.length-1;a===0?i=n.reactions=null:(i[r]=i[a],i.pop())}}if(i===null&&(n.f&Zr)!==0&&(Si===null||!Aa.call(Si,n))){var s=n;(s.f&Gi)!==0&&(s.f^=Gi,s.f&=~sa),vc(s),lp(s),Ya(s,0)}}function Ya(e,n){var i=e.deps;if(i!==null)for(var r=n;r<i.length;r++)fp(e,i[r])}function ca(e){var n=e.f;if((n&Cs)===0){ar(e,Rr);var i=Be,r=Bo;Be=e,Bo=!0;try{(n&(Bs|Ju))!==0?gp(e):_c(e),Nf(e);var a=Tf(e);e.teardown=typeof a=="function"?a:null,e.wv=Sf;var s;Hl&&Dv&&(e.f&ti)!==0&&e.deps}finally{Bo=r,Be=i}}}async function dp(){await Promise.resolve(),dr()}function t(e){var n=e.f,i=(n&Zr)!==0;if(He!==null&&!ss){var r=Be!==null&&(Be.f&Cs)!==0;if(!r&&(Ki===null||!Aa.call(Ki,e))){var a=He.deps;if((He.f&Pl)!==0)e.rv<na&&(e.rv=na,Si===null&&a!==null&&a[Di]===e?Di++:Si===null?Si=[e]:Si.push(e));else{(He.deps??=[]).push(e);var s=e.reactions;s===null?e.reactions=[He]:Aa.call(s,He)||s.push(He)}}}if(Ks&&Js.has(e))return Js.get(e);if(i){var m=e;if(Ks){var g=m.v;return((m.f&Rr)===0&&m.reactions!==null||Ef(m))&&(g=pc(m)),Js.set(m,g),g}var w=(m.f&Gi)===0&&!ss&&He!==null&&(Bo||(He.f&Gi)!==0),k=(m.f&Gs)===0;Ra(m)&&(w&&(m.f|=Gi),gf(m)),w&&!k&&(_f(m),jf(m))}if(rs?.has(e))return rs.get(e);if((e.f&Ws)!==0)throw e.v;return e.v}function jf(e){if(e.f|=Gi,e.deps!==null)for(const n of e.deps)(n.reactions??=[]).push(e),(n.f&Zr)!==0&&(n.f&Gi)===0&&(_f(n),jf(n))}function Ef(e){if(e.v===Yr)return!0;if(e.deps===null)return!1;for(const n of e.deps)if(Js.has(n)||(n.f&Zr)!==0&&Ef(n))return!0;return!1}function _(e){var n=ss;try{return ss=!0,e()}finally{ss=n}}function se(e){if(!(typeof e!="object"||!e||e instanceof EventTarget)){if(Is in e)Gl(e);else if(!Array.isArray(e))for(let n in e){const i=e[n];typeof i=="object"&&i&&Is in i&&Gl(i)}}}function Gl(e,n=new Set){if(typeof e=="object"&&e!==null&&!(e instanceof EventTarget)&&!n.has(e)){n.add(e),e instanceof Date&&e.getTime();for(let r in e)try{Gl(e[r],n)}catch{}const i=lc(e);if(i!==Object.prototype&&i!==Array.prototype&&i!==Map.prototype&&i!==Set.prototype&&i!==Date.prototype){const r=Xu(i);for(let a in r){const s=r[a].get;if(s)try{s.call(e)}catch{}}}}}function Af(e){Be===null&&(He===null&&jv(),Tv()),Ks&&$v()}function vp(e,n){var i=n.last;i===null?n.last=n.first=e:(i.next=e,e.prev=i,n.last=e)}function xs(e,n,i){var r=Be;r!==null&&(r.f&Li)!==0&&(e|=Li);var a={ctx:Ln,deps:null,nodes:null,f:e|ti|Gi,first:null,fn:n,last:null,next:null,parent:r,b:r&&r.b,prev:null,teardown:null,wv:0,ac:null};if(i)try{ca(a)}catch(g){throw $i(a),g}else n!==null&&is(a);var s=a;if(i&&s.deps===null&&s.teardown===null&&s.nodes===null&&s.first===s.last&&(s.f&Ba)===0&&(s=s.first,(e&Bs)!==0&&(e&Ea)!==0&&s!==null&&(s.f|=Ea)),s!==null&&(s.parent=r,r!==null&&vp(s,r),He!==null&&(He.f&Zr)!==0&&(e&da)===0)){var m=He;(m.effects??=[]).push(s)}return a}function hc(){return He!==null&&!ss}function Ko(e){const n=xs(to,null,!1);return ar(n,Rr),n.teardown=e,n}function Kl(e){Af();var n=Be.f,i=!He&&(n&os)!==0&&(n&Gs)===0;if(i){var r=Ln;(r.e??=[]).push(e)}else return Cf(e)}function Cf(e){return xs(Za|Ku,e,!1)}function pp(e){return Af(),xs(to|Ku,e,!0)}function mp(e){Us.ensure();const n=xs(da|Ba,e,!0);return(i={})=>new Promise(r=>{i.outro?ia(n,()=>{$i(n),r(void 0)}):($i(n),r(void 0))})}function If(e){return xs(Za,e,!1)}function Hs(e,n){var i=Ln,r={effect:null,ran:!1,deps:e};i.l.$.push(r),r.effect=qa(()=>{e(),!r.ran&&(r.ran=!0,_(n))})}function so(){var e=Ln;qa(()=>{for(var n of e.l.$){n.deps();var i=n.effect;(i.f&Rr)!==0&&i.deps!==null&&ar(i,Vi),Ra(i)&&ca(i),n.ran=!1}})}function hp(e){return xs(ac|Ba,e,!0)}function qa(e,n=0){return xs(to|n,e,!0)}function rt(e,n=[],i=[],r=[]){np(r,n,i,a=>{xs(to,()=>e(...a.map(t)),!0)})}function gc(e,n=0){var i=xs(Bs|n,e,!0);return i}function ns(e){return xs(os|Ba,e,!0)}function Nf(e){var n=e.teardown;if(n!==null){const i=Ks,r=He;Eu(!0),Xi(null);try{n.call(null)}finally{Eu(i),Xi(r)}}}function _c(e,n=!1){var i=e.first;for(e.first=e.last=null;i!==null;){const a=i.ac;a!==null&&Go(()=>{a.abort(ta)});var r=i.next;(i.f&da)!==0?i.parent=null:$i(i,n),i=r}}function gp(e){for(var n=e.first;n!==null;){var i=n.next;(n.f&os)===0&&$i(n),n=i}}function $i(e,n=!0){var i=!1;(n||(e.f&Gu)!==0)&&e.nodes!==null&&e.nodes.end!==null&&(Mf(e.nodes.start,e.nodes.end),i=!0),_c(e,n&&!i),Ya(e,0),ar(e,Cs);var r=e.nodes&&e.nodes.t;if(r!==null)for(const s of r)s.stop();Nf(e);var a=e.parent;a!==null&&a.first!==null&&Bf(e),e.next=e.prev=e.teardown=e.ctx=e.deps=e.fn=e.nodes=e.ac=null}function Mf(e,n){for(;e!==null;){var i=e===n?null:ls(e);e.remove(),e=i}}function Bf(e){var n=e.parent,i=e.prev,r=e.next;i!==null&&(i.next=r),r!==null&&(r.prev=i),n!==null&&(n.first===e&&(n.first=r),n.last===e&&(n.last=i))}function ia(e,n,i=!0){var r=[];Df(e,r,!0);var a=()=>{i&&$i(e),n&&n()},s=r.length;if(s>0){var m=()=>--s||a();for(var g of r)g.out(m)}else a()}function Df(e,n,i){if((e.f&Li)===0){e.f^=Li;var r=e.nodes&&e.nodes.t;if(r!==null)for(const g of r)(g.is_global||i)&&n.push(g);for(var a=e.first;a!==null;){var s=a.next,m=(a.f&Ea)!==0||(a.f&os)!==0&&(e.f&Bs)!==0;Df(a,n,m?i:!1),a=s}}}function bc(e){Lf(e,!0)}function Lf(e,n){if((e.f&Li)!==0){e.f^=Li,(e.f&Rr)===0&&(ar(e,ti),is(e));for(var i=e.first;i!==null;){var r=i.next,a=(i.f&Ea)!==0||(i.f&os)!==0;Lf(i,a?n:!1),i=r}var s=e.nodes&&e.nodes.t;if(s!==null)for(const m of s)(m.is_global||n)&&m.in()}}function Rf(e,n){if(e.nodes)for(var i=e.nodes.start,r=e.nodes.end;i!==null;){var a=i===r?null:ls(i);n.append(i),i=a}}const Eo=Symbol("events"),_p=new Set,Cu=new Set;function bp(e,n,i,r={}){function a(s){if(r.capture||Vl.call(n,s),!s.cancelBubble)return Go(()=>i?.call(this,s))}return e.startsWith("pointer")||e.startsWith("touch")||e==="wheel"?gs(()=>{n.addEventListener(e,a,r)}):n.addEventListener(e,a,r),a}function C(e,n,i,r,a){var s={capture:r,passive:a},m=bp(e,n,i,s);(n===document.body||n===window||n===document||n instanceof HTMLMediaElement)&&Ko(()=>{n.removeEventListener(e,m,s)})}let Iu=null;function Vl(e){var n=this,i=n.ownerDocument,r=e.type,a=e.composedPath?.()||[],s=a[0]||e.target;Iu=e;var m=0,g=Iu===e&&e[Eo];if(g){var w=a.indexOf(g);if(w!==-1&&(n===document||n===window)){e[Eo]=n;return}var k=a.indexOf(n);if(k===-1)return;w<=k&&(m=w)}if(s=a[m]||e.target,s!==n){oc(e,"currentTarget",{configurable:!0,get(){return s||i}});var b=He,j=Be;Xi(null),ws(null);try{for(var B,F=[];s!==null;){var O=s.assignedSlot||s.parentNode||s.host||null;try{var E=s[Eo]?.[r];E!=null&&(!s.disabled||e.target===s)&&E.call(s,e)}catch(P){B?F.push(P):B=P}if(e.cancelBubble||O===n||O===null)break;s=O}if(B){for(let P of F)queueMicrotask(()=>{throw P});throw B}}finally{e[Eo]=n,delete e.currentTarget,Xi(b),ws(j)}}}const yp=globalThis?.window?.trustedTypes&&globalThis.window.trustedTypes.createPolicy("svelte-trusted-html",{createHTML:e=>e});function wp(e){return yp?.createHTML(e)??e}function qf(e,n=!1){var i=Vv("template");return e=e.replaceAll("<!>","<!---->"),i.innerHTML=n?wp(e):e,i.content}function _s(e,n){var i=Be;i.nodes===null&&(i.nodes={start:e,end:n,a:null,t:null})}function q(e,n){var i=(n&zv)!==0,r=(n&Wv)!==0,a,s=!e.startsWith("<!>");return()=>{if(he)return _s(ze,null),ze;a===void 0&&(a=qf(s?e:"<!>"+e,!0),i||(a=Ji(a)));var m=r||af?document.importNode(a,!0):a.cloneNode(!0);if(i){var g=Ji(m),w=m.lastChild;_s(g,w)}else _s(m,m);return m}}function es(e=""){if(!he){var n=ki(e+"");return _s(n,n),n}var i=ze;return i.nodeType!==eo?(i.before(i=ki()),ai(i)):Wo(i),_s(i,i),i}function Vs(){if(he)return _s(ze,null),ze;var e=document.createDocumentFragment(),n=document.createComment(""),i=ki();return e.append(n,i),_s(n,i),e}function M(e,n){if(he){var i=Be;((i.f&Gs)===0||i.nodes.end===null)&&(i.nodes.end=ze),oa();return}e!==null&&e.before(n)}const xp=["touchstart","touchmove"];function Sp(e){return xp.includes(e)}function D(e,n){var i=n==null?"":typeof n=="object"?n+"":n;i!==(e.__t??=e.nodeValue)&&(e.__t=i,e.nodeValue=i+"")}function Ff(e,n){return Of(e,n)}function kp(e,n){zl(),n.intro=n.intro??!1;const i=n.target,r=he,a=ze;try{for(var s=Ji(i);s&&(s.nodeType!==Da||s.data!==uc);)s=ls(s);if(!s)throw aa;As(!0),ai(s);const m=Of(e,{...n,anchor:s});return As(!1),m}catch(m){if(m instanceof Error&&m.message.split(`
`).some(g=>g.startsWith("https://svelte.dev/e/")))throw m;return m!==aa&&console.warn("Failed to hydrate: ",m),n.recover===!1&&Av(),zl(),dc(i),As(!1),Ff(e,n)}finally{As(r),ai(a)}}const Ao=new Map;function Of(e,{target:n,anchor:i,props:r={},events:a,context:s,intro:m=!0}){zl();var g=void 0,w=mp(()=>{var k=i??n.appendChild(ki());tp(k,{pending:()=>{}},B=>{oi({});var F=Ln;if(s&&(F.c=s),a&&(r.$$events=a),he&&_s(B,null),g=e(B,r)||{},he&&(Be.nodes.end=ze,ze===null||ze.nodeType!==Da||ze.data!==fc))throw io(),aa;li()});var b=new Set,j=B=>{for(var F=0;F<B.length;F++){var O=B[F];if(!b.has(O)){b.add(O);var E=Sp(O);for(const U of[n,document]){var P=Ao.get(U);P===void 0&&(P=new Map,Ao.set(U,P));var dt=P.get(O);dt===void 0?(U.addEventListener(O,Vl,{passive:E}),P.set(O,1)):P.set(O,dt+1)}}}};return j(Ho(_p)),Cu.add(j),()=>{for(var B of b)for(const E of[n,document]){var F=Ao.get(E),O=F.get(B);--O==0?(E.removeEventListener(B,Vl),F.delete(B),F.size===0&&Ao.delete(E)):F.set(B,O)}Cu.delete(j),k!==i&&k.parentNode?.removeChild(k)}});return Xl.set(g,w),g}let Xl=new WeakMap;function $p(e,n){const i=Xl.get(e);return i?(Xl.delete(e),i(n)):Promise.resolve()}function Tp(e){return function(...n){var i=n[0];i.target===this&&e?.apply(this,n)}}function ua(e){return function(...n){var i=n[0];return i.stopPropagation(),e?.apply(this,n)}}function mi(e){return new jp(e)}class jp{#t;#e;constructor(n){var i=new Map,r=(s,m)=>{var g=W(m,!1,!1);return i.set(s,g),g};const a=new Proxy({...n.props||{},$$events:{}},{get(s,m){return t(i.get(m)??r(m,Reflect.get(s,m)))},has(s,m){return m===Vu?!0:(t(i.get(m)??r(m,Reflect.get(s,m))),Reflect.has(s,m))},set(s,m,g){return f(i.get(m)??r(m,g),g),Reflect.set(s,m,g)}});this.#e=(n.hydrate?kp:Ff)(n.component,{target:n.target,anchor:n.anchor,props:a,context:n.context,intro:n.intro??!1,recover:n.recover}),(!n?.props?.$$host||n.sync===!1)&&dr(),this.#t=a.$$events;for(const s of Object.keys(this.#e))s==="$set"||s==="$destroy"||s==="$on"||oc(this,s,{get(){return this.#e[s]},set(m){this.#e[s]=m},enumerable:!0});this.#e.$set=s=>{Object.assign(a,s)},this.#e.$destroy=()=>{$p(this.#e)}}$set(n){this.#e.$set(n)}$on(n,i){this.#t[n]=this.#t[n]||[];const r=(...a)=>i.call(this,...a);return this.#t[n].push(r),()=>{this.#t[n]=this.#t[n].filter(a=>a!==r)}}$destroy(){this.#e.$destroy()}}const Ep="5";typeof window<"u"&&((window.__svelte??={}).v??=new Set).add(Ep);Lv();class Ap{anchor;#t=new Map;#e=new Map;#n=new Map;#s=new Set;#a=!0;constructor(n,i=!0){this.anchor=n,this.#a=i}#o=()=>{var n=Xe;if(this.#t.has(n)){var i=this.#t.get(n),r=this.#e.get(i);if(r)bc(r),this.#s.delete(i);else{var a=this.#n.get(i);a&&(this.#e.set(i,a.effect),this.#n.delete(i),a.fragment.lastChild.remove(),this.anchor.before(a.fragment),r=a.effect)}for(const[s,m]of this.#t){if(this.#t.delete(s),s===n)break;const g=this.#n.get(m);g&&($i(g.effect),this.#n.delete(m))}for(const[s,m]of this.#e){if(s===i||this.#s.has(s))continue;const g=()=>{if(Array.from(this.#t.values()).includes(s)){var k=document.createDocumentFragment();Rf(m,k),k.append(ki()),this.#n.set(s,{effect:m,fragment:k})}else $i(m);this.#s.delete(s),this.#e.delete(s)};this.#a||!r?(this.#s.add(s),ia(m,g,!1)):g()}}};#r=n=>{this.#t.delete(n);const i=Array.from(this.#t.values());for(const[r,a]of this.#n)i.includes(r)||($i(a.effect),this.#n.delete(r))};ensure(n,i){var r=Xe,a=cf();if(i&&!this.#e.has(n)&&!this.#n.has(n))if(a){var s=document.createDocumentFragment(),m=ki();s.append(m),this.#n.set(n,{effect:ns(()=>i(m)),fragment:s})}else this.#e.set(n,ns(()=>i(this.anchor)));if(this.#t.set(r,n),a){for(const[g,w]of this.#e)g===n?r.unskip_effect(w):r.skip_effect(w);for(const[g,w]of this.#n)g===n?r.unskip_effect(w.effect):r.skip_effect(w.effect);r.oncommit(this.#o),r.ondiscard(this.#r)}else he&&(this.anchor=ze),this.#o()}}function Fa(e){Ln===null&&cc(),La&&Ln.l!==null?Np(Ln).m.push(e):Kl(()=>{const n=_(e);if(typeof n=="function")return n})}function Cp(e){Ln===null&&cc(),Fa(()=>()=>_(e))}function Ip(e,n,{bubbles:i=!1,cancelable:r=!1}={}){return new CustomEvent(e,{detail:n,bubbles:i,cancelable:r})}function yc(){const e=Ln;return e===null&&cc(),(n,i,r)=>{const a=e.s.$$events?.[n];if(a){const s=no(a)?a.slice():[a],m=Ip(n,i,r);for(const g of s)g.call(e.x,m);return!m.defaultPrevented}return!0}}function Np(e){var n=e.l;return n.u??={a:[],b:[],m:[]}}function Z(e,n,i=!1){he&&oa();var r=new Ap(e),a=i?Ea:0;function s(m,g){if(he){const b=sf(e);var w;if(b===uc?w=0:b===zo?w=!1:w=parseInt(b.substring(1)),m!==w){var k=qo();ai(k),r.anchor=k,As(!1),r.ensure(m,g),As(!0);return}}r.ensure(m,g)}gc(()=>{var m=!1;n((g,w=0)=>{m=!0,s(w,g)}),m||s(!1,null)},a)}function Fn(e,n){return n}function Mp(e,n,i){for(var r=[],a=n.length,s,m=n.length,g=0;g<a;g++){let j=n[g];ia(j,()=>{if(s){if(s.pending.delete(j),s.done.add(j),s.pending.size===0){var B=e.outrogroups;Yl(Ho(s.done)),B.delete(s),B.size===0&&(e.outrogroups=null)}}else m-=1},!1)}if(m===0){var w=r.length===0&&i!==null;if(w){var k=i,b=k.parentNode;dc(b),b.append(k),e.items.clear()}Yl(n,!w)}else s={pending:new Set(n),done:new Set},(e.outrogroups??=new Set).add(s)}function Yl(e,n=!0){for(var i=0;i<e.length;i++)$i(e[i],n)}var Nu;function on(e,n,i,r,a,s=null){var m=e,g=new Map,w=(n&ef)!==0;if(w){var k=e;m=he?ai(Ji(k)):k.appendChild(ki())}he&&oa();var b=null,j=Na(()=>{var dt=i();return no(dt)?dt:dt==null?[]:Ho(dt)}),B,F=!0;function O(){P.fallback=b,Bp(P,B,m,n,r),b!==null&&(B.length===0?(b.f&Es)===0?bc(b):(b.f^=Es,Ga(b,null,m)):ia(b,()=>{b=null}))}var E=gc(()=>{B=t(j);var dt=B.length;let U=!1;if(he){var lt=sf(m)===zo;lt!==(dt===0)&&(m=qo(),ai(m),As(!1),U=!0)}for(var Tt=new Set,wt=Xe,Nt=cf(),Wt=0;Wt<dt;Wt+=1){he&&ze.nodeType===Da&&ze.data===fc&&(m=ze,U=!0,As(!1));var tt=B[Wt],Et=r(tt,Wt),kt=F?null:g.get(Et);kt?(kt.v&&Ma(kt.v,tt),kt.i&&Ma(kt.i,Wt),Nt&&wt.unskip_effect(kt.e)):(kt=Dp(g,F?m:Nu??=ki(),tt,Et,Wt,a,n,i),F||(kt.e.f|=Es),g.set(Et,kt)),Tt.add(Et)}if(dt===0&&s&&!b&&(F?b=ns(()=>s(m)):(b=ns(()=>s(Nu??=ki())),b.f|=Es)),dt>Tt.size&&kv(),he&&dt>0&&ai(qo()),!F)if(Nt){for(const[Jt,de]of g)Tt.has(Jt)||wt.skip_effect(de.e);wt.oncommit(O),wt.ondiscard(()=>{})}else O();U&&As(!0),t(j)}),P={effect:E,items:g,outrogroups:null,fallback:b};F=!1,he&&(m=ze)}function Ua(e){for(;e!==null&&(e.f&os)===0;)e=e.next;return e}function Bp(e,n,i,r,a){var s=(r&Fv)!==0,m=n.length,g=e.items,w=Ua(e.effect.first),k,b=null,j,B=[],F=[],O,E,P,dt;if(s)for(dt=0;dt<m;dt+=1)O=n[dt],E=a(O,dt),P=g.get(E).e,(P.f&Es)===0&&(P.nodes?.a?.measure(),(j??=new Set).add(P));for(dt=0;dt<m;dt+=1){if(O=n[dt],E=a(O,dt),P=g.get(E).e,e.outrogroups!==null)for(const kt of e.outrogroups)kt.pending.delete(P),kt.done.delete(P);if((P.f&Es)!==0)if(P.f^=Es,P===w)Ga(P,null,i);else{var U=b?b.next:w;P===e.effect.last&&(e.effect.last=P.prev),P.prev&&(P.prev.next=P.next),P.next&&(P.next.prev=P.prev),Fs(e,b,P),Fs(e,P,U),Ga(P,U,i),b=P,B=[],F=[],w=Ua(b.next);continue}if((P.f&Li)!==0&&(bc(P),s&&(P.nodes?.a?.unfix(),(j??=new Set).delete(P))),P!==w){if(k!==void 0&&k.has(P)){if(B.length<F.length){var lt=F[0],Tt;b=lt.prev;var wt=B[0],Nt=B[B.length-1];for(Tt=0;Tt<B.length;Tt+=1)Ga(B[Tt],lt,i);for(Tt=0;Tt<F.length;Tt+=1)k.delete(F[Tt]);Fs(e,wt.prev,Nt.next),Fs(e,b,wt),Fs(e,Nt,lt),w=lt,b=Nt,dt-=1,B=[],F=[]}else k.delete(P),Ga(P,w,i),Fs(e,P.prev,P.next),Fs(e,P,b===null?e.effect.first:b.next),Fs(e,b,P),b=P;continue}for(B=[],F=[];w!==null&&w!==P;)(k??=new Set).add(w),F.push(w),w=Ua(w.next);if(w===null)continue}(P.f&Es)===0&&B.push(P),b=P,w=Ua(P.next)}if(e.outrogroups!==null){for(const kt of e.outrogroups)kt.pending.size===0&&(Yl(Ho(kt.done)),e.outrogroups?.delete(kt));e.outrogroups.size===0&&(e.outrogroups=null)}if(w!==null||k!==void 0){var Wt=[];if(k!==void 0)for(P of k)(P.f&Li)===0&&Wt.push(P);for(;w!==null;)(w.f&Li)===0&&w!==e.fallback&&Wt.push(w),w=Ua(w.next);var tt=Wt.length;if(tt>0){var Et=(r&ef)!==0&&m===0?i:null;if(s){for(dt=0;dt<tt;dt+=1)Wt[dt].nodes?.a?.measure();for(dt=0;dt<tt;dt+=1)Wt[dt].nodes?.a?.fix()}Mp(e,Wt,Et)}}s&&gs(()=>{if(j!==void 0)for(P of j)P.nodes?.a?.apply()})}function Dp(e,n,i,r,a,s,m,g){var w=(m&Rv)!==0?(m&Ov)===0?W(i,!1,!1):la(i):null,k=(m&qv)!==0?la(a):null;return{v:w,i:k,e:ns(()=>(s(n,w??i,k??a,g),()=>{e.delete(r)}))}}function Ga(e,n,i){if(e.nodes)for(var r=e.nodes.start,a=e.nodes.end,s=n&&(n.f&Es)===0?n.nodes.start:i;r!==null;){var m=ls(r);if(s.before(r),r===a)return;r=m}}function Fs(e,n,i){n===null?e.effect.first=i:n.next=i,i===null?e.effect.last=n:i.prev=n}function Lp(e,n,i=!1,r=!1,a=!1){var s=e,m="";rt(()=>{var g=Be;if(m===(m=n()??"")){he&&oa();return}if(g.nodes!==null&&(Mf(g.nodes.start,g.nodes.end),g.nodes=null),m!==""){if(he){ze.data;for(var w=oa(),k=w;w!==null&&(w.nodeType!==Da||w.data!=="");)k=w,w=ls(w);if(w===null)throw io(),aa;_s(ze,k),s=ai(w);return}var b=m+"";i?b=`<svg>${b}</svg>`:r&&(b=`<math>${b}</math>`);var j=qf(b);if((i||r)&&(j=Ji(j)),_s(Ji(j),j.lastChild),i||r)for(;Ji(j);)s.before(Ji(j));else s.before(j)}})}function Pf(e,n,i,r,a){he&&oa();var s=n.$$slots?.[i],m=!1;s===!0&&(s=n.children,m=!0),s===void 0||s(e,m?()=>r:r)}const Mu=[...` 	
\r\f \v\uFEFF`];function Rp(e,n,i){var r=e==null?"":""+e;if(n&&(r=r?r+" "+n:n),i){for(var a of Object.keys(i))if(i[a])r=r?r+" "+a:a;else if(r.length)for(var s=a.length,m=0;(m=r.indexOf(a,m))>=0;){var g=m+s;(m===0||Mu.includes(r[m-1]))&&(g===r.length||Mu.includes(r[g]))?r=(m===0?"":r.substring(0,m))+r.substring(g+1):m=g}}return r===""?null:r}function qp(e,n){return e==null?null:String(e)}function Me(e,n,i,r,a,s){var m=e.__className;if(he||m!==i||m===void 0){var g=Rp(i,r,s);(!he||g!==e.getAttribute("class"))&&(g==null?e.removeAttribute("class"):e.className=g),e.__className=i}else if(s&&a!==s)for(var w in s){var k=!!s[w];(a==null||k!==!!a[w])&&e.classList.toggle(w,k)}return s}function Ts(e,n,i,r){var a=e.__style;if(he||a!==n){var s=qp(n);(!he||s!==e.getAttribute("style"))&&(s==null?e.removeAttribute("style"):e.style.cssText=s),e.__style=n}return r}function Hf(e,n,i=!1){if(e.multiple){if(n==null)return;if(!no(n))return Jv();for(var r of e.options)r.selected=n.includes(Xa(r));return}for(r of e.options){var a=Xa(r);if(Kv(a,n)){r.selected=!0;return}}(!i||n!==void 0)&&(e.selectedIndex=-1)}function Fp(e){var n=new MutationObserver(()=>{Hf(e,e.__value)});n.observe(e,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["value"]}),Ko(()=>{n.disconnect()})}function $s(e,n,i=n){var r=new WeakSet,a=!0;mc(e,"change",s=>{var m=s?"[selected]":":checked",g;if(e.multiple)g=[].map.call(e.querySelectorAll(m),Xa);else{var w=e.querySelector(m)??e.querySelector("option:not([disabled])");g=w&&Xa(w)}i(g),Xe!==null&&r.add(Xe)}),If(()=>{var s=n();if(e===document.activeElement){var m=Fo??Xe;if(r.has(m))return}if(Hf(e,s,a),a&&s===void 0){var g=e.querySelector(":checked");g!==null&&(s=Xa(g),i(s))}e.__value=s,a=!1}),Fp(e)}function Xa(e){return"__value"in e?e.__value:e.value}const Op=Symbol("is custom element"),Pp=Symbol("is html"),Hp=_v?"link":"LINK";function Zn(e){if(he){var n=!1,i=()=>{if(!n){if(n=!0,e.hasAttribute("value")){var r=e.value;js(e,"value",null),e.value=r}if(e.hasAttribute("checked")){var a=e.checked;js(e,"checked",null),e.checked=a}}};e.__on_r=i,gs(i),wf()}}function js(e,n,i,r){var a=zp(e);he&&(a[n]=e.getAttribute(n),n==="src"||n==="srcset"||n==="href"&&e.nodeName===Hp)||a[n]!==(a[n]=i)&&(n==="loading"&&(e[gv]=i),i==null?e.removeAttribute(n):typeof i!="string"&&Wp(e).includes(n)?e[n]=i:e.setAttribute(n,i))}function zp(e){return e.__attributes??={[Op]:e.nodeName.includes("-"),[Pp]:e.namespaceURI===nf}}var Bu=new Map;function Wp(e){var n=e.getAttribute("is")||e.nodeName,i=Bu.get(n);if(i)return i;Bu.set(n,i=[]);for(var r,a=e,s=Element.prototype;s!==a;){r=Xu(a);for(var m in r)r[m].set&&i.push(m);a=lc(a)}return i}function rn(e,n,i=n){var r=new WeakSet;mc(e,"input",async a=>{var s=a?e.defaultValue:e.value;if(s=Bl(e)?Dl(s):s,i(s),Xe!==null&&r.add(Xe),await dp(),s!==(s=n())){var m=e.selectionStart,g=e.selectionEnd,w=e.value.length;if(e.value=s??"",g!==null){var k=e.value.length;m===g&&g===w&&k>w?(e.selectionStart=k,e.selectionEnd=k):(e.selectionStart=m,e.selectionEnd=Math.min(g,k))}}}),(he&&e.defaultValue!==e.value||_(n)==null&&e.value)&&(i(Bl(e)?Dl(e.value):e.value),Xe!==null&&r.add(Xe)),qa(()=>{var a=n();if(e===document.activeElement){var s=Fo??Xe;if(r.has(s))return}Bl(e)&&a===Dl(e.value)||e.type==="date"&&!a&&!e.value||a!==e.value&&(e.value=a??"")})}function Ql(e,n,i=n){mc(e,"change",r=>{var a=r?e.defaultChecked:e.checked;i(a)}),(he&&e.defaultChecked!==e.checked||_(n)==null)&&i(e.checked),qa(()=>{var r=n();e.checked=!!r})}function Bl(e){var n=e.type;return n==="number"||n==="range"}function Dl(e){return e===""?null:+e}function Du(e,n){return e===n||e?.[Is]===n}function wc(e={},n,i,r){return If(()=>{var a,s;return qa(()=>{a=s,s=[],_(()=>{e!==i(...s)&&(n(e,...s),a&&Du(i(...a),e)&&n(null,...a))})}),()=>{gs(()=>{s&&Du(i(...s),e)&&n(null,...s)})}}),e}function Ds(e=!1){const n=Ln,i=n.l.u;if(!i)return;let r=()=>se(n.s);if(e){let a=0,s={};const m=Jo(()=>{let g=!1;const w=n.s;for(const k in w)w[k]!==s[k]&&(s[k]=w[k],g=!0);return g&&a++,a});r=()=>t(m)}i.b.length&&pp(()=>{Lu(n,r),Ro(i.b)}),Kl(()=>{const a=_(()=>i.m.map(xv));return()=>{for(const s of a)typeof s=="function"&&s()}}),i.a.length&&Kl(()=>{Lu(n,r),Ro(i.a)})}function Lu(e,n){if(e.l.s)for(const i of e.l.s)t(i);n()}function bs(e,n){var i=e.$$events?.[n.type],r=no(i)?i.slice():i==null?[]:[i];for(var a of r)a.call(this,n)}function hi(e,n,i){e.$$events||={},e.$$events[n]||=[],e.$$events[n].push(i)}function gi(e){for(var n in e)n in this&&(this[n]=e[n])}function xc(e,n,i){if(e==null)return n(void 0),i&&i(void 0),Ns;const r=_(()=>e.subscribe(n,i));return r.unsubscribe?()=>r.unsubscribe():r}const xa=[];function Up(e,n){return{subscribe:xr(e,n).subscribe}}function xr(e,n=Ns){let i=null;const r=new Set;function a(g){if(Zu(e,g)&&(e=g,i)){const w=!xa.length;for(const k of r)k[1](),xa.push(k,e);if(w){for(let k=0;k<xa.length;k+=2)xa[k][0](xa[k+1]);xa.length=0}}}function s(g){a(g(e))}function m(g,w=Ns){const k=[g,w];return r.add(k),r.size===1&&(i=n(a,s)||Ns),g(e),()=>{r.delete(k),r.size===0&&i&&(i(),i=null)}}return{set:a,update:s,subscribe:m}}function Jp(e,n,i){const r=!Array.isArray(e),a=r?[e]:e;if(!a.every(Boolean))throw new Error("derived() expects stores as input, got a falsy value");const s=n.length<2;return Up(i,(m,g)=>{let w=!1;const k=[];let b=0,j=Ns;const B=()=>{if(b)return;j();const O=n(r?k[0]:k,m,g);s?m(O):j=typeof O=="function"?O:Ns},F=a.map((O,E)=>xc(O,P=>{k[E]=P,b&=~(1<<E),w&&B()},()=>{b|=1<<E}));return w=!0,B(),function(){Ro(F),j(),w=!1}})}function as(e){let n;return xc(e,i=>n=i)(),n}let Co=!1,Zl=Symbol();function Qn(e,n,i){const r=i[n]??={store:null,source:W(void 0),unsubscribe:Ns};if(r.store!==e&&!(Zl in i))if(r.unsubscribe(),r.store=e??null,e==null)r.source.v=void 0,r.unsubscribe=Ns;else{var a=!0;r.unsubscribe=xc(e,s=>{a?r.source.v=s:f(r.source,s)}),a=!1}return e&&Zl in i?as(e):t(r.source)}function Gp(e,n){return e.set(n),n}function Oa(){const e={};function n(){Ko(()=>{for(var i in e)e[i].unsubscribe();oc(e,Zl,{enumerable:!1,value:!0})})}return[e,n]}function Kp(e){var n=Co;try{return Co=!1,[e(),Co]}finally{Co=n}}function qr(e,n,i,r){var a=!La||(i&Pv)!==0,s=(i&Hv)!==0,m=r,g=!0,w=()=>(g&&(g=!1,m=r),m),k;{var b=Is in e||Vu in e;k=Ta(e,n)?.set??(b&&n in e?U=>e[n]=U:void 0)}var j,B=!1;[j,B]=Kp(()=>e[n]),j===void 0&&r!==void 0&&(j=w(),k&&(a&&Cv(),k(j)));var F;if(a?F=()=>{var U=e[n];return U===void 0?w():(g=!0,U)}:F=()=>{var U=e[n];return U!==void 0&&(m=void 0),U===void 0?m:U},k){var O=e.$$legacy;return(function(U,lt){return arguments.length>0?((!a||!lt||O||B)&&k(lt?F():U),U):F()})}var E=!1,P=Na(()=>(E=!1,F()));t(P);var dt=Be;return(function(U,lt){if(arguments.length>0){const Tt=lt?t(P):a&&s?ka(U):U;return f(P,Tt),E=!0,m!==void 0&&(m=Tt),U}return Ks&&E||(dt.f&Cs)!==0?P.v:t(P)})}const Ms=xr(""),zs=xr(""),yr=xr(""),Lr=xr(null),Yn=xr(!1),Ps=xr("就绪"),Dr=xr("就绪"),Sc=xr([]),Vp=xr("等待解析…"),Xp=xr([]),Yp=xr([]),kc=xr([]),vs=xr(!1),Do=xr(null),Vo=xr([]),fa=xr(-1),$c=Jp(yr,e=>String(e||"").replace(/\s/g,"").length),tc=xr([]),Ru=xr(!1),Ja=xr(!1);let Ll=null,Rl=null;typeof window<"u"&&(window.__waGetStore=e=>{const i={docId:Ms,instruction:zs,sourceText:yr,docIr:Lr,docIrDirty:Yn,flowStatus:Ps,docStatus:Dr,generating:vs,wordCount:$c}[e];return i?as(i):void 0});async function Qp(){const e=as(Ms);if(!e)return;const n=await fetch(`/api/doc/${e}/chat`);if(!n.ok)return;const i=await n.json(),r=Array.isArray(i.items)?i.items:[];Sc.set(r)}async function Zp(){const e=as(Ms);if(!e)return;const n=await fetch(`/api/doc/${e}/thoughts`);if(!n.ok)return;const i=await n.json(),r=Array.isArray(i.items)?i.items:[];kc.set(r)}async function tm(e){const n=as(Ms);n&&await fetch(`/api/doc/${n}/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({items:e.slice(-200)})})}async function em(e){const n=as(Ms);n&&await fetch(`/api/doc/${n}/thoughts`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({items:e.slice(-200)})})}function Br(e,n){const i={role:e,text:String(n||"").trim()};i.text&&Sc.update(r=>{const a=[...r,i];return Ll&&clearTimeout(Ll),Ll=setTimeout(()=>{tm(a).catch(()=>{})},300),a})}function Wr(e,n,i){const r={label:e,detail:n,time:i||new Date().toLocaleTimeString()};kc.update(a=>{const s=[...a,r].slice(-200);return Rl&&clearTimeout(Rl),Rl=setTimeout(()=>{em(s).catch(()=>{})},300),s})}function pt(e,n="info"){const i=Date.now(),r={id:i,message:e,type:n};tc.update(a=>[...a,r]),setTimeout(()=>{tc.update(a=>a.filter(s=>s.id!==i))},2600)}function qu(e){const n=String(e||"");Vo.update(i=>{const r=i.slice(0,as(fa)+1);if(r[r.length-1]===n)return i;r.push(n);const a=r.slice(-50);return fa.set(a.length-1),a})}function nm(){const e=as(fa);if(e<=0)return;fa.set(e-1);const n=as(Vo);yr.set(n[e-1]||""),Yn.set(!0)}function rm(){const e=as(fa),n=as(Vo);e>=n.length-1||(fa.set(e+1),yr.set(n[e+1]||""),Yn.set(!0))}var im=q('<div class="assistant-header svelte-191yngm"><div class="assistant-title svelte-191yngm"><span class="assistant-dot svelte-191yngm"></span> 智能助手</div> <button class="assistant-toggle svelte-191yngm"> </button></div>'),sm=q('<div class="panel-title svelte-191yngm">对话写作</div>'),am=q('<div class="thought-item svelte-191yngm"><div class="thought-meta svelte-191yngm"><span class="label"> </span> <span class="time"> </span></div> <div class="detail svelte-191yngm"> </div></div>'),om=q('<div class="thoughts svelte-191yngm"><div class="thoughts-title svelte-191yngm">思考链</div> <div class="thought-list svelte-191yngm"></div></div>'),lm=q('<div><div class="chat-bubble svelte-191yngm"> </div></div>'),cm=q('<div><!> <!> <div class="chat-history svelte-191yngm"></div> <div class="composer-tools svelte-191yngm"><button class="attach-btn svelte-191yngm">上传内容</button> <span class="composer-tip svelte-191yngm">支持图片与文档</span></div> <div class="composer svelte-191yngm"><textarea rows="3" placeholder="输入需求或修改指令" class="svelte-191yngm"></textarea> <button class="send-btn svelte-191yngm">发送</button></div> <input class="hidden-input svelte-191yngm" type="file" accept="image/*,.doc,.docx,.pdf,.txt,.md,.html,.htm,.ppt,.pptx,.xls,.xlsx,.csv,.json"/></div>');function zf(e,n){if(new.target)return mi({component:zf,...e});oi(n,!1);const i=()=>Qn(zs,"$instruction",s),r=()=>Qn(kc,"$thoughtLog",s),a=()=>Qn(Sc,"$chat",s),[s,m]=Oa(),g=yc();let w=qr(n,"variant",12,"panel"),k=W(!0),b=W(null);function j(){const Mt=i().trim();Mt&&(g("send",Mt),zs.set(""),O())}function B(Mt){Mt.key==="Enter"&&!Mt.shiftKey&&(Mt.preventDefault(),j())}function F(){f(k,!t(k)),O()}function O(){queueMicrotask(()=>{const Mt=document.querySelector(".chat-history");Mt&&(Mt.scrollTop=Mt.scrollHeight);const mt=document.querySelector(".thought-list");mt&&(mt.scrollTop=mt.scrollHeight)})}function E(){t(b)?.click()}function P(Mt){const mt=Mt.currentTarget,jt=mt?.files?.[0];jt&&(g("upload",{file:jt}),mt&&(mt.value=""))}var dt={get variant(){return w()},set variant(Mt){w(Mt),dr()},$set:gi,$on:(Mt,mt)=>hi(n,Mt,mt)};Ds();var U=cm(),lt=v(U);{var Tt=Mt=>{var mt=im(),jt=u(v(mt),2),Bt=v(jt,!0);d(jt),d(mt),rt(()=>D(Bt,t(k)?"隐藏思考":"思考链")),C("click",jt,F),M(Mt,mt)},wt=Mt=>{var mt=sm();M(Mt,mt)};Z(lt,Mt=>{w()==="assistant"?Mt(Tt):Mt(wt,!1)})}var Nt=u(lt,2);{var Wt=Mt=>{var mt=om(),jt=u(v(mt),2);on(jt,5,r,Fn,(Bt,Kt)=>{var vn=am(),cn=v(vn),Le=v(cn),bt=v(Le,!0);d(Le);var At=u(Le,2),ee=v(At,!0);d(At),d(cn);var We=u(cn,2),ge=v(We,!0);d(We),d(vn),rt(()=>{D(bt,(t(Kt),_(()=>t(Kt).label))),D(ee,(t(Kt),_(()=>t(Kt).time))),D(ge,(t(Kt),_(()=>t(Kt).detail)))}),M(Bt,vn)}),d(jt),d(mt),M(Mt,mt)};Z(Nt,Mt=>{t(k)&&Mt(Wt)})}var tt=u(Nt,2);on(tt,5,a,Fn,(Mt,mt)=>{var jt=lm(),Bt=v(jt),Kt=v(Bt,!0);d(Bt),d(jt),rt(()=>{Me(jt,1,`chat-msg ${t(mt),_(()=>t(mt).role)??""}`,"svelte-191yngm"),D(Kt,(t(mt),_(()=>t(mt).text)))}),M(Mt,jt)}),d(tt);var Et=u(tt,2),kt=v(Et);ms(2),d(Et);var Jt=u(Et,2),de=v(Jt);hs(de);var De=u(de,2);d(Jt);var xe=u(Jt,2);wc(xe,Mt=>f(b,Mt),()=>t(b)),d(U),rt(()=>Me(U,1,`chat-shell ${w()}`,"svelte-191yngm")),C("click",kt,E),rn(de,i,Mt=>Gp(zs,Mt)),C("keydown",de,B),C("click",De,j),C("change",xe,P),M(e,U);var ln=li(dt);return m(),ln}function fr(e){return String(e||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function ys(e){let n=fr(e);return n=n.replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>"),n=n.replace(/\*(.+?)\*/g,"<em>$1</em>"),n=n.replace(/~~(.+?)~~/g,"<del>$1</del>"),n=n.replace(/==(.+?)==/g,"<mark>$1</mark>"),n=n.replace(/\+\+(.+?)\+\+/g,"<u>$1</u>"),n=n.replace(/\[(.+?)\]\((.+?)\)/g,'<a href="$2" target="_blank" rel="noopener">$1</a>'),n}function Oo(e){return String(e||"").trim().toLowerCase()}function Wf(e){const n=[];let i=[],r=!1;const a=()=>{i.length&&(i.length>=4?n.push(i.join("")):n.push(...i),i=[])};for(const s of e){const m=s.trim();if(!m){a(),r||(n.push(""),r=!0);continue}r=!1;const g=m.length<=1,w=/[\u4e00-\u9fa5A-Za-z0-9\.\-\u3000-\u303F]/.test(m);if(g&&w){i.push(m);continue}a(),n.push(s)}return a(),n}function Po(e,n,i=""){const r=ys(n),a=Math.min(6,Math.max(1,Number(e||1)));return`<h${a}${i}>${r}</h${a}>`}function um(e){return`<p>${ys(e).replace(/\n/g,"<br/>")}</p>`}function fm(e){const n=String(e.id||"").trim();return n?` data-block-id="${fr(n)}"`:""}function Tc(e){const n=e.style;if(!n||typeof n!="object")return"";const i=n,r=[],a=String(i.align||i.textAlign||"").trim();["left","center","right","justify"].includes(a)&&r.push(`text-align:${a}`);const s=String(i.lineHeight||"").trim();/^\d+(\.\d+)?$/.test(s)&&r.push(`line-height:${s}`);const m=String(i.indent||i.textIndent||"").trim();/^\d+(\.\d+)?(px|pt|em|rem)?$/.test(m)&&r.push(`text-indent:${m}`);const g=String(i.marginTop||"").trim();/^\d+(\.\d+)?(px|pt|em|rem)?$/.test(g)&&r.push(`margin-top:${g}`);const w=String(i.marginBottom||"").trim();/^\d+(\.\d+)?(px|pt|em|rem)?$/.test(w)&&r.push(`margin-bottom:${w}`);const k=String(i.fontFamily||"").trim();k&&k.length<80&&r.push(`font-family:${fr(k)}`);const b=String(i.fontSize||"").trim();/^\d+(\.\d+)?(px|pt|em|rem)?$/.test(b)&&r.push(`font-size:${b}`);const j=String(i.fontWeight||"").trim();/^(normal|bold|bolder|lighter|[1-9]00)$/.test(j)&&r.push(`font-weight:${j}`);const B=String(i.fontStyle||"").trim();/^(normal|italic|oblique)$/.test(B)&&r.push(`font-style:${B}`);const F=String(i.color||"").trim();(/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(F)||F.startsWith("rgb(")||F.startsWith("rgba("))&&r.push(`color:${fr(F)}`);const O=String(i.background||i.backgroundColor||"").trim();return(/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(O)||O.startsWith("rgb(")||O.startsWith("rgba("))&&r.push(`background-color:${fr(O)}`),r.length?` style="${r.join(";")}"`:""}function dm(e){const n={caption:"",columns:[],rows:[]},i=e.table,r=typeof i=="object"&&i?i:e.data,a=typeof r=="object"&&r?r:e;n.caption=String(a.caption||"").trim();const s=a.columns;Array.isArray(s)&&(n.columns=s.map(g=>String(g)));const m=a.rows;return Array.isArray(m)&&(n.rows=m),n}function vm(e){const n=e.figure,i=typeof n=="object"&&n?n:null,a=String((i||e).caption||"").trim(),s=i?{...i}:{};return a&&(s.caption=a),{caption:a,spec:s}}function pm(e){const n=[],i=String(e.color||"").trim();(/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(i)||i.startsWith("rgb("))&&n.push(`color:${fr(i)}`);const r=String(e.background||"").trim();(/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(r)||r.startsWith("rgb("))&&n.push(`background-color:${fr(r)}`);const a=String(e.font||"").trim();a&&a.length<80&&n.push(`font-family:${fr(a)}`);const s=String(e.size||"").trim();return/^\d+(\.\d+)?(px|pt|em|rem)?$/.test(s)&&n.push(`font-size:${s}`),n.length?` style="${n.join(";")}"`:""}function Fu(e){const n=[];return e.forEach(i=>{const r=String(i.text||"");if(!r)return;let a=fr(r).replace(/\n/g,"<br/>");i.bold&&(a=`<strong>${a}</strong>`),i.italic&&(a=`<em>${a}</em>`),i.underline&&(a=`<u>${a}</u>`),i.strike&&(a=`<del>${a}</del>`);const s=String(i.link||"").trim();s&&(a=`<a href="${fr(s)}" target="_blank" rel="noopener">${a}</a>`);const m=pm(i);m&&(a=`<span${m}>${a}</span>`),n.push(a)}),n.join("")}function mm(e){const n=/^H([1-6])::(.+)$/.exec(e);if(n){const i=Math.min(6,Math.max(1,Number(n[1]||2))),r=String(n[2]||"").trim();if(r)return`${"#".repeat(i)} ${r}`}return`## ${e}`}function hm(e){const n=/^H([1-6])::(.+)$/.exec(e);if(n){const i=Math.min(6,Math.max(1,Number(n[1]||2))),r=String(n[2]||"").trim();if(r)return Po(i,r)}return Po(2,e)}function Uf(e){const n=String(e.type||"paragraph").toLowerCase();if(n==="paragraph"||n==="text"||n==="p"){const r=Array.isArray(e.runs)?e.runs:null,s=(r&&r.length?r.map(m=>String(m.text||"")).join(""):String(e.text||"")).trim();return s?[s]:[]}if(n==="list"||n==="bullets"||n==="bullet"){const r=!!e.ordered,a=Array.isArray(e.items)?e.items:[];if(a.length){const g=a.map(w=>String(w||"").trim()).filter(Boolean);return r?g.map((w,k)=>`${k+1}. ${w}`):g.map(w=>`- ${w}`)}const s=String(e.text||"").trim();if(!s)return[];const m=s.split(/\n+/).map(g=>g.trim()).filter(Boolean);return r?m.map((g,w)=>`${w+1}. ${g.replace(/^\d+[\.\)]\s+/,"")}`):m.map(g=>g.startsWith("-")?g:`- ${g}`)}if(n==="table"||n==="figure"){const r={};return typeof e.caption=="string"&&(r.caption=e.caption),Array.isArray(e.columns)&&(r.columns=e.columns),Array.isArray(e.rows)&&(r.rows=e.rows),e.data&&typeof e.data=="object"&&(r.data=e.data),[`[[${n==="table"?"TABLE":"FIGURE"}:${JSON.stringify(r)}]]`]}if(n==="reference"||n==="ref"){const r=String(e.text||"").trim();return r?[r]:(Array.isArray(e.items)?e.items:[]).map(s=>String(s||"").trim()).filter(Boolean)}const i=String(e.text||"").trim();return i?[i]:[]}function Jf(e){const n=fm(e),i=Tc(e),r=String(e.type||"paragraph").toLowerCase();if(r==="heading"){const s=Math.min(6,Math.max(1,Number(e.level||1))),m=String(e.text||""),g=Array.isArray(e.runs)?e.runs:null,w=m.trim(),k=`${n}${i}`;if(g&&g.length){const b=Fu(g);return`<h${s}${k}>${b||"<br/>"}</h${s}>`}return w?Po(s,m,k):k?`<h${s}${k}><br/></h${s}>`:""}if(r==="paragraph"||r==="text"||r==="p"){const s=String(e.text||""),m=Array.isArray(e.runs)?e.runs:null,g=s.trim(),w=`${n}${i}`;if(m&&m.length){const k=Fu(m);return`<p${w}>${k||"<br/>"}</p>`}return g?`<p${w}>${ys(s).replace(/\n/g,"<br/>")}</p>`:w?`<p${w}><br/></p>`:""}if(r==="list"||r==="bullets"||r==="bullet"){let s=!!e.ordered;const m=Array.isArray(e.items)?e.items:[],g=m.length>0;let w=m.length?m.map(j=>String(j??"")):String(e.text||"").split(/\n+/).map(j=>j.trim()).filter(Boolean);if(!w.length&&!g)return"";if(!s){const j=/^\d+[\.\)]\s+/;w.filter(F=>j.test(F)).length===w.length&&(s=!0,w=w.map(F=>F.replace(j,"")))}const k=w.map(j=>{const B=String(j??"");return B.trim()?`<li>${ys(B)}</li>`:"<li><br/></li>"}).join(""),b=`${n}${i}`;return s?`<ol${b}>${k}</ol>`:`<ul${b}>${k}</ul>`}if(r==="table"){const s=dm(e),m=s.caption||"Table",g=s.columns.length?s.columns:["Col 1","Col 2"],w=s.rows.length?s.rows:[["",""]],k=g.map(B=>`<th>${fr(B)}</th>`).join(""),b=w.map(B=>{const F=Array.isArray(B)?B:[B];return`<tr>${g.map((E,P)=>`<td>${fr(String(F[P]??""))}</td>`).join("")}</tr>`}).join("");return`<figure class="wa-table"${`${n}${i}`}><figcaption>${fr(m)}</figcaption><table><thead><tr>${k}</tr></thead><tbody>${b}</tbody></table></figure>`}if(r==="figure"){const s=vm(e),m=s.caption||"图示",g=`${n}${i}`,w=s.spec&&typeof s.spec=="object"?encodeURIComponent(JSON.stringify(s.spec)):"",k=w?` data-figure-spec="${fr(w)}"`:"";return`<figure class="wa-figure"${g}${k}><div class="wa-figure-box">图</div><figcaption>${fr(m)}</figcaption></figure>`}if(r==="quote"){const s=String(e.text||"").trim();return s?`<blockquote>${ys(s)}</blockquote>`:""}const a=String(e.text||"").trim();return a?um(a):""}function jc(e){for(const n of e)if(String(n.type||"").toLowerCase()==="heading"&&Number(n.level||0)===1){const r=String(n.text||"").trim();if(r)return r}for(const n of e)if(String(n.type||"")==="paragraph"){const i=String(n.text||"").trim();if(i)return i.slice(0,24)}return""}function ec(e){const n=[];let i="";for(const r of e){const a=String(r.section_id||r.section_title||"").trim();if(a&&a!==i){const s=mm(a);s&&n.push(s),i=a}n.push(...Uf(r))}return n.length?n.join(`

`).trim():null}function nc(e,n){const i=['<div class="wa-doc">'],r=String(n||"").trim()||jc(e);i.push(`<div class="wa-header" contenteditable="false">${fr(r)}</div>`),i.push('<div class="wa-body">'),r&&i.push(`<div class="wa-title">${ys(r)}</div>`);let a="",s=!1;for(const m of e){const g=String(m.section_id||m.section_title||"").trim();if(g&&g!==a){const b=hm(g);b&&i.push(b),a=g}const w=String(m.type||"").toLowerCase();if(!s&&r&&w==="heading"&&Number(m.level||0)===1){const b=String(m.text||"").trim();if(Oo(b)===Oo(r)){s=!0;continue}}const k=Jf(m);k&&i.push(k)}return i.push("</div>"),i.push('<div class="wa-footer" contenteditable="false">Page 1</div>'),i.push("</div>"),i.length>2?i.join(""):null}function Gf(e){for(const n of e){const i=String(n.title||"").trim(),r=Number(n.level||0);if(i&&r<=1)return i;const a=Array.isArray(n.children)?n.children:[],s=Gf(a);if(s)return s}return""}function Kf(e){const n=String(e.title||"").trim();if(n)return n;const i=Array.isArray(e.sections)?e.sections:[],r=Gf(i);if(r)return r;if(i.length===1){const s=i[0],m=Number(s.level||0),g=String(s.title||"").trim();if(g&&m<=1)return g}const a=Array.isArray(e.blocks)?e.blocks:[];return jc(a)}function Vf(e,n){const i=String(e.title||"").trim();if(i){const s=Math.min(6,Math.max(1,Number(e.level||2)));n.push(`${"#".repeat(s)} ${i}`)}const r=Array.isArray(e.blocks)?e.blocks:[];for(const s of r)n.push(...Uf(s));const a=Array.isArray(e.children)?e.children:[];for(const s of a)Vf(s,n)}function Xf(e,n){const i=String(e.title||"").trim(),r=Math.min(6,Math.max(1,Number(e.level||2))),a=String(e.id||"").trim(),s=a?` data-section-id="${fr(a)}" data-section-level="${r}"`:"",m=Tc({style:e.style}),g=`${s}${m}`,w=[];i&&(r===1&&n&&Oo(i)===n||w.push(Po(r,i,g)));const k=Array.isArray(e.blocks)?e.blocks:[];for(const j of k){const B=Jf(j);B&&w.push(B)}const b=Array.isArray(e.children)?e.children:[];for(const j of b)w.push(Xf(j,n));return w.join("")}function gm(e){const n=String(e.title||"").trim(),i=Array.isArray(e.sections)?e.sections:[],r=[];n&&r.push(`# ${n}`);for(const a of i){const s=String(a.title||a.name||a.section||"").trim();if(!s)continue;r.push(`## ${s}`);let m=a.content??a.text??a.body;Array.isArray(m)&&(m=m.map(w=>String(w||"").trim()).filter(Boolean).join(`

`));const g=String(m||"").trim();g&&r.push(g)}return r.length?r.join(`

`).trim():null}function Qa(e){const n=Kf(e),i=Array.isArray(e.sections)?e.sections:[],r=[];n&&r.push(`# ${n}`);for(const a of i)Vf(a,r);return r.length?r.join(`

`).trim():null}function Ou(e){const n=Kf(e),i=Array.isArray(e.sections)?e.sections:[];if(!n&&i.length===0)return null;const r=['<div class="wa-doc">'];r.push(`<div class="wa-header" contenteditable="false">${fr(n)}</div>`),r.push('<div class="wa-body">');const a=Oo(n),s=Tc({style:e.title_style});n&&r.push(`<div class="wa-title"${s}>${ys(n)}</div>`);for(const m of i)r.push(Xf(m,a));return r.push("</div>"),r.push('<div class="wa-footer" contenteditable="false">Page 1</div>'),r.push("</div>"),r.join("")}function _m(e){const n=String(e.type||"paragraph").toLowerCase(),r=String(e.id||"").trim()||Lo();if(n==="paragraph"){const s=String(e.text||"").trim();return s?{id:r,type:"paragraph",text:s}:null}if(n==="list"){const s=Array.isArray(e.items)?e.items.map(m=>String(m||"").trim()).filter(Boolean):[];return s.length?{id:r,type:"list",items:s,ordered:!!e.ordered}:null}if(n==="table")return{id:r,type:"table",table:e.table||{}};if(n==="figure")return{id:r,type:"figure",figure:e.figure||{}};const a=String(e.text||"").trim();return a?{id:r,type:"paragraph",text:a}:null}function Lo(){return typeof crypto<"u"&&"randomUUID"in crypto?crypto.randomUUID().replace(/-/g,""):`b${Math.random().toString(16).slice(2)}${Date.now().toString(16)}`}function bm(e,n){const i=String(n).trim()||"自动生成文档",r=[],a=[];let s=[];const m=()=>{if(!s.length)return;const g={id:Lo(),title:i,level:1,blocks:s,children:[]};r.push(g),a.push({level:1,node:g}),s=[]};for(const g of e){if(String(g.type||"").toLowerCase()==="heading"){const b=Math.min(6,Math.max(1,Number(g.level||1))),j=String(g.text||"").trim()||"章节",B={id:Lo(),title:j,level:b,blocks:[],children:[]};for(s.length&&a.length===0&&m();a.length&&a[a.length-1].level>=b;)a.pop();a.length?a[a.length-1].node.children.push(B):r.push(B),a.push({level:b,node:B});continue}const k=_m(g);k&&(a.length?a[a.length-1].node.blocks.push(k):s.push(k))}return s.length&&!r.length&&r.push({id:Lo(),title:i,level:1,blocks:s,children:[]}),{title:i,sections:r}}const Yf=["摘要","引言","绪论","背景","研究背景","目标","范围","术语","定义","需求","需求分析","总体设计","系统设计","架构设计","详细设计","模块设计","实现","关键技术","应用","方法","数据","分析","讨论","评估","结果","结论","总结","展望","风险","问题","计划","本周工作","下周计划","问题与风险","需协助事项","参考文献","附录","致谢"],ps=/[。！？!?；;，、]/,Qf=["本文","本研究","本项目","作为","通过","基于","采用","利用","借助","随着","本周","本次","本节","我们","由于","因此","此外","同时","首先","其次","最后"],ym=["作为","尽管","通过","基于","采用","利用","借助","随着","为了","针对","此外","同时","首先","其次","最后"],wm=["模型","系统"];function Zs(e){return String(e||"").replace(/^[：:、\-—\s]+/g,"").trim()}function Sa(e){return String(e||"").replace(/[：:、\-—\s]+$/g,"").trim()}function xm(e,n){let i=String(e||"").trim(),r=String(n||"").trim();if(!i||!r||i.length<8)return{left:i,right:r};const a=Math.min(8,Math.floor(i.length/2));for(let s=a;s>=3;s-=1){const m=i.slice(-s);if(!m||!i.startsWith(m))continue;const g=i.slice(0,i.length-s).trim();if(!(!g||g.length<4))return r.startsWith(m)?{left:g,right:r}:{left:g,right:`${m}${r}`}}return{left:i,right:r}}function Sm(e){const n=String(e||"").trim();return n?!!(n.length>=24||ps.test(n)||Qf.some(r=>{const a=n.indexOf(r);return a>=1&&a<=18})||n.length>=14&&/(是|为|通过|随着|由于|因此|并且|能够|可以|实现|提升|优化)/.test(n)):!1}function Pu(e){const n=String(e||"").trim();if(!n||n.length<=12&&!ps.test(n))return null;const i=/^(.{1,12})[:：](.+)$/.exec(n);if(i){const m=String(i[1]||"").trim(),g=String(i[2]||"").trim();if(m&&g&&(ps.test(g)||g.length>=12))return{heading:Sa(m),rest:Zs(g)}}const r=/^(.{2,10})\s*\1(.+)$/.exec(n);if(r){const m=String(r[1]||"").trim(),g=String(r[2]||"").trim();if(m&&g&&(ps.test(g)||g.length>=6))return{heading:Sa(m),rest:Zs(g)}}const a=Yf.slice().sort((m,g)=>g.length-m.length);for(const m of a)if(n.startsWith(m)&&n.length>m.length+1){const g=Zs(n.slice(m.length).trim());if(g&&(ps.test(g)||g.length>=12))return{heading:m,rest:g}}for(const m of a){const g=n.indexOf(m);if(g<=0)continue;const w=g+m.length;if(w>10)continue;const k=n.slice(0,w).trim(),b=Zs(n.slice(w).trim());if(k&&b&&(ps.test(b)||b.length>=12))return{heading:Sa(k),rest:b}}const s=n.search(/\b\d+(?:\.\d+)+\b/);if(s>0&&s<=12){const m=n.slice(0,s).trim(),g=Zs(n.slice(s).trim());if(m&&g&&(ps.test(g)||g.length>=12))return{heading:Sa(m),rest:g}}for(const m of ym){const g=n.indexOf(m);if(g<2||g>24)continue;let w=n.slice(0,g).trim(),k=Zs(n.slice(g).trim());if(!(!w||!k)&&!(w.length>20||k.length<6)){if(["作为","通过","基于","采用","利用","借助"].includes(m)){const b=xm(w,k);w=b.left,k=b.right;for(const j of wm)if(w.endsWith(j)&&w.length-j.length>=4){k=`${j}${k}`,w=w.slice(0,w.length-j.length).trim();break}}if(w&&w.length<=16&&!ps.test(w))return{heading:Sa(w),rest:k}}}for(const m of Qf){const g=n.indexOf(m);if(g>0&&g<=10){const w=n.slice(0,g).trim(),k=Zs(n.slice(g).trim());if(w&&k&&k.length>=6&&!ps.test(w))return{heading:Sa(w),rest:k}}}return null}function km(e){const n=String(e||"").replace(/\r/g,"").trim();if(!n)return[];const i=n.split(/\n+/).map(s=>s.trim()).filter(Boolean),r=[],a=s=>{const m=String(s||"").trim();if(!m)return;if(m.length<=92){r.push(m);return}let g=m.split(new RegExp("(?<=[。！？!?；;])(?=[^”’」』）》】\\]\\s])","g")).map(k=>k.trim()).filter(Boolean);if(g.length<=1&&m.length>118){const k=[];for(let b=0;b<m.length;b+=1){const j=m[b];(j==="，"||j===","||j==="、")&&k.push(b)}if(k.length){const b=Math.floor(m.length/2);let j=k[0],B=Number.POSITIVE_INFINITY;for(const E of k){if(E<24||E>m.length-18)continue;const P=Math.abs(E-b);P<B&&(B=P,j=E)}const F=m.slice(0,j+1).trim(),O=m.slice(j+1).trim();g=[F,O].filter(Boolean)}}if(g.length<=1){r.push(m);return}const w=[];for(const k of g)k&&(w.length&&k.length<24?w[w.length-1]=`${w[w.length-1]}${k}`:w.push(k));r.push(...w.filter(Boolean))};for(const s of i.length?i:[n])a(s);return r.length?r:[n]}function Zf(e){let n=String(e||"").trim();return n?(n.startsWith("```")&&(n=n.replace(/^```json/i,"").replace(/^```/,""),n.endsWith("```")&&(n=n.slice(0,-3)),n=n.trim()),n.startsWith("{")||n.startsWith("[")?n:null):null}function ao(e){try{return JSON.parse(e)}catch{return null}}function td(e){const n=[],i=String(e||"").split(`
`);for(const r of i){const a=r.trim();if(!a)continue;const s=ao(a);s&&typeof s=="object"&&!Array.isArray(s)&&n.push(s)}return n}function $m(e){if(!e||typeof e!="object")return null;const n=e;return n.doc_ir&&typeof n.doc_ir=="object"?Qa(n.doc_ir):Array.isArray(e)?ec(e):Array.isArray(n.blocks)?ec(n.blocks):Array.isArray(n.sections)?n.sections.some(a=>a&&(a.blocks||a.children))?Qa(n):gm(n):null}function rc(e){if(!e||typeof e!="object")return null;const n=e;return n.doc_ir&&typeof n.doc_ir=="object"?Ou(n.doc_ir):Array.isArray(e)?nc(e):Array.isArray(n.blocks)?nc(n.blocks,String(n.title||"").trim()):Array.isArray(n.sections)?Ou(n):null}function Tm(e){const n=String(e||"").trim();if(!n||/^#{1,3}\s+/m.test(n))return null;const i=Zf(n);if(i){const a=ao(i);if(a!==null){const s=$m(a);if(s)return s}}const r=td(n);return r.length>0?ec(r):null}function jm(e){const n=String(e||"").trim();if(!n)return null;const i=Zf(n);if(i){const a=ao(i);if(a!==null){const s=rc(a);if(s)return s}}const r=td(n);if(r.length>0){const a=nc(r);if(a)return a}return null}function Em(e){if(!e)return null;if(typeof e=="string"){const n=ao(e);return n?rc(n):null}return typeof e!="object"?null:rc(e)}function Am(e,n,i){const r=String(e||""),a=jm(r);if(a)return a;if(!i){const s=Em(n);if(s)return s}return""}function ic(e){let n=String(e||"").replace(/\r\n/g,`
`).replace(/\r/g,`
`);if(!n.endsWith(`
`)){const F=n.lastIndexOf(`
`),O=F>=0?n.slice(F+1):n;O.trim().length<=4&&(/^#{1,6}\s*\S*$/.test(O)||/^[-*•·]\s*\S*$/.test(O))&&(n=F>=0?n.slice(0,F+1):"")}if(!n.trim())return null;const i=Wf(n.split(`
`)),r=[];let a="",s=[],m=[],g=null;const w=F=>{const O=km(String(F||""));for(const E of O){const P=String(E||"").trim();P&&r.push({type:"paragraph",text:P})}},k=()=>{if(!s.length)return;const F=s.join(" ").replace(/\s+/g," ").trim();F&&w(F),s=[]},b=()=>{m.length&&(r.push({type:"list",items:m.slice(),ordered:!!g}),m=[],g=null)};let j=!0;for(const F of i){const E=String(F||"").trim();if(!E){k(),b(),j=!0;continue}if(/^#{1,6}$/.test(E))continue;const P=/^(#{1,3})\s*(.+)$/.exec(E);if(P){k(),b();const wt=Math.min(3,Math.max(1,P[1].length));let Nt=String(P[2]||"").trim(),Wt="";const tt=Pu(Nt);tt&&(Nt=tt.heading,Wt=tt.rest),wt===1&&!a&&Nt&&(a=Nt),r.push({type:"heading",level:wt,text:Nt||"章节"}),Wt&&w(Wt),j=!1;continue}const dt=/^(\d+(?:\.\d+){0,3})[\.、\)]?\s+(.+)$/.exec(E);if(dt){const wt=String(dt[1]||"");let Nt=String(dt[2]||"").trim();const Wt=(wt.match(/\./g)||[]).length,tt=Math.min(6,2+Wt),Et=Pu(Nt),kt=Nt.length<=16&&!ps.test(Nt),Jt=Yf.some(xe=>Nt.startsWith(xe)),de=Sm(Nt),De=Et||kt||Jt||(j||!s.length&&!m.length)&&!de;if(Nt&&De){k(),b();let xe="";Et&&(Nt=Et.heading,xe=Et.rest),tt===1&&!a&&Nt&&(a=Nt),r.push({type:"heading",level:tt,text:Nt||"章节"}),xe&&w(xe),j=!1;continue}}const U=E.match(/^\[\[(FIGURE|TABLE)\s*:\s*(\{[\s\S]*\})\s*\]\]$/i);if(U){k(),b();const wt=String(U[1]||"").toLowerCase(),Nt=ao(U[2])||{raw:U[2]};wt==="table"?r.push({type:"table",table:Nt}):r.push({type:"figure",figure:Nt});continue}const lt=E.match(/^[-*•·]\s+(.*)$/),Tt=E.match(/^\d+[\.\)]\s+(.*)$/);if(lt||Tt){k();const wt=!!Tt;g===null&&(g=wt),g!==wt&&(b(),g=wt);const Nt=String(Tt?.[1]||lt?.[1]||"").trim();Nt&&m.push(Nt),j=!1;continue}b(),s.push(E),j=!1}k(),b();const B=a||jc(r)||"自动生成文档";return bm(r,B)}function Cm(e){const n=String(e||"").replace(/\r\n/g,`
`).replace(/\r/g,`
`);if(!n.trim())return"";const i=Tm(n)||n,r=Wf(i.split(`
`));let a="",s=!1,m="";const g=[],w=()=>{m&&(g.push(m==="ol"?"</ol>":"</ul>"),m="")};for(const k of r){const b=k.trim();if(b.startsWith("```")){s?(g.push("</code></pre>"),s=!1):(w(),g.push('<pre class="code"><code>'),s=!0);continue}if(s){g.push(`${fr(k)}
`);continue}if(/^#{1,6}$/.test(b))continue;if(b===":::left"){w(),a="left";continue}if(b===":::center"){w(),a="center";continue}if(b===":::right"){w(),a="right";continue}if(b===":::"){w(),a="";continue}const j=b.match(/^\[\[(FIGURE|TABLE)\s*:\s*(\{[\s\S]*\})\s*\]\]$/i);if(j){w();const P=String(j[1]||"").toLowerCase();let dt=P==="figure"?"图示":"表格";try{const U=JSON.parse(j[2]);U&&typeof U.caption=="string"&&U.caption.trim()&&(dt=U.caption.trim())}catch{}P==="figure"?g.push(`<figure class="wa-figure" data-wa-figure="1"><div class="wa-figure-box">图</div><figcaption>${fr(dt)}</figcaption></figure>`):g.push(`<div class="wa-table" data-wa-table="1"><div class="wa-table-box">表</div><div class="wa-table-caption">${fr(dt)}</div></div>`);continue}const B=b.match(/^(#{1,3})\s*(.+?)\s*$/);if(B){w();const P=Math.min(3,B[1].length);g.push(`<h${P}>${ys(B[2])}</h${P}>`);continue}if(!b){if(m)continue;w(),g.push("<p><br/></p>");continue}const F=b.match(/^-\s+(.+)/),O=b.match(/^\d+\.\s+(.+)/);if(F||O){const P=F?"ul":"ol";m?m!==P&&(w(),m=P,g.push(P==="ol"?"<ol>":"<ul>")):(m=P,g.push(P==="ol"?"<ol>":"<ul>"));const dt=(F||O)[1];g.push(`<li>${ys(dt)}</li>`);continue}w();const E=a?` style="text-align:${a};"`:"";g.push(`<p${E}>${ys(k)}</p>`)}return w(),g.join("")}function Im(e,n,i){const r=Am(e,n,i);return r||Cm(String(e||""))}var Nm=q('<button class="dropdown-item svelte-lk86dq"> </button>'),Mm=q('<div class="dropdown-panel svelte-lk86dq"></div>'),Bm=q("<option> </option>"),Dm=q('<button class="color-item svelte-lk86dq"></button>'),Lm=q('<div class="dropdown-panel color-grid svelte-lk86dq"></div>'),Rm=q('<button class="color-item svelte-lk86dq"></button>'),qm=q('<div class="dropdown-panel color-grid svelte-lk86dq"></div>'),Fm=q('<button class="dropdown-item svelte-lk86dq"> </button>'),Om=q('<div class="dropdown-panel svelte-lk86dq"></div>'),Pm=q('<div class="dropdown-panel svelte-lk86dq"><button class="dropdown-item svelte-lk86dq">插入表格</button> <button class="dropdown-item svelte-lk86dq">合并单元格</button> <button class="dropdown-item svelte-lk86dq">插入行</button> <button class="dropdown-item svelte-lk86dq">插入列</button> <button class="dropdown-item svelte-lk86dq">删除行</button> <button class="dropdown-item svelte-lk86dq">删除列</button></div>'),Hm=q('<div class="panel-header svelte-lk86dq"><div class="panel-title">正文编辑</div> <div class="editor-stats svelte-lk86dq"><span> </span> <span>·</span> <span> </span></div></div> <div class="extended-toolbar svelte-lk86dq"><div class="toolbar-group svelte-lk86dq"><button class="tool-btn svelte-lk86dq" title="字体"><span style="font-family: serif;">A</span></button> <!></div> <div class="toolbar-group svelte-lk86dq"><select class="tool-select svelte-lk86dq"><option>字号</option><!></select></div> <div class="toolbar-group svelte-lk86dq"><button class="tool-btn svelte-lk86dq" title="文字颜色"><span style="color: #FF0000;">A</span></button> <!></div> <div class="toolbar-group svelte-lk86dq"><button class="tool-btn svelte-lk86dq" title="背景颜色"><span style="background: #FFFF00;">█</span></button> <!></div> <span class="separator svelte-lk86dq"></span> <button class="tool-btn svelte-lk86dq" title="左对齐">≡</button> <button class="tool-btn svelte-lk86dq" title="居中">≡</button> <button class="tool-btn svelte-lk86dq" title="右对齐">≡</button> <button class="tool-btn svelte-lk86dq" title="两端对齐">≡</button> <span class="separator svelte-lk86dq"></span> <button class="tool-btn svelte-lk86dq" title="上标">x²</button> <button class="tool-btn svelte-lk86dq" title="下标">x₂</button> <button class="tool-btn svelte-lk86dq" title="水平线">—</button> <span class="separator svelte-lk86dq"></span> <div class="toolbar-group svelte-lk86dq"><button class="tool-btn svelte-lk86dq" title="行距">≣</button> <!></div> <button class="tool-btn svelte-lk86dq" title="首行缩进">¶</button> <button class="tool-btn svelte-lk86dq" title="段间距">⇕</button> <span class="separator svelte-lk86dq"></span> <button class="tool-btn svelte-lk86dq" title="行内公式">𝑓(𝑥)</button> <button class="tool-btn svelte-lk86dq" title="公式块">∫</button> <span class="separator svelte-lk86dq"></span> <button class="tool-btn svelte-lk86dq" title="插入脚注">※</button> <button class="tool-btn svelte-lk86dq" title="生成目录">☰</button> <span class="separator svelte-lk86dq"></span> <div class="toolbar-group svelte-lk86dq"><button class="tool-btn svelte-lk86dq" title="表格">⊞</button> <!></div></div>',1),zm=q('<div class="slash-empty svelte-lk86dq">无匹配命令，按 Backspace 删除关键字。</div>'),Wm=q('<button role="option"><span class="slash-label svelte-lk86dq"> </span> <span class="slash-desc svelte-lk86dq"> </span></button>'),Um=q('<div class="slash-list svelte-lk86dq"></div>'),Jm=q('<div class="slash-menu svelte-lk86dq" role="listbox" tabindex="-1" aria-label="插入命令菜单"><div class="slash-menu-head svelte-lk86dq"><span>/ 命令</span> <span class="query svelte-lk86dq"> </span></div> <!> <div class="slash-menu-foot svelte-lk86dq">↑↓ 选择 · Enter 执行 · Esc 关闭</div></div>'),Gm=q('<div class="block-marquee svelte-lk86dq" aria-hidden="true"></div>'),Km=q('<div class="find-replace-panel svelte-lk86dq"><div class="find-replace-row svelte-lk86dq"><input type="text" placeholder="查找..." class="svelte-lk86dq"/> <button class="btn-small svelte-lk86dq">下一个</button> <button class="btn-small svelte-lk86dq">✕</button></div> <div class="find-replace-row svelte-lk86dq"><input type="text" placeholder="替换为..." class="svelte-lk86dq"/> <button class="btn-small svelte-lk86dq">替换</button> <button class="btn-small svelte-lk86dq">全部替换</button></div></div>'),Vm=q('<div><!> <div class="editable svelte-lk86dq" role="region" aria-label="文档编辑区"></div> <!> <!> <!></div>');function ed(e,n){if(new.target)return mi({component:ed,...e});oi(n,!1);const i=()=>Qn(vs,"$generating",w),r=()=>Qn(yr,"$sourceText",w),a=()=>Qn(Lr,"$docIr",w),s=()=>Qn(fa,"$historyIndex",w),m=()=>Qn(Vo,"$history",w),g=()=>Qn($c,"$wordCount",w),[w,k]=Oa();let b=W(null),j="",B=W("text"),F=null,O=null,E=null,P=qr(n,"showToolbar",12,!0),dt=qr(n,"paper",12,!0),U=qr(n,"lockEditing",12,!1);const lt=yc();let Tt=W(null),wt=W(""),Nt=!1,Wt=null,tt="",Et=null,kt=[],Jt=[],de="",De=null,xe=W(!1),ln=W({left:0,top:0,width:0,height:0}),Mt=!1,mt="",jt=[];const Bt=[{id:"heading1",label:"标题 1",desc:"插入一级标题",command:"heading1",keywords:["h1","标题","一级"]},{id:"heading2",label:"标题 2",desc:"插入二级标题",command:"heading2",keywords:["h2","标题","二级"]},{id:"paragraph",label:"正文段落",desc:"切换为正文段落",command:"paragraph",keywords:["正文","段落","p"]},{id:"list-bullet",label:"无序列表",desc:"插入项目符号列表",command:"list-bullet",keywords:["列表","bullet","无序"]},{id:"list-number",label:"有序列表",desc:"插入编号列表",command:"list-number",keywords:["列表","编号","有序"]},{id:"quote",label:"引用块",desc:"插入引用格式",command:"quote",keywords:["引用","quote"]},{id:"code",label:"代码块",desc:"插入代码块",command:"code",keywords:["代码","code"]},{id:"table",label:"表格",desc:"插入表格",command:"table",keywords:["表格","table"]},{id:"image",label:"图片",desc:"插入图片",command:"image",keywords:["图片","image","图"]},{id:"toc",label:"目录",desc:"生成目录",command:"toc",keywords:["目录","toc"]},{id:"footnote",label:"脚注",desc:"插入脚注",command:"footnote",keywords:["脚注","footnote"]},{id:"math-inline",label:"行内公式",desc:"插入行内 LaTeX 公式",command:"math-inline",keywords:["公式","math","latex"]},{id:"math-block",label:"公式块",desc:"插入块级 LaTeX 公式",command:"math-block",keywords:["公式块","math","latex"]}];let Kt=W(!1),vn=W(0),cn=W(0),Le=W(0),bt=W("");function At(){return i()?"正在生成内容，暂不可直接编辑…":U()?"正在渲染内容，暂不可编辑，请稍候…":"在这里直接编辑或等待生成内容…"}function ee(){if(!t(b))return;const o=i()||U();Qr(b,t(b).dataset.readonly=o?"1":"0"),Qr(b,t(b).dataset.emptyHint=At())}function We(o){if(!t(b))return;const p=!String(o||"").trim();Qr(b,t(b).dataset.empty=p?"1":"0"),ee()}function ge(o){if(!o||typeof o!="object")return!1;const p=o;if(String(p.title||"").trim())return!0;const S=H=>{for(const L of H){if(!L||typeof L!="object")continue;const K=L;if(String(K.title||"").trim()||(Array.isArray(K.blocks)?K.blocks:[]).length>0)return!0;const z=Array.isArray(K.children)?K.children:[];if(z.length&&S(z))return!0}return!1},A=Array.isArray(p.sections)?p.sections:[];return A.length>0&&S(A)?!0:(Array.isArray(p.blocks)?p.blocks:[]).length>0}function en(){return{title:"",sections:[{id:Rn(),title:"",level:1,blocks:[{id:Rn(),type:"paragraph",text:""}],children:[]}]}}function Sr(){if(!t(b))return;const o=String(r()||""),p=a(),h=ge(p);if(!h&&!o.trim()){const I=en();Lr.set(I),Yn.set(!1);return}const S=!h,A=h?`doc:${Ti(p)}`:`text:${o}`;if(t(Tt)&&t(b).contains(t(Tt))&&A!==j){Wt=A;return}A!==j&&(F&&clearTimeout(F),F=setTimeout(()=>{if(Qr(b,t(b).innerHTML=Im(o,p,S)),f(B,S?"text":"doc"),j=A,Wt=null,We(o),ee(),ne(),Tr(),tt){const I=t(b).querySelector(`[data-block-id="${CSS.escape(tt)}"]`);tt="",I&&I.focus()}Ir(),yi(),Kr()},100))}function Ti(o){try{return JSON.stringify(o)||""}catch{return""}}function Ur(o){const p=!i()&&!U();o.setAttribute("contenteditable",p?"true":"false"),o.setAttribute("spellcheck","false"),p?o.dataset.waEdit="1":delete o.dataset.waEdit}function ne(){if(!t(b))return;const o=t(b).querySelector(".wa-title");o&&(o.dataset.docTitle="1",Ur(o)),t(b).querySelectorAll("[data-section-id]").forEach(p=>{Ur(p)}),t(b).querySelectorAll("[data-block-id]").forEach(p=>{const h=p,S=h.tagName.toLowerCase();if(S==="figure"||S==="table"){h.setAttribute("contenteditable","false"),delete h.dataset.waEdit;return}Ur(h)})}function Ue(o){if(!o||!(o instanceof HTMLElement)||!t(b))return null;const p=o.closest('[data-wa-edit="1"]');return!p||!t(b).contains(p)?null:p}function An(o){const p=Ue(o);if(p)return p;const h=document.activeElement,S=Ue(h);if(S)return S;const I=window.getSelection()?.anchorNode||null;return I instanceof HTMLElement?Ue(I):I&&I.parentElement?Ue(I.parentElement):null}function tr(){const p=window.getSelection()?.anchorNode||null;return p instanceof HTMLElement?Ue(p):p&&p.parentElement?Ue(p.parentElement):null}function or(){if(!t(b))return null;const o=window.getSelection();if(!o||o.rangeCount===0)return null;const p=o.getRangeAt(0).cloneRange();p.collapse(!0);const h=p.getBoundingClientRect();if(h){const S=Math.max(0,h.left+Math.max(1,h.width/2)),A=Math.max(0,h.top+Math.max(1,h.height/2)),I=document.elementFromPoint(S,A),H=Ue(I);if(H)return H;const L=Pe(A);if(L)return L}return t(b).querySelector('[data-wa-edit="1"]')}function Lt(o){let p=String(o||"").replace(/\r/g,"");return p=p.replace(/[ \t]+/g," "),p=p.replace(/[ \t]*\n[ \t]*/g,`
`),p=p.replace(/\n{3,}/g,`

`),p.trim()}function Ri(o){if(o.nodeType===Node.TEXT_NODE)return o.textContent||"";if(!(o instanceof HTMLElement))return"";const p=o.tagName.toLowerCase();if(p==="br")return`
`;if(p==="strong"||p==="b")return`**${X(o)}**`;if(p==="em"||p==="i")return`*${X(o)}*`;if(p==="u")return`++${X(o)}++`;if(p==="del"||p==="s")return`~~${X(o)}~~`;if(p==="mark")return`==${X(o)}==`;if(p==="code")return"`"+(o.textContent||"")+"`";if(p==="a"){const h=o.getAttribute("href")||"",S=X(o);return h?`[${S}](${h})`:S}return X(o)}function X(o){const p=[];return o.childNodes.forEach(h=>p.push(Ri(h))),Lt(p.join(""))}function ht(o){if(o.nodeType===Node.TEXT_NODE)return o.textContent||"";if(!(o instanceof HTMLElement))return"";if(o.tagName.toLowerCase()==="br")return`
`;const h=[];return o.childNodes.forEach(S=>h.push(ht(S))),h.join("")}function Ut(o){const p=[];return o.childNodes.forEach(h=>p.push(ht(h))),p.join("")}function Se(o){const p=document.createElement("div");return p.appendChild(o),X(p)}function vr(o){const p=window.getSelection();if(!p||p.rangeCount===0)return null;const h=p.getRangeAt(0);if(!o.contains(h.startContainer))return null;const S=h.cloneRange();S.selectNodeContents(o),S.setEnd(h.startContainer,h.startOffset);const A=h.cloneRange();A.selectNodeContents(o),A.setStart(h.startContainer,h.startOffset);const I=Se(S.cloneContents()),H=Se(A.cloneContents());return{before:I,after:H}}function er(o){if(o.nodeType===Node.TEXT_NODE)return(o.textContent||"").length;if(!(o instanceof HTMLElement))return 0;if(o.tagName.toLowerCase()==="br")return 1;let h=0;return o.childNodes.forEach(S=>{h+=er(S)}),h}function On(o){const p=window.getSelection();if(!p||p.rangeCount===0)return null;const h=p.getRangeAt(0),S=h.startContainer;if(!o.contains(S))return null;let A=0,I=!1;const H=L=>{if(!I){if(L===S){if(L.nodeType===Node.TEXT_NODE)A+=h.startOffset;else if(L instanceof HTMLElement){const K=Array.from(L.childNodes);for(let R=0;R<h.startOffset;R++)A+=er(K[R])}I=!0;return}if(L.nodeType===Node.TEXT_NODE||L instanceof HTMLElement&&L.tagName.toLowerCase()==="br"){A+=er(L);return}L.childNodes.forEach(K=>H(K))}};return H(o),A}function _n(o){const p=o.style,h=window.getComputedStyle(o),S={},A=p.textAlign||o.getAttribute("align")||h.textAlign||"";A&&(S.align=A);const I=p.lineHeight||h.lineHeight;if(I){let _t=I;const Ct=/^(\d+(?:\.\d+)?)px$/.exec(I),$e=/^(\d+(?:\.\d+)?)px$/.exec(p.fontSize||h.fontSize||"");if(Ct&&$e){const at=Number(Ct[1])/Number($e[1]);Number.isFinite(at)&&at>0&&(_t=at.toFixed(2).replace(/\.00$/,""))}S.lineHeight=_t}const H=p.textIndent||h.textIndent;H&&(S.indent=H);const L=p.marginTop||h.marginTop;L&&(S.marginTop=L);const K=p.marginBottom||h.marginBottom;K&&(S.marginBottom=K);const R=p.fontFamily||h.fontFamily;R&&(S.fontFamily=R);const z=p.fontSize||h.fontSize;if(z){let _t=z;const Ct=/^(\d+(?:\.\d+)?)px$/.exec(z);if(Ct){const $e=Math.round(Number(Ct[1])*72/96);Number.isFinite($e)&&$e>0&&(_t=`${$e}pt`)}S.fontSize=_t}const it=p.fontWeight||h.fontWeight;it&&(S.fontWeight=it);const Q=p.fontStyle||h.fontStyle;Q&&(S.fontStyle=Q);const gt=p.color||h.color;gt&&(S.color=gt);const st=p.backgroundColor||h.backgroundColor;return st&&st!=="transparent"&&st!=="rgba(0, 0, 0, 0)"&&(S.background=st),Object.keys(S).length?S:null}function Re(o){const p=[],h=(R,z)=>{R&&p.push({text:R,bold:z.bold,italic:z.italic,underline:z.underline,strike:z.strike,color:z.color,background:z.background,font:z.font,size:z.size,link:z.link})},S=R=>{const z=String(R||"").trim();return z?z.split(",")[0].replace(/["']/g,"").trim():""},A=(R,z)=>{if(R.nodeType===Node.TEXT_NODE){h(R.textContent||"",z);return}if(!(R instanceof HTMLElement))return;const it=R.tagName.toLowerCase();if(it==="br"){h(`
`,z);return}const Q={...z};if((it==="strong"||it==="b")&&(Q.bold=!0),(it==="em"||it==="i")&&(Q.italic=!0),it==="u"&&(Q.underline=!0),(it==="s"||it==="del"||it==="strike")&&(Q.strike=!0),it==="a"){const st=R.getAttribute("href")||"";st&&(Q.link=st)}if(it==="font"){const st=R.getAttribute("color");st&&(Q.color=st);const _t=R.getAttribute("face");_t&&(Q.font=S(_t));const Ct=R.getAttribute("size");Ct&&(Q.size=String(Ct))}const gt=R.style;if(gt){gt.color&&(Q.color=gt.color),gt.backgroundColor&&(Q.background=gt.backgroundColor),gt.fontFamily&&(Q.font=S(gt.fontFamily)),gt.fontSize&&(Q.size=gt.fontSize);const st=gt.textDecoration;st&&st.includes("underline")&&(Q.underline=!0),st&&st.includes("line-through")&&(Q.strike=!0)}R.childNodes.forEach(st=>A(st,Q))};A(o,{});const I=[],H=R=>[R.bold?"b":"",R.italic?"i":"",R.underline?"u":"",R.strike?"s":"",R.color||"",R.background||"",R.font||"",R.size||"",R.link||""].join("|");p.forEach(R=>{const z=I[I.length-1];z&&H(z)===H(R)?z.text+=R.text:I.push({...R})});const L=Lt(I.map(R=>R.text).join("")),K=I.some(R=>Object.keys(R).some(z=>z!=="text"&&R[z]));return{text:L,runs:K?I:null}}function un(o){if(o.dataset.docTitle==="1")return{kind:"title",text:X(o)};const p=String(o.dataset.sectionId||"").trim();if(p)return{kind:"section",id:p,text:X(o),style:_n(o)};const h=String(o.dataset.blockId||"").trim();if(!h)return null;const S=o.tagName.toLowerCase();if(S==="ul"||S==="ol"){const R={type:"list",items:Array.from(o.querySelectorAll(":scope > li")).map(it=>Lt(X(it))),ordered:S==="ol"},z=_n(o);return z&&(R.style=z),{kind:"block",id:h,payload:R}}if(/^h[1-6]$/.test(S)){const K=Number(S.slice(1)),R=Re(o),z=R.text.replace(/\n+/g," ").trim(),it={type:"heading",level:K,text:z};R.runs&&(it.runs=R.runs);const Q=_n(o);return Q&&(it.style=Q),{kind:"block",id:h,payload:it}}const A=Re(o),H={type:"paragraph",text:A.text};A.runs&&(H.runs=A.runs);const L=_n(o);return L&&(H.style=L),{kind:"block",id:h,payload:H}}function bn(o,p=180){O&&clearTimeout(O),O=setTimeout(()=>{const h=Qa(o)||"";yr.set(h),We(h),qu(h)},p)}function Ye(o,p){Lr.set(o),Yn.set(!1),j=`doc:${Ti(o)}`,bn(o,p?.immediate?0:180)}function pr(o,p){const h=String(p||"").trim()||"自动生成文档",S=String(o.title||"").trim();let A=!1;h!==S&&(A=!0);const I=K=>{let R=!1;const z=K.map(it=>{let Q=!1,gt=it;String(it.title||"").trim()===S&&(gt={...it,title:h},Q=!0);const st=Array.isArray(it.children)?it.children:[];if(st.length){const _t=I(st);_t!==st&&(gt={...gt,children:_t},Q=!0)}return Q&&(R=!0),gt});return R&&(A=!0),R?z:K},H=Array.isArray(o.sections)?o.sections:[],L=I(H);return A?{...o,title:h,sections:L}:null}function ei(o,p,h,S){const A=String(h||"").trim()||"章节";let I=!1;const H=R=>{let z=!1;const it=R.map(Q=>{let gt=!1,st=Q;String(Q.id||"")===p&&(st={...Q,title:A},S&&Object.keys(S).length&&(st={...st,style:S}),gt=!0);const _t=Array.isArray(Q.children)?Q.children:[];if(_t.length){const Ct=H(_t);Ct!==_t&&(st={...st,children:Ct},gt=!0)}return gt&&(z=!0),st});return z&&(I=!0),z?it:R},L=Array.isArray(o.sections)?o.sections:[],K=H(L);return I?{...o,sections:K}:null}function sn(o,p,h){let S=!1;const A=L=>{let K=!1;const R=L.map(z=>{let it=!1,Q=z;const gt=Array.isArray(z.blocks)?z.blocks:[];if(gt.length){const _t=gt.findIndex(Ct=>String(Ct.id||"")===p);if(_t>=0){const Ct=gt[_t]||{},$e={...Ct,...h,id:Ct.id||p},at=gt.slice();at[_t]=$e,Q={...Q,blocks:at},it=!0}}const st=Array.isArray(z.children)?z.children:[];if(st.length){const _t=A(st);_t!==st&&(Q={...Q,children:_t},it=!0)}return it&&(K=!0),Q});return K&&(S=!0),K?R:L},I=Array.isArray(o.sections)?o.sections:[],H=A(I);return S?{...o,sections:H}:null}function kr(o,p,h){let S=!1;const A=L=>{let K=!1;const R=L.map(z=>{let it=!1,Q=z;const gt=Array.isArray(z.blocks)?z.blocks:[];if(gt.length){const _t=gt.findIndex(Ct=>String(Ct.id||"")===p);if(_t>=0){const Ct=gt.slice();Ct.splice(_t+1,0,h),Q={...Q,blocks:Ct},it=!0}}const st=Array.isArray(z.children)?z.children:[];if(st.length){const _t=A(st);_t!==st&&(Q={...Q,children:_t},it=!0)}return it&&(K=!0),Q});return K&&(S=!0),K?R:L},I=Array.isArray(o.sections)?o.sections:[],H=A(I);return S?{...o,sections:H}:null}function Pn(o,p,h){let S=!1;const A=L=>{let K=!1;const R=L.map(z=>{let it=!1,Q=z;const gt=Array.isArray(z.blocks)?z.blocks:[];if(gt.length){const _t=gt.findIndex(Ct=>String(Ct.id||"")===p);if(_t>=0){const Ct=gt.slice();Ct.splice(_t,0,h),Q={...Q,blocks:Ct},it=!0}}const st=Array.isArray(z.children)?z.children:[];if(st.length){const _t=A(st);_t!==st&&(Q={...Q,children:_t},it=!0)}return it&&(K=!0),Q});return K&&(S=!0),K?R:L},I=Array.isArray(o.sections)?o.sections:[],H=A(I);return S?{...o,sections:H}:null}function Fr(o,p,h){let S=!1;const A=R=>{const z=String(R.type||"paragraph").toLowerCase();if(z==="list"){const it=Array.isArray(R.items)?R.items:[],Q=it.map(gt=>String(gt??"").replace(p,h));return Q.join("")!==it.join("")?(S=!0,{...R,items:Q}):R}if(z==="table"){const it=typeof R.table=="object"&&R.table?R.table:null;if(it&&typeof it.caption=="string"){const Q=String(it.caption||"").replace(p,h);if(Q!==it.caption)return S=!0,{...R,table:{...it,caption:Q}}}return R}if(z==="figure"){const it=typeof R.figure=="object"&&R.figure?R.figure:null;if(it&&typeof it.caption=="string"){const Q=String(it.caption||"").replace(p,h);if(Q!==it.caption)return S=!0,{...R,figure:{...it,caption:Q}}}return R}if(typeof R.text=="string"){const it=String(R.text||"").replace(p,h);if(it!==R.text)return S=!0,{...R,text:it}}return R},I=R=>{let z=!1;const it=R.map(Q=>{let gt=!1,st=Q;if(typeof Q.title=="string"){const $e=String(Q.title||"").replace(p,h);$e!==Q.title&&(st={...st,title:$e},gt=!0,S=!0)}const _t=Array.isArray(Q.blocks)?Q.blocks:[];if(_t.length){const $e=_t.map(at=>A(at));$e.some((at,ct)=>at!==_t[ct])&&(st={...st,blocks:$e},gt=!0)}const Ct=Array.isArray(Q.children)?Q.children:[];if(Ct.length){const $e=I(Ct);$e!==Ct&&(st={...st,children:$e},gt=!0)}return gt&&(z=!0),gt?st:Q});return z?it:R},H={...o};if(typeof H.title=="string"){const R=String(H.title||"").replace(p,h);R!==H.title&&(H.title=R,S=!0)}const L=Array.isArray(H.sections)?H.sections:[],K=I(L);return K!==L&&(H.sections=K),S?H:null}function Yt(o,p=160){Et&&clearTimeout(Et),Et=setTimeout(()=>{yn(o)},p)}function yn(o,p){const h=a();if(!h||typeof h!="object")return;const S=un(o);if(!S)return;let A=null;S.kind==="title"?A=pr(h,String(S.text||"")):S.kind==="section"?A=ei(h,String(S.id||""),String(S.text||""),S.style||null):S.kind==="block"&&(A=sn(h,String(S.id||""),S.payload||{})),A&&Ye(A,p)}function $r(){Et&&(clearTimeout(Et),Et=null);const o=t(Tt)||An(document.activeElement);if(o){yn(o,{immediate:!0});return}O&&(clearTimeout(O),O=null);const p=a();if(!p||typeof p!="object")return;const h=Qa(p)||"";yr.set(h),We(h)}const Hn="sec:",Rt="doc:title";function ve(o){return String(o||"").startsWith(Hn)}function an(o){return ve(o)?String(o||"").slice(Hn.length).trim():""}function Ze(){if(!t(b))return[];const o=t(b).querySelectorAll('[data-block-id], [data-section-id], [data-doc-title="1"]');return Array.from(o)}function Qt(o){if(!o)return"";const p=String(o.dataset.blockId||"").trim();if(p)return p;const h=String(o.dataset.sectionId||"").trim();return h?`${Hn}${h}`:String(o.dataset.docTitle||"").trim()?Rt:""}function qe(o){if(!t(b)||!o)return null;if(o===Rt)return t(b).querySelector('[data-doc-title="1"]');if(ve(o)){const p=an(o);return p?t(b).querySelector(`[data-section-id="${CSS.escape(p)}"]`):null}return t(b).querySelector(`[data-block-id="${CSS.escape(o)}"]`)}function pe(o){if(!t(b)||!o)return{sectionId:"",sectionTitle:""};if(o===Rt){const I=t(b).querySelector('[data-doc-title="1"]');return{sectionId:Rt,sectionTitle:I?Lt(Ut(I)):"文档标题"}}const p=an(o);if(p){const I=t(b).querySelector(`[data-section-id="${CSS.escape(p)}"]`),H=I?Lt(Ut(I).replace(/^#+\s*/,"")):"";return{sectionId:p,sectionTitle:H}}let h="",S="";const A=Array.from(t(b).querySelectorAll("[data-section-id], [data-block-id]"));for(const I of A){const H=String(I.dataset.sectionId||"").trim();H&&(h=H,S=Lt(Ut(I).replace(/^#+\s*/,"")));const L=String(I.dataset.blockId||"").trim();if(L&&L===o)return{sectionId:h,sectionTitle:S}}return{sectionId:"",sectionTitle:""}}function wn(o){const p=new Set,h=[];for(const S of o){const A=String(S||"").trim();!A||p.has(A)||(p.add(A),h.push(A))}return h}function zn(o){const p=new Set(wn(o)),h=[];for(const S of Ze()){const A=Qt(S);A&&p.has(A)&&h.push(A)}return h}function Fe(){const o=Jt.map(I=>{const H=Qt(I),L=Ut(I),K=pe(H),R=H===Rt?"title":ve(H)?"section":"block";return{id:H,text:L,kind:R,style:_n(I)||{},sectionId:K.sectionId,sectionTitle:K.sectionTitle}});if(!o.length){lt("blockselect",{blockId:"",blockIds:[],blocks:[],text:"",rect:null,style:{}});return}const p=Jt[0],h=Qt(p),S=Ut(p),A=p.getBoundingClientRect();lt("blockselect",{blockId:h,blockIds:kt.slice(),blocks:o,text:S,rect:{top:A.top,left:A.left,width:A.width,height:A.height},style:_n(p)||{}})}function qt(o,p){for(const h of Jt)h.classList.remove("wa-block-selected");kt=zn(o),Jt=kt.map(h=>qe(h)).filter(h=>!!h);for(const h of Jt)h.classList.add("wa-block-selected");p&&kt.includes(p)?de=p:kt.length===1?de=kt[0]:kt.length||(de=""),Fe(),queueMicrotask(()=>zt())}function ye(){qt([])}function je(o){return(o||[]).filter(p=>{const h=String(p||"").trim();return h&&h!==Rt&&!ve(h)})}function Oe(){if(!t(b))return!1;const o=window.getSelection();if(!o||o.rangeCount===0)return!1;const p=o.anchorNode,h=o.focusNode;return!!(p&&h&&t(b).contains(p)&&t(b).contains(h))}function Je(){const o=window.getSelection();return!o||o.rangeCount===0||o.isCollapsed?!1:Oe()}function nr(o,p){const h=new Set(je(p));if(!h.size)return[];const S=[],A=H=>{for(const L of H){const K=Array.isArray(L.blocks)?L.blocks:[];for(const z of K){const it=String(z.id||"");it&&h.has(it)&&S.push(z)}const R=Array.isArray(L.children)?L.children:[];R.length&&A(R)}},I=Array.isArray(o.sections)?o.sections:[];return A(I),S}function yt(o){const p=String(o.type||"paragraph").toLowerCase();if(p==="list")return(Array.isArray(o.items)?o.items:[]).map(S=>String(S??"").trim()).filter(Boolean).join(`
`);if(p==="table"){const h=o.table&&typeof o.table=="object"?o.table:{};return String(h.caption||"表格")}if(p==="figure"){const h=o.figure&&typeof o.figure=="object"?o.figure:{};return String(h.caption||"图片")}return String(o.text||"").trim()}async function re(o){const p=String(o||"");if(!p)return!1;try{if(navigator.clipboard&&navigator.clipboard.writeText)return await navigator.clipboard.writeText(p),!0}catch{}try{const h=document.createElement("textarea");h.value=p,h.style.position="fixed",h.style.opacity="0",document.body.appendChild(h),h.focus(),h.select();const S=document.execCommand("copy");return h.remove(),S}catch{return!1}}async function ke(){try{if(navigator.clipboard&&navigator.clipboard.readText)return await navigator.clipboard.readText()}catch{}return""}function le(o,p){const h=JSON.parse(JSON.stringify(o||{})),S=String(h.type||"paragraph").toLowerCase();return h.id=Rn(),["paragraph","text","p","list","table","figure","heading"].includes(S)||(h.type="paragraph",h.text=yt(o)),(S==="text"||S==="p")&&typeof h.text!="string"&&(h.text=yt(o)),S==="paragraph"&&typeof h.text!="string"&&(h.text=yt(o)),h.id||(h.id=`${Rn()}_${p+1}`),h}function ce(o,p,h){if(!h.length)return null;let S=!1;const A=L=>{let K=!1;const R=L.map(z=>{let it=!1,Q=z;const gt=Array.isArray(z.blocks)?z.blocks:[];if(gt.length){const _t=gt.findIndex(Ct=>String(Ct.id||"")===p);if(_t>=0){const Ct=gt.slice();Ct.splice(_t+1,0,...h),Q={...Q,blocks:Ct},it=!0}}const st=Array.isArray(z.children)?z.children:[];if(st.length){const _t=A(st);_t!==st&&(Q={...Q,children:_t},it=!0)}return it&&(K=!0),Q});return K&&(S=!0),K?R:L},I=Array.isArray(o.sections)?o.sections:[],H=A(I);return S?{...o,sections:H}:null}function Ht(o,p){if(!p.length)return null;const h=Array.isArray(o.sections)?o.sections:[];if(!h.length)return null;const S=h[0],A=Array.isArray(S.blocks)?S.blocks:[],I={...S,blocks:[...A,...p]},H=h.slice();return H[0]=I,{...o,sections:H}}function Ee(o,p){const h=new Set(je(p));if(!h.size)return null;let S=!1;const A=L=>{let K=!1;const R=L.map(z=>{let it=!1,Q=z;const gt=Array.isArray(z.blocks)?z.blocks:[];if(gt.length){const _t=gt.filter(Ct=>!h.has(String(Ct.id||"")));_t.length!==gt.length&&(Q={...Q,blocks:_t},it=!0)}const st=Array.isArray(z.children)?z.children:[];if(st.length){const _t=A(st);_t!==st&&(Q={...Q,children:_t},it=!0)}return it&&(K=!0),Q});return K&&(S=!0),K?R:L},I=Array.isArray(o.sections)?o.sections:[],H=A(I);return S?{...o,sections:H}:null}function Or(){const o=i()||U(),p=fi();let h=!1,S=!1,A=!1;const I=s()>0,H=s()>=0&&s()<m().length-1;let L=!o&&(p||I),K=!o&&(p||H);try{h=!!document.queryCommandState("bold"),S=!!document.queryCommandState("italic"),A=!!document.queryCommandState("underline")}catch{}try{const gt=!!document.queryCommandEnabled("undo"),st=!!document.queryCommandEnabled("redo");L=!o&&(gt||I),K=!o&&(st||H)}catch{}const R=Je()||kt.length>0,z=R,it=!o&&R,Q=!o&&(p||kt.length>0);return{focused:p,readonly:o,bold:h,italic:S,underline:A,hasSelection:R,canUndo:L,canRedo:K,canCopy:z,canCut:it,canPaste:Q}}function zt(o=!1){const p=Or(),h=JSON.stringify(p);!o&&h===mt||(mt=h,lt("toolbarstate",p))}async function Cn(){if(Je())return document.execCommand("copy"),!0;if(!a()||typeof a()!="object")return!1;const o=je(kt);if(!o.length)return!1;const p=nr(a(),o);if(!p.length)return!1;jt=p.map((S,A)=>le(S,A));const h=p.map(S=>yt(S)).filter(Boolean).join(`

`);return await re(h),!0}async function Ae(){if(Je())return document.execCommand("cut"),!0;if(!a()||typeof a()!="object")return!1;const o=je(kt);if(!o.length||!await Cn())return!1;const h=Ee(a(),o);return h?(Ye(h),qt([]),!0):!1}async function Wn(){if(Je()){const I=await ke();return I?(document.execCommand("insertText",!1,I),!0):!1}if(!a()||typeof a()!="object")return!1;const o=je(kt),p=o.length?o[o.length-1]:"";let h=jt.map((I,H)=>le(I,H));if(!h.length){const I=(await ke()).trim();if(!I)return!1;h=I.split(/\n{2,}/).map(H=>H.trim()).filter(Boolean).map((H,L)=>({id:`${Rn()}_${L+1}`,type:"paragraph",text:H}))}const S=a(),A=p?ce(S,p,h):Ht(S,h);return A?(Ye(A),qt(h.map(I=>String(I.id||"")).filter(Boolean)),!0):!1}function Tr(){!t(b)||!kt.length||qt(kt,de)}function ci(o){const h=Ze().map(K=>Qt(K)).filter(Boolean),S=de&&h.includes(de)?de:h[0]||"",A=h.indexOf(S),I=h.indexOf(o);if(A<0||I<0){qt([o],o);return}const[H,L]=A<=I?[A,I]:[I,A];qt(h.slice(H,L+1),S)}function ji(o){const p=kt.includes(o),h=p?kt.filter(S=>S!==o):[...kt,o];qt(h,p?de:o)}function Ei(o,p){const h=Math.min(o.x,p.x),S=Math.min(o.y,p.y),A=Math.abs(o.x-p.x),I=Math.abs(o.y-p.y);return{left:h,top:S,width:A,height:I}}function ni(o,p){const h=o.left+o.width,S=o.top+o.height,A=p.left+p.width,I=p.top+p.height;return!(h<p.left||A<o.left||S<p.top||I<o.top)}function qi(o){const p=[];for(const h of Ze()){const S=Qt(h);S&&ni(o,h.getBoundingClientRect())&&p.push(S)}return p}function ui(o){if(!De)return;const p={x:o.clientX,y:o.clientY},h=Ei(De,p);if(!t(xe)){if(h.width<10&&h.height<10)return;f(xe,!0),Mt=!0,window.getSelection()?.removeAllRanges()}o.preventDefault(),f(ln,h);const S=qi(h);S.length?qt(S,S[0]):qt([])}function Qe(){De=null,f(xe,!1),f(ln,{left:0,top:0,width:0,height:0}),window.removeEventListener("mousemove",ui),window.removeEventListener("mouseup",rr)}function rr(){Qe()}function Jr(o){if(!t(b)||o.button!==0)return;const p=o.target;if(!p||!t(b).contains(p)||p.closest('a,button,input,textarea,select,[data-wa-no-marquee="1"]'))return;const h=t(b).getBoundingClientRect(),S=o.clientX<=h.left+22;!o.altKey&&!S||(De={x:o.clientX,y:o.clientY},f(xe,!1),f(ln,{left:o.clientX,top:o.clientY,width:0,height:0}),window.addEventListener("mousemove",ui),window.addEventListener("mouseup",rr))}function xn(o){if(!o.isContentEditable)return;o.focus();const p=document.createRange();p.selectNodeContents(o);const h=!Lt(Ut(o));p.collapse(h);const S=window.getSelection();S?.removeAllRanges(),S?.addRange(p)}function Pe(o){if(!t(b))return null;const p=Array.from(t(b).querySelectorAll('[data-wa-edit="1"]'));if(!p.length)return null;p.sort((H,L)=>H.getBoundingClientRect().top-L.getBoundingClientRect().top);const h=p[0],S=p[p.length-1];if(o<=h.getBoundingClientRect().top+4)return h;if(o>=S.getBoundingClientRect().bottom-4)return S;let A=h,I=Number.POSITIVE_INFINITY;for(const H of p){const L=H.getBoundingClientRect(),K=L.top+L.height/2,R=Math.abs(o-K);R<I&&(A=H,I=R)}return A}function Un(o,p){const h=p.getBoundingClientRect();return o.clientX<=h.left+18}function ue(o){if(t(Kt)&&Jn(),Mt){Mt=!1;return}const p=o.target;if(!p||!t(b))return;const h=p.closest('[data-block-id], [data-section-id], [data-doc-title="1"]');if(!h||!t(b).contains(h)){if(ye(),!i()&&!U()){const L=Pe(o.clientY)||t(b).querySelector('[data-wa-edit="1"]');L&&xn(L)}return}const S=Qt(h);if(!S){ye();return}const A=Un(o,h),I=o.ctrlKey||o.metaKey;if(!(o.shiftKey||I||o.altKey||A)){ye();return}if(o.shiftKey){ci(S);return}if(I){ji(S);return}qt([S],S)}function Sn(){const o=String(t(bt)||"").trim().toLowerCase();return o?Bt.filter(p=>`${p.label} ${p.desc} ${p.keywords.join(" ")}`.toLowerCase().includes(o)):Bt}function Jn(){f(Kt,!1),f(bt,""),f(Le,0)}function _e(){const o=window.getSelection();if(!o||o.rangeCount===0)return null;const p=o.getRangeAt(0).cloneRange();p.collapse(!0);let h=p.getBoundingClientRect();if(!h||h.width===0&&h.height===0){const S=document.createElement("span");S.textContent="​",S.style.opacity="0",p.insertNode(S),h=S.getBoundingClientRect(),S.remove(),o.removeAllRanges(),o.addRange(p)}return h||null}function jr(o){if(i()||U())return;const p=An(o);if(!p)return;const h=_e()||p.getBoundingClientRect(),S=320,A=320;f(vn,Math.min(Math.max(12,h.left),Math.max(12,window.innerWidth-S-12))),f(cn,Math.min(Math.max(72,h.bottom+8),Math.max(72,window.innerHeight-A-12))),f(bt,""),f(Le,0),f(Kt,!0)}function Zt(o){const p=Sn();if(!p.length){f(Le,0);return}const h=(t(Le)+o+p.length)%p.length;f(Le,h)}function Fi(o){const p=Sn();if(!p.length){Jn();return}const h=p[Math.max(0,Math.min(o,p.length-1))];Jn(),te(h.command);const S=An(document.activeElement);S&&Yt(S,0),queueMicrotask(()=>zt())}function In(o){if(t(b)&&Qr(b,t(b).dataset.caretActive="1"),i()||U()){o.target?.blur?.(),t(b)&&delete t(b).dataset.caretActive,zt();return}const p=Ue(o.target);p&&(f(Tt,p),f(wt,String(p.dataset.blockId||p.dataset.sectionId||p.dataset.docTitle||"")),queueMicrotask(()=>zt()))}function Oi(o){t(Kt)&&Jn();const p=Ue(o.target);p&&(!i()&&!U()&&yn(p,{immediate:!0}),t(Tt)===p&&(f(Tt,null),f(wt,"")),Wt&&Wt!==j&&Sr()),queueMicrotask(()=>{if(!t(b))return;const h=document.activeElement;h&&t(b).contains(h)?Qr(b,t(b).dataset.caretActive="1"):delete t(b).dataset.caretActive}),queueMicrotask(()=>zt())}function Ce(o){if(i()||U()||Nt)return;const p=An(o.target);p&&(f(Tt,p),f(wt,String(p.dataset.blockId||p.dataset.sectionId||p.dataset.docTitle||"")),Yt(p),queueMicrotask(()=>zt()))}function nn(){Nt=!0,zt()}function Gn(o){Nt=!1,Ce(o),queueMicrotask(()=>zt())}function kn(o){const p=document.createElement("div");p.innerHTML=o;const h=[],S=L=>{if(L.nodeType===Node.TEXT_NODE)return(L.textContent||"").replace(/\s+/g," ");if(!(L instanceof HTMLElement))return"";const K=L.tagName.toLowerCase();if(K==="br")return`
`;if(K==="strong"||K==="b")return`**${A(L)}**`;if(K==="em"||K==="i")return`*${A(L)}*`;if(K==="u")return`++${A(L)}++`;if(K==="del"||K==="s")return`~~${A(L)}~~`;if(K==="mark")return`==${A(L)}==`;if(K==="code")return"`"+A(L)+"`";if(K==="a"){const R=L.getAttribute("href")||"",z=A(L);return R?`[${z}](${R})`:z}return A(L)},A=L=>{const K=[];return L.childNodes.forEach(R=>K.push(S(R))),K.join("").replace(/\s+/g," ").trim()},I=L=>{const K=L.replace(/\s+$/g,"").trim();K&&h.push(K)},H=L=>{if(!(L instanceof HTMLElement))return;const K=L.tagName.toLowerCase();if(L.dataset.waFigure==="1"){const R=L.querySelector("figcaption")?.textContent?.trim()||"图示";h.push(`[[FIGURE:{"caption":"${Er(R)}"}]]`);return}if(L.dataset.waTable==="1"){const R=L.querySelector(".wa-table-caption")?.textContent?.trim()||"表格";h.push(`[[TABLE:{"caption":"${Er(R)}"}]]`);return}if(K==="h1"||K==="h2"||K==="h3"){const R=K==="h1"?1:K==="h2"?2:3,z=A(L);z&&h.push(`${"#".repeat(R)} ${z}`);return}if(K==="pre"){const R=L.textContent||"";h.push("```\n"+R.replace(/\n+$/,"")+"\n```");return}if(K==="blockquote"){const R=A(L);R&&h.push("> "+R);return}if(K==="ul"||K==="ol"){Array.from(L.querySelectorAll(":scope > li")).forEach((z,it)=>{const Q=A(z);Q&&h.push(K==="ol"?`${it+1}. ${Q}`:`- ${Q}`)});return}if(K==="p"||K==="div"){const R=A(L);I(R);return}if(K==="figure"){const R=L.querySelector("figcaption")?.textContent?.trim()||"图示";h.push(`[[FIGURE:{"caption":"${Er(R)}"}]]`);return}if(K==="table"){h.push('[[TABLE:{"caption":"表格"}]]');return}L.childNodes.forEach(R=>H(R))};return p.childNodes.forEach(L=>H(L)),h.join(`

`).trim()}function Ai(o){const p=document.createElement("div");p.innerHTML=o;const h=[];let S="";const A=at=>{if(at.nodeType===Node.TEXT_NODE)return(at.textContent||"").replace(/\s+/g," ");if(!(at instanceof HTMLElement))return"";const ct=at.tagName.toLowerCase();if(ct==="br")return`
`;if(ct==="strong"||ct==="b")return`**${I(at)}**`;if(ct==="em"||ct==="i")return`*${I(at)}*`;if(ct==="u")return`++${I(at)}++`;if(ct==="del"||ct==="s")return`~~${I(at)}~~`;if(ct==="mark")return`==${I(at)}==`;if(ct==="code")return"`"+I(at)+"`";if(ct==="a"){const It=at.getAttribute("href")||"",Vt=I(at);return It?`[${Vt}](${It})`:Vt}return I(at)},I=at=>{const ct=[];return at.childNodes.forEach(It=>ct.push(A(It))),ct.join("").replace(/\s+/g," ").trim()},H=(at,ct)=>{const It=at.replace(/\s+$/g,"").trim();It&&h.push({type:"paragraph",text:It,id:ct||void 0})},L=["摘要","引言","绪论","前言","背景","相关技术概述","关键技术","研究方法","实验","结果","讨论","结论","总结","展望","参考文献","附录","致谢","Abstract"],K=/^(\d+(?:\.\d+){0,2})\s*[\.、:：-]?\s*([^\s].{0,24})$/,R=/^([一二三四五六七八九十]+)\s*[、.．:：-]?\s*([^\s].{0,24})$/,z=at=>{const ct=String(at||"").trim();return ct?!!(ct.length>=24||/[。！？!?；;，,]/.test(ct)||["本文","本研究","随着","通过","由于","因此","此外","同时","首先","其次","最后"].some(Gt=>{const Pt=ct.indexOf(Gt);return Pt>=1&&Pt<=18})||ct.length>=14&&/(是|为|通过|随着|由于|因此|并且|能够|可以|实现|提升|优化)/.test(ct)):!1},it=at=>{const ct=String(at||"").trim();if(!ct)return{title:"",rest:""};const It=/^(.{2,18})\s*\1(.+)$/.exec(ct);if(It)return{title:String(It[1]||"").trim(),rest:String(It[2]||"").trim()};for(const Gt of L){const Pt=ct.indexOf(Gt);if(Pt>1&&Pt<=20){const Nn=ct.slice(0,Pt).trim(),Wi=ct.slice(Pt).trim();if(Nn.length>=2&&Wi.length>=2)return{title:Nn,rest:Wi}}}const Vt=ct.search(/\b\d+(?:\.\d+){0,2}\b/);return Vt>1&&Vt<=20?{title:ct.slice(0,Vt).trim(),rest:ct.slice(Vt).trim()}:{title:ct,rest:""}},Q=at=>{const ct=String(at||"").trim();if(!ct)return null;if(ct.length<=12&&L.includes(ct))return{level:2,heading:ct,rest:""};const It=K.exec(ct);if(It){const Gt=String(It[1]||"").trim(),Pt=String(It[2]||"").trim();if(z(Pt))return null;const Nn=Gt.split(".").length-1;return{level:Math.min(4,2+Math.max(0,Nn)),heading:`${Gt} ${Pt}`.trim(),rest:""}}const Vt=R.exec(ct);if(Vt){const Gt=String(Vt[1]||"").trim(),Pt=String(Vt[2]||"").trim();return z(Pt)?null:{level:2,heading:`${Gt} ${Pt}`.trim(),rest:""}}if(ct.length>20){for(const Gt of L)if(ct.startsWith(Gt)&&ct.length>Gt.length+8)return{level:2,heading:Gt,rest:ct.slice(Gt.length).trim()}}return null},gt=(at,ct)=>{const It=String(at||"").trim();if(!It)return;const Vt=Q(It);if(Vt){h.push({type:"heading",level:Vt.level,text:Vt.heading}),Vt.rest&&H(Vt.rest,ct);return}H(It,ct)},st=at=>{const ct=at.tagName.toLowerCase()==="table"?at:at.querySelector("table");if(!ct)return null;const It=at.querySelector("figcaption")||at.querySelector(".wa-table-caption")||ct.querySelector("caption"),Vt=It?(It.textContent||"").trim():"",Gt=[],Pt=[],Nn=Array.from(ct.querySelectorAll("thead th"));return Nn.length&&Nn.forEach(Vr=>Gt.push((Vr.textContent||"").trim())),Array.from(ct.querySelectorAll("tr")).forEach((Vr,va)=>{const Rs=Array.from(Vr.querySelectorAll("td, th"));if(!Rs.length)return;const Ys=Rs.map(pa=>(pa.textContent||"").trim());if(!Gt.length&&va===0&&Vr.querySelectorAll("th").length===Rs.length){Gt.push(...Ys);return}Pt.push(Ys)}),{caption:Vt,columns:Gt,rows:Pt}},_t=at=>{const ct=at.tagName.toLowerCase()==="figure"?at:at.querySelector("figure"),It=ct?.querySelector("figcaption")||at.querySelector("figcaption"),Vt=It?(It.textContent||"").trim():"",Gt=ct?.dataset.figureSpec||"";let Pt={};if(Gt)try{const Nn=JSON.parse(decodeURIComponent(Gt));Nn&&typeof Nn=="object"&&(Pt=Nn)}catch{Pt={}}return Vt&&(Pt={...Pt,caption:Vt}),Object.keys(Pt).length?Pt:{caption:Vt}},Ct=at=>{if(!(at instanceof HTMLElement))return;const ct=at.tagName.toLowerCase();if(ct==="div"&&at.classList.contains("wa-doc")){at.childNodes.forEach(It=>Ct(It));return}if(!(at.classList.contains("wa-header")||at.classList.contains("wa-footer"))){if(at.classList.contains("wa-body")){at.childNodes.forEach(It=>Ct(It));return}if(at.classList.contains("wa-title")){const It=I(at),Vt=it(It);Vt.title&&!S&&(S=Vt.title),Vt.rest&&gt(Vt.rest);return}if(at.dataset.waTable==="1"||at.classList.contains("wa-table")||ct==="table"){const It=st(at);It&&h.push({type:"table",table:It,id:at.dataset.blockId||void 0});return}if(at.dataset.waFigure==="1"||at.classList.contains("wa-figure")||ct==="figure"){const It=_t(at);It&&h.push({type:"figure",figure:It,id:at.dataset.blockId||void 0});return}if(ct==="h1"||ct==="h2"||ct==="h3"||ct==="h4"||ct==="h5"||ct==="h6"){const It=Number(ct.slice(1)),Vt=I(at);if(Vt){if(It===1&&!S){S=Vt;return}h.push({type:"heading",level:It,text:Vt})}return}if(ct==="ul"||ct==="ol"){const It=Array.from(at.querySelectorAll(":scope > li")).map(Vt=>I(Vt)).filter(Boolean);It.length&&h.push({type:"list",items:It,ordered:ct==="ol",id:at.dataset.blockId||void 0});return}if(ct==="blockquote"){const It=I(at);It&&h.push({type:"paragraph",text:It});return}if(ct==="pre"){const It=at.textContent||"";H(It.replace(/\n+$/,""),at.dataset.blockId||void 0);return}if(ct==="p"||ct==="div"){const It=I(at);gt(It,at.dataset.blockId||void 0);return}at.childNodes.forEach(It=>Ct(It))}};p.childNodes.forEach(at=>Ct(at));const $e=S||cs(h)||"自动生成文档";return Gr(h,$e)}function cs(o){for(const p of o){if(String(p.type||"")==="heading"&&Number(p.level||0)===1&&p.text)return String(p.text||"").trim();if(String(p.type||"")==="paragraph"&&p.text){const h=String(p.text||"").trim();if(h)return h.slice(0,24)}}return""}function Gr(o,p){const h=String(p||"").trim()||"自动生成文档",S=[],A=[];let I=[];const H=()=>{if(!I.length)return;const L={id:Rn(),title:h,level:1,blocks:I,children:[]};S.push(L),A.push({level:1,node:L}),I=[]};for(const L of o){if(String(L.type||"").toLowerCase()==="heading"){const z=Math.min(6,Math.max(1,Number(L.level||1))),it=String(L.text||"").trim()||"章节",Q={id:Rn(),title:it,level:z,blocks:[],children:[]};for(I.length&&A.length===0&&H();A.length&&A[A.length-1].level>=z;)A.pop();A.length?A[A.length-1].node.children.push(Q):S.push(Q),A.push({level:z,node:Q});continue}const R=Yi(L);R&&(A.length?A[A.length-1].node.blocks.push(R):I.push(R))}return I.length&&!S.length&&S.push({id:Rn(),title:h,level:1,blocks:I,children:[]}),{title:h,sections:S}}function Yi(o){const p=String(o.type||"paragraph").toLowerCase(),S=String(o.id||"").trim()||Rn();if(p==="paragraph"){const I=String(o.text||"").trim();return I?{id:S,type:"paragraph",text:I}:null}if(p==="list"){const I=Array.isArray(o.items)?o.items.map(L=>String(L||"").trim()).filter(Boolean):[];if(!I.length)return null;const H=!!o.ordered;return{id:S,type:"list",items:I,ordered:H}}if(p==="table")return{id:S,type:"table",table:o.table||{}};if(p==="figure")return{id:S,type:"figure",figure:o.figure||{}};const A=String(o.text||"").trim();return A?{id:S,type:"paragraph",text:A}:null}function Rn(){return typeof crypto<"u"&&"randomUUID"in crypto?crypto.randomUUID().replace(/-/g,""):`b${Math.random().toString(16).slice(2)}${Date.now().toString(16)}`}function Er(o){return o.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}function Qi(){if(!t(b))return null;const o=document.activeElement;if(o&&t(b).contains(o)&&o.isContentEditable)return o;const p=Jt[0]||null;if(p&&p.isContentEditable)return p.focus(),p;const h=t(b).querySelector('[data-wa-edit="1"]');return h?(h.focus(),h):null}function fi(){if(!t(b))return!1;const o=document.activeElement;return!!(o&&t(b).contains(o)&&o.isContentEditable)}function Ci(o){const p=Qi();if(!p)return!1;try{return document.execCommand(o)?(Yt(p,0),!0):!1}catch{return!1}}function te(o){const p=i()||U(),h=String(o||"").toLowerCase();if(h==="copy"){Cn(),zt();return}if(h==="cut"){p||Ae(),zt();return}if(h==="paste"){p||Wn(),zt();return}if(h==="undo"){if(p){zt();return}Ci("undo")||nm(),queueMicrotask(()=>zt());return}if(h==="redo"){if(p){zt();return}Ci("redo")||rm(),queueMicrotask(()=>zt());return}if(Qi()){if(o==="bold")return document.execCommand("bold");if(o==="italic")return document.execCommand("italic");if(o==="underline")return document.execCommand("underline");if(o==="strikethrough")return document.execCommand("strikeThrough");if(o==="superscript")return document.execCommand("superscript");if(o==="subscript")return document.execCommand("subscript");if(o==="heading1")return document.execCommand("formatBlock",!1,"H1");if(o==="heading2")return document.execCommand("formatBlock",!1,"H2");if(o==="heading3")return document.execCommand("formatBlock",!1,"H3");if(o==="paragraph")return document.execCommand("formatBlock",!1,"P");if(o==="list-bullet")return document.execCommand("insertUnorderedList");if(o==="list-number")return document.execCommand("insertOrderedList");if(o==="indent")return document.execCommand("indent");if(o==="outdent")return document.execCommand("outdent");if(o==="quote")return document.execCommand("formatBlock",!1,"BLOCKQUOTE");if(o==="align-left")return document.execCommand("justifyLeft");if(o==="align-center")return document.execCommand("justifyCenter");if(o==="align-right")return document.execCommand("justifyRight");if(o==="align-justify")return document.execCommand("justifyFull");if(o.startsWith("line-height:")){const S=o.slice(12),A=window.getSelection();if(A&&A.rangeCount){let H=A.getRangeAt(0).commonAncestorContainer;if(H.nodeType===Node.TEXT_NODE&&(H=H.parentElement),H instanceof HTMLElement){let L=H.closest("p, div, h1, h2, h3, blockquote");L instanceof HTMLElement&&(L.style.lineHeight=S)}}return}if(o.startsWith("margin:")){const S=o.slice(7),A=window.getSelection();if(A&&A.rangeCount){let H=A.getRangeAt(0).commonAncestorContainer;if(H.nodeType===Node.TEXT_NODE&&(H=H.parentElement),H instanceof HTMLElement){let L=H.closest("p, div, h1, h2, h3");L instanceof HTMLElement&&(L.style.margin=S)}}return}if(o==="indent-first"){const S=window.getSelection();if(S&&S.rangeCount){let I=S.getRangeAt(0).commonAncestorContainer;if(I.nodeType===Node.TEXT_NODE&&(I=I.parentElement),I instanceof HTMLElement){let H=I.closest("p, div");H instanceof HTMLElement&&(H.style.textIndent="2em")}}return}if(o.startsWith("color:")){const S=o.slice(6);return document.execCommand("foreColor",!1,S)}if(o.startsWith("bgcolor:")){const S=o.slice(8);return document.execCommand("hiliteColor",!1,S)}if(o.startsWith("font:")){const S=o.slice(5);return document.execCommand("fontName",!1,S)}if(o.startsWith("size:")){const S=o.slice(5),A=window.getSelection();if(A&&A.rangeCount){const I=A.getRangeAt(0),H=document.createElement("span");H.style.fontSize=S+"px",I.surroundContents(H)}return}if(o==="code"){const S=window.getSelection(),A=S&&S.rangeCount?S.getRangeAt(0).toString():"";return document.execCommand("insertHTML",!1,`<pre><code>${bi(A||"")}</code></pre>`)}if(o==="image"){const S=document.createElement("input");S.type="file",S.accept="image/*",S.onchange=async A=>{const I=A.target.files?.[0];if(!I)return;const H=new FileReader;H.onload=L=>{const K=L.target?.result;document.execCommand("insertHTML",!1,`<img src="${K}" alt="图片" style="max-width:100%;height:auto;" />`)},H.readAsDataURL(I)},S.click();return}if(o==="table"){const S=prompt("行数：","3"),A=prompt("列数：","3");if(!S||!A)return;let I='<table style="border-collapse:collapse;width:100%;margin:10px 0;">';for(let H=0;H<parseInt(S);H++){I+="<tr>";for(let L=0;L<parseInt(A);L++)I+='<td style="border:1px solid #ccc;padding:8px;min-width:80px;">　</td>';I+="</tr>"}return I+="</table>",document.execCommand("insertHTML",!1,I)}if(o==="link"){const S=prompt("请输入链接地址：","https://");S&&document.execCommand("createLink",!1,S);return}if(o==="hr")return document.execCommand("insertHTML",!1,'<hr style="border:none;border-top:1px solid #ddd;margin:16px 0;" />');if(o==="math-inline"){const S=prompt("输入行内公式（LaTeX）：","x^2 + y^2 = r^2");S&&document.execCommand("insertHTML",!1,`<span class="math-inline" data-latex="${bi(S)}">$${S}$</span>`);return}if(o==="math-block"){const S=prompt("输入公式块（LaTeX）：","\\int_{-\\infty}^{\\infty} e^{-x^2} dx = \\sqrt{\\pi}");S&&document.execCommand("insertHTML",!1,`<div class="math-block" data-latex="${bi(S)}">$$${S}$$</div>`);return}if(o==="footnote"){const S=prompt("脚注内容：");if(!S)return;const A="fn-"+Date.now(),I=`<sup><a href="#${A}" id="ref-${A}" style="color:#a5722a;text-decoration:none;">[${cr()}]</a></sup>`;document.execCommand("insertHTML",!1,I),_i(A,S,cr());return}if(o==="toc"){const S=Cr();document.execCommand("insertHTML",!1,S);return}if(o==="clear-format")return document.execCommand("removeFormat")}}function Ar(o){const p=o.ctrlKey||o.metaKey,h=String(o.key||"").toLowerCase(),S=!fi()&&kt.length>0,A=An(o.target)||tr()||or();if(t(Kt)){if(h==="escape"){o.preventDefault(),Jn();return}if(h==="arrowdown"){o.preventDefault(),Zt(1);return}if(h==="arrowup"){o.preventDefault(),Zt(-1);return}if(h==="enter"||h==="tab"){o.preventDefault(),Fi(t(Le));return}if(h==="backspace"){o.preventDefault(),f(bt,String(t(bt)||"").slice(0,-1)),f(Le,0);return}if(!p&&!o.altKey&&!o.metaKey&&o.key.length===1){o.preventDefault(),f(bt,t(bt)+o.key),f(Le,0);return}}if(!p&&!o.altKey&&o.key==="/"&&A){o.preventDefault(),jr(o.target);return}if(p&&h==="b"){o.preventDefault(),te("bold");return}if(p&&h==="i"){o.preventDefault(),te("italic");return}if(p&&h==="u"){o.preventDefault(),te("underline");return}if(p&&o.shiftKey&&h==="x"){o.preventDefault(),te("strikethrough");return}if(p&&h==="z"&&o.shiftKey){o.preventDefault(),te("redo");return}if(p&&h==="z"){o.preventDefault(),te("undo");return}if(p&&h==="y"){o.preventDefault(),te("redo");return}if(p&&h==="k"){o.preventDefault(),te("link");return}if(p&&h==="f"){o.preventDefault(),f(pn,!0),zt();return}if(p&&h==="c"&&S&&!Je()){o.preventDefault(),te("copy");return}if(p&&h==="x"&&S&&!Je()){o.preventDefault(),te("cut");return}if(p&&h==="v"&&S&&!Je()){o.preventDefault(),te("paste");return}if(o.key==="Enter"&&!o.shiftKey&&!p){const I=A;if(I&&I.dataset.blockId){const H=I.tagName.toLowerCase();if(H!=="ul"&&H!=="ol"){o.preventDefault(),document.execCommand("insertLineBreak"),Yt(I,0),queueMicrotask(()=>zt());return}}}if(o.key==="Enter"&&!o.shiftKey&&p){if(A&&t(b)){o.preventDefault(),document.execCommand("insertParagraph"),ne();const H=t(b).innerHTML||"",L=Ai(H);if(L)Ye(L,{immediate:!0}),f(B,"doc"),j=`doc:${Ti(L)}`,Yn.set(!1);else{const K=kn(H);yr.set(K),Yn.set(!0),qu(K),We(K)}queueMicrotask(()=>zt());return}const I=A;if(I&&I.dataset.blockId){const H=I.tagName.toLowerCase();if(H==="ul"||H==="ol"){o.preventDefault();const L=a();if(!L||typeof L!="object")return;const K=String(I.dataset.blockId),z=window.getSelection()?.anchorNode,it=z instanceof HTMLElement?z:z?.parentElement,Q=it?it.closest("li"):null;if(!Q||!I.contains(Q))return;const gt=Array.from(I.querySelectorAll(":scope > li")),st=gt.indexOf(Q);if(st<0)return;let _t="",Ct="";const $e=vr(Q);if($e)_t=$e.before,Ct=$e.after;else{const Gt=Ut(Q),Pt=On(Q),Nn=Pt==null?Gt.length:Math.max(0,Math.min(Gt.length,Pt));_t=Gt.slice(0,Nn),Ct=Gt.slice(Nn)}const at=Lt(_t),ct=Lt(Ct);if(!at&&!ct){const Gt=gt.map((Pt,Nn)=>Nn===st?null:Lt(X(Pt))).filter(Pt=>Pt!==null);if(Gt.length){const Pt=sn(L,K,{type:"list",items:Gt,ordered:H==="ol"});if(Pt){const Nn={id:Rn(),type:"paragraph",text:""},Wi=kr(Pt,K,Nn);if(Wi){tt=String(Nn.id||""),Ye(Wi);return}Ye(Pt)}}else{const Pt=sn(L,K,{type:"paragraph",text:"",items:[],ordered:!1});Pt&&(tt=K,Ye(Pt))}return}const It=gt.map((Gt,Pt)=>Pt===st?at:Lt(X(Gt)));It.splice(st+1,0,ct);const Vt=sn(L,K,{type:"list",items:It,ordered:H==="ol"});Vt&&(tt=K,Ye(Vt));return}if(H==="p"||/^h[1-6]$/.test(H)){o.preventDefault();const L=a();if(!L||typeof L!="object")return;const K=String(I.dataset.blockId),R=Ut(I),z=On(I),it=z==null?R.length:Math.max(0,Math.min(R.length,z)),Q=R.slice(0,it),gt=R.slice(it),st=Lt(Q),_t=Lt(gt),Ct=_n(I),$e=/^h[1-6]$/.test(H);if(it===0){const Gt={id:Rn(),type:"paragraph",text:""};Ct&&H==="p"&&(Gt.style=Ct);const Pt=Pn(L,K,Gt);Pt&&(tt=String(Gt.id||""),Ye(Pt));return}if(it>=R.length){const Gt={id:Rn(),type:"paragraph",text:""};Ct&&H==="p"&&(Gt.style=Ct);const Pt=kr(L,K,Gt);Pt&&(tt=String(Gt.id||""),Ye(Pt));return}let at=null;if($e){const Pt={type:"heading",level:Number(H.slice(1)),text:st.replace(/\n+/g," ").trim()};Ct&&(Pt.style=Ct),at=sn(L,K,Pt)}else{const Gt={type:"paragraph",text:st};Ct&&(Gt.style=Ct),at=sn(L,K,Gt)}const ct={id:Rn(),type:"paragraph",text:_t};!$e&&Ct&&(ct.style=Ct);const Vt=kr(at||L,K,ct);Vt&&(tt=String(ct.id||""),Ye(Vt))}}}queueMicrotask(()=>zt())}let pn=W(!1),Pr=W(""),di=W(""),Ii=W(!1),Ni=W(!1),us=W(!1),Ls=W(!1),Mi=W(!1);const Xs=new Map,et=["宋体","黑体","微软雅黑","楷体","Arial","Times New Roman","Courier New","Georgia","Verdana"],ut=[12,14,16,18,20,22,24,28,32,36,42,48,56,64,72],Xt=["#000000","#333333","#666666","#999999","#CCCCCC","#FFFFFF","#FF0000","#FF6600","#FFCC00","#00FF00","#00CCFF","#0000FF","#9900FF","#FF00FF"],Dt=[1,1.15,1.5,2,2.5,3];function fe(){t(Pr)&&window.find(t(Pr),!1,!1,!0,!1,!0,!1)}function mn(){if(!t(Pr))return;const o=window.getSelection();o&&o.toString().toLowerCase()===t(Pr).toLowerCase()&&document.execCommand("insertHTML",!1,t(di)),fe()}function ie(){const o=new RegExp(hn(t(Pr)),"gi");if(!t(Pr))return;if(a()&&typeof a()=="object"){const h=Fr(a(),o,t(di));h&&Ye(h),f(pn,!1);return}if(!t(b))return;let p=t(b).innerHTML;p=p.replace(o,t(di)),Qr(b,t(b).innerHTML=p),ne(),f(pn,!1)}function hn(o){return o.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function Kn(){const o=window.getSelection();if(!o||!o.rangeCount)return;const p=o.anchorNode?.parentElement?.closest("td, th");if(!p)return alert("请先选中表格单元格");const h=p.nextElementSibling;if(!h||h.tagName!=="TD"&&h.tagName!=="TH")return alert("无法合并：需要选中相邻单元格");const S=parseInt(p.getAttribute("colspan")||"1");p.setAttribute("colspan",String(S+1)),h.remove()}function ir(){const o=window.getSelection();if(!o||!o.rangeCount)return;const p=o.anchorNode?.parentElement?.closest("td, th");if(!p)return alert("请先选中表格单元格");const h=p.parentElement,S=h.cloneNode(!0);S.querySelectorAll("td, th").forEach(A=>A.textContent="　"),h.parentElement?.insertBefore(S,h.nextSibling)}function lr(){const o=window.getSelection();if(!o||!o.rangeCount)return;const p=o.anchorNode?.parentElement?.closest("td, th");if(!p)return alert("请先选中表格单元格");const h=Array.from(p.parentElement?.children||[]).indexOf(p),S=p.closest("table");S&&S.querySelectorAll("tr").forEach(A=>{const I=document.createElement(p.tagName.toLowerCase());I.textContent="　",I.style.cssText=p.style.cssText,A.insertBefore(I,A.children[h+1])})}function me(){const o=window.getSelection();if(!o||!o.rangeCount)return;const p=o.anchorNode?.parentElement?.closest("td, th");if(!p)return alert("请先选中表格单元格");const h=p.parentElement;if(!h)return;const S=h.parentElement;if(S&&S.children.length<=1)return alert("无法删除：表格至少需要一行");h.remove()}function mr(){const o=window.getSelection();if(!o||!o.rangeCount)return;const p=o.anchorNode?.parentElement?.closest("td, th");if(!p)return alert("请先选中表格单元格");const h=Array.from(p.parentElement?.children||[]).indexOf(p),S=p.closest("table");if(!S)return;const A=S.querySelector("tr");if(A&&A.children.length<=1)return alert("无法删除：表格至少需要一列");S.querySelectorAll("tr").forEach(I=>{I.children[h]?.remove()})}function cr(){return t(b)?t(b).querySelectorAll('[id^="ref-fn-"]').length+1:1}function _i(o,p,h){if(!t(b))return;let S=t(b).querySelector(".footnotes-section");S||(S=document.createElement("div"),S.className="footnotes-section",S.innerHTML='<hr style="margin-top:40px;border:none;border-top:1px solid #ddd;" /><h3>脚注</h3>',t(b).appendChild(S));const A=document.createElement("div");A.className="footnote-item",A.id=o,A.innerHTML=`<sup>[${h}]</sup> ${p}`,S.appendChild(A)}function Cr(){if(!t(b))return"";const o=t(b).querySelectorAll("h1, h2, h3");if(o.length===0)return"<p>未找到标题</p>";let p='<div class="toc-section" style="border:1px solid #ddd;padding:16px;border-radius:8px;background:rgba(255,255,255,0.5);margin:20px 0;"><h3>目录</h3><ul style="list-style:none;padding-left:0;">';return o.forEach((h,S)=>{const A=parseInt(h.tagName[1]),I=h.textContent||"",H="heading-"+S;h.id=H;const L=(A-1)*20;p+=`<li style="margin-left:${L}px;margin-top:8px;"><a href="#${H}" style="color:#a5722a;text-decoration:none;">${I}</a></li>`}),p+="</ul></div>",p}function bi(o){return String(o||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Ir(){if(!(!t(b)||!window.renderMathInElement))try{window.renderMathInElement(t(b),{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],throwOnError:!1})}catch(o){console.error("Math rendering error:",o)}}function yi(){!t(b)||!window.Prism||t(b).querySelectorAll("pre code").forEach(o=>{window.Prism.highlightElement(o)})}async function Kr(){if(!t(b))return;const o=Array.from(t(b).querySelectorAll(".wa-figure[data-figure-spec]"));for(const p of o){if(p.dataset.figureRendered==="1")continue;const h=p.dataset.figureSpec||"";if(!h)continue;p.dataset.figureRendered="1";let S=null;try{S=JSON.parse(decodeURIComponent(h))}catch{S=null}if(!S)continue;const A=JSON.stringify(S);let I=Xs.get(A);const H=p.querySelector(".wa-figure-box");if(H&&(H.innerHTML='<div class="wa-figure-loading">渲染中...</div>'),!I)try{const L=await fetch("/api/figure/render",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({spec:S})});if(!L.ok)throw new Error(await L.text());const K=await L.json();I=String(K.svg||""),I&&Xs.set(A,I)}catch{I=""}H&&(H.innerHTML=I||'<div class="wa-figure-loading">渲染失败</div>')}}const Bi=Do.subscribe(o=>{if(o){if(o==="commit"){$r(),Do.set(null),queueMicrotask(()=>zt());return}te(o),Do.set(null),queueMicrotask(()=>zt())}});Fa(()=>{if(Sr(),!ge(a())){const z=String(r()||"").trim(),it=z?ic(z):null;it?(Lr.set(it),Yn.set(!1)):(Lr.set(en()),Yn.set(!1))}E=yr.subscribe(()=>Sr()),Lr.subscribe(()=>Sr());const o=document.createElement("link");o.rel="stylesheet",o.href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css",document.head.appendChild(o);const p=document.createElement("script");p.src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js",p.onload=()=>{const z=document.createElement("script");z.src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js",z.onload=()=>{Ir()},document.head.appendChild(z)},document.head.appendChild(p);const h=document.createElement("link");h.rel="stylesheet",h.href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css",document.head.appendChild(h);const S=document.createElement("script");S.src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js",S.onload=()=>{const z=["https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-clike.min.js","https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-c.min.js","https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-cpp.min.js","https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-java.min.js","https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-javascript.min.js","https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-python.min.js","https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-sql.min.js"],it=Q=>new Promise(gt=>{const st=document.createElement("script");st.src=Q,st.async=!1,st.onload=()=>gt(),st.onerror=()=>gt(),document.head.appendChild(st)});(async()=>{for(const Q of z)await it(Q);setTimeout(()=>yi(),500)})()},document.head.appendChild(S);const A=new IntersectionObserver(z=>{z.forEach(it=>{if(it.isIntersecting&&it.target instanceof HTMLImageElement){const Q=it.target;Q.dataset.src&&(Q.src=Q.dataset.src,Q.removeAttribute("data-src"))}})}),I=new MutationObserver(()=>{t(b)?.querySelectorAll("img[data-src]").forEach(z=>A.observe(z))});t(b)&&I.observe(t(b),{childList:!0,subtree:!0});const H=()=>zt(),L=()=>zt(),K=()=>zt(),R=z=>{if(z.defaultPrevented||!(z.ctrlKey||z.metaKey))return;const Q=z.target;if(!!Q?.closest("input, textarea, select")||!!(Q&&Q.isContentEditable&&!t(b)?.contains(Q)))return;const st=String(z.key||"").toLowerCase();if(!fi()&&!kt.length)return;const _t=!fi()&&kt.length>0;if(st==="c"){_t&&!Je()&&(z.preventDefault(),te("copy"));return}if(st==="x"){_t&&!Je()&&(z.preventDefault(),te("cut"));return}if(st==="v"){_t&&!Je()&&(z.preventDefault(),te("paste"));return}if(st==="z"&&z.shiftKey){z.preventDefault(),te("redo");return}if(st==="z"){z.preventDefault(),te("undo");return}st==="y"&&(z.preventDefault(),te("redo"))};return document.addEventListener("selectionchange",H),t(b)?.addEventListener("mouseup",L),t(b)?.addEventListener("keyup",K),window.addEventListener("keydown",R),zt(!0),()=>{Qe(),Bi(),E&&E(),A.disconnect(),I.disconnect(),document.removeEventListener("selectionchange",H),t(b)?.removeEventListener("mouseup",L),t(b)?.removeEventListener("keyup",K),window.removeEventListener("keydown",R),F&&clearTimeout(F),O&&clearTimeout(O),Et&&clearTimeout(Et)}}),Hs(()=>(i(),se(U()),t(b),t(Tt)),()=>{const o=i()||U();t(b)&&(ee(),ne(),o&&t(Tt)&&(t(Tt).blur(),f(Tt,null),f(wt,"")),zt())}),so();var Zi={get showToolbar(){return P()},set showToolbar(o){P(o),dr()},get paper(){return dt()},set paper(o){dt(o),dr()},get lockEditing(){return U()},set lockEditing(o){U(o),dr()},$set:gi,$on:(o,p)=>hi(n,o,p)};Ds();var Pi=Vm(),wi=v(Pi);{var Vn=o=>{var p=Hm(),h=wr(p),S=u(v(h),2),A=v(S),I=v(A);d(A);var H=u(A,4),L=v(H);d(H),d(S),d(h);var K=u(h,2),R=v(K),z=v(R),it=u(z,2);{var Q=fn=>{var $n=Mm();on($n,5,()=>et,Fn,(Hr,sr)=>{var dn=Nm(),ri=v(dn,!0);d(dn),rt(()=>{Ts(dn,`font-family: ${t(sr)??""}`),D(ri,t(sr))}),C("click",dn,()=>{te("font:"+t(sr)),f(Ii,!1)}),M(Hr,dn)}),d($n),M(fn,$n)};Z(it,fn=>{t(Ii)&&fn(Q)})}d(R);var gt=u(R,2),st=v(gt),_t=v(st);_t.value=_t.__value="";var Ct=u(_t);on(Ct,1,()=>ut,Fn,(fn,$n)=>{var Hr=Bm(),sr=v(Hr);d(Hr);var dn={};rt(()=>{D(sr,`${t($n)??""}pt`),dn!==(dn=t($n))&&(Hr.value=(Hr.__value=t($n))??"")}),M(fn,Hr)}),d(st),d(gt);var $e=u(gt,2),at=v($e),ct=u(at,2);{var It=fn=>{var $n=Lm();on($n,5,()=>Xt,Fn,(Hr,sr)=>{var dn=Dm();rt(()=>{Ts(dn,`background: ${t(sr)??""};`),js(dn,"aria-label",`文字颜色 ${t(sr)}`)}),C("click",dn,()=>{te("color:"+t(sr)),f(Ni,!1)}),M(Hr,dn)}),d($n),M(fn,$n)};Z(ct,fn=>{t(Ni)&&fn(It)})}d($e);var Vt=u($e,2),Gt=v(Vt),Pt=u(Gt,2);{var Nn=fn=>{var $n=qm();on($n,5,()=>Xt,Fn,(Hr,sr)=>{var dn=Rm();rt(()=>{Ts(dn,`background: ${t(sr)??""};`),js(dn,"aria-label",`背景颜色 ${t(sr)}`)}),C("click",dn,()=>{te("bgcolor:"+t(sr)),f(us,!1)}),M(Hr,dn)}),d($n),M(fn,$n)};Z(Pt,fn=>{t(us)&&fn(Nn)})}d(Vt);var Wi=u(Vt,4),Vr=u(Wi,2),va=u(Vr,2),Rs=u(va,2),Ys=u(Rs,4),pa=u(Ys,2),ma=u(pa,2),Pa=u(ma,4),oo=v(Pa),Qo=u(oo,2);{var Zo=fn=>{var $n=Om();on($n,5,()=>Dt,Fn,(Hr,sr)=>{var dn=Fm(),ri=v(dn);d(dn),rt(()=>D(ri,`${t(sr)??""}倍行距`)),C("click",dn,()=>{te("line-height:"+t(sr)),f(Ls,!1)}),M(Hr,dn)}),d($n),M(fn,$n)};Z(Qo,fn=>{t(Ls)&&fn(Zo)})}d(Pa);var fs=u(Pa,2),lo=u(fs,2),co=u(lo,4),uo=u(co,2),fo=u(uo,4),vo=u(fo,2),po=u(vo,4),ha=v(po),mo=u(ha,2);{var ho=fn=>{var $n=Pm(),Hr=v($n),sr=u(Hr,2),dn=u(sr,2),ri=u(dn,2),Ha=u(ri,2),ga=u(Ha,2);d($n),C("click",Hr,()=>{te("table"),f(Mi,!1)}),C("click",sr,()=>{Kn(),f(Mi,!1)}),C("click",dn,()=>{ir(),f(Mi,!1)}),C("click",ri,()=>{lr(),f(Mi,!1)}),C("click",Ha,()=>{me(),f(Mi,!1)}),C("click",ga,()=>{mr(),f(Mi,!1)}),M(fn,$n)};Z(mo,fn=>{t(Mi)&&fn(ho)})}d(po),d(K),rt(fn=>{D(I,`${g()??""} 字`),D(L,`${fn??""} 分钟阅读`)},[()=>(g(),_(()=>Math.ceil(g()/400)))]),C("click",z,()=>f(Ii,!t(Ii))),C("change",st,fn=>te("size:"+fn.currentTarget.value)),C("click",at,()=>f(Ni,!t(Ni))),C("click",Gt,()=>f(us,!t(us))),C("click",Wi,()=>te("align-left")),C("click",Vr,()=>te("align-center")),C("click",va,()=>te("align-right")),C("click",Rs,()=>te("align-justify")),C("click",Ys,()=>te("superscript")),C("click",pa,()=>te("subscript")),C("click",ma,()=>te("hr")),C("click",oo,()=>f(Ls,!t(Ls))),C("click",fs,()=>te("indent-first")),C("click",lo,()=>te("margin:10px 0")),C("click",co,()=>te("math-inline")),C("click",uo,()=>te("math-block")),C("click",fo,()=>te("footnote")),C("click",vo,()=>te("toc")),C("click",ha,()=>f(Mi,!t(Mi))),M(o,p)};Z(wi,o=>{P()&&o(Vn)})}var we=u(wi,2);wc(we,o=>f(b,o),()=>t(b));var hr=u(we,2);{var vi=o=>{var p=Jm(),h=v(p),S=u(v(h),2),A=v(S,!0);d(S),d(h);var I=u(h,2);{var H=R=>{var z=zm();M(R,z)},L=$a(()=>_(()=>Sn().length===0)),K=R=>{var z=Um();on(z,5,()=>_(Sn),Fn,(it,Q,gt)=>{var st=Wm(),_t=v(st),Ct=v(_t,!0);d(_t);var $e=u(_t,2),at=v($e,!0);d($e),d(st),rt(()=>{Me(st,1,`slash-item ${gt===t(Le)?"active":""}`,"svelte-lk86dq"),js(st,"aria-selected",gt===t(Le)),D(Ct,(t(Q),_(()=>t(Q).label))),D(at,(t(Q),_(()=>t(Q).desc)))}),C("mouseenter",st,()=>f(Le,gt)),C("click",st,()=>Fi(gt)),M(it,st)}),d(z),M(R,z)};Z(I,R=>{t(L)?R(H):R(K,!1)})}ms(2),d(p),rt(()=>{Ts(p,`left:${t(vn)}px;top:${t(cn)}px;`),D(A,t(bt)||"全部")}),C("mousedown",p,ua(function(R){bs.call(this,n,R)})),M(o,p)};Z(hr,o=>{t(Kt)&&o(vi)})}var Hi=u(hr,2);{var zi=o=>{var p=Gm();rt(()=>Ts(p,(t(ln),_(()=>`left:${t(ln).left}px;top:${t(ln).top}px;width:${t(ln).width}px;height:${t(ln).height}px;`)))),M(o,p)};Z(Hi,o=>{t(xe)&&o(zi)})}var Ss=u(Hi,2);{var Xo=o=>{var p=Km(),h=v(p),S=v(h);Zn(S);var A=u(S,2),I=u(A,2);d(h);var H=u(h,2),L=v(H);Zn(L);var K=u(L,2),R=u(K,2);d(H),d(p),rn(S,()=>t(Pr),z=>f(Pr,z)),C("click",A,fe),C("click",I,()=>f(pn,!1)),rn(L,()=>t(di),z=>f(di,z)),C("click",K,mn),C("click",R,ie),M(o,p)};Z(Ss,o=>{t(pn)&&o(Xo)})}d(Pi),rt(()=>{Me(Pi,1,`panel editor ${dt()?"paper":""}`,"svelte-lk86dq"),js(we,"data-render-mode",t(B)),js(we,"contenteditable",i()||U()?"false":"true")}),C("mousedown",we,Jr),C("input",we,Ce),C("focusin",we,In),C("focusout",we,Oi),C("compositionstart",we,nn),C("compositionend",we,Gn),C("click",we,ue),C("keydown",we,Ar),M(e,Pi);var Yo=li(Zi);return k(),Yo}function nd(e,n){if(new.target)return mi({component:nd,...e});oi(n,!1);let i=qr(n,"showToolbar",12,!0),r=qr(n,"paper",12,!0),a=qr(n,"lockEditing",12,!1);var s={get showToolbar(){return i()},set showToolbar(m){i(m),dr()},get paper(){return r()},set paper(m){r(m),dr()},get lockEditing(){return a()},set lockEditing(m){a(m),dr()},$set:gi,$on:(m,g)=>hi(n,m,g)};return ed(e,{get showToolbar(){return i()},get paper(){return r()},get lockEditing(){return a()},$$events:{blockedit(m){bs.call(this,n,m)},blockselect(m){bs.call(this,n,m)},toolbarstate(m){bs.call(this,n,m)}}}),li(s)}var Xm=q("<button> </button>"),Ym=q('<button class="template-chip svelte-1ka5p0t"> </button>'),Qm=q('<div class="kind-grid svelte-1ka5p0t"></div> <div class="template-list svelte-1ka5p0t"></div> <textarea class="prompt-box svelte-1ka5p0t" rows="5" placeholder="输入你要绘制的内容，例如：用户登录到下单的关键流程。"></textarea> <div class="canvas-actions svelte-1ka5p0t"><button class="btn primary svelte-1ka5p0t"> </button> <button class="btn ghost svelte-1ka5p0t">插入文档</button></div> <textarea class="prompt-box mini svelte-1ka5p0t" rows="3" placeholder="二次优化，例如：改成更简洁的 5 个节点，强调异常分支。"></textarea> <button class="btn ghost svelte-1ka5p0t">AI 二次优化</button>',1),Zm=q('<textarea class="spec-editor svelte-1ka5p0t" rows="18" placeholder="可直接编辑 JSON 规范，例如：type=flow，caption=示例，data 包含 nodes/edges。"></textarea> <div class="canvas-actions svelte-1ka5p0t"><button class="btn primary svelte-1ka5p0t">应用规范</button> <button class="btn ghost svelte-1ka5p0t">复制规范</button></div>',1),th=q('<div class="empty svelte-1ka5p0t">暂无历史记录</div>'),eh=q('<button class="history-item svelte-1ka5p0t"><div class="svelte-1ka5p0t"> </div> <div class="svelte-1ka5p0t"> </div> <div class="svelte-1ka5p0t"> </div></button>'),nh=q('<div class="history-list svelte-1ka5p0t"><!></div>'),rh=q('<div class="error svelte-1ka5p0t"> </div>'),ih=q('<div class="svg-host svelte-1ka5p0t"><div class="svg-scale svelte-1ka5p0t"><!></div></div>'),sh=q('<div class="placeholder svelte-1ka5p0t"><h4 class="svelte-1ka5p0t">画布预览区</h4> <p class="svelte-1ka5p0t">左侧输入描述后点击“生成图形”，或切换到 JSON 手动编辑规范。</p></div>'),ah=q('<div class="canvas-backdrop svelte-1ka5p0t" role="button" tabindex="0" aria-label="关闭画布"><section class="canvas-shell svelte-1ka5p0t" aria-label="AI 画布系统"><header class="canvas-topbar svelte-1ka5p0t"><div class="title-wrap svelte-1ka5p0t"><h3 class="svelte-1ka5p0t">AI 画布系统</h3> <p class="svelte-1ka5p0t">同页完成生成、修改、预览、插入，支持流程图/ER 图/时序图/统计图。</p></div> <div class="top-actions svelte-1ka5p0t"><button class="btn ghost svelte-1ka5p0t">工作台</button> <button class="btn ghost svelte-1ka5p0t">JSON</button> <button class="btn ghost svelte-1ka5p0t">历史</button> <button class="btn ghost svelte-1ka5p0t">清空</button> <button class="close-btn svelte-1ka5p0t" aria-label="关闭">×</button></div></header> <div class="canvas-main svelte-1ka5p0t"><aside class="canvas-sidebar svelte-1ka5p0t"><div class="panel-title svelte-1ka5p0t"> </div> <!> <!> <!> <!></aside> <section class="canvas-stage svelte-1ka5p0t"><div class="stage-toolbar svelte-1ka5p0t"><div class="zoom-group svelte-1ka5p0t"><button class="btn ghost svelte-1ka5p0t">-</button> <span> </span> <button class="btn ghost svelte-1ka5p0t">+</button> <button class="btn ghost svelte-1ka5p0t">重置缩放</button></div> <div class="export-group svelte-1ka5p0t"><button class="btn ghost svelte-1ka5p0t">复制 SVG</button> <button class="btn ghost svelte-1ka5p0t">下载 SVG</button> <button class="btn primary svelte-1ka5p0t">插入正文</button></div></div> <div class="preview-wrap svelte-1ka5p0t"><!></div></section></div></section></div>');function rd(e,n){if(new.target)return mi({component:rd,...e});oi(n,!1);let i=qr(n,"open",12,!1),r=qr(n,"docId",12,"");const a=yc(),s=[{value:"flow",label:"流程图"},{value:"er",label:"ER 图"},{value:"sequence",label:"时序图"},{value:"timeline",label:"时间线"},{value:"bar",label:"柱状图"},{value:"line",label:"折线图"},{value:"pie",label:"饼图"}],m={flow:["需求分析 -> 方案设计 -> 开发实现 -> 测试验收 -> 上线运营","用户登录 -> 权限校验 -> 数据查询 -> 结果返回","问题发现 -> 原因定位 -> 修复验证 -> 发布回归"],er:["电商系统：用户、订单、商品、支付","教学系统：学生、课程、教师、选课记录","医院系统：患者、医生、挂号、检查报告"],sequence:["用户 -> 网关 -> 认证服务 -> 业务服务 -> 数据库","浏览器 -> 服务端 -> 缓存 -> 数据库","客户端 -> API -> 队列 -> Worker -> 存储"],timeline:["立项 -> 调研 -> 设计 -> 开发 -> 测试 -> 发布","需求冻结 -> 联调 -> 验收 -> 复盘","周一需求 -> 周三开发 -> 周五发布"],bar:["近 3 个月活跃用户对比","三种方案成本对比","各模块缺陷数统计"],line:["Q1-Q4 访问量变化趋势","模型版本准确率变化","系统响应时间趋势"],pie:["项目成本占比：人力、硬件、云资源、其他","问题类型占比：功能、性能、兼容性、体验","用户来源占比：自然、投放、活动、推荐"]};let g=W("studio"),w=W("flow"),k=W(""),b=W(""),j=W(!1),B=W(""),F=W(""),O=W(null),E=W(""),P=W(1),dt=W([]);function U(bt){return bt==="json"?"规范编辑":bt==="history"?"历史画布":"智能画布"}function lt(){a("close")}function Tt(bt){f(k,bt)}function wt(bt){const At=String(bt||"").trim().toLowerCase();return At==="er"?"er":At==="sequence"?"sequence":At==="timeline"?"timeline":At==="bar"?"bar":At==="line"?"line":At==="pie"?"pie":"flow"}function Nt(bt){if(!bt||typeof bt!="object"||Array.isArray(bt))throw new Error("图形规范不是对象");return bt}function Wt(bt){return JSON.stringify(bt,(At,ee)=>typeof ee=="string"?ee.replace(/\u0000/g,""):ee,2)}function tt(bt,At,ee,We){f(dt,[{id:Date.now(),kind:At,prompt:bt,spec:ee,svg:We,ts:Date.now()},...t(dt)].slice(0,40))}async function Et(bt,At,ee){const We=await fetch("/api/figure/render",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({spec:bt})});if(!We.ok)throw new Error(await We.text());const ge=await We.json(),en=String(ge.svg||"");f(F,en),f(O,bt),f(E,Wt(bt)),tt(At,ee,bt,en)}async function kt(bt){const At=String(bt||t(k)||"").trim();if(!r()){f(B,"文档未加载");return}if(At){f(j,!0),f(B,"");try{const ee=await fetch(`/api/doc/${r()}/diagram/generate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt:At,kind:t(w)})});if(!ee.ok)throw new Error(await ee.text());const We=await ee.json(),ge=Nt(We.spec||{});await Et(ge,At,t(w)),f(g,"studio")}catch(ee){f(B,ee instanceof Error?ee.message:"图形生成失败")}finally{f(j,!1)}}}async function Jt(){const bt=t(b).trim();if(!bt)return;if(!t(O)){await kt(bt);return}const At=JSON.stringify(t(O)).slice(0,1800);await kt(`在当前图基础上优化：${bt}
当前规范：${At}`)}async function de(){const bt=String(t(E)||"").trim();if(bt){f(j,!0),f(B,"");try{const At=Nt(JSON.parse(bt)),ee=wt(At.type);f(w,ee),await Et(At,"手动编辑规范",ee),f(g,"studio")}catch(At){f(B,At instanceof Error?At.message:"规范解析失败")}finally{f(j,!1)}}}function De(bt){f(w,bt.kind),f(k,bt.prompt),f(O,bt.spec),f(F,bt.svg),f(E,Wt(bt.spec)),f(g,"studio")}function xe(){t(O)&&a("insert",{spec:t(O)})}async function ln(){if(t(F))try{await navigator.clipboard.writeText(t(F))}catch{f(B,"复制 SVG 失败，请检查浏览器权限")}}async function Mt(){if(t(E).trim())try{await navigator.clipboard.writeText(t(E))}catch{f(B,"复制规范失败，请检查浏览器权限")}}function mt(){if(!t(F))return;const bt=new Blob([t(F)],{type:"image/svg+xml;charset=utf-8"}),At=URL.createObjectURL(bt),ee=document.createElement("a");ee.href=At,ee.download=`canvas-${Date.now()}.svg`,document.body.appendChild(ee),ee.click(),ee.remove(),URL.revokeObjectURL(At)}function jt(){f(F,""),f(O,null),f(E,""),f(b,""),f(B,""),f(P,1)}function Bt(bt){bt.key==="Escape"&&lt()}var Kt={get open(){return i()},set open(bt){i(bt),dr()},get docId(){return r()},set docId(bt){r(bt),dr()},$set:gi,$on:(bt,At)=>hi(n,bt,At)};Ds();var vn=Vs(),cn=wr(vn);{var Le=bt=>{var At=ah(),ee=v(At),We=v(ee),ge=u(v(We),2),en=v(ge),Sr=u(en,2),Ti=u(Sr,2),Ur=u(Ti,2),ne=u(Ur,2);d(ge),d(We);var Ue=u(We,2),An=v(Ue),tr=v(An),or=v(tr,!0);d(tr);var Lt=u(tr,2);{var Ri=Rt=>{var ve=Qm(),an=wr(ve);on(an,5,()=>s,Fn,(ye,je)=>{var Oe=Xm(),Je=v(Oe,!0);d(Oe),rt(()=>{Me(Oe,1,(t(w),t(je),_(()=>`kind-chip ${t(w)===t(je).value?"active":""}`)),"svelte-1ka5p0t"),D(Je,(t(je),_(()=>t(je).label)))}),C("click",Oe,()=>f(w,t(je).value)),M(ye,Oe)}),d(an);var Ze=u(an,2);on(Ze,5,()=>(t(w),_(()=>m[t(w)])),Fn,(ye,je)=>{var Oe=Ym(),Je=v(Oe,!0);d(Oe),rt(()=>D(Je,t(je))),C("click",Oe,()=>Tt(t(je))),M(ye,Oe)}),d(Ze);var Qt=u(Ze,2);hs(Qt);var qe=u(Qt,2),pe=v(qe),wn=v(pe,!0);d(pe);var zn=u(pe,2);d(qe);var Fe=u(qe,2);hs(Fe);var qt=u(Fe,2);rt((ye,je)=>{pe.disabled=ye,D(wn,t(j)?"生成中...":"生成图形"),zn.disabled=!t(O),qt.disabled=je},[()=>(t(j),t(k),_(()=>t(j)||!t(k).trim())),()=>(t(j),t(b),_(()=>t(j)||!t(b).trim()))]),rn(Qt,()=>t(k),ye=>f(k,ye)),C("click",pe,()=>kt()),C("click",zn,xe),rn(Fe,()=>t(b),ye=>f(b,ye)),C("click",qt,Jt),M(Rt,ve)};Z(Lt,Rt=>{t(g)==="studio"&&Rt(Ri)})}var X=u(Lt,2);{var ht=Rt=>{var ve=Zm(),an=wr(ve);hs(an);var Ze=u(an,2),Qt=v(Ze),qe=u(Qt,2);d(Ze),rt((pe,wn)=>{Qt.disabled=pe,qe.disabled=wn},[()=>(t(j),t(E),_(()=>t(j)||!t(E).trim())),()=>(t(E),_(()=>!t(E).trim()))]),rn(an,()=>t(E),pe=>f(E,pe)),C("click",Qt,de),C("click",qe,Mt),M(Rt,ve)};Z(X,Rt=>{t(g)==="json"&&Rt(ht)})}var Ut=u(X,2);{var Se=Rt=>{var ve=nh(),an=v(ve);{var Ze=qe=>{var pe=th();M(qe,pe)},Qt=qe=>{var pe=Vs(),wn=wr(pe);on(wn,1,()=>t(dt),Fn,(zn,Fe)=>{var qt=eh(),ye=v(qt),je=v(ye,!0);d(ye);var Oe=u(ye,2),Je=v(Oe,!0);d(Oe);var nr=u(Oe,2),yt=v(nr,!0);d(nr),d(qt),rt((re,ke)=>{D(je,re),D(Je,(t(Fe),_(()=>t(Fe).prompt||"无描述"))),D(yt,ke)},[()=>(t(Fe),_(()=>s.find(re=>re.value===t(Fe).kind)?.label||t(Fe).kind)),()=>(t(Fe),_(()=>new Date(t(Fe).ts).toLocaleString()))]),C("click",qt,()=>De(t(Fe))),M(zn,qt)}),M(qe,pe)};Z(an,qe=>{t(dt),_(()=>t(dt).length===0)?qe(Ze):qe(Qt,!1)})}d(ve),M(Rt,ve)};Z(Ut,Rt=>{t(g)==="history"&&Rt(Se)})}var vr=u(Ut,2);{var er=Rt=>{var ve=rh(),an=v(ve,!0);d(ve),rt(()=>D(an,t(B))),M(Rt,ve)};Z(vr,Rt=>{t(B)&&Rt(er)})}d(An);var On=u(An,2),_n=v(On),Re=v(_n),un=v(Re),bn=u(un,2),Ye=v(bn);d(bn);var pr=u(bn,2),ei=u(pr,2);d(Re);var sn=u(Re,2),kr=v(sn),Pn=u(kr,2),Fr=u(Pn,2);d(sn),d(_n);var Yt=u(_n,2),yn=v(Yt);{var $r=Rt=>{var ve=ih(),an=v(ve),Ze=v(an);Lp(Ze,()=>t(F)),d(an),d(ve),rt(()=>Ts(an,`transform: scale(${t(P)});`)),M(Rt,ve)},Hn=Rt=>{var ve=sh();M(Rt,ve)};Z(yn,Rt=>{t(F)?Rt($r):Rt(Hn,!1)})}d(Yt),d(On),d(Ue),d(ee),d(At),rt((Rt,ve)=>{D(or,Rt),D(Ye,`${ve??""}%`),kr.disabled=!t(F),Pn.disabled=!t(F),Fr.disabled=!t(O)},[()=>(t(g),_(()=>U(t(g)))),()=>(t(P),_(()=>Math.round(t(P)*100)))]),C("click",en,()=>f(g,"studio")),C("click",Sr,()=>f(g,"json")),C("click",Ti,()=>f(g,"history")),C("click",Ur,jt),C("click",ne,lt),C("click",un,()=>f(P,Math.max(.4,Number((t(P)-.1).toFixed(1))))),C("click",pr,()=>f(P,Math.min(2.2,Number((t(P)+.1).toFixed(1))))),C("click",ei,()=>f(P,1)),C("click",kr,ln),C("click",Pn,mt),C("click",Fr,xe),C("click",At,Tp(lt)),C("keydown",At,Bt),M(bt,At)};Z(cn,bt=>{i()&&bt(Le)})}return M(e,vn),li(Kt)}var oh=q("<div> </div>"),lh=q('<div class="toast-root svelte-1cpok13"></div>');function id(e,n){if(new.target)return mi({component:id,...e});oi(n,!1);const i=()=>Qn(tc,"$toasts",r),[r,a]=Oa();var s={$set:gi,$on:(w,k)=>hi(n,w,k)},m=lh();on(m,5,i,w=>w.id,(w,k)=>{var b=oh(),j=v(b,!0);d(b),rt(()=>{Me(b,1,`toast ${t(k),_(()=>t(k).type)??""}`,"svelte-1cpok13"),D(j,(t(k),_(()=>t(k).message)))}),M(w,b)}),d(m),M(e,m);var g=li(s);return a(),g}var ch=q('<button type="button" class="modal-backdrop svelte-ta60gp" aria-label="关闭"></button> <div class="modal svelte-ta60gp" role="dialog" aria-modal="true"><div class="modal-header svelte-ta60gp"><div class="modal-title svelte-ta60gp"> </div> <button class="btn ghost">关闭</button></div> <div class="modal-body"><!></div></div>',1);function sd(e,n){if(new.target)return mi({component:sd,...e});oi(n,!1);let i=qr(n,"open",12,!1),r=qr(n,"title",12,""),a=qr(n,"onClose",12);var s={get open(){return i()},set open(k){i(k),dr()},get title(){return r()},set title(k){r(k),dr()},get onClose(){return a()},set onClose(k){a(k),dr()},$set:gi,$on:(k,b)=>hi(n,k,b)},m=Vs(),g=wr(m);{var w=k=>{var b=ch(),j=wr(b),B=u(j,2),F=v(B),O=v(F),E=v(O,!0);d(O);var P=u(O,2);d(F);var dt=u(F,2),U=v(dt);Pf(U,n,"default",{}),d(dt),d(B),rt(()=>D(E,r())),C("click",j,function(...lt){a()?.apply(this,lt)}),C("click",P,function(...lt){a()?.apply(this,lt)}),M(k,b)};Z(g,k=>{i()&&k(w)})}return M(e,m),li(s)}var uh=q('<div class="settings-row svelte-anx9w7"><label><input type="checkbox"/> 扩展大纲</label></div> <div class="settings-row svelte-anx9w7"><label><input type="checkbox"/> 需要引用</label></div> <div class="settings-row svelte-anx9w7"><label for="targetChars">目标字数</label> <input id="targetChars" type="number" min="100" max="10000" placeholder="例如 1000" class="svelte-anx9w7"/></div> <div class="settings-row svelte-anx9w7"><label for="styleTone">风格/语气</label> <input id="styleTone" type="text" placeholder="例如：正式、简洁、适度营销" class="svelte-anx9w7"/></div> <div class="settings-row svelte-anx9w7"><label for="outputFormat">输出格式</label> <select id="outputFormat" class="svelte-anx9w7"><option>Markdown</option><option>纯文本</option></select></div> <div class="settings-section svelte-anx9w7"><div class="section-title svelte-anx9w7">高级设置（可改所有默认值）</div> <label for="formattingJson">格式 formatting</label> <textarea id="formattingJson" rows="6" class="svelte-anx9w7"></textarea> <label for="prefsJson">生成偏好 generation_prefs</label> <textarea id="prefsJson" rows="6" class="svelte-anx9w7"></textarea></div> <div class="settings-actions svelte-anx9w7"><button class="btn primary">保存</button> <button class="btn ghost">取消</button></div>',1),fh=q('<button class="btn ghost">设置</button> <!>',1);function ad(e,n){if(new.target)return mi({component:ad,...e});oi(n,!1);const i=()=>Qn(Ms,"$docId",r),[r,a]=Oa();let s=W(!1),m=W(!1),g=W(""),w=W(""),k=W(!1),b=W("markdown"),j=W(""),B=W("");async function F(){const wt=i();if(!wt)return;const Nt=await fetch(`/api/doc/${wt}`);if(!Nt.ok)return;const Wt=await Nt.json(),tt=Wt.generation_prefs||{},Et=Wt.formatting||{};f(m,!!tt.expand_outline),f(g,tt.target_chars?Number(tt.target_chars):""),f(w,String(Et.style||"")),f(k,!!tt.citations_required),f(b,String(tt.output_format||"markdown")),f(j,JSON.stringify(Et,null,2)),f(B,JSON.stringify(tt,null,2))}async function O(){const wt=i();if(!wt)return;let Nt={},Wt={};try{Nt=t(j).trim()?JSON.parse(t(j)):{},Wt=t(B).trim()?JSON.parse(t(B)):{}}catch{pt("高级设置 JSON 解析失败，请检查格式。","bad");return}const tt={generation_prefs:{...Wt,expand_outline:t(m),citations_required:t(k),output_format:t(b)},formatting:{...Nt,style:t(w)}};t(g)&&(tt.generation_prefs.target_chars=Number(t(g))),await fetch(`/api/doc/${wt}/settings`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(tt)}),pt("设置已保存","ok"),f(s,!1)}function E(){f(s,!0),F().catch(()=>{})}var P={$set:gi,$on:(wt,Nt)=>hi(n,wt,Nt)};Ds();var dt=fh(),U=wr(dt),lt=u(U,2);sd(lt,{get open(){return t(s)},title:"生成设置",onClose:()=>f(s,!1),children:(wt,Nt)=>{var Wt=uh(),tt=wr(Wt),Et=v(tt),kt=v(Et);Zn(kt),ms(),d(Et),d(tt);var Jt=u(tt,2),de=v(Jt),De=v(de);Zn(De),ms(),d(de),d(Jt);var xe=u(Jt,2),ln=u(v(xe),2);Zn(ln),d(xe);var Mt=u(xe,2),mt=u(v(Mt),2);Zn(mt),d(Mt);var jt=u(Mt,2),Bt=u(v(jt),2),Kt=v(Bt);Kt.value=Kt.__value="markdown";var vn=u(Kt);vn.value=vn.__value="plain",d(Bt),d(jt);var cn=u(jt,2),Le=u(v(cn),4);hs(Le);var bt=u(Le,4);hs(bt),d(cn);var At=u(cn,2),ee=v(At),We=u(ee,2);d(At),Ql(kt,()=>t(m),ge=>f(m,ge)),Ql(De,()=>t(k),ge=>f(k,ge)),rn(ln,()=>t(g),ge=>f(g,ge)),rn(mt,()=>t(w),ge=>f(w,ge)),$s(Bt,()=>t(b),ge=>f(b,ge)),rn(Le,()=>t(j),ge=>f(j,ge)),rn(bt,()=>t(B),ge=>f(B,ge)),C("click",ee,O),C("click",We,()=>f(s,!1)),M(wt,Wt)},$$slots:{default:!0}}),C("click",U,E),M(e,dt);var Tt=li(P);return a(),Tt}var dh=q('<div class="loading svelte-1bmythy">加载中...</div>'),vh=q('<div class="empty svelte-1bmythy">暂无文档</div>'),ph=q('<div class="doc-item svelte-1bmythy"><button class="doc-info svelte-1bmythy" type="button"><div class="doc-title svelte-1bmythy"> </div> <div class="doc-meta svelte-1bmythy"><span> </span> <span> </span></div> <div class="doc-preview svelte-1bmythy"> </div></button> <button class="delete-btn svelte-1bmythy">删除</button></div>'),mh=q('<div class="doc-list svelte-1bmythy"></div>'),hh=q('<div class="modal-backdrop svelte-1bmythy" role="button" tabindex="0" aria-label="关闭文档列表"><div class="modal-panel svelte-1bmythy" role="dialog" aria-modal="true" tabindex="-1"><div class="modal-header svelte-1bmythy"><h2 class="svelte-1bmythy">文档列表</h2> <button class="close-btn svelte-1bmythy">✕</button></div> <div class="modal-body svelte-1bmythy"><!></div></div></div>');function od(e,n){if(new.target)return mi({component:od,...e});oi(n,!1);let i=qr(n,"visible",12,!1),r=qr(n,"onSelect",12,()=>{}),a=W([]),s=W(!1);async function m(){f(s,!0);try{const O=await fetch("/api/docs/list");if(!O.ok)throw new Error("加载失败");const E=await O.json();f(a,E.docs||[])}catch{pt("加载文档列表失败","error")}finally{f(s,!1)}}function g(O){try{return new Date(O).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})}catch{return O}}function w(O,E){return(O||"").length>E?O.slice(0,E)+"...":O}async function k(O){if(confirm("确定删除此文档？"))try{await fetch(`/api/doc/${O}/delete`,{method:"POST"}),pt("已删除","ok"),await m()}catch{pt("删除失败","error")}}Fa(()=>{i()&&m()}),Hs(()=>se(i()),()=>{i()&&m()}),so();var b={get visible(){return i()},set visible(O){i(O),dr()},get onSelect(){return r()},set onSelect(O){r(O),dr()},$set:gi,$on:(O,E)=>hi(n,O,E)};Ds();var j=Vs(),B=wr(j);{var F=O=>{var E=hh(),P=v(E),dt=v(P),U=u(v(dt),2);d(dt);var lt=u(dt,2),Tt=v(lt);{var wt=tt=>{var Et=dh();M(tt,Et)},Nt=tt=>{var Et=vh();M(tt,Et)},Wt=tt=>{var Et=mh();on(Et,5,()=>t(a),Fn,(kt,Jt)=>{var de=ph(),De=v(de),xe=v(De),ln=v(xe,!0);d(xe);var Mt=u(xe,2),mt=v(Mt),jt=v(mt,!0);d(mt);var Bt=u(mt,2),Kt=v(Bt);d(Bt),d(Mt);var vn=u(Mt,2),cn=v(vn,!0);d(vn),d(De);var Le=u(De,2);d(de),rt((bt,At)=>{D(ln,(t(Jt),_(()=>t(Jt).title||"自动生成文档"))),D(jt,bt),D(Kt,`${t(Jt),_(()=>t(Jt).char_count||0)??""} 字`),D(cn,At)},[()=>(t(Jt),_(()=>g(t(Jt).updated_at))),()=>(t(Jt),_(()=>w(t(Jt).text,80)))]),C("click",De,()=>r()(t(Jt).doc_id)),C("click",Le,()=>k(t(Jt).doc_id)),M(kt,de)}),d(Et),M(tt,Et)};Z(Tt,tt=>{t(s)?tt(wt):(t(a),_(()=>t(a).length===0)?tt(Nt,1):tt(Wt,!1))})}d(lt),d(P),d(E),C("click",U,()=>i(!1)),C("click",P,ua(function(tt){bs.call(this,n,tt)})),C("keydown",P,ua(function(tt){bs.call(this,n,tt)})),C("click",E,()=>i(!1)),C("keydown",E,tt=>{(tt.key==="Enter"||tt.key===" "||tt.key==="Escape")&&(tt.preventDefault(),i(!1))}),M(O,E)};Z(B,O=>{i()&&O(F)})}return M(e,j),li(b)}var gh=q('<div class="skeleton-wrapper svelte-1bn1hqj"><div class="skeleton-header svelte-1bn1hqj"><div class="skeleton-line skeleton-title svelte-1bn1hqj"></div> <div class="skeleton-line skeleton-subtitle svelte-1bn1hqj"></div></div> <div class="skeleton-content svelte-1bn1hqj"><div class="skeleton-line svelte-1bn1hqj"></div> <div class="skeleton-line svelte-1bn1hqj"></div> <div class="skeleton-line short svelte-1bn1hqj"></div> <div class="skeleton-line svelte-1bn1hqj"></div> <div class="skeleton-line svelte-1bn1hqj"></div> <div class="skeleton-line short svelte-1bn1hqj"></div></div></div>');function ld(e,n){if(new.target)return mi({component:ld,...e});oi(n,!1);var i={$set:gi,$on:(a,s)=>hi(n,a,s)},r=gh();return M(e,r),li(i)}var _h=q('<div class="progress-bar indeterminate svelte-1qjgclg"></div>'),bh=q('<div class="progress-bar svelte-1qjgclg"></div>'),yh=q('<div class="progress-container svelte-1qjgclg"><!></div>');function cd(e,n){if(new.target)return mi({component:cd,...e});oi(n,!1);let i=qr(n,"progress",12,0),r=qr(n,"indeterminate",12,!1);var a={get progress(){return i()},set progress(k){i(k),dr()},get indeterminate(){return r()},set indeterminate(k){r(k),dr()},$set:gi,$on:(k,b)=>hi(n,k,b)},s=yh(),m=v(s);{var g=k=>{var b=_h();M(k,b)},w=k=>{var b=bh();rt(j=>Ts(b,`width: ${j??""}%`),[()=>(se(i()),_(()=>Math.min(100,Math.max(0,i()))))]),M(k,b)};Z(m,k=>{r()?k(g):k(w,!1)})}return d(s),M(e,s),li(a)}var wh=q('<div class="error-boundary svelte-1k3aqik"><div class="error-icon svelte-1k3aqik">⚠️</div> <h2 class="svelte-1k3aqik">抱歉，出现了一些问题</h2> <p class="error-message svelte-1k3aqik"> </p> <div class="error-suggestion svelte-1k3aqik">建议： <ul class="svelte-1k3aqik"><li class="svelte-1k3aqik">刷新页面重试</li> <li class="svelte-1k3aqik">检查网络连接</li> <li class="svelte-1k3aqik">清除浏览器缓存</li> <li class="svelte-1k3aqik">如问题持续，请联系技术支持</li></ul></div> <button class="btn-retry svelte-1k3aqik">重新加载</button></div>');function ud(e,n){if(new.target)return mi({component:ud,...e});oi(n,!1);let i=qr(n,"fallback",12,"出现错误，请刷新页面重试"),r=W(!1),a=W("");Fa(()=>{const b=j=>{f(r,!0),f(a,j.error?.message||j.message||i()),console.error("捕获到错误:",j.error)};return window.addEventListener("error",b),()=>{window.removeEventListener("error",b)}});var s={get fallback(){return i()},set fallback(b){i(b),dr()},$set:gi,$on:(b,j)=>hi(n,b,j)};Ds();var m=Vs(),g=wr(m);{var w=b=>{var j=wh(),B=u(v(j),4),F=v(B,!0);d(B);var O=u(B,4);d(j),rt(()=>D(F,t(a))),C("click",O,()=>window.location.reload()),M(b,j)},k=b=>{var j=Vs(),B=wr(j);Pf(B,n,"default",{}),M(b,j)};Z(g,b=>{t(r)?b(w):b(k,!1)})}return M(e,m),li(s)}var xh=q('<div class="verify-debug-controls svelte-13e776w"><label for="verify-debug-level" class="svelte-13e776w">debug level</label> <select id="verify-debug-level" class="svelte-13e776w"><option>safe (masked)</option><option>strict (metrics only)</option><option>full (raw, rate limited)</option></select></div>'),Sh=q('<div class="verify-summary svelte-13e776w"> </div>'),kh=q('<span class="verify-debug-observe svelte-13e776w"> </span>'),$h=q('<span class="verify-debug-flag svelte-13e776w">full -> safe (rate limited)</span>'),Th=q('<span class="verify-debug-trend svelte-13e776w"> </span>'),jh=q('<div class="verify-debug-history-item svelte-13e776w"><span class="history-time svelte-13e776w"> </span> <span> </span> <span> </span> <span class="history-meta svelte-13e776w"> </span> <span class="history-meta svelte-13e776w"> </span> <span class="history-meta svelte-13e776w"> </span> <span class="history-meta svelte-13e776w"> </span></div>'),Eh=q('<div class="verify-debug-history svelte-13e776w"><div class="verify-debug-history-title svelte-13e776w"> </div> <div class="verify-debug-history-list svelte-13e776w"></div></div>'),Ah=q('<div class="verify-debug-summary svelte-13e776w"><span> </span> <span class="verify-debug-metrics svelte-13e776w"> </span> <!> <span class="verify-debug-health svelte-13e776w"><span> </span> <span> </span></span> <!> <!> <button class="btn-debug-clear svelte-13e776w">清空历史</button> <button class="btn-debug-copy svelte-13e776w">复制诊断 JSON</button></div> <!>',1),Ch=q('<p class="empty svelte-13e776w">加载中...</p>'),Ih=q('<p class="empty svelte-13e776w">暂无引用</p>'),Nh=q('<span class="source svelte-13e776w"> </span>'),Mh=q('<span class="hint svelte-13e776w"> </span>'),Bh=q('<span class="hint svelte-13e776w"> </span>'),Dh=q('<span class="hint svelte-13e776w"> </span>'),Lh=q('<span class="hint svelte-13e776w"> </span>'),Rh=q('<div class="debug-line svelte-13e776w"> </div>'),qh=q('<div class="debug-line svelte-13e776w"> </div>'),Fh=q('<div class="debug-line svelte-13e776w"> </div>'),Oh=q('<details class="verify-debug-item svelte-13e776w"><summary class="svelte-13e776w">debug details</summary> <div class="debug-line svelte-13e776w"> </div> <!> <!> <div class="debug-line svelte-13e776w"> </div> <!> <div class="debug-line svelte-13e776w"> </div></details>'),Ph=q('<div class="verify-info svelte-13e776w"><span> </span> <!> <!> <!> <!> <!></div>'),Hh=q('<div class="citation-item svelte-13e776w"><div class="citation-info svelte-13e776w"><strong class="svelte-13e776w"> </strong> <span class="svelte-13e776w"> </span> <!> <!></div> <div class="citation-actions svelte-13e776w"><button class="btn-copy svelte-13e776w">复制</button> <button class="btn-delete svelte-13e776w">删除</button></div></div>'),zh=q('<div class="citation-list svelte-13e776w"></div>'),Wh=q('<div class="modal-backdrop svelte-13e776w" role="button" tabindex="0" aria-label="关闭引用管理"><div class="modal svelte-13e776w" role="dialog" aria-modal="true" tabindex="-1"><div class="modal-header svelte-13e776w"><h2 class="svelte-13e776w">引用管理</h2> <button class="close-btn svelte-13e776w">×</button></div> <div class="modal-body svelte-13e776w"><div class="add-section svelte-13e776w"><h3 class="svelte-13e776w">添加引用</h3> <div class="form-grid svelte-13e776w"><input type="text" placeholder="引用 ID（如 smith2023）" class="svelte-13e776w"/> <input type="text" placeholder="作者*" class="svelte-13e776w"/> <input type="text" placeholder="标题*" class="svelte-13e776w"/> <input type="text" placeholder="年份" class="svelte-13e776w"/> <input type="text" placeholder="来源（期刊/会议/URL）" class="full-width svelte-13e776w"/></div> <button class="btn-add svelte-13e776w">添加引用</button></div> <div class="verify-section svelte-13e776w"><h3 class="svelte-13e776w">核验真实性</h3> <div class="verify-row svelte-13e776w"><button class="btn-verify svelte-13e776w"><!></button> <!> <!> <!></div></div> <div class="export-section svelte-13e776w"><h3 class="svelte-13e776w">导出参考文献</h3> <div class="export-btns svelte-13e776w"><button class="btn-export svelte-13e776w">APA</button> <button class="btn-export svelte-13e776w">MLA</button> <button class="btn-export svelte-13e776w">GB/T 7714</button></div></div> <div class="list-section svelte-13e776w"><h3 class="svelte-13e776w"> </h3> <!></div></div></div></div>');function fd(e,n){if(new.target)return mi({component:fd,...e});oi(n,!1);const i=()=>Qn(Ms,"$docId",r),[r,a]=Oa();let s=qr(n,"visible",12,!1);const m=!1,g=8,w=.55,k=.08;let b=W([]),j=W(!1),B=W(!1),F=W({}),O=W(null),E=W(null),P=W([]),dt=0,U=W("safe"),lt=W(""),Tt=null,wt=W({id:"",author:"",title:"",year:"",source:""});function Nt(X){return Array.isArray(X)?X.filter(ht=>ht&&typeof ht=="object").map(ht=>{const Ut=ht;return{id:String(Ut.id||"").trim(),author:String(Ut.author||"").trim(),title:String(Ut.title||"").trim(),year:String(Ut.year||"").trim(),source:String(Ut.source||"").trim()}}).filter(ht=>ht.id&&ht.title):[]}function Wt(X){const ht=String(X||"").trim().toLowerCase();return ht==="full"?"full":ht==="strict"?"strict":"safe"}function tt(X){const ht=Number(X);return Number.isFinite(ht)?Math.max(0,Math.round(ht)):0}function Et(X){const ht=Number(X);return Number.isFinite(ht)?Math.max(0,ht):0}function kt(X){return tt(X.hit)+tt(X.miss)}function Jt(X){const ht=kt(X);return ht<=0?0:tt(X.hit)/ht}function de(X){const ht=tt(X.set);return ht<=0?0:tt(X.evicted)/ht}function De(X){return`${(Math.max(0,Math.min(1,Number(X)||0))*100).toFixed(1)}%`}function xe(){return new Date().toLocaleTimeString("zh-CN",{hour12:!1})}function ln(X){const ht={id:`${Date.now()}-${dt++}`,at_label:xe(),level:X.level,workers:tt(X.request.workers),elapsed_ms:Number(X.elapsed_ms||0),cache_size:tt(X.cache.size),cache_max:tt(X.cache.max_entries),hit_rate:Jt(X.cache),evict_rate:de(X.cache),sampled_output:tt(X.sampling.output_items),sampled_input:tt(X.sampling.input_items)};f(P,[...t(P),ht].slice(-g))}function Mt(X){return X.length?X.reduce((ht,Ut)=>ht+(Number.isFinite(Ut)?Ut:0),0)/X.length:0}function mt(X=5){const ht=Math.max(1,tt(X));return t(P).slice(-ht)}function jt(X=5){return Mt(mt(X).map(ht=>Number(ht.hit_rate||0)))}function Bt(X=5){return Mt(mt(X).map(ht=>Number(ht.evict_rate||0)))}function Kt(X=5){return Mt(mt(X).map(ht=>Number(ht.elapsed_ms||0)))}function vn(){t(P).length&&(f(P,[]),pt("已清空调试历史","ok"))}async function cn(){const X=i();if(X){f(j,!0);try{const ht=await fetch(`/api/doc/${X}/citations`);if(!ht.ok)throw new Error(await ht.text());const Ut=await ht.json();f(b,Nt(Ut?.items)),f(F,{}),f(O,null),f(E,null),f(P,[])}catch(ht){console.error("Failed to load citations",ht),pt("加载引用失败","bad")}finally{f(j,!1)}}}async function Le(){const X=i();if(!X)return;const ht=await fetch(`/api/doc/${X}/citations`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({items:t(b)})});if(!ht.ok)throw new Error(await ht.text())}function bt(){Tt&&clearTimeout(Tt),Tt=setTimeout(()=>{Le().catch(X=>{console.error("Failed to save citations",X),pt("保存引用失败","bad")})},300)}function At(){if(!t(wt).id||!t(wt).author||!t(wt).title){pt("请填写必填项：ID、作者、标题","bad");return}if(t(b).some(X=>X.id===t(wt).id)){pt("引用 ID 已存在","bad");return}f(b,[...t(b),{...t(wt)}]),bt(),f(wt,{id:"",author:"",title:"",year:"",source:""}),pt("已添加引用","ok")}function ee(X){f(b,t(b).filter(Ut=>Ut.id!==X));const ht={...t(F)};if(delete ht[X],f(F,ht),t(E)&&t(E).items[X]){const Ut={...t(E).items};delete Ut[X],f(E,{...t(E),items:Ut})}bt(),pt("已删除引用","ok")}async function We(X){try{await navigator.clipboard.writeText(`[@${X}]`),pt("已复制引用标记","ok")}catch{pt("复制失败，请手动复制","bad")}}function ge(X,ht){return ht==="apa"?`${X.author} (${X.year}). ${X.title}. ${X.source}.`:ht==="mla"?`${X.author}. "${X.title}." ${X.source}, ${X.year}.`:`${X.author}. ${X.title}[J]. ${X.source}, ${X.year}.`}function en(X){const ht=t(b).map(er=>ge(er,X)),Ut=new Blob([ht.join(`

`)],{type:"text/plain"}),Se=URL.createObjectURL(Ut),vr=document.createElement("a");vr.href=Se,vr.download=`references_${X}.txt`,vr.click(),URL.revokeObjectURL(Se),pt(`已导出 ${X.toUpperCase()} 参考文献`,"ok")}function Sr(){if(!t(E))return null;const X=t(b).map(Ut=>({id:Ut.id,verify:t(F)[Ut.id]||null,debug:t(E)?.items?.[Ut.id]||null})),ht=t(P).slice().reverse();return{generated_at:new Date().toISOString(),doc_id:i(),debug_level_selected:t(U),summary:t(O)||null,debug:t(E),debug_history_limit:g,debug_history:ht,debug_history_stats:{sample_size:mt(5).length,avg_hit_rate:jt(5),avg_evict_rate:Bt(5),avg_elapsed_ms:Kt(5)},rows:X}}async function Ti(){if(!m||!t(E))return;const X=Sr();if(X)try{await navigator.clipboard.writeText(JSON.stringify(X,null,2)),pt("已复制核验诊断 JSON","ok")}catch{pt("复制诊断 JSON 失败","bad")}}function Ur(X){return X==="verified"?"ok":X==="possible"?"warn":X==="error"?"err":"miss"}function ne(X){return X==="verified"?"已核验":X==="possible"?"疑似匹配":X==="error"?"核验失败":"未命中"}async function Ue(){const X=i();if(X){if(!t(b).length){pt("暂无可核验的引用","info");return}f(B,!0);try{const ht={items:t(b),persist:!0,debug:m};m&&(ht.debug_level=t(U));const Ut=await fetch(`/api/doc/${X}/citations/verify`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(ht)});if(!Ut.ok)throw new Error(await Ut.text());const Se=await Ut.json(),vr=Array.isArray(Se?.items)?Se.items:[],er={};for(const Re of vr){if(!Re||typeof Re!="object")continue;const un=Re,bn=String(un.id||"").trim();bn&&(er[bn]={id:bn,status:String(un.status||"not_found")||"not_found",provider:String(un.provider||"").trim(),score:Number(un.score||0),matched_title:String(un.matched_title||"").trim(),matched_year:String(un.matched_year||"").trim(),matched_source:String(un.matched_source||"").trim(),reason:String(un.reason||"").trim()})}f(F,er);const On=Se?.summary||{};if(f(O,{total:Number(On.total||0),verified:Number(On.verified||0),possible:Number(On.possible||0),not_found:Number(On.not_found||0),error:Number(On.error||0)}),m&&Se&&typeof Se=="object"&&Se.debug&&typeof Se.debug=="object"){const Re=Se.debug,un=Re.request,bn=un&&typeof un=="object"?un:{},Ye=Wt(Re.requested_level),pr=Wt(Re.level),ei=Re.cache,sn=ei&&typeof ei=="object"?ei:{},kr={size:tt(sn.size),ttl_s:Number(sn.ttl_s||0),max_entries:tt(sn.max_entries),hit:tt(sn.hit),miss:tt(sn.miss),set:tt(sn.set),expired:tt(sn.expired),evicted:tt(sn.evicted)},Pn=Re.sampling,Fr=Pn&&typeof Pn=="object"?Pn:{},Yt=Re.sanitized,yn=Re.observe,$r=yn&&typeof yn=="object"?yn:null;let Hn=null;if($r){const Ze=$r.request,Qt=Ze&&typeof Ze=="object"?Ze:{},qe=$r.window,pe=qe&&typeof qe=="object"?qe:{},wn=pe.elapsed_ms,zn=wn&&typeof wn=="object"?wn:{},Fe=pe.items,qt=Fe&&typeof Fe=="object"?Fe:{},ye=pe.workers,je=ye&&typeof ye=="object"?ye:{},Oe=pe.errors,Je=Oe&&typeof Oe=="object"?Oe:{},nr=pe.cache_delta,yt=nr&&typeof nr=="object"?nr:{},re=Qt.cache_delta,ke=re&&typeof re=="object"?re:{};Hn={request:{elapsed_ms:Et(Qt.elapsed_ms),item_count:tt(Qt.item_count),worker_count:tt(Qt.worker_count),error_count:tt(Qt.error_count),cache_delta:{hit:tt(ke.hit),miss:tt(ke.miss),set:tt(ke.set),expired:tt(ke.expired),evicted:tt(ke.evicted),hit_rate:Et(ke.hit_rate)}},window:{window_s:Et(pe.window_s),max_runs:tt(pe.max_runs),runs:tt(pe.runs),elapsed_ms:{avg:Et(zn.avg),p50:Et(zn.p50),p95:Et(zn.p95),max:Et(zn.max)},items:{total:tt(qt.total),avg:Et(qt.avg),p50:Et(qt.p50),p95:Et(qt.p95),max:Et(qt.max)},workers:{avg:Et(je.avg),max:Et(je.max)},errors:{total:tt(Je.total),rate_per_run:Et(Je.rate_per_run)},cache_delta:{hit:tt(yt.hit),miss:tt(yt.miss),set:tt(yt.set),expired:tt(yt.expired),evicted:tt(yt.evicted),hit_rate:Et(yt.hit_rate)}}}}const Rt={},ve=Array.isArray(Re.items)?Re.items:[];for(const Ze of ve){if(!Ze||typeof Ze!="object")continue;const Qt=Ze,qe=String(Qt.id||"").trim();if(!qe)continue;const pe=Qt.providers,wn=pe&&typeof pe=="object"?pe:{},zn={};for(const[Fe,qt]of Object.entries(wn))zn[String(Fe)]=Number(qt||0);Rt[qe]={id:qe,cache_hit:!!Qt.cache_hit,query:String(Qt.query||"").trim(),providers:zn,errors:Array.isArray(Qt.errors)?Qt.errors.map(Fe=>String(Fe||"").trim()).filter(Boolean):[],picked_provider:String(Qt.picked_provider||"").trim(),picked_title_score:Number(Qt.picked_title_score||0),picked_year_score:Number(Qt.picked_year_score||0),picked_total_score:Number(Qt.picked_total_score||0),elapsed_ms:Number(Qt.elapsed_ms||0)}}const an={request:{persist:!!bn.persist,debug:!!bn.debug,input_count:tt(bn.input_count),workers:tt(bn.workers)},requested_level:Ye,level:pr,sanitized:typeof Yt=="boolean"?Yt:pr!=="full",rate_limited_full:!!Re.rate_limited_full,cache:kr,observe:Hn,sampling:{input_items:Number(Fr.input_items||ve.length),output_items:Number(Fr.output_items||ve.length),limit:Number(Fr.limit||0),truncated:!!Fr.truncated},elapsed_ms:Number(Re.elapsed_ms||0),items:Rt};f(E,an),ln(an),Ye==="full"&&pr!=="full"&&pt("debug full 已被限流降级为 safe","info")}else f(E,null);const _n=Nt(Se?.updated_items);_n.length&&f(b,_n),pt("引用核验完成","ok")}catch(ht){console.error("Failed to verify citations",ht),pt("引用核验失败","bad")}finally{f(B,!1)}}}Fa(()=>{s()&&cn()}),Hs(()=>(se(s()),i(),t(lt)),()=>{if(s()){const X=i();X&&X!==t(lt)&&(f(lt,X),cn())}}),so();var An={get visible(){return s()},set visible(X){s(X),dr()},$set:gi,$on:(X,ht)=>hi(n,X,ht)};Ds();var tr=Vs(),or=wr(tr);{var Lt=X=>{var ht=Wh(),Ut=v(ht),Se=v(Ut),vr=u(v(Se),2);d(Se);var er=u(Se,2),On=v(er),_n=u(v(On),2),Re=v(_n);Zn(Re);var un=u(Re,2);Zn(un);var bn=u(un,2);Zn(bn);var Ye=u(bn,2);Zn(Ye);var pr=u(Ye,2);Zn(pr),d(_n);var ei=u(_n,2);d(On);var sn=u(On,2),kr=u(v(sn),2),Pn=v(kr),Fr=v(Pn);{var Yt=yt=>{var re=es("核验中...");M(yt,re)},yn=yt=>{var re=es("核验引用");M(yt,re)};Z(Fr,yt=>{t(B)?yt(Yt):yt(yn,!1)})}d(Pn);var $r=u(Pn,2);{var Hn=yt=>{var re=xh(),ke=u(v(re),2),le=v(ke);le.value=le.__value="safe";var ce=u(le);ce.value=ce.__value="strict";var Ht=u(ce);Ht.value=Ht.__value="full",d(ke),d(re),rt(()=>ke.disabled=t(B)),$s(ke,()=>t(U),Ee=>f(U,Ee)),M(yt,re)};Z($r,yt=>{m&&yt(Hn)})}var Rt=u($r,2);{var ve=yt=>{var re=Sh(),ke=v(re);d(re),rt(()=>D(ke,`总计 ${t(O),_(()=>t(O).total)??""} · 已核验 ${t(O),_(()=>t(O).verified)??""} · 疑似 ${t(O),_(()=>t(O).possible)??""} · 未命中 ${t(O),_(()=>t(O).not_found)??""} · 异常 ${t(O),_(()=>t(O).error)??""}`)),M(yt,re)};Z(Rt,yt=>{t(O)&&yt(ve)})}var an=u(Rt,2);{var Ze=yt=>{var re=Ah(),ke=wr(re),le=v(ke),ce=v(le);d(le);var Ht=u(le,2),Ee=v(Ht);d(Ht);var Or=u(Ht,2);{var zt=xn=>{var Pe=kh(),Un=v(Pe);d(Pe),rt((ue,Sn,Jn,_e,jr)=>D(Un,`window ${t(E),_(()=>t(E).observe.window.runs)??""}/${t(E),_(()=>t(E).observe.window.max_runs||"-")??""} · p50/p95 ${ue??""}/${Sn??""}ms · avg items ${Jn??""} · avg workers ${_e??""} · hitΔ ${jr??""}`),[()=>(t(E),_(()=>t(E).observe.window.elapsed_ms.p50.toFixed(1))),()=>(t(E),_(()=>t(E).observe.window.elapsed_ms.p95.toFixed(1))),()=>(t(E),_(()=>t(E).observe.window.items.avg.toFixed(1))),()=>(t(E),_(()=>t(E).observe.window.workers.avg.toFixed(1))),()=>(t(E),_(()=>De(t(E).observe.window.cache_delta.hit_rate)))]),M(xn,Pe)};Z(Or,xn=>{t(E),_(()=>t(E).observe)&&xn(zt)})}var Cn=u(Or,2),Ae=v(Cn),Wn=v(Ae);d(Ae);var Tr=u(Ae,2),ci=v(Tr);d(Tr),d(Cn);var ji=u(Cn,2);{var Ei=xn=>{var Pe=$h();M(xn,Pe)};Z(ji,xn=>{t(E),_(()=>t(E).rate_limited_full)&&xn(Ei)})}var ni=u(ji,2);{var qi=xn=>{var Pe=Th(),Un=v(Pe);d(Pe),rt((ue,Sn,Jn)=>D(Un,`avg(5) hit ${ue??""} · evict ${Sn??""} · elapsed ${Jn??""}ms`),[()=>_(()=>De(jt(5))),()=>_(()=>De(Bt(5))),()=>_(()=>Kt(5).toFixed(1))]),M(xn,Pe)};Z(ni,xn=>{t(P),_(()=>t(P).length>0)&&xn(qi)})}var ui=u(ni,2),Qe=u(ui,2);d(ke);var rr=u(ke,2);{var Jr=xn=>{var Pe=Eh(),Un=v(Pe),ue=v(Un);d(Un);var Sn=u(Un,2);on(Sn,5,()=>(t(P),_(()=>t(P).slice().reverse())),Jn=>Jn.id,(Jn,_e)=>{var jr=jh(),Zt=v(jr),Fi=v(Zt,!0);d(Zt);var In=u(Zt,2),Oi=v(In);d(In);var Ce=u(In,2),nn=v(Ce);d(Ce);var Gn=u(Ce,2),kn=v(Gn);d(Gn);var Ai=u(Gn,2),cs=v(Ai);d(Ai);var Gr=u(Ai,2),Yi=v(Gr);d(Gr);var Rn=u(Gr,2),Er=v(Rn);d(Rn),d(jr),rt((Qi,fi,Ci)=>{D(Fi,(t(_e),_(()=>t(_e).at_label))),Me(In,1,(t(_e),_(()=>"history-chip "+(t(_e).hit_rate<w?"warn":"ok"))),"svelte-13e776w"),D(Oi,`hit ${Qi??""}`),Me(Ce,1,(t(_e),_(()=>"history-chip "+(t(_e).evict_rate>k?"warn":"ok"))),"svelte-13e776w"),D(nn,`evict ${fi??""}`),D(kn,`w${t(_e),_(()=>t(_e).workers)??""}`),D(cs,`cache ${t(_e),_(()=>t(_e).cache_size)??""}/${t(_e),_(()=>t(_e).cache_max||"-")??""}`),D(Yi,`sample ${t(_e),_(()=>t(_e).sampled_output)??""}/${t(_e),_(()=>t(_e).sampled_input)??""}`),D(Er,`${Ci??""}ms`)},[()=>(t(_e),_(()=>De(t(_e).hit_rate))),()=>(t(_e),_(()=>De(t(_e).evict_rate))),()=>(t(_e),_(()=>t(_e).elapsed_ms.toFixed(1)))]),M(Jn,jr)}),d(Sn),d(Pe),rt(()=>D(ue,`recent verify runs (${t(P),_(()=>t(P).length)??""}/8)`)),M(xn,Pe)};Z(rr,xn=>{t(P),_(()=>t(P).length>0)&&xn(Jr)})}rt((xn,Pe,Un,ue,Sn,Jn,_e,jr,Zt)=>{D(ce,`Debug · req ${t(E),_(()=>t(E).requested_level)??""} · active ${t(E),_(()=>t(E).level)??""} · workers ${t(E),_(()=>t(E).request.workers)??""} · sampled ${t(E),_(()=>t(E).sampling.output_items)??""}/${t(E),_(()=>t(E).sampling.input_items)??""} · elapsed ${xn??""}ms`),D(Ee,`cache ${t(E),_(()=>t(E).cache.size)??""}/${t(E),_(()=>t(E).cache.max_entries||"-")??""} · ttl ${Pe??""}s · hit ${t(E),_(()=>t(E).cache.hit)??""}/${Un??""} (${ue??""}) · evict ${t(E),_(()=>t(E).cache.evicted)??""}/${t(E),_(()=>t(E).cache.set)??""} (${Sn??""}) · expired ${t(E),_(()=>t(E).cache.expired)??""}`),Me(Ae,1,Jn,"svelte-13e776w"),D(Wn,`hit ${_e??""}`),Me(Tr,1,jr,"svelte-13e776w"),D(ci,`evict ${Zt??""}`),ui.disabled=(t(P),_(()=>t(P).length===0))},[()=>(t(E),_(()=>t(E).elapsed_ms.toFixed(1))),()=>(t(E),_(()=>t(E).cache.ttl_s.toFixed(0))),()=>(t(E),_(()=>kt(t(E).cache))),()=>(t(E),_(()=>De(Jt(t(E).cache)))),()=>(t(E),_(()=>De(de(t(E).cache)))),()=>(t(E),_(()=>"verify-debug-chip "+(Jt(t(E).cache)<w?"warn":"ok"))),()=>(t(E),_(()=>De(Jt(t(E).cache)))),()=>(t(E),_(()=>"verify-debug-chip "+(de(t(E).cache)>k?"warn":"ok"))),()=>(t(E),_(()=>De(de(t(E).cache))))]),C("click",ui,vn),C("click",Qe,Ti),M(yt,re)};Z(an,yt=>{m&&t(E)&&yt(Ze)})}d(kr),d(sn);var Qt=u(sn,2),qe=u(v(Qt),2),pe=v(qe),wn=u(pe,2),zn=u(wn,2);d(qe),d(Qt);var Fe=u(Qt,2),qt=v(Fe),ye=v(qt);d(qt);var je=u(qt,2);{var Oe=yt=>{var re=Ch();M(yt,re)},Je=yt=>{var re=Ih();M(yt,re)},nr=yt=>{var re=zh();on(re,5,()=>t(b),Fn,(ke,le)=>{const ce=Na(()=>(t(F),t(le),_(()=>t(F)[t(le).id]))),Ht=Na(()=>(t(E),t(le),_(()=>t(E)?.items?.[t(le).id])));var Ee=Hh(),Or=v(Ee),zt=v(Or),Cn=v(zt);d(zt);var Ae=u(zt,2),Wn=v(Ae);d(Ae);var Tr=u(Ae,2);{var ci=Qe=>{var rr=Nh(),Jr=v(rr,!0);d(rr),rt(()=>D(Jr,(t(le),_(()=>t(le).source)))),M(Qe,rr)};Z(Tr,Qe=>{t(le),_(()=>t(le).source)&&Qe(ci)})}var ji=u(Tr,2);{var Ei=Qe=>{var rr=Ph(),Jr=v(rr),xn=v(Jr,!0);d(Jr);var Pe=u(Jr,2);{var Un=Ce=>{var nn=Mh(),Gn=v(nn);d(nn),rt(()=>D(Gn,`来源：${se(t(ce)),_(()=>t(ce).provider)??""}`)),M(Ce,nn)};Z(Pe,Ce=>{se(t(ce)),_(()=>t(ce).provider)&&Ce(Un)})}var ue=u(Pe,2);{var Sn=Ce=>{var nn=Bh(),Gn=v(nn);d(nn),rt(kn=>D(Gn,`相似度：${kn??""}`),[()=>(se(t(ce)),_(()=>Number(t(ce).score||0).toFixed(2)))]),M(Ce,nn)},Jn=$a(()=>(se(t(ce)),_(()=>Number(t(ce).score||0)>0)));Z(ue,Ce=>{t(Jn)&&Ce(Sn)})}var _e=u(ue,2);{var jr=Ce=>{var nn=Dh(),Gn=v(nn);d(nn),rt(()=>D(Gn,`匹配标题：${se(t(ce)),_(()=>t(ce).matched_title)??""}`)),M(Ce,nn)};Z(_e,Ce=>{se(t(ce)),_(()=>t(ce).matched_title)&&Ce(jr)})}var Zt=u(_e,2);{var Fi=Ce=>{var nn=Lh(),Gn=v(nn);d(nn),rt(()=>D(Gn,`匹配年份：${se(t(ce)),_(()=>t(ce).matched_year)??""}`)),M(Ce,nn)};Z(Zt,Ce=>{se(t(ce)),_(()=>t(ce).matched_year)&&Ce(Fi)})}var In=u(Zt,2);{var Oi=Ce=>{var nn=Oh(),Gn=u(v(nn),2),kn=v(Gn);d(Gn);var Ai=u(Gn,2);{var cs=Ar=>{var pn=Rh(),Pr=v(pn);d(pn),rt(()=>D(Pr,`query: ${se(t(Ht)),_(()=>t(Ht).query)??""}`)),M(Ar,pn)};Z(Ai,Ar=>{se(t(Ht)),_(()=>t(Ht).query)&&Ar(cs)})}var Gr=u(Ai,2);{var Yi=Ar=>{var pn=qh(),Pr=v(pn);d(pn),rt((di,Ii,Ni)=>D(Pr,`picked: ${se(t(Ht)),_(()=>t(Ht).picked_provider)??""} (total ${di??""}, title ${Ii??""}, year ${Ni??""})`),[()=>(se(t(Ht)),_(()=>t(Ht).picked_total_score.toFixed(3))),()=>(se(t(Ht)),_(()=>t(Ht).picked_title_score.toFixed(3))),()=>(se(t(Ht)),_(()=>t(Ht).picked_year_score.toFixed(3)))]),M(Ar,pn)};Z(Gr,Ar=>{se(t(Ht)),_(()=>t(Ht).picked_provider)&&Ar(Yi)})}var Rn=u(Gr,2),Er=v(Rn);d(Rn);var Qi=u(Rn,2);{var fi=Ar=>{var pn=Fh(),Pr=v(pn);d(pn),rt(di=>D(Pr,`errors: ${di??""}`),[()=>(se(t(Ht)),_(()=>t(Ht).errors.join(" | ")))]),M(Ar,pn)};Z(Qi,Ar=>{se(t(Ht)),_(()=>t(Ht).errors.length>0)&&Ar(fi)})}var Ci=u(Qi,2),te=v(Ci);d(Ci),d(nn),rt((Ar,pn)=>{D(kn,`cache_hit: ${se(t(Ht)),_(()=>t(Ht).cache_hit?"true":"false")??""}`),D(Er,`providers: ${Ar??""}`),D(te,`elapsed: ${pn??""}ms`)},[()=>(se(t(Ht)),_(()=>JSON.stringify(t(Ht).providers))),()=>(se(t(Ht)),_(()=>t(Ht).elapsed_ms.toFixed(2)))]),M(Ce,nn)};Z(In,Ce=>{m&&t(Ht)&&Ce(Oi)})}d(rr),rt((Ce,nn)=>{Me(Jr,1,Ce,"svelte-13e776w"),D(xn,nn)},[()=>(se(t(ce)),_(()=>"status "+Ur(t(ce).status))),()=>(se(t(ce)),_(()=>ne(t(ce).status)))]),M(Qe,rr)};Z(ji,Qe=>{t(ce)&&Qe(Ei)})}d(Or);var ni=u(Or,2),qi=v(ni),ui=u(qi,2);d(ni),d(Ee),rt(()=>{D(Cn,`[@${t(le),_(()=>t(le).id)??""}]`),D(Wn,`${t(le),_(()=>t(le).author)??""} (${t(le),_(()=>t(le).year)??""}). ${t(le),_(()=>t(le).title)??""}`)}),C("click",qi,()=>We(t(le).id)),C("click",ui,()=>ee(t(le).id)),M(ke,Ee)}),d(re),M(yt,re)};Z(je,yt=>{t(j)?yt(Oe):(t(b),_(()=>t(b).length===0)?yt(Je,1):yt(nr,!1))})}d(Fe),d(er),d(Ut),d(ht),rt(()=>{Pn.disabled=(t(B),t(j),t(b),_(()=>t(B)||t(j)||t(b).length===0)),D(ye,`已有引用 (${t(b),_(()=>t(b).length)??""})`)}),C("click",vr,()=>s(!1)),rn(Re,()=>t(wt).id,yt=>Qr(wt,t(wt).id=yt)),rn(un,()=>t(wt).author,yt=>Qr(wt,t(wt).author=yt)),rn(bn,()=>t(wt).title,yt=>Qr(wt,t(wt).title=yt)),rn(Ye,()=>t(wt).year,yt=>Qr(wt,t(wt).year=yt)),rn(pr,()=>t(wt).source,yt=>Qr(wt,t(wt).source=yt)),C("click",ei,At),C("click",Pn,Ue),C("click",pe,()=>en("apa")),C("click",wn,()=>en("mla")),C("click",zn,()=>en("gb")),C("click",Ut,ua(function(yt){bs.call(this,n,yt)})),C("keydown",Ut,ua(function(yt){bs.call(this,n,yt)})),C("click",ht,()=>s(!1)),C("keydown",ht,yt=>{(yt.key==="Enter"||yt.key===" "||yt.key==="Escape")&&(yt.preventDefault(),s(!1))}),M(X,ht)};Z(or,X=>{s()&&X(Lt)})}M(e,tr);var Ri=li(An);return a(),Ri}const ql=5e3;function Te(e){const n=Number(e);return Number.isFinite(n)?Math.max(0,Math.round(n)):0}function Dn(e){const n=Number(e);return Number.isFinite(n)?Math.max(0,n):0}function ja(e){return Math.max(0,Math.min(1,Dn(e)))}function si(e){return`${(Math.max(0,Math.min(1,e))*100).toFixed(1)}%`}function Hu(e){const n=Te(e.hit)+Te(e.miss);return n<=0?0:Te(e.hit)/n}function Os(e){const n=Number(e||0);if(!Number.isFinite(n)||n<=0)return"--:--:--";const i=n>1e10?n:n*1e3;return new Date(i).toLocaleTimeString("zh-CN",{hour12:!1})}function Io(e){const n=Number(e||0);return Number.isFinite(n)?Math.abs(n)<1?n.toFixed(3):Math.abs(n)<100?n.toFixed(2):n.toFixed(1):"0"}function No(e){return{enabled:!!e.enabled,min_runs:Math.max(1,Math.min(500,Te(e.min_runs)||8)),p95_ms:Math.max(100,Math.min(6e4,Te(e.p95_ms)||4500)),error_rate_per_run:Math.max(0,Math.min(1,Dn(e.error_rate_per_run)||0)),cache_delta_hit_rate:Math.max(0,Math.min(1,Dn(e.cache_delta_hit_rate)||0))}}function zu(e){const n=e&&typeof e=="object"?e:{};return{hit:Te(n.hit),miss:Te(n.miss),set:Te(n.set),expired:Te(n.expired),evicted:Te(n.evicted),hit_rate:ja(n.hit_rate)}}function Uh(e){return Array.isArray(e)?e.map(n=>String(n||"").trim()).filter(n=>n.length>0).slice(0,12):[]}function Jh(e){return String(e||"").trim().toLowerCase()==="critical"?"critical":"warn"}function sc(e){const n=String(e||"").trim().toLowerCase();return n==="critical"?"critical":n==="warn"?"warn":"ok"}function dd(e){const n=e&&typeof e=="object"?e:{};return{id:String(n.id||"").trim(),ts:Dn(n.ts),severity:sc(n.severity),degraded:!!n.degraded,runs:Te(n.runs),p95_ms:Dn(n.p95_ms),error_rate_per_run:ja(n.error_rate_per_run),cache_delta_hit_rate:ja(n.cache_delta_hit_rate),triggered_alerts:Te(n.triggered_alerts),notification_status:String(n.notification_status||"").trim()}}function Gh(e,n){const i=e&&typeof e=="object"?e:{},r=i.trend_context&&typeof i.trend_context=="object"?i.trend_context:{},a=Array.isArray(r.points)?r.points:[];return{event_id:n,total:Te(r.total),before:Te(r.before),after:Te(r.after),points:a.map(s=>dd(s)).filter(s=>s.id.length>0)}}function Kh(e){const n=e&&typeof e=="object"?e:{},i=n.cache&&typeof n.cache=="object"?n.cache:{},r=n.observe&&typeof n.observe=="object"?n.observe:{},a=r.elapsed_ms&&typeof r.elapsed_ms=="object"?r.elapsed_ms:{},s=r.items&&typeof r.items=="object"?r.items:{},m=r.workers&&typeof r.workers=="object"?r.workers:{},g=r.errors&&typeof r.errors=="object"?r.errors:{},w=Array.isArray(r.recent)?r.recent:[],k=!!n.degraded,b=Uh(n.errors),j=n.alerts&&typeof n.alerts=="object"?n.alerts:{},B=Array.isArray(j.rules)?j.rules:[],F=Array.isArray(j.triggered_rules)?j.triggered_rules:[],O=j.thresholds&&typeof j.thresholds=="object"?j.thresholds:{},E=j.notification&&typeof j.notification=="object"?j.notification:{},P=n.trend&&typeof n.trend=="object"?n.trend:{},dt=Array.isArray(P.points)?P.points:[];return{cache:{size:Te(i.size),ttl_s:Dn(i.ttl_s),max_entries:Te(i.max_entries),hit:Te(i.hit),miss:Te(i.miss),set:Te(i.set),expired:Te(i.expired),evicted:Te(i.evicted)},observe:{window_s:Dn(r.window_s),max_runs:Te(r.max_runs),runs:Te(r.runs),elapsed_ms:{avg:Dn(a.avg),p50:Dn(a.p50),p95:Dn(a.p95),max:Dn(a.max)},items:{total:Te(s.total),avg:Dn(s.avg),p50:Dn(s.p50),p95:Dn(s.p95),max:Dn(s.max)},workers:{avg:Dn(m.avg),max:Dn(m.max)},errors:{total:Te(g.total),rate_per_run:ja(g.rate_per_run)},cache_delta:zu(r.cache_delta),recent:w.filter(U=>U&&typeof U=="object").map(U=>{const lt=U;return{ts:Dn(lt.ts),elapsed_ms:Dn(lt.elapsed_ms),item_count:Te(lt.item_count),worker_count:Te(lt.worker_count),error_count:Te(lt.error_count),cache_delta:zu(lt.cache_delta)}})},degraded:k,errors:b,alerts:{enabled:!!j.enabled,severity:sc(j.severity),triggered:Te(j.triggered),runs:Te(j.runs),min_runs:Te(j.min_runs),warmup:!!j.warmup,thresholds:{p95_ms:Math.max(100,Math.min(6e4,Dn(O.p95_ms)||4500)),error_rate_per_run:Math.max(0,Math.min(1,ja(O.error_rate_per_run))),cache_delta_hit_rate:Math.max(0,Math.min(1,ja(O.cache_delta_hit_rate)))},rules:B.filter(U=>U&&typeof U=="object").map(U=>{const lt=U;return{id:String(lt.id||"").trim(),level:Jh(lt.level),triggered:!!lt.triggered,value:Dn(lt.value),threshold:Dn(lt.threshold),op:String(lt.op||"").trim(),message:String(lt.message||"").trim()}}).filter(U=>U.id.length>0),triggered_rules:F.map(U=>String(U||"").trim()).filter(U=>U.length>0),notification:{enabled:!!E.enabled,webhook_configured:!!E.webhook_configured,sent:!!E.sent,channels:Array.isArray(E.channels)?E.channels.map(U=>String(U||"").trim()).filter(U=>U.length>0):[],signature:String(E.signature||"").trim(),dedupe_hit:!!E.dedupe_hit,event_type:String(E.event_type||"").trim()||"none",status:String(E.status||"").trim()||"unknown",cooldown_s:Dn(E.cooldown_s),last_sent_at:Dn(E.last_sent_at),suppressed:Te(E.suppressed),last_error:String(E.last_error||"").trim(),event_id:String(E.event_id||"").trim(),events_total:Te(E.events_total),events_recent:Array.isArray(E.events_recent)?E.events_recent.filter(U=>U&&typeof U=="object").map(U=>{const lt=U;return{id:String(lt.id||"").trim(),ts:Dn(lt.ts),severity:sc(lt.severity),event_type:String(lt.event_type||"").trim()||"none",status:String(lt.status||"").trim()||"unknown",sent:!!lt.sent,dedupe_hit:!!lt.dedupe_hit,triggered_rules:Array.isArray(lt.triggered_rules)?lt.triggered_rules.map(Tt=>String(Tt||"").trim()).filter(Tt=>Tt.length>0):[],channels:Array.isArray(lt.channels)?lt.channels.map(Tt=>String(Tt||"").trim()).filter(Tt=>Tt.length>0):[]}}).filter(U=>U.id.length>0):[]}},trend:{enabled:!!P.enabled,total:Te(P.total),limit:Te(P.limit),points:dt.filter(U=>U&&typeof U=="object").map(U=>dd(U)).filter(U=>U.id.length>0)}}}var Vh=q('<div class="perf-empty">Loading...</div>'),Xh=q('<div class="perf-error"> </div>'),Yh=q("<span>Metrics endpoint is degraded; current data comes from fallback snapshot.</span>"),Qh=q("<span>Metrics endpoint is healthy.</span>"),Zh=q('<span class="error-item"> </span>'),tg=q('<div class="perf-degraded-errors"><div class="title">Degraded Causes</div> <div class="error-list"></div></div>'),eg=q("<span> </span>"),ng=q("<span>alerts disabled</span>"),rg=q('<span class="alerts-warmup">warmup: alerts suppressed until enough runs</span>'),ig=q("<span> </span>"),sg=q("<span>dedupe-hit</span>"),ag=q("<span> </span>"),og=q('<span class="notify-signature"> </span>'),lg=q('<span class="notify-error"> </span>'),cg=q("<span>dedupe</span>"),ug=q("<span> </span>"),fg=q("<span> </span>"),dg=q('<button class="event-link"><!></button>'),vg=q('<div><span class="event-time"> </span> <span class="event-type"> </span> <span class="event-status"> </span> <span> </span> <!> <!> <!> <!></div>'),pg=q('<div class="perf-alert-events"><div class="title"> </div> <div class="alert-event-list"></div></div>'),mg=q('<div class="perf-error"> </div>'),hg=q("<span>degraded</span>"),gg=q('<div><span class="time"> </span> <span> </span> <span> </span> <span> </span> <span> </span> <span> </span> <!></div>'),_g=q('<div class="trend-list"></div>'),bg=q('<div class="perf-event-context"><div class="title"> </div> <div class="line"> </div> <!></div>'),yg=q("<span> </span>"),wg=q('<div><span class="rule-id"> </span> <span> </span> <span> </span></div>'),xg=q('<div class="perf-alert-rules"><div class="title">Triggered Rules</div> <div class="alert-rule-list"></div></div>'),Sg=q('<div class="perf-empty">暂无数据</div>'),kg=q('<div class="recent-item"><span class="time"> </span> <span> </span> <span> </span> <span> </span> <span> </span> <span> </span></div>'),$g=q('<div class="recent-list"></div>'),Tg=q('<div class="line">trend storage disabled</div>'),jg=q('<div class="perf-empty">暂无趋势数据</div>'),Eg=q("<span>degraded</span>"),Ag=q('<div><span class="time"> </span> <span> </span> <span> </span> <span> </span> <span> </span> <span> </span> <!></div>'),Cg=q('<div class="trend-list"></div>'),Ig=q('<div class="perf-updated"> </div> <div><span class="health-tag"> </span> <!></div> <!> <div><span class="alerts-tag">Alerts</span> <!> <!></div> <div><span class="notify-tag">Notify</span> <span> <!></span> <!> <!> <!> <!> <!></div> <!> <!> <!> <div class="perf-alert-config"><div class="title">Alert Config</div> <div class="alert-admin-key"><label for="alert-admin-key">admin key (optional)</label> <input id="alert-admin-key" type="password" placeholder="X-Admin-Key"/></div> <div class="alert-config-grid"><label class="alert-field checkbox"><input type="checkbox"/> <span>enabled</span></label> <label class="alert-field"><span>min runs</span> <input type="number" min="1" max="500"/></label> <label class="alert-field"><span>p95 ms >=</span> <input type="number" min="100" max="60000"/></label> <label class="alert-field"><span>error rate >=</span> <input type="number" min="0" max="1" step="0.01"/></label> <label class="alert-field"><span>hit rate &lt;=</span> <input type="number" min="0" max="1" step="0.01"/></label></div> <div class="alert-config-actions"><button class="btn-alert-save"><!></button> <button class="btn-alert-reset">Restore defaults</button> <!></div></div> <!> <div class="perf-cards"><div class="perf-card"><div class="label">窗口</div> <div class="value"> </div> <div class="meta"> </div></div> <div class="perf-card"><div class="label">延迟</div> <div class="value"> </div> <div class="meta"> </div></div> <div class="perf-card"><div class="label">负载</div> <div class="value"> </div> <div class="meta"> </div></div> <div class="perf-card"><div class="label">Errors/Hit rate</div> <div class="value"> </div> <div class="meta"> </div></div></div> <div class="perf-cache"><div class="title">Cache snapshot</div> <div class="line"> </div> <div class="line"> </div></div> <div class="perf-recent"><div class="title"> </div> <!></div> <div class="perf-trend"><div class="title"> </div> <!></div>',1),Ng=q('<div class="perf-empty">暂无观测数据</div>'),Mg=q('<div class="perf-backdrop" role="button" tabindex="0" aria-label="关闭性能观测"><div class="perf-modal" role="dialog" aria-modal="true" tabindex="-1"><div class="perf-header"><div><h2>核验性能观测</h2> <div class="perf-sub">Window metrics + recent request details</div></div> <div class="perf-actions"><button class="btn-refresh"><!></button> <button class="btn-close" aria-label="关闭">×</button></div></div> <div class="perf-body"><!></div></div></div>');function vd(e,n){if(new.target)return mi({component:vd,...e});oi(n,!1);let i=qr(n,"visible",12,!1),r=W(null),a=W(!1),s=W(!1),m=W(""),g=W(""),w=null,k=W(!1),b=W(!1),j=W(!1),B=W(""),F=W(""),O=W(""),E=W(!1),P=W(""),dt=W(""),U=W(null),lt=W({enabled:!0,min_runs:8,p95_ms:4500,error_rate_per_run:.3,cache_delta_hit_rate:.35});typeof window<"u"&&f(O,String(window.localStorage.getItem("wa_alert_admin_key")||""));function Tt(mt=!1){const jt={};mt&&(jt["Content-Type"]="application/json");const Bt=String(t(O)||"").trim();return Bt&&(jt["X-Admin-Key"]=Bt),jt}function wt(){if(typeof window>"u")return;const mt=String(t(O)||"");mt.trim()?window.localStorage.setItem("wa_alert_admin_key",mt):window.localStorage.removeItem("wa_alert_admin_key")}function Nt(mt){t(j)||t(b)||f(lt,No({enabled:mt.alerts.enabled,min_runs:mt.alerts.min_runs,p95_ms:mt.alerts.thresholds.p95_ms,error_rate_per_run:mt.alerts.thresholds.error_rate_per_run,cache_delta_hit_rate:mt.alerts.thresholds.cache_delta_hit_rate}))}async function Wt(){if(t(r)){f(b,!0),f(B,""),f(F,"");try{const mt=No(t(lt));f(lt,mt);const jt=await fetch("/api/metrics/citation_verify/alerts/config",{method:"POST",headers:Tt(!0),body:JSON.stringify({config:mt})});if(!jt.ok)throw new Error(`HTTP ${jt.status}`);const Bt=await jt.json();if(Number(Bt?.ok||0)!==1)throw new Error("Failed to save alert config");const Kt=Bt?.config&&typeof Bt.config=="object"?Bt.config:{};f(lt,No({enabled:Kt.enabled,min_runs:Kt.min_runs,p95_ms:Kt.p95_ms,error_rate_per_run:Kt.error_rate_per_run,cache_delta_hit_rate:Kt.cache_delta_hit_rate})),f(j,!1),f(B,"Alert config saved"),f(F,"ok"),await kt(!0)}catch(mt){f(B,mt instanceof Error?mt.message:"Failed to save alert config"),f(F,"bad")}finally{f(b,!1)}}}async function tt(){f(b,!0),f(B,""),f(F,"");try{const mt=await fetch("/api/metrics/citation_verify/alerts/config",{method:"POST",headers:Tt(!0),body:JSON.stringify({reset:!0})});if(!mt.ok)throw new Error(`HTTP ${mt.status}`);const jt=await mt.json();if(Number(jt?.ok||0)!==1)throw new Error("Failed to reset alert config");const Bt=jt?.config&&typeof jt.config=="object"?jt.config:{};f(lt,No({enabled:Bt.enabled,min_runs:Bt.min_runs,p95_ms:Bt.p95_ms,error_rate_per_run:Bt.error_rate_per_run,cache_delta_hit_rate:Bt.cache_delta_hit_rate})),f(j,!1),f(B,"Alert config reset to defaults"),f(F,"ok"),await kt(!0)}catch(mt){f(B,mt instanceof Error?mt.message:"Failed to reset alert config"),f(F,"bad")}finally{f(b,!1)}}async function Et(mt){const jt=String(mt||"").trim();if(jt){f(E,!0),f(dt,jt),f(P,"");try{const Bt=await fetch(`/api/metrics/citation_verify/alerts/event/${encodeURIComponent(jt)}?context=12`,{headers:Tt(!1)});if(!Bt.ok)throw new Error(`HTTP ${Bt.status}`);const Kt=await Bt.json();if(Number(Kt?.ok||0)!==1)throw new Error("Failed to load event context");f(U,Gh(Kt,jt))}catch(Bt){f(P,Bt instanceof Error?Bt.message:"Failed to load event context"),f(U,null)}finally{f(E,!1)}}}async function kt(mt=!1){mt?f(s,!0):t(r)||f(a,!0),f(m,"");try{const jt=await fetch("/api/metrics/citation_verify");if(!jt.ok)throw new Error(`HTTP ${jt.status}`);const Bt=await jt.json();f(r,Kh(Bt)),t(r)&&Nt(t(r)),f(g,new Date().toLocaleTimeString("zh-CN",{hour12:!1}))}catch(jt){f(m,jt instanceof Error?jt.message:"Failed to load performance metrics")}finally{f(a,!1),f(s,!1)}}function Jt(){w&&(clearInterval(w),w=null)}function de(){w||(w=setInterval(()=>{i()&&kt(!1)},ql))}Cp(()=>{Jt()}),Hs(()=>(se(i()),t(k)),()=>{i()&&!t(k)?(f(k,!0),kt(!1),de()):!i()&&t(k)&&(f(k,!1),Jt())}),so();var De={get visible(){return i()},set visible(mt){i(mt),dr()},$set:gi,$on:(mt,jt)=>hi(n,mt,jt)};Ds();var xe=Vs(),ln=wr(xe);{var Mt=mt=>{var jt=Mg(),Bt=v(jt),Kt=v(Bt),vn=u(v(Kt),2),cn=v(vn),Le=v(cn);{var bt=ne=>{var Ue=es("Refreshing...");M(ne,Ue)},At=ne=>{var Ue=es("Refresh");M(ne,Ue)};Z(Le,ne=>{t(s)?ne(bt):ne(At,!1)})}d(cn);var ee=u(cn,2);d(vn),d(Kt);var We=u(Kt,2),ge=v(We);{var en=ne=>{var Ue=Vh();M(ne,Ue)},Sr=ne=>{var Ue=Xh(),An=v(Ue,!0);d(Ue),rt(()=>D(An,t(m))),M(ne,Ue)},Ti=ne=>{var Ue=Ig(),An=wr(Ue),tr=v(An);d(An);var or=u(An,2),Lt=v(or),Ri=v(Lt,!0);d(Lt);var X=u(Lt,2);{var ht=et=>{var ut=Yh();M(et,ut)},Ut=et=>{var ut=Qh();M(et,ut)};Z(X,et=>{t(r),_(()=>t(r).degraded)?et(ht):et(Ut,!1)})}d(or);var Se=u(or,2);{var vr=et=>{var ut=tg(),Xt=u(v(ut),2);on(Xt,5,()=>(t(r),_(()=>t(r).errors)),Fn,(Dt,fe)=>{var mn=Zh(),ie=v(mn,!0);d(mn),rt(()=>D(ie,t(fe))),M(Dt,mn)}),d(Xt),d(ut),M(et,ut)};Z(Se,et=>{t(r),_(()=>t(r).degraded&&t(r).errors.length>0)&&et(vr)})}var er=u(Se,2),On=u(v(er),2);{var _n=et=>{var ut=eg(),Xt=v(ut);d(ut),rt(Dt=>D(Xt,`severity ${Dt??""} | triggered ${t(r),_(()=>t(r).alerts.triggered)??""} | runs ${t(r),_(()=>t(r).alerts.runs)??""}/${t(r),_(()=>t(r).alerts.min_runs)??""}`),[()=>(t(r),_(()=>t(r).alerts.severity.toUpperCase()))]),M(et,ut)},Re=et=>{var ut=ng();M(et,ut)};Z(On,et=>{t(r),_(()=>t(r).alerts.enabled)?et(_n):et(Re,!1)})}var un=u(On,2);{var bn=et=>{var ut=rg();M(et,ut)};Z(un,et=>{t(r),_(()=>t(r).alerts.warmup&&t(r).alerts.enabled)&&et(bn)})}d(er);var Ye=u(er,2),pr=u(v(Ye),2),ei=v(pr),sn=u(ei);{var kr=et=>{var ut=es();rt(Xt=>D(ut,Xt),[()=>(t(r),_(()=>t(r).alerts.notification.channels.join(",")))]),M(et,ut)},Pn=et=>{var ut=es("none");M(et,ut)};Z(sn,et=>{t(r),_(()=>t(r).alerts.notification.channels.length>0)?et(kr):et(Pn,!1)})}d(pr);var Fr=u(pr,2);{var Yt=et=>{var ut=ig(),Xt=v(ut);d(ut),rt(()=>D(Xt,`suppressed ${t(r),_(()=>t(r).alerts.notification.suppressed)??""}`)),M(et,ut)};Z(Fr,et=>{t(r),_(()=>t(r).alerts.notification.suppressed>0)&&et(Yt)})}var yn=u(Fr,2);{var $r=et=>{var ut=sg();M(et,ut)};Z(yn,et=>{t(r),_(()=>t(r).alerts.notification.dedupe_hit)&&et($r)})}var Hn=u(yn,2);{var Rt=et=>{var ut=ag(),Xt=v(ut);d(ut),rt(Dt=>D(Xt,`event ${Dt??""}`),[()=>(t(r),_(()=>t(r).alerts.notification.event_id.slice(0,8)))]),M(et,ut)};Z(Hn,et=>{t(r),_(()=>t(r).alerts.notification.event_id)&&et(Rt)})}var ve=u(Hn,2);{var an=et=>{var ut=og(),Xt=v(ut,!0);d(ut),rt(()=>D(Xt,(t(r),_(()=>t(r).alerts.notification.signature)))),M(et,ut)};Z(ve,et=>{t(r),_(()=>t(r).alerts.notification.signature)&&et(an)})}var Ze=u(ve,2);{var Qt=et=>{var ut=lg(),Xt=v(ut,!0);d(ut),rt(()=>D(Xt,(t(r),_(()=>t(r).alerts.notification.last_error)))),M(et,ut)};Z(Ze,et=>{t(r),_(()=>t(r).alerts.notification.last_error)&&et(Qt)})}d(Ye);var qe=u(Ye,2);{var pe=et=>{var ut=pg(),Xt=v(ut),Dt=v(Xt);d(Xt);var fe=u(Xt,2);on(fe,5,()=>(t(r),_(()=>t(r).alerts.notification.events_recent.slice().reverse())),Fn,(mn,ie)=>{var hn=vg(),Kn=v(hn),ir=v(Kn,!0);d(Kn);var lr=u(Kn,2),me=v(lr,!0);d(lr);var mr=u(lr,2),cr=v(mr,!0);d(mr);var _i=u(mr,2),Cr=v(_i);d(_i);var bi=u(_i,2);{var Ir=Vn=>{var we=cg();M(Vn,we)};Z(bi,Vn=>{t(ie),_(()=>t(ie).dedupe_hit)&&Vn(Ir)})}var yi=u(bi,2);{var Kr=Vn=>{var we=ug(),hr=v(we);d(we),rt(vi=>D(hr,`rules ${vi??""}`),[()=>(t(ie),_(()=>t(ie).triggered_rules.join(",")))]),M(Vn,we)};Z(yi,Vn=>{t(ie),_(()=>t(ie).triggered_rules.length>0)&&Vn(Kr)})}var Bi=u(yi,2);{var Zi=Vn=>{var we=fg(),hr=v(we);d(we),rt(vi=>D(hr,`via ${vi??""}`),[()=>(t(ie),_(()=>t(ie).channels.join(",")))]),M(Vn,we)};Z(Bi,Vn=>{t(ie),_(()=>t(ie).channels.length>0)&&Vn(Zi)})}var Pi=u(Bi,2);{var wi=Vn=>{var we=dg(),hr=v(we);{var vi=zi=>{var Ss=es("loading...");M(zi,Ss)},Hi=zi=>{var Ss=es("locate");M(zi,Ss)};Z(hr,zi=>{t(E),t(dt),t(ie),_(()=>t(E)&&t(dt)===t(ie).id)?zi(vi):zi(Hi,!1)})}d(we),rt(()=>we.disabled=t(E)),C("click",we,()=>Et(t(ie).id)),M(Vn,we)};Z(Pi,Vn=>{t(ie),_(()=>t(ie).id)&&Vn(wi)})}d(hn),rt(Vn=>{Me(hn,1,(t(ie),_(()=>"alert-event-item "+t(ie).severity))),D(ir,Vn),D(me,(t(ie),_(()=>t(ie).event_type))),D(cr,(t(ie),_(()=>t(ie).status))),D(Cr,`sent ${t(ie),_(()=>t(ie).sent?"yes":"no")??""}`)},[()=>(se(Os),t(ie),_(()=>Os(t(ie).ts)))]),M(mn,hn)}),d(fe),d(ut),rt(()=>D(Dt,`Alert Events (${t(r),_(()=>t(r).alerts.notification.events_recent.length)??""}/${t(r),_(()=>t(r).alerts.notification.events_total)??""})`)),M(et,ut)};Z(qe,et=>{t(r),_(()=>t(r).alerts.notification.events_recent.length>0)&&et(pe)})}var wn=u(qe,2);{var zn=et=>{var ut=mg(),Xt=v(ut,!0);d(ut),rt(()=>D(Xt,t(P))),M(et,ut)};Z(wn,et=>{t(P)&&et(zn)})}var Fe=u(wn,2);{var qt=et=>{var ut=bg(),Xt=v(ut),Dt=v(Xt);d(Xt);var fe=u(Xt,2),mn=v(fe);d(fe);var ie=u(fe,2);{var hn=Kn=>{var ir=_g();on(ir,7,()=>(t(U),_(()=>t(U).points)),(lr,me)=>`ctx-${lr.id}-${me}`,(lr,me)=>{var mr=gg(),cr=v(mr),_i=v(cr,!0);d(cr);var Cr=u(cr,2),bi=v(Cr);d(Cr);var Ir=u(Cr,2),yi=v(Ir);d(Ir);var Kr=u(Ir,2),Bi=v(Kr);d(Kr);var Zi=u(Kr,2),Pi=v(Zi);d(Zi);var wi=u(Zi,2),Vn=v(wi);d(wi);var we=u(wi,2);{var hr=vi=>{var Hi=hg();M(vi,Hi)};Z(we,vi=>{t(me),_(()=>t(me).degraded)&&vi(hr)})}d(mr),rt((vi,Hi,zi,Ss)=>{Me(mr,1,(t(me),_(()=>"trend-item "+t(me).severity))),D(_i,vi),D(bi,`p95 ${Hi??""}ms`),D(yi,`err ${zi??""}`),D(Bi,`hit ${Ss??""}`),D(Pi,`alerts ${t(me),_(()=>t(me).triggered_alerts)??""}`),D(Vn,`notify ${t(me),_(()=>t(me).notification_status||"none")??""}`)},[()=>(se(Os),t(me),_(()=>Os(t(me).ts))),()=>(t(me),_(()=>t(me).p95_ms.toFixed(1))),()=>(se(si),t(me),_(()=>si(t(me).error_rate_per_run))),()=>(se(si),t(me),_(()=>si(t(me).cache_delta_hit_rate)))]),M(lr,mr)}),d(ir),M(Kn,ir)};Z(ie,Kn=>{t(U),_(()=>t(U).points.length>0)&&Kn(hn)})}d(ut),rt(Kn=>{D(Dt,`Event Context (${Kn??""})`),D(mn,`points ${t(U),_(()=>t(U).points.length)??""}/${t(U),_(()=>t(U).total)??""} | before ${t(U),_(()=>t(U).before)??""}
                | after ${t(U),_(()=>t(U).after)??""}`)},[()=>(t(U),_(()=>t(U).event_id.slice(0,8)))]),M(et,ut)};Z(Fe,et=>{t(U)&&et(qt)})}var ye=u(Fe,2),je=u(v(ye),2),Oe=u(v(je),2);Zn(Oe),d(je);var Je=u(je,2),nr=v(Je),yt=v(nr);Zn(yt),ms(2),d(nr);var re=u(nr,2),ke=u(v(re),2);Zn(ke),d(re);var le=u(re,2),ce=u(v(le),2);Zn(ce),d(le);var Ht=u(le,2),Ee=u(v(Ht),2);Zn(Ee),d(Ht);var Or=u(Ht,2),zt=u(v(Or),2);Zn(zt),d(Or),d(Je);var Cn=u(Je,2),Ae=v(Cn),Wn=v(Ae);{var Tr=et=>{var ut=es("Saving...");M(et,ut)},ci=et=>{var ut=es("Save alert config");M(et,ut)};Z(Wn,et=>{t(b)?et(Tr):et(ci,!1)})}d(Ae);var ji=u(Ae,2),Ei=u(ji,2);{var ni=et=>{var ut=yg(),Xt=v(ut,!0);d(ut),rt(()=>{Me(ut,1,"alert-config-msg "+(t(F)||"ok")),D(Xt,t(B))}),M(et,ut)};Z(Ei,et=>{t(B)&&et(ni)})}d(Cn),d(ye);var qi=u(ye,2);{var ui=et=>{var ut=xg(),Xt=u(v(ut),2);on(Xt,5,()=>(t(r),_(()=>t(r).alerts.rules.filter(Dt=>Dt.triggered))),Fn,(Dt,fe)=>{var mn=wg(),ie=v(mn),hn=v(ie,!0);d(ie);var Kn=u(ie,2),ir=v(Kn,!0);d(Kn);var lr=u(Kn,2),me=v(lr);d(lr),d(mn),rt((mr,cr)=>{Me(mn,1,(t(fe),_(()=>"alert-rule-item "+t(fe).level))),D(hn,(t(fe),_(()=>t(fe).id))),D(ir,(t(fe),_(()=>t(fe).message))),D(me,`value ${mr??""} ${t(fe),_(()=>t(fe).op)??""} ${cr??""}`)},[()=>(se(Io),t(fe),_(()=>Io(t(fe).value))),()=>(se(Io),t(fe),_(()=>Io(t(fe).threshold)))]),M(Dt,mn)}),d(Xt),d(ut),M(et,ut)};Z(qi,et=>{t(r),_(()=>t(r).alerts.enabled&&t(r).alerts.triggered>0)&&et(ui)})}var Qe=u(qi,2),rr=v(Qe),Jr=u(v(rr),2),xn=v(Jr);d(Jr);var Pe=u(Jr,2),Un=v(Pe);d(Pe),d(rr);var ue=u(rr,2),Sn=u(v(ue),2),Jn=v(Sn);d(Sn);var _e=u(Sn,2),jr=v(_e);d(_e),d(ue);var Zt=u(ue,2),Fi=u(v(Zt),2),In=v(Fi);d(Fi);var Oi=u(Fi,2),Ce=v(Oi);d(Oi),d(Zt);var nn=u(Zt,2),Gn=u(v(nn),2),kn=v(Gn);d(Gn);var Ai=u(Gn,2),cs=v(Ai);d(Ai),d(nn),d(Qe);var Gr=u(Qe,2),Yi=u(v(Gr),2),Rn=v(Yi);d(Yi);var Er=u(Yi,2),Qi=v(Er);d(Er),d(Gr);var fi=u(Gr,2),Ci=v(fi),te=v(Ci);d(Ci);var Ar=u(Ci,2);{var pn=et=>{var ut=Sg();M(et,ut)},Pr=et=>{var ut=$g();on(ut,7,()=>(t(r),_(()=>t(r).observe.recent.slice().reverse())),(Xt,Dt)=>`${Xt.ts}-${Dt}`,(Xt,Dt)=>{var fe=kg(),mn=v(fe),ie=v(mn,!0);d(mn);var hn=u(mn,2),Kn=v(hn);d(hn);var ir=u(hn,2),lr=v(ir);d(ir);var me=u(ir,2),mr=v(me);d(me);var cr=u(me,2),_i=v(cr);d(cr);var Cr=u(cr,2),bi=v(Cr);d(Cr),d(fe),rt((Ir,yi,Kr)=>{D(ie,Ir),D(Kn,`${yi??""}ms`),D(lr,`items ${t(Dt),_(()=>t(Dt).item_count)??""}`),D(mr,`w${t(Dt),_(()=>t(Dt).worker_count)??""}`),D(_i,`err ${t(Dt),_(()=>t(Dt).error_count)??""}`),D(bi,`hit_delta ${Kr??""}`)},[()=>(se(Os),t(Dt),_(()=>Os(t(Dt).ts))),()=>(t(Dt),_(()=>t(Dt).elapsed_ms.toFixed(1))),()=>(se(si),t(Dt),_(()=>si(t(Dt).cache_delta.hit_rate)))]),M(Xt,fe)}),d(ut),M(et,ut)};Z(Ar,et=>{t(r),_(()=>t(r).observe.recent.length===0)?et(pn):et(Pr,!1)})}d(fi);var di=u(fi,2),Ii=v(di),Ni=v(Ii);d(Ii);var us=u(Ii,2);{var Ls=et=>{var ut=Tg();M(et,ut)},Mi=et=>{var ut=jg();M(et,ut)},Xs=et=>{var ut=Cg();on(ut,7,()=>(t(r),_(()=>t(r).trend.points.slice().reverse())),(Xt,Dt)=>`${Xt.id}-${Dt}`,(Xt,Dt)=>{var fe=Ag(),mn=v(fe),ie=v(mn,!0);d(mn);var hn=u(mn,2),Kn=v(hn);d(hn);var ir=u(hn,2),lr=v(ir);d(ir);var me=u(ir,2),mr=v(me);d(me);var cr=u(me,2),_i=v(cr);d(cr);var Cr=u(cr,2),bi=v(Cr);d(Cr);var Ir=u(Cr,2);{var yi=Kr=>{var Bi=Eg();M(Kr,Bi)};Z(Ir,Kr=>{t(Dt),_(()=>t(Dt).degraded)&&Kr(yi)})}d(fe),rt((Kr,Bi,Zi,Pi)=>{Me(fe,1,(t(Dt),_(()=>"trend-item "+t(Dt).severity))),D(ie,Kr),D(Kn,`p95 ${Bi??""}ms`),D(lr,`err ${Zi??""}`),D(mr,`hit ${Pi??""}`),D(_i,`alerts ${t(Dt),_(()=>t(Dt).triggered_alerts)??""}`),D(bi,`notify ${t(Dt),_(()=>t(Dt).notification_status||"none")??""}`)},[()=>(se(Os),t(Dt),_(()=>Os(t(Dt).ts))),()=>(t(Dt),_(()=>t(Dt).p95_ms.toFixed(1))),()=>(se(si),t(Dt),_(()=>si(t(Dt).error_rate_per_run))),()=>(se(si),t(Dt),_(()=>si(t(Dt).cache_delta_hit_rate)))]),M(Xt,fe)}),d(ut),M(et,ut)};Z(us,et=>{t(r),_(()=>!t(r).trend.enabled)?et(Ls):(t(r),_(()=>t(r).trend.points.length===0)?et(Mi,1):et(Xs,!1))})}d(di),rt((et,ut,Xt,Dt,fe,mn,ie,hn,Kn,ir,lr,me)=>{D(tr,`Updated ${(t(g)||"--:--:--")??""} | Auto poll ${et??""}s`),Me(or,1,(t(r),_(()=>"perf-health "+(t(r).degraded?"warn":"ok")))),D(Ri,(t(r),_(()=>t(r).degraded?"DEGRADED":"HEALTHY"))),Me(er,1,(t(r),_(()=>"perf-alert-summary "+(t(r).alerts.enabled?t(r).alerts.severity:"ok")))),Me(Ye,1,(t(r),_(()=>"perf-notify-summary "+(t(r).alerts.notification.sent?"sent":"idle")))),D(ei,`status ${t(r),_(()=>t(r).alerts.notification.status)??""} | event ${t(r),_(()=>t(r).alerts.notification.event_type)??""} | channels `),Ae.disabled=t(b)||!t(j),ji.disabled=t(b),D(xn,`${t(r),_(()=>t(r).observe.runs)??""}/${t(r),_(()=>t(r).observe.max_runs)??""}`),D(Un,`window ${ut??""}s`),D(Jn,`${Xt??""} / ${Dt??""} ms`),D(jr,`max ${fe??""} ms`),D(In,`${mn??""} items/run`),D(Ce,`workers avg ${ie??""} | max ${hn??""}`),D(kn,`${Kn??""} / ${ir??""}`),D(cs,`errors ${t(r),_(()=>t(r).observe.errors.total)??""} | hit_delta`),D(Rn,`size ${t(r),_(()=>t(r).cache.size)??""}/${t(r),_(()=>t(r).cache.max_entries)??""} | ttl ${lr??""}s | hit ${t(r),_(()=>t(r).cache.hit)??""}/
              ${t(r),_(()=>t(r).cache.hit+t(r).cache.miss)??""} (${me??""})`),D(Qi,`set ${t(r),_(()=>t(r).cache.set)??""} | evicted ${t(r),_(()=>t(r).cache.evicted)??""} | expired ${t(r),_(()=>t(r).cache.expired)??""}`),D(te,`Recent Runs (${t(r),_(()=>t(r).observe.recent.length)??""})`),D(Ni,`Trend (${t(r),_(()=>t(r).trend.points.length)??""}/${t(r),_(()=>t(r).trend.total)??""})`)},[()=>(se(ql),_(()=>Math.floor(ql/1e3))),()=>(t(r),_(()=>t(r).observe.window_s.toFixed(0))),()=>(t(r),_(()=>t(r).observe.elapsed_ms.p50.toFixed(1))),()=>(t(r),_(()=>t(r).observe.elapsed_ms.p95.toFixed(1))),()=>(t(r),_(()=>t(r).observe.elapsed_ms.max.toFixed(1))),()=>(t(r),_(()=>t(r).observe.items.avg.toFixed(1))),()=>(t(r),_(()=>t(r).observe.workers.avg.toFixed(1))),()=>(t(r),_(()=>t(r).observe.workers.max.toFixed(0))),()=>(se(si),t(r),_(()=>si(t(r).observe.errors.rate_per_run))),()=>(se(si),t(r),_(()=>si(t(r).observe.cache_delta.hit_rate))),()=>(t(r),_(()=>t(r).cache.ttl_s.toFixed(0))),()=>(se(si),se(Hu),t(r),_(()=>si(Hu(t(r).cache))))]),rn(Oe,()=>t(O),et=>f(O,et)),C("change",Oe,wt),Ql(yt,()=>t(lt).enabled,et=>Qr(lt,t(lt).enabled=et)),C("change",yt,()=>{f(j,!0),f(B,""),f(F,"")}),rn(ke,()=>t(lt).min_runs,et=>Qr(lt,t(lt).min_runs=et)),C("input",ke,()=>{f(j,!0),f(B,""),f(F,"")}),rn(ce,()=>t(lt).p95_ms,et=>Qr(lt,t(lt).p95_ms=et)),C("input",ce,()=>{f(j,!0),f(B,""),f(F,"")}),rn(Ee,()=>t(lt).error_rate_per_run,et=>Qr(lt,t(lt).error_rate_per_run=et)),C("input",Ee,()=>{f(j,!0),f(B,""),f(F,"")}),rn(zt,()=>t(lt).cache_delta_hit_rate,et=>Qr(lt,t(lt).cache_delta_hit_rate=et)),C("input",zt,()=>{f(j,!0),f(B,""),f(F,"")}),C("click",Ae,Wt),C("click",ji,tt),M(ne,Ue)},Ur=ne=>{var Ue=Ng();M(ne,Ue)};Z(ge,ne=>{t(a)&&!t(r)?ne(en):t(m)?ne(Sr,1):t(r)?ne(Ti,2):ne(Ur,!1)})}d(We),d(Bt),d(jt),rt(()=>cn.disabled=t(a)||t(s)),C("click",cn,()=>kt(!0)),C("click",ee,()=>i(!1)),C("click",Bt,ua(function(ne){bs.call(this,n,ne)})),C("keydown",Bt,ua(function(ne){bs.call(this,n,ne)})),C("click",jt,()=>i(!1)),C("keydown",jt,ne=>{(ne.key==="Enter"||ne.key===" "||ne.key==="Escape")&&(ne.preventDefault(),i(!1))}),M(mt,jt)};Z(ln,mt=>{i()&&mt(Mt)})}return M(e,xe),li(De)}const Bg="modulepreload",Dg=function(e){return"/"+e},Wu={},Lg=function(n,i,r){let a=Promise.resolve();if(i&&i.length>0){let k=function(b){return Promise.all(b.map(j=>Promise.resolve(j).then(B=>({status:"fulfilled",value:B}),B=>({status:"rejected",reason:B}))))};var m=k;document.getElementsByTagName("link");const g=document.querySelector("meta[property=csp-nonce]"),w=g?.nonce||g?.getAttribute("nonce");a=k(i.map(b=>{if(b=Dg(b),b in Wu)return;Wu[b]=!0;const j=b.endsWith(".css"),B=j?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${b}"]${B}`))return;const F=document.createElement("link");if(F.rel=j?"stylesheet":Bg,j||(F.as="script"),F.crossOrigin="",F.href=b,w&&F.setAttribute("nonce",w),document.head.appendChild(F),j)return new Promise((O,E)=>{F.addEventListener("load",O),F.addEventListener("error",()=>E(new Error(`Unable to preload CSS for ${b}`)))})}))}function s(g){const w=new Event("vite:preloadError",{cancelable:!0});if(w.payload=g,window.dispatchEvent(w),!w.defaultPrevented)throw g}return a.then(g=>{for(const w of g||[])w.status==="rejected"&&s(w.reason);return n().catch(s)})};let Mo=null,Fl=null;async function Rg(){try{return Fl?!0:(Mo=await Lg(()=>import("./chunk-wa_bridge.js"),[]),Mo?.default&&await Mo.default(),Fl=Mo?.WasmEditor??null,Fl?(console.log("已加载 Rust WASM 引擎"),!0):(console.warn("未找到 Rust WASM 入口：WasmEditor"),!1))}catch(e){return console.warn("Rust WASM 加载失败，回退到 contenteditable：",e),!1}}var qg=q('<div class="status-chip light svelte-13mrafj"> </div>'),Fg=q('<div class="status-chip light svelte-13mrafj"> </div>'),Og=q('<button class="btn ghost svelte-13mrafj">续跑</button>'),Pg=q('<div class="generation-banner svelte-13mrafj"> </div>'),Hg=q('<div class="generation-banner svelte-13mrafj"> <!> 。可点击“续跑”继续生成。</div>'),zg=q('<div class="failure-row svelte-13mrafj"><span> </span> <button class="btn ghost svelte-13mrafj">重试</button></div>'),Wg=q('<section class="section-failures svelte-13mrafj"><div class="panel-title svelte-13mrafj">失败章节</div> <!></section>'),Ug=q('<span class="feedback-tip svelte-13mrafj"> </span>'),Jg=q('<div class="plagiarism-evidence svelte-13mrafj"> </div>'),Gg=q('<div class="plagiarism-item svelte-13mrafj"><div class="plagiarism-item-head svelte-13mrafj"><span> </span> <span> </span></div> <div class="plagiarism-item-metrics svelte-13mrafj"><span> </span> <span> </span> <span> </span> <span> </span></div> <!> <div class="panel-sub svelte-13mrafj"> </div></div>'),Kg=q('<section class="feedback-panel ai-rate-panel svelte-13mrafj"><div class="feedback-panel-head svelte-13mrafj"><div><div class="panel-title svelte-13mrafj">AI 率检测</div> <div class="panel-sub svelte-13mrafj">基于 burstiness、重复率、词汇熵、连接词密度等信号估计。</div></div></div> <div class="feedback-form svelte-13mrafj"><div class="plagiarism-grid svelte-13mrafj"><label class="feedback-label" for="ai-rate-threshold">判定阈值</label> <input id="ai-rate-threshold" type="number" min="0.05" max="0.95" step="0.01" data-testid="ai-rate-threshold" class="svelte-13mrafj"/> <span class="panel-sub svelte-13mrafj">建议 0.65，结果仅作为风险提示</span></div> <div class="feedback-actions svelte-13mrafj"><button class="btn primary svelte-13mrafj" data-testid="ai-rate-run"> </button> <!></div> <!></div></section>'),Vg=q('<span class="feedback-tip svelte-13mrafj"> </span>'),Xg=q('<div class="plagiarism-report-actions svelte-13mrafj"><span class="panel-sub svelte-13mrafj"> </span> <button class="btn ghost svelte-13mrafj">下载 JSON</button> <button class="btn ghost svelte-13mrafj">下载 MD</button> <button class="btn ghost svelte-13mrafj">下载 CSV</button></div>'),Yg=q('<em class="svelte-13mrafj"> </em>'),Qg=q('<div class="plagiarism-evidence svelte-13mrafj"> </div>'),Zg=q('<div class="plagiarism-item svelte-13mrafj"><div class="plagiarism-item-head svelte-13mrafj"><span> <!></span> <span> </span></div> <div class="plagiarism-item-metrics svelte-13mrafj"><span> </span> <span> </span> <span> </span> <span> </span></div> <!></div>'),t_=q('<div class="plagiarism-results svelte-13mrafj"></div>'),e_=q('<section class="feedback-panel plagiarism-panel svelte-13mrafj"><div class="feedback-panel-head svelte-13mrafj"><div><div class="panel-title svelte-13mrafj">内容查重检测</div> <div class="panel-sub svelte-13mrafj">算法：n-gram + Winnowing + SimHash 混合评分，建议阈值 0.35。</div></div></div> <div class="feedback-form svelte-13mrafj"><div class="plagiarism-grid svelte-13mrafj"><label class="feedback-label" for="plag-threshold">判定阈值</label> <input id="plag-threshold" type="number" min="0.05" max="0.95" step="0.01" data-testid="plagiarism-threshold" class="svelte-13mrafj"/> <label class="feedback-label" for="plag-docids">参考文档ID</label> <input id="plag-docids" type="text" placeholder="多个ID用逗号或空格分隔" data-testid="plagiarism-docids" class="svelte-13mrafj"/></div> <div class="feedback-row svelte-13mrafj"><span class="feedback-label">参考文本</span> <textarea rows="4" maxlength="30000" placeholder="可粘贴外部资料、历史稿件或样本文本用于查重" data-testid="plagiarism-text" class="svelte-13mrafj"></textarea></div> <div class="feedback-actions svelte-13mrafj"><button class="btn primary svelte-13mrafj" data-testid="plagiarism-run"> </button> <button class="btn ghost svelte-13mrafj" data-testid="plagiarism-library-run"> </button> <!></div> <!> <!></div></section>'),n_=q('<button type="button"> </button>'),r_=q('<span class="feedback-tip svelte-13mrafj"> </span>'),i_=q('<div class="feedback-item-note svelte-13mrafj"> </div>'),s_=q('<div class="feedback-item svelte-13mrafj"><div class="feedback-item-head svelte-13mrafj"><span> </span> <span> </span></div> <!></div>'),a_=q('<div class="feedback-history svelte-13mrafj"><div class="panel-sub svelte-13mrafj">最近反馈</div> <!></div>'),o_=q('<section class="feedback-panel svelte-13mrafj"><div class="feedback-panel-head svelte-13mrafj"><div><div class="panel-title svelte-13mrafj">用户满意度</div> <div class="panel-sub svelte-13mrafj">1 分最低，5 分最高；低分样本会进入学习池。</div></div></div> <div class="feedback-form svelte-13mrafj"><div class="feedback-row svelte-13mrafj"><span class="feedback-label">评分</span> <div class="rating-group svelte-13mrafj"></div> <span class="feedback-label">阶段</span> <select data-testid="feedback-stage" class="svelte-13mrafj"><option>通用反馈</option><option>阶段1 生成</option><option>阶段2 修改</option><option>最终版本</option></select></div> <div class="feedback-row svelte-13mrafj"><span class="feedback-label">备注</span> <textarea data-testid="feedback-note" rows="2" maxlength="600" placeholder="可选：不满意点、缺失点、改进建议" class="svelte-13mrafj"></textarea></div> <div class="feedback-actions svelte-13mrafj"><button class="btn primary svelte-13mrafj" data-testid="feedback-submit"> </button> <!></div> <!></div></section>'),l_=q('<div class="panel-empty svelte-13mrafj">加载中...</div>'),c_=q('<div class="panel-empty svelte-13mrafj"> </div>'),u_=q('<div class="panel-empty svelte-13mrafj">暂无版本</div>'),f_=q('<div class="version-summary svelte-13mrafj"> </div>'),d_=q('<div class="version-summary svelte-13mrafj"> </div>'),v_=q('<div><div><div class="minor-title svelte-13mrafj"> </div> <!> <div class="minor-meta svelte-13mrafj"> </div></div> <div class="minor-actions svelte-13mrafj"><button class="btn ghost svelte-13mrafj">切换</button> <button class="btn ghost svelte-13mrafj">对比</button></div></div>'),p_=q('<div class="version-minors svelte-13mrafj"></div>'),m_=q('<div class="version-group"><div><div class="version-title svelte-13mrafj"><span> </span> <span> </span></div> <div class="version-meta svelte-13mrafj"><span> </span> <span> </span></div> <!> <div class="version-actions svelte-13mrafj"><button class="btn ghost svelte-13mrafj">切换</button> <button class="btn ghost svelte-13mrafj">对比</button></div></div> <!></div>'),h_=q('<div class="version-groups svelte-13mrafj"></div>'),g_=q('<div class="inline-selection-bar svelte-13mrafj" role="toolbar" aria-label="选中块快捷操作"><div class="inline-selection-meta svelte-13mrafj"> <span class="svelte-13mrafj">Ctrl/Cmd+Enter 下弹窗 · Ctrl/Cmd+Shift+Enter 上弹窗</span></div> <div class="inline-selection-actions svelte-13mrafj"><button class="mini-btn svelte-13mrafj">改写</button> <button class="mini-btn svelte-13mrafj">样式</button> <button class="mini-btn svelte-13mrafj">插表</button> <button class="mini-btn svelte-13mrafj">插图</button> <button class="mini-btn svelte-13mrafj">对话</button> <button class="mini-btn svelte-13mrafj">上方</button> <button class="mini-btn svelte-13mrafj">下方</button></div></div>'),__=q('<span class="selected-chip svelte-13mrafj"> </span>'),b_=q('<div class="block-error svelte-13mrafj"> </div>'),y_=q('<div class="inline-style-row compact svelte-13mrafj"><span>字体</span> <select class="svelte-13mrafj"><option>默认</option><option>宋体</option><option>黑体</option><option>微软雅黑</option><option>楷体</option><option>仿宋</option></select> <span>字号</span> <select class="svelte-13mrafj"><option>默认</option><option>12pt</option><option>14pt</option><option>16pt</option><option>18pt</option><option>20pt</option></select> <span>行距</span> <select class="svelte-13mrafj"><option>默认</option><option>1.2</option><option>1.5</option><option>1.75</option><option>2.0</option></select> <span>对齐</span> <select class="svelte-13mrafj"><option>默认</option><option>左对齐</option><option>居中</option><option>右对齐</option><option>两端对齐</option></select> <span>字重</span> <select class="svelte-13mrafj"><option>默认</option><option>常规</option><option>中等</option><option>半粗</option><option>加粗</option></select> <span>字形</span> <select class="svelte-13mrafj"><option>默认</option><option>正常</option><option>斜体</option></select> <span>文字色</span> <input type="text" placeholder="#1f2937" class="svelte-13mrafj"/> <span>背景色</span> <input type="text" placeholder="#ffffff" class="svelte-13mrafj"/></div> <div class="panel-empty svelte-13mrafj">样式栏会回显当前选中块的样式，修改仅作用于当前选区。</div>',1),w_=q('<div class="assistant-inline-tip svelte-13mrafj"><div>用于处理当前选中块的复杂语义修改。</div> <textarea class="inline-instruction svelte-13mrafj" placeholder="例如：将选中内容改成课程设计报告语气，并补全术语解释。"></textarea> <div class="assistant-inline-actions svelte-13mrafj"><button class="btn ghost svelte-13mrafj">同步到改写指令</button> <button class="btn ghost svelte-13mrafj">发到右下角全局助手</button></div></div>'),x_=q('<div class="panel-empty svelte-13mrafj">当前选区包含标题，请直接编辑标题或切到“样式设置”。</div>'),S_=q('<div class="inline-preset-row svelte-13mrafj"><button class="preset-chip svelte-13mrafj">更正式</button> <button class="preset-chip svelte-13mrafj">更简洁</button> <button class="preset-chip svelte-13mrafj">更详细</button> <button class="preset-chip svelte-13mrafj">保留术语</button></div> <div class="inline-ai-row svelte-13mrafj"><textarea class="inline-instruction svelte-13mrafj" placeholder="例如：仅重写选中段落，语气更正式，减少20%字数。"></textarea></div> <div class="inline-action-row svelte-13mrafj"><button class="btn ghost svelte-13mrafj">切到改动对话</button> <button class="btn primary svelte-13mrafj"> </button></div> <!>',1),k_=q('<div class="block-error svelte-13mrafj"> </div>'),$_=q('<button><span class="svelte-13mrafj"> </span> <span class="svelte-13mrafj"> </span></button>'),T_=q('<div class="candidate-card svelte-13mrafj"><div class="candidate-head svelte-13mrafj"><span> </span> <span class="candidate-meta svelte-13mrafj"> </span></div> <div class="candidate-actions svelte-13mrafj"><button class="btn primary svelte-13mrafj">采纳到正文</button> <button class="btn ghost svelte-13mrafj">重新生成</button> <button class="btn ghost danger svelte-13mrafj">忽略建议</button></div> <div class="candidate-label svelte-13mrafj">建议文本</div> <div class="candidate-text svelte-13mrafj"> </div></div>'),j_=q('<div class="candidate-compare compact svelte-13mrafj"><div class="candidate-before svelte-13mrafj"><div class="candidate-label svelte-13mrafj">原文</div> <div class="candidate-text svelte-13mrafj"> </div></div> <div class="candidate-panel svelte-13mrafj"><div class="candidate-switches svelte-13mrafj"></div> <!></div></div>'),E_=q('<section aria-label="选中内容修改窗口"><div class="inline-popover-head svelte-13mrafj"><div><div class="panel-title svelte-13mrafj">选中内容轻量修改</div> <div class="panel-sub svelte-13mrafj">当前上下文独立于其他段落块，同一块会继承修改上下文。</div></div> <div class="inline-popover-head-actions svelte-13mrafj"><button class="btn ghost btn-sm svelte-13mrafj">插表</button> <button class="btn ghost btn-sm svelte-13mrafj">插图</button> <button class="btn ghost btn-sm svelte-13mrafj">上方</button> <button class="btn ghost btn-sm svelte-13mrafj">下方</button> <button class="btn ghost btn-sm svelte-13mrafj">关闭</button></div></div> <div class="inline-tabs svelte-13mrafj"><button>改写建议</button> <button>样式设置</button> <button>改动对话</button></div> <div class="selected-targets svelte-13mrafj"></div> <!> <!> <!> <!> <!> <!></section>'),A_=q('<span class="assistant-queue-badge svelte-13mrafj"> </span>'),C_=q('<div class="confirm-overlay svelte-13mrafj" role="dialog" aria-modal="true" aria-label="高风险编辑确认"><section class="confirm-dialog svelte-13mrafj"><div class="panel-title svelte-13mrafj">检测到高风险编辑</div> <div class="panel-sub svelte-13mrafj"> </div> <div class="confirm-note svelte-13mrafj"> </div> <div class="confirm-actions svelte-13mrafj"><button class="btn ghost svelte-13mrafj">取消</button> <button class="btn primary danger svelte-13mrafj"> </button></div></section></div>'),I_=q("<!> <!> <!> <!>",1),N_=q('<main><header class="topbar svelte-13mrafj"><div class="brand svelte-13mrafj"><div class="logo svelte-13mrafj">IR</div> <div class="brand-text"><div class="brand-title svelte-13mrafj">写作引擎</div> <div class="brand-sub svelte-13mrafj">Doc IR · 语义写作</div></div></div> <nav class="menu svelte-13mrafj"><button class="menu-item svelte-13mrafj">概览</button> <button class="menu-item svelte-13mrafj">模板</button> <button class="menu-item svelte-13mrafj">协作</button> <button class="menu-item svelte-13mrafj">历史</button> <button class="menu-item svelte-13mrafj">帮助</button></nav> <div class="top-actions svelte-13mrafj"><div class="status-chip svelte-13mrafj"><span class="dot svelte-13mrafj"></span> <span> </span></div> <div class="status-chip light svelte-13mrafj"> </div> <!> <!> <button class="btn ghost svelte-13mrafj">保存</button> <button class="btn ghost svelte-13mrafj">导出 Word</button> <button class="btn ghost svelte-13mrafj">导出 PDF</button> <button class="btn ghost svelte-13mrafj" data-testid="ai-rate-toggle"> </button> <button class="btn ghost svelte-13mrafj" data-testid="plagiarism-toggle"> </button> <button class="btn ghost svelte-13mrafj" data-testid="feedback-toggle"> </button> <!></div></header> <div class="workspace svelte-13mrafj"><aside class="nav-rail svelte-13mrafj"><button class="nav-btn active svelte-13mrafj" title="文档"><span>文档</span></button> <button class="nav-btn svelte-13mrafj" title="画布"><span>画布</span></button> <button class="nav-btn svelte-13mrafj" title="引用"><span>引用</span></button> <button class="nav-btn svelte-13mrafj" title="性能"><span>性能</span></button> <button class="nav-btn svelte-13mrafj" title="文档库"><span>文档库</span></button></aside> <section class="doc-area svelte-13mrafj"><div class="doc-toolbar svelte-13mrafj"><div class="toolbar-line svelte-13mrafj"><div class="toolbar-cluster svelte-13mrafj"><span class="cluster-label svelte-13mrafj">文本</span> <button class="tool-btn svelte-13mrafj" title="撤销 Ctrl/Cmd+Z">↶</button> <button class="tool-btn svelte-13mrafj" title="重做 Ctrl/Cmd+Y">↷</button> <button class="tool-btn svelte-13mrafj" title="复制 Ctrl/Cmd+C">复制</button> <button class="tool-btn svelte-13mrafj" title="剪切 Ctrl/Cmd+X">剪切</button> <button class="tool-btn svelte-13mrafj" title="粘贴 Ctrl/Cmd+V">粘贴</button> <button class="tool-btn svelte-13mrafj" title="清除格式">Tx</button> <span class="tool-sep svelte-13mrafj"></span> <button title="加粗 Ctrl/Cmd+B">B</button> <button title="斜体 Ctrl/Cmd+I">I</button> <button title="下划线 Ctrl/Cmd+U">U</button></div> <div class="toolbar-cluster svelte-13mrafj"><span class="cluster-label svelte-13mrafj">结构</span> <button class="tool-btn svelte-13mrafj">H1</button> <button class="tool-btn svelte-13mrafj">H2</button> <button class="tool-btn svelte-13mrafj">引用</button> <button class="tool-btn svelte-13mrafj">代码</button> <button class="tool-btn svelte-13mrafj">列表</button> <button class="tool-btn svelte-13mrafj">1.</button></div> <div class="toolbar-cluster svelte-13mrafj"><span class="cluster-label svelte-13mrafj">插入</span> <button class="tool-btn svelte-13mrafj">画布</button> <button class="tool-btn svelte-13mrafj">引用</button></div> <div class="toolbar-cluster compact svelte-13mrafj"><span class="cluster-label svelte-13mrafj">智能写作</span> <button class="btn ghost svelte-13mrafj">生成</button> <button class="btn ghost svelte-13mrafj">停止</button> <!></div></div></div> <!> <!> <!> <!> <!> <!> <div class="doc-stage svelte-13mrafj"><!></div></section> <aside class="side-panel svelte-13mrafj"><div class="panel-card version-panel svelte-13mrafj"><div class="panel-header svelte-13mrafj"><div><div class="panel-title svelte-13mrafj">版本树</div> <div class="panel-sub svelte-13mrafj">自动小版本 · 手动大版本</div></div> <button class="icon-btn svelte-13mrafj" title="刷新">刷新</button></div> <div class="major-commit svelte-13mrafj"><input class="version-input svelte-13mrafj" placeholder="输入版本说明"/> <button class="btn primary svelte-13mrafj">保存版本</button></div> <!> <div class="version-diff svelte-13mrafj"><div class="panel-sub svelte-13mrafj">对比结果</div> <pre class="svelte-13mrafj"> </pre></div></div></aside></div> <!> <!> <div><button class="assistant-toggle svelte-13mrafj"> <!></button> <!></div> <input class="hidden-input svelte-13mrafj" type="file" accept="image/*"/> <!> <!></main> <!> <!>',1);function pd(e,n){if(new.target)return mi({component:pd,...e});oi(n,!1);const i=()=>Qn(vs,"$generating",F),r=()=>Qn(yr,"$sourceText",F),a=()=>Qn(Lr,"$docIr",F),s=()=>Qn(Ms,"$docId",F),m=()=>Qn(Dr,"$docStatus",F),g=()=>Qn(Ps,"$flowStatus",F),w=()=>Qn($c,"$wordCount",F),k=()=>Qn(zs,"$instruction",F),b=()=>Qn(Yn,"$docIrDirty",F),j=()=>Qn(Ru,"$darkMode",F),B=()=>Qn(Ja,"$isLoading",F),[F,O]=Oa();let E=null,P="",dt=null,U=null,lt=!1,Tt=W(!1),wt=[],Nt=null,Wt=0,tt=0,Et=!1,kt=W(!1),Jt=null,de=null,De=0,xe="",ln="",Mt=!1,mt=!1,jt=!1,Bt=0,Kt=0,vn=0,cn=9e4,Le=null,bt=!1,At=W({current:0,total:0,percent:0,etaS:0,section:""}),ee=0,We=[],ge=W([]),en=W(null),Sr=W(!1),Ti=!1,Ur=W(null),ne=null,Ue=!1,An="",tr=W(""),or=null,Lt=W(null),Ri=W(!1),X=W(!1),ht=W(!1),Ut=W(!1),Se=W([]),vr=W(0),er=W("general"),On=W(""),_n=W(!1),Re=W(0),un=W(!1),bn=W(!1),Ye=W(!1),pr=W(.35),ei=W(""),sn=W(""),kr=W(!1),Pn=W(!1),Fr=W(.65),Yt=W(null),yn=W([]),$r=W(0),Hn=W(0),Rt=W(null),ve=W(!1),an=[],Ze=W([]),Qt=W(""),qe=W(""),pe=W(""),wn=W(!0),zn=W(!1),Fe="",qt=W([]),ye=W([]),je=W(""),Oe=W(""),Je=W(""),nr=W(""),yt=W(""),re=W(""),ke=W(""),le=W(""),ce=W(""),Ht=W(""),Ee=W("rewrite"),Or=W(!1),zt=W(""),Cn=W(""),Ae=W([]),Wn=W(0),Tr=W(null),ci=W("");const ji=new Map;let Ei="",ni=W(!1),qi=W(0),ui=W(0),Qe=W(!1),rr=W("down"),Jr=W(0),xn=W(0),Pe=W([]),Un=W([]),ue=W(!1),Sn=W(""),Jn=W(null),_e=[],jr=Date.now(),Zt=W({focused:!1,readonly:!1,bold:!1,italic:!1,underline:!1,hasSelection:!1,canUndo:!1,canRedo:!1,canCopy:!1,canCut:!1,canPaste:!1}),Fi=0,In=W([]),Oi=!1,Ce=null;typeof window<"u"&&document.body.setAttribute("data-engine","rust");function nn(){return Ce||(Ce=Rg().then(l=>l).catch(()=>!1)),Ce}function Gn(){const l=window;if(l.__DOC_ID__)return String(l.__DOC_ID__);const c=document.body?.getAttribute("data-doc-id");return c||document.querySelector('meta[name="doc-id"]')?.getAttribute("content")||""}function kn(){if(!De)return new Date().toLocaleTimeString();const l=Date.now()-De,c=Math.max(0,Math.floor(l/1e3)),y=String(Math.floor(c/60)).padStart(2,"0"),x=String(c%60).padStart(2,"0");return`+${y}:${x}`}function Ai(l){const c=(l||"").toUpperCase();return c==="PLAN"?"规划":c==="WRITE"?"写作":c==="DONE"?"完成":c==="STOPPED"?"已停止":l}function cs(l){return hn(String(l||"")).trim().replace(/^#+\s*/,"").replace(/^h[23]::/i,"").replace(/\s+/g,"").replace(/[：:，,。.!?？；;、（）()【】\[\]《》"'“”‘’]/g,"").toLowerCase()}function Gr(){return i()||t(Tt)||t(kt)}function Yi(l){const c=String(l||"").trim();return c?c.replace(/[`~*#>\-\[\]\(\)_=|]/g,"").replace(/\s+/g,"").replace(/[，。！？；：,.!?;:]/g,"").length>=8:!1}function Rn(l){const c=String(l||"").trim();return c?/(?:全文|整篇|整文|全部|从头).{0,4}(?:重写|改写)|覆盖重写|推倒重写|重新写一份|(?:rewrite|redo|start over|from scratch|replace).{0,14}(?:entire|whole|full|document|draft)|(?:entire|whole|full).{0,14}(?:rewrite|redo|replace)|overwrite(?:\s+the)?(?:\s+whole|\s+entire|\s+full)?(?:\s+document|\s+draft)?/i.test(c)?"overwrite":/(?:续写|接着写|继续写|接续写|在原文基础上继续|延续写|(?:continue|keep writing|carry on|extend|add more|build on).{0,14}(?:current|existing|draft|document|text|content)?|(?:based on|on top of)\s+(?:the\s+)?(?:existing|current))/i.test(c)?"continue":null:null}function Er(l){if(!Array.isArray(l))return[];const c=[],y=new Set;for(const x of l){const $=String(x||"").trim();!$||y.has($)||(y.add($),c.push($))}return c}function Qi(l){if(!l||typeof l!="object")return null;const c=String(l.status||"").trim().toLowerCase();if(c!=="running"&&c!=="interrupted")return null;const y=String(l.compose_mode||"auto").trim().toLowerCase(),x=y==="continue"||y==="overwrite"||y==="auto"?y:"auto";return{status:c,updated_at:Number(l.updated_at||0),user_instruction:String(l.user_instruction||"").trim(),request_instruction:String(l.request_instruction||"").trim(),compose_mode:x,partial_chars:Number(l.partial_chars||0),partial_preview:String(l.partial_preview||"").trim(),plan_sections:Er(l.plan_sections),completed_sections:Er(l.completed_sections),pending_sections:Er(l.pending_sections),cursor_anchor:String(l.cursor_anchor||"").trim(),error:String(l.error||"").trim()}}function fi(){const l=[],c=new Set;for(const y of t(ye)){const x=cs(y.sectionTitle||y.sectionId||"");!x||c.has(x)||(c.add(x),l.push(x))}return l}function Ci(l,c){const y=cs(l);if(y){if(c==="start"){t(Pe).includes(y)||f(Pe,[...t(Pe),y]);return}c==="end"&&(f(Pe,t(Pe).filter(x=>x!==y)),t(Un).includes(y)||f(Un,[...t(Un),y]))}}function te(){f(Pe,[]),f(Un,[])}function Ar(){if(!Gr())return!0;if(!i())return!1;const l=fi();return l.length?l.every(c=>t(Un).includes(c)&&!t(Pe).includes(c)):!1}function pn(l){if(Ar())return!0;const c=t(Sn)||`生成中，暂不支持${l}`;return f(zt,c),pt(c,"info"),!1}function Pr(l){const c={id:++Fi,text:l,createdAt:Date.now()};f(In,[...t(In),c].slice(-20)),Br("system",`当前正在生成，已加入待执行队列（${t(In).length}）`),pt(`已排队（${t(In).length}）`,"info"),queueMicrotask(()=>{di()})}async function di(){if(Oi||!t(In).length)return;Oi=!0;let l=0,c=!1;try{for(;t(In).length;){if(Gr()){l||(l=Date.now());const $=Date.now()-l;!i()&&(t(Tt)||t(kt))&&!wt.length&&Jt===null&&Date.now()-jr>2500?(us(),c||(pt("检测到渲染状态卡住，已自动恢复并继续执行排队指令。","info"),c=!0)):$>15e4&&(vs.set(!1),us(),c||(pt("排队指令等待超时，已强制恢复并继续。","info"),c=!0)),await new Promise(N=>setTimeout(N,100));continue}l=0;const[y,...x]=t(In);f(In,x),Br("system",`开始执行排队指令（剩余 ${t(In).length}）`),await go(y.text,{fromQueue:!0})}}finally{Oi=!1}}function Ii(l){const c=String(l||"");c.trim()&&(c.length<8&&!/[\w\u4e00-\u9fa5]/.test(c)||(jr=Date.now(),P+=c,dt&&clearTimeout(dt),dt=setTimeout(()=>{const y=P.slice(-120);Wr("写作",y,kn()),P="",dt=null},500)))}function Ni(l,c){if(!c&&!lt&&!t(Tt))return;const y=String(l??r()??"");U&&clearTimeout(U),U=setTimeout(()=>{if(!c&&!lt&&!t(Tt))return;const x=ic(y);if(x){const $=Vr(x);Lr.set($),Yn.set(!1)}},120)}function us(){wt=[],tt=0,Et=!1,f(kt,!1),Jt=null,de=null,Wt+=1,f(Tt,!1),Nt&&(clearTimeout(Nt),Nt=null)}function Ls(){let l=26,c=14;return tt>1600?(l=120,c=6):tt>700?(l=72,c=8):tt>260&&(l=46,c=11),Et&&(l=Math.max(l,140),c=Math.min(c,5)),{chunk:l,delayMs:c}}function Mi(l,c,y){yr.update(x=>{const $=String(x||""),T=y?$+c:va($,l,c);return Ni(T),T}),dn(),Ii(c)}function Xs(l){if(l!==Wt)return;if(!wt.length){f(kt,!1),Et=!1,Jt!==null&&(Xt(Jt,de),Jt=null,de=null),f(Tt,!1);return}const c=wt[0],y=Ls(),x=c.text.slice(0,y.chunk);c.text=c.text.slice(x.length),tt=Math.max(0,tt-x.length),c.text||wt.shift(),x&&Mi(c.section,x,c.raw),Nt=setTimeout(()=>Xs(l),y.delayMs)}function et(){if(t(kt)||!wt.length)return;f(kt,!0),f(Tt,!0);const l=++Wt;Xs(l)}function ut(l,c,y){const x=String(c||"");x&&(wt.push({section:String(l||""),raw:!!y?.raw,text:x}),tt+=x.length,et())}function Xt(l,c){const y=String(l||"");if(jr=Date.now(),yr.set(y),c&&typeof c=="object"){const x=Vr(c);Lr.set(x),Yn.set(!1)}else{const x=ic(y);if(x){const $=Vr(x);Lr.set($),Yn.set(!1)}else Lr.set(null),Yn.set(!0)}}function Dt(l,c){if(Jt=String(l||""),de=c||null,!wt.length&&!t(kt)){Xt(Jt,de),Jt=null,de=null;return}Et=!0,et()}let fe=0;async function mn(l,c){const y=++fe,x=Math.max(10,c?.chunk??36),$=Math.max(10,c?.delayMs??18);f(Tt,!0),Yn.set(!0),yr.set("");try{let T=0;for(;T<l.length;){if(y!==fe)return;const N=l.slice(T,T+x);jr=Date.now(),yr.update(V=>{const G=String(V||"")+N;return Ni(G),G}),Ii(N),T+=x,await new Promise(V=>setTimeout(V,$))}if(y!==fe)return;if(c?.finalDocIr&&typeof c.finalDocIr=="object"){const N=Vr(c.finalDocIr);Lr.set(N),Yn.set(!1)}else Ni(l,!0)}finally{y===fe&&f(Tt,!1)}}function ie(l,c,y){let x=String(l||"").replace(/\r/g,"");/^#\s+/m.test(x)||(x=`# ${c||"自动生成文档"}

`+x.trimStart());for(const $ of y||[]){const T=hn(String($||"").trim());if(!T)continue;new RegExp(`^##\\s+${T.replace(/[.*+?^${}()|[\]\\\\]/g,"\\\\$&")}\\s*$`,"m").test(x)||(x=(x.trimEnd()+`

## ${T}

`).replace(/\n{4,}/g,`

`))}return x}function hn(l){const c=String(l||"").trim(),y=/^H[23]::(.*)$/.exec(c);return(y?y[1]:c).trim()}function Kn(l){return l.replace(/[.*+?^${}()|[\]\\/]/g,"\\$&")}const ir="sec:",lr="doc:title";function me(l){return String(l||"").startsWith(ir)}function mr(l){return String(l||"")===lr}function cr(l){return me(l)?String(l||"").slice(ir.length).trim():""}function _i(l){const c=String(l||"").trim();return!c||me(c)||mr(c)?"":c}function Cr(l){return(l||[]).map(c=>_i(c)).filter(Boolean)}function bi(l){return(l||[]).map(c=>cr(c)).filter(Boolean)}function Ir(l){const c=String(l||"").trim().toLowerCase();if(!c)return"";if(/^#([0-9a-f]{3})$/.test(c)){const T=c.slice(1);return`#${T[0]}${T[0]}${T[1]}${T[1]}${T[2]}${T[2]}`}if(/^#([0-9a-f]{6})$/.test(c))return c;const y=/^rgba?\(([^)]+)\)$/.exec(c);if(!y)return"";const x=y[1].split(",").map(T=>Number(T.trim())).filter(T=>Number.isFinite(T));return x.length<3?"":`#${x.slice(0,3).map(T=>Math.max(0,Math.min(255,Math.round(T))).toString(16).padStart(2,"0")).join("")}`}function yi(l){return(l||[]).map(c=>({...c}))}function Kr(l){return(l||[]).map(c=>String(c||"").trim()).filter(Boolean).sort().join("|")}function Bi(){Ei&&ji.set(Ei,{tab:t(Ee),cmd:t(Ht),styleFontSize:t(Oe),styleLineHeight:t(Je),styleFontFamily:t(nr),styleColor:t(yt),styleBackground:t(re),styleAlign:t(ke),styleFontWeight:t(le),styleFontStyle:t(ce),candidates:yi(t(Ae)),activeIndex:t(Wn),originalText:t(Cn),error:t(zt),dialogInput:t(ci)})}function Zi(l){f(Ee,l.tab||"rewrite"),f(Ht,String(l.cmd||"")),f(Oe,String(l.styleFontSize||"")),f(Je,String(l.styleLineHeight||"")),f(nr,String(l.styleFontFamily||"")),f(yt,Ir(l.styleColor||"")),f(re,Ir(l.styleBackground||"")),f(ke,String(l.styleAlign||"")),f(le,String(l.styleFontWeight||"")),f(ce,String(l.styleFontStyle||"")),f(Ae,yi(l.candidates||[])),f(Wn,Number.isFinite(l.activeIndex)?Math.max(0,l.activeIndex):0),f(Cn,String(l.originalText||t(je)||"")),f(zt,String(l.error||"")),f(ci,String(l.dialogInput||""))}function Pi(l){f(Ee,"rewrite"),f(Oe,String(l.fontSize||"")),f(Je,String(l.lineHeight||"")),f(nr,String(l.fontFamily||"")),f(yt,Ir(String(l.color||""))),f(re,Ir(String(l.background||l.backgroundColor||""))),f(ke,String(l.align||l.textAlign||"")),f(le,String(l.fontWeight||"")),f(ce,String(l.fontStyle||"")),f(Ht,""),f(Or,!1),f(zt,""),f(Cn,t(je)),f(Ae,[]),f(Wn,0),f(ci,"")}function wi(l,c,y){return Math.min(y,Math.max(c,l))}function Vn(l){const c=(l||[]).map(G=>String(G||"").trim()).filter(Boolean);if(!c.length)return null;const y=document.querySelector(".editable");if(!y)return null;let x=Number.POSITIVE_INFINITY,$=Number.POSITIVE_INFINITY,T=0,N=0,V=0;for(const G of c){let J=null;if(me(G)){const nt=cr(G);if(nt){const Y=`[data-section-id="${CSS.escape(nt)}"]`;J=y.querySelector(Y)}}else if(mr(G))J=y.querySelector('.wa-title[data-doc-title="1"]');else{const nt=_i(G);if(nt){const Y=`[data-block-id="${CSS.escape(nt)}"]`;J=y.querySelector(Y)}}if(!J)continue;const vt=J.getBoundingClientRect();x=Math.min(x,vt.left),$=Math.min($,vt.top),T=Math.max(T,vt.right),N=Math.max(N,vt.bottom),V+=1}return V?{left:x,top:$,right:T,bottom:N,width:Math.max(0,T-x),height:Math.max(0,N-$)}:null}function we(){if(!t(qt).length){f(ni,!1),f(Qe,!1);return}const l=Vn(t(qt));if(!l){f(ni,!1),f(Qe,!1);return}const c=Math.min(560,window.innerWidth-24);f(qi,wi(l.left,12,Math.max(12,window.innerWidth-c-12))),f(ui,wi(l.bottom+10,72,Math.max(72,window.innerHeight-56))),f(ni,!0);const y=Math.min(720,window.innerWidth-24);f(Jr,wi(l.left,12,Math.max(12,window.innerWidth-y-12))),f(xn,t(rr)==="up"?wi(t(ui)-10,92,Math.max(92,window.innerHeight-80)):wi(t(ui)+50,92,Math.max(92,window.innerHeight-80)))}function hr(l,c="down"){if(t(qt).length){if(t(Qe)&&t(Ee)===l&&t(rr)===c){f(Qe,!1);return}f(Ee,l),f(rr,c),f(Qe,!0),we()}}function vi(){f(Qe,!1)}function Hi(l){if(t(Qe)&&t(Ee)===l){f(Qe,!1);return}f(Ee,l),t(Qe)||(f(Qe,!0),we())}function zi(l){const c=l.detail||{};if(c.docIr&&typeof c.docIr=="object"){const y=Vr(c.docIr);Lr.set(y),Yn.set(!1),or=y}if(c.text){const y=String(c.text||"");yr.set(y),f(tr,y)}c.meta&&c.meta.action&&pt("Block updated","ok")}function Ss(l){const c=l.detail&&typeof l.detail=="object"?l.detail:{};f(Zt,{focused:!!c.focused,readonly:!!c.readonly,bold:!!c.bold,italic:!!c.italic,underline:!!c.underline,hasSelection:!!c.hasSelection,canUndo:!!c.canUndo,canRedo:!!c.canRedo,canCopy:!!c.canCopy,canCut:!!c.canCut,canPaste:!!c.canPaste})}function Xo(l){const c=l.detail||{},y=Array.isArray(c.blockIds)?c.blockIds.map(J=>String(J||"").trim()).filter(Boolean):[],x=String(c.blockId||""),$=y.length?y:x?[x]:[],T=Kr($),N=Ei;if(!$.length&&t(qt).length){const J=document.activeElement;if(J&&(J.closest(".inline-edit-popover")||J.closest(".inline-selection-bar")||J.closest(".block-dialog")))return}N&&N!==T&&Bi();const V=Array.isArray(c.blocks)?c.blocks.map(J=>({id:String(J?.id||"").trim(),text:String(J?.text||""),style:J?.style&&typeof J.style=="object"?J.style:{},kind:["block","section","title"].includes(String(J?.kind||""))?String(J?.kind||""):"block",sectionId:String(J?.sectionId||"").trim(),sectionTitle:String(J?.sectionTitle||"").trim()})).filter(J=>J.id):[];f(qt,$),f(ye,V.length?V:$.map(J=>({id:J,text:String(c.text||""),style:{},kind:"block",sectionId:"",sectionTitle:""}))),Fe=$[0]||"",f(je,t(ye).length>1?t(ye).map((J,vt)=>`[块${vt+1}] ${J.text}`.trim()).join(`

`):String(c.text||""));const G=c.style&&typeof c.style=="object"?c.style:{};if(f(nr,String(G.fontFamily||"")),f(Oe,String(G.fontSize||"")),f(Je,String(G.lineHeight||"")),f(yt,Ir(String(G.color||""))),f(re,Ir(String(G.background||G.backgroundColor||""))),f(ke,String(G.align||G.textAlign||"")),f(le,String(G.fontWeight||"")),f(ce,String(G.fontStyle||"")),!$.length){Ei="",f(ni,!1),f(Qe,!1),f(Cn,""),f(Ae,[]),f(Wn,0),f(zt,"");return}if(T!==N){const J=ji.get(T);J?Zi(J):Pi(G),Ei=T}f(Cn,t(Cn)||t(je)),requestAnimationFrame(()=>we())}function Yo(l,c,y){const x=new Set((c||[]).map(J=>String(J||"").trim()).filter(Boolean));if(!x.size)return null;const $=Array.isArray(l.sections)?l.sections:[];let T=!1;const N=J=>{const vt={...J};for(const[nt,Y]of Object.entries(y)){const ft=String(Y||"").trim();ft?vt[nt]=ft:delete vt[nt]}return vt},V=J=>{let vt=!1;const Y=(Array.isArray(J?.blocks)?J.blocks:[]).map(St=>{if(!x.has(String(St?.id||"")))return St;vt=!0,T=!0;const Ge=St?.style&&typeof St.style=="object"?St.style:{};return{...St,style:N(Ge)}}),ft=Array.isArray(J?.children)?J.children:[],ot=ft.map(St=>V(St)),xt=ot.some((St,Ge)=>St!==ft[Ge]);if(!vt&&!xt)return J;const $t={...J};return vt&&($t.blocks=Y),xt&&($t.children=ot),$t},G=$.map(J=>V(J));return T?{...l,sections:G}:null}function o(l,c,y){const x=new Set((c||[]).map(J=>String(J||"").trim()).filter(Boolean));if(!x.size)return null;const $=Array.isArray(l.sections)?l.sections:[];let T=!1;const N=J=>{const vt={...J};for(const[nt,Y]of Object.entries(y)){const ft=String(Y||"").trim();ft?vt[nt]=ft:delete vt[nt]}return vt},V=J=>{let vt=!1,nt=J;const Y=String(J?.id||"").trim();if(Y&&x.has(Y)){const $t=J?.style&&typeof J.style=="object"?J.style:{};nt={...nt,style:N($t)},vt=!0}const ft=Array.isArray(J?.children)?J.children:[],ot=ft.map($t=>V($t));return ot.some(($t,St)=>$t!==ft[St])&&(nt={...nt,children:ot},vt=!0),vt&&(T=!0),vt?nt:J},G=$.map(J=>V(J));return T?{...l,sections:G}:null}function p(l,c){const y=l.title_style,x=y&&typeof y=="object"?{...y}:{};let $=!1;for(const[T,N]of Object.entries(c)){const V=String(N||"").trim();V?String(x[T]||"")!==V&&(x[T]=V,$=!0):T in x&&(delete x[T],$=!0)}return $?{...l,title_style:x}:null}function h(l){if(!pn("修改当前选中块"))return;const c=t(qt).length?t(qt):Fe?[Fe]:[];if(!c.length||!a())return;const y=Cr(c),x=bi(c),$=c.includes(lr);let T=a(),N=!1;if(y.length){const V=Yo(T,y,l);V&&(T=V,N=!0)}if(x.length){const V=o(T,x,l);V&&(T=V,N=!0)}if($){const V=p(T,l);V&&(T=V,N=!0)}N&&(_t(T),requestAnimationFrame(()=>we()),ri().catch(()=>{}))}function S(){return t(qt).length?t(qt).slice():Fe?[Fe]:[]}function A(){return Cr(S())}function I(){const l=S();return l.length?A().length!==l.length:!1}function H(){return t(ye).length>1?t(ye).map((l,c)=>`[块${c+1}] ${l.text}`.trim()).join(`

`):t(ye).length===1?String(t(ye)[0].text||""):t(je).trim()}function L(l){f(Ee,"assistant"),f(wn,!0);const c=S(),y=H(),x=String(l||"").trim();if(y&&c.length>0){const T=c.some(N=>me(N)||mr(N))?"请只修改我选中的标题或段落，不要改其他部分。":c.length>1?`请只修改我选中的 ${c.length} 个段落块，不要改其他段落。`:"请只修改我选中的这段内容，不要改其他段落。";zs.set(`${T}
${y}

修改要求：${x}`)}queueMicrotask(()=>{const $=document.querySelector(".assistant-dock .composer textarea");$&&$.focus()})}async function K(){if(!pn("生成块改写候选"))return;const l=S(),c=A();if(!s()||!l.length)return;if(!c.length){f(zt,"当前选中为标题，建议在“样式设置”中修改，或直接在标题处输入。");return}if(c.length!==l.length){f(zt,"标题与正文混选时暂不支持候选生成，请只选段落块。");return}const y=t(Ht).trim();if(y){f(Or,!0),f(zt,""),f(Ae,[]);try{if(!a()||typeof a()!="object")throw new Error("文档尚未就绪");const x=a();if(f(Cn,H()),c.length===1){const $={block_id:c[0],instruction:y};a()&&($.doc_ir=a());const T=await fetch(`/api/doc/${s()}/block-edit/preview`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify($)});if(!T.ok)throw new Error(await T.text());const N=await T.json();f(Cn,String(N.before||t(je)||""));const V=Array.isArray(N.candidates)?N.candidates:[];f(Ae,V.filter(G=>G&&typeof G=="object"&&G.doc_ir&&!G.error).map((G,J)=>({label:String(G.label||`方案${J+1}`),selectedAfter:it(String(G.selected_after||""),t(Cn)),selectedBefore:String(G.selected_before||t(Cn)||""),docIr:G.doc_ir,diff:G.diff})))}else{const $=[{label:"方案A",instruction:y},{label:"方案B",instruction:`${y}。请采用另一种表达方式，保持原意但在句式和组织上有明显差异。`}],T=[];for(const N of $){let V=JSON.parse(JSON.stringify(x));const G=[],J=[];for(const vt of c){const nt={block_id:vt,instruction:N.instruction,doc_ir:V,variants:[{label:N.label,instruction:N.instruction}]},Y=await fetch(`/api/doc/${s()}/block-edit/preview`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(nt)});if(!Y.ok)throw new Error(await Y.text());const ft=await Y.json(),ot=Array.isArray(ft.candidates)?ft.candidates[0]:null;if(!ot||!ot.doc_ir)throw new Error(`未生成可用候选：${N.label}`);const xt=String(ft.before||""),$t=it(String(ot.selected_after||""),xt);xt&&G.push(xt),$t&&J.push($t),V=ot.doc_ir}T.push({label:N.label,selectedAfter:J.join(`

`),selectedBefore:G.join(`

`)||t(Cn),docIr:V,diff:""})}f(Ae,T)}if(!t(Ae).length)throw new Error("没有生成可用候选版本");f(Wn,0)}catch(x){f(zt,x instanceof Error?x.message:"候选生成失败")}finally{f(Or,!1)}}}function R(l){const c=t(Ht).trim();f(Ht,c?`${c}；${l}`:l),f(Ee,"rewrite")}function z(l){if(t(qt).length){if((l.ctrlKey||l.metaKey)&&l.key==="Enter"){l.preventDefault();const c=l.shiftKey?"up":"down";hr(t(Ee),c);return}l.key==="Escape"&&t(Qe)&&f(Qe,!1)}}function it(l,c){const y=String(l||"").trim();if(!y)return"";const x=String(c||"").trim();let $=y.replace(/^\s*```[a-zA-Z0-9_-]*\s*/g,"").replace(/\s*```\s*$/g,"").trim();const T=/(?:改写后(?:的)?(?:文本|版本)?|优化后(?:的)?(?:文本|版本)?|重写后(?:的)?(?:文本|版本)?|润色后(?:的)?(?:文本|版本)?|rewritten\s*text|revised\s*version|final\s*version)\s*[:：]\s*/gi;let N=null;for(;;){const G=T.exec($);if(!G)break;N=G}if(N&&N.index>=0&&($=$.slice(N.index+N[0].length).trim()),x&&$.startsWith(x)){const G=$.slice(x.length).replace(/^[\s:：\-—]+/,"");G.length>=4&&($=G)}const V=$.split(/\n{2,}/).map(G=>G.trim()).filter(Boolean);if(x&&V.length>=2){const G=V.filter(J=>J!==x);G.length&&G.length<V.length&&($=G.join(`

`))}return $.trim()}function Q(l){const c=String(l?.selectedAfter||""),y=String(l?.selectedBefore||t(Cn)||""),x=c.length-y.length;return x===0?"长度不变":x>0?`增加 ${x} 字`:`减少 ${Math.abs(x)} 字`}function gt(){f(Ae,[]),f(Wn,0),f(zt,""),pt("已忽略本轮建议","info")}async function st(l){if(!pn("采纳候选改写"))return;const c=t(Ae)[l];if(!c||!s()||!c.docIr)return;const y=c.docIr;_t(y);try{await fetch(`/api/doc/${s()}/save`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({doc_ir:y})}),await fetch(`/api/doc/${s()}/version/commit`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:`块修改:${c.label}`,author:"user",kind:"minor"})}),pt(`已应用${c.label}`,"ok"),f(Ae,[]),f(Wn,0),f(Ht,""),requestAnimationFrame(()=>we()),await za()}catch(x){f(zt,x instanceof Error?x.message:"应用候选失败")}}function _t(l){const c=Vr(l);Lr.set(c),Yn.set(!1),or=c;const y=Qa(c)||"";yr.set(y),f(tr,y)}function Ct(l,c,y){if(!c)return null;const x=Array.isArray(l.sections)?l.sections:[];if(!x.length)return null;let $=!1;const T=V=>{let G=!1;const J=V.map(vt=>{let nt=!1,Y=vt;const ft=Array.isArray(vt.blocks)?vt.blocks.slice():[],ot=ft.findIndex($t=>String($t?.id||"")===c);ot>=0&&(ft.splice(ot+1,0,y),Y={...Y,blocks:ft},nt=!0);const xt=Array.isArray(vt.children)?vt.children:[];if(xt.length){const $t=T(xt);$t!==xt&&(Y={...Y,children:$t},nt=!0)}return nt&&(G=!0),nt?Y:vt});return G&&($=!0),G?J:V},N=T(x);return $?{...l,sections:N}:null}function $e(l,c){const y=Array.isArray(l.sections)?l.sections:[];if(!y.length)return null;const x=y[0],$=Array.isArray(x.blocks)?x.blocks.slice():[];$.push(c);const T={...x,blocks:$},N=y.slice();return N[0]=T,{...l,sections:N}}function at(l,c){if(!l||typeof l!="object")return;const y=a();if(!y||typeof y!="object")return;const x={id:Math.random().toString(36).slice(2),type:"figure",figure:l},$=Cr(c?.targetIds||[]),T=$.length?$[$.length-1]:"",N=T&&Ct(y,T,x)||$e(y,x);N&&_t(N)}function ct(l){const c=a();if(!c||typeof c!="object")return;const y={id:Math.random().toString(36).slice(2),type:"table",table:{caption:"新建表格",columns:["列1","列2","列3"],rows:[["","",""],["","",""]]}},x=Cr(l?.targetIds||[]),$=x.length?x[x.length-1]:"",T=$&&Ct(c,$,y)||$e(c,y);T&&(_t(T),pt("已插入表格块，可直接编辑内容。","ok"))}const It=new Map;async function Vt(l){if(!l)return null;if(It.has(l))return It.get(l);try{const c=await fetch(`/api/text/${encodeURIComponent(l)}`);if(!c.ok)throw new Error(await c.text());const y=await c.json();return It.set(l,y),y}catch{return null}}function Gt(l){if(!l)return"";const c=String(l.kind||""),y=String(l.format||"");if(y==="text")return String(l.text||"");if(y==="json"){const x=l.data||{};if(c==="list")return(Array.isArray(x.items)?x.items:[]).map(T=>`- ${String(T).trim()}`).join(`
`);if(c==="table")return`[[TABLE:${JSON.stringify(x)}]]`;if(c==="figure")return`[[FIGURE:${JSON.stringify(x)}]]`;if(x.text)return String(x.text)}return""}async function Pt(l,c){const y=await Vt(c),x=Gt(y);x&&ut(String(l||""),x,{raw:!l})}function Nn(l){let c=String(l||"").replace(/\r/g,"");return c=c.replace(/(\n(?:-|\d+\.)[^\n]*)(?:\n{2,})(?=(?:-|\d+\.)\s)/g,`$1
`),c=c.replace(/\n{3,}/g,`

`),c}function Wi(l){const c=String(l||"").replace(/\r/g,"").trim();if(!c)return[];const y=c.split(/\n+/).map(T=>T.trim()).filter(Boolean),x=[],$=T=>{const N=String(T||"").trim();if(!N)return;if(N.length<=92){x.push(N);return}let V=N.split(new RegExp("(?<=[。！？!?；;])(?=[^”’」』）》】\\]\\s])","g")).map(J=>J.trim()).filter(Boolean);if(V.length<=1&&N.length>118){const J=[];for(let vt=0;vt<N.length;vt+=1){const nt=N[vt];(nt==="，"||nt===","||nt==="、")&&J.push(vt)}if(J.length){const vt=Math.floor(N.length/2);let nt=J[0],Y=Number.POSITIVE_INFINITY;for(const xt of J){if(xt<24||xt>N.length-18)continue;const $t=Math.abs(xt-vt);$t<Y&&(Y=$t,nt=xt)}const ft=N.slice(0,nt+1).trim(),ot=N.slice(nt+1).trim();V=[ft,ot].filter(Boolean)}}if(V.length<=1){x.push(N);return}const G=[];for(const J of V)J&&(G.length&&J.length<24?G[G.length-1]=`${G[G.length-1]}${J}`:G.push(J));x.push(...G.filter(Boolean))};for(const T of y.length?y:[c])$(T);return x.length?x:[c]}function Vr(l){const c=Array.isArray(l.sections)?l.sections:[];if(!c.length)return l;let y=!1;const x=(N,V)=>{const G=String(N||"").trim(),J=String(V||"").trim();if(!G||!J)return null;const vt=G.replace(/^\d+(?:\.\d+){0,3}\s*/,"").trim();if(!vt||vt.length>4)return null;const nt=/^([\u4e00-\u9fa5]{1,4})(自|是|在|由|通过|随着|并|可|将|会)([\s\S]*)$/.exec(J);if(!nt)return null;const Y=String(nt[1]||"").trim();if(!Y||Y.length>3||vt.endsWith(Y))return null;const ft=`${G}${Y}`.trim(),ot=`${String(nt[2]||"")}${String(nt[3]||"")}`.trim();return ot?{title:ft,rest:ot}:null},$=N=>{let V=!1,G=N;const J=Array.isArray(N?.blocks)?N.blocks:[];if(J.length){const ft=J[0],ot=String(ft?.type||"").toLowerCase();if(ot==="paragraph"||ot==="text"||ot==="p"){const xt=x(String(N?.title||""),String(ft?.text||""));if(xt){const $t={...ft,text:xt.rest},St=J.slice();St[0]=$t,G={...G,title:xt.title,blocks:St},V=!0,y=!0}}}const vt=Array.isArray(G?.blocks)?G.blocks:J,nt=[];for(const ft of vt){const ot=String(ft?.type||"").toLowerCase(),xt=String(ft?.text||""),$t=Array.isArray(ft?.runs)?ft.runs:null;if((ot==="paragraph"||ot==="text"||ot==="p")&&!$t&&xt.length>92){const St=Wi(xt);if(St.length>1){const Ge=String(ft?.id||""),Ft=Ge?Ge.replace(/__\d+$/,""):Math.random().toString(36).slice(2),ae=ft?.style&&typeof ft.style=="object"?{...ft.style}:{},Ie=St.length;St.forEach((oe,tn)=>{const Ne={...ae};Ie>1&&(tn===0?Ne.marginBottom||(Ne.marginBottom="0"):(Ne.marginTop||(Ne.marginTop="0"),!Ne.indent&&!Ne.textIndent&&(Ne.indent="0"),tn<Ie-1&&!Ne.marginBottom&&(Ne.marginBottom="0"))),nt.push({...ft,id:`${Ft}__${tn+1}`,text:oe,style:Ne})}),y=!0,V=!0;continue}}nt.push(ft)}V&&(G={...G,blocks:nt});const Y=Array.isArray(N?.children)?N.children:[];if(Y.length){const ft=Y.map(xt=>$(xt));ft.some((xt,$t)=>xt!==Y[$t])&&(G={...G,children:ft},y=!0)}return G},T=c.map(N=>$(N));return y?{...l,sections:T}:l}function va(l,c,y){const x=hn(c),$=String(y||"").replace(/\r/g,"");if(!$||!$.trim()&&!$.includes(`
`))return String(l||"");if(!x){const xt=String(l||"").replace(/\r/g,""),$t=xt+(xt.endsWith(`
`)||!xt?"":`
`)+$;return Nn($t)}let T=String(l||"").replace(/\r/g,"");const N=new RegExp(`^##\\s+${Kn(x)}\\s*$`,"m");N.test(T)||(T=ie(T,"",[x]));const V=N.exec(T);if(!V){const xt=T+(T.endsWith(`
`)?"":`
`)+$;return Nn(xt)}const G=V.index+V[0].length,vt=T.slice(G).search(/^##\s+/m),nt=vt>=0?G+vt:T.length,Y=T.slice(0,nt),ft=T.slice(nt),ot=Y+$+ft;return Nn(ot)}function Rs(l){const c=String(l||"").replace(/\r/g,"").split(`
`);let y="message";const x=[];for(const N of c)N.startsWith("event:")&&(y=N.slice(6).trim()),N.startsWith("data:")&&x.push(N.slice(5).trim());const $=x.join(`
`);let T={};try{T=$?JSON.parse($):{}}catch{T={raw:$}}return{event:y,data:T}}async function Ys(l,c,y,x){const $=await fetch(l,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c),signal:x});if(!$.ok){const J=await $.text()||$.statusText||"请求失败";throw new Error(`HTTP ${$.status}: ${J}`)}if(!$.body)throw new Error("当前环境不支持流式输出");const T=$.body.getReader(),N=new TextDecoder("utf-8");let V="";for(;;){const{value:G,done:J}=await T.read();if(J)break;V+=N.decode(G,{stream:!0});let vt=V.indexOf(`

`);for(;vt>=0;){const nt=V.slice(0,vt);if(V=V.slice(vt+2),nt.trim()){const{event:Y,data:ft}=Rs(nt);y(Y,ft)}vt=V.indexOf(`

`)}}}async function pa(){const l=s();if(l){Ja.set(!0);try{const c=await fetch(`/api/doc/${l}`);if(!c.ok)throw new Error(await c.text());const y=await c.json();if(yr.set(String(y.text||"")),f(tr,String(y.text||"")),An=t(tr),f(Lt,Qi(y.resume_state)),f(Se,ma(y.feedback_log)),await uo(),await fo(),y.doc_ir&&typeof y.doc_ir=="object"){const x=Vr(y.doc_ir);Lr.set(x),Yn.set(!1),or=x}else Lr.set(null),or=null;za().catch(()=>{})}catch(c){pt(`加载失败: ${c instanceof Error?c.message:"未知错误"}`,"error")}finally{Ja.set(!1)}}}function ma(l){const c=Array.isArray(l)?l:[],y=[];for(const x of c){if(!x||typeof x!="object")continue;const $=Number(x.rating||0);if(!Number.isFinite($)||$<1||$>5)continue;const T=String(x.id||"").trim()||`${Date.now()}-${Math.random()}`,N=String(x.note||"").trim(),V=String(x.stage||"general").trim()||"general",G=Number(x.created_at||0),J=Number.isFinite(G)&&G>0?G:Date.now()/1e3,nt=(Array.isArray(x.tags)?x.tags:[]).map(Y=>String(Y||"").trim()).filter(Boolean);y.push({id:T,rating:$,note:N,stage:V,tags:nt,created_at:J})}return y.sort((x,$)=>$.created_at-x.created_at),y.slice(0,80)}async function Pa(){const l=s();if(l)try{const c=await fetch(`/api/doc/${l}/feedback`);if(!c.ok)return;const y=await c.json();f(Se,ma(y.items))}catch{}}function oo(l){const c=Number(l||0);return!Number.isFinite(c)||c<=0?"--":new Date(c*1e3).toLocaleString()}async function Qo(){const l=s();if(!l||t(_n))return;if(!Number.isFinite(t(vr))||t(vr)<1||t(vr)>5){pt("请选择 1-5 分满意度","info");return}f(_n,!0),f(Re,0);const c={item:{rating:t(vr),stage:t(er),note:String(t(On)||"").trim(),created_at:Date.now()/1e3},context:{doc_status:String(m()||""),flow_status:String(g()||""),char_count:String(r()||"").replace(/\s/g,"").length,word_count:Number(w()||0),instruction_preview:String(k()||"").trim().slice(0,400)}};try{const y=await fetch(`/api/doc/${l}/feedback`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)});if(!y.ok)throw new Error(await y.text());const x=await y.json();f(Se,ma(x.items));const $=Number(x.low_recorded||0);f(Re,Number.isFinite($)?$:0),t(Re)>0?pt("已记录低满意度样本，后续可用于学习改进。","info"):pt("满意度已提交","ok"),f(On,"")}catch(y){const x=y instanceof Error?y.message:"提交失败";pt(`满意度提交失败: ${x}`,"bad")}finally{f(_n,!1)}}function Zo(l){const c=String(l||"");if(!c.trim())return[];const y=c.split(/[,\n;\s]+/).map($=>String($||"").trim()).filter(Boolean),x=[];for(const $ of y)x.includes($)||x.push($);return x.slice(0,50)}function fs(l){const c=Number(l||0);return Number.isFinite(c)?Math.max(0,Math.min(1,c)):0}function lo(l){const c=fs(l);return c>=.7?"高风险":c>=.45?"中风险":c>=.2?"低风险":"很低"}async function co(){const l=s();if(!l||t(bn))return;const c=Zo(t(ei)),y=String(t(sn)||"").trim();if(!c.length&&!y){pt("请至少提供一个对比文档ID或粘贴参考文本","info");return}f(bn,!0),f(yn,[]),f($r,0),f(Hn,0);try{const x={threshold:Math.max(.05,Math.min(.95,Number(t(pr)||.35))),reference_doc_ids:c};y&&(x.reference_texts=[{id:"manual_text",title:"手动粘贴文本",text:y}]);const $=await fetch(`/api/doc/${l}/plagiarism/check`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(x)});if(!$.ok)throw new Error(await $.text());const T=await $.json(),N=Array.isArray(T?.results)?T.results:[];f(yn,N.map(V=>({reference_id:String(V?.reference_id||""),reference_title:String(V?.reference_title||""),score:fs(V?.score),threshold:fs(V?.threshold||x.threshold),suspected:!!V?.suspected,metrics:V?.metrics&&typeof V.metrics=="object"?V.metrics:{},evidence:Array.isArray(V?.evidence)?V.evidence:[]}))),f($r,Number(T?.flagged_count||0)||0),f(Hn,fs(T?.max_score||0)),t(yn).length===0?pt("查重完成：没有可分析的参考文本","info"):t($r)>0?pt(`查重完成：发现 ${t($r)} 个疑似高重复来源`,"bad"):pt("查重完成：未发现超阈值重复来源","ok")}catch(x){const $=x instanceof Error?x.message:"查重失败";pt(`查重失败: ${$}`,"bad")}finally{f(bn,!1)}}async function uo(){const l=s();if(l)try{const c=await fetch(`/api/doc/${l}/plagiarism/library_scan/latest`);if(!c.ok)return;const y=await c.json();f(Rt,y?.has_report&&y.latest||null)}catch{}}async function fo(){const l=s();if(l)try{const c=await fetch(`/api/doc/${l}/ai_rate/latest`);if(!c.ok)return;const y=await c.json();f(Yt,y?.has_latest&&y.latest||null)}catch{}}async function vo(){const l=s();if(l&&!t(Pn)){f(Pn,!0);try{const c={threshold:Math.max(.05,Math.min(.95,Number(t(Fr)||.65)))},y=await fetch(`/api/doc/${l}/ai_rate/check`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)});if(!y.ok)throw new Error(await y.text());const x=await y.json();f(Yt,x);const $=Number(x?.ai_rate_percent||0),T=String(x?.risk_level||"");x?.suspected_ai?pt(`AI率检测完成：${$}%（${T}）`,"bad"):pt(`AI率检测完成：${$}%（${T}）`,"ok")}catch(c){const y=c instanceof Error?c.message:"AI率检测失败";pt(`AI率检测失败: ${y}`,"bad")}finally{f(Pn,!1)}}}async function po(){const l=s();if(l&&!t(Ye)){f(Ye,!0);try{const c={include_all_docs:!0,threshold:Math.max(.05,Math.min(.95,Number(t(pr)||.35))),top_k:30,max_docs:120},y=String(t(sn)||"").trim();y&&(c.reference_texts=[{id:"manual_text",title:"手动粘贴文本",text:y}]);const x=await fetch(`/api/doc/${l}/plagiarism/library_scan`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)});if(!x.ok)throw new Error(await x.text());const $=await x.json();f(Rt,{report_id:String($?.report_id||""),created_at:Number($?.created_at||0),threshold:Number($?.threshold||c.threshold),source_chars:Number($?.source_chars||0),flagged_count:Number($?.flagged_count||0),total_references:Number($?.total_references||0),max_score:Number($?.max_score||0),suspected:!!$?.suspected,paths:$?.paths&&typeof $.paths=="object"?$.paths:{}});const T=Array.isArray($?.results)?$.results:[];f(yn,T.map(N=>({reference_id:String(N?.reference_id||""),reference_title:String(N?.reference_title||""),score:fs(N?.score),threshold:fs(N?.threshold||c.threshold),suspected:!!N?.suspected,metrics:N?.metrics&&typeof N.metrics=="object"?N.metrics:{},evidence:Array.isArray(N?.evidence)?N.evidence:[]}))),f($r,Number($?.flagged_count||0)||0),f(Hn,fs($?.max_score||0)),pt(`全库查重完成：来源 ${t(Rt).total_references}，超阈值 ${t(Rt).flagged_count}`,t(Rt).flagged_count>0?"bad":"ok")}catch(c){const y=c instanceof Error?c.message:"全库查重失败";pt(`全库查重失败: ${y}`,"bad")}finally{f(Ye,!1)}}}function ha(l){const c=s();if(!c)return;const y=String(t(Rt)?.report_id||"").trim();if(!y){pt("暂无可下载的查重报告","info");return}window.location.href=`/api/doc/${c}/plagiarism/library_scan/download?report_id=${encodeURIComponent(y)}&format=${l}`}function mo(l){const c=[],y=Array.isArray(l?.sections)?l.sections:[],x=$=>{c.push($),(Array.isArray($?.children)?$.children:[]).forEach(N=>x(N))};return y.forEach($=>x($)),c}function ho(l){const c=Math.max(1,Math.min(6,Number(l?.level||1))),y=String(l?.title||"").trim(),x=l?.style&&typeof l.style=="object"?JSON.stringify(l.style):"";return`${c}:${y}:${x}`}function fn(l){const c=String(l?.type||"paragraph").toLowerCase(),y=l?.style&&typeof l.style=="object"?l.style:null,x=Array.isArray(l?.runs)?l.runs:null;if(c==="list"){const N=Array.isArray(l?.items)?l.items:[],V=!!l?.ordered,G={type:"list",items:N,ordered:V};return y&&(G.style=y),x&&(G.runs=x),G}if(c==="table"){const N={type:"table",table:l?.table||{}};return y&&(N.style=y),x&&(N.runs=x),N}if(c==="figure"){const N={type:"figure",figure:l?.figure||{}};return y&&(N.style=y),x&&(N.runs=x),N}const T={type:"paragraph",text:String(l?.text||"")};return y&&(T.style=y),x&&(T.runs=x),T}function $n(l){const c=String(l?.type||"paragraph").toLowerCase(),y=l?.style?`:style=${JSON.stringify(l?.style||{})}`:"",x=l?.runs?`:runs=${JSON.stringify(l?.runs||[])}`:"";return c==="list"?`list:${JSON.stringify(l?.items||[])}:${!!l?.ordered}${y}`:c==="table"?`table:${JSON.stringify(l?.table||{})}${y}`:c==="figure"?`figure:${JSON.stringify(l?.figure||{})}${y}`:`paragraph:${String(l?.text||"")}${y}${x}`}function Hr(l,c){if(!l||!c)return null;const y=mo(l),x=mo(c);if(y.length!==x.length)return null;for(let T=0;T<y.length;T++)if(ho(y[T])!==ho(x[T])||!y[T]?.id)return null;const $=[];for(let T=0;T<y.length;T++){const N=y[T],V=x[T],G=Array.isArray(N?.blocks)?N.blocks:[],J=Array.isArray(V?.blocks)?V.blocks:[],vt=G.map(St=>String(St?.id||"")).filter(Boolean),nt=J.map(St=>String(St?.id||"")).filter(Boolean),Y=new Set(vt),ft=new Set(nt),ot=new Map(G.map(St=>[String(St?.id||""),St]));for(const St of vt)ft.has(St)||$.push({op:"delete",target_id:St});const xt=nt.filter(St=>Y.has(St)),$t=vt.filter(St=>ft.has(St));xt.forEach((St,Ge)=>{const Ft=$t.indexOf(St);Ft!==-1&&Ft!==Ge&&($.push({op:"move",target_id:St,parent_id:String(N.id),index:Ge}),$t.splice(Ft,1),$t.splice(Ge,0,St))}),J.forEach((St,Ge)=>{const Ft=String(St?.id||"");if(Ft&&Y.has(Ft)){const Ie=ot.get(Ft);Ie&&$n(Ie)!==$n(St)&&$.push({op:"update",target_id:Ft,payload:fn(St)});return}const ae=fn(St);$.push({op:"insert",parent_id:String(N.id),index:Ge,payload:ae})})}return $}async function sr(){const l=s();if(!l||!i()||Ue)return;const c=String(r()||"");if(!(!c.trim()||c===An)){Ue=!0;try{(await fetch(`/api/doc/${l}/save`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:c})})).ok&&(An=c)}catch{}finally{Ue=!1}}}function dn(){i()&&(ne&&clearTimeout(ne),ne=setTimeout(()=>{sr()},1600))}async function ri(){const l=s();if(l)try{if(a()&&!b()&&or){const y=Hr(or,a());if(y&&y.length>0){const x=await fetch(`/api/doc/${l}/doc_ir/ops`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({ops:y})});if(x.ok){const $=await x.json();if($.doc_ir&&typeof $.doc_ir=="object"){const T=Vr($.doc_ir);Lr.set(T),Yn.set(!1),or=T}if($.text){const T=String($.text||"");yr.set(T),f(tr,T),An=T}else f(tr,r()),An=r();pt("已保存","ok");return}}else if(y&&y.length===0){f(tr,r()),An=r(),or=a();return}}const c={text:r()};!b()&&a()&&(c.doc_ir=a()),await fetch(`/api/doc/${l}/save`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)}),f(tr,r()),An=r(),!b()&&a()?or=a():or=null,pt("已保存","ok")}catch(c){pt(`保存失败: ${c instanceof Error?c.message:"未知错误"}`,"error")}}function Ha(l){if(!l)return"";try{return new Date(l*1e3).toLocaleString()}catch{return String(l)}}function ga(l){if(!l||typeof l!="object")return"";const c=Number(l.insert||0),y=Number(l.delete||0),x=Number(l.replace||0),$=[];return c&&$.push(`新增${c}`),x&&$.push(`修改${x}`),y&&$.push(`删除${y}`),$.join(" / ")}function hd(l){const c=[];let y=null;return l.forEach(x=>{const $=Array.isArray(x?.tags)?x.tags:[];(x?.kind||($.includes("major")?"major":$.includes("minor")?"minor":""))==="major"||!y?(y={major:x,minors:[]},c.push(y)):y.minors.push(x)}),c}async function za(){if(s()){f(ve,!0),f(pe,"");try{const l=await fetch(`/api/doc/${s()}/version/log?branch=main&limit=50`);if(!l.ok)throw new Error(await l.text());const c=await l.json();an=Array.isArray(c.versions)?c.versions:[],f(Ze,hd(an))}catch(l){f(pe,l instanceof Error?l.message:"加载失败")}finally{f(ve,!1)}}}async function gd(){if(!s())return;const l=t(qe).trim()||"定稿版本";try{const c=await fetch(`/api/doc/${s()}/version/commit`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:l,author:"user",kind:"major"})});if(!c.ok)throw new Error(await c.text());f(qe,""),await za(),pt("已提交版本","ok")}catch(c){pt(`提交失败: ${c instanceof Error?c.message:"未知错误"}`,"error")}}async function Ec(l){if(!(!s()||!l))try{const c=await fetch(`/api/doc/${s()}/version/checkout`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({version_id:l})});if(!c.ok)throw new Error(await c.text());const y=await c.json(),x=String(y.doc_text||"");Xt(x),f(tr,x),await za(),pt("已切换版本","ok")}catch(c){pt(`切换失败: ${c instanceof Error?c.message:"未知错误"}`,"error")}}async function _d(l,c){if(!(!s()||!l||!c)){f(Qt,"");try{const y=await fetch(`/api/doc/${s()}/version/diff?from_version=${l}&to_version=${c}`);if(!y.ok)throw new Error(await y.text());const x=await y.json(),$=Array.isArray(x.diff)?x.diff:[];f(Qt,$.join(`
`))}catch(y){f(Qt,y instanceof Error?y.message:"对比失败")}}}async function Ac(l){if(!l)return;const c=an.find(y=>y.is_current);!c||c.version_id===l||await _d(c.version_id,l)}async function Cc(l){if(!s())return!1;try{const c=await fetch(`/api/doc/${s()}/export/check?format=${l}&auto_fix=1`);if(!c.ok){const N=await c.text();return pt(`导出校验失败: ${N||c.statusText}`,"bad"),!1}const y=await c.json(),x=!!y?.can_export,$=Array.isArray(y?.issues)?y.issues:[];if((Array.isArray(y?.warnings)?y.warnings:[]).length>0&&pt("导出前已自动修复文档结构。","info"),!x){const N=$[0],V=String(N?.message||"导出前校验未通过");return $.some(J=>String(J?.code||"").startsWith("citation_"))?(f(X,!0),pt(`${V} 已自动打开“引用”面板，请先点击“核验引用”。`,"bad")):pt(V,"bad"),!1}return!0}catch(c){return pt(`导出校验失败: ${c instanceof Error?c.message:"未知错误"}`,"bad"),!1}}async function bd(){!s()||!await Cc("pdf")||(pt("正在生成PDF...","info"),window.location.href=`/download/${s()}.pdf`)}function yd(l){f(Ri,!1),window.location.href=`/workbench/${l}`}async function wd(){!s()||!await Cc("docx")||(pt("正在生成Word文档...","info"),window.location.href=`/download/${s()}.docx`)}async function xd(){if(!t(Lt)||i())return;const l=String(t(Lt).user_instruction||t(Lt).request_instruction||"").trim();if(!l){pt("没有可续跑的历史指令","info");return}await go(l,{fromResume:!0,forcedComposeMode:"continue",resumeSections:t(Lt).pending_sections||[],cursorAnchor:t(Lt).cursor_anchor||""})}function tl(){f(en,null),f(Sr,!1)}function Ic(l,c,y){f(en,{requestPayload:{...l},note:String(c.note||""),reason:String(c.confirmation_reason||"high_risk_edit"),riskLevel:String(c.risk_level||"high"),planSource:String(c.plan_source||"rules"),operationsCount:Number(c.operations_count||0)}),f(Sr,!1),Dr.set("待确认：检测到高风险编辑"),Ps.set("待确认");const x=y?.fromStream?"流式生成":"非流式生成",$=t(en).note||`检测到高风险编辑，来源 ${x}。`;Br("system",$),Wr("待确认",$,kn()),pt("检测到高风险编辑，请确认后执行。","info")}async function Nc(l,c){const y=await fetch(`/api/doc/${s()}/generate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)});if(!y.ok){const N=await y.text();throw new Error(`HTTP ${y.status}: ${N||y.statusText}`)}const x=await y.json();if(x.requires_confirmation)return Ic(l,x,{fromStream:c?.fromStream}),"pending";const $=String(x.text||"");if(jt){const N=x.doc_ir&&typeof x.doc_ir=="object"?x.doc_ir:null;Dt($,N)}else{const N=x.doc_ir&&typeof x.doc_ir=="object"?x.doc_ir:null;mn($,{finalDocIr:N})}Dr.set("完成"),Ps.set("完成"),f(Lt,null);const T=String(c?.completionMsg||"已完成生成。");return Br("system",T),Wr("完成",T,kn()),pt("生成完成（非流式）","ok"),ri().catch(()=>{}),tl(),"applied"}async function Sd(){if(!(!t(en)||!s()||i())){f(Sr,!0),vs.set(!0),Dr.set("执行高风险编辑中…");try{const l={...t(en).requestPayload,confirm_apply:!0};await Nc(l,{completionMsg:"已完成高风险编辑（确认执行）。"})==="pending"&&pt("服务端仍要求确认，请检查风险策略配置。","info")}catch(l){const c=l instanceof Error?l.message:"确认执行失败";Dr.set(`生成失败: ${c}`),Br("system",c),Wr("错误",String(c),kn()),pt(String(c),"bad")}finally{f(Sr,!1),vs.set(!1)}}}function kd(){t(en)&&(tl(),Dr.set("已取消高风险编辑"),Ps.set("已停止"),pt("已取消执行。","info"))}function $d(l){const c=String(l?.name||"").toLowerCase();return String(l?.type||"").startsWith("image/")||/\.(png|jpe?g|gif|bmp|webp|svg)$/i.test(c)}async function Mc(l,c){if(!s()||!l)return;const y=new FormData;y.append("file",l,l.name);const x=c?.source||"assistant",$=$d(l);if(x==="inline-image"&&!$){pt("选中段落插图仅支持图片文件。","info");return}try{pt($?"正在上传图片...":"正在上传文件...","info");const T=await fetch(`/api/doc/${s()}/upload`,{method:"POST",body:y});if(!T.ok)throw new Error(await T.text());const N=await T.json(),V=String(N.kind||"");if(x==="inline-image"&&$){const G=l.name.replace(/\.[^.]+$/,"");at({caption:G,source:"upload",filename:l.name},{targetIds:c?.targetIds||[]}),ri().catch(()=>{}),pt("图片上传成功，已插入选中内容后。","ok"),Br("system",`已插入图片：${l.name}`);return}if(V==="template")pt("模板文件上传成功，已解析结构。","ok"),Br("system",`模板已上传并解析：${l.name}`);else{const G=$?"图片已上传到资料库。若要插入正文，请选中段落后点击“插图”。":"文件上传成功，已纳入资料库。";pt(G,"ok"),Br("system",`${G}（${l.name}）`)}}catch(T){const N=T instanceof Error?T.message:"上传失败";pt(N,"bad")}}function Bc(){t(qt).length&&pn("插图")&&(_e=t(qt).slice(),t(Jn)?.click())}function Dc(){t(qt).length&&pn("插表")&&(ct({targetIds:t(qt).slice()}),ri().catch(()=>{}))}async function Td(l){const c=l.currentTarget,y=c?.files?.[0],x=_e.slice();_e=[],y&&await Mc(y,{source:"inline-image",targetIds:x}),c&&(c.value="")}async function jd(l){const c=l?.detail?.file;c&&await Mc(c,{source:"assistant"})}async function go(l,c){const y=String(l||"").trim();if(!y)return;if(Gr()){c?.fromQueue||(Br("user",y),zs.set(""),Pr(y));return}if(!s()){const nt="缺少文档ID，请刷新或从 /workbench/{id} 进入";Dr.set(`已中止: ${nt}`),Wr("中止",nt,new Date().toLocaleTimeString()),pt(nt,"info");return}tl(),c?.fromQueue?Br("system","正在执行排队指令…"):c?.fromResume?Br("system","正在续跑上次中断任务…"):(Br("user",y),zs.set("")),Xr("commit");const x=String(r()||""),$=Yi(x),T=Rn(y);let N=c?.forcedComposeMode||T||"auto";!c?.forcedComposeMode&&!T&&$&&(c?.fromQueue?N="continue":N=window.confirm(`检测到编辑区已有内容。
确定：在当前内容基础上续写
取消：覆盖重写当前文档`)?"continue":"overwrite");let V=y;!T&&N==="continue"?V=`请在保留现有内容结构和已写段落的前提下继续写作，不要删除或改写已有内容。

用户需求：${y}`:!T&&N==="overwrite"&&(V=`请忽略当前已有正文，按用户需求从头完整重写，并用新内容覆盖旧内容。

用户需求：${y}`);const G=Er(c?.resumeSections||[]),J=String(c?.cursorAnchor||"").trim();f(Lt,{status:"running",updated_at:Date.now()/1e3,user_instruction:y,request_instruction:V,compose_mode:N,partial_chars:String(r()||"").trim().length,partial_preview:String(r()||"").trim().slice(-240),plan_sections:G,completed_sections:[],pending_sections:G,cursor_anchor:J,error:""}),fe+=1,us(),te(),vs.set(!0),Yn.set(!0),lt=!0,Ps.set("分析"),Dr.set("生成中…"),De=Date.now(),xe="",ln="",Mt=!1,mt=!1,jt=!1,Bt=Date.now(),jr=Date.now(),bt=!1,f(At,{current:0,total:0,percent:0,etaS:0,section:""}),ee=Date.now(),We=[],vn=0,f(ge,[]),Wr("启动","开始生成",new Date().toLocaleTimeString()),E=new AbortController,Ja.set(!1),Le&&clearInterval(Le),Le=setInterval(()=>{if(!i())return;const nt=Date.now()-Bt,Y=We.length>0?Math.round(We.reduce((xt,$t)=>xt+$t,0)/We.length):0;let ft=Math.max(cn,Y*6||0,vn*3||0,9e4);ft=Math.min(6e5,ft),(/model preparing/i.test(ln)||/解析中/.test(ln)||xe==="analysis")&&(ft=Math.max(ft,18e4)),nt>ft&&!bt&&(bt=!0,E?.abort(`客户端超时：${Math.round(nt/1e3)}秒无事件，切换非流式生成`))},1e3);const vt={instruction:V,text:x,compose_mode:N};G.length>0&&(vt.resume_sections=G),J&&(vt.cursor_anchor=J);try{if(await Ys(`/api/doc/${s()}/generate/stream`,vt,(nt,Y)=>{const ft=Date.now();if(xe=String(nt||""),Bt>0&&(Kt=ft-Bt,Kt>0&&Kt<12e4&&(We=[...We,Kt].slice(-8)),Kt>vn&&Kt<6e5&&(vn=Kt)),Bt=ft,nt==="state"){const ot=Ai(String(Y.name||""));Ps.set(ot||g()),Wr("流程",ot,kn());return}if(nt==="delta"){const ot=String(Y.delta||"").trim();ot&&(Dr.set(ot),ln=ot,Wr("进度",ot,kn()));return}if(nt==="plan"){const ot=String(Y.title||"自动生成文档"),$t=(Array.isArray(Y.sections)?Y.sections:[]).map(Ge=>hn(String(Ge||""))).filter(Boolean);t(Lt)&&f(Lt,{...t(Lt),plan_sections:$t,completed_sections:[],pending_sections:$t}),Wr("大纲",`标题：${ot}；章节：${$t.join(" / ")}`,kn());const St=ie(r(),ot,$t);yr.set(St),Ni(St);return}if(nt==="section"){const ot=String(Y.phase||""),xt=String(Y.section_key||Y.section||"");if((ot==="start"||ot==="end")&&Ci(xt,ot),ot==="end"){const $t=hn(String(xt||"")).trim();if(t(Lt)&&$t){const St=Er([...t(Lt).completed_sections,$t]),Ft=(t(Lt).plan_sections||[]).filter(ae=>!St.includes(ae));f(Lt,{...t(Lt),completed_sections:St,pending_sections:Ft})}}if(ot==="delta"){jt=!0;const $t=String(Y.block_id||""),St=String(Y.block_type||"");if($t){Pt(xt,$t);return}const Ge=String(Y.delta||"");Ge&&ut(xt,Ge,{raw:!xt&&!St})}return}if(nt==="progress"){const ot=Number(Y.current||0),xt=Number(Y.total||0),$t=Number(Y.percent||0),St=hn(String(Y.section||"")),Ge=Number(Y.elapsed_s||0);if(ee===0&&(ee=Date.now()),ot>0){const ae=(Ge>0?Ge:Math.max(1,Math.round((Date.now()-ee)/1e3)))/ot,Ie=Math.max(0,Math.round(ae*Math.max(0,xt-ot)));f(At,{current:ot,total:xt,percent:$t,etaS:Ie,section:St})}else f(At,{current:ot,total:xt,percent:$t,etaS:0,section:St});return}if(nt==="section_error"){const ot=String(Y.section||""),xt=String(Y.reason||"unknown");ot&&(f(ge,[...t(ge),{section:ot,reason:xt}]),pt(`章节失败: ${ot}`,"bad"));return}if(nt==="analysis"){const ot=String(Y.summary||""),xt=Array.isArray(Y.steps)?Y.steps:[],$t=Array.isArray(Y.missing)?Y.missing:[];if(Vp.set(ot||"等待解析…"),Xp.set(xt),Yp.set($t),Wr("解析",ot||"解析完成",kn()),Y.raw){const St=JSON.stringify(Y.raw,null,2).slice(0,600);Wr("解析JSON",St,kn())}return}if(nt==="confirmation_required"){Mt=!0,Ic(vt,Y,{fromStream:!0});return}if(nt==="final"){const ot=String(Y.text||"");if(jt){const xt=Y.doc_ir&&typeof Y.doc_ir=="object"?Y.doc_ir:null;Dt(ot,xt)}else{const xt=Y.doc_ir&&typeof Y.doc_ir=="object"?Y.doc_ir:null;mn(ot,{finalDocIr:xt})}Dr.set("完成"),Ps.set("完成"),Mt=!0,f(Lt,null),Br("system","已完成生成。"),Wr("完成","生成完成",kn()),pt("生成完成","ok"),ri().catch(()=>{});return}if(nt==="error"){const ot=String(Y.message||Y.reason||Y.detail||"服务端未返回具体原因"),$t=String(Y.code||Y.type||"").toLowerCase().includes("abort")||/aborted|stopped|取消|中止/i.test(ot);mt=!0,Dr.set($t?`已中止: ${ot}`:`生成失败: ${ot}`),Br("system",ot),Wr($t?"中止":"错误",ot,kn()),pt(ot,$t?"info":"bad")}},E.signal),!Mt&&!mt){const nt=ln?`流式结束但未完成，最后进度: ${ln}`:xe?`流式结束但未完成，最后事件: ${xe}`:"流式结束但未完成，服务端未返回原因";Dr.set(`已中止: ${nt}`),Br("system",nt),Wr("中止",nt,kn()),pt(nt,"info")}}catch(nt){if(String(nt?.name||"")==="AbortError"){const Y=E?.signal?.reason||nt?.message||"用户中止";if(String(Y).includes("切换非流式生成")){Wr("中止",String(Y),kn()),pt(String(Y),"info");try{const ft=await Nc(vt,{completionMsg:"已完成生成（非流式兜底）。",fromStream:!0});(ft==="applied"||ft==="pending")&&(Mt=!0)}catch(ft){const ot=ft?.message||"非流式生成失败";Dr.set(`生成失败: ${ot}`),Br("system",ot),Wr("错误",String(ot),kn()),pt(String(ot),"bad")}}else Dr.set(`已中止: ${Y}`),Br("system",`已中止生成：${Y}`),Wr("中止",String(Y),kn()),pt(String(Y),"info")}else{const Y=nt?.message||"生成失败，请检查模型是否运行。";Dr.set(`生成失败: ${Y}`),Br("system",Y),Wr("错误",String(Y),kn()),pt(String(Y),"bad")}}finally{if(!Mt){const nt=String(r()||"").trim(),Y=t(Lt);f(Lt,{status:"interrupted",updated_at:Date.now()/1e3,user_instruction:String(Y?.user_instruction||y),request_instruction:String(Y?.request_instruction||V),compose_mode:Y?.compose_mode||N,partial_chars:nt.length,partial_preview:nt.slice(-240),plan_sections:Er(Y?.plan_sections||[]),completed_sections:Er(Y?.completed_sections||[]),pending_sections:Er(Y?.pending_sections||[]),cursor_anchor:String(Y?.cursor_anchor||J),error:String(m()||"")}),sr()}if(vs.set(!1),Ja.set(!1),lt=!1,te(),ne&&(clearTimeout(ne),ne=null),U&&(clearTimeout(U),U=null),Le&&(clearInterval(Le),Le=null),vn>0&&typeof localStorage<"u"){const nt=Math.min(6e5,Math.max(cn,vn*3,9e4));cn=nt;try{localStorage.setItem("wa_idle_base_ms",String(nt))}catch{}}E=null,t(In).length&&queueMicrotask(()=>{di()})}}async function Ed(l){const c=s(),y=String(l||"").trim();if(!(!c||!y||i())){Xr("commit"),await ri().catch(()=>{}),vs.set(!0),Dr.set(`重试章节：${y}`);try{const x=await fetch(`/api/doc/${c}/generate/section`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({section:y,instruction:String(k()||"").trim()})});if(!x.ok)throw new Error(await x.text());const $=await x.json(),T=String($.text||"");if(T&&(yr.set(T),Dr.set("完成"),Br("system",`章节重试完成：${y}`)),$.doc_ir&&typeof $.doc_ir=="object"){const N=Vr($.doc_ir);Lr.set(N),Yn.set(!1)}else T&&Yn.set(!0);f(ge,t(ge).filter(N=>N.section!==y)),pt(`章节重试完成: ${y}`,"ok"),ri().catch(()=>{})}catch(x){const $=x instanceof Error?x.message:"章节重试失败";Dr.set(`重试失败: ${$}`),pt(`章节重试失败: ${$}`,"bad")}finally{vs.set(!1)}}}function Ad(){E&&E.abort("用户点击停止")}function Xr(l){Do.set(l)}Fa(()=>{const l=localStorage.getItem("darkMode")==="true";Ru.set(l),l&&document.body.classList.add("dark");const c=localStorage.getItem("wa_idle_base_ms");if(c){const T=Number(c);Number.isFinite(T)&&T>0&&(cn=T)}nn();const y=T=>{if(!Ti)return;const N=document.querySelector(".grid");if(!N)return;const V=N.getBoundingClientRect(),G=Math.min(Math.max(T.clientX-V.left,220),V.width-260);Math.round(G/V.width*100)},x=()=>{Ti=!1,document.body.style.cursor=""},$=()=>{we()};if(window.addEventListener("mousemove",y),window.addEventListener("mouseup",x),window.addEventListener("resize",$),window.addEventListener("scroll",$,!0),window.addEventListener("keydown",z),!s()){const T=Gn();T&&(Ms.set(T),pa().then(()=>Promise.all([Qp(),Zp(),Pa()])).catch(()=>{}))}return()=>{Bi(),window.removeEventListener("mousemove",y),window.removeEventListener("mouseup",x),window.removeEventListener("resize",$),window.removeEventListener("scroll",$,!0),window.removeEventListener("keydown",z),t(Ur)&&clearTimeout(t(Ur))}}),Hs(()=>(t(Wn),t(Ae)),()=>{t(Wn)>=t(Ae).length&&f(Wn,0)}),Hs(()=>(t(Ae),t(Wn)),()=>{f(Tr,t(Ae)[t(Wn)]||null)}),Hs(()=>(r(),t(tr),i(),t(Ur)),()=>{r()&&r()!==t(tr)&&!i()&&(t(Ur)&&clearTimeout(t(Ur)),f(Ur,setTimeout(()=>{ri().catch(()=>{})},3e3)))}),Hs(()=>(t(ue),i(),t(Un),t(Pe)),()=>{if(!Gr())f(ue,!1),f(Sn,"");else if(!i())f(ue,!0),f(Sn,"当前内容仍在渲染，请等待打字机输出结束后再修改。");else{const l=fi();if(!l.length)f(ue,!0),f(Sn,"当前仍在生成。请先选择已完成章节下的段落块。");else{const c=l.filter(y=>!t(Un).includes(y)||t(Pe).includes(y));f(ue,c.length>0),f(Sn,t(ue)?"选中块所在章节仍在生成，请等待该章节完成后再修改。":"")}}}),so();var Cd={$set:gi,$on:(l,c)=>hi(n,l,c)};Ds();var Lc=N_(),_o=wr(Lc);let Rc;var el=v(_o),qc=u(v(el),4),nl=v(qc),Fc=u(v(nl),2),Id=v(Fc,!0);d(Fc),d(nl);var rl=u(nl,2),Nd=v(rl);d(rl);var Oc=u(rl,2);{var Md=l=>{var c=qg(),y=v(c);d(c),rt(()=>D(y,`最近满意度 ${t(Se),_(()=>t(Se)[0].rating)??""}/5`)),M(l,c)};Z(Oc,l=>{t(Se),_(()=>t(Se).length>0)&&l(Md)})}var Pc=u(Oc,2);{var Bd=l=>{var c=Fg(),y=v(c);d(c),rt(x=>D(y,`查重最高 ${x??""}%`),[()=>(t(Hn),_(()=>Math.round(t(Hn)*100)))]),M(l,c)};Z(Pc,l=>{t(yn),_(()=>t(yn).length>0)&&l(Bd)})}var Hc=u(Pc,2),zc=u(Hc,2),Wc=u(zc,2),bo=u(Wc,2),Dd=v(bo,!0);d(bo);var yo=u(bo,2),Ld=v(yo,!0);d(yo);var wo=u(yo,2),Rd=v(wo,!0);d(wo);var qd=u(wo,2);ad(qd,{}),d(qc),d(el);var il=u(el,2),sl=v(il),Uc=u(v(sl),2),Jc=u(Uc,2),Gc=u(Jc,2),Fd=u(Gc,2);d(sl);var al=u(sl,2),ol=v(al),Kc=v(ol),ll=v(Kc),cl=u(v(ll),2),ul=u(cl,2),fl=u(ul,2),dl=u(fl,2),vl=u(dl,2),pl=u(vl,2),xo=u(pl,4),So=u(xo,2),ml=u(So,2);d(ll);var hl=u(ll,2),Vc=u(v(hl),2),Xc=u(Vc,2),Yc=u(Xc,2),Qc=u(Yc,2),Zc=u(Qc,2),Od=u(Zc,2);d(hl);var gl=u(hl,2),tu=u(v(gl),2),Pd=u(tu,2);d(gl);var eu=u(gl,2),_l=u(v(eu),2),bl=u(_l,2),Hd=u(bl,2);{var zd=l=>{var c=Og();C("click",c,xd),M(l,c)};Z(Hd,l=>{t(Lt)&&!i()&&l(zd)})}d(eu),d(Kc),d(ol);var nu=u(ol,2);{var Wd=l=>{var c=Pg(),y=v(c);d(c),rt(x=>D(y,`生成中 ${t(At),_(()=>t(At).current)??""}/${t(At),_(()=>t(At).total)??""} · ${t(At),_(()=>t(At).percent)??""}% · 预计剩余 ${x??""} 分 ${t(At),_(()=>t(At).etaS%60)??""} 秒`),[()=>(t(At),_(()=>Math.ceil(t(At).etaS/60)))]),M(l,c)};Z(nu,l=>{i(),t(At),_(()=>i()&&t(At).total>0)&&l(Wd)})}var ru=u(nu,2);{var Ud=l=>{var c=Hg(),y=v(c),x=u(y);{var $=T=>{var N=es();rt(V=>D(N,`，待续写章节：${V??""}`),[()=>(t(Lt),_(()=>t(Lt).pending_sections.join(" / ")))]),M(T,N)};Z(x,T=>{t(Lt),_(()=>t(Lt).pending_sections&&t(Lt).pending_sections.length>0)&&T($)})}ms(),d(c),rt(()=>D(y,`检测到未完成任务（已缓存约 ${t(Lt),_(()=>t(Lt).partial_chars)??""} 字） `)),M(l,c)};Z(ru,l=>{t(Lt),i(),_(()=>t(Lt)&&!i()&&t(Lt).status==="interrupted")&&l(Ud)})}var iu=u(ru,2);{var Jd=l=>{var c=Wg(),y=u(v(c),2);on(y,1,()=>t(ge),Fn,(x,$)=>{var T=zg(),N=v(T),V=v(N,!0);d(N);var G=u(N,2);d(T),rt(()=>D(V,(t($),_(()=>t($).section)))),C("click",G,()=>Ed(t($).section)),M(x,T)}),d(c),M(l,c)};Z(iu,l=>{t(ge),_(()=>t(ge).length>0)&&l(Jd)})}var su=u(iu,2);{var Gd=l=>{var c=Kg(),y=u(v(c),2),x=v(y),$=u(v(x),2);Zn($),ms(2),d(x);var T=u(x,2),N=v(T),V=v(N,!0);d(N);var G=u(N,2);{var J=Y=>{var ft=Ug(),ot=v(ft);d(ft),rt((xt,$t,St)=>D(ot,`估计 AI 率 ${xt??""}%，
                  风险 ${$t??""}，
                  置信度 ${St??""}%`),[()=>(t(Yt),_(()=>Math.round(Number(t(Yt).ai_rate||0)*100))),()=>(t(Yt),_(()=>String(t(Yt).risk_level||"unknown"))),()=>(t(Yt),_(()=>Math.round(Number(t(Yt).confidence||0)*100)))]),M(Y,ft)};Z(G,Y=>{t(Yt)&&Y(J)})}d(T);var vt=u(T,2);{var nt=Y=>{var ft=Gg(),ot=v(ft),xt=v(ot),$t=v(xt);d(xt);var St=u(xt,2);let Ge;var Ft=v(St);d(St),d(ot);var ae=u(ot,2),Ie=v(ae),oe=v(Ie);d(Ie);var tn=u(Ie,2),Ne=v(tn);d(tn);var Mn=u(tn,2),be=v(Mn);d(Mn);var Ot=u(Mn,2),Ke=v(Ot);d(Ot),d(ae);var Ve=u(ae,2);{var qn=gr=>{var Bn=Jg(),Tn=v(Bn);d(Bn),rt(jn=>D(Tn,`依据：${jn??""}`),[()=>(t(Yt),_(()=>String(t(Yt).evidence[0]||"")))]),M(gr,Bn)},Nr=$a(()=>(t(Yt),_(()=>Array.isArray(t(Yt).evidence)&&t(Yt).evidence.length>0)));Z(Ve,gr=>{t(Nr)&&gr(qn)})}var gn=u(Ve,2),ur=v(gn,!0);d(gn),d(ft),rt((gr,Bn,Tn,jn,Xn,Mr,_r,zr)=>{D($t,`阈值 ${gr??""}%`),Ge=Me(St,1,"svelte-13mrafj",null,Ge,Bn),D(Ft,`判定 ${Tn??""}`),D(oe,`重复率 ${jn??""}%`),D(Ne,`词汇多样性 ${Xn??""}%`),D(be,`熵 ${Mr??""}%`),D(Ke,`句长波动 ${_r??""}%`),D(ur,zr)},[()=>(t(Yt),_(()=>Math.round(Number(t(Yt).threshold||.65)*100))),()=>({danger:!!t(Yt).suspected_ai}),()=>(t(Yt),_(()=>t(Yt).suspected_ai?"疑似AI生成":"未超阈值")),()=>(t(Yt),_(()=>Math.round(Number(t(Yt).signals?.repeated_3gram_ratio||0)*100))),()=>(t(Yt),_(()=>Math.round(Number(t(Yt).signals?.lexical_diversity||0)*100))),()=>(t(Yt),_(()=>Math.round(Number(t(Yt).signals?.token_entropy_norm||0)*100))),()=>(t(Yt),_(()=>Math.round(Number(t(Yt).signals?.sentence_burstiness_cv||0)*100))),()=>(t(Yt),_(()=>String(t(Yt).note||"")))]),M(Y,ft)};Z(vt,Y=>{t(Yt)&&Y(nt)})}d(y),d(c),rt(()=>{N.disabled=t(Pn),D(V,t(Pn)?"检测中...":"开始 AI 率检测")}),rn($,()=>t(Fr),Y=>f(Fr,Y)),C("click",N,vo),M(l,c)};Z(su,l=>{t(kr)&&l(Gd)})}var au=u(su,2);{var Kd=l=>{var c=e_(),y=u(v(c),2),x=v(y),$=u(v(x),2);Zn($);var T=u($,4);Zn(T),d(x);var N=u(x,2),V=u(v(N),2);hs(V),d(N);var G=u(N,2),J=v(G),vt=v(J,!0);d(J);var nt=u(J,2),Y=v(nt,!0);d(nt);var ft=u(nt,2);{var ot=Ft=>{var ae=Vg(),Ie=v(ae);d(ae),rt((oe,tn)=>D(Ie,`最高重复分数 ${oe??""}%，
                  风险等级 ${tn??""}，
                  超阈值来源 ${t($r)??""} 个`),[()=>(t(Hn),_(()=>Math.round(t(Hn)*100))),()=>(t(Hn),_(()=>lo(t(Hn))))]),M(Ft,ae)};Z(ft,Ft=>{t(yn),_(()=>t(yn).length>0)&&Ft(ot)})}d(G);var xt=u(G,2);{var $t=Ft=>{var ae=Xg(),Ie=v(ae),oe=v(Ie);d(Ie);var tn=u(Ie,2),Ne=u(tn,2),Mn=u(Ne,2);d(ae),rt(()=>D(oe,`报告ID ${t(Rt),_(()=>t(Rt).report_id)??""} · 来源 ${t(Rt),_(()=>t(Rt).total_references)??""} · 超阈值 ${t(Rt),_(()=>t(Rt).flagged_count)??""}`)),C("click",tn,()=>ha("json")),C("click",Ne,()=>ha("md")),C("click",Mn,()=>ha("csv")),M(Ft,ae)};Z(xt,Ft=>{t(Rt)&&Ft($t)})}var St=u(xt,2);{var Ge=Ft=>{var ae=t_();on(ae,5,()=>t(yn),Fn,(Ie,oe)=>{var tn=Zg(),Ne=v(tn),Mn=v(Ne),be=v(Mn),Ot=u(be);{var Ke=En=>{var ii=Yg(),ts=v(ii);d(ii),rt(()=>D(ts,`(${t(oe),_(()=>t(oe).reference_id)??""})`)),M(En,ii)};Z(Ot,En=>{t(oe),_(()=>t(oe).reference_id)&&En(Ke)})}d(Mn);var Ve=u(Mn,2);let qn;var Nr=v(Ve);d(Ve),d(Ne);var gn=u(Ne,2),ur=v(gn),gr=v(ur);d(ur);var Bn=u(ur,2),Tn=v(Bn);d(Bn);var jn=u(Bn,2),Xn=v(jn);d(jn);var Mr=u(jn,2),_r=v(Mr);d(Mr),d(gn);var zr=u(gn,2);{var br=En=>{var ii=Qg(),ts=v(ii);d(ii),rt(ds=>D(ts,`证据片段：${ds??""}`),[()=>(t(oe),_(()=>String(t(oe).evidence[0]?.snippet||"").slice(0,120)))]),M(En,ii)};Z(zr,En=>{t(oe),_(()=>t(oe).evidence&&t(oe).evidence.length>0)&&En(br)})}d(tn),rt((En,ii,ts,ds,Qs,_a)=>{D(be,`${t(oe),_(()=>t(oe).reference_title||t(oe).reference_id)??""} `),qn=Me(Ve,1,"svelte-13mrafj",null,qn,{danger:t(oe).suspected}),D(Nr,`分数 ${En??""}% / 阈值 ${ii??""}%`),D(gr,`Containment ${ts??""}%`),D(Tn,`Jaccard ${ds??""}%`),D(Xn,`Winnowing ${Qs??""}%`),D(_r,`Longest ${_a??""} chars`)},[()=>(t(oe),_(()=>Math.round(t(oe).score*100))),()=>(t(oe),_(()=>Math.round(t(oe).threshold*100))),()=>(t(oe),_(()=>Math.round(Number(t(oe).metrics?.containment||0)*100))),()=>(t(oe),_(()=>Math.round(Number(t(oe).metrics?.jaccard_resemblance||0)*100))),()=>(t(oe),_(()=>Math.round(Number(t(oe).metrics?.winnowing_overlap||0)*100))),()=>(t(oe),_(()=>Number(t(oe).metrics?.longest_match_chars||0)))]),M(Ie,tn)}),d(ae),M(Ft,ae)};Z(St,Ft=>{t(yn),_(()=>t(yn).length>0)&&Ft(Ge)})}d(y),d(c),rt(()=>{J.disabled=t(bn),D(vt,t(bn)?"检测中...":"开始查重"),nt.disabled=t(Ye),D(Y,t(Ye)?"全库扫描中...":"全库查重")}),rn($,()=>t(pr),Ft=>f(pr,Ft)),rn(T,()=>t(ei),Ft=>f(ei,Ft)),rn(V,()=>t(sn),Ft=>f(sn,Ft)),C("click",J,co),C("click",nt,po),M(l,c)};Z(au,l=>{t(un)&&l(Kd)})}var ou=u(au,2);{var Vd=l=>{var c=o_(),y=u(v(c),2),x=v(y),$=u(v(x),2);on($,4,()=>[1,2,3,4,5],Fn,(Ft,ae)=>{var Ie=n_(),oe=v(Ie,!0);d(Ie),rt(()=>{Me(Ie,1,`rating-btn ${t(vr)===ae?"active":""}`,"svelte-13mrafj"),js(Ie,"data-testid",`rating-${ae}`),D(oe,ae)}),C("click",Ie,()=>f(vr,ae)),M(Ft,Ie)}),d($);var T=u($,4),N=v(T);N.value=N.__value="general";var V=u(N);V.value=V.__value="stage1";var G=u(V);G.value=G.__value="stage2";var J=u(G);J.value=J.__value="final",d(T),d(x);var vt=u(x,2),nt=u(v(vt),2);hs(nt),d(vt);var Y=u(vt,2),ft=v(Y),ot=v(ft,!0);d(ft);var xt=u(ft,2);{var $t=Ft=>{var ae=r_(),Ie=v(ae);d(ae),rt(()=>D(Ie,`已记录低满意度样本 ${t(Re)??""} 条`)),M(Ft,ae)};Z(xt,Ft=>{t(Re)>0&&Ft($t)})}d(Y);var St=u(Y,2);{var Ge=Ft=>{var ae=a_(),Ie=u(v(ae),2);on(Ie,1,()=>(t(Se),_(()=>t(Se).slice(0,5))),Fn,(oe,tn)=>{var Ne=s_(),Mn=v(Ne),be=v(Mn),Ot=v(be);d(be);var Ke=u(be,2),Ve=v(Ke,!0);d(Ke),d(Mn);var qn=u(Mn,2);{var Nr=gn=>{var ur=i_(),gr=v(ur,!0);d(ur),rt(()=>D(gr,(t(tn),_(()=>t(tn).note)))),M(gn,ur)};Z(qn,gn=>{t(tn),_(()=>t(tn).note)&&gn(Nr)})}d(Ne),rt(gn=>{D(Ot,`${t(tn),_(()=>t(tn).rating)??""}/5 · ${t(tn),_(()=>t(tn).stage)??""}`),D(Ve,gn)},[()=>(t(tn),_(()=>oo(t(tn).created_at)))]),M(oe,Ne)}),d(ae),M(Ft,ae)};Z(St,Ft=>{t(Se),_(()=>t(Se).length>0)&&Ft(Ge)})}d(y),d(c),rt(()=>{ft.disabled=t(_n),D(ot,t(_n)?"提交中...":"提交评分")}),$s(T,()=>t(er),Ft=>f(er,Ft)),rn(nt,()=>t(On),Ft=>f(On,Ft)),C("click",ft,Qo),M(l,c)};Z(ou,l=>{t(Ut)&&l(Vd)})}var lu=u(ou,2),Xd=v(lu);{var Yd=l=>{ld(l,{})},Qd=l=>{{let c=Na(()=>t(Tt)||t(kt));nd(l,{showToolbar:!1,paper:!0,get lockEditing(){return t(c)},$$events:{blockedit:zi,blockselect:Xo,toolbarstate:Ss}})}};Z(Xd,l=>{B()?l(Yd):l(Qd,!1)})}d(lu),d(al);var cu=u(al,2),uu=v(cu),yl=v(uu),Zd=u(v(yl),2);d(yl);var wl=u(yl,2),xl=v(wl);Zn(xl);var tv=u(xl,2);d(wl);var fu=u(wl,2);{var ev=l=>{var c=l_();M(l,c)},nv=l=>{var c=c_(),y=v(c,!0);d(c),rt(()=>D(y,t(pe))),M(l,c)},rv=l=>{var c=u_();M(l,c)},iv=l=>{var c=h_();on(c,5,()=>t(Ze),Fn,(y,x)=>{var $=m_(),T=v($),N=v(T),V=v(N),G=v(V,!0);d(V);var J=u(V,2),vt=v(J,!0);d(J),d(N);var nt=u(N,2),Y=v(nt),ft=v(Y,!0);d(Y);var ot=u(Y,2),xt=v(ot,!0);d(ot),d(nt);var $t=u(nt,2);{var St=Ne=>{var Mn=f_(),be=v(Mn,!0);d(Mn),rt(Ot=>D(be,Ot),[()=>(t(x),_(()=>ga(t(x).major?.summary)))]),M(Ne,Mn)},Ge=$a(()=>(t(x),_(()=>ga(t(x).major?.summary))));Z($t,Ne=>{t(Ge)&&Ne(St)})}var Ft=u($t,2),ae=v(Ft),Ie=u(ae,2);d(Ft),d(T);var oe=u(T,2);{var tn=Ne=>{var Mn=p_();on(Mn,5,()=>(t(x),_(()=>t(x).minors)),Fn,(be,Ot)=>{var Ke=v_(),Ve=v(Ke),qn=v(Ve),Nr=v(qn,!0);d(qn);var gn=u(qn,2);{var ur=_r=>{var zr=d_(),br=v(zr,!0);d(zr),rt(En=>D(br,En),[()=>(t(Ot),_(()=>ga(t(Ot).summary)))]),M(_r,zr)},gr=$a(()=>(t(Ot),_(()=>ga(t(Ot).summary))));Z(gn,_r=>{t(gr)&&_r(ur)})}var Bn=u(gn,2),Tn=v(Bn,!0);d(Bn),d(Ve);var jn=u(Ve,2),Xn=v(jn),Mr=u(Xn,2);d(jn),d(Ke),rt(_r=>{Me(Ke,1,(t(Ot),_(()=>`version-minor ${t(Ot).is_current?"current":""}`)),"svelte-13mrafj"),D(Nr,(t(Ot),_(()=>t(Ot).message||"未命名"))),D(Tn,_r),Xn.disabled=(t(Ot),_(()=>t(Ot).is_current)),Mr.disabled=(t(Ot),_(()=>t(Ot).is_current))},[()=>(t(Ot),_(()=>Ha(t(Ot).timestamp)))]),C("click",Xn,()=>Ec(t(Ot).version_id)),C("click",Mr,()=>Ac(t(Ot).version_id)),M(be,Ke)}),d(Mn),M(Ne,Mn)};Z(oe,Ne=>{t(x),_(()=>t(x).minors&&t(x).minors.length)&&Ne(tn)})}d($),rt((Ne,Mn)=>{Me(T,1,(t(x),_(()=>`version-major ${t(x).major?.is_current?"current":""}`)),"svelte-13mrafj"),D(G,(t(x),_(()=>t(x).major?.message||"未命名"))),Me(J,1,(t(x),_(()=>`badge ${t(x).major?.kind==="major"?"major":"minor"}`)),"svelte-13mrafj"),D(vt,(t(x),_(()=>t(x).major?.kind==="major"?"大版本":"小版本"))),D(ft,Ne),D(xt,Mn),ae.disabled=(t(x),_(()=>t(x).major?.is_current)),Ie.disabled=(t(x),_(()=>t(x).major?.is_current))},[()=>(t(x),_(()=>Ha(t(x).major?.timestamp||0))),()=>(t(x),_(()=>String(t(x).major?.version_id||"").slice(0,7)))]),C("click",ae,()=>Ec(t(x).major?.version_id)),C("click",Ie,()=>Ac(t(x).major?.version_id)),M(y,$)}),d(c),M(l,c)};Z(fu,l=>{t(ve)?l(ev):t(pe)?l(nv,1):(t(Ze),_(()=>t(Ze).length===0)?l(rv,2):l(iv,!1))})}var du=u(fu,2),vu=u(v(du),2),sv=v(vu,!0);d(vu),d(du),d(uu),d(cu),d(il);var pu=u(il,2);{var av=l=>{var c=g_(),y=v(c),x=v(y);ms(),d(y);var $=u(y,2),T=v($),N=u(T,2),V=u(N,2),G=u(V,2),J=u(G,2),vt=u(J,2),nt=u(vt,2);d($),d(c),rt(()=>{Ts(c,`left:${t(qi)}px;top:${t(ui)}px;`),D(x,`已选中 ${t(qt),_(()=>t(qt).length)??""} 项 `),T.disabled=t(ue),N.disabled=t(ue),V.disabled=t(ue),G.disabled=t(ue)}),C("click",T,()=>hr("rewrite","down")),C("click",N,()=>hr("style","down")),C("click",V,Dc),C("click",G,Bc),C("click",J,()=>hr("assistant","down")),C("click",vt,()=>hr(t(Ee),"up")),C("click",nt,()=>hr(t(Ee),"down")),M(l,c)};Z(pu,l=>{t(qt),t(ni),_(()=>t(qt).length>0&&t(ni))&&l(av)})}var mu=u(pu,2);{var ov=l=>{var c=E_(),y=v(c),x=u(v(y),2),$=v(x),T=u($,2),N=u(T,2),V=u(N,2),G=u(V,2);d(x),d(y);var J=u(y,2),vt=v(J),nt=u(vt,2),Y=u(nt,2);d(J);var ft=u(J,2);on(ft,5,()=>t(ye),Fn,(be,Ot,Ke)=>{var Ve=__(),qn=v(Ve,!0);d(Ve),rt(()=>{js(Ve,"title",(t(Ot),_(()=>t(Ot).text))),D(qn,(t(Ot),_(()=>t(Ot).kind==="section"||t(Ot).kind==="title"?`标题${Ke+1}`:`块${Ke+1}`)))}),M(be,Ve)}),d(ft);var ot=u(ft,2);{var xt=be=>{var Ot=b_(),Ke=v(Ot,!0);d(Ot),rt(()=>D(Ke,t(Sn))),M(be,Ot)};Z(ot,be=>{t(ue)&&be(xt)})}var $t=u(ot,2);{var St=be=>{var Ot=y_(),Ke=wr(Ot),Ve=u(v(Ke),2),qn=v(Ve);qn.value=qn.__value="";var Nr=u(qn);Nr.value=Nr.__value="宋体";var gn=u(Nr);gn.value=gn.__value="黑体";var ur=u(gn);ur.value=ur.__value="微软雅黑";var gr=u(ur);gr.value=gr.__value="楷体";var Bn=u(gr);Bn.value=Bn.__value="仿宋",d(Ve);var Tn=u(Ve,4),jn=v(Tn);jn.value=jn.__value="";var Xn=u(jn);Xn.value=Xn.__value="12pt";var Mr=u(Xn);Mr.value=Mr.__value="14pt";var _r=u(Mr);_r.value=_r.__value="16pt";var zr=u(_r);zr.value=zr.__value="18pt";var br=u(zr);br.value=br.__value="20pt",d(Tn);var En=u(Tn,4),ii=v(En);ii.value=ii.__value="";var ts=u(ii);ts.value=ts.__value="1.2";var ds=u(ts);ds.value=ds.__value="1.5";var Qs=u(ds);Qs.value=Qs.__value="1.75";var _a=u(Qs);_a.value=_a.__value="2",d(En);var ba=u(En,4),kl=v(ba);kl.value=kl.__value="";var $l=u(kl);$l.value=$l.__value="left";var Tl=u($l);Tl.value=Tl.__value="center";var jl=u(Tl);jl.value=jl.__value="right";var bu=u(jl);bu.value=bu.__value="justify",d(ba);var ya=u(ba,4),El=v(ya);El.value=El.__value="";var Al=u(El);Al.value=Al.__value="400";var Cl=u(Al);Cl.value=Cl.__value="500";var Il=u(Cl);Il.value=Il.__value="600";var yu=u(Il);yu.value=yu.__value="700",d(ya);var wa=u(ya,4),Nl=v(wa);Nl.value=Nl.__value="";var Ml=u(Nl);Ml.value=Ml.__value="normal";var wu=u(Ml);wu.value=wu.__value="italic",d(wa);var Wa=u(wa,4);Zn(Wa);var To=u(Wa,4);Zn(To),d(Ke),ms(2),rt(()=>{Ve.disabled=t(ue),Tn.disabled=t(ue),En.disabled=t(ue),ba.disabled=t(ue),ya.disabled=t(ue),wa.disabled=t(ue),Wa.disabled=t(ue),To.disabled=t(ue)}),$s(Ve,()=>t(nr),pi=>f(nr,pi)),C("change",Ve,()=>h({fontFamily:t(nr)})),$s(Tn,()=>t(Oe),pi=>f(Oe,pi)),C("change",Tn,()=>h({fontSize:t(Oe)})),$s(En,()=>t(Je),pi=>f(Je,pi)),C("change",En,()=>h({lineHeight:t(Je)})),$s(ba,()=>t(ke),pi=>f(ke,pi)),C("change",ba,()=>h({align:t(ke)})),$s(ya,()=>t(le),pi=>f(le,pi)),C("change",ya,()=>h({fontWeight:t(le)})),$s(wa,()=>t(ce),pi=>f(ce,pi)),C("change",wa,()=>h({fontStyle:t(ce)})),rn(Wa,()=>t(yt),pi=>f(yt,pi)),C("change",Wa,()=>h({color:t(yt)})),rn(To,()=>t(re),pi=>f(re,pi)),C("change",To,()=>h({background:t(re)})),M(be,Ot)};Z($t,be=>{t(Ee)==="style"&&be(St)})}var Ge=u($t,2);{var Ft=be=>{var Ot=w_(),Ke=u(v(Ot),2);hs(Ke);var Ve=u(Ke,2),qn=v(Ve),Nr=u(qn,2);d(Ve),d(Ot),rn(Ke,()=>t(ci),gn=>f(ci,gn)),C("click",qn,()=>{f(Ht,t(ci).trim()),f(Ee,"rewrite")}),C("click",Nr,()=>L(t(ci))),M(be,Ot)};Z(Ge,be=>{t(Ee)==="assistant"&&be(Ft)})}var ae=u(Ge,2);{var Ie=be=>{var Ot=S_(),Ke=wr(Ot),Ve=v(Ke),qn=u(Ve,2),Nr=u(qn,2),gn=u(Nr,2);d(Ke);var ur=u(Ke,2),gr=v(ur);hs(gr),d(ur);var Bn=u(ur,2),Tn=v(Bn),jn=u(Tn,2),Xn=v(jn,!0);d(jn),d(Bn);var Mr=u(Bn,2);{var _r=br=>{var En=x_();M(br,En)},zr=$a(()=>_(I));Z(Mr,br=>{t(zr)&&br(_r)})}rt(br=>{jn.disabled=br,D(Xn,t(Or)?"正在生成建议...":"生成建议（不改原文）")},[()=>(t(ue),t(Or),t(Ht),_(()=>t(ue)||t(Or)||!t(Ht).trim()||I()))]),C("click",Ve,()=>R("语气更正式，保留原意")),C("click",qn,()=>R("压缩到更简洁，控制在80字左右")),C("click",Nr,()=>R("增加解释细节，但不要扩展事实")),C("click",gn,()=>R("保持术语不变，仅调整表达")),rn(gr,()=>t(Ht),br=>f(Ht,br)),C("click",Tn,()=>hr("assistant",t(rr))),C("click",jn,K),M(be,Ot)};Z(ae,be=>{t(Ee)==="rewrite"&&be(Ie)})}var oe=u(ae,2);{var tn=be=>{var Ot=k_(),Ke=v(Ot,!0);d(Ot),rt(()=>D(Ke,t(zt))),M(be,Ot)};Z(oe,be=>{t(zt)&&be(tn)})}var Ne=u(oe,2);{var Mn=be=>{var Ot=j_(),Ke=v(Ot),Ve=u(v(Ke),2),qn=v(Ve,!0);d(Ve),d(Ke);var Nr=u(Ke,2),gn=v(Nr);on(gn,5,()=>t(Ae),Fn,(Bn,Tn,jn)=>{var Xn=$_(),Mr=v(Xn),_r=v(Mr,!0);d(Mr);var zr=u(Mr,2),br=v(zr,!0);d(zr),d(Xn),rt(En=>{Me(Xn,1,`candidate-switch ${t(Wn)===jn?"active":""}`,"svelte-13mrafj"),D(_r,(t(Tn),_(()=>t(Tn).label))),D(br,En)},[()=>(t(Tn),_(()=>Q(t(Tn))))]),C("click",Xn,()=>f(Wn,jn)),M(Bn,Xn)}),d(gn);var ur=u(gn,2);{var gr=Bn=>{var Tn=T_(),jn=v(Tn),Xn=v(jn),Mr=v(Xn,!0);d(Xn);var _r=u(Xn,2),zr=v(_r,!0);d(_r),d(jn);var br=u(jn,2),En=v(br),ii=u(En,2),ts=u(ii,2);d(br);var ds=u(br,4),Qs=v(ds,!0);d(ds),d(Tn),rt(_a=>{D(Mr,(t(Tr),_(()=>t(Tr).label))),D(zr,_a),En.disabled=t(ue),D(Qs,(t(Tr),_(()=>t(Tr).selectedAfter)))},[()=>(t(Tr),_(()=>Q(t(Tr))))]),C("click",En,()=>st(t(Wn))),C("click",ii,K),C("click",ts,gt),M(Bn,Tn)};Z(ur,Bn=>{t(Tr)&&Bn(gr)})}d(Nr),d(Ot),rt(()=>D(qn,t(Cn)||t(je))),M(be,Ot)};Z(Ne,be=>{t(Ae),_(()=>t(Ae).length>0)&&be(Mn)})}d(c),rt(()=>{Me(c,1,`inline-edit-popover ${t(rr)}`,"svelte-13mrafj"),Ts(c,`left:${t(Jr)}px;top:${t(xn)}px;`),$.disabled=t(ue),T.disabled=t(ue),Me(vt,1,`inline-tab ${t(Ee)==="rewrite"?"active":""}`,"svelte-13mrafj"),Me(nt,1,`inline-tab ${t(Ee)==="style"?"active":""}`,"svelte-13mrafj"),Me(Y,1,`inline-tab ${t(Ee)==="assistant"?"active":""}`,"svelte-13mrafj")}),C("click",$,Dc),C("click",T,Bc),C("click",N,()=>hr(t(Ee),"up")),C("click",V,()=>hr(t(Ee),"down")),C("click",G,vi),C("click",vt,()=>Hi("rewrite")),C("click",nt,()=>Hi("style")),C("click",Y,()=>Hi("assistant")),M(l,c)};Z(mu,l=>{t(Qe),t(qt),_(()=>t(Qe)&&t(qt).length>0)&&l(ov)})}var ko=u(mu,2),$o=v(ko),hu=v($o),lv=u(hu);{var cv=l=>{var c=A_(),y=v(c,!0);d(c),rt(()=>D(y,(t(In),_(()=>t(In).length)))),M(l,c)};Z(lv,l=>{t(In),_(()=>t(In).length>0)&&l(cv)})}d($o);var uv=u($o,2);{var fv=l=>{zf(l,{variant:"assistant",$$events:{send:c=>go(c.detail),upload:jd}})};Z(uv,l=>{t(wn)&&l(fv)})}d(ko);var Sl=u(ko,2);wc(Sl,l=>f(Jn,l),()=>t(Jn));var gu=u(Sl,2);{var dv=l=>{var c=C_(),y=v(c),x=u(v(y),2),$=v(x);d(x);var T=u(x,2),N=v(T,!0);d(T);var V=u(T,2),G=v(V),J=u(G,2),vt=v(J,!0);d(J),d(V),d(y),d(c),rt(()=>{D($,`风险等级 ${t(en),_(()=>t(en).riskLevel)??""} · 计划来源 ${t(en),_(()=>t(en).planSource)??""}
          · 操作数 ${t(en),_(()=>t(en).operationsCount)??""}`),D(N,(t(en),_(()=>t(en).note||"该请求会执行高风险文本改动，请确认是否继续。"))),G.disabled=t(Sr),J.disabled=t(Sr),D(vt,t(Sr)?"执行中...":"确认执行")}),C("click",G,kd),C("click",J,Sd),M(l,c)};Z(gu,l=>{t(en)&&l(dv)})}var vv=u(gu,2);{var pv=l=>{cd(l,{indeterminate:!0})};Z(vv,l=>{i()&&l(pv)})}d(_o);var _u=u(_o,2);rd(_u,{get open(){return t(zn)},get docId(){return s()},$$events:{close:()=>f(zn,!1),insert:l=>at(l.detail.spec)}});var mv=u(_u,2);ud(mv,{children:(l,c)=>{var y=I_(),x=wr(y);id(x,{});var $=u(x,2);od($,{onSelect:yd,get visible(){return t(Ri)},set visible(V){f(Ri,V)},$$legacy:!0});var T=u($,2);fd(T,{get visible(){return t(X)},set visible(V){f(X,V)},$$legacy:!0});var N=u(T,2);vd(N,{get visible(){return t(ht)},set visible(V){f(ht,V)},$$legacy:!0}),M(l,y)},$$slots:{default:!0}}),rt(()=>{Rc=Me(_o,1,"app svelte-13mrafj",null,Rc,{dark:j()}),D(Id,m()||"未加载"),D(Nd,`字数 ${w()??""}`),D(Dd,t(kr)?"收起AI率":"AI率检测"),D(Ld,t(un)?"收起查重":"查重检测"),D(Rd,t(Ut)?"收起评分":"满意度评分"),cl.disabled=(t(Zt),_(()=>!t(Zt).canUndo)),ul.disabled=(t(Zt),_(()=>!t(Zt).canRedo)),fl.disabled=(t(Zt),_(()=>!t(Zt).canCopy)),dl.disabled=(t(Zt),_(()=>!t(Zt).canCut)),vl.disabled=(t(Zt),_(()=>!t(Zt).canPaste)),pl.disabled=(t(Zt),_(()=>t(Zt).readonly||!t(Zt).focused)),Me(xo,1,(t(Zt),_(()=>`tool-btn ${t(Zt).bold?"active":""}`)),"svelte-13mrafj"),xo.disabled=(t(Zt),_(()=>t(Zt).readonly||!t(Zt).focused)),Me(So,1,(t(Zt),_(()=>`tool-btn ${t(Zt).italic?"active":""}`)),"svelte-13mrafj"),So.disabled=(t(Zt),_(()=>t(Zt).readonly||!t(Zt).focused)),Me(ml,1,(t(Zt),_(()=>`tool-btn ${t(Zt).underline?"active":""}`)),"svelte-13mrafj"),ml.disabled=(t(Zt),_(()=>t(Zt).readonly||!t(Zt).focused)),_l.disabled=i(),bl.disabled=!i(),D(sv,t(Qt)||"请选择版本进行对比"),Me(ko,1,`assistant-dock ${t(wn)?"open":""}`,"svelte-13mrafj"),D(hu,`${t(wn)?"收起助手":"打开助手"} `)}),C("click",Hc,ri),C("click",zc,wd),C("click",Wc,bd),C("click",bo,()=>f(kr,!t(kr))),C("click",yo,()=>f(un,!t(un))),C("click",wo,()=>f(Ut,!t(Ut))),C("click",Uc,()=>f(zn,!0)),C("click",Jc,()=>f(X,!0)),C("click",Gc,()=>f(ht,!0)),C("click",Fd,()=>f(Ri,!0)),C("click",cl,()=>Xr("undo")),C("click",ul,()=>Xr("redo")),C("click",fl,()=>Xr("copy")),C("click",dl,()=>Xr("cut")),C("click",vl,()=>Xr("paste")),C("click",pl,()=>Xr("clear-format")),C("click",xo,()=>Xr("bold")),C("click",So,()=>Xr("italic")),C("click",ml,()=>Xr("underline")),C("click",Vc,()=>Xr("heading1")),C("click",Xc,()=>Xr("heading2")),C("click",Yc,()=>Xr("quote")),C("click",Qc,()=>Xr("code")),C("click",Zc,()=>Xr("list-bullet")),C("click",Od,()=>Xr("list-number")),C("click",tu,()=>f(zn,!0)),C("click",Pd,()=>f(X,!0)),C("click",_l,()=>go(k())),C("click",bl,Ad),C("click",Zd,za),rn(xl,()=>t(qe),l=>f(qe,l)),C("click",tv,gd),C("click",$o,()=>f(wn,!t(wn))),C("change",Sl,Td),M(e,Lc);var hv=li(Cd);return O(),hv}function md(e,n){if(new.target)return mi({component:md,...e});oi(n,!1);var i={$set:gi,$on:(r,a)=>hi(n,r,a)};return pd(e,{}),li(i)}const Uu=document.getElementById("app");Uu&&new md({target:Uu});
