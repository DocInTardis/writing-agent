{% extends "v2_base2.html" %}
{% block content %}
<div class="app" data-doc-id="{{ doc_id }}">
  <header class="topbar">
    <div class="brand">
      <div class="logo">WA</div>
      <div class="brand-text">
        <div class="brand-title">写作 Agent 工作台</div>
        <div class="brand-sub">图谱流程 · 文本优先 · 本地 Ollama</div>
      </div>
    </div>
    <div class="top-actions">
      <a class="link" href="/download/{{ doc_id }}.docx">导出 .docx</a>
      <button id="btnNew" class="btn ghost" type="button">新建空白</button>
    </div>
  </header>

  <main class="layout">
    <section class="panel doc">
      <div class="panel-head">
        <div class="doc-head-left">
          <div class="tabs">
            <button class="tab active" data-tab="preview" type="button">预览</button>
            <button class="tab" data-tab="source" type="button">源文本</button>
          </div>
          <div class="toolbar" role="toolbar" aria-label="文档工具栏">
            <button class="tool-btn" id="tbH1" type="button" title="标题 (#)">H1</button>
            <button class="tool-btn" id="tbH2" type="button" title="章节 (##)">H2</button>
            <button class="tool-btn" id="tbH3" type="button" title="小节 (###)">H3</button>
            <div class="tool-sep"></div>
            <button class="tool-btn" id="tbTable" type="button" title="插入表格标记">表格</button>
            <button class="tool-btn" id="tbFigure" type="button" title="插入图表标记">图表</button>
            <div class="tool-sep"></div>
            <button class="tool-btn" id="tbSkeleton" type="button" title="插入毕业设计骨架">骨架</button>
          </div>
        </div>
        <div class="doc-meta">
          <span id="docStatus" class="pill">就绪</span>
          <span id="wordCount" class="muted"></span>
        </div>
      </div>

      <div class="doc-body">
        <div id="preview" class="paper"></div>
        <textarea
          id="source"
          class="source hidden"
          placeholder="空白文档：你可以直接写，也可以在右侧用自然语言描述生成要求。"
        ></textarea>
      </div>
    </section>

    <aside class="panel side">
      <div class="panel-head">
        <div class="side-title">指令与设置</div>
        <div class="muted">像说话一样描述你的需求。</div>
      </div>

      <div class="side-body">
        <div class="card">
          <div class="card-title">模板</div>
          <div class="muted">上传 .docx/.html/.txt/.md，系统仅提取章节结构作为生成约束。</div>
          <input id="templateFile" type="file" accept=".docx,.html,.htm,.txt,.md" />
          <div id="templateInfo" class="muted"></div>
        </div>

        <div class="card">
          <div class="card-title">文档格式</div>
          <div class="muted">用于生成约束与 .docx 导出。</div>
          <div class="form-grid">
            <label class="field">
              <span class="field-label">用途</span>
              <select id="settingPurpose" class="select">
                <option value="毕业设计/课程设计报告">毕业设计/课程设计报告</option>
                <option value="论文/学术报告">论文/学术报告</option>
                <option value="项目文档/设计说明书">项目文档/设计说明书</option>
              </select>
            </label>
            <label class="field">
              <span class="field-label">字号</span>
              <select id="settingFontSize" class="select">
                <option value="小四|12">小四 (12pt)</option>
                <option value="五号|10.5">五号 (10.5pt)</option>
                <option value="小五|9">小五 (9pt)</option>
                <option value="四号|14">四号 (14pt)</option>
              </select>
            </label>
            <label class="field">
              <span class="field-label">行距</span>
              <select id="settingLineSpacing" class="select">
                <option value="1.5">1.5</option>
                <option value="1.0">1.0</option>
                <option value="1.15">1.15</option>
                <option value="2.0">2.0</option>
              </select>
            </label>
            <label class="field">
              <span class="field-label">导出</span>
              <div class="chips" style="margin-top:0">
                <label class="chip"><input id="settingCover" type="checkbox" checked />封面</label>
                <label class="chip"><input id="settingToc" type="checkbox" checked />目录</label>
                <label class="chip"><input id="settingHeader" type="checkbox" checked />页眉</label>
                <label class="chip"><input id="settingPageNo" type="checkbox" checked />页码</label>
              </div>
            </label>
          </div>
          <div class="muted" style="margin-top:8px;">偏好图类型（系统会选择插入位置）：</div>
          <div class="chips" id="figureChips">
            <label class="chip"><input type="checkbox" value="flow" checked />流程图</label>
            <label class="chip"><input type="checkbox" value="er" checked />ER 图</label>
            <label class="chip"><input type="checkbox" value="sequence" checked />时序图</label>
            <label class="chip"><input type="checkbox" value="timeline" />时间轴</label>
            <label class="chip"><input type="checkbox" value="bar" checked />柱状图</label>
            <label class="chip"><input type="checkbox" value="line" checked />折线图</label>
            <label class="chip"><input type="checkbox" value="pie" />饼图</label>
          </div>
          <div class="row">
            <button id="btnApplySettings" class="btn ghost" type="button">应用</button>
          </div>
        </div>

        <div class="card">
          <div class="card-title">生成</div>
          <textarea id="instruction" class="input" placeholder="例如：写一份关于 XXX 的毕业设计报告，包含必要的表格与图，方法部分给出流程与时序图占位，不要编造数据，用 [待补充] 占位。"></textarea>
          <div class="row">
            <button id="btnGenerate" class="btn primary" type="button">开始生成</button>
            <button id="btnStop" class="btn ghost" type="button" disabled>停止</button>
          </div>
        </div>

        <div class="card">
          <div class="card-title">生成流程</div>
          <div id="graph" class="graph">
            <div class="node" data-state="PLAN">规划</div>
            <div class="node" data-state="DRAFT_SECTIONS">起草</div>
            <div class="node" data-state="AGGREGATE">合并</div>
            <div class="node" data-state="VALIDATE">校验</div>
            <div class="node" data-state="REPAIR">修复</div>
          </div>
          <div id="problems" class="problems hidden"></div>
        </div>
      </div>
    </aside>
  </main>
</div>

<script src="/static/v2.js" defer></script>
{% endblock %}
