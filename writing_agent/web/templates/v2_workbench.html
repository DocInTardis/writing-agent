{% extends "v2_base.html" %}
{% block content %}
<div class="app" data-doc-id="{{ doc_id }}">
  <header class="topbar">
    <div class="brand">
      <div class="logo">WA</div>
      <div class="brand-text">
        <div class="brand-title">写作 Agent 工作台</div>
        <div class="brand-sub">图谱流程 · 文本优先 · 本地 Ollama</div>
      </div>
    </div>
    <div class="top-actions">
      <a class="link" href="/download/{{ doc_id }}.docx">导出 docx</a>
      <button id="btnNew" class="btn ghost" type="button">新建空白</button>
    </div>
  </header>

  <main class="layout">
    <section class="panel doc">
      <div class="panel-head">
        <div class="tabs">
          <button class="tab active" data-tab="preview" type="button">预览</button>
          <button class="tab" data-tab="source" type="button">源文本</button>
        </div>
        <div class="doc-meta">
          <span id="docStatus" class="pill">就绪</span>
          <span id="wordCount" class="muted"></span>
        </div>
      </div>

      <div class="doc-body">
        <div id="preview" class="paper"></div>
        <textarea id="source" class="source hidden" placeholder="空白文档：你可以直接写，也可以在右侧用自然语言描述生成要求…"></textarea>
      </div>
    </section>

    <aside class="panel side">
      <div class="panel-head">
        <div class="side-title">指令与配置</div>
        <div class="muted">不需要填表，像说话一样输入要求</div>
      </div>

      <div class="side-body">
        <div class="card">
          <div class="card-title">模板</div>
          <div class="muted">上传报告/论文模板（.docx/.html/.txt/.md），只提取章节结构用于约束生成。</div>
          <input id="templateFile" type="file" accept=".docx,.html,.htm,.txt,.md" />
          <div id="templateInfo" class="muted"></div>
        </div>

        <div class="card">
          <div class="card-title">生成</div>
          <textarea id="instruction" class="input" placeholder="例如：写一份关于XXX的课程报告，要求包含对比表格与数据图，方法部分给出流程与时序图占位，不要编造数据，用[待补充]占位。"></textarea>
          <div class="row">
            <button id="btnGenerate" class="btn primary" type="button">开始生成</button>
            <button id="btnStop" class="btn ghost" type="button" disabled>停止</button>
          </div>
        </div>

        <div class="card">
          <div class="card-title">生成流程</div>
          <div id="graph" class="graph">
            <div class="node" data-state="PLAN">规划</div>
            <div class="node" data-state="DRAFT_SECTIONS">起草</div>
            <div class="node" data-state="AGGREGATE">合并</div>
            <div class="node" data-state="VALIDATE">校验</div>
            <div class="node" data-state="REPAIR">修复</div>
          </div>
          <div id="problems" class="problems hidden"></div>
        </div>
      </div>
    </aside>
  </main>
</div>

<script src="/static/v2.js" defer></script>
{% endblock %}
