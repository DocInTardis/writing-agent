name: citation-observability

on:
  pull_request:
    paths:
      - "writing_agent/web/app_v2.py"
      - "writing_agent/web/frontend_svelte/src/lib/components/PerformanceMetrics.svelte"
      - "scripts/citation_verify_load_probe.py"
      - "scripts/citation_verify_alert_chaos.py"
      - ".github/workflows/citation-observability.yml"
  push:
    branches: ["main", "master"]
    paths:
      - "writing_agent/web/app_v2.py"
      - "writing_agent/web/frontend_svelte/src/lib/components/PerformanceMetrics.svelte"
      - "scripts/citation_verify_load_probe.py"
      - "scripts/citation_verify_alert_chaos.py"
      - ".github/workflows/citation-observability.yml"
  workflow_dispatch:
  schedule:
    - cron: "20 2 * * *"

jobs:
  metrics-probe:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install Runtime Deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install fastapi uvicorn jinja2 python-multipart python-docx cairosvg pypdf
      - name: Run Load Probe
        run: |
          set -euo pipefail
          export WRITING_AGENT_USE_OLLAMA=0
          python -m uvicorn writing_agent.web.app_v2:app --host 127.0.0.1 --port 18080 >/tmp/wa_app.log 2>&1 &
          APP_PID=$!
          trap "kill $APP_PID || true" EXIT
          python - <<'PY'
          import time
          import urllib.request
          url = "http://127.0.0.1:18080/api/metrics/citation_verify"
          deadline = time.time() + 20
          while time.time() < deadline:
              try:
                  with urllib.request.urlopen(url, timeout=1.5) as resp:
                      code = int(getattr(resp, "status", 0) or resp.getcode() or 0)
                  if 200 <= code < 300:
                      break
              except Exception:
                  time.sleep(0.25)
          else:
              raise SystemExit("app_not_ready")
          PY
          python scripts/citation_verify_load_probe.py \
            --base-url http://127.0.0.1:18080 \
            --requests 240 \
            --concurrency 16 \
            --timeout-s 6 \
            --min-success-rate 0.99 \
            --max-p95-ms 1500 \
            --max-degraded-rate 0.05
          python scripts/capacity_guard.py --quick
      - name: Upload Probe Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: citation-observability-probe
          path: |
            .data/out/citation_verify_load_probe_*.json
            .data/out/capacity_guard_*.json
          if-no-files-found: ignore

  alert-chaos:
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install Runtime Deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install fastapi uvicorn jinja2 python-multipart python-docx cairosvg pypdf
      - name: Run Alert Webhook Chaos
        run: |
          python scripts/citation_verify_alert_chaos.py \
            --host 127.0.0.1 \
            --port 18110 \
            --webhook-port 18111 \
            --cooldown-s 1.0
      - name: Upload Chaos Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: citation-observability-chaos
          path: .data/out/citation_verify_alert_chaos_*.json
          if-no-files-found: ignore
